System.register([],(function(t,e){"use strict";return{execute:function(){function i(t,e){const i="undefined"==typeof window?global:window;return void 0===i[t]?i[t]=e:i[t]}t({AntiAliasing:void 0,BitMask:Fn,CCClass:Dr,DebugMode:void 0,Enum:Ln,Eventify:ts,ExtrapolationMode:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SetRandomSeed:Ns,SetUseRandomSeed:xs,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,WorldNode3DToLocalNodeUI:_C,WorldNode3DToWorldNodeUI:dC,__checkObsoleteInNamespace__:function(t){return of||(of="undefined"==typeof Proxy?{}:new Proxy(t,{get:function(t,e,i){return hf(e),Reflect.get(t,e,i)}})),of},__checkObsolete__:function(t){for(var e,i=p(t);!(e=i()).done;)hf(e.value)},absMax:Ws,absMaxComponent:Vs,approx:Ss,assert:x,assertID:W,buildShadowPass:VD,buildShadowPasses:XD,ccenum:kn,clamp:As,clamp01:Rs,color:Ra,createDefaultPipeline:IP,debug:N,deprecateModuleExportedName:function(t){for(var e in t){var i=t[e];uf[e]=i}},deserialize:xl,enumerableProps:Xs,equals:Es,error:C,errorID:z,find:q,genRandom:Bs,getCameraUniqueID:KD,getError:X,getLoadOpOfClearFlag:qD,getRenderArea:HD,getSerializationMetadata:function(t){return t[po]},instantiate:Kl,inverseLerp:Hs,isDisplayStats:j,isValid:jr,lerp:ws,log:M,logID:L,markAsWarning:void 0,mat4:ma,murmurhash2_32_gc:pi,nextPow2:Gs,pingPong:zs,pseudoRandom:Fs,pseudoRandomRange:Ls,pseudoRandomRangeInt:Us,quat:la,randomRange:Ps,randomRangeInt:Ds,rect:Ea,removeProperty:void 0,repeat:ks,replaceProperty:void 0,setDefaultLogTimes:function(t){t>0&&(rf=t)},setDisplayStats:Y,size:ya,toDegree:Os,toRadian:bs,v2:$s,v3:qs,v4:ea,validPunctualLightsCulling:YF,warn:I,warnID:G}),i("CC_WECHAT",!1),i("CC_BAIDU",!1),i("CC_XIAOMI",!1),i("CC_ALIPAY",!1),i("CC_BYTEDANCE",!1),i("CC_OPPO",!1),i("CC_VIVO",!1),i("CC_HUAWEI",!1),i("CC_COCOSPLAY",!1),i("CC_QTT",!1),i("CC_LINKSURE",!1);const n=!1;function r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function s(t,e,i){return e&&r(t.prototype,e),i&&r(t,i),t}function a(){return(a=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}).apply(this,arguments)}function o(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,h(t,e)}function u(t){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function c(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function l(t,e,i){return(l=c()?Reflect.construct:function(t,e,i){var n=[null];n.push.apply(n,e);var r=new(Function.bind.apply(t,n));return i&&h(r,i.prototype),r}).apply(null,arguments)}function _(t){var e="function"==typeof Map?new Map:void 0;return(_=function(t){if(null===t||(i=t,-1===Function.toString.call(i).indexOf("[native code]")))return t;var i;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return l(t,arguments,u(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),h(n,t)})(t)}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function p(t,e){var i;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return f(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?f(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0;return function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(i=t[Symbol.iterator]()).next.bind(i)}function m(t,e,i,n,r){var s={};return Object.keys(n).forEach((function(t){s[t]=n[t]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),s),r&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(r):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(t,e,s),s=null),s}i("CC_EDITOR",!1),i("CC_PREVIEW",!1),i("CC_BUILD",!0),i("CC_TEST",!1),i("CC_DEBUG",!1),i("CC_DEV",!1),i("CC_MINIGAME",!1),i("CC_RUNTIME_BASED",!1),i("CC_SUPPORT_JIT",!0),i("CC_JSB",!1);var g="undefined"==typeof window?global:window,v=t("cclegacy",{_global:g});v.internal={};var y=t("VERSION","3.6.2");g.CocosEngine=v.ENGINE_VERSION=y,g.cc=v;var T="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",E=null,S=console.log.bind(console),A=S,R=S,w=function(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];console.log("ASSERT: "+O.apply(void 0,[e].concat(n)))}},b=S;function O(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return v.js.formatStr.apply(null,[t].concat(i))}function M(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return S.apply(void 0,[t].concat(i))}function I(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return A.apply(void 0,[t].concat(i))}function C(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return R.apply(void 0,[t].concat(i))}function x(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return w.apply(void 0,[t,e].concat(n))}function N(){return b.apply(void 0,arguments)}function B(t){if(S=A=R=w=b=function(){},t!==H.NONE){if(t>H.ERROR){var e=function(t){if(v.game.canvas){if(!E){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",v.game.canvas.height);var i=e.style;i.zIndex="99999",i.position="absolute",i.top=i.left="0",(E=document.createElement("textarea")).setAttribute("rows","20"),E.setAttribute("cols","30"),E.setAttribute("disabled","true");var n=E.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",e.appendChild(E),v.game.canvas.parentNode.appendChild(e)}E.value=E.value+t+"\r\n",E.scrollTop=E.scrollHeight}};R=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e("ERROR :  "+O.apply(void 0,[t].concat(n)))},w=function(t,i){if(!t){for(var n=arguments.length,r=new Array(n>2?n-2:0),s=2;s<n;s++)r[s-2]=arguments[s];e("ASSERT: "+O.apply(void 0,[i].concat(r)))}},t!==H.ERROR_FOR_WEB_PAGE&&(A=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e("WARN :  "+O.apply(void 0,[t].concat(n)))}),t===H.INFO_FOR_WEB_PAGE&&(S=function(t){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];e(O.apply(void 0,[t].concat(n)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),R=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.error.apply(console,[t].concat(i))},w=function(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];var s=O.apply(void 0,[e].concat(n));throw new Error(s)}});if(t!==H.ERROR&&(A=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.warn.apply(console,[t].concat(i))}),t<=H.INFO&&(S=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return console.log.apply(console,[t].concat(i))}),t<=H.VERBOSE&&"function"==typeof console.debug){var i=console.debug.bind(console);b=function(){return i.apply(void 0,arguments)}}}}function P(t){C(t.stack||t)}function D(t){return function(e){for(var i=t+" "+e+", please go to "+T+"#"+e+" to see details.",n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];return 0===r.length?i:i+" Arguments: "+r.join(", ")}}var F=D("Log");function L(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];M(F.apply(void 0,[t].concat(i)))}var U=D("Warning");function G(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];I(U.apply(void 0,[t].concat(i)))}var k=D("Error");function z(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];C(k.apply(void 0,[t].concat(i)))}var H,V=D("Assert");function W(t,e){if(!t){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];x(!1,V.apply(void 0,[e].concat(n)))}}function X(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return k.apply(void 0,[t].concat(i))}function j(){return!!v.profiler&&v.profiler.isShowingStats()}function Y(t){v.profiler&&(t?v.profiler.showStats():v.profiler.hideStats())}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(H||(H=t("DebugMode",{})));var K=Object.freeze({__proto__:null,log:M,warn:I,error:C,assert:x,debug:N,_resetDebugSetting:B,_throw:P,logID:L,warnID:G,errorID:z,assertID:W,get DebugMode(){return H},getError:X,isDisplayStats:j,setDisplayStats:Y});function q(t,e){if(!e){var i=v.director.getScene();if(!i)return null;e=i}return e.getChildByPath(t)}v.find=q;var Q,Z,J,$,tt,et,it,nt,rt,st,at,ot,ut,ht,ct,lt,_t,dt,ft,pt,mt,gt,vt,yt,Tt,Et,St,At,Rt,wt,bt,Ot,Mt,It,Ct,xt,Nt,Bt,Pt,Dt,Ft,Lt,Ut,Gt,kt=new(function(){function t(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}var e=t.prototype;return e.registerGCObject=function(t){return t},e.init=function(){},e.finalizationRegistryCallback=function(t){var e=this._gcObjects.get(t);e&&(this._gcObjects.delete(t),e.destroy()),this._finalizationRegistry.unregister(t)},e.destroy=function(){},t}()),zt=function(){function t(){return kt.registerGCObject(this)}return t.prototype.destroy=function(){},t}(),Ht=function(t,e,i){for(var n=0;n<e.length;++n)t.length<=n&&t.push(new i),t[n].copy(e[n]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(Q||(Q={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(Z||(Z={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.NVN=5]="NVN",t[t.WEBGL=6]="WEBGL",t[t.WEBGL2=7]="WEBGL2",t[t.WEBGPU=8]="WEBGPU"}(J||(J={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}($||($={})),function(t){t[t.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=3]="BLEND_MINMAX",t[t.COMPUTE_SHADER=4]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=6]="COUNT"}(tt||(tt={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(et||(et={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(it||(it={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(nt||(nt={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(rt||(rt={})),function(t){t[t.NONE=0]="NONE"}(st||(st={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(at||(at={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(ot||(ot={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(ut||(ut={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(ht||(ht={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(ct||(ct={})),function(t){t[t.NONE=0]="NONE",t[t.RENDER_TARGET=1]="RENDER_TARGET",t[t.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",t[t.LINEAR_FILTER=4]="LINEAR_FILTER",t[t.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",t[t.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(lt||(lt={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(_t||(_t={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(dt||(dt={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(ft||(ft={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(pt||(pt={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(mt||(mt={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(gt||(gt={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(vt||(vt={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(yt||(yt={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Tt||(Tt={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Et||(Et={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(St||(St={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(At||(At={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=4]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=65536]="TRANSFER_READ",t[t.HOST_READ=131072]="HOST_READ",t[t.PRESENT=262144]="PRESENT",t[t.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",t[t.HOST_WRITE=67108864]="HOST_WRITE"}(Rt||(Rt={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(wt||(wt={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(bt||(bt={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Ot||(Ot={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(Mt||(Mt={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(It||(It={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(Ct||(Ct={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(xt||(xt={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Nt||(Nt={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Bt||(Bt={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(Pt||(Pt={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(Dt||(Dt={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(Ft||(Ft={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Lt||(Lt={})),function(t){t[t.FULL=0]="FULL",t[t.SPLIT_BEGIN=1]="SPLIT_BEGIN",t[t.SPLIT_END=2]="SPLIT_END"}(Ut||(Ut={})),function(t){t[t.RASTER=0]="RASTER",t[t.COMPUTE=1]="COMPUTE",t[t.COPY=2]="COPY",t[t.MOVE=3]="MOVE",t[t.RAYTRACE=4]="RAYTRACE",t[t.PRESENT=5]="PRESENT"}(Gt||(Gt={}));var Vt,Wt=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Xt=function(){function t(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p,m,g,v,y,T,E){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===_&&(_=0),void 0===d&&(d=1),void 0===f&&(f=0),void 0===p&&(p=0),void 0===m&&(m=new Wt),void 0===g&&(g=new Wt),void 0===v&&(v=!1),void 0===y&&(y=-1),void 0===T&&(T=1),void 0===E&&(E=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=r,this.maxVertexTextureUnits=s,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=o,this.maxShaderStorageBlockSize=u,this.maxUniformBufferBindings=h,this.maxUniformBlockSize=c,this.maxTextureSize=l,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=d,this.maxComputeSharedMemorySize=f,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=g,this.supportQuery=v,this.clipSpaceMinZ=y,this.screenSpaceSignY=T,this.clipSpaceSignY=E}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),jt=function(){function t(t){void 0===t&&(t=!0),this.enableBarrierDeduce=t}return t.prototype.copy=function(t){return this.enableBarrierDeduce=t.enableBarrierDeduce,this},t}(),Yt=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Kt=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),qt=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.width=t,this.height=e,this.depth=i}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),Qt=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),Zt=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=n}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),Jt=function(){function t(t,e,i,n,r){void 0===t&&(t=new Qt),void 0===e&&(e=new Yt),void 0===i&&(i=new Qt),void 0===n&&(n=new Yt),void 0===r&&(r=new qt),this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=n,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),$t=function(){function t(t,e,i,n,r,s){void 0===t&&(t=new Qt),void 0===e&&(e=new Yt),void 0===i&&(i=new qt),void 0===n&&(n=new Qt),void 0===r&&(r=new Yt),void 0===s&&(s=new qt),this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=n,this.dstOffset=r,this.dstExtent=s}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),te=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=new Yt),void 0===r&&(r=new qt),void 0===s&&(s=new Qt),this.buffOffset=t,this.buffStride=e,this.buffTexHeight=i,this.texOffset=n,this.texExtent=r,this.texSubres=s}return t.prototype.copy=function(t){return this.buffOffset=t.buffOffset,this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),ee=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=1),this.left=t,this.top=e,this.width=i,this.height=n,this.minDepth=r,this.maxDepth=s}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),ie=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=i,this.w=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),ne=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=[0]),void 0===e&&(e=[0]),void 0===i&&(i=[0]),void 0===n&&(n=[0]),void 0===r&&(r=[0]),void 0===s&&(s=[0]),void 0===a&&(a=[0]),void 0===o&&(o=[0]),this.maxBlockCounts=t,this.maxSamplerTextureCounts=e,this.maxSamplerCounts=i,this.maxTextureCounts=n,this.maxBufferCounts=r,this.maxImageCounts=s,this.maxSubpassInputCounts=a,this.setIndices=o}return t.prototype.copy=function(t){return this.maxBlockCounts=t.maxBlockCounts.slice(),this.maxSamplerTextureCounts=t.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=t.maxSamplerCounts.slice(),this.maxTextureCounts=t.maxTextureCounts.slice(),this.maxBufferCounts=t.maxBufferCounts.slice(),this.maxImageCounts=t.maxImageCounts.slice(),this.maxSubpassInputCounts=t.maxSubpassInputCounts.slice(),this.setIndices=t.setIndices.slice(),this},t}(),re=function(){function t(t,e,i,n){void 0===t&&(t=null),void 0===e&&(e=dt.ON),void 0===i&&(i=0),void 0===n&&(n=0),this.windowHandle=t,this.vsyncMode=e,this.width=i,this.height=n}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),se=function(){function t(t){void 0===t&&(t=new ne),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),ae=function(){function t(t,e,i,n,r){void 0===t&&(t=rt.NONE),void 0===e&&(e=ot.NONE),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=st.NONE),this.usage=t,this.memUsage=e,this.size=i,this.stride=n,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),oe=function(){function t(t,e,i){void 0===t&&(t=null),void 0===e&&(e=0),void 0===i&&(i=0),this.buffer=t,this.offset=e,this.range=i}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),ue=function(){function t(t,e,i,n,r,s,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=n,this.vertexOffset=r,this.instanceCount=s,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),he=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),ce=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return Ht(this.drawInfos,t.drawInfos,ue),this},t}(),le=function(){function t(t,e,i,n,r,s,a,o,u,h,c){void 0===t&&(t=ut.TEX2D),void 0===e&&(e=ht.NONE),void 0===i&&(i=et.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=ct.NONE),void 0===a&&(a=1),void 0===o&&(o=1),void 0===u&&(u=_t.ONE),void 0===h&&(h=1),void 0===c&&(c=0),this.type=t,this.usage=e,this.format=i,this.width=n,this.height=r,this.flags=s,this.layerCount=a,this.levelCount=o,this.samples=u,this.depth=h,this.externalRes=c}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),_e=function(){function t(t,e,i,n,r,s,a){void 0===t&&(t=null),void 0===e&&(e=ut.TEX2D),void 0===i&&(i=et.UNKNOWN),void 0===n&&(n=0),void 0===r&&(r=1),void 0===s&&(s=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=i,this.baseLevel=n,this.levelCount=r,this.baseLayer=s,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),de=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=ft.LINEAR),void 0===e&&(e=ft.LINEAR),void 0===i&&(i=ft.NONE),void 0===n&&(n=pt.WRAP),void 0===r&&(r=pt.WRAP),void 0===s&&(s=pt.WRAP),void 0===a&&(a=0),void 0===o&&(o=mt.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=n,this.addressV=r,this.addressW=s,this.maxAnisotropy=a,this.cmpFunc=o}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),fe=function(){function t(t,e,i){void 0===t&&(t=""),void 0===e&&(e=nt.UNKNOWN),void 0===i&&(i=0),this.name=t,this.type=e,this.count=i}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),pe=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.members=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Ht(this.members,t.members,fe),this.count=t.count,this},t}(),me=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=nt.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),ge=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.count=n}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),ve=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=nt.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),ye=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=nt.UNKNOWN),void 0===r&&(r=0),void 0===s&&(s=at.READ_WRITE),this.set=t,this.binding=e,this.name=i,this.type=n,this.count=r,this.memoryAccess=s}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Te=function(){function t(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),void 0===r&&(r=at.READ_WRITE),this.set=t,this.binding=e,this.name=i,this.count=n,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Ee=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=""),void 0===n&&(n=0),this.set=t,this.binding=e,this.name=i,this.count=n}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Se=function(){function t(t,e){void 0===t&&(t=Et.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Ae=function(){function t(t,e,i,n,r,s){void 0===t&&(t=""),void 0===e&&(e=et.UNKNOWN),void 0===i&&(i=!1),void 0===n&&(n=0),void 0===r&&(r=!1),void 0===s&&(s=0),this.name=t,this.format=e,this.isNormalized=i,this.stream=n,this.isInstanced=r,this.location=s}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),Re=function(){function t(t,e,i,n,r,s,a,o,u,h){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=[]),void 0===s&&(s=[]),void 0===a&&(a=[]),void 0===o&&(o=[]),void 0===u&&(u=[]),void 0===h&&(h=[]),this.name=t,this.stages=e,this.attributes=i,this.blocks=n,this.buffers=r,this.samplerTextures=s,this.samplers=a,this.textures=o,this.images=u,this.subpassInputs=h}return t.prototype.copy=function(t){return this.name=t.name,Ht(this.stages,t.stages,Se),Ht(this.attributes,t.attributes,Ae),Ht(this.blocks,t.blocks,pe),Ht(this.buffers,t.buffers,Te),Ht(this.samplerTextures,t.samplerTextures,me),Ht(this.samplers,t.samplers,ge),Ht(this.textures,t.textures,ve),Ht(this.images,t.images,ye),Ht(this.subpassInputs,t.subpassInputs,Ee),this},t}(),we=function(){function t(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=null),void 0===n&&(n=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=n}return t.prototype.copy=function(t){return Ht(this.attributes,t.attributes,Ae),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),be=function(){function t(t,e,i,n,r,s){void 0===t&&(t=et.UNKNOWN),void 0===e&&(e=_t.ONE),void 0===i&&(i=St.CLEAR),void 0===n&&(n=At.STORE),void 0===r&&(r=null),void 0===s&&(s=!1),this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=n,this.barrier=r,this.isGeneralLayout=s}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.barrier=t.barrier,this.isGeneralLayout=t.isGeneralLayout,this},t}(),Oe=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=et.UNKNOWN),void 0===e&&(e=_t.ONE),void 0===i&&(i=St.CLEAR),void 0===n&&(n=At.STORE),void 0===r&&(r=St.CLEAR),void 0===s&&(s=At.STORE),void 0===a&&(a=null),void 0===o&&(o=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=r,this.stencilStoreOp=s,this.barrier=a,this.isGeneralLayout=o}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.barrier=t.barrier,this.isGeneralLayout=t.isGeneralLayout,this},t}(),Me=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===i&&(i=[]),void 0===n&&(n=[]),void 0===r&&(r=-1),void 0===s&&(s=-1),void 0===a&&(a=wt.NONE),void 0===o&&(o=wt.NONE),this.inputs=t,this.colors=e,this.resolves=i,this.preserves=n,this.depthStencil=r,this.depthStencilResolve=s,this.depthResolveMode=a,this.stencilResolveMode=o}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Ie=function(){function t(t,e,i,n,r,s,a,o,u){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=null),void 0===n&&(n=null),void 0===r&&(r=null),void 0===s&&(s=0),void 0===a&&(a=null),void 0===o&&(o=null),void 0===u&&(u=0),this.srcSubpass=t,this.dstSubpass=e,this.generalBarrier=i,this.bufferBarriers=n,this.buffers=r,this.bufferBarrierCount=s,this.textureBarriers=a,this.textures=o,this.textureBarrierCount=u}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.generalBarrier=t.generalBarrier,this.bufferBarriers=t.bufferBarriers,this.buffers=t.buffers,this.bufferBarrierCount=t.bufferBarrierCount,this.textureBarriers=t.textureBarriers,this.textures=t.textures,this.textureBarrierCount=t.textureBarrierCount,this},t}(),Ce=function(){function t(t,e,i,n){void 0===t&&(t=[]),void 0===e&&(e=new Oe),void 0===i&&(i=[]),void 0===n&&(n=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=i,this.dependencies=n}return t.prototype.copy=function(t){return Ht(this.colorAttachments,t.colorAttachments,be),this.depthStencilAttachment.copy(t.depthStencilAttachment),Ht(this.subpasses,t.subpasses,Me),Ht(this.dependencies,t.dependencies,Ie),this},t}(),xe=function(){function t(t,e,i){void 0===t&&(t=Rt.NONE),void 0===e&&(e=Rt.NONE),void 0===i&&(i=Ut.FULL),this.prevAccesses=t,this.nextAccesses=e,this.type=i}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this},t}(),Ne=function(){function t(t,e,i,n,r,s,a,o,u,h){void 0===t&&(t=Rt.NONE),void 0===e&&(e=Rt.NONE),void 0===i&&(i=Ut.FULL),void 0===n&&(n=0),void 0===r&&(r=1),void 0===s&&(s=0),void 0===a&&(a=1),void 0===o&&(o=!1),void 0===u&&(u=null),void 0===h&&(h=null),this.prevAccesses=t,this.nextAccesses=e,this.type=i,this.baseMipLevel=n,this.levelCount=r,this.baseSlice=s,this.sliceCount=a,this.discardContents=o,this.srcQueue=u,this.dstQueue=h}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseSlice=t.baseSlice,this.sliceCount=t.sliceCount,this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),Be=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=Rt.NONE),void 0===e&&(e=Rt.NONE),void 0===i&&(i=Ut.FULL),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=!1),void 0===a&&(a=null),void 0===o&&(o=null),this.prevAccesses=t,this.nextAccesses=e,this.type=i,this.offset=n,this.size=r,this.discardContents=s,this.srcQueue=a,this.dstQueue=o}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses,this.nextAccesses=t.nextAccesses,this.type=t.type,this.offset=t.offset,this.size=t.size,this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),Pe=function(){function t(t,e,i){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===i&&(i=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),De=function(){function t(t,e,i,n,r){void 0===t&&(t=-1),void 0===e&&(e=Bt.UNKNOWN),void 0===i&&(i=0),void 0===n&&(n=Et.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=n,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),Fe=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return Ht(this.bindings,t.bindings,De),this},t}(),Le=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),Ue=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Ge=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return Ht(this.attributes,t.attributes,Ae),this},t}(),ke=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=Ft.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),ze=function(){function t(t){void 0===t&&(t=Pt.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),He=function(){function t(t,e,i){void 0===t&&(t=Dt.OCCLUSION),void 0===e&&(e=32767),void 0===i&&(i=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=i}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Ve=function(t,e,i,n,r,s,a,o){void 0===t&&(t=""),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=it.NONE),void 0===r&&(r=!1),void 0===s&&(s=!1),void 0===a&&(a=!1),void 0===o&&(o=!1),this.name=t,this.size=e,this.count=i,this.type=n,this.hasAlpha=r,this.hasDepth=s,this.hasStencil=a,this.isCompressed=o},We=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),Xe=function(){function t(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this.writeMask=t,this.compareMask=e,this.reference=i}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),je=function(){function t(t,e,i,n,r,s,a,o,u,h,c){void 0===t&&(t=new ee),void 0===e&&(e=new Kt),void 0===i&&(i=new ie),void 0===n&&(n=1),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=new Xe),void 0===c&&(c=new Xe),this.viewport=t,this.scissor=e,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=r,this.depthBiasClamp=s,this.depthBiasSlope=a,this.depthMinBounds=o,this.depthMaxBounds=u,this.stencilStatesFront=h,this.stencilStatesBack=c}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),Ye=function(t){function e(i){var n;return(n=t.call(this)||this)._objectType=Q.UNKNOWN,n._objectID=0,n._typedID=0,n._objectType=i,n._objectID=e._idTable[Q.UNKNOWN]++,n._typedID=e._idTable[i]++,n}return o(e,t),s(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}(zt);Ye._idTable=Array(Q.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Vt||(Vt={}));var Ke=Object.freeze([new Ve("UNKNOWN",0,0,it.NONE,!1,!1,!1,!1),new Ve("A8",1,1,it.UNORM,!0,!1,!1,!1),new Ve("L8",1,1,it.UNORM,!1,!1,!1,!1),new Ve("LA8",1,2,it.UNORM,!0,!1,!1,!1),new Ve("R8",1,1,it.UNORM,!1,!1,!1,!1),new Ve("R8SN",1,1,it.SNORM,!1,!1,!1,!1),new Ve("R8UI",1,1,it.UINT,!1,!1,!1,!1),new Ve("R8I",1,1,it.INT,!1,!1,!1,!1),new Ve("R16F",2,1,it.FLOAT,!1,!1,!1,!1),new Ve("R16UI",2,1,it.UINT,!1,!1,!1,!1),new Ve("R16I",2,1,it.INT,!1,!1,!1,!1),new Ve("R32F",4,1,it.FLOAT,!1,!1,!1,!1),new Ve("R32UI",4,1,it.UINT,!1,!1,!1,!1),new Ve("R32I",4,1,it.INT,!1,!1,!1,!1),new Ve("RG8",2,2,it.UNORM,!1,!1,!1,!1),new Ve("RG8SN",2,2,it.SNORM,!1,!1,!1,!1),new Ve("RG8UI",2,2,it.UINT,!1,!1,!1,!1),new Ve("RG8I",2,2,it.INT,!1,!1,!1,!1),new Ve("RG16F",4,2,it.FLOAT,!1,!1,!1,!1),new Ve("RG16UI",4,2,it.UINT,!1,!1,!1,!1),new Ve("RG16I",4,2,it.INT,!1,!1,!1,!1),new Ve("RG32F",8,2,it.FLOAT,!1,!1,!1,!1),new Ve("RG32UI",8,2,it.UINT,!1,!1,!1,!1),new Ve("RG32I",8,2,it.INT,!1,!1,!1,!1),new Ve("RGB8",3,3,it.UNORM,!1,!1,!1,!1),new Ve("SRGB8",3,3,it.UNORM,!1,!1,!1,!1),new Ve("RGB8SN",3,3,it.SNORM,!1,!1,!1,!1),new Ve("RGB8UI",3,3,it.UINT,!1,!1,!1,!1),new Ve("RGB8I",3,3,it.INT,!1,!1,!1,!1),new Ve("RGB16F",6,3,it.FLOAT,!1,!1,!1,!1),new Ve("RGB16UI",6,3,it.UINT,!1,!1,!1,!1),new Ve("RGB16I",6,3,it.INT,!1,!1,!1,!1),new Ve("RGB32F",12,3,it.FLOAT,!1,!1,!1,!1),new Ve("RGB32UI",12,3,it.UINT,!1,!1,!1,!1),new Ve("RGB32I",12,3,it.INT,!1,!1,!1,!1),new Ve("RGBA8",4,4,it.UNORM,!0,!1,!1,!1),new Ve("BGRA8",4,4,it.UNORM,!0,!1,!1,!1),new Ve("SRGB8_A8",4,4,it.UNORM,!0,!1,!1,!1),new Ve("RGBA8SN",4,4,it.SNORM,!0,!1,!1,!1),new Ve("RGBA8UI",4,4,it.UINT,!0,!1,!1,!1),new Ve("RGBA8I",4,4,it.INT,!0,!1,!1,!1),new Ve("RGBA16F",8,4,it.FLOAT,!0,!1,!1,!1),new Ve("RGBA16UI",8,4,it.UINT,!0,!1,!1,!1),new Ve("RGBA16I",8,4,it.INT,!0,!1,!1,!1),new Ve("RGBA32F",16,4,it.FLOAT,!0,!1,!1,!1),new Ve("RGBA32UI",16,4,it.UINT,!0,!1,!1,!1),new Ve("RGBA32I",16,4,it.INT,!0,!1,!1,!1),new Ve("R5G6B5",2,3,it.UNORM,!1,!1,!1,!1),new Ve("R11G11B10F",4,3,it.FLOAT,!1,!1,!1,!1),new Ve("RGB5A1",2,4,it.UNORM,!0,!1,!1,!1),new Ve("RGBA4",2,4,it.UNORM,!0,!1,!1,!1),new Ve("RGB10A2",2,4,it.UNORM,!0,!1,!1,!1),new Ve("RGB10A2UI",2,4,it.UINT,!0,!1,!1,!1),new Ve("RGB9E5",2,4,it.FLOAT,!0,!1,!1,!1),new Ve("DEPTH",4,1,it.FLOAT,!1,!0,!1,!1),new Ve("DEPTH_STENCIL",5,2,it.FLOAT,!1,!0,!0,!1),new Ve("BC1",1,3,it.UNORM,!1,!1,!1,!0),new Ve("BC1_ALPHA",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC1_SRGB",1,3,it.UNORM,!1,!1,!1,!0),new Ve("BC1_SRGB_ALPHA",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC2",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC2_SRGB",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC3",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC3_SRGB",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC4",1,1,it.UNORM,!1,!1,!1,!0),new Ve("BC4_SNORM",1,1,it.SNORM,!1,!1,!1,!0),new Ve("BC5",1,2,it.UNORM,!1,!1,!1,!0),new Ve("BC5_SNORM",1,2,it.SNORM,!1,!1,!1,!0),new Ve("BC6H_UF16",1,3,it.UFLOAT,!1,!1,!1,!0),new Ve("BC6H_SF16",1,3,it.FLOAT,!1,!1,!1,!0),new Ve("BC7",1,4,it.UNORM,!0,!1,!1,!0),new Ve("BC7_SRGB",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ETC_RGB8",1,3,it.UNORM,!1,!1,!1,!0),new Ve("ETC2_RGB8",1,3,it.UNORM,!1,!1,!1,!0),new Ve("ETC2_SRGB8",1,3,it.UNORM,!1,!1,!1,!0),new Ve("ETC2_RGB8_A1",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ETC2_SRGB8_A1",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ETC2_RGBA8",2,4,it.UNORM,!0,!1,!1,!0),new Ve("ETC2_SRGB8_A8",2,4,it.UNORM,!0,!1,!1,!0),new Ve("EAC_R11",1,1,it.UNORM,!1,!1,!1,!0),new Ve("EAC_R11SN",1,1,it.SNORM,!1,!1,!1,!0),new Ve("EAC_RG11",2,2,it.UNORM,!1,!1,!1,!0),new Ve("EAC_RG11SN",2,2,it.SNORM,!1,!1,!1,!0),new Ve("PVRTC_RGB2",2,3,it.UNORM,!1,!1,!1,!0),new Ve("PVRTC_RGBA2",2,4,it.UNORM,!0,!1,!1,!0),new Ve("PVRTC_RGB4",2,3,it.UNORM,!1,!1,!1,!0),new Ve("PVRTC_RGBA4",2,4,it.UNORM,!0,!1,!1,!0),new Ve("PVRTC2_2BPP",2,4,it.UNORM,!0,!1,!1,!0),new Ve("PVRTC2_4BPP",2,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_4x4",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_5x4",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_5x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_6x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_6x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_8x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_8x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_8x8",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_10x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_10x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_10x8",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_10x10",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_12x10",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_RGBA_12x12",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_4x4",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_5x4",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_5x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_6x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_6x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_8x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_8x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_8x8",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_10x5",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_10x6",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_10x8",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_10x10",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_12x10",1,4,it.UNORM,!0,!1,!1,!0),new Ve("ASTC_SRGBA_12x12",1,4,it.UNORM,!0,!1,!1,!0)]),qe=Bt.UNIFORM_BUFFER|Bt.DYNAMIC_UNIFORM_BUFFER|Bt.STORAGE_BUFFER|Bt.DYNAMIC_STORAGE_BUFFER,Qe=Bt.SAMPLER_TEXTURE|Bt.SAMPLER|Bt.TEXTURE|Bt.STORAGE_IMAGE|Bt.INPUT_ATTACHMENT,Ze=Bt.DYNAMIC_STORAGE_BUFFER|Bt.DYNAMIC_UNIFORM_BUFFER,Je=28;function $e(t){return t>0&&0==(t&t-1)}function ti(t,e,i,n){if(!Ke[t].isCompressed)return e*i*n*Ke[t].size;switch(t){case et.BC1:case et.BC1_ALPHA:case et.BC1_SRGB:case et.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case et.BC2:case et.BC2_SRGB:case et.BC3:case et.BC3_SRGB:case et.BC4:case et.BC4_SNORM:case et.BC6H_SF16:case et.BC6H_UF16:case et.BC7:case et.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case et.BC5:case et.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(i/4)*32*n;case et.ETC_RGB8:case et.ETC2_RGB8:case et.ETC2_SRGB8:case et.ETC2_RGB8_A1:case et.EAC_R11:case et.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case et.ETC2_RGBA8:case et.ETC2_SRGB8_A1:case et.EAC_RG11:case et.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case et.PVRTC_RGB2:case et.PVRTC_RGBA2:case et.PVRTC2_2BPP:return Math.ceil(e/8)*Math.ceil(i/4)*8*n;case et.PVRTC_RGB4:case et.PVRTC_RGBA4:case et.PVRTC2_4BPP:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case et.ASTC_RGBA_4X4:case et.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case et.ASTC_RGBA_5X4:case et.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(i/4)*16*n;case et.ASTC_RGBA_5X5:case et.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(i/5)*16*n;case et.ASTC_RGBA_6X5:case et.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(i/5)*16*n;case et.ASTC_RGBA_6X6:case et.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(i/6)*16*n;case et.ASTC_RGBA_8X5:case et.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(i/5)*16*n;case et.ASTC_RGBA_8X6:case et.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(i/6)*16*n;case et.ASTC_RGBA_8X8:case et.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(i/8)*16*n;case et.ASTC_RGBA_10X5:case et.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(i/5)*16*n;case et.ASTC_RGBA_10X6:case et.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(i/6)*16*n;case et.ASTC_RGBA_10X8:case et.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(i/8)*16*n;case et.ASTC_RGBA_10X10:case et.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(i/10)*16*n;case et.ASTC_RGBA_12X10:case et.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(i/10)*16*n;case et.ASTC_RGBA_12X12:case et.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(i/12)*16*n;default:return 0}}function ei(t,e,i,n,r){for(var s=0,a=0;a<r;++a)s+=ti(t,e,i,n),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return s}var ii=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ni(t){return ii[t]||0}function ri(t){if(t.isCompressed)return Uint8Array;var e=t.size/t.count;switch(t.type){case it.UNORM:case it.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}case it.SNORM:case it.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array;default:return Int8Array}case it.FLOAT:return Float32Array}return Float32Array}function si(t){switch(t){case et.BC1:case et.BC1_ALPHA:case et.BC1_SRGB:case et.BC1_SRGB_ALPHA:case et.BC2:case et.BC2_SRGB:case et.BC3:case et.BC3_SRGB:case et.BC4:case et.BC4_SNORM:case et.BC6H_SF16:case et.BC6H_UF16:case et.BC7:case et.BC7_SRGB:case et.BC5:case et.BC5_SNORM:case et.ETC_RGB8:case et.ETC2_RGB8:case et.ETC2_SRGB8:case et.ETC2_RGB8_A1:case et.EAC_R11:case et.EAC_R11SN:case et.ETC2_RGBA8:case et.ETC2_SRGB8_A1:case et.EAC_RG11:case et.EAC_RG11SN:return{width:4,height:4};case et.PVRTC_RGB2:case et.PVRTC_RGBA2:case et.PVRTC2_2BPP:return{width:8,height:4};case et.PVRTC_RGB4:case et.PVRTC_RGBA4:case et.PVRTC2_4BPP:return{width:4,height:4};case et.ASTC_RGBA_4X4:case et.ASTC_SRGBA_4X4:return{width:4,height:4};case et.ASTC_RGBA_5X4:case et.ASTC_SRGBA_5X4:return{width:5,height:4};case et.ASTC_RGBA_5X5:case et.ASTC_SRGBA_5X5:return{width:5,height:5};case et.ASTC_RGBA_6X5:case et.ASTC_SRGBA_6X5:return{width:6,height:5};case et.ASTC_RGBA_6X6:case et.ASTC_SRGBA_6X6:return{width:6,height:6};case et.ASTC_RGBA_8X5:case et.ASTC_SRGBA_8X5:return{width:8,height:5};case et.ASTC_RGBA_8X6:case et.ASTC_SRGBA_8X6:return{width:8,height:6};case et.ASTC_RGBA_8X8:case et.ASTC_SRGBA_8X8:return{width:8,height:8};case et.ASTC_RGBA_10X5:case et.ASTC_SRGBA_10X5:return{width:10,height:5};case et.ASTC_RGBA_10X6:case et.ASTC_SRGBA_10X6:return{width:10,height:6};case et.ASTC_RGBA_10X8:case et.ASTC_SRGBA_10X8:return{width:10,height:8};case et.ASTC_RGBA_10X10:case et.ASTC_SRGBA_10X10:return{width:10,height:10};case et.ASTC_RGBA_12X10:case et.ASTC_SRGBA_12X10:return{width:12,height:10};case et.ASTC_RGBA_12X12:case et.ASTC_SRGBA_12X12:return{width:12,height:12};default:return{width:1,height:1}}}function ai(t,e){return Math.ceil(t/e)*e}var oi=Object.freeze({__proto__:null,get ObjectType(){return Q},get Status(){return Z},get API(){return J},get SurfaceTransform(){return $},get Feature(){return tt},get Format(){return et},get FormatType(){return it},get Type(){return nt},get BufferUsageBit(){return rt},get BufferFlagBit(){return st},get MemoryAccessBit(){return at},get MemoryUsageBit(){return ot},get TextureType(){return ut},get TextureUsageBit(){return ht},get TextureFlagBit(){return ct},get FormatFeatureBit(){return lt},get SampleCount(){return _t},get VsyncMode(){return dt},get Filter(){return ft},get Address(){return pt},get ComparisonFunc(){return mt},get StencilOp(){return gt},get BlendFactor(){return vt},get BlendOp(){return yt},get ColorMask(){return Tt},get ShaderStageFlagBit(){return Et},get LoadOp(){return St},get StoreOp(){return At},get AccessFlagBit(){return Rt},get ResolveMode(){return wt},get PipelineBindPoint(){return bt},get PrimitiveMode(){return Ot},get PolygonMode(){return Mt},get ShadeModel(){return It},get CullMode(){return Ct},get DynamicStateFlagBit(){return xt},get StencilFace(){return Nt},get DescriptorType(){return Bt},get QueueType(){return Pt},get QueryType(){return Dt},get CommandBufferType(){return Ft},get ClearFlagBit(){return Lt},get BarrierType(){return Ut},get PassType(){return Gt},Size:Wt,DeviceCaps:Xt,DeviceOptions:jt,Offset:Yt,Rect:Kt,Extent:qt,TextureSubresLayers:Qt,TextureSubresRange:Zt,TextureCopy:Jt,TextureBlit:$t,BufferTextureCopy:te,Viewport:ee,Color:ie,BindingMappingInfo:ne,SwapchainInfo:re,DeviceInfo:se,BufferInfo:ae,BufferViewInfo:oe,DrawInfo:ue,DispatchInfo:he,IndirectBuffer:ce,TextureInfo:le,TextureViewInfo:_e,SamplerInfo:de,Uniform:fe,UniformBlock:pe,UniformSamplerTexture:me,UniformSampler:ge,UniformTexture:ve,UniformStorageImage:ye,UniformStorageBuffer:Te,UniformInputAttachment:Ee,ShaderStage:Se,Attribute:Ae,ShaderInfo:Re,InputAssemblerInfo:we,ColorAttachment:be,DepthStencilAttachment:Oe,SubpassInfo:Me,SubpassDependency:Ie,RenderPassInfo:Ce,GeneralBarrierInfo:xe,TextureBarrierInfo:Ne,BufferBarrierInfo:Be,FramebufferInfo:Pe,DescriptorSetLayoutBinding:De,DescriptorSetLayoutInfo:Fe,DescriptorSetInfo:Le,PipelineLayoutInfo:Ue,InputState:Ge,CommandBufferInfo:ke,QueueInfo:ze,QueryPoolInfo:He,FormatInfo:Ve,MemoryStatus:We,DynamicStencilStates:Xe,DynamicStates:je,GFXObject:Ye,get AttributeName(){return Vt},FormatInfos:Ke,DESCRIPTOR_BUFFER_TYPE:qe,DESCRIPTOR_SAMPLER_TYPE:Qe,DESCRIPTOR_DYNAMIC_TYPE:Ze,DRAW_INFO_SIZE:Je,IsPowerOf2:$e,FormatSize:ti,FormatSurfaceSize:ei,GetTypeSize:ni,getTypedArrayConstructor:ri,formatAlignment:si,alignTo:ai}),ui=function(t){function e(){var e;return(e=t.call(this,Q.BUFFER)||this)._usage=rt.NONE,e._memUsage=ot.NONE,e._size=0,e._stride=1,e._count=0,e._flags=st.NONE,e._isBufferView=!1,e}return o(e,t),s(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(Ye),hi=function(t){function e(){var e;return(e=t.call(this,Q.COMMAND_BUFFER)||this)._queue=null,e._type=Ft.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return o(e,t),s(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(Ye),ci=function(){function t(){this._gfxAPI=J.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(tt.COUNT),this._formatFeatures=new Array(et.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new We,this._caps=new Xt,this._bindingMappingInfo=new ne,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map,this._bufferBarriers=new Map}var e=t.prototype;return e.hasFeature=function(t){return this._features[t]},e.getFormatFeatures=function(t){return this._formatFeatures[t]},s(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();ci.canvas=void 0;var li=function(t){function e(){var e;return(e=t.call(this,Q.SWAPCHAIN)||this)._transform=$.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return o(e,t),s(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(Ye),_i=function(t){function e(){var e;return(e=t.call(this,Q.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return o(e,t),s(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(Ye),di=String.prototype.charCodeAt;function fi(t){return this[t]}function pi(t,e){for(var i=t.length,n=e^i,r=0,s="string"==typeof t?di:fi;i>=4;){var a=255&s.call(t,r)|(255&s.call(t,++r))<<8|(255&s.call(t,++r))<<16|(255&s.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),i-=4,++r}switch(i){case 3:n^=(255&s.call(t,r+2))<<16;case 2:n^=(255&s.call(t,r+1))<<8;case 1:n=1540483477*(65535&(n^=255&s.call(t,r)))+((1540483477*(n>>>16)&65535)<<16)}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0}var mi=function(t){function e(){var e;return(e=t.call(this,Q.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new ue,e}o(e,t);var i=e.prototype;return i.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},i.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var i=this.attributes[e];t+=","+i.name+","+i.format+","+i.isNormalized+","+i.stream+","+i.isInstanced+","+i.location}return pi(t,666)},s(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo},set:function(t){this._drawInfo=t}}]),e}(Ye),gi=function(t){function e(){var e;return(e=t.call(this,Q.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}o(e,t);var i=e.prototype;return i.bindBuffer=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&qe){var s=this._layout.descriptorIndices[t];this._buffers[s+i]!==e&&(this._buffers[s+i]=e,this._isDirty=!0)}},i.bindSampler=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&Qe){var s=this._layout.descriptorIndices[t];this._samplers[s+i]!==e&&(this._samplers[s+i]=e,this._isDirty=!0)}},i.bindTexture=function(t,e,i){void 0===i&&(i=0);var n=this._layout.bindingIndices[t],r=this._layout.bindings[n];if(r&&r.descriptorType&Qe){var s=this._layout.descriptorIndices[t];this._textures[s+i]!==e&&(this._textures[s+i]=e,this._isDirty=!0)}},i.getBuffer=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._buffers[i+e]},i.getSampler=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._samplers[i+e]},i.getTexture=function(t,e){void 0===e&&(e=0);var i=this._layout.descriptorIndices[t];return this._textures[i+e]},s(e,[{key:"layout",get:function(){return this._layout}}]),e}(Ye),vi=function(t){function e(){var e;return(e=t.call(this,Q.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return o(e,t),s(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(Ye),yi=function(t){function e(){var e;return(e=t.call(this,Q.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return o(e,t),s(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(Ye),Ti=function(){function t(t,e,i,n,r,s,a,o,u,h,c,l){void 0===t&&(t=!1),void 0===e&&(e=Mt.FILL),void 0===i&&(i=It.GOURAND),void 0===n&&(n=Ct.BACK),void 0===r&&(r=!0),void 0===s&&(s=!1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=!0),void 0===c&&(c=!1),void 0===l&&(l=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=r,this.depthBiasEnabled=s,this.depthBias=a,this.depthBiasClamp=o,this.depthBiasSlop=u,this.isDepthClip=h,this.isMultisample=c,this.lineWidth=l}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=Mt.FILL,this.shadeModel=It.GOURAND,this.cullMode=Ct.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},s(t,[{key:"native",get:function(){return this}}]),t}(),Ei=function(){function t(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p,m,g,v){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===i&&(i=mt.LESS),void 0===n&&(n=!1),void 0===r&&(r=mt.ALWAYS),void 0===s&&(s=65535),void 0===a&&(a=65535),void 0===o&&(o=gt.KEEP),void 0===u&&(u=gt.KEEP),void 0===h&&(h=gt.KEEP),void 0===c&&(c=1),void 0===l&&(l=!1),void 0===_&&(_=mt.ALWAYS),void 0===d&&(d=65535),void 0===f&&(f=65535),void 0===p&&(p=gt.KEEP),void 0===m&&(m=gt.KEEP),void 0===g&&(g=gt.KEEP),void 0===v&&(v=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=r,this.stencilReadMaskFront=s,this.stencilWriteMaskFront=a,this.stencilFailOpFront=o,this.stencilZFailOpFront=u,this.stencilPassOpFront=h,this.stencilRefFront=c,this.stencilTestBack=l,this.stencilFuncBack=_,this.stencilReadMaskBack=d,this.stencilWriteMaskBack=f,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=g,this.stencilRefBack=v}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=mt.LESS,this.stencilTestFront=!1,this.stencilFuncFront=mt.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=gt.KEEP,this.stencilZFailOpFront=gt.KEEP,this.stencilPassOpFront=gt.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=mt.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=gt.KEEP,this.stencilZFailOpBack=gt.KEEP,this.stencilPassOpBack=gt.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},s(t,[{key:"native",get:function(){return this}}]),t}(),Si=function(){function t(t,e,i,n,r,s,a,o){void 0===t&&(t=!1),void 0===e&&(e=vt.ONE),void 0===i&&(i=vt.ZERO),void 0===n&&(n=yt.ADD),void 0===r&&(r=vt.ONE),void 0===s&&(s=vt.ZERO),void 0===a&&(a=yt.ADD),void 0===o&&(o=Tt.ALL),this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=r,this.blendDstAlpha=s,this.blendAlphaEq=a,this.blendColorMask=o}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=vt.ONE,this.blendDst=vt.ZERO,this.blendEq=yt.ADD,this.blendSrcAlpha=vt.ONE,this.blendDstAlpha=vt.ZERO,this.blendAlphaEq=yt.ADD,this.blendColorMask=Tt.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),Ai=function(){function t(t,e,i,n){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===i&&(i=new ie),void 0===n&&(n=[new Si]),this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=n}var e=t.prototype;return e.setTarget=function(t,e){var i=this.targets[t];i||(i=this.targets[t]=new Si),Object.assign(i,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},s(t,[{key:"native",get:function(){return this}}]),t}(),Ri=function(t,e,i,n,r,s,a,o,u,h){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),void 0===n&&(n=new Ge),void 0===r&&(r=new Ti),void 0===s&&(s=new Ei),void 0===a&&(a=new Ai),void 0===o&&(o=Ot.TRIANGLE_LIST),void 0===u&&(u=xt.NONE),void 0===h&&(h=bt.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=i,this.inputState=n,this.rasterizerState=r,this.depthStencilState=s,this.blendState=a,this.primitive=o,this.dynamicStates=u,this.bindPoint=h},wi=function(t){function e(){var e;return(e=t.call(this,Q.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Ot.TRIANGLE_LIST,e._is=null,e._rs=new Ti,e._dss=new Ei,e._bs=new Ai,e._dynamicStates=xt.NONE,e._renderPass=null,e}return o(e,t),s(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(Ye),bi=function(t){function e(){var e;return(e=t.call(this,Q.QUEUE)||this)._type=Pt.GRAPHICS,e}return o(e,t),s(e,[{key:"type",get:function(){return this._type}}]),e}(Ye),Oi=function(t){function e(){var e;return(e=t.call(this,Q.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return o(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var i=this._subpasses[e];if(i.inputs.length){t+="ia";for(var n=0;n<i.inputs.length;++n){var r=this._colorInfos[i.inputs[n]];t+=","+r.format+","+r.sampleCount}}if(i.colors.length){t+="ca";for(var s=0;s<i.inputs.length;++s){var a=this._colorInfos[i.inputs[s]];t+=","+a.format+","+a.sampleCount}}if(i.depthStencil>=0){var o=this._colorInfos[i.depthStencil];t+="ds,"+o.format+","+o.sampleCount}}else{t+="ca";for(var u=0;u<this._colorInfos.length;++u){var h=this._colorInfos[u];t+=","+h.format+","+h.sampleCount}var c=this._depthStencilInfo;c&&(t+="ds,"+c.format+","+c.sampleCount)}return pi(t,666)},s(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(Ye),Mi=function(t){function e(e,i){var n;return(n=t.call(this,Q.SAMPLER)||this)._info=new de,n._hash=0,n._info.copy(e),n._hash=i,n}return o(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new de;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},s(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Ye),Ii=function(t){function e(){var e;return(e=t.call(this,Q.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return o(e,t),s(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(Ye),Ci=function(t){function e(){var e;return(e=t.call(this,Q.TEXTURE)||this)._info=new le,e._viewInfo=new _e,e._isPowerOf2=!1,e._isTextureView=!1,e._size=0,e}return o(e,t),e.getLevelCount=function(t,e){return Math.floor(Math.log2(Math.max(t,e)))},s(e,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}]),e}(Ye),xi=function(t){function e(e,i){var n;return(n=t.call(this,Q.GLOBAL_BARRIER)||this)._info=new xe,n._hash=0,n._info.copy(e),n._hash=i,n}return o(e,t),e.computeHash=function(t){return pi(t.prevAccesses+" "+t.nextAccesses+" "+t.type,666)},s(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Ye),Ni=function(t){function e(e,i){var n;return(n=t.call(this,Q.TEXTURE_BARRIER)||this)._info=new Ne,n._hash=0,n._info.copy(e),n._hash=i,n}return o(e,t),e.computeHash=function(t){var e=t.prevAccesses+" "+t.nextAccesses;return e+=t.type,e+=t.baseMipLevel,e+=t.levelCount,e+=t.baseSlice,e+=t.sliceCount,e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,pi(e+=t.dstQueue?t.dstQueue.type:0,666)},s(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Ye),Bi=function(t){function e(e,i){var n;return(n=t.call(this,Q.BUFFER_BARRIER)||this)._info=new Be,n._hash=0,n._info.copy(e),n._hash=i,n}return o(e,t),e.computeHash=function(t){var e=t.prevAccesses+" "+t.nextAccesses;return e+=t.type,e+=t.offset,e+=t.size,e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,pi(e+=t.dstQueue?t.dstQueue.type:0,666)},s(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Ye),Pi={Device:ci,Swapchain:li,Buffer:ui,Texture:Ci,Sampler:Mi,Shader:Ii,InputAssembler:mi,RenderPass:Oi,Framebuffer:_i,DescriptorSet:gi,DescriptorSetLayout:vi,PipelineLayout:yi,PipelineState:wi,CommandBuffer:hi,Queue:bi,GeneralBarrier:xi,TextureBarrier:Ni,BufferBarrier:Bi,RasterizerState:Ti,BlendState:Ai,BlendTarget:Si,DepthStencilState:Ei,PipelineStateInfo:Ri};Object.assign(Pi,oi),v.gfx=Pi;var Di=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},s(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function Fi(t,e){t.splice(e,1)}function Li(t,e){var i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function Ui(t,e){var i=t.indexOf(e);return i>=0&&(Fi(t,i),!0)}var Gi=Object.freeze({__proto__:null,removeAt:Fi,fastRemoveAt:Li,remove:Ui,fastRemove:function(t,e){var i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)},removeIf:function(t,e){var i=t.findIndex(e);if(i>=0){var n=t[i];return Fi(t,i),n}},verifyType:function(t,e){if(t&&t.length>0)for(var i,n=p(t);!(i=n()).done;)if(!(i.value instanceof e))return L(1300),!1;return!0},removeArray:function(t,e){for(var i=0,n=e.length;i<n;i++)Ui(t,e[i])},appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0].concat(e)),t},contains:function(t,e){return t.indexOf(e)>=0},copy:function(t){for(var e=t.length,i=new Array(e),n=0;n<e;n+=1)i[n]=t[n];return i},MutableForwardIterator:Di}),ki=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,Li(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),zi=function(){function t(){this._poolHandle=-1,ki.addContainer(this)}return t.prototype.destroy=function(){ki.removeContainer(this)},t}(),Hi=t("Pool",function(t){function e(e,i,n){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=n||null,r._elementsPerBatch=Math.max(i,1),r._nextAvail=r._elementsPerBatch-1;for(var s=0;s<r._elementsPerBatch;++s)r._freepool.push(e());return r}o(e,t);var i=e.prototype;return i.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},i.free=function(t){this._freepool[++this._nextAvail]=t},i.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},i.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},i.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&G(14100);var i=e||this._dtor;if(i)for(var n=0;n<=this._nextAvail;n++)i(this._freepool[n]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(zi)),Vi=t("RecyclePool",function(t){function e(e,i,n){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=n||null,r._data=new Array(i),r._initSize=i;for(var s=0;s<i;++s)r._data[s]=e();return r}o(e,t);var i=e.prototype;return i.reset=function(){this._count=0},i.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},i.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},i.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},i.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},i.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}},s(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(zi)),Wi=t("CachedArray",function(t){function e(e,i){var n;return(n=t.call(this)||this).array=void 0,n.length=0,n._compareFn=void 0,n._initSize=0,n.array=new Array(e),n._initSize=e,n.length=0,n._compareFn=i,n}o(e,t);var i=e.prototype;return i.push=function(t){this.array[this.length++]=t},i.pop=function(){return this.array[--this.length]},i.get=function(t){return this.array[t]},i.clear=function(){this.length=0},i.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},i.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},i.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},i.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},i.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},i.indexOf=function(t){for(var e=0,i=this.length;e<i;++e)if(this.array[e]===t)return e;return-1},e}(zi));t("memop",Object.freeze({__proto__:null,Pool:Hi,RecyclePool:Vi,CachedArray:Wi}));var Xi=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();Xi.global=new Xi("global");var ji=new Xi("TmpCId."),Yi="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),Ki="__cid__";function qi(t){return"number"==typeof t||t instanceof Number}function Qi(t){return"string"==typeof t||t instanceof String}function Zi(t){for(var e in t)return!1;return!0}var Ji,$i=(Ji={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,i,n,r){Ji.value=i,Ji.writable=n,Ji.enumerable=r,Object.defineProperty(t,e,Ji),Ji.value=void 0}),tn=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,i,n,r,s,a){void 0===s&&(s=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(s=r,r=void 0),t.get=n,t.set=r,t.enumerable=s,t.configurable=a,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}}(),en=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,i,n,r,s){t.get=n,t.enumerable=r,t.configurable=s,Object.defineProperty(e,i,t),t.get=void 0}}(),nn=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,i,n,r,s){t.set=n,t.enumerable=r,t.configurable=s,Object.defineProperty(e,i,t),t.set=void 0}}();function rn(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function sn(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var i="";if(t.name&&(i=t.name),t.toString){var n,r=t.toString();(n="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===n.length&&(i=n[1])}return"Object"!==i?i:""}return t&&t.constructor?sn(t.constructor):""}function an(t,e,i,n){var r=/([^.]+)$/,s=r.exec(e)[0],a=r.exec(i)[0];function o(){return this[a]}n?tn(t,s,o,(function(t){this[a]=t})):en(t,s,o)}function on(t,e,i,n){for(var r in i)an(t,e+"."+r,i[r],n)}var un=/(%d)|(%s)/,hn=/%s/;function cn(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];if(0===arguments.length)return"";if(0===i.length)return""+t;var r="string"==typeof t&&un.test(t);if(r)for(var s,a=p(i);!(s=a()).done;){var o=s.value,u="number"==typeof o?un:hn;if(u.test(t)){var h=""+o;t=t.replace(u,h)}else t+=" "+o}else for(var c,l=p(i);!(c=l()).done;){var _=c.value;t+=" "+_}return t}function ln(){for(var t=arguments.length-1,e=new Array(t),i=0;i<t;++i)e[i]=arguments[i+1];return e}function _n(t,e){for(;t;){var i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function dn(t,e,i){var n=_n(e,t);n&&Object.defineProperty(i,t,n)}function fn(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var r=0,s=i;r<s.length;r++){var a=s[r];if(a){if("object"!=typeof a){z(5402,a);continue}for(var o in a)o in t||dn(o,a,t)}}return t}function pn(t){t=t||{};for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];for(var r=0,s=i;r<s.length;r++){var a=s[r];if(a){if("object"!=typeof a){z(5403,a);continue}for(var o in a)dn(o,a,t)}}return t}function mn(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function gn(t){var e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function vn(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=gn(t)))return!1;if(t===e)return!0}}return!1}function yn(t){for(var e=0,i=Object.keys(t);e<i.length;e++)delete t[i[e]]}var Tn=rn(!0),En=rn(!0);function Sn(t,e,i){return function(n,r){if(r.prototype.hasOwnProperty(t)&&delete e[r.prototype[t]],$i(r.prototype,t,n),n){var s=e[n];!i&&s&&s!==r?C("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=r}}}var An=Sn("__cid__",Tn,!1),Rn=Sn("__classname__",En,!0);function wn(t,e){if(Rn(t,e),!e.prototype.hasOwnProperty(Ki)){var i=t||ji.getNewId();i&&An(i,e)}}function bn(t,e){var i=En[e],n=Tn[e],r=!0;if(i&&i!==t&&(C('"'+e+'" has already been set as name or alias of another class.'),r=!1),n&&n!==t&&(C('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var s=t[Yi];s||(s=[],t[Yi]=s),s.push(e),En[e]=t,Tn[e]=t}}function On(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];for(var n=0,r=e;n<r.length;n++){var s=r[n],a=s.prototype,o=a.__cid__;o&&delete Tn[o];var u=a.__classname__;u&&delete En[u];var h=a[Yi];if(h)for(var c=0;c<h.length;++c){var l=h[c];delete En[l],delete Tn[l]}}}function Mn(t){return In(t)}function In(t){return Tn[t]}function Cn(t){return En[t]}function xn(t,e){return Nn(t,e)}function Nn(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(Ki))return t.prototype.__cid__;if(t&&t.constructor){var i=t.constructor.prototype;if(i&&i.hasOwnProperty(Ki))return t.__cid__}return""}var Bn=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var i=void 0===e?t:e,n=void 0===e?null:t;this.count=0,this._pool=new Array(i),this._cleanup=n}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),Pn=Gi,Dn={IDGenerator:Xi,Pool:Bn,array:Gi,isNumber:qi,isString:Qi,isEmptyObject:Zi,getPropertyDescriptor:_n,addon:fn,mixin:pn,extend:mn,getSuper:gn,isChildClassOf:vn,clear:yn,value:$i,getset:tn,get:en,set:nn,unregisterClass:On,getClassName:sn,setClassName:wn,setClassAlias:bn,getClassByName:Cn,getClassById:In,get _registeredClassNames(){return a({},En)},set _registeredClassNames(t){yn(En),Object.assign(En,t)},get _registeredClassIds(){return a({},Tn)},set _registeredClassIds(t){yn(Tn),Object.assign(Tn,t)},_getClassId:xn,getClassId:Nn,_setClassId:An,_getClassById:Mn,obsolete:an,obsoletes:on,formatStr:cn,shiftArguments:ln,createMap:rn};function Fn(t){if("__bitmask__"in t)return t;$i(t,"__bitmask__",null,!0);for(var e=-1,i=Object.keys(t),n=0;n<i.length;n++){var r=i[n],s=t[r];if(-1===s)s=++e,t[r]=s;else if("number"==typeof s)e=s;else if("string"==typeof s&&Number.isInteger(parseFloat(r)))continue;var a=""+s;r!==a&&$i(t,a,r)}return t}function Ln(t){return"__enums__"in t?t:($i(t,"__enums__",null,!0),Ln.update(t))}function Un(t){t.hasOwnProperty("__enums__")}function Gn(t){Un(t);var e=t.__enums__||[];for(var i in e.length=0,t){var n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function kn(t){"__enums__"in t||$i(t,"__enums__",null,!0)}v.js=Dn,t("js",Object.freeze({__proto__:null,array:Pn,js:Dn,IDGenerator:Xi,Pool:Bn,isNumber:qi,isString:Qi,isEmptyObject:Zi,value:$i,getset:tn,get:en,set:nn,createMap:rn,getClassName:sn,obsolete:an,obsoletes:on,formatStr:cn,shiftArguments:ln,getPropertyDescriptor:_n,copyAllProperties:function(t,e,i){for(var n=Object.getOwnPropertyNames(t),r=0,s=n.length;r<s;++r){var a=n[r];-1===i.indexOf(a)&&dn(a,t,e)}},addon:fn,mixin:pn,extend:mn,getSuper:gn,isChildClassOf:vn,clear:yn,_idToClass:Tn,_nameToClass:En,_setClassId:An,setClassName:wn,setClassAlias:bn,unregisterClass:On,_getClassById:Mn,getClassById:In,getClassByName:Cn,_getClassId:xn,getClassId:Nn})),Fn.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},Fn.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var i in t){var n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort((function(t,e){return t.value-e.value})),e},v.BitMask=Fn,Ln.update=function(t){for(var e=-1,i=Object.keys(t),n=0;n<i.length;n++){var r=i[n],s=t[r];if(-1===s)s=++e,t[r]=s;else if("number"==typeof s)e=s;else if("string"==typeof s&&Number.isInteger(parseFloat(r)))continue;var a=""+s;r!==a&&$i(t,a,r)}return Array.isArray(t.__enums__)&&Gn(t),t},Ln||(Ln=t("Enum",{})),Ln.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},Ln.getList=function(t){return Un(t),t.__enums__?t.__enums__:Gn(t)},v.Enum=Ln;var zn,Hn=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return z(100,sn(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){z(100,sn(this)+".set")},e.toString=function(){return""},t}());wn("cc.ValueType",Hn),v.ValueType=Hn,function(t){t.PATH="path",t.ENGINE="engine",t.ASSETS="assets",t.SCRIPTING="scripting",t.PHYSICS="physics",t.RENDERING="rendering",t.LAUNCH="launch",t.SCREEN="screen",t.SPLASH_SCREEN="splashScreen",t.ANIMATION="animation",t.PROFILING="profiling",t.PLUGINS="plugins"}(zn||(zn={}));var Vn=t("Settings",function(){function t(){this._settings={},this._override={}}var e=t.prototype;return e.init=function(t,e){var i=this;for(var n in void 0===t&&(t=""),void 0===e&&(e={}),e){var r=e[n];if(r)for(var s in r)this.overrideSettings(n,s,r[s])}return t?new Promise((function(e,n){console.time("Settings 3");var r=new XMLHttpRequest;r.open("GET",t),r.responseType="text",r.onload=function(){i._settings=JSON.parse(r.response),console.timeEnd("Settings 3"),e()},r.onerror=function(){n(new Error("request settings failed!"))},r.send(null)})):Promise.resolve()},e.overrideSettings=function(t,e,i){t in this._override||(this._override[t]={}),this._override[t][e]=i},e.querySettings=function(t,e){if(t in this._override){var i=this._override[t];if(i&&e in i)return i[e]}if(t in this._settings){var n=this._settings[t];if(n&&e in n)return n[e]}return null},t}());Vn.Category=zn;var Wn=t("settings",new Vn);v.settings=Wn;var Xn=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144,CUSTOM_PIPELINE_NAME:"",init:function(){var t=Wn.querySettings(Vn.Category.ENGINE,"macros");if(t)for(var e in t)Xn[e]=t[e]}});v.macro=Xn;for(var jn=/^(?:cc|dragonBones|sp|ccsg)\..+/,Yn=new Array(123),Kn=0;Kn<123;++Kn)Yn[Kn]=64;for(var qn=0;qn<64;++qn)Yn["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(qn)]=qn;var Qn=Yn;function Zn(t,e,i){function n(t,e,i,n){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[i]=r.get),r.set&&n&&(t[n]=r.set);else{var s=t[i];tn(t,e,s,t[n])}}for(var r,s=t.prototype,a=0;a<e.length;a++){var o=(r=e[a])[0].toUpperCase()+r.slice(1);n(s,r,"get"+o,"set"+o)}for(r in i){var u=i[r];n(s,r,u[0],u[1])}}function Jn(t,e,i,n){var r=t[e];r?Array.isArray(r)?n?(r.push(r[0]),r[0]=i):r.push(i):t[e]=n?[i,r]:[r,i]:t[e]=i}function $n(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}function tr(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:!!t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function er(t,e,i){t&&setTimeout((function(){t(e,i)}),0)}function ir(t){return!(!t||t.constructor!==Object)&&Zi(t)}function nr(t,e,i){if(e>i){var n=e;e=i,i=n}return t<e?e:t<i?t:i}function rr(t){return t*Xn.RAD}function sr(t){return t*Xn.DEG}v.misc={BUILTIN_CLASSID_RE:jn,BASE64_VALUES:Qn,propertyDefine:Zn,pushToMap:Jn,contains:$n,isDomNode:tr,callInNextTick:er,isPlainEmptyObj_DEV:ir,clampf:nr,degreesToRadians:rr,radiansToDegrees:sr},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:jn,BASE64_VALUES:Qn,propertyDefine:Zn,pushToMap:Jn,contains:$n,isDomNode:tr,callInNextTick:er,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ir,clampf:nr,degreesToRadians:rr,radiansToDegrees:sr}));var ar="$_$";function or(t,e){var i=e?Object.create(e):{};return $i(t,"__attrs__",i),i}function ur(t){if("function"!=typeof t)return or(t,cr(t.constructor));for(var e,i=v.Class.getInheritanceChain(t),n=i.length-1;n>=0;n--){var r=i[n];r.hasOwnProperty("__attrs__")&&r.__attrs__||or(r,(e=i[n+1])&&e.__attrs__)}return or(t,(e=i[0])&&e.__attrs__),t.__attrs__}function hr(t,e){var i=cr(t),n=e+ar,r={};for(var s in i)s.startsWith(n)&&(r[s.slice(n.length)]=i[s]);return r}function cr(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||ur(t)}function lr(t,e,i,n){cr(t)[e+ar+i]=n}var _r=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),dr=t("CCInteger",new _r("Integer",0));v.Integer=dr,v.CCInteger=dr;var fr=t("CCFloat",new _r("Float",0));v.Float=fr,v.CCFloat=fr;var pr=t("CCBoolean",new _r("Boolean",!1));v.Boolean=pr,v.CCBoolean=pr;var mr=t("CCString",new _r("String",""));function gr(t,e){return function(i,n){var r='"'+sn(i)+"."+n+'"',s=hr(i,n),a=s.type;if(a===dr||a===fr?a="Number":a!==mr&&a!==pr||(a=""+a),a===t){if(s.hasOwnProperty("default")){var o=s.default;if(void 0!==o&&!Array.isArray(o)&&!ir(o)){var u=typeof o,h=t.toLowerCase();if(u===h)if("object"===h){if(!o||o instanceof s.ctor)return;G(3605,r,sn(s.ctor))}else"Number"!==t&&G(3606,e,r,t);else{if("function"===u)return;t===mr.default&&null==o?G(3607,r):G(3611,e,r,u)}delete s.type}}}else G(3604,r)}}v.String=mr,v.CCString=mr;var vr=Object.freeze({__proto__:null,DELIMETER:ar,createAttrsSingle:or,createAttrs:ur,attr:hr,getClassAttrs:cr,setClassAttr:lr,PrimitiveType:_r,CCInteger:dr,CCFloat:fr,CCBoolean:pr,CCString:mr,getTypeChecker_ET:gr,getObjTypeChecker_ET:function(t){return function(e,i){gr("Object","type")(e,i);var n=cr(e)[i+ar+"default"],r=v.Class.getDefault(n);if(!Array.isArray(r)&&vn(t,v.ValueType)){var s=sn(t),a=cn('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',sn(e),i,s);n?M(a):G(3612,a,s,sn(e),i,s)}}}}),yr={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Tr(t,e,i,n){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,i.call(this,e)};var s={};for(var a in n[r]=s,yr){var o=yr[a];t.hasOwnProperty(a)&&(s[a]=t[a],o.canUsedInGet||delete t[a])}}}function Er(t,e,i,n){if(Array.isArray(e)){if(!(e.length>0))return z(5508,i,n);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=v.String:e===Boolean?t.type=v.Boolean:e===Number&&(t.type=v.Float))}function Sr(t,e,i){var n=t?{_short:!0}:{_short:!0,default:e};return i&&(n.type=i),n}function Ar(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Sr(e,[],t);if("function"==typeof t){var i=t;return Sr(e,vn(i,v.ValueType)?new i:null,i)}return Sr(e,t instanceof _r?t.default:t)}return null}var Rr,wr=[];function br(){return wr[wr.length-1]}v._RF={push:function(t,e,i,n){void 0===i&&(i=e,e=""),wr.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:n})},pop:function(){var t=wr.pop(),e=t.module,i=e.exports;if(i===t.exports){for(var n in i)return;e.exports=i=t.cls}},peek:br},function(t){t[t.STANDALONE=1]="STANDALONE",t[t.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",t[t.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(Rr||(Rr={}));var Or=ar,Mr="__ctors__",Ir="Enum",Cr="BitMask";function Nr(t,e,i,n){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,i),Ur(t,n,e,i)}function Br(t,e,i,n){var r=n.get;n.set,r&&(Ur(t,n,e,i),lr(t,i,"serializable",!1))}function Pr(t){return"function"==typeof t?t():t}function Dr(t){var e=t.name,i=t.extends,n=function(t,e,i){var n=v.Component,r=br();if(r&&vn(e,n)){if(vn(r.cls,n))return z(3615),null;t=t||r.script}var s=function(t,e,i){var n=i.ctor;return $i(n,Mr,!0,!0),n.prototype,e&&(n.$super=e),wn(t,n),n}(t,e,i);if(r)if(vn(e,n)){var a=r.uuid;a&&An(a,s),r.cls=s}else vn(r.cls,n)||(r.cls=s);return s}(e,i,t);e||(e=v.js.getClassName(n)),n._sealed=!0,i&&(i._sealed=!1),function(t,e,i,n){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),i)for(var r in function(t,e){for(var i in t){var n=t[i],r=Ar(n,!1);if(r&&(n=t[i]=r),n){var s=n.notify;s&&Tr(n,i,s,t),"type"in n&&Er(n,n.type,e,i)}}}(i,e),i){var s=i[r];s.get||s.set?Br(t,e,r,s):Nr(t,e,r,s)}var a=cr(t);t.__values__=t.__props__.filter((function(t){return!1!==a[t+Or+"serializable"]}))}(n,e,t.properties,i);var r=t.editor;return r&&vn(i,v.Component)&&v.Component._registerEditorProps(n,r),n}function Fr(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__values__")}Dr._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,Mr)},Dr.fastDefine=function(t,e,i){wn(t,e);for(var n=e.__props__=e.__values__=Object.keys(i),r=cr(e),s=0;s<n.length;s++){var a=n[s];r[a+Or+"visible"]=!1,r[a+Or+"default"]=i[a]}},Dr.Attr=vr,Dr.attr=hr,Dr.isCCClassOrFastDefined=Fr,Dr.getInheritanceChain=function(t){for(var e=[];t=gn(t);)t!==Object&&e.push(t);return e};var Lr={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ur(t,e,i,n){var r=null,s="";function a(){return s=n+Or,r=cr(t)}"type"in e&&void 0===e.type&&G(3660,n,i);var o=e.type;o&&(Lr[o]?(r||a())[s+"type"]=o:"Object"===o||("object"==typeof o?Ln.isEnum(o)?((r||a())[s+"type"]=Ir,r[s+"enumList"]=Ln.getList(o)):Fn.isBitMask(o)&&((r||a())[s+"type"]=Cr,r[s+"bitmaskList"]=Fn.getList(o)):"function"==typeof o&&((r||a())[s+"type"]="Object",r[s+"ctor"]=o))),"default"in e&&((r||a())[s+"default"]=e.default);var u,h=function(t,i){if(t in e){var n=e[t];typeof n===i&&((r||a())[s+t]=n)}};e.editorOnly&&((r||a())[s+"editorOnly"]=!0),e.__internalFlags&Rr.STANDALONE?u=!0===e.serializable||0!=(e.__internalFlags&Rr.IMPLICIT_SERIALIZABLE):!1===e.serializable&&(u=!1),void 0!==u&&((r||a())[s+"serializable"]=u),h("formerlySerializedAs","string");var c=e.range;c&&Array.isArray(c)&&c.length>=2&&((r||a())[s+"min"]=c[0],r[s+"max"]=c[1],c.length>2&&(r[s+"step"]=c[2])),h("min","number"),h("max","number"),h("step","number")}Dr.isArray=function(t){return t=Pr(t),Array.isArray(t)},Dr.getDefault=Pr,Dr.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Dr.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Dr.getNewValueTypeCode=function(t){for(var e=sn(t),i=t.constructor,n="new "+e+"(",r=0;r<i.__props__.length;r++)n+=t[i.__props__[r]],r<i.__props__.length-1&&(n+=",");return n+")"},v.Class=Dr;var Gr,kr=t("editorExtrasTag","__editorExtras__"),zr=1<<22,Hr=[],Vr=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=Hr.length,e=0;e<t;++e){var i=Hr[e];1&i._objFlags||i._destroyImmediate()}t===Hr.length?Hr.length=0:Hr.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(G(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Hr.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var i,n=t instanceof v._BaseNode||t instanceof v.Component,r=n?"_id":null,s={};for(i in t)if(t.hasOwnProperty(i)){if(i===r)continue;switch(typeof t[i]){case"string":s[i]="";break;case"object":case"function":s[i]=null}}if(Dr._isCCClass(e))for(var a=v.Class.Attr.getClassAttrs(e),o=e.__props__,u=0;u<o.length;u++){var h=""+(i=o[u]);if(h in a){if(n&&"_id"===i)continue;switch(typeof a[h]){case"string":s[i]="";break;case"object":case"function":s[i]=null;break;case"undefined":s[i]=void 0}}}var c="";for(i in s){var l;l=Dr.IDENTIFIER_RE.test(i)?"o."+i+"=":"o["+Dr.escapeForJS(i)+"]=";var _=s[i];""===_&&(_='""'),c+=l+_+";\n"}return Function("o",c)}(this,t),$i(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?z(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},s(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var i=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|i}},{key:"replicated",get:function(){return!!(this._objFlags&zr)},set:function(t){t?this._objFlags|=zr:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),Wr=Vr.prototype;function Xr(t){return t instanceof Vr}function jr(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}Wr._deserialize=null,Wr._onPreDestroy=null,Dr.fastDefine("cc.Object",Vr,((Gr={_name:"",_objFlags:0})[kr]={},Gr)),Dr.Attr.setClassAttr(Vr,kr,"editorOnly",!0),Dr.Attr.setClassAttr(Vr,"replicated","visible",!1),$i(Vr,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),v.isValid=jr,v.Object=Vr;var Yr=Pn.fastRemoveAt;function Kr(){}var qr=function(){function t(){this.callback=Kr,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,i){this.callback=t||Kr,this.target=e,this.once=!!i},e.reset=function(){this.target=void 0,this.callback=Kr,this.once=!1},e.check=function(){return!(Xr(this.target)&&!jr(this.target,!0))},t}(),Qr=new Hi((function(){return new qr}),32),Zr=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),Qr.free(i),Yr(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),Qr.free(i),Yr(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Yr(this.callbackInfos,t),Qr.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),Qr.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Yr(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),Jr=new Hi((function(){return new Zr}),16),$r=function(){function t(){this._callbackTable=rn(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,i,n){if(!this.hasEventListener(t,e,i)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=Jr.alloc());var s=Qr.alloc();s.set(e,i,n),r.callbackInfos.push(s)}return e},e.hasEventListener=function(t,e,i){var n=this._callbackTable&&this._callbackTable[t];if(!n)return!1;var r=n.callbackInfos;if(!e){if(n.isInvoking){for(var s=0;s<r.length;++s)if(r[s])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var o=r[a];if(o&&o.check()&&o.callback===e&&o.target===i)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var i=this._callbackTable&&this._callbackTable[t];i&&(i.isInvoking?i.cancelAll():(i.clear(),Jr.free(i),delete this._callbackTable[t]))}else if(t)for(var n in this._callbackTable){var r=this._callbackTable[n];if(r.isInvoking)for(var s=r.callbackInfos,a=0;a<s.length;++a){var o=s[a];o&&o.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,i){var n,r=this._callbackTable&&this._callbackTable[t];if(r){var s=r.callbackInfos;if(e)for(var a=0;a<s.length;++a){var o=s[a];if(o&&o.callback===e&&o.target===i){r.cancel(a);break}}else this.removeAll(t)}null===(n=this._offCallback)||void 0===n||n.call(this)},e.emit=function(t,e,i,n,r,s){var a=this._callbackTable&&this._callbackTable[t];if(a){var o=!a.isInvoking;a.isInvoking=!0;for(var u=a.callbackInfos,h=0,c=u.length;h<c;++h){var l=u[h];if(l){var _=l.callback,d=l.target;l.once&&this.off(t,_,d),l.check()?d?_.call(d,e,i,n,r,s):_(e,i,n,r,s):this.off(t,_,d)}}o&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),Jr.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function ts(t){for(var e=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._callbackTable=rn(!0),e}o(e,t);var i=e.prototype;return i.once=function(t,e,i){return this.on(t,e,i,!0)},i.targetOff=function(t){this.removeAll(t)},e}(t),i=$r.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i)),r=0;r<n.length;++r){var s=n[r];if(!(s in e.prototype)){var a=Object.getOwnPropertyDescriptor(i,s);a&&Object.defineProperty(e.prototype,s,a)}}return e}var es=t("EventTarget",ts((function(){})));v.EventTarget=es;var is,ns,rs,ss,as,os,us=t("AsyncDelegate",function(){function t(){this._delegates=[]}var e=t.prototype;return e.add=function(t){this._delegates.includes(t)||this._delegates.push(t)},e.hasListener=function(t){return this._delegates.includes(t)},e.remove=function(t){Dn.array.fastRemove(this._delegates,t)},e.dispatch=function(){for(var t=arguments,e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return Promise.all(this._delegates.map((function(e){return e.apply(void 0,t)})).filter(Boolean))},t}());!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(is||(is={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(ns||(ns={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(rs||(rs={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(ss||(ss={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(as||(as={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER",t.EVENT_GAMEPAD="EVENT_GAMEPAD",t.EVENT_HANDLE="EVENT_HANDLE",t.EVENT_HMD="EVENT_HMD"}(os||(os={}));var hs=new(function(t){function e(){var e,i,r;(r=t.call(this)||this).networkType=void 0,r.isNative=void 0,r.isBrowser=void 0,r.isMobile=void 0,r.isLittleEndian=void 0,r.platform=void 0,r.language=void 0,r.nativeLanguage=void 0,r.os=void 0,r.osVersion=void 0,r.osMainVersion=void 0,r.browserType=void 0,r.browserVersion=void 0,r.isXR=void 0,r._battery=void 0,r._featureMap=void 0;var s,a=window.navigator,o=a.userAgent.toLowerCase();null===(e=a.getBattery)||void 0===e||e.call(a).then((function(t){r._battery=t})),r.networkType=rs.LAN,r.isNative=!1,r.isBrowser=!0,r.isMobile=/mobile|android|iphone|ipad/.test(o),r.platform=r.isMobile?as.MOBILE_BROWSER:as.DESKTOP_BROWSER,r.isLittleEndian=(s=new ArrayBuffer(2),new DataView(s).setInt16(0,256,!0),256===new Int16Array(s)[0]);var u=a.language;r.nativeLanguage=u.toLowerCase(),u=(u=u||a.browserLanguage)?u.split("-")[0]:ns.ENGLISH,r.language=u;var h=!1,c=!1,l="",_=0,d=/android\s*(\d+(?:\.\d+)*)/i.exec(o)||/android\s*(\d+(?:\.\d+)*)/i.exec(a.platform);d&&(h=!0,l=d[1]||"",_=parseInt(l)||0),(d=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(o))?(c=!0,l=d[2]||"",_=parseInt(l)||0):(/(iPhone|iPad|iPod)/.exec(a.platform)||"MacIntel"===a.platform&&a.maxTouchPoints&&a.maxTouchPoints>1)&&(c=!0,l="",_=0);var f=ss.UNKNOWN;-1!==a.appVersion.indexOf("Win")?f=ss.WINDOWS:c?f=ss.IOS:-1!==a.appVersion.indexOf("Mac")?f=ss.OSX:-1!==a.appVersion.indexOf("X11")&&-1===a.appVersion.indexOf("Linux")?f=ss.LINUX:h?f=ss.ANDROID:-1===a.appVersion.indexOf("Linux")&&-1===o.indexOf("ubuntu")||(f=ss.LINUX),r.os=f,r.osVersion=l,r.osMainVersion=_,r.browserType=is.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(o)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(o)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(o)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(o),m=p?p[0].toLowerCase():ss.UNKNOWN;("safari"===m&&h||"qq"===m&&/android.*applewebkit/i.test(o))&&(m=is.ANDROID);var g={micromessenger:is.WECHAT,wechat:is.WECHAT,weixin:is.WECHAT,trident:is.IE,edge:is.EDGE,"360 aphone":is.BROWSER_360,mxbrowser:is.MAXTHON,"opr/":is.OPERA,ubrowser:is.UC,huaweibrowser:is.HUAWEI};r.browserType=g[m]||m,r.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(o);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(o)),r.browserVersion=v?v[4]:"",r.isXR=!1;var y,T=document.createElement("canvas");T.getContext("2d");try{y=T.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){y=!1}if(r.browserType===is.SAFARI){var E,S=null===(E=/ version\/(\d+)/.exec(o))||void 0===E?void 0:E[1];"string"==typeof S&&Number.parseInt(S)>=14&&(y=!0)}var A=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(T.width=T.height=2,createImageBitmap(T,{}).then((function(t){A=!0,null==t||t.close()})).catch((function(){})));var R=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart||n,w=void 0!==document.documentElement.onmouseup||n;return r._featureMap=((i={})[os.WEBP]=y,i[os.IMAGE_BITMAP]=A,i[os.WEB_VIEW]=!0,i[os.VIDEO_PLAYER]=!0,i[os.SAFE_AREA]=!1,i[os.INPUT_TOUCH]=R,i[os.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup||n,i[os.EVENT_MOUSE]=w,i[os.EVENT_TOUCH]=R||w,i[os.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,i[os.EVENT_GAMEPAD]=void 0!==navigator.getGamepads||void 0!==navigator.webkitGetGamepads,i[os.EVENT_HANDLE]=r.isXR,i[os.EVENT_HMD]=r.isXR,i),r._registerEvent(),r}o(e,t);var i=e.prototype;return i._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var i=!1,n=function(){i||(i=!0,e.emit("hide"))},r=function(t,n,r,s,a){i&&(i=!1,e.emit("show",t,n,r,s,a))};if(t)for(var s=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<s.length;a++)document.addEventListener(s[a],(function(e){var i=document[t];(i=i||e.hidden)?n():r()}));else window.addEventListener("blur",n),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",n),window.addEventListener("pageshow",r),document.addEventListener("pagehide",n),document.addEventListener("pageshow",r))},i.hasFeature=function(t){return this._featureMap[t]},i.getBatteryLevel=function(){return this._battery?this._battery.level:1},i.triggerGC=function(){},i.openURL=function(t){window.open(t)},i.now=function(){return Date.now?Date.now():+new Date},i.restartJSVM=function(){},i.close=function(){this.emit("close"),window.close()},e}(es)),cs=2147483647;function ls(t){return(t>0)-(t<0)}function _s(t){var e,i;return e=(t>65535)<<4,e|=i=((t>>>=e)>255)<<3,e|=i=((t>>>=i)>15)<<2,(e|=i=((t>>>=i)>3)<<1)|(t>>>=i)>>1}function ds(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24}function fs(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function ps(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}var ms=new Array(256);!function(t){for(var e=0;e<256;++e){var i=e,n=e,r=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--r;t[e]=n<<r&255}}(ms);var gs=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:cs,INT_MIN:-2147483648,sign:ls,abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:_s,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:ds,countTrailingZeros:fs,nextPow2:ps,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return ms[255&t]<<24|ms[t>>>8&255]<<16|ms[t>>>16&255]<<8|ms[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>fs(t)+1}});t("bits",gs);var vs=Math.PI/180,ys=180/Math.PI,Ts=t("EPSILON",1e-6);function Es(t,e){return Math.abs(t-e)<=Ts*Math.max(1,Math.abs(t),Math.abs(e))}function Ss(t,e,i){return i=i||Ts,Math.abs(t-e)<=i}function As(t,e,i){if(e>i){var n=e;e=i,i=n}return t<e?e:t>i?i:t}function Rs(t){return t<0?0:t>1?1:t}function ws(t,e,i){return t+(e-t)*i}function bs(t){return t*vs}function Os(t){return t*ys}var Ms=!0,Is=t("random",Ms?Bs:Math.random),Cs=0;function xs(e){Is=t("random",(Ms=e)?Bs:Math.random)}function Ns(t){Cs=t}function Bs(){return(Cs=(9301*Cs+49297)%233280)/233280}function Ps(t,e){return Is()*(e-t)+t}function Ds(t,e){return Math.floor(Ps(t,e))}function Fs(t){return(t=(9301*t+49297)%233280)/233280}function Ls(t,e,i){return Fs(t)*(i-e)+e}function Us(t,e,i){return Math.floor(Ls(t,e,i))}function Gs(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function ks(t,e){return t-Math.floor(t/e)*e}function zs(t,e){return t=ks(t,2*e),e-Math.abs(t-e)}function Hs(t,e,i){return(i-t)/(e-t)}function Vs(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function Ws(t,e){return Math.abs(t)>Math.abs(e)?t:e}function Xs(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var js=t("Vec3",function(t){function e(e,i,n){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=i||0,r.z=n||0),r}o(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,i,n){return t.x=e,t.y=i,t.z=n,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+n*n+r*r)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return i*i+n*n+r*r},e.len=function(t){var e=t.x,i=t.y,n=t.z;return Math.sqrt(e*e+i*i+n*n)},e.lengthSqr=function(t){var e=t.x,i=t.y,n=t.z;return e*e+i*i+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var i=e.x,n=e.y,r=e.z;return Math.abs(i)<Ts?t.x=0:t.x=1/i,Math.abs(n)<Ts?t.y=0:t.y=1/n,Math.abs(r)<Ts?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=e.z,s=i*i+n*n+r*r;return s>0&&(s=1/Math.sqrt(s),t.x=i*s,t.y=n*s,t.z=r*s),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=i.x,o=i.y,u=i.z;return t.x=r*u-s*o,t.y=s*a-n*u,t.z=n*o-r*a,t},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t},e.random=function(t,e){e=e||1;var i=2*Is()*Math.PI,n=2*Is()-1,r=Math.sqrt(1-n*n);return t.x=r*Math.cos(i)*e,t.y=r*Math.sin(i)*e,t.z=n*e,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=i.m03*n+i.m07*r+i.m11*s+i.m15;return a=a?Math.abs(1/a):1,t.x=(i.m00*n+i.m04*r+i.m08*s+i.m12)*a,t.y=(i.m01*n+i.m05*r+i.m09*s+i.m13)*a,t.z=(i.m02*n+i.m06*r+i.m10*s+i.m14)*a,t},e.transformMat4Normal=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=i.m03*n+i.m07*r+i.m11*s;return a=a?Math.abs(1/a):1,t.x=(i.m00*n+i.m04*r+i.m08*s)*a,t.y=(i.m01*n+i.m05*r+i.m09*s)*a,t.z=(i.m02*n+i.m06*r+i.m10*s)*a,t},e.transformMat3=function(t,e,i){var n=e.x,r=e.y,s=e.z;return t.x=n*i.m00+r*i.m03+s*i.m06,t.y=n*i.m01+r*i.m04+s*i.m07,t.z=n*i.m02+r*i.m05+s*i.m08,t},e.transformAffine=function(t,e,i){var n=e.x,r=e.y,s=e.z;return t.x=i.m00*n+i.m04*r+i.m08*s+i.m12,t.y=i.m01*n+i.m05*r+i.m09*s+i.m13,t.z=i.m02*n+i.m06*r+i.m10*s+i.m14,t},e.transformQuat=function(t,e,i){var n=i.w*e.x+i.y*e.z-i.z*e.y,r=i.w*e.y+i.z*e.x-i.x*e.z,s=i.w*e.z+i.x*e.y-i.y*e.x,a=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=n*i.w+a*-i.x+r*-i.z-s*-i.y,t.y=r*i.w+a*-i.y+s*-i.x-n*-i.z,t.z=s*i.w+a*-i.z+n*-i.y-r*-i.x,t},e.transformRTS=function(t,e,i,n,r){var s=e.x*r.x,a=e.y*r.y,o=e.z*r.z,u=i.w*s+i.y*o-i.z*a,h=i.w*a+i.z*s-i.x*o,c=i.w*o+i.x*a-i.y*s,l=-i.x*s-i.y*a-i.z*o;return t.x=u*i.w+l*-i.x+h*-i.z-c*-i.y+n.x,t.y=h*i.w+l*-i.y+c*-i.x-u*-i.z+n.y,t.z=c*i.w+l*-i.z+u*-i.y-h*-i.x+n.z,t},e.transformInverseRTS=function(t,e,i,n,r){var s=e.x-n.x,a=e.y-n.y,o=e.z-n.z,u=i.w*s-i.y*o+i.z*a,h=i.w*a-i.z*s+i.x*o,c=i.w*o-i.x*a+i.y*s,l=i.x*s+i.y*a+i.z*o;return t.x=(u*i.w+l*i.x+h*i.z-c*i.y)/r.x,t.y=(h*i.w+l*i.y+c*i.x-u*i.z)/r.y,t.z=(c*i.w+l*i.z+u*i.y-h*i.x)/r.z,t},e.rotateX=function(t,e,i,n){var r=e.x-i.x,s=e.y-i.y,a=e.z-i.z,o=Math.cos(n),u=Math.sin(n),h=r,c=s*o-a*u,l=s*u+a*o;return t.x=h+i.x,t.y=c+i.y,t.z=l+i.z,t},e.rotateY=function(t,e,i,n){var r=e.x-i.x,s=e.y-i.y,a=e.z-i.z,o=Math.cos(n),u=Math.sin(n),h=a*u+r*o,c=s,l=a*o-r*u;return t.x=h+i.x,t.y=c+i.y,t.z=l+i.z,t},e.rotateZ=function(t,e,i,n){var r=e.x-i.x,s=e.y-i.y,a=e.z-i.z,o=Math.cos(n),u=Math.sin(n),h=r*o-s*u,c=r*u+s*o,l=a;return t.x=h+i.x,t.y=c+i.y,t.z=l+i.z,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,i){void 0===i&&(i=Ts);var n=t.x,r=t.y,s=t.z,a=e.x,o=e.y,u=e.z;return Math.abs(n-a)<=i*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(r-o)<=i*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-u)<=i*Math.max(1,Math.abs(s),Math.abs(u))},e.angle=function(t,i){e.normalize(Ys,t),e.normalize(Ks,i);var n=e.dot(Ys,Ks);return n>1?0:n<-1?Math.PI:Math.acos(n)},e.projectOnPlane=function(t,i,n){return e.subtract(t,i,e.project(t,i,n))},e.project=function(t,i,n){var r=e.lengthSqr(n);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,n,e.dot(i,n)/r)};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z)},i.set=function(t,e,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=i||0),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},i.equals3f=function(t,e,i,n){return void 0===n&&(n=Ts),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=n*Math.max(1,Math.abs(this.z),Math.abs(i))},i.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},i.strictEquals3f=function(t,e,i){return this.x===t&&this.y===e&&this.z===i},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},i.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},i.add3f=function(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},i.subtract3f=function(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},i.multiply3f=function(t,e,i){return this.x*=t,this.y*=e,this.z*=i,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},i.divide3f=function(t,e,i){return this.x/=t,this.y/=e,this.z/=i,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},i.clampf=function(t,e){return this.x=As(this.x,t.x,e.x),this.y=As(this.y,t.y,e.y),this.z=As(this.z,t.z,e.z),this},i.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},i.cross=function(t){var e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,a=t.z;return this.x=i*a-n*s,this.y=n*r-e*a,this.z=e*s-i*r,this},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},i.normalize=function(){var t=this.x,e=this.y,i=this.z,n=t*t+e*e+i*i;return n>0&&(n=1/Math.sqrt(n),this.x=t*n,this.y=e*n,this.z=i*n),this},i.transformMat4=function(t){var e=this.x,i=this.y,n=this.z,r=t.m03*e+t.m07*i+t.m11*n+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*i+t.m08*n+t.m12)*r,this.y=(t.m01*e+t.m05*i+t.m09*n+t.m13)*r,this.z=(t.m02*e+t.m06*i+t.m10*n+t.m14)*r,this},e}(Hn));js.UNIT_X=Object.freeze(new js(1,0,0)),js.UNIT_Y=Object.freeze(new js(0,1,0)),js.UNIT_Z=Object.freeze(new js(0,0,1)),js.RIGHT=Object.freeze(new js(1,0,0)),js.UP=Object.freeze(new js(0,1,0)),js.FORWARD=Object.freeze(new js(0,0,-1)),js.ZERO=Object.freeze(new js(0,0,0)),js.ONE=Object.freeze(new js(1,1,1)),js.NEG_ONE=Object.freeze(new js(-1,-1,-1));var Ys=new js,Ks=new js;function qs(t,e,i){return new js(t,e,i)}Dr.fastDefine("cc.Vec3",js,{x:0,y:0,z:0}),v.Vec3=js,v.v3=qs;var Qs=t("Vec2",function(t){function e(e,i){var n;return n=t.call(this)||this,e&&"object"==typeof e?(n.x=e.x,n.y=e.y):(n.x=e||0,n.y=i||0),n}o(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,i){return t.x=e,t.y=i,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},e.len=function(t){var e=t.x,i=t.y;return Math.sqrt(e*e+i*i)},e.lengthSqr=function(t){var e=t.x,i=t.y;return e*e+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var i=e.x,n=e.y;return Math.abs(i)<Ts?t.x=0:t.x=1/i,Math.abs(n)<Ts?t.y=0:t.y=1/n,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=i*i+n*n;return r>0&&(r=1/Math.sqrt(r),t.x=i*r,t.y=n*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,i){return t instanceof js?(t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,i,n){var r=e.x,s=e.y;return t.x=r+n*(i.x-r),t.y=s+n*(i.y-s),t},e.random=function(t,e){e=e||1;var i=2*Is()*Math.PI;return t.x=Math.cos(i)*e,t.y=Math.sin(i)*e,t},e.transformMat3=function(t,e,i){var n=e.x,r=e.y;return t.x=i.m00*n+i.m03*r+i.m06,t.y=i.m01*n+i.m04*r+i.m07,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y;return t.x=i.m00*n+i.m04*r+i.m12,t.y=i.m01*n+i.m05*r+i.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,i){e.normalize(Zs,t),e.normalize(Js,i);var n=e.dot(Zs,Js);return n>1?0:n<-1?Math.PI:Math.acos(n)};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y)},i.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},i.equals2f=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))},i.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},i.strictEquals2f=function(t,e){return this.x===t&&this.y===e},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},i.lerp=function(t,e){var i=this.x,n=this.y;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this},i.clampf=function(t,e){return this.x=As(this.x,t.x,e.x),this.y=As(this.y,t.y,e.y),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this},i.add2f=function(t,e){return this.x+=t,this.y+=e,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},i.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},i.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this},i.divide2f=function(t,e){return this.x/=t,this.y/=e,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this},i.dot=function(t){return this.x*t.x+this.y*t.y},i.cross=function(t){return this.x*t.y-this.y*t.x},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y},i.normalize=function(){var t=this.x,e=this.y,i=t*t+e*e;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this},i.angle=function(t){var e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return console.warn("Can't get angle between zero vector"),0;var n=this.dot(t)/Math.sqrt(e*i);return n=As(n,-1,1),Math.acos(n)},i.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},i.rotate=function(t){var e=this.x,i=this.y,n=Math.sin(t),r=Math.cos(t);return this.x=r*e-n*i,this.y=n*e+r*i,this},i.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},i.transformMat4=function(t){var e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this},e}(Hn));Qs.ZERO=Object.freeze(new Qs(0,0)),Qs.ONE=Object.freeze(new Qs(1,1)),Qs.NEG_ONE=Object.freeze(new Qs(-1,-1)),Qs.UNIT_X=Object.freeze(new Qs(1,0)),Qs.UNIT_Y=Object.freeze(new Qs(0,1));var Zs=new Qs,Js=new Qs;function $s(t,e){return new Qs(t,e)}Dr.fastDefine("cc.Vec2",Qs,{x:0,y:0}),v.Vec2=Qs,v.v2=$s;var ta=t("Vec4",function(t){function e(e,i,n,r){var s;return s=t.call(this)||this,e&&"object"==typeof e?(s.x=e.x,s.y=e.y,s.z=e.z,s.w=e.w):(s.x=e||0,s.y=i||0,s.z=n||0,s.w=r||0),s}o(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,i,n,r){return t.x=e,t.y=i,t.z=n,t.w=r,t},e.add=function(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t},e.subtract=function(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t},e.multiply=function(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t},e.divide=function(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t.w=Math.min(e.w,i.w),t},e.max=function(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t.w=Math.max(e.w,i.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t},e.distance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,s=e.w-t.w;return Math.sqrt(i*i+n*n+r*r+s*s)},e.squaredDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z,s=e.w-t.w;return i*i+n*n+r*r+s*s},e.len=function(t){var e=t.x,i=t.y,n=t.z,r=t.w;return Math.sqrt(e*e+i*i+n*n+r*r)},e.lengthSqr=function(t){var e=t.x,i=t.y,n=t.z,r=t.w;return e*e+i*i+n*n+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var i=e.x,n=e.y,r=e.z,s=e.w;return Math.abs(i)<Ts?t.x=0:t.x=1/i,Math.abs(n)<Ts?t.y=0:t.y=1/n,Math.abs(r)<Ts?t.z=0:t.z=1/r,Math.abs(s)<Ts?t.w=0:t.w=1/s,t},e.normalize=function(t,e){var i=e.x,n=e.y,r=e.z,s=e.w,a=i*i+n*n+r*r+s*s;return a>0&&(a=1/Math.sqrt(a),t.x=i*a,t.y=n*a,t.z=r*a,t.w=s*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t},e.random=function(t,e){e=e||1;var i=2*Is()*Math.PI,n=2*Is()-1,r=Math.sqrt(1-n*n);return t.x=r*Math.cos(i)*e,t.y=r*Math.sin(i)*e,t.z=n*e,t.w=0,t},e.transformMat4=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=e.w;return t.x=i.m00*n+i.m04*r+i.m08*s+i.m12*a,t.y=i.m01*n+i.m05*r+i.m09*s+i.m13*a,t.z=i.m02*n+i.m06*r+i.m10*s+i.m14*a,t.w=i.m03*n+i.m07*r+i.m11*s+i.m15*a,t},e.transformAffine=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=e.w;return t.x=i.m00*n+i.m04*r+i.m08*s+i.m12*a,t.y=i.m01*n+i.m05*r+i.m09*s+i.m13*a,t.z=i.m02*n+i.m06*r+i.m10*s+i.m14*a,t.w=e.w,t},e.transformQuat=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=i.x,o=i.y,u=i.z,h=i.w,c=h*n+o*s-u*r,l=h*r+u*n-a*s,_=h*s+a*r-o*n,d=-a*n-o*r-u*s;return t.x=c*h+d*-a+l*-u-_*-o,t.y=l*h+d*-o+_*-a-c*-u,t.z=_*h+d*-u+c*-o-l*-a,t.w=e.w,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z,this.w)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},i.equals4f=function(t,e,i,n,r){return void 0===r&&(r=Ts),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=r*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=r*Math.max(1,Math.abs(this.w),Math.abs(n))},i.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},i.strictEquals4f=function(t,e,i,n){return this.x===t&&this.y===e&&this.z===i&&this.w===n},i.lerp=function(t,e){var i=this.x,n=this.y,r=this.z,s=this.w;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this.z=r+e*(t.z-r),this.w=s+e*(t.w-s),this},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},i.clampf=function(t,e){return this.x=As(this.x,t.x,e.x),this.y=As(this.y,t.y,e.y),this.z=As(this.z,t.z,e.z),this.w=As(this.w,t.w,e.w),this},i.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},i.add4f=function(t,e,i,n){return this.x+=t,this.y+=e,this.z+=i,this.w+=n,this},i.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},i.subtract4f=function(t,e,i,n){return this.x-=t,this.y-=e,this.z-=i,this.w-=n,this},i.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},i.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},i.multiply4f=function(t,e,i,n){return this.x*=t,this.y*=e,this.z*=i,this.w*=n,this},i.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},i.divide4f=function(t,e,i,n){return this.x/=t,this.y/=e,this.z/=i,this.w/=n,this},i.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},i.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},i.cross=function(t){var e=this.x,i=this.y,n=this.z,r=t.x,s=t.y,a=t.z;return this.x=i*a-n*s,this.y=n*r-e*a,this.z=e*s-i*r,this},i.length=function(){var t=this.x,e=this.y,i=this.z,n=this.w;return Math.sqrt(t*t+e*e+i*i+n*n)},i.lengthSqr=function(){var t=this.x,e=this.y,i=this.z,n=this.w;return t*t+e*e+i*i+n*n},i.normalize=function(){var t=this.x,e=this.y,i=this.z,n=this.w,r=t*t+e*e+i*i+n*n;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=i*r,this.w=n*r),this},i.transformMat4=function(t){var e=this.x,i=this.y,n=this.z,r=this.w;return this.x=t.m00*e+t.m04*i+t.m08*n+t.m12*r,this.y=t.m01*e+t.m05*i+t.m09*n+t.m13*r,this.z=t.m02*e+t.m06*i+t.m10*n+t.m14*r,this.w=t.m03*e+t.m07*i+t.m11*n+t.m15*r,this},e}(Hn));function ea(t,e,i,n){return new ta(t,e,i,n)}ta.ZERO=Object.freeze(new ta(0,0,0,0)),ta.ONE=Object.freeze(new ta(1,1,1,1)),ta.NEG_ONE=Object.freeze(new ta(-1,-1,-1,-1)),Dr.fastDefine("cc.Vec4",ta,{x:0,y:0,z:0,w:0}),v.Vec4=ta,v.v4=ea;var ia=t("Mat3",function(t){function e(e,i,n,r,s,a,o,u,h){var c;return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=1),c=t.call(this)||this,"object"==typeof e?(c.m00=e.m00,c.m01=e.m01,c.m02=e.m02,c.m03=e.m03,c.m04=e.m04,c.m05=e.m05,c.m06=e.m06,c.m07=e.m07,c.m08=e.m08):(c.m00=e,c.m01=i,c.m02=n,c.m03=r,c.m04=s,c.m05=a,c.m06=o,c.m07=u,c.m08=h),c}o(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,i,n,r,s,a,o,u,h){return t.m00=e,t.m01=i,t.m02=n,t.m03=r,t.m04=s,t.m05=a,t.m06=o,t.m07=u,t.m08=h,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var i=e.m01,n=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=n,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var i=e.m00,n=e.m01,r=e.m02,s=e.m03,a=e.m04,o=e.m05,u=e.m06,h=e.m07,c=e.m08,l=c*a-o*h,_=-c*s+o*u,d=h*s-a*u,f=i*l+n*_+r*d;return 0===f?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(f=1/f,t.m00=l*f,t.m01=(-c*n+r*h)*f,t.m02=(o*n-r*a)*f,t.m03=_*f,t.m04=(c*i-r*u)*f,t.m05=(-o*i+r*s)*f,t.m06=d*f,t.m07=(-h*i+n*u)*f,t.m08=(a*i-n*s)*f,t)},e.determinant=function(t){var e=t.m00,i=t.m01,n=t.m02,r=t.m03,s=t.m04,a=t.m05,o=t.m06,u=t.m07,h=t.m08;return e*(h*s-a*u)+i*(-h*r+a*o)+n*(u*r-s*o)},e.multiply=function(t,e,i){var n=e.m00,r=e.m01,s=e.m02,a=e.m03,o=e.m04,u=e.m05,h=e.m06,c=e.m07,l=e.m08,_=i.m00,d=i.m01,f=i.m02,p=i.m03,m=i.m04,g=i.m05,v=i.m06,y=i.m07,T=i.m08;return t.m00=_*n+d*a+f*h,t.m01=_*r+d*o+f*c,t.m02=_*s+d*u+f*l,t.m03=p*n+m*a+g*h,t.m04=p*r+m*o+g*c,t.m05=p*s+m*u+g*l,t.m06=v*n+y*a+T*h,t.m07=v*r+y*o+T*c,t.m08=v*s+y*u+T*l,t},e.multiplyMat4=function(t,e,i){var n=e.m00,r=e.m01,s=e.m02,a=e.m03,o=e.m04,u=e.m05,h=e.m06,c=e.m07,l=e.m08,_=i.m00,d=i.m01,f=i.m02,p=i.m04,m=i.m05,g=i.m06,v=i.m08,y=i.m09,T=i.m10;return t.m00=_*n+d*a+f*h,t.m01=_*r+d*o+f*c,t.m02=_*s+d*u+f*l,t.m03=p*n+m*a+g*h,t.m04=p*r+m*o+g*c,t.m05=p*s+m*u+g*l,t.m06=v*n+y*a+T*h,t.m07=v*r+y*o+T*c,t.m08=v*s+y*u+T*l,t},e.transform=function(t,e,i){var n=e.m00,r=e.m01,s=e.m02,a=e.m03,o=e.m04,u=e.m05,h=e.m06,c=e.m07,l=e.m08,_=i.x,d=i.y;return t.m00=n,t.m01=r,t.m02=s,t.m03=a,t.m04=o,t.m05=u,t.m06=_*n+d*a+h,t.m07=_*r+d*o+c,t.m08=_*s+d*u+l,t},e.scale=function(t,e,i){var n=i.x,r=i.y;return t.m00=n*e.m00,t.m01=n*e.m01,t.m02=n*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,i){var n=e.m00,r=e.m01,s=e.m02,a=e.m03,o=e.m04,u=e.m05,h=e.m06,c=e.m07,l=e.m08,_=Math.sin(i),d=Math.cos(i);return t.m00=d*n+_*a,t.m01=d*r+_*o,t.m02=d*s+_*u,t.m03=d*a-_*n,t.m04=d*o-_*r,t.m05=d*u-_*s,t.m06=h,t.m07=c,t.m08=l,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,i,n){return js.lengthSqr(i)<Ts*Ts?(e.identity(t),t):(n=n||js.UNIT_Y,js.normalize(na,js.cross(na,n,i)),js.lengthSqr(na)<Ts*Ts?(e.identity(t),t):(js.cross(ra,i,na),e.set(t,na.x,na.y,na.z,ra.x,ra.y,ra.z,i.x,i.y,i.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=-i,t.m04=n,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var i=e.x,n=e.y,r=e.z,s=e.w,a=i+i,o=n+n,u=r+r,h=i*a,c=n*a,l=n*o,_=r*a,d=r*o,f=r*u,p=s*a,m=s*o,g=s*u;return t.m00=1-l-f,t.m03=c-g,t.m06=_+m,t.m01=c+g,t.m04=1-h-f,t.m07=d-p,t.m02=_-m,t.m05=d+p,t.m08=1-h-l,t},e.inverseTransposeMat4=function(t,e){var i=e.m00,n=e.m01,r=e.m02,s=e.m03,a=e.m04,o=e.m05,u=e.m06,h=e.m07,c=e.m08,l=e.m09,_=e.m10,d=e.m11,f=e.m12,p=e.m13,m=e.m14,g=e.m15,v=i*o-n*a,y=i*u-r*a,T=i*h-s*a,E=n*u-r*o,S=n*h-s*o,A=r*h-s*u,R=c*p-l*f,w=c*m-_*f,b=c*g-d*f,O=l*m-_*p,M=l*g-d*p,I=_*g-d*m,C=v*I-y*M+T*O+E*b-S*w+A*R;return C?(C=1/C,t.m00=(o*I-u*M+h*O)*C,t.m01=(u*b-a*I-h*w)*C,t.m02=(a*M-o*b+h*R)*C,t.m03=(r*M-n*I-s*O)*C,t.m04=(i*I-r*b+s*w)*C,t.m05=(n*b-i*M-s*R)*C,t.m06=(p*A-m*S+g*E)*C,t.m07=(m*T-f*A-g*y)*C,t.m08=(f*S-p*T+g*v)*C,t):null},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t},e.add=function(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t},e.subtract=function(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t},e.multiplyScalar=function(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t},e.multiplyScalarAndAdd=function(t,e,i,n){return t.m00=i.m00*n+e.m00,t.m01=i.m01*n+e.m01,t.m02=i.m02*n+e.m02,t.m03=i.m03*n+e.m03,t.m04=i.m04*n+e.m04,t.m05=i.m05*n+e.m05,t.m06=i.m06*n+e.m06,t.m07=i.m07*n+e.m07,t.m08=i.m08*n+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var i=e.prototype;return i.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},i.set=function(t,e,i,n,r,s,a,o,u){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=1),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=i,this.m03=n,this.m04=r,this.m05=s,this.m06=a,this.m07=o,this.m08=u),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},i.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},i.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},i.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},i.transpose=function(){var t=this.m01,e=this.m02,i=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=i,this},i.invert=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=u*r-s*o,c=-u*n+s*a,l=o*n-r*a,_=t*h+e*c+i*l;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=h*_,this.m01=(-u*e+i*o)*_,this.m02=(s*e-i*r)*_,this.m03=c*_,this.m04=(u*t-i*a)*_,this.m05=(-s*t+i*n)*_,this.m06=l*_,this.m07=(-o*t+e*a)*_,this.m08=(r*t-e*n)*_,this)},i.determinant=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08;return t*(u*r-s*o)+e*(-u*n+s*a)+i*(o*n-r*a)},i.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},i.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},i.multiply=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,c=t.m00,l=t.m01,_=t.m02,d=t.m03,f=t.m04,p=t.m05,m=t.m06,g=t.m07,v=t.m08;return this.m00=c*e+l*r+_*o,this.m01=c*i+l*s+_*u,this.m02=c*n+l*a+_*h,this.m03=d*e+f*r+p*o,this.m04=d*i+f*s+p*u,this.m05=d*n+f*a+p*h,this.m06=m*e+g*r+v*o,this.m07=m*i+g*s+v*u,this.m08=m*n+g*a+v*h,this},i.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},i.scale=function(t){var e=t.x,i=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=i*this.m03,this.m04=i*this.m04,this.m05=i*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},i.rotate=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,c=Math.sin(t),l=Math.cos(t);return this.m00=l*e+c*r,this.m01=l*i+c*s,this.m02=l*n+c*a,this.m03=l*r-c*e,this.m04=l*s-c*i,this.m05=l*a-c*n,this.m06=o,this.m07=u,this.m08=h,this},i.fromQuat=function(t){var e=t.x,i=t.y,n=t.z,r=t.w,s=e+e,a=i+i,o=n+n,u=e*s,h=i*s,c=i*a,l=n*s,_=n*a,d=n*o,f=r*s,p=r*a,m=r*o;return this.m00=1-c-d,this.m03=h-m,this.m06=l+p,this.m01=h+m,this.m04=1-u-d,this.m07=_-f,this.m02=l-p,this.m05=_+f,this.m08=1-u-c,this},e}(Hn));ia.IDENTITY=Object.freeze(new ia);var na=new js,ra=new js;Dr.fastDefine("cc.Mat3",ia,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),v.Mat3=ia;var sa=t("Quat",function(t){function e(e,i,n,r){var s;return s=t.call(this)||this,e&&"object"==typeof e?(s.x=e.x,s.y=e.y,s.z=e.z,s.w=e.w):(s.x=e||0,s.y=i||0,s.z=n||0,s.w=null!=r?r:1),s}o(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,i,n,r){return t.x=e,t.y=i,t.z=n,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,i,n){var r=js.dot(i,n);return r<-.999999?(js.cross(ua,js.UNIT_X,i),ua.length()<1e-6&&js.cross(ua,js.UNIT_Y,i),js.normalize(ua,ua),e.fromAxisAngle(t,ua,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(js.cross(ua,i,n),t.x=ua.x,t.y=ua.y,t.z=ua.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var i=2*Math.acos(e.w),n=Math.sin(i/2);return 0!==n?(t.x=e.x/n,t.y=e.y/n,t.z=e.z/n):(t.x=1,t.y=0,t.z=0),i},e.multiply=function(t,e,i){var n=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,r=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,s=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,a=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=n,t.y=r,t.z=s,t.w=a,t},e.multiplyScalar=function(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t},e.scaleAndAdd=function(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t},e.rotateX=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=e.x,a=e.y,o=e.z,u=e.w;return t.x=s*r+u*n,t.y=a*r+o*n,t.z=o*r-a*n,t.w=u*r-s*n,t},e.rotateY=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=e.x,a=e.y,o=e.z,u=e.w;return t.x=s*r-o*n,t.y=a*r+u*n,t.z=o*r+s*n,t.w=u*r-a*n,t},e.rotateZ=function(t,e,i){i*=.5;var n=Math.sin(i),r=Math.cos(i),s=e.x,a=e.y,o=e.z,u=e.w;return t.x=s*r+a*n,t.y=a*r-s*n,t.z=o*r+u*n,t.w=u*r-o*n,t},e.rotateAround=function(t,i,n,r){return e.invert(aa,i),js.transformQuat(ua,n,aa),e.fromAxisAngle(aa,ua,r),e.multiply(t,i,aa),t},e.rotateAroundLocal=function(t,i,n,r){return e.fromAxisAngle(aa,n,r),e.multiply(t,i,aa),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t},e.slerp=function(t,e,i,n){var r=0,s=0,a=i.x,o=i.y,u=i.z,h=i.w,c=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(c<0&&(c=-c,a=-a,o=-o,u=-u,h=-h),1-c>1e-6){var l=Math.acos(c),_=Math.sin(l);r=Math.sin((1-n)*l)/_,s=Math.sin(n*l)/_}else r=1-n,s=n;return t.x=r*e.x+s*a,t.y=r*e.y+s*o,t.z=r*e.z+s*u,t.w=r*e.w+s*h,t},e.sqlerp=function(t,i,n,r,s,a){return e.slerp(aa,i,s,a),e.slerp(oa,n,r,a),e.slerp(t,aa,oa,2*a*(1-a)),t},e.invert=function(t,e){var i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,n=i?1/i:0;return t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0&&(i=1/Math.sqrt(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i),t},e.fromAxes=function(t,i,n,r){return ia.set(ha,i.x,i.y,i.z,n.x,n.y,n.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,ha))},e.fromViewUp=function(t,i,n){return ia.fromViewUp(ha,i,n),e.normalize(t,e.fromMat3(t,ha))},e.fromAxisAngle=function(t,e,i){i*=.5;var n=Math.sin(i);return t.x=n*e.x,t.y=n*e.y,t.z=n*e.z,t.w=Math.cos(i),t},e.fromMat3=function(t,e){var i=e.m00,n=e.m03,r=e.m06,s=e.m01,a=e.m04,o=e.m07,u=e.m02,h=e.m05,c=e.m08,l=i+a+c;if(l>0){var _=.5/Math.sqrt(l+1);t.w=.25/_,t.x=(h-o)*_,t.y=(r-u)*_,t.z=(s-n)*_}else if(i>a&&i>c){var d=2*Math.sqrt(1+i-a-c);t.w=(h-o)/d,t.x=.25*d,t.y=(n+s)/d,t.z=(r+u)/d}else if(a>c){var f=2*Math.sqrt(1+a-i-c);t.w=(r-u)/f,t.x=(n+s)/f,t.y=.25*f,t.z=(o+h)/f}else{var p=2*Math.sqrt(1+c-i-a);t.w=(s-n)/p,t.x=(r+u)/p,t.y=(o+h)/p,t.z=.25*p}return t},e.fromEuler=function(t,e,i,n){e*=ca,i*=ca,n*=ca;var r=Math.sin(e),s=Math.cos(e),a=Math.sin(i),o=Math.cos(i),u=Math.sin(n),h=Math.cos(n);return t.x=r*o*h+s*a*u,t.y=s*a*h+r*o*u,t.z=s*o*u-r*a*h,t.w=s*o*h-r*a*u,t},e.fromAngleZ=function(t,e){return e*=ca,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var i=2*e.y,n=2*e.z;return t.x=1-i*e.y-n*e.z,t.y=i*e.x+n*e.w,t.z=n*e.x+i*e.w,t},e.toAxisY=function(t,e){var i=2*e.x,n=2*e.y,r=2*e.z;return t.x=n*e.x-r*e.w,t.y=1-i*e.x-r*e.z,t.z=r*e.y+i*e.w,t},e.toAxisZ=function(t,e){var i=2*e.x,n=2*e.y,r=2*e.z;return t.x=r*e.x-n*e.w,t.y=r*e.y-i*e.w,t.z=1-i*e.x-n*e.y,t},e.toEuler=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=e.w,o=0,u=0,h=0,c=n*r+s*a;if(c>.499999)o=0,u=Os(2*Math.atan2(n,a)),h=90;else if(c<-.499999)o=0,u=-Os(2*Math.atan2(n,a)),h=-90;else{var l=n*n,_=r*r,d=s*s;o=Os(Math.atan2(2*n*a-2*r*s,1-2*l-2*d)),u=Os(Math.atan2(2*r*a-2*n*s,1-2*_-2*d)),h=Os(Math.asin(2*c)),i&&(o=-180*Math.sign(o+1e-6)+o,u=-180*Math.sign(u+1e-6)+u,h=180*Math.sign(h+1e-6)-h)}return t.x=o,t.y=u,t.z=h,t},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.z,this.w)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=null!=n?n:1),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},i.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},i.getEulerAngles=function(t){return e.toEuler(t,this)},i.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},i.slerp=function(t,i){return e.slerp(this,this,t,i)},i.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},i.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(Hn));sa.IDENTITY=Object.freeze(new sa);var aa=new sa,oa=new sa,ua=new js,ha=new ia,ca=.5*Math.PI/180;function la(t,e,i,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),new sa(t,e,i,n)}Dr.fastDefine("cc.Quat",sa,{x:0,y:0,z:0,w:1}),v.Quat=sa,v.quat=la;var _a=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),da=t("Mat4",function(t){function e(e,i,n,r,s,a,o,u,h,c,l,_,d,f,p,m){var g;return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=1),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===c&&(c=0),void 0===l&&(l=1),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===m&&(m=1),(g=t.call(this)||this).m00=void 0,g.m01=void 0,g.m02=void 0,g.m03=void 0,g.m04=void 0,g.m05=void 0,g.m06=void 0,g.m07=void 0,g.m08=void 0,g.m09=void 0,g.m10=void 0,g.m11=void 0,g.m12=void 0,g.m13=void 0,g.m14=void 0,g.m15=void 0,"object"==typeof e?(g.m00=e.m00,g.m01=e.m01,g.m02=e.m02,g.m03=e.m03,g.m04=e.m04,g.m05=e.m05,g.m06=e.m06,g.m07=e.m07,g.m08=e.m08,g.m09=e.m09,g.m10=e.m10,g.m11=e.m11,g.m12=e.m12,g.m13=e.m13,g.m14=e.m14,g.m15=e.m15):(g.m00=e,g.m01=i,g.m02=n,g.m03=r,g.m04=s,g.m05=a,g.m06=o,g.m07=u,g.m08=h,g.m09=c,g.m10=l,g.m11=_,g.m12=d,g.m13=f,g.m14=p,g.m15=m),g}o(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p,m){return t.m00=e,t.m01=i,t.m02=n,t.m03=r,t.m04=s,t.m05=a,t.m06=o,t.m07=u,t.m08=h,t.m09=c,t.m10=l,t.m11=_,t.m12=d,t.m13=f,t.m14=p,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var i=e.m01,n=e.m02,r=e.m03,s=e.m06,a=e.m07,o=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=n,t.m09=s,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=o}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var i=e.m00,n=e.m01,r=e.m02,s=e.m03,a=e.m04,o=e.m05,u=e.m06,h=e.m07,c=e.m08,l=e.m09,_=e.m10,d=e.m11,f=e.m12,p=e.m13,m=e.m14,g=e.m15,v=i*o-n*a,y=i*u-r*a,T=i*h-s*a,E=n*u-r*o,S=n*h-s*o,A=r*h-s*u,R=c*p-l*f,w=c*m-_*f,b=c*g-d*f,O=l*m-_*p,M=l*g-d*p,I=_*g-d*m,C=v*I-y*M+T*O+E*b-S*w+A*R;return 0===C?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(C=1/C,t.m00=(o*I-u*M+h*O)*C,t.m01=(r*M-n*I-s*O)*C,t.m02=(p*A-m*S+g*E)*C,t.m03=(_*S-l*A-d*E)*C,t.m04=(u*b-a*I-h*w)*C,t.m05=(i*I-r*b+s*w)*C,t.m06=(m*T-f*A-g*y)*C,t.m07=(c*A-_*T+d*y)*C,t.m08=(a*M-o*b+h*R)*C,t.m09=(n*b-i*M-s*R)*C,t.m10=(f*S-p*T+g*v)*C,t.m11=(l*T-c*S-d*v)*C,t.m12=(o*w-a*O-u*R)*C,t.m13=(i*O-n*w+r*R)*C,t.m14=(p*y-f*E-m*v)*C,t.m15=(c*E-l*y+_*v)*C,t)},e.determinant=function(t){var e=t.m00,i=t.m01,n=t.m02,r=t.m03,s=t.m04,a=t.m05,o=t.m06,u=t.m07,h=t.m08,c=t.m09,l=t.m10,_=t.m11,d=t.m12,f=t.m13,p=t.m14,m=t.m15;return(e*a-i*s)*(l*m-_*p)-(e*o-n*s)*(c*m-_*f)+(e*u-r*s)*(c*p-l*f)+(i*o-n*a)*(h*m-_*d)-(i*u-r*a)*(h*p-l*d)+(n*u-r*o)*(h*f-c*d)},e.multiply=function(t,e,i){var n=e.m00,r=e.m01,s=e.m02,a=e.m03,o=e.m04,u=e.m05,h=e.m06,c=e.m07,l=e.m08,_=e.m09,d=e.m10,f=e.m11,p=e.m12,m=e.m13,g=e.m14,v=e.m15,y=i.m00,T=i.m01,E=i.m02,S=i.m03;return t.m00=y*n+T*o+E*l+S*p,t.m01=y*r+T*u+E*_+S*m,t.m02=y*s+T*h+E*d+S*g,t.m03=y*a+T*c+E*f+S*v,y=i.m04,T=i.m05,E=i.m06,S=i.m07,t.m04=y*n+T*o+E*l+S*p,t.m05=y*r+T*u+E*_+S*m,t.m06=y*s+T*h+E*d+S*g,t.m07=y*a+T*c+E*f+S*v,y=i.m08,T=i.m09,E=i.m10,S=i.m11,t.m08=y*n+T*o+E*l+S*p,t.m09=y*r+T*u+E*_+S*m,t.m10=y*s+T*h+E*d+S*g,t.m11=y*a+T*c+E*f+S*v,y=i.m12,T=i.m13,E=i.m14,S=i.m15,t.m12=y*n+T*o+E*l+S*p,t.m13=y*r+T*u+E*_+S*m,t.m14=y*s+T*h+E*d+S*g,t.m15=y*a+T*c+E*f+S*v,t},e.transform=function(t,e,i){var n=i.x,r=i.y,s=i.z;if(e===t)t.m12=e.m00*n+e.m04*r+e.m08*s+e.m12,t.m13=e.m01*n+e.m05*r+e.m09*s+e.m13,t.m14=e.m02*n+e.m06*r+e.m10*s+e.m14,t.m15=e.m03*n+e.m07*r+e.m11*s+e.m15;else{var a=e.m00,o=e.m01,u=e.m02,h=e.m03,c=e.m04,l=e.m05,_=e.m06,d=e.m07,f=e.m08,p=e.m09,m=e.m10,g=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=o,t.m02=u,t.m03=h,t.m04=c,t.m05=l,t.m06=_,t.m07=d,t.m08=f,t.m09=p,t.m10=m,t.m11=g,t.m12=a*n+c*r+f*s+e.m12,t.m13=o*n+l*r+p*s+e.m13,t.m14=u*n+_*r+m*s+e.m14,t.m15=h*n+d*r+g*s+e.m15}return t},e.translate=function(t,e,i){return e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=i.x,t.m13+=i.y,t.m14+=i.z,t.m15=e.m15),t},e.scale=function(t,e,i){var n=i.x,r=i.y,s=i.z;return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*s,t.m09=e.m09*s,t.m10=e.m10*s,t.m11=e.m11*s,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,i,n){var r=n.x,s=n.y,a=n.z,o=Math.sqrt(r*r+s*s+a*a);if(Math.abs(o)<Ts)return null;r*=o=1/o,s*=o,a*=o;var u=Math.sin(i),h=Math.cos(i),c=1-h,l=e.m00,_=e.m01,d=e.m02,f=e.m03,p=e.m04,m=e.m05,g=e.m06,v=e.m07,y=e.m08,T=e.m09,E=e.m10,S=e.m11,A=r*r*c+h,R=s*r*c+a*u,w=a*r*c-s*u,b=r*s*c-a*u,O=s*s*c+h,M=a*s*c+r*u,I=r*a*c+s*u,C=s*a*c-r*u,x=a*a*c+h;return t.m00=l*A+p*R+y*w,t.m01=_*A+m*R+T*w,t.m02=d*A+g*R+E*w,t.m03=f*A+v*R+S*w,t.m04=l*b+p*O+y*M,t.m05=_*b+m*O+T*M,t.m06=d*b+g*O+E*M,t.m07=f*b+v*O+S*M,t.m08=l*I+p*C+y*x,t.m09=_*I+m*C+T*x,t.m10=d*I+g*C+E*x,t.m11=f*I+v*C+S*x,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e.m04,a=e.m05,o=e.m06,u=e.m07,h=e.m08,c=e.m09,l=e.m10,_=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=s*r+h*n,t.m05=a*r+c*n,t.m06=o*r+l*n,t.m07=u*r+_*n,t.m08=h*r-s*n,t.m09=c*r-a*n,t.m10=l*r-o*n,t.m11=_*r-u*n,t},e.rotateY=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e.m00,a=e.m01,o=e.m02,u=e.m03,h=e.m08,c=e.m09,l=e.m10,_=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=s*r-h*n,t.m01=a*r-c*n,t.m02=o*r-l*n,t.m03=u*r-_*n,t.m08=s*n+h*r,t.m09=a*n+c*r,t.m10=o*n+l*r,t.m11=u*n+_*r,t},e.rotateZ=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),s=e.m00,a=e.m01,o=e.m02,u=e.m03,h=e.m04,c=e.m05,l=e.m06,_=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=s*r+h*n,t.m01=a*r+c*n,t.m02=o*r+l*n,t.m03=u*r+_*n,t.m04=h*r-s*n,t.m05=c*r-a*n,t.m06=l*r-o*n,t.m07=_*r-u*n,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,i){var n=i.x,r=i.y,s=i.z,a=Math.sqrt(n*n+r*r+s*s);if(Math.abs(a)<Ts)return null;n*=a=1/a,r*=a,s*=a;var o=Math.sin(e),u=Math.cos(e),h=1-u;return t.m00=n*n*h+u,t.m01=r*n*h+s*o,t.m02=s*n*h-r*o,t.m03=0,t.m04=n*r*h-s*o,t.m05=r*r*h+u,t.m06=s*r*h+n*o,t.m07=0,t.m08=n*s*h+r*o,t.m09=r*s*h-n*o,t.m10=s*s*h+u,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=n,t.m06=i,t.m07=0,t.m08=0,t.m09=-i,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=0,t.m02=-i,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=i,t.m09=0,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=0,t.m04=-i,t.m05=n,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,i){var n=e.x,r=e.y,s=e.z,a=e.w,o=n+n,u=r+r,h=s+s,c=n*o,l=n*u,_=n*h,d=r*u,f=r*h,p=s*h,m=a*o,g=a*u,v=a*h;return t.m00=1-(d+p),t.m01=l+v,t.m02=_-g,t.m03=0,t.m04=l-v,t.m05=1-(c+p),t.m06=f+m,t.m07=0,t.m08=_+g,t.m09=f-m,t.m10=1-(c+d),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var i=pa.m00=e.m00,n=pa.m01=e.m01,r=pa.m02=e.m02,s=pa.m03=e.m04,a=pa.m04=e.m05,o=pa.m05=e.m06,u=pa.m06=e.m08,h=pa.m07=e.m09,c=pa.m08=e.m10;return t.x=Math.sqrt(i*i+n*n+r*r),t.y=Math.sqrt(s*s+a*a+o*o),t.z=Math.sqrt(u*u+h*h+c*c),ia.determinant(pa)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var i=e.m00+e.m05+e.m10,n=0;return i>0?(n=2*Math.sqrt(i+1),t.w=.25*n,t.x=(e.m06-e.m09)/n,t.y=(e.m08-e.m02)/n,t.z=(e.m01-e.m04)/n):e.m00>e.m05&&e.m00>e.m10?(n=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/n,t.x=.25*n,t.y=(e.m01+e.m04)/n,t.z=(e.m08+e.m02)/n):e.m05>e.m10?(n=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/n,t.x=(e.m01+e.m04)/n,t.y=.25*n,t.z=(e.m06+e.m09)/n):(n=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/n,t.x=(e.m08+e.m02)/n,t.y=(e.m06+e.m09)/n,t.z=.25*n),t},e.toRTS=function(t,e,i,n){n.x=js.set(fa,t.m00,t.m01,t.m02).length(),pa.m00=t.m00/n.x,pa.m01=t.m01/n.x,pa.m02=t.m02/n.x,n.y=js.set(fa,t.m04,t.m05,t.m06).length(),pa.m03=t.m04/n.y,pa.m04=t.m05/n.y,pa.m05=t.m06/n.y,n.z=js.set(fa,t.m08,t.m09,t.m10).length(),pa.m06=t.m08/n.z,pa.m07=t.m09/n.z,pa.m08=t.m10/n.z,ia.determinant(pa)<0&&(n.x*=-1,pa.m00*=-1,pa.m01*=-1,pa.m02*=-1),sa.fromMat3(e,pa),js.set(i,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,i,n){var r=e.x,s=e.y,a=e.z,o=e.w,u=r+r,h=s+s,c=a+a,l=r*u,_=r*h,d=r*c,f=s*h,p=s*c,m=a*c,g=o*u,v=o*h,y=o*c,T=n.x,E=n.y,S=n.z;return t.m00=(1-(f+m))*T,t.m01=(_+y)*T,t.m02=(d-v)*T,t.m03=0,t.m04=(_-y)*E,t.m05=(1-(l+m))*E,t.m06=(p+g)*E,t.m07=0,t.m08=(d+v)*S,t.m09=(p-g)*S,t.m10=(1-(l+f))*S,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,i,n,r){var s=e.x,a=e.y,o=e.z,u=e.w,h=s+s,c=a+a,l=o+o,_=s*h,d=s*c,f=s*l,p=a*c,m=a*l,g=o*l,v=u*h,y=u*c,T=u*l,E=n.x,S=n.y,A=n.z,R=r.x,w=r.y,b=r.z;return t.m00=(1-(p+g))*E,t.m01=(d+T)*E,t.m02=(f-y)*E,t.m03=0,t.m04=(d-T)*S,t.m05=(1-(_+g))*S,t.m06=(m+v)*S,t.m07=0,t.m08=(f+y)*A,t.m09=(m-v)*A,t.m10=(1-(_+p))*A,t.m11=0,t.m12=i.x+R-(t.m00*R+t.m04*w+t.m08*b),t.m13=i.y+w-(t.m01*R+t.m05*w+t.m09*b),t.m14=i.z+b-(t.m02*R+t.m06*w+t.m10*b),t.m15=1,t},e.fromQuat=function(t,e){var i=e.x,n=e.y,r=e.z,s=e.w,a=i+i,o=n+n,u=r+r,h=i*a,c=n*a,l=n*o,_=r*a,d=r*o,f=r*u,p=s*a,m=s*o,g=s*u;return t.m00=1-l-f,t.m01=c+g,t.m02=_-m,t.m03=0,t.m04=c-g,t.m05=1-h-f,t.m06=d+p,t.m07=0,t.m08=_+m,t.m09=d-p,t.m10=1-h-l,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,i,n,r,s,a){var o=1/(i-e),u=1/(r-n),h=1/(s-a);return t.m00=2*s*o,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*s*u,t.m06=0,t.m07=0,t.m08=(i+e)*o,t.m09=(r+n)*u,t.m10=(a+s)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*s*2*h,t.m15=0,t},e.perspective=function(t,e,i,n,r,s,a,o,u){void 0===s&&(s=!0),void 0===a&&(a=-1),void 0===o&&(o=1),void 0===u&&(u=0);var h=1/Math.tan(e/2),c=1/(n-r),l=s?h/i:h,_=(s?h:h*i)*o,d=_a[u];return t.m00=l*d[0],t.m01=l*d[1],t.m02=0,t.m03=0,t.m04=_*d[2],t.m05=_*d[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*n)*c,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*n*c*(1-a),t.m15=0,t},e.ortho=function(t,e,i,n,r,s,a,o,u,h){void 0===o&&(o=-1),void 0===u&&(u=1),void 0===h&&(h=0);var c=1/(e-i),l=1/(n-r)*u,_=1/(s-a),d=-2*c,f=-2*l,p=(e+i)*c,m=(r+n)*l,g=_a[h];return t.m00=d*g[0],t.m01=d*g[1],t.m02=0,t.m03=0,t.m04=f*g[2],t.m05=f*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=_*(1-o),t.m11=0,t.m12=p*g[0]+m*g[2],t.m13=p*g[1]+m*g[3],t.m14=(s-o*a)*_,t.m15=1,t},e.lookAt=function(t,e,i,n){var r=e.x,s=e.y,a=e.z,o=n.x,u=n.y,h=n.z,c=r-i.x,l=s-i.y,_=a-i.z,d=1/Math.sqrt(c*c+l*l+_*_),f=u*(_*=d)-h*(l*=d),p=h*(c*=d)-o*_,m=o*l-u*c,g=l*(m*=d=1/Math.sqrt(f*f+p*p+m*m))-_*(p*=d),v=_*(f*=d)-c*m,y=c*p-l*f;return t.m00=f,t.m01=g,t.m02=c,t.m03=0,t.m04=p,t.m05=v,t.m06=l,t.m07=0,t.m08=m,t.m09=y,t.m10=_,t.m11=0,t.m12=-(f*r+p*s+m*a),t.m13=-(g*r+v*s+y*a),t.m14=-(c*r+l*s+_*a),t.m15=1,t},e.inverseTranspose=function(t,e){var i=e.m00,n=e.m01,r=e.m02,s=e.m03,a=e.m04,o=e.m05,u=e.m06,h=e.m07,c=e.m08,l=e.m09,_=e.m10,d=e.m11,f=e.m12,p=e.m13,m=e.m14,g=e.m15,v=i*o-n*a,y=i*u-r*a,T=i*h-s*a,E=n*u-r*o,S=n*h-s*o,A=r*h-s*u,R=c*p-l*f,w=c*m-_*f,b=c*g-d*f,O=l*m-_*p,M=l*g-d*p,I=_*g-d*m,C=v*I-y*M+T*O+E*b-S*w+A*R;return C?(C=1/C,t.m00=(o*I-u*M+h*O)*C,t.m01=(u*b-a*I-h*w)*C,t.m02=(a*M-o*b+h*R)*C,t.m03=0,t.m04=(r*M-n*I-s*O)*C,t.m05=(i*I-r*b+s*w)*C,t.m06=(n*b-i*M-s*R)*C,t.m07=0,t.m08=(p*A-m*S+g*E)*C,t.m09=(m*T-f*A-g*y)*C,t.m10=(f*S-p*T+g*v)*C,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,i){return void 0===i&&(i=0),t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t},e.add=function(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t},e.subtract=function(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t},e.multiplyScalar=function(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t},e.multiplyScalarAndAdd=function(t,e,i,n){return t.m00=e.m00+i.m00*n,t.m01=e.m01+i.m01*n,t.m02=e.m02+i.m02*n,t.m03=e.m03+i.m03*n,t.m04=e.m04+i.m04*n,t.m05=e.m05+i.m05*n,t.m06=e.m06+i.m06*n,t.m07=e.m07+i.m07*n,t.m08=e.m08+i.m08*n,t.m09=e.m09+i.m09*n,t.m10=e.m10+i.m10*n,t.m11=e.m11+i.m11*n,t.m12=e.m12+i.m12*n,t.m13=e.m13+i.m13*n,t.m14=e.m14+i.m14*n,t.m15=e.m15+i.m15*n,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=i*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=i*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=i*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=i*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=i*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=i*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=i*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var i=e.prototype;return i.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},i.set=function(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=1),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===c&&(c=1),void 0===l&&(l=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===p&&(p=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=i,this.m03=n,this.m04=r,this.m05=s,this.m06=a,this.m07=o,this.m08=u,this.m09=h,this.m10=c,this.m11=l,this.m12=_,this.m13=d,this.m14=f,this.m15=p,this.m00=t),this},i.equals=function(t,e){return void 0===e&&(e=Ts),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},i.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},i.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},i.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},i.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},i.transpose=function(){var t=this.m01,e=this.m02,i=this.m03,n=this.m06,r=this.m07,s=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=n,this.m11=this.m14,this.m12=i,this.m13=r,this.m14=s,this},i.invert=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=this.m09,c=this.m10,l=this.m11,_=this.m12,d=this.m13,f=this.m14,p=this.m15,m=t*s-e*r,g=t*a-i*r,v=t*o-n*r,y=e*a-i*s,T=e*o-n*s,E=i*o-n*a,S=u*d-h*_,A=u*f-c*_,R=u*p-l*_,w=h*f-c*d,b=h*p-l*d,O=c*p-l*f,M=m*O-g*b+v*w+y*R-T*A+E*S;return 0===M?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(M=1/M,this.m00=(s*O-a*b+o*w)*M,this.m01=(i*b-e*O-n*w)*M,this.m02=(d*E-f*T+p*y)*M,this.m03=(c*T-h*E-l*y)*M,this.m04=(a*R-r*O-o*A)*M,this.m05=(t*O-i*R+n*A)*M,this.m06=(f*v-_*E-p*g)*M,this.m07=(u*E-c*v+l*g)*M,this.m08=(r*b-s*R+o*S)*M,this.m09=(e*R-t*b-n*S)*M,this.m10=(_*T-d*v+p*m)*M,this.m11=(h*v-u*T-l*m)*M,this.m12=(s*A-r*w-a*S)*M,this.m13=(t*w-e*A+i*S)*M,this.m14=(d*g-_*y-f*m)*M,this.m15=(u*y-h*g+c*m)*M,this)},i.determinant=function(){var t=this.m00,e=this.m01,i=this.m02,n=this.m03,r=this.m04,s=this.m05,a=this.m06,o=this.m07,u=this.m08,h=this.m09,c=this.m10,l=this.m11,_=this.m12,d=this.m13,f=this.m14,p=this.m15;return(t*s-e*r)*(c*p-l*f)-(t*a-i*r)*(h*p-l*d)+(t*o-n*r)*(h*f-c*d)+(e*a-i*s)*(u*p-l*_)-(e*o-n*s)*(u*f-c*_)+(i*o-n*a)*(u*d-h*_)},i.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},i.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},i.multiply=function(t){var e=this.m00,i=this.m01,n=this.m02,r=this.m03,s=this.m04,a=this.m05,o=this.m06,u=this.m07,h=this.m08,c=this.m09,l=this.m10,_=this.m11,d=this.m12,f=this.m13,p=this.m14,m=this.m15,g=t.m00,v=t.m01,y=t.m02,T=t.m03;return this.m00=g*e+v*s+y*h+T*d,this.m01=g*i+v*a+y*c+T*f,this.m02=g*n+v*o+y*l+T*p,this.m03=g*r+v*u+y*_+T*m,g=t.m04,v=t.m05,y=t.m06,T=t.m07,this.m04=g*e+v*s+y*h+T*d,this.m05=g*i+v*a+y*c+T*f,this.m06=g*n+v*o+y*l+T*p,this.m07=g*r+v*u+y*_+T*m,g=t.m08,v=t.m09,y=t.m10,T=t.m11,this.m08=g*e+v*s+y*h+T*d,this.m09=g*i+v*a+y*c+T*f,this.m10=g*n+v*o+y*l+T*p,this.m11=g*r+v*u+y*_+T*m,g=t.m12,v=t.m13,y=t.m14,T=t.m15,this.m12=g*e+v*s+y*h+T*d,this.m13=g*i+v*a+y*c+T*f,this.m14=g*n+v*o+y*l+T*p,this.m15=g*r+v*u+y*_+T*m,this},i.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},i.translate=function(t){return this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},i.scale=function(t){var e=t.x,i=t.y,n=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=i,this.m05*=i,this.m06*=i,this.m07*=i,this.m08*=n,this.m09*=n,this.m10*=n,this.m11*=n,this},i.rotate=function(t,e){var i=e.x,n=e.y,r=e.z,s=Math.sqrt(i*i+n*n+r*r);if(Math.abs(s)<Ts)return null;i*=s=1/s,n*=s,r*=s;var a=Math.sin(t),o=Math.cos(t),u=1-o,h=this.m00,c=this.m01,l=this.m02,_=this.m03,d=this.m04,f=this.m05,p=this.m06,m=this.m07,g=this.m08,v=this.m09,y=this.m10,T=this.m11,E=i*i*u+o,S=n*i*u+r*a,A=r*i*u-n*a,R=i*n*u-r*a,w=n*n*u+o,b=r*n*u+i*a,O=i*r*u+n*a,M=n*r*u-i*a,I=r*r*u+o;return this.m00=h*E+d*S+g*A,this.m01=c*E+f*S+v*A,this.m02=l*E+p*S+y*A,this.m03=_*E+m*S+T*A,this.m04=h*R+d*w+g*b,this.m05=c*R+f*w+v*b,this.m06=l*R+p*w+y*b,this.m07=_*R+m*w+T*b,this.m08=h*O+d*M+g*I,this.m09=c*O+f*M+v*I,this.m10=l*O+p*M+y*I,this.m11=_*O+m*M+T*I,this},i.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},i.getScale=function(t){var e=pa.m00=this.m00,i=pa.m01=this.m01,n=pa.m02=this.m02,r=pa.m03=this.m04,s=pa.m04=this.m05,a=pa.m05=this.m06,o=pa.m06=this.m08,u=pa.m07=this.m09,h=pa.m08=this.m10;return t.x=Math.sqrt(e*e+i*i+n*n),t.y=Math.sqrt(r*r+s*s+a*a),t.z=Math.sqrt(o*o+u*u+h*h),ia.determinant(pa)<0&&(t.x*=-1),t},i.getRotation=function(t){var e=this.m00+this.m05+this.m10,i=0;return e>0?(i=2*Math.sqrt(e+1),t.w=.25*i,t.x=(this.m06-this.m09)/i,t.y=(this.m08-this.m02)/i,t.z=(this.m01-this.m04)/i):this.m00>this.m05&&this.m00>this.m10?(i=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/i,t.x=.25*i,t.y=(this.m01+this.m04)/i,t.z=(this.m08+this.m02)/i):this.m05>this.m10?(i=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/i,t.x=(this.m01+this.m04)/i,t.y=.25*i,t.z=(this.m06+this.m09)/i):(i=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/i,t.x=(this.m08+this.m02)/i,t.y=(this.m06+this.m09)/i,t.z=.25*i),t},i.fromRTS=function(t,e,i){var n=t.x,r=t.y,s=t.z,a=t.w,o=n+n,u=r+r,h=s+s,c=n*o,l=n*u,_=n*h,d=r*u,f=r*h,p=s*h,m=a*o,g=a*u,v=a*h,y=i.x,T=i.y,E=i.z;return this.m00=(1-(d+p))*y,this.m01=(l+v)*y,this.m02=(_-g)*y,this.m03=0,this.m04=(l-v)*T,this.m05=(1-(c+p))*T,this.m06=(f+m)*T,this.m07=0,this.m08=(_+g)*E,this.m09=(f-m)*E,this.m10=(1-(c+d))*E,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},i.fromQuat=function(t){var e=t.x,i=t.y,n=t.z,r=t.w,s=e+e,a=i+i,o=n+n,u=e*s,h=i*s,c=i*a,l=n*s,_=n*a,d=n*o,f=r*s,p=r*a,m=r*o;return this.m00=1-c-d,this.m01=h+m,this.m02=l-p,this.m03=0,this.m04=h-m,this.m05=1-u-d,this.m06=_+f,this.m07=0,this.m08=l+p,this.m09=_-f,this.m10=1-u-c,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(Hn));da.IDENTITY=Object.freeze(new da);var fa=new js,pa=new ia;function ma(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p){return new da(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p)}Dr.fastDefine("cc.Mat4",da,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),v.Mat4=da,v.mat4=ma;var ga=t("AffineTransform",function(){function t(t,e,i,n,r,s){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===s&&(s=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=r,this.ty=s}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,i){var n=e.a,r=e.b,s=e.c,a=e.d,o=e.tx,u=e.ty;t.a=n*i.a+r*i.c,t.b=n*i.b+r*i.d,t.c=s*i.a+a*i.c,t.d=s*i.b+a*i.d,t.tx=o*i.a+u*i.c+i.tx,t.ty=o*i.b+u*i.d+i.ty},t.invert=function(t,e){var i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,i,n){var r,s;n?(r=e,s=i):(n=i,r=e.x,s=e.y),t.x=n.a*r+n.c*s+n.tx,t.y=n.b*r+n.d*s+n.ty},t.transformSize=function(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height},t.transformRect=function(t,e,i){var n=e.x+e.width,r=e.y+e.height,s=i.a*e.x+i.c*e.y+i.tx,a=i.b*e.x+i.d*e.y+i.ty,o=i.a*n+i.c*e.y+i.tx,u=i.b*n+i.d*e.y+i.ty,h=i.a*e.x+i.c*r+i.tx,c=i.b*e.x+i.d*r+i.ty,l=i.a*n+i.c*r+i.tx,_=i.b*n+i.d*r+i.ty,d=Math.min(s,o,h,l),f=Math.max(s,o,h,l),p=Math.min(a,u,c,_),m=Math.max(a,u,c,_);t.x=d,t.y=p,t.width=f-d,t.height=m-p},t.transformObb=function(t,e,i,n,r,s){var a=s.a*r.x+s.c*r.y+s.tx,o=s.b*r.x+s.d*r.y+s.ty,u=s.a*r.width,h=s.b*r.width,c=s.c*r.height,l=s.d*r.height;e.x=a,e.y=o,i.x=u+a,i.y=h+o,t.x=c+a,t.y=l+o,n.x=u+c+a,n.y=h+l+o},t}());v.AffineTransform=ga;var va=t("Size",function(t){function e(e,i){var n;return n=t.call(this)||this,e&&"object"==typeof e?(n.width=e.width,n.height=e.height):(n.width=e||0,n.height=i||0),n}o(e,t),e.lerp=function(t,e,i,n){return t.width=e.width+(i.width-e.width)*n,t.height=e.height+(i.height-e.height)*n,t};var i=e.prototype;return i.clone=function(){return new e(this.width,this.height)},i.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},i.equals=function(t){return this.width===t.width&&this.height===t.height},i.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},i.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},s(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(Hn));function ya(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new va(t,e)}va.ZERO=Object.freeze(new va(0,0)),va.ONE=Object.freeze(new va(1,1)),Dr.fastDefine("cc.Size",va,{width:0,height:0}),v.size=ya,v.Size=va;var Ta=t("Rect",function(t){function e(e,i,n,r){var s;return s=t.call(this)||this,e&&"object"==typeof e?(s.y=e.y,s.width=e.width,s.height=e.height,s.x=e.x):(s.x=e||0,s.y=i||0,s.width=n||0,s.height=r||0),s}o(e,t),e.fromMinMax=function(t,e,i){var n=Math.min(e.x,i.x),r=Math.min(e.y,i.y),s=Math.max(e.x,i.x),a=Math.max(e.y,i.y);return t.x=n,t.y=r,t.width=s-n,t.height=a-r,t},e.lerp=function(t,e,i,n){var r=e.x,s=e.y,a=e.width,o=e.height;return t.x=r+(i.x-r)*n,t.y=s+(i.y-s)*n,t.width=a+(i.width-a)*n,t.height=o+(i.height-o)*n,t},e.intersection=function(t,e,i){var n=e.x,r=e.y,s=e.x+e.width,a=e.y+e.height,o=i.x,u=i.y,h=i.x+i.width,c=i.y+i.height;return t.x=Math.max(n,o),t.y=Math.max(r,u),t.width=Math.min(s,h)-t.x,t.height=Math.min(a,c)-t.y,t},e.union=function(t,e,i){var n=e.x,r=e.y,s=e.width,a=e.height,o=i.x,u=i.y,h=i.width,c=i.height;return t.x=Math.min(n,o),t.y=Math.min(r,u),t.width=Math.max(n+s,o+h)-t.x,t.height=Math.max(r+a,u+c)-t.y,t};var i=e.prototype;return i.clone=function(){return new e(this.x,this.y,this.width,this.height)},i.set=function(t,e,i,n){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0),this},i.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},i.lerp=function(t,e){var i=this.x,n=this.y,r=this.width,s=this.height;return this.x=i+(t.x-i)*e,this.y=n+(t.y-n)*e,this.width=r+(t.width-r)*e,this.height=s+(t.height-s)*e,this},i.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},i.intersects=function(t){var e=this.x+this.width,i=this.y+this.height,n=t.x+t.width,r=t.y+t.height;return!(e<t.x||n<this.x||i<t.y||r<this.y)},i.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},i.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},i.transformMat4=function(t){var e=this.x,i=this.y,n=e+this.width,r=i+this.height,s=t.m00*e+t.m04*i+t.m12,a=t.m01*e+t.m05*i+t.m13,o=t.m00*n+t.m04*i+t.m12,u=t.m01*n+t.m05*i+t.m13,h=t.m00*e+t.m04*r+t.m12,c=t.m01*e+t.m05*r+t.m13,l=t.m00*n+t.m04*r+t.m12,_=t.m01*n+t.m05*r+t.m13,d=Math.min(s,o,h,l),f=Math.max(s,o,h,l),p=Math.min(a,u,c,_),m=Math.max(a,u,c,_);return this.x=d,this.y=p,this.width=f-d,this.height=m-p,this},i.transformMat4ToPoints=function(t,e,i,n,r){var s=this.x,a=this.y,o=s+this.width,u=a+this.height;e.x=t.m00*s+t.m04*a+t.m12,e.y=t.m01*s+t.m05*a+t.m13,r.x=t.m00*o+t.m04*a+t.m12,r.y=t.m01*o+t.m05*a+t.m13,i.x=t.m00*s+t.m04*u+t.m12,i.y=t.m01*s+t.m05*u+t.m13,n.x=t.m00*o+t.m04*u+t.m12,n.y=t.m01*o+t.m05*u+t.m13},s(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new Qs(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new Qs(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new va(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(Hn));function Ea(t,e,i,n){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),new Ta(t,e,i,n)}Dr.fastDefine("cc.Rect",Ta,{x:0,y:0,width:0,height:0}),v.Rect=Ta,v.rect=Ea;var Sa=1/255,Aa=t("Color",function(t){function e(e,i,n,r){var s;return(s=t.call(this)||this)._val=0,"string"==typeof e?s.fromHEX(e):void 0!==i?s.set(e,i,n,r):s.set(e),s}o(e,t),e.clone=function(t){var i=new e;return t._val?i._val=t._val:i._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,i},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,i,n,r){return t.r=e,t.g=i,t.b=n,t.a=r,t},e.toVec4=function(t,e){return(e=void 0!==e?e:new ta).x=wa(t.r),e.y=wa(t.g),e.z=wa(t.b),e.w=wa(t.a),e},e.fromVec4=function(t,i){return(i=void 0===i?new e:i).r=ba(t.x),i.g=ba(t.y),i.b=ba(t.z),i.a=ba(t.w),i},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var i=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(i)?255:i,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t},e.subtract=function(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t},e.multiply=function(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t},e.divide=function(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t},e.scale=function(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t},e.lerp=function(t,e,i,n){var r=e.r,s=e.g,a=e.b,o=e.a;return r+=(i.r-r)*n,s+=(i.g-s)*n,a+=(i.b-a)*n,o+=(i.a-o)*n,t._val=Math.floor((o<<24>>>0)+(a<<16)+(s<<8)+r),t},e.toArray=function(t,i,n){void 0===n&&(n=0);var r=i instanceof e||i.a>1?1/255:1;return t[n+0]=i.r*r,t[n+1]=i.g*r,t[n+2]=i.b*r,t[n+3]=i.a*r,t},e.fromArray=function(t,e,i){return void 0===i&&(i=0),e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,i){return void 0===i&&(i=Ts),Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var i=e.prototype;return i.clone=function(){var t=new e;return t._val=this._val,t},i.equals=function(t){return t&&this._val===t._val},i.lerp=function(t,e){var i=this.r,n=this.g,r=this.b,s=this.a;return i+=(t.r-i)*e,n+=(t.g-n)*e,r+=(t.b-r)*e,s+=(t.a-s)*e,this._val=Math.floor((s<<24>>>0)+(r<<16)+(n<<8)+i),this},i.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},i.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*Sa).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},i.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(n<<16)+(i<<8)+(0|e),this},i.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",i=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this.a<16?e:"")+this.a.toString(16)),i.join("")},i.toRGBValue=function(){return 16777215&this._val},i.fromHSV=function(t,e,i){var n=0,r=0,s=0;if(0===e)n=r=s=i;else if(0===i)n=r=s=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),o=t-a,u=i*(1-e),h=i*(1-e*o),c=i*(1-e*(1-o));switch(a){default:case 0:n=i,r=c,s=u;break;case 1:n=h,r=i,s=u;break;case 2:n=u,r=i,s=c;break;case 3:n=u,r=h,s=i;break;case 4:n=c,r=u,s=i;break;case 5:n=i,r=u,s=h}}return n*=255,r*=255,s*=255,this._val=(this.a<<24>>>0)+(s<<16)+(r<<8)+(0|n),this},i.toHSV=function(){var t=this.r*Sa,e=this.g*Sa,i=this.b*Sa,n={h:0,s:0,v:0},r=Math.max(t,e,i),s=Math.min(t,e,i),a=0;return n.v=r,n.s=r?(r-s)/r:0,n.s?(a=r-s,n.h=t===r?(e-i)/a:e===r?2+(i-t)/a:4+(t-e)/a,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n},i.set=function(t,e,i,n){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,i=t.b||0,n="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)),this},i.multiply=function(t){var e=(255&this._val)*t.r>>8,i=(65280&this._val)*t.g>>8,n=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&n|65280&i|255&e,this},i._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},i._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},i._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},i._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},s(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~As(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~As(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~As(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~As(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*Sa},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*Sa},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*Sa},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*Sa},set:function(t){this.a=255*t}}]),e}(Hn));function Ra(t,e,i,n){return new Aa(t,e,i,n)}function wa(t){if((0|t)!==t||t>>>8!=0)throw new RangeError("Value out of 8-bit range");return Ma[t]}function ba(t){if(t<=0)return 0;var e=Ma;if(t>=1)return e.length-1;for(var i=0,n=e.length>>>1;0!==n;n>>>=1)e[i|n]<=t&&(i|=n);return t-e[i]<=e[i+1]-t?i:i+1}Aa.WHITE=Object.freeze(new Aa(255,255,255,255)),Aa.GRAY=Object.freeze(new Aa(127,127,127,255)),Aa.BLACK=Object.freeze(new Aa(0,0,0,255)),Aa.TRANSPARENT=Object.freeze(new Aa(0,0,0,0)),Aa.RED=Object.freeze(new Aa(255,0,0,255)),Aa.GREEN=Object.freeze(new Aa(0,255,0,255)),Aa.BLUE=Object.freeze(new Aa(0,0,255,255)),Aa.CYAN=Object.freeze(new Aa(0,255,255,255)),Aa.MAGENTA=Object.freeze(new Aa(255,0,255,255)),Aa.YELLOW=Object.freeze(new Aa(255,255,0,255)),Dr.fastDefine("cc.Color",Aa,{r:0,g:0,b:0,a:255}),v.Color=Aa,v.color=Ra;for(var Oa,Ma=[],Ia=0;Ia<256;Ia++)Ma.push((Oa=Ia/255)<=0?0:Oa>=1?1:Oa<.04045?Oa/12.92:Math.pow((Oa+.055)/1.055,2.4));var Ca,xa=t("MATH_FLOAT_ARRAY",Float64Array),Na=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.createFloatArray=function(t){return new xa(t)},s(e,[{key:"array",get:function(){return this._array}}]),e}(Hn)),Ba=Object.freeze({__proto__:null,bits:gs,Vec2:Qs,v2:$s,Vec3:js,v3:qs,Vec4:ta,v4:ea,Quat:sa,quat:la,Mat3:ia,Mat4:da,mat4:ma,AffineTransform:ga,Size:va,size:ya,Rect:Ta,rect:Ea,Color:Aa,color:Ra,EPSILON:Ts,equals:Es,approx:Ss,clamp:As,clamp01:Rs,lerp:ws,toRadian:bs,toDegree:Os,get random(){return Is},SetUseRandomSeed:xs,SetRandomSeed:Ns,genRandom:Bs,randomRange:Ps,randomRangeInt:Ds,pseudoRandom:Fs,pseudoRandomRange:Ls,pseudoRandomRangeInt:Us,nextPow2:Gs,repeat:ks,pingPong:zs,inverseLerp:Hs,absMaxComponent:Vs,absMax:Ws,enumerableProps:Xs,MATH_FLOAT_ARRAY:xa,MathBase:Na});t("math",Ba),function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(Ca||(Ca={}));var Pa,Da={auto:Ca.AUTO,landscape:Ca.LANDSCAPE,portrait:Ca.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(Pa||(Pa={}));var Fa=new(function(t){function e(){var e,i,n,r,s,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new va(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=Ca.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(i=e._gameCanvas)||void 0===i||null===(n=i.parentNode)||void 0===n||n.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(s=r.parentNode)||void 0===s||s.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var o=e._fnGroup,u=0;u<o.length;u++)if(a=o[u],void 0!==document[a[1]]){for(var h=0;h<a.length;h++)e._fn[o[0][h]]=a[h];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}o(e,t);var i=e.prototype;return i.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=Da[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},i.requestFullScreen=function(){var t=this;return new Promise((function(e,i){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var n=t._getFullscreenTarget();n?n.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(i)}),{once:!0,capture:!0}):i(new Error("Cannot access fullscreen target"))})))}))},i.exitFullScreen=function(){var t=this;return new Promise((function(e,i){var n=document[t._fn.exitFullscreen]();window.Promise&&n instanceof Promise?n.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(i):(t.windowSize=t._cachedFrameSize,e())}))},i._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var i,n,r=window.devicePixelRatio;null===(i=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===i||null===(n=i.addEventListener)||void 0===n||n.call(i,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},i._convertToSizeInCssPixels=function(t){var e=t.clone(),i=this.devicePixelRatio;return e.width/=i,e.height/=i,e},i._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===Pa.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,i=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=i+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=i+"px")}this._updateContainer()}},i._getFullscreenTarget=function(){var t=this._windowType;return t===Pa.Fullscreen?document[this._fn.fullscreenElement]:t===Pa.SubFrame?this._gameFrame:document.body},i._doRequestFullScreen=function(){var t=this;return new Promise((function(e,i){if(t._supportFullScreen){var n=t._getFullscreenTarget();if(n){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=n[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(i):(t._onFullscreenChange=e,t._onFullscreenError=i)}else i(new Error("Cannot access fullscreen target"))}else i(new Error("fullscreen is not supported"))}))},i._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=hs.isMobile&&(e&&t===Ca.PORTRAIT||!e&&t===Ca.LANDSCAPE)},i._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void G(9201);var t,e,i=v.view.getDesignResolutionSize(),n=this._gameFrame,r=n.clientWidth,s=n.clientHeight,a=i.width,o=i.height,u=r/a,h=s/o,c=this._gameContainer.style;u<h?(t=r,e=o*u):(t=a*h,e=s),c.width=t+"px",c.height=e+"px"}else{var l=this._gameContainer.style;l.width="100%",l.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else G(9201)},s(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===Pa.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):G(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new va(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new va(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(G(9201),new va(0,0));var t,e,i;switch(this._windowType){case Pa.SubFrame:return this._gameFrame?new va(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(G(9201),new va(0,0));case Pa.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,i=this.isFrameRotated?t.clientWidth:t.clientHeight,new va(e,i);case Pa.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,i=this.isFrameRotated?window.innerWidth:window.innerHeight,new va(e,i);case Pa.Unknown:default:return new va(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?Pa.Fullscreen:this._gameFrame?this._exactFitScreen?Pa.BrowserWindow:Pa.SubFrame:(G(9201),Pa.Unknown)}}]),e}(es)),La=function(){function t(){}var e=t.prototype;return e.init=function(){var t,e,i=null===(t=Wn.querySettings(Vn.Category.SCREEN,"exactFitScreen"))||void 0===t||t,n=null!==(e=Wn.querySettings(Vn.Category.SCREEN,"orientation"))&&void 0!==e?e:"auto",r=Wn.querySettings(Vn.Category.SCREEN,"overrideDpr");Fa.init({exactFitScreen:i,configOrientation:n,overrideDpr:r},(function(){var t,e=v.director;null!==(t=e.root)&&void 0!==t&&t.pipeline?e.root.pipeline.shadingScale=Fa.resolutionScale:G(1220)}))},e.fullScreen=function(){return Fa.isFullScreen},e.requestFullScreen=function(t,e,i){return arguments.length>0&&G(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),Fa.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==i||i()}))},e.exitFullScreen=function(){return Fa.exitFullScreen()},e.autoFullScreen=function(t,e){var i;null===(i=this.requestFullScreen(t,e))||void 0===i||i.catch((function(){}))},e.disableAutoFullScreen=function(){},s(t,[{key:"devicePixelRatio",get:function(){return Fa.devicePixelRatio}},{key:"windowSize",get:function(){return Fa.windowSize},set:function(t){Fa.windowSize=t}},{key:"resolution",get:function(){return Fa.resolution}},{key:"supportsFullScreen",get:function(){return Fa.supportFullScreen}}]),t}(),Ua=t("screen",new La);v.screen=Ua;var Ga,ka,za=t("sys",{Feature:os,hasFeature:function(t){return hs.hasFeature(t)},NetworkType:rs,Language:ns,OS:ss,Platform:as,BrowserType:is,isNative:hs.isNative,isBrowser:hs.isBrowser,isMobile:hs.isMobile,isLittleEndian:hs.isLittleEndian,platform:hs.platform,language:hs.language,languageCode:hs.nativeLanguage,os:hs.os,osVersion:hs.osVersion,osMainVersion:hs.osMainVersion,browserType:hs.browserType,browserVersion:hs.browserVersion,isXR:hs.isXR,windowPixelResolution:Ua.windowSize,capabilities:{canvas:!0,opengl:!0,webp:hs.hasFeature(os.WEBP),imageBitmap:hs.hasFeature(os.IMAGE_BITMAP),touches:hs.hasFeature(os.INPUT_TOUCH),mouse:hs.hasFeature(os.EVENT_MOUSE),keyboard:hs.hasFeature(os.EVENT_KEYBOARD),accelerometer:hs.hasFeature(os.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return hs.networkType},getBatteryLevel:function(){return hs.getBatteryLevel()},garbageCollect:function(){hs.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",M(t+="Using "+(v.game.renderType===v.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){hs.openURL(t)},init:function(){try{var t=za.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){G(5200)};this.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}this.__isWebIOS14OrIPadOS14Env=(za.os===ss.IOS||za.os===ss.OSX)&&hs.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)},now:function(){return hs.now()},restartVM:function(){hs.restartJSVM()},getSafeAreaRect:function(){var t=v.view,e=Fa.safeAreaEdge,i=Fa.windowSize,n=new Qs(e.left,e.bottom),r=new Qs(i.width-e.right,i.height-e.top);t._convertToUISpace(n),t._convertToUISpace(r);var s=n.x,a=n.y,o=r.x-n.x,u=r.y-n.y;return new Ta(s,a,o,u)}});v.sys=za,function(t){t[t.AUTO=0]="AUTO",t[t.CANVAS=1]="CANVAS",t[t.WEBGL=2]="WEBGL",t[t.HEADLESS=3]="HEADLESS"}(Ga||(Ga={})),function(t){t[t.UNKNOWN=-1]="UNKNOWN",t[t.CANVAS=0]="CANVAS",t[t.WEBGL=1]="WEBGL",t[t.OPENGL=2]="OPENGL",t[t.HEADLESS=3]="HEADLESS"}(ka||(ka={}));var Ha,Va=function(){function t(){this.initialized=!1,this._canvas=null,this._renderType=ka.UNKNOWN}var e=t.prototype;return e.init=function(t,e){if(!this.initialized){var i=Wn.querySettings(Vn.Category.RENDERING,"renderMode");if(this._canvas=t,this._renderType=this._determineRenderType(i),console.time("gfx 2"),this._renderType===ka.WEBGL){var n=new se(e),r=!!window.WebGL2RenderingContext,s=window.navigator.userAgent.toLowerCase();(-1!==s.indexOf("safari")&&-1===s.indexOf("chrome")||za.browserType===is.UC)&&(r=!1);var a=[];r&&v.WebGL2Device&&a.push(v.WebGL2Device),v.WebGLDevice&&a.push(v.WebGLDevice),v.EmptyDevice&&a.push(v.EmptyDevice),ci.canvas=t;for(var o=0;o<a.length&&(this._gfxDevice=new a[o],!this._gfxDevice.initialize(n));o++);}else this._renderType===ka.HEADLESS&&v.EmptyDevice&&(this._gfxDevice=new v.EmptyDevice,this._gfxDevice.initialize(new se(e)));if(console.timeEnd("phase gfx 2"),console.time("phase gfx 3"),!this._gfxDevice)return C("can not support canvas rendering in 3D"),void(this._renderType=ka.UNKNOWN);var u=new re(this._canvas),h=Ua.windowSize;u.width=h.width,u.height=h.height,this._swapchain=this._gfxDevice.createSwapchain(u),this._canvas&&(this._canvas.oncontextmenu=function(){return!1}),console.timeEnd("gfx 3")}},e._determineRenderType=function(t){("number"!=typeof t||t>ka.HEADLESS||t<Ga.AUTO)&&(t=Ga.AUTO);var e=ka.CANVAS,i=!1;if(t===Ga.CANVAS?(e=ka.CANVAS,i=!0):t===Ga.AUTO||t===Ga.WEBGL?(e=ka.WEBGL,i=!0):t===Ga.HEADLESS&&(e=ka.HEADLESS,i=!0),!i)throw new Error(X(3820,t));return e},s(t,[{key:"gfxDevice",get:function(){return this._gfxDevice}},{key:"swapchain",get:function(){return this._swapchain}}]),t}(),Wa=new Va;t("gfx",Object.freeze({__proto__:null,DescriptorSet:gi,Buffer:ui,CommandBuffer:hi,get ObjectType(){return Q},get Status(){return Z},get API(){return J},get SurfaceTransform(){return $},get Feature(){return tt},get Format(){return et},get FormatType(){return it},get Type(){return nt},get BufferUsageBit(){return rt},get BufferFlagBit(){return st},get MemoryAccessBit(){return at},get MemoryUsageBit(){return ot},get TextureType(){return ut},get TextureUsageBit(){return ht},get TextureFlagBit(){return ct},get FormatFeatureBit(){return lt},get SampleCount(){return _t},get VsyncMode(){return dt},get Filter(){return ft},get Address(){return pt},get ComparisonFunc(){return mt},get StencilOp(){return gt},get BlendFactor(){return vt},get BlendOp(){return yt},get ColorMask(){return Tt},get ShaderStageFlagBit(){return Et},get LoadOp(){return St},get StoreOp(){return At},get AccessFlagBit(){return Rt},get ResolveMode(){return wt},get PipelineBindPoint(){return bt},get PrimitiveMode(){return Ot},get PolygonMode(){return Mt},get ShadeModel(){return It},get CullMode(){return Ct},get DynamicStateFlagBit(){return xt},get StencilFace(){return Nt},get DescriptorType(){return Bt},get QueueType(){return Pt},get QueryType(){return Dt},get CommandBufferType(){return Ft},get ClearFlagBit(){return Lt},get BarrierType(){return Ut},get PassType(){return Gt},Size:Wt,DeviceCaps:Xt,DeviceOptions:jt,Offset:Yt,Rect:Kt,Extent:qt,TextureSubresLayers:Qt,TextureSubresRange:Zt,TextureCopy:Jt,TextureBlit:$t,BufferTextureCopy:te,Viewport:ee,Color:ie,BindingMappingInfo:ne,SwapchainInfo:re,DeviceInfo:se,BufferInfo:ae,BufferViewInfo:oe,DrawInfo:ue,DispatchInfo:he,IndirectBuffer:ce,TextureInfo:le,TextureViewInfo:_e,SamplerInfo:de,Uniform:fe,UniformBlock:pe,UniformSamplerTexture:me,UniformSampler:ge,UniformTexture:ve,UniformStorageImage:ye,UniformStorageBuffer:Te,UniformInputAttachment:Ee,ShaderStage:Se,Attribute:Ae,ShaderInfo:Re,InputAssemblerInfo:we,ColorAttachment:be,DepthStencilAttachment:Oe,SubpassInfo:Me,SubpassDependency:Ie,RenderPassInfo:Ce,GeneralBarrierInfo:xe,TextureBarrierInfo:Ne,BufferBarrierInfo:Be,FramebufferInfo:Pe,DescriptorSetLayoutBinding:De,DescriptorSetLayoutInfo:Fe,DescriptorSetInfo:Le,PipelineLayoutInfo:Ue,InputState:Ge,CommandBufferInfo:ke,QueueInfo:ze,QueryPoolInfo:He,FormatInfo:Ve,MemoryStatus:We,DynamicStencilStates:Xe,DynamicStates:je,GFXObject:Ye,get AttributeName(){return Vt},FormatInfos:Ke,DESCRIPTOR_BUFFER_TYPE:qe,DESCRIPTOR_SAMPLER_TYPE:Qe,DESCRIPTOR_DYNAMIC_TYPE:Ze,DRAW_INFO_SIZE:Je,IsPowerOf2:$e,FormatSize:ti,FormatSurfaceSize:ei,GetTypeSize:ni,getTypedArrayConstructor:ri,formatAlignment:si,alignTo:ai,Device:ci,Swapchain:li,Framebuffer:_i,InputAssembler:mi,DescriptorSetLayout:vi,PipelineLayout:yi,RasterizerState:Ti,DepthStencilState:Ei,BlendTarget:Si,BlendState:Ai,PipelineStateInfo:Ri,PipelineState:wi,Queue:bi,RenderPass:Oi,Sampler:Mi,Shader:Ii,Texture:Ci,GeneralBarrier:xi,TextureBarrier:Ni,get LegacyRenderMode(){return Ga},get RenderType(){return ka},DeviceManager:Va,deviceManager:Wa}));var Xa,ja=((Ha={})[it.UNORM]="Uint",Ha[it.SNORM]="Int",Ha[it.UINT]="Uint",Ha[it.INT]="Int",Ha[it.UFLOAT]="Float",Ha[it.FLOAT]="Float",Ha.default="Uint",Ha);function Ya(t){return""+(ja[t.type]||ja.default)+t.size/t.count*8}function Ka(t,e,i,n,r){void 0===i&&(i=et.R32F),void 0===n&&(n=0),void 0===r&&(r=0);var s=Ke[i];r||(r=s.size);for(var a="set"+Ya(s),o=s.size/s.count,u=Math.floor(e.length/s.count),h=za.isLittleEndian,c=0;c<u;++c)for(var l=n+r*c,_=0;_<s.count;++_){var d=l+o*_;t[a](d,e[s.count*c+_],h)}}function qa(t,e,i,n,r,s){void 0===e&&(e=et.R32F),void 0===i&&(i=0),void 0===n&&(n=t.byteLength-i),void 0===r&&(r=0),void 0===s&&(s=[]);var a=Ke[e];r||(r=a.size);for(var o="get"+Ya(a),u=a.size/a.count,h=Math.floor(n/r),c=za.isLittleEndian,l=0;l<h;++l)for(var _=i+r*l,d=0;d<a.count;++d){var f=_+u*d;s[a.count*l+d]=t[o](f,c)}return s}function Qa(t,e,i,n,r,s,a){void 0===i&&(i=et.R32F),void 0===n&&(n=0),void 0===r&&(r=t.byteLength-n),void 0===s&&(s=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var o=Ke[i];s||(s=o.size);for(var u="set"+Ya(o),h="get"+Ya(o),c=o.size/o.count,l=Math.floor(r/s),_=za.isLittleEndian,d=0;d<l;++d)for(var f=n+s*d,p=0;p<o.count;++p){var m=f+c*p,g=t[h](m,_);a[u](m,e(g,p,t),_)}return a}function Za(t,e,i,n){return i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),n)}!function(t){t[t.positions=Vt.ATTR_POSITION]="positions",t[t.normals=Vt.ATTR_NORMAL]="normals",t[t.uvs=Vt.ATTR_TEX_COORD]="uvs",t[t.colors=Vt.ATTR_COLOR]="colors"}(Xa||(Xa={}));var Ja=function(){},$a=function(){return Ja},to=eo((function(){}));function eo(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function io(t){return function(e){return function(i){!function(t,e,i){var n=ro(t);if(n){var r=so(n,"proto");so(r,"editor")[e]=i}}(i,t,e)}}}var no="__ccclassCache__";function ro(t){return so(t,no)}function so(t,e){return t[e]||(t[e]={})}var ao=eo((function(t,e){var i=Dn.getSuper(t);i===Object&&(i=null);var n={name:e,extends:i,ctor:t},r=t[no];if(r){var s=r.proto;s&&Dn.mixin(n,s),t[no]=void 0}return Dr(n)})),oo=io("requireComponent"),uo=io("executionOrder"),ho=to;function co(t,e,i){var n=null;function r(t,e,i){!function(t,e,i,n,r,s){var a,o=s&&"function"!=typeof s&&(s.get||s.set);r&&(a=Ar(r,o));var u=Dn.mixin(e,a||r||{});o?(s.get&&(u.get=s.get),s.set&&(u.set=s.set)):fo(t,u,i,n,s)}(function(t){return ro(t.constructor)}(t),function(t,e){var i,n,r=so(ro(t.constructor),"proto"),s=so(r,"properties");return null!==(n=s[i=e])&&void 0!==n?n:s[i]={}}(t,e),t.constructor,e,n,i)}return void 0===t?co({type:void 0}):void 0===e?(n=t,r):void r(t,e,i)}function lo(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}function _o(t,e,i){var n,r,s=ro(t.constructor),a=so(s,"proto"),o=so(a,"properties"),u=null!==(r=o[n=e])&&void 0!==r?r:o[n]={};return u.__internalFlags|=Rr.STANDALONE,i&&"function"!=typeof i&&(i.get||i.set)?(i.get&&(u.get=i.get),i.set&&(u.set=i.set)):fo(s,u,t.constructor,e,i),u}function fo(t,e,i,n,r){if(r)"function"==typeof r?e.default=lo(r):r.initializer&&(e.default=lo(r.initializer));else{var s=t.default||(t.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(i));s.hasOwnProperty(n)&&(e.default=s[n])}}var po=Symbol("cc:SerializationMetadata"),mo=function(t,e,i){yo(_o(t,e,i))};function go(t){return function(e,i,n){var r=_o(e,i,n);r.formerlySerializedAs=t,yo(r)}}var vo=function(t,e,i){var n=_o(t,e,i);n.editorOnly=!0,yo(n)};function yo(t){t.__internalFlags|=Rr.IMPLICIT_SERIALIZABLE}var To=Ja,Eo=to,So=$a,Ao=to,Ro=$a,wo=$a,bo=$a,Oo=xo(dr),Mo=xo(fr),Io=xo(pr),Co=xo(mr);function xo(t){return co({type:t})}var No=function(t,e,i){_o(t,e,i).override=!0},Bo=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Dn.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=Dn.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},s(t,[{key:"count",get:function(){return this._count}}]),t}(),Po=function(){function t(e,i){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var n=0,r=i.length;n<r;n++)this.pipes.push(i[n])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(G(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var i=0,n=e.length;i<n;){var r=(0,e[i])(t);if(r)return t.isFinish=!0,r;++i!==n&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var i=this;(0,this.pipes[t])(e,(function(n){n?(e.isFinish=!0,e.dispatch("complete",n)):++t<i.pipes.length?(e.input=e.output,e.output=null,i._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",n,e.output))}))},t}();Po._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=Dn.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var i=this.get(e);i&&t(i,e)}},e.find=function(t){for(var e in this._weakMap){var i=this.get(e);if(i&&t(i,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},s(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var Do,Fo=new Bo,Lo=new Bo,Uo=new Bo,Go=new Bo,ko=new Po("normal load",[]),zo=new Po("fetch",[]),Ho=new Po("transform url",[]),Vo=new Map;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(Do||(Do={}));var Wo,Xo={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.INTERNAL="internal",t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Wo||(Wo={}));var jo=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var i;return 0!==t._deadPool.length?(i=t._deadPool.pop()).set(e):i=new t(e),i};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,i,n,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,n,r);break;case"error":this.onError&&this.onError(e,i,n,r);break;default:var s="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[s]&&this[s](e,i,n,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();jo.MAX_DEAD_NUM=500,jo._taskId=0,jo._deadPool=[];var Yo="0123456789abcdef".split(""),Ko=["","","",""],qo=Ko.concat(Ko,"-",Ko,"-",Ko,"-",Ko,"-",Ko,Ko,Ko),Qo=qo.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function Zo(t){var e=t.split("@")[0];if(22!==e.length)return t;qo[0]=t[0],qo[1]=t[1];for(var i=2,n=2;i<22;i+=2){var r=Qn[t.charCodeAt(i)],s=Qn[t.charCodeAt(i+1)];qo[Qo[n++]]=Yo[r>>2],qo[Qo[n++]]=Yo[(3&r)<<2|s>>4],qo[Qo[n++]]=Yo[15&s]}return t.replace(e,qo.join(""))}var Jo=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function $o(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.nativeExt&&(e.ext=e.nativeExt);var i=Go.find((function(e){return!!e.getAssetInfo(t)}));return i&&(e.bundle=i.name),iu(t,e)}function tu(t){return!!t&&(t instanceof v.SceneAsset||t instanceof v.Scene)}function eu(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function iu(t,e){var i=jo.create({input:t,options:e}),n=[];try{for(var r,s=p(Ho.sync(i));!(r=s()).done;){var a=r.value,o=a.url;a.recycle(),n.push(o)}}catch(t){for(var u,h=p(i.output);!(u=h()).done;)u.value.recycle();C(t.message,t.stack)}return i.recycle(),n.length>1?n:n[0]}var nu,ru,su,au=Object.freeze({__proto__:null,getUuidFromURL:function(t){var e=Jo.exec(t);return e?e[1]:""},getUrlWithUuid:$o,isScene:tu,normalize:eu,transform:iu,decodeUuid:Zo}),ou=/(\.[^\.\/\?\\]*)(\?.*)?$/,uu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,hu=/[^\.\/]+\/\.\.\//;function cu(){for(var t="",e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];for(var r=0,s=i;r<s.length;r++){var a=s[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function lu(t){var e=ou.exec(t);return e?e[1]:""}function _u(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function du(t,e){var i=t.indexOf("?");i>0&&(t=t.substring(0,i));var n=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!n)return t;var r=n[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function fu(t){var e=uu.exec(t);return e?e[2]:""}function pu(t,e){e=e||"";var i=t.indexOf("?"),n="";return i>0&&(n=t.substring(i),t=t.substring(0,i)),(i=t.lastIndexOf("."))<0?t+e+n:t.substring(0,i)+e+n}function mu(t,e,i){if(0===e.indexOf("."))return pu(t,e);var n=t.indexOf("?"),r="",s=i?lu(t):"";return n>0&&(r=t.substring(n),t=t.substring(0,n)),n=(n=t.lastIndexOf("/"))<=0?0:n+1,t.substring(0,n)+e+s+r}function gu(t){var e=t=String(t);do{e=t,t=t.replace(hu,"")}while(e.length!==t.length);return t}function vu(t){return t.replace(/[\/\\]$/,"")}function yu(){return hs.os===ss.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:cu,extname:lu,mainFileName:_u,basename:du,dirname:fu,changeExtname:pu,changeBasename:mu,_normalize:gu,stripSep:vu,getSeperator:yu}));var Tu=t("Asset",ao("cc.Asset")((ru=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).loaded=!0,e._native=su&&su(),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(d(e),"_uuid",{value:"",writable:!0}),e}o(e,t),e.deserialize=function(t){return v.deserialize(t)};var i=e.prototype;return i.toString=function(){return this.nativeUrl},i.serialize=function(){},i._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},i.addRef=function(){return this._ref++,this},i.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&v.assetManager._releaseManager.tryRelease(this),this},i.onLoaded=function(){},i.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},i.validate=function(){return!0},i.destroy=function(){return N(X(12101,this._uuid)),t.prototype.destroy.call(this)},s(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=$o(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=$o(this._uuid,{__nativeName__:t,nativeExt:lu(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(ts(Vr)),su=Za(ru.prototype,"_native",[mo],(function(){return""})),m(ru.prototype,"_nativeAsset",[co],Object.getOwnPropertyDescriptor(ru.prototype,"_nativeAsset"),ru.prototype),nu=ru))||nu);Tu.prototype.createNode=null,v.Asset=Tu;var Eu=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(i){"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer},t}(),Su=new js,Au=new js,Ru=new js,wu=new js,bu=new js,Ou=new js,Mu=new Array(3),Iu=new Array(3);function Cu(t,e){return js.dot(e.n,t)-e.d}function xu(t,e,i){return js.copy(t,e),js.subtract(bu,i.center,i.halfExtents),js.add(Ou,i.center,i.halfExtents),t.x=t.x<bu.x?bu.x:t.x,t.y=t.y<bu.y?bu.y:t.y,t.z=t.z<bu.z?bu.z:t.z,t.x=t.x>Ou.x?Ou.x:t.x,t.y=t.y>Ou.y?Ou.y:t.y,t.z=t.z>Ou.z?Ou.z:t.z,t}function Nu(t,e,i){js.set(Su,i.orientation.m00,i.orientation.m01,i.orientation.m02),js.set(Au,i.orientation.m03,i.orientation.m04,i.orientation.m05),js.set(Ru,i.orientation.m06,i.orientation.m07,i.orientation.m08),Mu[0]=Su,Mu[1]=Au,Mu[2]=Ru,Iu[0]=i.halfExtents.x,Iu[1]=i.halfExtents.y,Iu[2]=i.halfExtents.z,js.subtract(wu,e,i.center),js.set(t,i.center.x,i.center.y,i.center.z);for(var n=0;n<3;n++){var r=js.dot(wu,Mu[n]);r>Iu[n]&&(r=Iu[n]),r<-Iu[n]&&(r=-Iu[n]),t.x+=r*Mu[n].x,t.y+=r*Mu[n].y,t.z+=r*Mu[n].z}return t}var Bu=Object.freeze({__proto__:null,point_plane:Cu,pt_point_plane:function(t,e,i){var n=Cu(e,i);return js.subtract(t,e,js.multiplyScalar(t,i.n,n))},pt_point_aabb:xu,pt_point_obb:Nu,pt_point_line:function(t,e,i,n){js.subtract(Su,i,n);var r=Su,s=js.lengthSqr(r);if(0==s)js.copy(t,i);else{js.subtract(Su,e,i);var a=js.dot(Su,r)/s;a<0?js.copy(t,i):a>1?js.copy(t,n):js.scaleAndAdd(t,i,r,a)}}}),Pu={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512,SHAPE_SPLINE:1024},Du=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Pu.SHAPE_RAY,this.o=new js(t,e,i),this.d=new js(n,r,s)}return t.create=function(e,i,n,r,s,a){return void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=1),new t(e,i,n,r,s,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return js.copy(t.o,e.o),js.copy(t.d,e.d),t},t.fromPoints=function(t,e,i){return js.copy(t.o,e),js.normalize(t.d,js.subtract(t.d,i,e)),t},t.set=function(t,e,i,n,r,s,a){return t.o.x=e,t.o.y=i,t.o.z=n,t.d.x=r,t.d.y=s,t.d.z=a,t},t.prototype.computeHit=function(t,e){js.normalize(t,this.d),js.scaleAndAdd(t,this.o,t,e)},s(t,[{key:"type",get:function(){return this._type}}]),t}(),Fu=new js,Lu=new js,Uu=new js,Gu=new js;function ku(t){return Math.max(Math.max(t.x,t.y),t.z)}var zu,Hu=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this._center=new js(0,0,0),this._radius=0,this._type=void 0,this._type=Pu.SHAPE_SPHERE,this._center=new js(t,e,i),this._radius=n}t.create=function(e,i,n,r){return new t(e,i,n,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return js.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,i){return js.multiplyScalar(t.center,js.add(Fu,e,i),.5),t.radius=.5*js.subtract(Fu,i,e).length(),t},t.set=function(t,e,i,n,r){return t.center.x=e,t.center.y=i,t.center.z=n,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){js.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),js.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,i,n,r){js.transformMat4(r.center,this.center,t),r.radius=this.radius*ku(n)},e.translateAndRotate=function(t,e,i){js.transformMat4(i.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*ku(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),js.subtract(Lu,t,this.center);var e=Lu.length();if(e>this.radius){var i=.5*(e-this.radius);this.radius+=i,js.multiplyScalar(Lu,Lu,i/e),js.add(this.center,this.center,Lu)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var i=0;i<e;i++)this.mergePoint(t[i])}},e.mergeAABB=function(t){t.getBoundary(Uu,Gu),this.mergePoint(Uu),this.mergePoint(Gu)},s(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),Vu=function(){function t(t,e,i,n,r,s,a,o,u){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=1),void 0===u&&(u=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Pu.SHAPE_TRIANGLE,this.a=new js(t,e,i),this.b=new js(n,r,s),this.c=new js(a,o,u)}return t.create=function(e,i,n,r,s,a,o,u,h){return void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=1),new t(e,i,n,r,s,a,o,u,h)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return js.copy(t.a,e.a),js.copy(t.b,e.b),js.copy(t.c,e.c),t},t.fromPoints=function(t,e,i,n){return js.copy(t.a,e),js.copy(t.b,i),js.copy(t.c,n),t},t.set=function(t,e,i,n,r,s,a,o,u,h){return t.a.x=e,t.a.y=i,t.a.z=n,t.b.x=r,t.b.y=s,t.b.z=a,t.c.x=o,t.c.y=u,t.c.z=h,t},s(t,[{key:"type",get:function(){return this._type}}]),t}();!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(zu||(zu={}));var Wu,Xu,ju,Yu,Ku,qu,Qu,Zu,Ju=(Wu=new js(0,0,0),function(t,e){var i=js.dot(t.d,e.n);if(Math.abs(i)<Number.EPSILON)return 0;js.multiplyScalar(Wu,e.n,e.d);var n=js.dot(js.subtract(Wu,Wu,t.o),e.n)/i;return n<0?0:n}),$u=(Xu=new js(0,0,0),ju=new js(0,0,0),Yu=new js(0,0,0),Ku=new js(0,0,0),qu=new js(0,0,0),function(t,e,i){js.subtract(Xu,e.b,e.a),js.subtract(ju,e.c,e.a),js.cross(Yu,t.d,ju);var n=js.dot(Xu,Yu);if(n<Number.EPSILON&&(!i||n>-Number.EPSILON))return 0;var r=1/n;js.subtract(Ku,t.o,e.a);var s=js.dot(Ku,Yu)*r;if(s<0||s>1)return 0;js.cross(qu,Ku,Xu);var a=js.dot(t.d,qu)*r;if(a<0||s+a>1)return 0;var o=js.dot(ju,qu)*r;return o<0?0:o}),th=function(){var t=new js(0,0,0);return function(e,i){var n=i.radius,r=i.center,s=e.o,a=e.d,o=n*n;js.subtract(t,r,s);var u=t.lengthSqr(),h=js.dot(t,a),c=o-(u-h*h);if(c<0)return 0;var l=Math.sqrt(c),_=u<o?h+l:h-l;return _<0?0:_}}(),eh=(Qu=new js,Zu=new js,function(t,e){return js.subtract(Qu,e.center,e.halfExtents),js.add(Zu,e.center,e.halfExtents),ih(t,Qu,Zu)});function ih(t,e,i){var n=t.o,r=t.d,s=1/r.x,a=1/r.y,o=1/r.z,u=(e.x-n.x)*s,h=(i.x-n.x)*s,c=(e.y-n.y)*a,l=(i.y-n.y)*a,_=(e.z-n.z)*o,d=(i.z-n.z)*o,f=Math.max(Math.max(Math.min(u,h),Math.min(c,l)),Math.min(_,d)),p=Math.min(Math.min(Math.max(u,h),Math.max(c,l)),Math.max(_,d));return p<0||f>p?0:f>0?f:p}var nh,rh,sh,ah,oh=function(){var t=new js,e=new js,i=new js,n=new js,r=new js,s=new js,a=new js,o=new Array(3),u=new Array(3),h=new Array(3),c=new Array(6);return function(l,_){o[0]=_.halfExtents.x,o[1]=_.halfExtents.y,o[2]=_.halfExtents.z,t=_.center,e=l.o,i=l.d,js.set(n,_.orientation.m00,_.orientation.m01,_.orientation.m02),js.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),js.set(s,_.orientation.m06,_.orientation.m07,_.orientation.m08),js.subtract(a,t,e),u[0]=js.dot(n,i),u[1]=js.dot(r,i),u[2]=js.dot(s,i),h[0]=js.dot(n,a),h[1]=js.dot(r,a),h[2]=js.dot(s,a);for(var d=0;d<3;++d){if(0===u[d]){if(-h[d]-o[d]>0||-h[d]+o[d]<0)return 0;u[d]=1e-7}c[2*d+0]=(h[d]+o[d])/u[d],c[2*d+1]=(h[d]-o[d])/u[d]}var f=Math.max(Math.max(Math.min(c[0],c[1]),Math.min(c[2],c[3])),Math.min(c[4],c[5])),p=Math.min(Math.min(Math.max(c[0],c[1]),Math.max(c[2],c[3])),Math.max(c[4],c[5]));return p<0||f>p?0:f>0?f:p}}(),uh=function(){var t=new js,e=new js,i=new js,n=new js,r=new js,s=new js,a=new js,o=new Hu;return function(u,h){var c=h.radius*h.radius,l=js.normalize(t,u.d),_=h.ellipseCenter0,d=h.ellipseCenter1,f=js.subtract(e,d,_);if(f.equals(js.ZERO))return o.radius=h.radius,o.center.set(h.ellipseCenter0),jh.raySphere(u,o);var p=u.o,m=js.subtract(i,p,_),g=js.cross(n,l,f),v=g.lengthSqr();if(0===v){o.radius=h.radius;var y=js.subtract(r,d,p);return m.lengthSqr()<y.lengthSqr()?o.center.set(h.ellipseCenter0):o.center.set(h.ellipseCenter1),jh.raySphere(u,o)}var T=js.cross(r,m,f),E=f.lengthSqr(),S=2*js.dot(g,T),A=S*S-4*v*(T.lengthSqr()-c*E);if(A<0)return 0;var R=(-S-Math.sqrt(A))/(2*v);if(R<0){o.radius=h.radius;var w=js.subtract(s,d,p);return m.lengthSqr()<w.lengthSqr()?o.center.set(h.ellipseCenter0):o.center.set(h.ellipseCenter1),jh.raySphere(u,o)}var b=js.scaleAndAdd(s,u.o,l,R),O=js.subtract(a,b,_),M=js.dot(O,f)/E;return M>=0&&M<=1?R:M<0?(o.radius=h.radius,o.center.set(h.ellipseCenter0),jh.raySphere(u,o)):M>1?(o.radius=h.radius,o.center.set(h.ellipseCenter1),jh.raySphere(u,o)):0}}(),hh=(nh=Vu.create(),rh={distance:1/0,doubleSided:!1,mode:zu.ANY},sh=0,ah=function(t,e,i,n,r,s){t===zu.CLOSEST?(sh>e||0===sh)&&(sh=e,s&&(0===s.length?s.push({distance:e,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}):(s[0].distance=e,s[0].vertexIndex0=i/3,s[0].vertexIndex1=n/3,s[0].vertexIndex2=r/3))):(sh=e,s&&s.push({distance:e,vertexIndex0:i/3,vertexIndex1:n/3,vertexIndex2:r/3}))},function(t,e,i){if(sh=0,0===e.geometricInfo.positions.length)return sh;var n=void 0===i?rh:i;if(ih(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,s=e.geometricInfo;!function(t,e,i,n,r){if(i===Ot.TRIANGLE_LIST)for(var s=e.length,a=0;a<s;a+=3){var o=3*e[a],u=3*e[a+1],h=3*e[a+2];js.set(nh.a,t[o],t[o+1],t[o+2]),js.set(nh.b,t[u],t[u+1],t[u+2]),js.set(nh.c,t[h],t[h+1],t[h+2]);var c=jh.rayTriangle(n,nh,r.doubleSided);if(!(0===c||c>r.distance)&&(ah(r.mode,c,o,u,h,r.result),r.mode===zu.ANY))return c}else if(i===Ot.TRIANGLE_STRIP)for(var l=e.length-2,_=0,d=0;d<l;d+=1){var f=3*e[d-_],p=3*e[d+_+1],m=3*e[d+2];js.set(nh.a,t[f],t[f+1],t[f+2]),js.set(nh.b,t[p],t[p+1],t[p+2]),js.set(nh.c,t[m],t[m+1],t[m+2]),_=~_;var g=jh.rayTriangle(n,nh,r.doubleSided);if(!(0===g||g>r.distance)&&(ah(r.mode,g,f,p,m,r.result),r.mode===zu.ANY))return g}else if(i===Ot.TRIANGLE_FAN){var v=e.length-1,y=3*e[0];js.set(nh.a,t[y],t[y+1],t[y+2]);for(var T=1;T<v;T+=1){var E=3*e[T],S=3*e[T+1];js.set(nh.b,t[E],t[E+1],t[E+2]),js.set(nh.c,t[S],t[S+1],t[S+2]);var A=jh.rayTriangle(n,nh,r.doubleSided);if(!(0===A||A>r.distance)&&(ah(r.mode,A,y,E,S,r.result),r.mode===zu.ANY))return A}}}(s.positions,s.indices,r,t,n)}return sh}),ch=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:zu.ANY};return function(i,n,r){t=0;var s=void 0===r?e:r,a=n.renderingSubMeshes.length,o=n.struct.minPosition,u=n.struct.maxPosition;if(o&&u&&!ih(i,o,u))return t;for(var h=0;h<a;h++){var c=n.renderingSubMeshes[h],l=hh(i,c,s);if(l)if(s.mode===zu.CLOSEST)(0===t||t>l)&&(t=l,s.subIndices&&(s.subIndices[0]=h));else if(t=l,s.subIndices&&s.subIndices.push(h),s.mode===zu.ANY)return l}return t&&s.mode===zu.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),lh=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:zu.ANY},i=new Du,n=new da;return function(r,s,a){t=0;var o=void 0===a?e:a,u=s.worldBounds;if(u&&!eh(r,u))return t;Du.copy(i,r),s.node&&(da.invert(n,s.node.getWorldMatrix(n)),js.transformMat4(i.o,r.o,n),js.transformMat4Normal(i.d,r.d,n));for(var h=s.subModels,c=0;c<h.length;c++){var l=h[c].subMesh,_=hh(i,l,o);if(_)if(o.mode===zu.CLOSEST)(0===t||t>_)&&(t=_,o.subIndices&&(o.subIndices[0]=c));else if(t=_,o.subIndices&&o.subIndices.push(c),o.mode===zu.ANY)return _}return t&&o.mode===zu.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),_h=function(){var t=new js(0,0,0);return function(e,i){js.subtract(t,e.e,e.s);var n=(i.d-js.dot(e.s,i.n))/js.dot(t,i.n);return n<0||n>1?0:n}}(),dh=function(){var t=new js(0,0,0),e=new js(0,0,0),i=new js(0,0,0),n=new js(0,0,0),r=new js(0,0,0),s=new js(0,0,0);return function(a,o,u){js.subtract(t,o.b,o.a),js.subtract(e,o.c,o.a),js.subtract(i,a.s,a.e),js.cross(r,t,e);var h=js.dot(i,r);if(h<=0)return 0;js.subtract(n,a.s,o.a);var c=js.dot(n,r);if(c<0||c>h)return 0;js.cross(s,i,n);var l=js.dot(e,s);if(l<0||l>h)return 0;var _=-js.dot(t,s);if(_<0||l+_>h)return 0;if(u){var d=1/h,f=1-(l*=d)-(_*=d);js.set(u,o.a.x*f+o.b.x*l+o.c.x*_,o.a.y*f+o.b.y*l+o.c.y*_,o.a.z*f+o.b.z*l+o.c.z*_)}return 1}}(),fh=new Du;function ph(t,e){fh.o.set(t.s),js.subtract(fh.d,t.e,t.s),fh.d.normalize();var i=eh(fh,e);return i<=t.length()?i:0}function mh(t,e){fh.o.set(t.s),js.subtract(fh.d,t.e,t.s),fh.d.normalize();var i=oh(fh,e);return i<=t.length()?i:0}function gh(t,e){fh.o.set(t.s),js.subtract(fh.d,t.e,t.s),fh.d.normalize();var i=th(fh,e);return i<=t.length()?i:0}var vh,yh,Th,Eh,Sh=(vh=new js,yh=new js,Th=new js,Eh=new js,function(t,e){return js.subtract(vh,t.center,t.halfExtents),js.add(yh,t.center,t.halfExtents),js.subtract(Th,e.center,e.halfExtents),js.add(Eh,e.center,e.halfExtents),vh.x<=Eh.x&&yh.x>=Th.x&&vh.y<=Eh.y&&yh.y>=Th.y&&vh.z<=Eh.z&&yh.z>=Th.z});function Ah(t,e,i,n,r,s){js.set(s[0],t.x+i.x*e.x+n.x*e.y+r.x*e.z,t.y+i.y*e.x+n.y*e.y+r.y*e.z,t.z+i.z*e.x+n.z*e.y+r.z*e.z),js.set(s[1],t.x-i.x*e.x+n.x*e.y+r.x*e.z,t.y-i.y*e.x+n.y*e.y+r.y*e.z,t.z-i.z*e.x+n.z*e.y+r.z*e.z),js.set(s[2],t.x+i.x*e.x-n.x*e.y+r.x*e.z,t.y+i.y*e.x-n.y*e.y+r.y*e.z,t.z+i.z*e.x-n.z*e.y+r.z*e.z),js.set(s[3],t.x+i.x*e.x+n.x*e.y-r.x*e.z,t.y+i.y*e.x+n.y*e.y-r.y*e.z,t.z+i.z*e.x+n.z*e.y-r.z*e.z),js.set(s[4],t.x-i.x*e.x-n.x*e.y-r.x*e.z,t.y-i.y*e.x-n.y*e.y-r.y*e.z,t.z-i.z*e.x-n.z*e.y-r.z*e.z),js.set(s[5],t.x+i.x*e.x-n.x*e.y-r.x*e.z,t.y+i.y*e.x-n.y*e.y-r.y*e.z,t.z+i.z*e.x-n.z*e.y-r.z*e.z),js.set(s[6],t.x-i.x*e.x+n.x*e.y-r.x*e.z,t.y-i.y*e.x+n.y*e.y-r.y*e.z,t.z-i.z*e.x+n.z*e.y-r.z*e.z),js.set(s[7],t.x-i.x*e.x-n.x*e.y+r.x*e.z,t.y-i.y*e.x-n.y*e.y+r.y*e.z,t.z-i.z*e.x-n.z*e.y+r.z*e.z)}function Rh(t,e){for(var i=js.dot(e,t[0]),n=i,r=1;r<8;++r){var s=js.dot(e,t[r]);i=s<i?s:i,n=s>n?s:n}return[i,n]}var wh,bh,Oh,Mh=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new js(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new js(0,0,0),n[r]=new js(0,0,0);var s=new js,a=new js;return function(e,r){js.set(t[0],1,0,0),js.set(t[1],0,1,0),js.set(t[2],0,0,1),js.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),js.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),js.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)js.cross(t[6+3*o],t[o],t[3]),js.cross(t[7+3*o],t[o],t[4]),js.cross(t[7+3*o],t[o],t[5]);js.subtract(s,e.center,e.halfExtents),js.add(a,e.center,e.halfExtents),function(t,e,i){js.set(i[0],t.x,e.y,e.z),js.set(i[1],t.x,e.y,t.z),js.set(i[2],t.x,t.y,e.z),js.set(i[3],t.x,t.y,t.z),js.set(i[4],e.x,e.y,e.z),js.set(i[5],e.x,e.y,t.z),js.set(i[6],e.x,t.y,e.z),js.set(i[7],e.x,t.y,t.z)}(s,a,i),Ah(r.center,r.halfExtents,t[3],t[4],t[5],n);for(var u=0;u<15;++u){var h=Rh(i,t[u]),c=Rh(n,t[u]);if(c[0]>h[1]||h[0]>c[1])return 0}return 1}}(),Ih=function(t,e){var i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),n=js.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1},Ch=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===Ih(t,e.planes[i]))return 0;return 1},xh=function(){for(var t=new Array(8),e=0,i=0,n=0;n<t.length;n++)t[n]=new js(0,0,0);return function(n,r){for(var s=0,a=!1,o=0;o<r.planes.length;o++){if(-1===(s=Ih(n,r.planes[o])))return 0;1===s&&(a=!0)}if(!a)return 1;for(var u=0;u<r.vertices.length;u++)js.subtract(t[u],r.vertices[u],n.center);e=0,i=0;for(var h=0;h<r.vertices.length;h++)t[h].x>n.halfExtents.x?e++:t[h].x<-n.halfExtents.x&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(var c=0;c<r.vertices.length;c++)t[c].y>n.halfExtents.y?e++:t[c].y<-n.halfExtents.y&&i++;if(e===r.vertices.length||i===r.vertices.length)return 0;e=0,i=0;for(var l=0;l<r.vertices.length;l++)t[l].z>n.halfExtents.z?e++:t[l].z<-n.halfExtents.z&&i++;return e===r.vertices.length||i===r.vertices.length?0:1}}(),Nh=(wh=new js(0,0,0),bh=new ia,function(t,e){return js.subtract(wh,e,t.center),js.transformMat3(wh,wh,ia.transpose(bh,t.orientation)),i=wh,n=t.halfExtents,Math.abs(i.x)<n.x&&Math.abs(i.y)<n.y&&Math.abs(i.z)<n.z;var i,n}),Bh=(Oh=function(t,e,i,n){return Math.abs(t.x*e+t.y*i+t.z*n)},function(t,e){var i=t.halfExtents.x*Oh(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*Oh(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*Oh(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),n=js.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1}),Ph=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===Bh(t,e.planes[i]))return 0;return 1},Dh=function(){for(var t=new Array(8),e=0,i=0,n=0,r=0;r<t.length;r++)t[r]=new js(0,0,0);var s=function(t,e,i,n){return t.x*e+t.y*i+t.z*n};return function(r,a){for(var o=0,u=!1,h=0;h<a.planes.length;h++){if(-1===(o=Bh(r,a.planes[h])))return 0;1===o&&(u=!0)}if(!u)return 1;for(var c=0;c<a.vertices.length;c++)js.subtract(t[c],a.vertices[c],r.center);i=0,n=0;for(var l=0;l<a.vertices.length;l++)(e=s(t[l],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?i++:e<-r.halfExtents.x&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var _=0;_<a.vertices.length;_++)(e=s(t[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?i++:e<-r.halfExtents.y&&n++;if(i===a.vertices.length||n===a.vertices.length)return 0;i=0,n=0;for(var d=0;d<a.vertices.length;d++)(e=s(t[d],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?i++:e<-r.halfExtents.z&&n++;return i===a.vertices.length||n===a.vertices.length?0:1}}(),Fh=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new js(0,0,0);for(var i=new Array(8),n=new Array(8),r=0;r<8;r++)i[r]=new js(0,0,0),n[r]=new js(0,0,0);return function(e,r){js.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),js.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),js.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),js.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),js.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),js.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)js.cross(t[6+3*s],t[s],t[3]),js.cross(t[7+3*s],t[s],t[4]),js.cross(t[8+3*s],t[s],t[5]);Ah(e.center,e.halfExtents,t[0],t[1],t[2],i),Ah(r.center,r.halfExtents,t[3],t[4],t[5],n);for(var a=0;a<15;++a){var o=Rh(i,t[a]),u=Rh(n,t[a]);if(u[0]>o[1]||o[0]>u[1])return 0}return 1}}(),Lh=function(){for(var t=new Hu,e=new js,i=new js,n=new js,r=new Array(8),s=0;s<8;s++)r[s]=new js;for(var a=new Array(8),o=0;o<8;o++)a[o]=new js;return function(s,o){if(0===js.squaredDistance(o.ellipseCenter0,o.ellipseCenter1))return t.radius=o.radius,t.center.set(o.ellipseCenter0),jh.sphereOBB(t,s);e.x=s.orientation.m00,e.y=s.orientation.m01,e.z=s.orientation.m02,i.x=s.orientation.m03,i.y=s.orientation.m04,i.z=s.orientation.m05,n.x=s.orientation.m06,n.y=s.orientation.m07,n.z=s.orientation.m08,Ah(s.center,s.halfExtents,e,i,n,r);var u=a,h=js.copy(u[0],e),c=js.copy(u[1],i),l=js.copy(u[2],n);js.subtract(u[3],o.center,s.center).normalize();var _=js.subtract(u[4],o.ellipseCenter0,o.ellipseCenter1);_.normalize(),js.cross(u[5],h,_),js.cross(u[6],c,_),js.cross(u[7],l,_);for(var d=0;d<8;++d){var f=Rh(r,u[d]),p=js.dot(u[d],o.ellipseCenter0),m=js.dot(u[d],o.ellipseCenter1),g=Math.max(p,m),v=Math.min(p,m)-o.radius,y=g+o.radius;if(v>f[1]||f[0]>y)return 0}return 1}}(),Uh=function(t,e){var i=js.dot(e.n,t.center),n=t.radius*e.n.length();return i+n<e.d?-1:i-n>e.d?0:1},Gh=function(t,e){for(var i=0;i<e.planes.length;i++)if(-1===Uh(t,e.planes[i]))return 0;return 1},kh=function(){var t=new js(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,n){for(var r=0;r<6;r++){var s=n.planes[r],a=i.radius,o=i.center,u=s.n,h=s.d,c=js.dot(u,o);if(c+a<h)return 0;if(!(c-a>h)){js.add(t,o,js.multiplyScalar(t,u,a));for(var l=0;l<6;l++)if(l!==r&&l!==r+e[r]){var _=n.planes[l];if(js.dot(_.n,t)<_.d)return 0}}}return 1}}(),zh=function(t,e){var i=t.radius+e.radius;return js.squaredDistance(t.center,e.center)<i*i},Hh=function(){var t=new js;return function(e,i){return xu(t,e.center,i),js.squaredDistance(e.center,t)<e.radius*e.radius}}(),Vh=function(){var t=new js;return function(e,i){return Nu(t,e.center,i),js.squaredDistance(e.center,t)<e.radius*e.radius}}(),Wh=function(){var t=new js,e=new js;return function(i,n){var r=i.radius+n.radius,s=r*r,a=js.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===a)return js.squaredDistance(i.center,n.center)<s;js.subtract(t,i.center,n.ellipseCenter0),js.subtract(e,n.ellipseCenter1,n.ellipseCenter0);var o=js.dot(t,e)/a;return o<0?js.squaredDistance(i.center,n.ellipseCenter0)<s:o>1?js.squaredDistance(i.center,n.ellipseCenter1)<s:(js.scaleAndAdd(t,n.ellipseCenter0,e,o),js.squaredDistance(i.center,t)<s)}}(),Xh=function(){var t=new js,e=new js,i=new js,n=new js,r=new js,s=new js;return function(a,o){var u,h,c=js.subtract(t,a.ellipseCenter1,a.ellipseCenter0),l=js.subtract(e,o.ellipseCenter1,o.ellipseCenter0),_=js.subtract(i,a.ellipseCenter0,o.ellipseCenter0),d=js.dot(c,c),f=js.dot(c,l),p=js.dot(l,l),m=js.dot(c,_),g=js.dot(l,_),v=d*p-f*f,y=v,T=v;v<Ts?(u=0,y=1,h=g,T=p):(h=d*g-f*m,(u=f*g-p*m)<0?(u=0,h=g,T=p):u>y&&(u=y,h=g+f,T=p)),h<0?(h=0,-m<0?u=0:-m>d?u=y:(u=-m,y=d)):h>T&&(h=T,-m+f<0?u=0:-m+f>d?u=y:(u=-m+f,y=d));var E=Math.abs(u)<Ts?0:u/y,S=Math.abs(h)<Ts?0:h/T,A=n;A.set(_),A.add(js.multiplyScalar(r,c,E)),A.subtract(js.multiplyScalar(s,l,S));var R=a.radius+o.radius;return A.lengthSqr()<R*R}}(),jh={raySphere:th,rayAABB:eh,rayOBB:oh,rayPlane:Ju,rayTriangle:$u,rayCapsule:uh,raySubMesh:hh,rayMesh:ch,rayModel:lh,lineSphere:gh,lineAABB:ph,lineOBB:mh,linePlane:_h,lineTriangle:dh,sphereWithSphere:zh,sphereAABB:Hh,sphereOBB:Vh,spherePlane:Uh,sphereFrustum:Gh,sphereFrustumAccurate:kh,sphereCapsule:Wh,aabbWithAABB:Sh,aabbWithOBB:Mh,aabbPlane:Ih,aabbFrustum:Ch,aabbFrustumAccurate:xh,obbWithOBB:Fh,obbPlane:Bh,obbFrustum:Ph,obbFrustumAccurate:Dh,obbPoint:Nh,obbCapsule:Lh,aabbFrustumCompletelyInside:function(t,e){for(var i=0;i<e.planes.length;i++)if(0!==Ih(t,e.planes[i]))return 0;return 1},capsuleWithCapsule:Xh,resolve:function(t,e,i){void 0===i&&(i=null);var n=t._type,r=e._type,s=this[n|r];return n<r?s(t,e,i):s(e,t,i)}};jh[Pu.SHAPE_RAY|Pu.SHAPE_SPHERE]=th,jh[Pu.SHAPE_RAY|Pu.SHAPE_AABB]=eh,jh[Pu.SHAPE_RAY|Pu.SHAPE_OBB]=oh,jh[Pu.SHAPE_RAY|Pu.SHAPE_PLANE]=Ju,jh[Pu.SHAPE_RAY|Pu.SHAPE_TRIANGLE]=$u,jh[Pu.SHAPE_RAY|Pu.SHAPE_CAPSULE]=uh,jh[Pu.SHAPE_LINE|Pu.SHAPE_SPHERE]=gh,jh[Pu.SHAPE_LINE|Pu.SHAPE_AABB]=ph,jh[Pu.SHAPE_LINE|Pu.SHAPE_OBB]=mh,jh[Pu.SHAPE_LINE|Pu.SHAPE_PLANE]=_h,jh[Pu.SHAPE_LINE|Pu.SHAPE_TRIANGLE]=dh,jh[Pu.SHAPE_SPHERE]=zh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_AABB]=Hh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_OBB]=Vh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_PLANE]=Uh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_FRUSTUM]=Gh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_FRUSTUM_ACCURATE]=kh,jh[Pu.SHAPE_SPHERE|Pu.SHAPE_CAPSULE]=Wh,jh[Pu.SHAPE_AABB]=Sh,jh[Pu.SHAPE_AABB|Pu.SHAPE_OBB]=Mh,jh[Pu.SHAPE_AABB|Pu.SHAPE_PLANE]=Ih,jh[Pu.SHAPE_AABB|Pu.SHAPE_FRUSTUM]=Ch,jh[Pu.SHAPE_AABB|Pu.SHAPE_FRUSTUM_ACCURATE]=xh,jh[Pu.SHAPE_OBB]=Fh,jh[Pu.SHAPE_OBB|Pu.SHAPE_PLANE]=Bh,jh[Pu.SHAPE_OBB|Pu.SHAPE_FRUSTUM]=Ph,jh[Pu.SHAPE_OBB|Pu.SHAPE_FRUSTUM_ACCURATE]=Dh,jh[Pu.SHAPE_OBB|Pu.SHAPE_CAPSULE]=Lh,jh[Pu.SHAPE_CAPSULE]=Xh;var Yh=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Pu.SHAPE_LINE,this.s=new js(t,e,i),this.e=new js(n,r,s)}return t.create=function(e,i,n,r,s,a){return new t(e,i,n,r,s,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return js.copy(t.s,e.s),js.copy(t.e,e.e),t},t.fromPoints=function(t,e,i){return js.copy(t.s,e),js.copy(t.e,i),t},t.set=function(t,e,i,n,r,s,a){return t.s.x=e,t.s.y=i,t.s.z=n,t.e.x=r,t.e.y=s,t.e.z=a,t},t.len=function(t){return js.distance(t.s,t.e)},t.prototype.length=function(){return js.distance(this.s,this.e)},s(t,[{key:"type",get:function(){return this._type}}]),t}(),Kh=new js(0,0,0),qh=new js(0,0,0),Qh=v.mat4(),Zh=v.v4(),Jh=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Pu.SHAPE_PLANE,this.n=new js(t,e,i),this.d=n}return t.create=function(e,i,n,r){return new t(e,i,n,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return js.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,i,n){return js.subtract(Kh,i,e),js.subtract(qh,n,e),js.normalize(t.n,js.cross(t.n,Kh,qh)),t.d=js.dot(t.n,e),t},t.set=function(t,e,i,n,r){return t.n.x=e,t.n.y=i,t.n.z=n,t.d=r,t},t.fromNormalAndPoint=function(t,e,i){return js.copy(t.n,e),t.d=js.dot(e,i),t},t.normalize=function(t,e){var i=e.n.length();return js.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t},t.prototype.transform=function(t){da.invert(Qh,t),da.transpose(Qh,Qh),ta.set(Zh,this.n.x,this.n.y,this.n.z,this.d),ta.transformMat4(Zh,Zh,Qh),js.set(this.n,Zh.x,Zh.y,Zh.z),this.d=Zh.w},s(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),$h=new js,tc=new js,ec=new js,ic=new js,nc=new ia,rc=function(t,e,i){nc.m00=Math.abs(i.m00),nc.m01=Math.abs(i.m01),nc.m02=Math.abs(i.m02),nc.m03=Math.abs(i.m04),nc.m04=Math.abs(i.m05),nc.m05=Math.abs(i.m06),nc.m06=Math.abs(i.m08),nc.m07=Math.abs(i.m09),nc.m08=Math.abs(i.m10),js.transformMat3(t,e,nc)},sc=function(){function t(t,e,i,n,r,s){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===s&&(s=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Pu.SHAPE_AABB,this.center=new js(t,e,i),this.halfExtents=new js(n,r,s)}t.create=function(e,i,n,r,s,a){return new t(e,i,n,r,s,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return js.copy(t.center,e.center),js.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,i){return js.add($h,i,e),js.subtract(tc,i,e),js.multiplyScalar(t.center,$h,.5),js.multiplyScalar(t.halfExtents,tc,.5),t},t.set=function(t,e,i,n,r,s,a){return t.center.set(e,i,n),t.halfExtents.set(r,s,a),t},t.merge=function(e,i,n){return js.subtract($h,i.center,i.halfExtents),js.subtract(tc,n.center,n.halfExtents),js.add(ec,i.center,i.halfExtents),js.add(ic,n.center,n.halfExtents),js.max(ic,ec,ic),js.min(ec,$h,tc),t.fromPoints(e,ec,ic)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,i){return js.transformMat4(t.center,e.center,i),rc(t.halfExtents,e.halfExtents,i),t};var e=t.prototype;return e.getBoundary=function(t,e){js.subtract(t,this.center,this.halfExtents),js.add(e,this.center,this.halfExtents)},e.transform=function(t,e,i,n,r){js.transformMat4(r.center,this.center,t),rc(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary($h,tc),t.x<$h.x&&($h.x=t.x),t.y<$h.y&&($h.y=t.y),t.z<$h.z&&($h.z=t.z),t.x>tc.x&&(tc.x=t.x),t.y>tc.y&&(tc.y=t.y),t.z>tc.z&&(tc.z=t.z),js.add(ec,$h,tc),this.center.set(js.multiplyScalar(ec,ec,.5)),this.halfExtents.set(tc.x-ec.x,tc.y-ec.y,tc.z-ec.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},s(t,[{key:"type",get:function(){return this._type}}]),t}(),ac=new js,oc=new js,uc=new ia,hc=function(){function t(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=1),void 0===s&&(s=1),void 0===a&&(a=1),void 0===o&&(o=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===c&&(c=1),void 0===l&&(l=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Pu.SHAPE_OBB,this.center=new js(t,e,i),this.halfExtents=new js(n,r,s),this.orientation=new ia(a,o,u,h,c,l,_,d,f)}t.create=function(e,i,n,r,s,a,o,u,h,c,l,_,d,f,p){return new t(e,i,n,r,s,a,o,u,h,c,l,_,d,f,p)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return js.copy(t.center,e.center),js.copy(t.halfExtents,e.halfExtents),ia.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,i){return js.multiplyScalar(t.center,js.add(ac,e,i),.5),js.multiplyScalar(t.halfExtents,js.subtract(oc,i,e),.5),ia.identity(t.orientation),t},t.set=function(t,e,i,n,r,s,a,o,u,h,c,l,_,d,f,p){return js.set(t.center,e,i,n),js.set(t.halfExtents,r,s,a),ia.set(t.orientation,o,u,h,c,l,_,d,f,p),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,i){uc.m00=Math.abs(i.m00),uc.m01=Math.abs(i.m01),uc.m02=Math.abs(i.m02),uc.m03=Math.abs(i.m03),uc.m04=Math.abs(i.m04),uc.m05=Math.abs(i.m05),uc.m06=Math.abs(i.m06),uc.m07=Math.abs(i.m07),uc.m08=Math.abs(i.m08),js.transformMat3(t,e,uc)}(ac,this.halfExtents,this.orientation),js.subtract(t,this.center,ac),js.add(e,this.center,ac)},e.transform=function(t,e,i,n,r){js.transformMat4(r.center,this.center,t),ia.fromQuat(r.orientation,i),js.multiply(r.halfExtents,this.halfExtents,n)},e.translateAndRotate=function(t,e,i){js.transformMat4(i.center,this.center,t),ia.fromQuat(i.orientation,e)},e.setScale=function(t,e){js.multiply(e.halfExtents,this.halfExtents,t)},s(t,[{key:"type",get:function(){return this._type}}]),t}(),cc=function(){function t(t,e,i){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===i&&(i=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Pu.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new js,this.rotation=new sa,this.ellipseCenter0=new js(0,e,0),this.ellipseCenter1=new js(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,i,n,r){var s=n,a=Vs(s);r.radius=this.radius*Math.abs(a);var o=(this.halfHeight+this.radius)*Math.abs(s.y)-r.radius;o<0&&(o=0),r.halfHeight=o,js.transformMat4(r.center,this.center,t),sa.multiply(r.rotation,this.rotation,i),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),js.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),js.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},s(t,[{key:"type",get:function(){return this._type}}]),t}(),lc=new Array(8);lc[0]=new js(1,1,1),lc[1]=new js(-1,1,1),lc[2]=new js(-1,-1,1),lc[3]=new js(1,-1,1),lc[4]=new js(1,1,-1),lc[5]=new js(-1,1,-1),lc[6]=new js(-1,-1,-1),lc[7]=new js(1,-1,-1);var _c,dc,fc,pc=new js,mc=new js,gc=new js,vc=function(){function t(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=Pu.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=Jh.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new js}t.createFromAABB=function(t,e){var i=new js,n=new js;return js.subtract(i,e.center,e.halfExtents),js.add(n,e.center,e.halfExtents),t.vertices[0].set(i.x,n.y,i.z),t.vertices[1].set(n.x,n.y,i.z),t.vertices[2].set(n.x,i.y,i.z),t.vertices[3].set(i.x,i.y,i.z),t.vertices[4].set(i.x,n.y,n.z),t.vertices[5].set(n.x,n.y,n.z),t.vertices[6].set(n.x,i.y,n.z),t.vertices[7].set(i.x,i.y,n.z),t._type!==Pu.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,i,n,r){var s=Math.tan(.5*e.fov),a=s*e.aspect;pc.set(n*a,n*s,n),mc.set(r*a,r*s,r);var o=t.vertices;return gc.set(pc.x,pc.y,pc.z),js.transformMat4(o[0],gc,i),gc.set(-pc.x,pc.y,pc.z),js.transformMat4(o[1],gc,i),gc.set(-pc.x,-pc.y,pc.z),js.transformMat4(o[2],gc,i),gc.set(pc.x,-pc.y,pc.z),js.transformMat4(o[3],gc,i),gc.set(mc.x,mc.y,mc.z),js.transformMat4(o[4],gc,i),gc.set(-mc.x,mc.y,mc.z),js.transformMat4(o[5],gc,i),gc.set(-mc.x,-mc.y,mc.z),js.transformMat4(o[6],gc,i),gc.set(mc.x,-mc.y,mc.z),js.transformMat4(o[7],gc,i),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e.type;for(var i=0;i<6;++i)Jh.copy(t.planes[i],e.planes[i]);for(var n=0;n<8;++n)js.copy(t.vertices[n],e.vertices[n]);return t};var e=t.prototype;return e.update=function(t,e){if(js.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),js.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),js.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),js.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),js.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),js.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Pu.SHAPE_FRUSTUM_ACCURATE){for(var i=0;i<6;i++){var n=this.planes[i],r=1/n.n.length();js.multiplyScalar(n.n,n.n,r),n.d*=r}for(var s=0;s<8;s++)js.transformMat4(this.vertices[s],lc[s],e)}},e.transform=function(t){if(this._type===Pu.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)js.transformMat4(this.vertices[e],this.vertices[e],t);this.updatePlanes()}},e.zero=function(){for(var t=0;t<8;t++)this.vertices[t].set(0,0,0);this.updatePlanes()},e.updatePlanes=function(){Jh.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Jh.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Jh.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Jh.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Jh.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Jh.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},s(t,[{key:"accurate",set:function(t){this._type=t?Pu.SHAPE_FRUSTUM_ACCURATE:Pu.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();function yc(t,e,i){void 0===i&&(i=1e-6);for(var n=0,r=t.length-1,s=r>>>1;n<=r;s=n+r>>>1){var a=t[s];if(a>e+i)r=s-1;else{if(!(a<e-i))return s;n=s+1}}return~n}vc.createOrtho=function(t,e,i,n,r,s){var a=e/2,o=i/2;js.set(gc,a,o,-n),js.transformMat4(t.vertices[0],gc,s),js.set(gc,-a,o,-n),js.transformMat4(t.vertices[1],gc,s),js.set(gc,-a,-o,-n),js.transformMat4(t.vertices[2],gc,s),js.set(gc,a,-o,-n),js.transformMat4(t.vertices[3],gc,s),js.set(gc,a,o,-r),js.transformMat4(t.vertices[4],gc,s),js.set(gc,-a,o,-r),js.transformMat4(t.vertices[5],gc,s),js.set(gc,-a,-o,-r),js.transformMat4(t.vertices[6],gc,s),js.set(gc,a,-o,-r),js.transformMat4(t.vertices[7],gc,s),Jh.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),Jh.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),Jh.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),Jh.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),Jh.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),Jh.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(_c||(_c={})),function(t){t[t.Default=_c.Default]="Default",t[t.Normal=_c.Normal]="Normal",t[t.Reverse=_c.Reverse]="Reverse",t[t.Loop=_c.Loop]="Loop",t[t.LoopReverse=_c.Loop|_c.Reverse]="LoopReverse",t[t.PingPong=_c.PingPong]="PingPong",t[t.PingPongReverse=_c.PingPong|_c.Reverse]="PingPongReverse"}(dc||(dc={})),kn(dc),fc=Symbol.iterator;var Tc,Ec,Sc,Ac=function(){function t(){this._times=[],this._values=[]}var e=t.prototype;return e[fc]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var i=[t._times[e],t._values[e]];return++e,{done:!1,value:i}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return yc(this._times,t)},e.updateTime=function(t,e){var i=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,i)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return yc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,i){return 0===e||t>i[e-1]||Ss(t,i[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var i=this._times,n=this._values,r=i.length,s=yc(i,t);if(s>=0)return s;var a=~s;return 0===a?(i.unshift(t),n.unshift(e)):a===r?(i.push(t),n.push(e)):(i.splice(a-1,0,t),n.splice(a-1,0,e)),a},s(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}();function Rc(t){return t>-1e-9&&t<1e-9}Dr.fastDefine("cc.KeyframeCurve",Ac,{_times:[],_values:[]}),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Tc||(Tc=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(Ec||(Ec=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(Sc||(Sc=t("TangentWeightMode",{})));var wc,bc,Oc,Mc=function(){},Ic=Object.freeze({__proto__:null,uniquelyReferenced:To,ccclass:ao,property:co,requireComponent:oo,executionOrder:uo,disallowMultiple:ho,allowReplicated:function(t){Dr.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:Eo,menu:So,playOnFocus:Ao,inspector:Ro,icon:wo,help:bo,type:xo,integer:Oo,float:Mo,boolean:Io,string:Co});t("_decorator",Ic);var Cc=t("Script",ao("cc.Script")(wc=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(Tu))||wc);v._Script=Cc;var xc=t("JavaScript",ao("cc.JavaScript")(bc=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(Cc))||bc);v._JavaScript=xc;var Nc,Bc,Pc,Dc,Fc,Lc,Uc,Gc=t("TypeScript",ao("cc.TypeScript")(Oc=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(Cc))||Oc);v._TypeScript=Gc;var kc,zc,Hc,Vc,Wc,Xc,jc,Yc,Kc,qc,Qc,Zc,Jc=t("EventHandler",ao("cc.ClickEvent")((Bc=function(){function t(){this.target=Pc&&Pc(),this.component=Dc&&Dc(),this._componentId=Fc&&Fc(),this.handler=Lc&&Lc(),this.customEventData=Uc&&Uc()}t.emitEvents=function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(var s=0,a=e.length;s<a;s++){var o=e[s];o instanceof t&&o.emit(n)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(v.isValid(e)){this._genCompIdIfNeeded();var i=v.js.getClassById(this._componentId),n=e.getComponent(i);if(v.isValid(n)){var r=n[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(n,t))}}},e._compName2Id=function(t){var e=v.js.getClassByName(t);return v.js.getClassId(e)},e._compId2Name=function(t){var e=v.js.getClassById(t);return v.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},s(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),Pc=Za(Bc.prototype,"target",[mo],(function(){return null})),Dc=Za(Bc.prototype,"component",[mo],(function(){return""})),Fc=Za(Bc.prototype,"_componentId",[mo],(function(){return""})),Lc=Za(Bc.prototype,"handler",[mo],(function(){return""})),Uc=Za(Bc.prototype,"customEventData",[mo],(function(){return""})),Nc=Bc))||Nc),$c=new Xi("Comp"),tl=Vr.Flags.IsOnLoadCalled,el=t("Component",(kc=ao("cc.Component"),zc=xo(Cc),kc((Kc=Yc=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).node=Wc&&Wc(),e._enabled=Xc&&Xc(),e.__prefab=jc&&jc(),e._sceneGetter=null,e._id=$c.getNewId(),e}o(e,t);var i=e.prototype;return i._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},i.addComponent=function(t){return this.node.addComponent(t)},i.getComponent=function(t){return this.node.getComponent(t)},i.getComponents=function(t){return this.node.getComponents(t)},i.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},i.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},i.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&v.director._compScheduler.disableComp(this),!0)},i._onPreDestroy=function(){this.unscheduleAllCallbacks(),v.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},i._instantiate=function(t){return t||(t=v.instantiate._clone(this,this)),t&&(t.node=null),t},i.schedule=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=v.macro.REPEAT_FOREVER),void 0===n&&(n=0),W(t,1619),W((e=e||0)>=0,1620),i=Number.isNaN(i)?v.macro.REPEAT_FOREVER:i,n=n||0;var r=v.director.getScheduler(),s=r.isTargetPaused(this);r.schedule(t,this,e,i,n,s)},i.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},i.unschedule=function(t){t&&v.director.getScheduler().unschedule(t,this)},i.unscheduleAllCallbacks=function(){v.director.getScheduler().unscheduleAllForTarget(this)},s(e,[{key:"name",get:function(){if(this._name)return this._name;var t=sn(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=v.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&tl}}]),e}(Vr),Yc.EventHandler=Jc,Yc.system=null,m((Vc=Kc).prototype,"__scriptAsset",[zc],Object.getOwnPropertyDescriptor(Vc.prototype,"__scriptAsset"),Vc.prototype),Wc=Za(Vc.prototype,"node",[mo],(function(){return null})),Xc=Za(Vc.prototype,"_enabled",[mo],(function(){return!0})),jc=Za(Vc.prototype,"__prefab",[mo],(function(){return null})),Hc=Vc))||Hc)),il=el.prototype;il.update=null,il.lateUpdate=null,il.__preload=null,il.onLoad=null,il.start=null,il.onEnable=null,il.onDisable=null,il.onDestroy=null,il.onFocusInEditor=null,il.onLostFocusInEditor=null,il.resetInEditor=null,il._getLocalBounds=null,il.onRestore=null,el._requireComponent=null,el._executionOrder=0,$i(el,"_registerEditorProps",(function(t,e){var i=e.requireComponent;i&&(Array.isArray(i)&&(i=i.filter(Boolean)),t._requireComponent=i);var n=e.executionOrder;n&&"number"==typeof n&&(t._executionOrder=n)})),v.Component=el;var nl=t("MissingScript",ao("cc.MissingScript")((Qc=function(t){function e(){var e;return(e=t.call(this)||this)._$erialized=Zc&&Zc(),e}return o(e,t),e.safeFindClass=function(t){var e=In(t);if(e)return e;v.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){G(4600,this.node.name)},e}(el),Zc=Za(Qc.prototype,"_$erialized",[mo,vo],(function(){return null})),qc=Qc))||qc);v._MissingScript=nl;try{var rl=nl.__values__;0!==rl.length&&"_$erialized"===rl[rl.length-1]||(C("The '_$erialized' prop in MissingScript is missing. Please contact jare."),C("    Error props: ['"+rl+"']"))}catch(Iu){C("Error when checking MissingScript 5, "+Iu)}var sl=t("serializeTag",Symbol("[[Serialize]]")),al=t("deserializeTag",Symbol("[[Deserialize]]")),ol=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return s(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function ul(t){var e=t;return{chunks:e.chunks,document:e.document}}function hl(t){if(t.length<16)throw new cl(X(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new cl(X(13100));var i=e.getUint32(4,!0);if(1!==i)throw new cl(X(13101,i));if(e.getUint32(8,!0)!==e.byteLength)throw new cl(X(13102));var n=12,r=e.getUint32(n,!0);n+=4;var s=new Uint8Array(e.buffer,n+e.byteOffset,r);n+=r;var a,o=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(X(13104))}(s);try{a=JSON.parse(o)}catch(t){throw new cl(t)}for(var u=[];n<e.byteLength;){n%8!=0&&(n+=8-n%8);var h=e.getUint32(n,!0);n+=4,u.push(new Uint8Array(e.buffer,n+e.byteOffset,h)),n+=h}if(n!==e.byteLength)throw new cl(X(13102));return new ol(a,u)}var cl=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(_(Error));function ll(t,e,i,n,r){if(e instanceof v.ValueType){r||t.push("if(prop){");var s=sn(e);t.push("s._deserializeFastDefinedObject(o"+i+",prop,"+s+");"),r||t.push("}else o"+i+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+n+");\n} else {\n    o"+i+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var i=t-e;return this._viewOrPaddings.push(i),this._length+=i,i}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(i){"number"==typeof i?e+=i:(t.set(new Uint8Array(i.buffer,i.byteOffset,i.byteLength),e),e+=i.byteLength)})),t},s(t,[{key:"byteLength",get:function(){return this._length}}])}(),v.internal.parseCCONJson=ul,v.internal.decodeCCONBinary=hl,v.internal.CCON=ol;var _l="$_$default",dl="$_$formerlySerializedAs",fl=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return o(e,t),e.prototype.get=function(t,e,i,n,r){var s=this._get();return s?(s.reset(t,e,i,n,r),s):new pl(t,e,i,n,r)},e}(Bn),pl=function(){function t(t,e,i,n){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,i,n){this.result=t,this.customEnv=n,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,i=!1;t instanceof ol?(i=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:i};var n=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,i,n){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,i,n):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,i=t.length,n=t.ctor;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,i)},e._deserializeArray=function(t){for(var e,i=new Array(t.length),n=0;n<t.length;n++)"object"==typeof(e=t[n])&&e?this._deserializeAndAssignField(i,e,""+n)&&(i[n]=null):i[n]=e;return i},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,i,n){var r=this,s=t.__type__,a=this._classFinder(s,t,i,n);if(!a)return this._classFinder===In&&this._reportMissingClass(s),null;var o=function(t){var i=new t;return e>=0&&(r.deserializedList[e]=i),i}(a);return this._deserializeInto(t,o,a),o},e._deserializeInto=function(t,e,i,n){void 0===n&&(n=!1),n||!e[al]?e._deserialize?e._deserialize(t.content,this):v.Class._isCCClass(i)?this._deserializeFireClass(e,t,i):this._deserializeFastDefinedObject(e,t,i):this._runCustomizedDeserialize(t,e,i)},e._runCustomizedDeserialize=function(t,e,i){var n=this,r={readProperty:function(e){var i=t[e];return"object"==typeof i&&i?n._deserializeObjectField(i):i},readThis:function(){n._deserializeInto(t,e,i,!0)},readSuper:function(){var r=gn(i);r&&n._deserializeInto(t,e,r)}};e[al](r,this._context)},e._deserializeFireClass=function(t,e,i){var n;if(i.hasOwnProperty("__deserialize__"))n=i.__deserialize__;else{n=function(t,e){for(var i=cr(e),n=e.__values__,r=["var prop;"],s=jn.test(Nn(e)),a=0;a<n.length;a++){var o=n[a],u=void 0,h=void 0;Dr.IDENTIFIER_RE.test(o)?(h='"'+o+'"',u="."+o):u="["+(h=Dr.escapeForJS(o))+"]";var c=u;if(i[o+dl]){var l=i[o+dl];c=Dr.IDENTIFIER_RE.test(l)?"."+l:"["+Dr.escapeForJS(l)+"]"}r.push("prop=d"+c+";"),r.push('if(typeof prop!=="undefined"){');var _=Dr.getDefault(i[o+_l]),d=i[o+"$_$type"];if(s&&(void 0!==_||d)){var f=void 0;if(void 0===_)f=d instanceof _r||d===Ir||d===Cr;else{var p=typeof _;f="string"===p||"number"===p||"boolean"===p}f?r.push("o"+u+"=prop;"):ll(r,_,u,h,!0)}else r.push('if(typeof prop!=="object"){o'+u+"=prop;}else{"),ll(r,_,u,h,!1),r.push("}");r.push("}")}return(v.js.isChildClassOf(e,v._BaseNode)||v.js.isChildClassOf(e,v.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===n[n.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,i);try{if(i===nl){var r=i.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(C("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),C("    Error props: ['"+r+"']. Please contact jare."));var s=n;n=function(t,e,i,n){s(t,e,i,n),e._$erialized||C("Unable to stash previously serialized data. "+JSON.stringify(i))}}}catch(t){C("Error when checking MissingScript 6, "+t)}$i(i,"__deserialize__",n,!0)}n(this,t,e,i)},e._deserializeAndAssignField=function(t,e,i){var n=e.__id__;if("number"==typeof n){var r=this.deserializedList[n];if(r)t[i]=r;else{var s,a=this._serializedData[n];t[i]=this._deserializeObject(a,n,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,n,t,i)}}else{var o=e.__uuid__;if(o){var u=e.__expectedType__;this.result.push(t,i,o,u)}else t[i]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var i=this.deserializedList[e];if(i)return i;var n=this._serializedData[e];return this._deserializeObject(n,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];"object"!=typeof n?"__type__"!==i&&(t[i]=n):n?this._deserializeAndAssignField(t,n,i)&&(t[i]=null):t[i]=null}},e._deserializeFastDefinedObject=function(t,e,i){if(i===v.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(i===v.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(i!==v.Color){if(i===v.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var n=cr(i),r=i.__values__,s=0;s<r.length;s++){var a=r[s],o=e[a];void 0!==o||e.hasOwnProperty(a)||(o=Dr.getDefault(n[a+_l])),"object"!=typeof o?t[a]=o:o?this._deserializeAndAssignField(t,o,a):t[a]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var u=e.a;t.a=void 0===u?255:u}},t}();pl.pool=new fl;var ml=[Qs,js,ta,sa,Aa,va,Ta,da];function gl(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var vl=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},gl,gl,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){da.fromArray(t,e,1)}],yl=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,i,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(n||"")},t}());function Tl(t,e){for(var i=t[4][e[0]],n=i[0],r=new(0,n[0]),s=n[1],a=n[2],o=i[i.length-1],u=1;u<o;++u)r[s[i[u]]]=e[u];for(;u<e.length;++u){var h=s[i[u]],c=n[i[u]+a];(0,bl[c])(t,r,h,e[u])}return r}function El(t,e,i){var n=new e;return n._deserialize?n._deserialize(i,t[0]):z(5303,sn(e)),n}function Sl(t,e,i,n){n>=0?e[i]=t[5][n]:t[7][3*~n]=e}function Al(t){return function(e,i,n,r){i[n]=r;for(var s=0;s<r.length;++s)t(e,r,s,r[s])}}function Rl(t,e,i,n){e[i]=null,t[8][n]=e}function wl(t,e,i,n){e[i]=Tl(t,n)}yl.pool=new Bn((function(t){t.reset()}),5),yl.pool.get=function(){return this._get()||new yl};var bl=new Array(13);function Ol(t,e,i){return t||i(e),Object}function Ml(t,e,i,n,r,s,a){var o=t(e);if(!o){if(r)return void(i[n]=function(e,i,n){return function(){var r=t(n)||Ol(s,n,a);return e[i]=r,new r}}(i,n,e));o=Ol(s,e,a)}i[n]=o}function Il(t,e,i,n){for(var r=i||In,s=t[3],a=0;a<s.length;++a){var o=s[a];"string"!=typeof o?Ml(r,o[0],o,0,e,i,n):Ml(r,o,s,a,e,i,n)}}function Cl(t){var e=t[4];if(e)for(var i=t[3],n=0;n<e.length;++n){var r=e[n];r[0]=i[r[0]]}}function xl(t,e,i){"string"==typeof t&&(t=JSON.parse(t));var n,r=!e;if(e=e||yl.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Nl}return!1}(t)){e.init(t),i=i||{};var s,a=t[0],o=!1;if("object"==typeof a&&(o=a.preprocessed,a=a.version),a<1)throw new Error(X(5304,a));i._version=a,i.result=e,t[0]=i,o||(Il(t,!1,i.classFinder,null!==(s=i.reportMissingClass)&&void 0!==s?s:xl.reportMissingClass),Cl(t)),v.game._isCloning=!0;var u=t[5],h=function(t){var e=t[5],i=t[6],n=0===i?0:i.length,r=e[e.length-1],s=e.length-n;"number"!=typeof r?r=0:(r<0&&(r=~r),--s);for(var a=0;a<s;++a)e[a]=Tl(t,e[a]);for(var o=t[3],u=0;u<n;++u,++a){var h=i[u],c=e[a];if(h>=0){var l=o[h];e[a]=El(t,l,c)}else(0,bl[h=~h])(t,e,a,c)}return r}(t);v.game._isCloning=!1,t[7]&&function(t,e,i){for(var n=t.length-1,r=0,s=3*t[n];r<s;r+=3){var a=t[r],o=e[t[r+2]],u=t[r+1];u>=0?a[i[u]]=o:a[~u]=o}for(;r<n;r+=3){var h=e[t[r]],c=e[t[r+2]],l=t[r+1];l>=0?h[i[l]]=c:h[~l]=c}}(t[7],u,t[2]),function(t){for(var e=t[5],i=t[2],n=t[1],r=t[8],s=t[9],a=t[10],o=0;o<r.length;++o){var u=r[o];"number"==typeof u&&(r[o]=e[u]);var h=s[o];"number"==typeof h&&(h=h>=0?i[h]:~h,s[o]=h);var c=a[o];"number"==typeof c&&(a[o]=n[c])}}(t),n=u[h]}else n=function(t,e,i){var n,r=(i=i||{}).classFinder||In,s=i.createAssetRefs||za.platform===as.EDITOR_CORE,a=i.customEnv,o=i.ignoreEditorOnly,u=null!==(n=i.reportMissingClass)&&void 0!==n?n:v.deserialize.reportMissingClass;e.init();var h=pl.pool.get(e,r,u,a,o);v.game._isCloning=!0;var c=h.deserialize(t);return v.game._isCloning=!1,pl.pool.put(h),s&&e.assignAssetsBy((function(t,e){return EditorExtends.serialize.asAsset(t,e.type)})),c}(t,e,i);return r&&yl.pool.put(e),n}bl[0]=function(t,e,i,n){e[i]=n},bl[1]=Sl,bl[2]=Al(Sl),bl[3]=Al(Rl),bl[4]=wl,bl[5]=function(t,e,i,n){vl[n[0]](e[i],n)},bl[6]=Rl,bl[7]=function(t,e,i,n){e[i].set(n)},bl[8]=function(t,e,i,n){var r=new ml[n[0]];vl[n[0]](r,n),e[i]=r},bl[9]=Al(wl),bl[10]=function(t,e,i,n){var r=t[3][n[0]];e[i]=El(t,r,n[1])},bl[11]=function(t,e,i,n){var r=n[0];e[i]=r;for(var s=1;s<n.length;s+=3){var a=n[s],o=n[s+1],u=n[s+2];(0,bl[o])(t,r,a,u)}},bl[12]=function(t,e,i,n){var r=n[0];e[i]=r;for(var s=0;s<r.length;++s){var a=r[s],o=n[s+1];0!==o&&(0,bl[o])(t,r,s,a)}},xl.Details=yl,xl.reportMissingClass=function(t){z(5302,t)};var Nl=function(t){this.preprocessed=!0,this.version=t};function Bl(t,e,i){return[1,0,0,[t],0,i?[e,-1]:[e],[0],0,[],[],[]]}v.deserialize=xl;var Pl,Dl,Fl,Ll,Ul,Gl,kl,zl,Hl,Vl,Wl,Xl=Vr.Flags.Destroyed,jl=Vr.Flags.PersistentMask,Yl=[];function Kl(t){var e;if(Xr(t)){if(t._instantiate)return v.game._isCloning=!0,e=t._instantiate(null,!0),v.game._isCloning=!1,e;if(t instanceof v.Asset)throw new TypeError(X(6903))}return v.game._isCloning=!0,e=ql(t),v.game._isCloning=!1,e}function ql(t,e){var i;Ql(t,i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var n=0,r=Yl.length;n<r;++n)Yl[n]._iN$t=null;return Yl.length=0,i}function Ql(t,e,i){Dn.value(t,"_iN$t",e,!0),Yl.push(t);var n=t.constructor;if(Fr(n))!function(t,e,i,n){for(var r=t.__values__,s=0;s<r.length;s++){var a=r[s],o=e[a];if("object"==typeof o&&o){var u=i[a];u instanceof Hn&&u.constructor===o.constructor?u.set(o):i[a]=o._iN$t||Zl(o,n)}else i[a]=o}}(n,t,e,i);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var s=t[r];if("object"==typeof s&&s){if(s===e)continue;e[r]=s._iN$t||Zl(s,i)}else e[r]=s}Xr(t)&&(e._objFlags&=jl)}function Zl(t,e){if(t instanceof Hn)return t.clone();if(t instanceof v.Asset)return t;var i;if(ArrayBuffer.isView(t)){var n=t.length;i=new t.constructor(n),t._iN$t=i,Yl.push(t);for(var r=0;r<n;++r)i[r]=t[r];return i}if(Array.isArray(t)){var s=t.length;i=new Array(s),t._iN$t=i,Yl.push(t);for(var a=0;a<s;++a){var o=t[a];i[a]="object"==typeof o&&o?o._iN$t||Zl(o,e):o}return i}if(t._objFlags&Xl)return null;var u=t.constructor;if(Fr(u)){if(e)if(e instanceof v.Component){if(t instanceof v._BaseNode||t instanceof v.Component)return t}else if(e instanceof v._BaseNode)if(t instanceof v._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof v.Component&&t.node&&!t.node.isChildOf(e))return t;i=new u}else if(u===Object)i={};else{if(u)return t;i=Object.create(null)}return Ql(t,i,e),i}function Jl(t,e){return(e<<3)+t}function $l(t){return e_[t]}function t_(t){switch(t){case Vl.Uint8:return Uint8Array;case Vl.Uint16:return Uint16Array;case Vl.Uint32:return Uint32Array;case Vl.Int8:return Int8Array;case Vl.Int16:return Int16Array;case Vl.Int32:return Int32Array;case Vl.Float32:return Float32Array;case Vl.Float64:return Float64Array}}Kl._clone=ql,v.instantiate=Kl,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(Vl||(Vl={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(Wl||(Wl={})),t("CompactValueTypeArray",ao("cc.CompactValueTypeArray")((zl=kl=function(){function t(){this._byteOffset=Fl&&Fl(),this._unitCount=Ll&&Ll(),this._unitElement=Ul&&Ul(),this._length=Gl&&Gl()}return t.lengthFor=function(t,e,i){return $l(e).requiredUnits*t.length*t_(i).BYTES_PER_ELEMENT},t.compress=function(e,i,n,r,s,a){for(var o=$l(i),u=t_(n),h=o.requiredUnits*e.length,c=new u(r,s,h),l=0;l<e.length;++l)o.compress(c,l,e[l]);var _=new t;return _._unitElement=Jl(n,i),_._byteOffset=a,_._unitCount=h,_._length=e.length,_},t.prototype.decompress=function(t){for(var e,i={storageUnit:7&(e=this._unitElement),elementType:e>>3},n=i.storageUnit,r=$l(i.elementType),s=new(t_(n))(t,this._byteOffset,this._unitCount),a=new Array(this._length),o=0;o<this._length;++o)a[o]=r.decompress(s,o);return a},t}(),kl.StorageUnit=Vl,kl.ElementType=Wl,Fl=Za((Dl=zl).prototype,"_byteOffset",[mo],(function(){return 0})),Ll=Za(Dl.prototype,"_unitCount",[mo],(function(){return 0})),Ul=Za(Dl.prototype,"_unitElement",[mo],(function(){return Jl(Vl.Uint8,Wl.Scalar)})),Gl=Za(Dl.prototype,"_length",[mo],(function(){return 0})),Pl=Dl))||Pl);var e_=((Hl={})[Wl.Scalar]={requiredUnits:1,compress:function(t,e,i){t[e]=i},decompress:function(t,e){return t[e]}},Hl[Wl.Vec2]={requiredUnits:2,compress:function(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:function(t,e){return new js(t[2*e],t[2*e+1])}},Hl[Wl.Vec3]={requiredUnits:3,compress:function(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:function(t,e){return new js(t[3*e],t[3*e+1],t[3*e+2])}},Hl[Wl.Vec4]={requiredUnits:4,compress:function(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:function(t,e){return new ta(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Hl[Wl.Quat]={requiredUnits:4,compress:function(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:function(t,e){return new sa(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Hl[Wl.Mat4]={requiredUnits:16,compress:function(t,e,i){da.toArray(t,i,16*e)},decompress:function(t,e){return da.fromArray(new da,t,16*e)}},Hl);function i_(t){return t*t}function n_(t){return t*(2-t)}function r_(t){return t*t*t}function s_(t){return--t*t*t+1}function a_(t){return t*t*t*t}function o_(t){return 1- --t*t*t*t}function u_(t){return t*t*t*t*t}function h_(t){return--t*t*t*t*t+1}function c_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function l_(t){return Math.sin(t*Math.PI/2)}function __(t){return 0===t?0:Math.pow(1024,t-1)}function d_(t){return 1===t?1:1-Math.pow(2,-10*t)}function f_(t){return 1-Math.sqrt(1-t*t)}function p_(t){return Math.sqrt(1- --t*t)}function m_(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function g_(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function v_(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function y_(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function T_(t){return 1-E_(1-t)}function E_(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}v._decorator=Ic;var S_,A_,R_=P_(i_,n_),w_=P_(r_,s_),b_=P_(a_,o_),O_=P_(u_,h_),M_=P_(c_,l_),I_=P_(__,d_),C_=P_(f_,p_),x_=P_(m_,g_),N_=P_(v_,y_),B_=P_(T_,E_);function P_(t,e){return function(i){return i<.5?e(2*i)/2:t(2*i-1)/2+.5}}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(A_||(A_={}));var D_,F_=((S_={})[A_.CONSTANT]=function(){return 0},S_[A_.LINEAR]=function(t){return t},S_[A_.QUAD_IN]=i_,S_[A_.QUAD_OUT]=n_,S_[A_.QUAD_IN_OUT]=function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},S_[A_.QUAD_OUT_IN]=R_,S_[A_.CUBIC_IN]=r_,S_[A_.CUBIC_OUT]=s_,S_[A_.CUBIC_IN_OUT]=function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},S_[A_.CUBIC_OUT_IN]=w_,S_[A_.QUART_IN]=a_,S_[A_.QUART_OUT]=o_,S_[A_.QUART_IN_OUT]=function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},S_[A_.QUART_OUT_IN]=b_,S_[A_.QUINT_IN]=u_,S_[A_.QUINT_OUT]=h_,S_[A_.QUINT_IN_OUT]=function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},S_[A_.QUINT_OUT_IN]=O_,S_[A_.SINE_IN]=c_,S_[A_.SINE_OUT]=l_,S_[A_.SINE_IN_OUT]=function(t){return.5*(1-Math.cos(Math.PI*t))},S_[A_.SINE_OUT_IN]=M_,S_[A_.EXPO_IN]=__,S_[A_.EXPO_OUT]=d_,S_[A_.EXPO_IN_OUT]=function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},S_[A_.EXPO_OUT_IN]=I_,S_[A_.CIRC_IN]=f_,S_[A_.CIRC_OUT]=p_,S_[A_.CIRC_IN_OUT]=function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},S_[A_.CIRC_OUT_IN]=C_,S_[A_.ELASTIC_IN]=m_,S_[A_.ELASTIC_OUT]=g_,S_[A_.ELASTIC_IN_OUT]=function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)},S_[A_.ELASTIC_OUT_IN]=x_,S_[A_.BACK_IN]=v_,S_[A_.BACK_OUT]=y_,S_[A_.BACK_IN_OUT]=function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},S_[A_.BACK_OUT_IN]=N_,S_[A_.BOUNCE_IN]=T_,S_[A_.BOUNCE_OUT]=E_,S_[A_.BOUNCE_IN_OUT]=function(t){return t<.5?.5*T_(2*t):.5*E_(2*t-1)+.5},S_[A_.BOUNCE_OUT_IN]=B_,S_[A_.SMOOTH]=function(t){return t<=0?0:t>=1?1:t*t*(3-2*t)},S_[A_.FADE]=function(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)},S_);function L_(t){return F_[t]}ds(255),ds(65280);var U_,G_,k_,z_=Tc.LINEAR<<0|Sc.NONE<<8|A_.LINEAR<<16,H_=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e._flags=z_,e}return o(e,t),s(e,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(t){this._flags&=-256,this._flags|=t<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(t){this._flags&=-65281,this._flags|=t<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(t){this._flags&=-16711681,this._flags|=t<<16}}]),e}(Mc);function V_(t){var e=new H_;if("number"==typeof t)e.value=t;else{var i=t.interpolationMode,n=t.tangentWeightMode,r=t.value,s=t.rightTangent,a=t.rightTangentWeight,o=t.leftTangent,u=t.leftTangentWeight,h=t.easingMethod,c=t[kr];e.value=null!=r?r:e.value,e.rightTangent=null!=s?s:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=o?o:e.leftTangent,e.leftTangentWeight=null!=u?u:e.leftTangentWeight,e.interpolationMode=null!=i?i:e.interpolationMode,e.tangentWeightMode=null!=n?n:e.tangentWeightMode,e.easingMethod=null!=h?h:e.easingMethod,c&&(e[kr]=c)}return e}Dr.fastDefine("cc.RealKeyframeValue",H_,((D_={interpolationMode:Tc.LINEAR,tangentWeightMode:Sc.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:A_.LINEAR})[kr]=void 0,D_)),Dr.Attr.setClassAttr(H_,kr,"editorOnly",!0),(U_=H_,null!==(k_=(G_=U_)[po])&&void 0!==k_?k_:G_[po]={}).uniquelyReferenced=!0;var W_,X_=t("RealCurve",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).preExtrapolation=Ec.CLAMP,e.postExtrapolation=Ec.CLAMP,e}o(e,t);var i=e.prototype;return i.evaluate=function(t){var e=this._times,i=this._values,n=e.length;if(0===n)return 0;var r=e[0],s=e[n-1];if(t<r){var a=this.preExtrapolation,o=i[0];if(a===Ec.CLAMP||n<2)return o.value;switch(a){case Ec.LINEAR:return od(r,i[0].value,e[1],i[1].value,t);case Ec.LOOP:t=sd(t,r,s);break;case Ec.PING_PONG:t=ad(t,r,s);break;default:return o.value}}else if(t>s){var u=this.postExtrapolation,h=i[n-1];if(u===Ec.CLAMP||n<2)return h.value;switch(u){case Ec.LINEAR:return od(s,h.value,e[n-2],i[n-2].value,t);case Ec.LOOP:t=sd(t,r,s);break;case Ec.PING_PONG:t=ad(t,r,s);break;default:return h.value}}var c=yc(e,t);if(c>=0)return i[c].value;var l=~c,_=l-1,d=e[_],f=i[_],p=e[l];return function(t,e,i,n,r){var s=i-t;switch(e.interpolationMode){default:case Tc.CONSTANT:return e.value;case Tc.LINEAR:var a=e.easingMethod===A_.LINEAR?r:L_(e.easingMethod)(r);return ws(e.value,n.value,a);case Tc.CUBIC:var o=1/3,u=e.rightTangent,h=e.rightTangentWeight,c=0!=(e.tangentWeightMode&Sc.RIGHT),l=n.leftTangent,_=n.leftTangentWeight,d=0!=(n.tangentWeightMode&Sc.LEFT);if(c||d){var f=0;if(c)f=h;else{var p=s,m=s*u;f=Math.sqrt(p*p+m*m)*o}var g=Math.atan(u),v=Math.cos(g)*f+t,y=Math.sin(g)*f+e.value,T=0;if(d)T=_;else{var E=s,S=s*l;T=Math.sqrt(E*E+S*S)*o}var A=Math.atan(l),R=(v-t)/s,w=(-Math.cos(A)*T+i-t)/s,b=y,O=-Math.sin(A)*T+n.value,M=[0,0,0],I=function(t,e,i,n,r){var s=i/n,a=e/n,o=s*s,u=1/3*(-1/3*o+a),h=.5*(2/27*s*o-1/3*s*a+t/n),c=u*u*u,l=h*h+c,_=0;if(Rc(l)){if(Rc(h))return r[0]=0,1;var d=Math.cbrt(-h);return r[0]=2*d,r[1]=-d,2}if(l<0){var f=1/3*Math.acos(-h/Math.sqrt(-c)),p=2*Math.sqrt(-u);r[0]=p*Math.cos(f),r[1]=-p*Math.cos(f+Math.PI/3),r[2]=-p*Math.cos(f-Math.PI/3),_=3}else{var m=Math.sqrt(l),g=Math.cbrt(m-h),v=-Math.cbrt(m+h);r[0]=g+v,_=1}for(var y=1/3*s,T=0;T<_;++T)r[T]-=y;return _}(0-r,3*R,3*w-6*R,3*(R-w)+1,M),C=function(t,e,i){var n=i;if(1===e)n=t[0];else{n=-1/0;for(var r=0;r<e;++r){var s=t[r];s>=0&&s<=1&&s>n&&(n=s)}n===-1/0&&(n=0)}return n}(M,I,r);return ud(e.value,b,O,n.value,C)}var x=e.value+o*u*s,N=n.value-o*l*s;return ud(e.value,x,N,n.value,r)}}(d,f,p,i[l],(t-d)/(p-d))},i.addKeyFrame=function(e,i){return t.prototype.addKeyFrame.call(this,e,V_(i))},i.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return V_(t)})));else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return V_(t[1])})))}},i.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(i){return Ss(i.value,e,t)}))},i[sl]=function(t,e){if(e.toCCON){var i=this._times,n=this._values,r=i.length,s=new DataView(new ArrayBuffer(0+j_+j_+Y_+K_*r+id*r)),a=0;s.setUint8(a,this.preExtrapolation),a+=j_,s.setUint8(a,this.postExtrapolation),a+=j_,s.setUint32(a,r,!0),a+=Y_,i.forEach((function(t,e){return s.setFloat32(a+K_*e,t,!0)})),a+=K_*r;for(var o,u=p(n);!(o=u()).done;){var h=o.value;a=nd(s,h,a)}var c=new Uint8Array(s.buffer,0,a);t.writeProperty("bytes",c);var l=n.map((function(t){return t[kr]}));l.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",l)}else t.writeThis()},i[al]=function(t,e){if(e.fromCCON){var i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0;this.preExtrapolation=n.getUint8(r),r+=j_,this.postExtrapolation=n.getUint8(r),r+=j_;var s=n.getUint32(r,!0);r+=Y_;var a=Array.from({length:s},(function(t,e){return n.getFloat32(r+K_*e,!0)}));r+=K_*s;for(var o=new Array(s),u=0;u<s;++u){var h=V_({});r=rd(n,h,r),o[u]=h}i.byteLength;var c=t.readProperty("keyframeValueEditorExtras");c&&(c.length,c.forEach((function(t,e){return o[e][kr]=t}))),this._times=a,this._values=o}else t.readThis()},e}(Ac));Dr.fastDefine("cc.RealCurve",X_,{_times:[],_values:[],preExtrapolation:Ec.CLAMP,postExtrapolation:Ec.CLAMP}),function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(W_||(W_={}));var j_=1,Y_=4,K_=4,q_=V_({}),Q_=q_.interpolationMode,Z_=q_.tangentWeightMode,J_=q_.leftTangent,$_=q_.leftTangentWeight,td=q_.rightTangent,ed=q_.rightTangentWeight,id=26;function nd(t,e,i){var n=0,r=i,s=r;r+=4;var a=e.value,o=e.interpolationMode,u=e.tangentWeightMode,h=e.rightTangent,c=e.rightTangentWeight,l=e.leftTangent,_=e.leftTangentWeight,d=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,o!==Q_&&(n|=W_.INTERPOLATION_MODE,t.setUint8(r,o),r+=1),u!==Z_&&(n|=W_.TANGENT_WEIGHT_MODE,t.setUint8(r,u),r+=1),l!==J_&&(n|=W_.LEFT_TANGENT,t.setFloat32(r,l,!0),r+=4),_!==$_&&(n|=W_.LEFT_TANGENT_WEIGHT,t.setFloat32(r,_,!0),r+=4),h!==td&&(n|=W_.RIGHT_TANGENT,t.setFloat32(r,h,!0),r+=4),c!==ed&&(n|=W_.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,c,!0),r+=4),n|=d<<8,t.setUint32(s,n,!0),r}function rd(t,e,i){var n=i,r=t.getUint32(n,!0);n+=4,e.value=t.getFloat32(n,!0),n+=4,r&W_.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(n),n+=1),r&W_.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(n),n+=1),r&W_.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(n,!0),n+=4),r&W_.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(n,!0),n+=4),r&W_.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(n,!0),n+=4),r&W_.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(n,!0),n+=4);var s=(65280&r)>>8;return e.easingMethod=s,n}function sd(t,e,i){return e+ks(t-e,i-e)}function ad(t,e,i){return e+zs(t-e,i-e)}function od(t,e,i,n,r){return e+(n-e)/(i-t)*(r-t)}function ud(t,e,i,n,r){var s=1-r;return s*s*s*t+3*s*s*r*e+3*s*r*r*i+r*r*r*n}v.bezier=function(t,e,i,n,r){var s=1-r;return s*(s*(t+(3*e-t)*r)+3*i*r*r)+n*r*r*r};var hd,cd,ld,_d,dd,fd,pd,md,gd,vd,yd=Math.cos,Td=Math.acos,Ed=Math.max,Sd=2*Math.PI,Ad=Math.sqrt;function Rd(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function wd(t,e){var i=function(t,e){var i,n,r,s,a=e-0,o=e-t[0],u=3*a,h=3*o,c=3*(e-t[2]),l=1/(-a+h-c+(e-1)),_=1/3,d=(u-6*o+c)*l,f=d*_,p=(-u+h)*l,m=(3*p-d*d)*_,g=m*_,v=(2*d*d*d-9*d*p+a*l*27)/27,y=v/2,T=y*y+g*g*g;if(T<0){var E=-m*_,S=Ad(E*E*E),A=-v/(2*S),R=Td(A<-1?-1:A>1?1:A),w=2*Rd(S);return n=w*yd(R*_)-f,r=w*yd((R+Sd)*_)-f,s=w*yd((R+2*Sd)*_)-f,n>=0&&n<=1?r>=0&&r<=1?s>=0&&s<=1?Ed(n,r,s):Ed(n,r):s>=0&&s<=1?Ed(n,s):n:r>=0&&r<=1?s>=0&&s<=1?Ed(r,s):r:s}if(0===T)return r=-(i=y<0?Rd(-y):-Rd(y))-f,(n=2*i-f)>=0&&n<=1?r>=0&&r<=1?Ed(n,r):n:r;var b=Ad(T);return(i=Rd(-y+b))-Rd(y+b)-f}(t,e),n=t[1];return((1-i)*(n+(t[3]-n)*i)*3+i*i)*i}v.bezierByTime=wd,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(vd||(vd=t("QuatInterpolationMode",{})));var bd,Od=ao("cc.QuatKeyframeValue")(hd=To((cd=function(t){var e=void 0===t?{}:t,i=e.value,n=e.interpolationMode,r=e.easingMethod;this.interpolationMode=ld&&ld(),this.value=_d&&_d(),this.easingMethod=dd&&dd(),this.value=i?sa.clone(i):this.value,this.interpolationMode=null!=n?n:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod},ld=Za(cd.prototype,"interpolationMode",[mo],(function(){return vd.SLERP})),_d=Za(cd.prototype,"value",[mo],(function(){return sa.clone(sa.IDENTITY)})),dd=Za(cd.prototype,"easingMethod",[mo],(function(){return A_.LINEAR})),hd=cd))||hd)||hd;function Md(t){return new Od(t)}t("QuatCurve",ao("cc.QuatCurve")((pd=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).preExtrapolation=md&&md(),e.postExtrapolation=gd&&gd(),e}o(e,t);var i=e.prototype;return i.evaluate=function(t,e){var i;null!==(i=e)&&void 0!==i||(e=new sa);var n=this._times,r=this._values,s=this.postExtrapolation,a=this.preExtrapolation,o=n.length;if(0===o)return e;var u=n[0],h=n[o-1];if(t<u){var c=r[0];switch(a){case Ec.LOOP:t=u+ks(t-u,h-u);break;case Ec.PING_PONG:t=u+zs(t-u,h-u);break;case Ec.CLAMP:default:return sa.copy(e,c.value)}}else if(t>h){var l=r[o-1];switch(s){case Ec.LOOP:t=u+ks(t-u,h-u);break;case Ec.PING_PONG:t=u+zs(t-u,h-u);break;case Ec.CLAMP:default:return sa.copy(e,l.value)}}var _=yc(n,t);if(_>=0)return sa.copy(e,r[_].value);var d=~_,f=d-1,p=n[f],m=r[f],g=n[d],v=r[d],y=(t-p)/(g-p);switch(m.interpolationMode){default:case vd.CONSTANT:return sa.copy(e,m.value);case vd.SLERP:var T=m.easingMethod,E=T===A_.LINEAR?y:Array.isArray(T)?wd(T,y):L_(T)(y);return sa.slerp(e,m.value,v.value,E)}},i.addKeyFrame=function(e,i){var n=new Od(i);return t.prototype.addKeyFrame.call(this,e,n)},i.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return Md(t)})));else{var i=Array.from(t);this.setKeyframes(i.map((function(t){return t[0]})),i.map((function(t){return Md(t[1])})))}},i[sl]=function(t,e){if(e.toCCON){var i=this._times,n=this._values,r=!0;n.forEach((function(t,e,i){var n=i[0];r&&t.interpolationMode!==n.interpolationMode&&(r=!1)}));var s=i.length,a=Pd*(r?1:s),o=n.reduce((function(t,e){var i=e.easingMethod;return t+(Array.isArray(i)?Dd+4*Ld:Dd)}),0),u=0,h=new DataView(new ArrayBuffer(u+=Cd+xd+Nd*s+4*Bd*s+o+a+0)),c=0,l=0;r&&(l|=bd.INTERPOLATION_MODE),h.setUint32(c,l,!0),c+=Cd,h.setUint32(c,s,!0),c+=xd,i.forEach((function(t,e){return h.setFloat32(c+Nd*e,t,!0)})),c+=Nd*s,n.forEach((function(t,e){var i=t.value,n=i.x,r=i.y,s=i.z,a=i.w,o=c+4*Bd*e;h.setFloat32(o+0*Bd,n,!0),h.setFloat32(o+1*Bd,r,!0),h.setFloat32(o+2*Bd,s,!0),h.setFloat32(o+3*Bd,a,!0)})),c+=4*Bd*s,n.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(h.setUint8(c,Fd),++c,h.setFloat32(c+0*Ld,e[0],!0),h.setFloat32(c+1*Ld,e[1],!0),h.setFloat32(c+2*Ld,e[2],!0),h.setFloat32(c+3*Ld,e[3],!0),c+=4*Ld):(h.setUint8(c,e),++c)}));var _=c;c+=a;var d=_;n.forEach((function(t){var e=t.interpolationMode;h.setUint8(d,e),r||(d+=Pd)}));var f=new Uint8Array(h.buffer);t.writeProperty("bytes",f)}else t.writeThis()},i[al]=function(t,e){if(e.fromCCON){var i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength),r=0,s=n.getUint32(r,!0);r+=Cd;var a=s&bd.INTERPOLATION_MODE,o=n.getUint32(r,!0);r+=xd;var u=Array.from({length:o},(function(t,e){return n.getFloat32(r+Nd*e,!0)})),h=r+=Nd*o;r+=4*Bd*o;var c=Array.from({length:o},(function(t,e){var i=h+4*Bd*e,s=n.getFloat32(i+0*Bd,!0),a=n.getFloat32(i+1*Bd,!0),o=n.getFloat32(i+2*Bd,!0),u=n.getFloat32(i+3*Bd,!0),c=n.getUint8(r);++r;var l=Md({value:{x:s,y:a,z:o,w:u}});return c!==Fd?l.easingMethod=c:(l.easingMethod=[n.getFloat32(r+0*Ld,!0),n.getFloat32(r+1*Ld,!0),n.getFloat32(r+2*Ld,!0),n.getFloat32(r+3*Ld,!0)],r+=4*Ld),l}));if(a){var l=n.getUint8(r);++r;for(var _=0;_<o;++_)c[_].interpolationMode=l}else{for(var d=0;d<o;++d){var f=n.getUint8(r+d);c[d].interpolationMode=f}r+=o}this._times=u,this._values=c}else t.readThis()},e}(Ac),md=Za(pd.prototype,"preExtrapolation",[mo],(function(){return Ec.CLAMP})),gd=Za(pd.prototype,"postExtrapolation",[mo],(function(){return Ec.CLAMP})),fd=pd))||fd),function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(bd||(bd={}));var Id,Cd=1,xd=4,Nd=4,Bd=4,Pd=1,Dd=1,Fd=255,Ld=4,Ud=(t("ObjectCurve",ao("cc.ObjectCurve")(Id=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var i=As(~e-1,0,this._values.length-1);return this._values[i]},e}(Ac))||Id),function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0});Dr.fastDefine("cc.Keyframe",Ud,{time:0,value:0,inTangent:0,outTangent:0});var Gd,kd=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,i=this.coefficient,e*(e*(e*i[0]+i[1])+i[2])+i[3];var e,i},t}(),zd=function(){function t(t){if(void 0===t&&(t=null),this.cachedKey=void 0,t instanceof X_)this._curve=t;else{var e=new X_;this._curve=e,e.preExtrapolation=Ec.LOOP,e.postExtrapolation=Ec.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:Tc.CUBIC,value:1}],[1,{interpolationMode:Tc.CUBIC,value:1}]])}this.cachedKey=new kd}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,i=this._curve,n=i.keyFramesCount-1,r=t,s=t<0?i.preExtrapolation:i.postExtrapolation,a=i.getKeyframeTime(0),o=i.getKeyframeTime(n);switch(s){case Ec.LOOP:r=ks(t-a,o-a)+a;break;case Ec.PING_PONG:r=zs(t-a,o-a)+a;break;case Ec.CLAMP:default:r=As(t,a,o)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var u=this.findIndex(e,r),h=Math.min(u+1,n);return this.calcOptimizedKey(e,u,h),e.evaluate(r)},e.calcOptimizedKey=function(t,e,i){var n=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(i),s=this._curve.getKeyframeValue(e),a=s.value,o=s.leftTangent,u=this._curve.getKeyframeValue(i),h=u.value,c=u.rightTangent;t.index=e,t.time=n,t.endTime=r;var l=r-n,_=h-a,d=1/(l*l),f=o*l,p=c*l;t.coefficient[0]=(f+p-_-_)*d/l,t.coefficient[1]=(_+_+_-f-f-p)*d,t.coefficient[2]=o,t.coefficient[3]=a},e.findIndex=function(t,e){var i=this._curve,n=i.keyFramesCount,r=t.index;if(-1!==r)if(e>i.getKeyframeTime(r))for(var s=0;s<3;s++){var a=r+s;if(a+1<n&&i.getKeyframeTime(a+1)>e)return a}else for(var o=0;o<3;o++){var u=r-o;if(u>=0&&i.getKeyframeTime(u-1)<=e)return u-1}for(var h,c=0,l=n;l-c>1;)h=Math.floor((c+l)/2),i.getKeyframeTime(h)>=e?l=h:c=h;return c},s(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],i=t[1],n=new Ud;return n.time=e,n.value=i.value,n.inTangent=i.leftTangent,n.outTangent=i.rightTangent,n}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return Vd(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=Hd(t)}},{key:"postWrapMode",get:function(){return Vd(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=Hd(t)}}]),t}();function Hd(t){switch(t){default:case _c.Default:case _c.Normal:case _c.Clamp:return Ec.CLAMP;case _c.PingPong:return Ec.PING_PONG;case _c.Loop:return Ec.LOOP}}function Vd(t){switch(t){default:case Ec.LINEAR:case Ec.CLAMP:return _c.Clamp;case Ec.PING_PONG:return _c.PingPong;case Ec.LOOP:return _c.Loop}}function Wd(){var t=new X_;return t.assignSorted([[0,{interpolationMode:Tc.CUBIC,value:1}],[1,{interpolationMode:Tc.CUBIC,value:1}]]),t}zd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Dr.fastDefine("cc.AnimationCurve",zd,{_curve:null}),function(t){t[t.LINEAR=0]="LINEAR",t[t.BEZIER=1]="BEZIER",t[t.CATMULL_ROM=2]="CATMULL_ROM"}(Gd||(Gd={}));var Xd=4294967295,jd=new js,Yd=new js,Kd=new js,qd=new js,Qd=function(){function t(t,e){void 0===t&&(t=Gd.CATMULL_ROM),void 0===e&&(e=[]),this._type=void 0,this._mode=Gd.CATMULL_ROM,this._knots=[],this._type=Pu.SHAPE_SPLINE,this._mode=t;for(var i=0;i<e.length;i++)this._knots[i]=new js(e[i])}t.create=function(e,i){return void 0===i&&(i=[]),new t(e,i)},t.clone=function(e){return new t(e.mode,e.knots)},t.copy=function(t,e){t._mode=e.mode,t._knots.length=0;for(var i=e.knots,n=i.length,r=0;r<n;r++)t._knots[r]=new js(i[r]);return t};var e=t.prototype;return e.setModeAndKnots=function(t,e){this._mode=t,this._knots.length=0;for(var i=0;i<e.length;i++)this._knots[i]=new js(e[i])},e.clearKnots=function(){this._knots.length=0},e.getKnotCount=function(){return this._knots.length},e.addKnot=function(t){this._knots.push(new js(t))},e.insertKnot=function(t,e){var i=new js(e);t>=this._knots.length?this._knots.push(i):this._knots.splice(t,0,i)},e.removeKnot=function(t){t>=0&&this._knots.length,this._knots.splice(t,1)},e.setKnot=function(t,e){t>=0&&this._knots.length,this._knots[t].set(e)},e.getKnot=function(t){return t>=0&&this._knots.length,this._knots[t]},e.getPoint=function(e,i){void 0===i&&(i=Xd),e=As(e,0,1);var n=this.getSegments();if(0==n)return new js(0,0,0);if(i==Xd){var r=1/n;i=Math.floor(e/r),e=e%r/r}if(i>=n)return new js(this._knots[this._knots.length-1]);switch(this._mode){case Gd.LINEAR:return t.calcLinear(this._knots[i],this._knots[i+1],e);case Gd.BEZIER:return t.calcBezier(this._knots[4*i],this._knots[4*i+1],this._knots[4*i+2],this._knots[4*i+3],e);case Gd.CATMULL_ROM:var s=i>0?this._knots[i-1]:this._knots[i],a=i+2<this._knots.length?this._knots[i+2]:this._knots[i+1];return t.calcCatmullRom(s,this._knots[i],this._knots[i+1],a,e);default:return new js(0,0,0)}},e.getPoints=function(t,e){if(void 0===e&&(e=Xd),0==t)return[];if(1==t)return[this.getPoint(0,e)];for(var i=[],n=1/(t-1),r=0;r<t;r++){var s=r*n,a=this.getPoint(s,e);i.push(a)}return i},e.getSegments=function(){var t=this._knots.length;switch(this._mode){case Gd.LINEAR:case Gd.CATMULL_ROM:return t<2?(G(14300),0):t-1;case Gd.BEZIER:return t<4||t%4!=0?(G(14301),0):t/4}},t.calcLinear=function(t,e,i){var n=new js;return js.multiplyScalar(jd,t,1-i),js.multiplyScalar(Yd,e,i),js.add(n,jd,Yd),n},t.calcBezier=function(t,e,i,n,r){var s=new js,a=1-r;return js.multiplyScalar(jd,t,a*a*a),js.multiplyScalar(Yd,e,3*r*a*a),js.multiplyScalar(Kd,i,3*r*r*a),js.multiplyScalar(qd,n,r*r*r),js.add(jd,jd,Yd),js.add(Kd,Kd,qd),js.add(s,jd,Kd),s},t.calcCatmullRom=function(t,e,i,n,r){var s=new js,a=r*r,o=a*r;return js.multiplyScalar(jd,t,-.5*o+a-.5*r),js.multiplyScalar(Yd,e,1.5*o-2.5*a+1),js.multiplyScalar(Kd,i,-1.5*o+2*a+.5*r),js.multiplyScalar(qd,n,.5*o-.5*a),js.add(jd,jd,Yd),js.add(Kd,Kd,qd),js.add(s,jd,Kd),s},s(t,[{key:"type",get:function(){return this._type}},{key:"mode",get:function(){return this._mode}},{key:"knots",get:function(){return this._knots}}]),t}(),Zd=Object.freeze({__proto__:null,distance:Bu,enums:Pu,intersect:jh,Line:Yh,Plane:Jh,Ray:Du,Triangle:Vu,Sphere:Hu,AABB:sc,OBB:hc,Capsule:cc,Frustum:vc,Keyframe:Ud,AnimationCurve:zd,get SplineMode(){return Gd},Spline:Qd,get ERaycastMode(){return zu}});t("geometry",Zd);var Jd,$d,tf,ef,nf,rf=10,sf=0,af=new Map;tf=function(t,e,i,n,r,s,a){var o=af.get(s);o&&o.logTimes>o.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,i+"."+n),o.count++)},Jd=t("replaceProperty",(function(t,e,i){null!=t&&i.forEach((function(i){var n=sf++;af.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:rf});var r=null!=i.target?i.target:t,s=null!=i.newName?i.newName:i.name,a=null!=i.targetName?i.targetName:e,o=r===t,u=i.suggest?"("+i.suggest+")":"";if(null!=i.customFunction)t[i.name]=function(){var t;return tf(e,i.name,a,s,I,n,u),(t=i.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=i.customSetter||null!=i.customGetter){var h=null!=i.customSetter,c=null!=i.customGetter;h&&c?Object.defineProperty(t,i.name,{get:function(){return tf(e,i.name,a,s,I,n,u),i.customGetter.call(this)},set:function(t){tf(e,i.name,a,s,I,n,u),i.customSetter.call(this,t)},enumerable:!1}):h?Object.defineProperty(t,i.name,{set:function(t){tf(e,i.name,a,s,I,n,u),i.customSetter.call(this,t)},enumerable:!1}):c&&Object.defineProperty(t,i.name,{get:function(){return tf(e,i.name,a,s,I,n,u),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get:function(){return tf(e,i.name,a,s,I,n,u),o?this[s]:r[s]},set:function(t){tf(e,i.name,a,s,I,n,u),o?this[s]=t:r[s]=t},enumerable:!1})}))})),nf=function(t,e,i,n,r){var s=af.get(n);s&&s.logTimes>s.count&&(i("'%s' has been removed. "+r,t+"."+e),s.count++)},$d=t("removeProperty",(function(t,e,i){null!=t&&i.forEach((function(i){var n=sf++;af.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:rf});var r=i.suggest?"("+i.suggest+")":"";Object.defineProperty(t,i.name,{get:function(){return nf(e,i.name,C,n,r)},set:function(){nf(e,i.name,C,n,r)},enumerable:!1})}))})),ef=function(t,e,i,n,r){var s=af.get(n);s&&s.logTimes>s.count&&(i("'%s' is deprecated. "+r,t+"."+e),s.count++)},t("markAsWarning",(function(t,e,i){null!=t&&i.forEach((function(i){var n=i.name,r=Object.getOwnPropertyDescriptor(t,n);if(r&&r.configurable){var s=sf++;af.set(s,{id:s,count:0,logTimes:void 0!==i.logTimes?i.logTimes:rf});var a=i.suggest?"("+i.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var o=r.value;t[n]=function(){return ef(e,n,I,s,a),o.call.apply(o,[this].concat(Array.prototype.slice.call(arguments)))}}else{var u=r.value;Object.defineProperty(t,n,{configurable:!0,get:function(){return ef(e,n,I,s,a),u}}),r.writable&&Object.defineProperty(t,n,{set:function(t){ef(e,n,I,s,a),u=t}})}else!function(e,i,n,r,s,a){if(e.get){var o=e.get;e.get=function(){return ef(i,n,r,s,a),o.call(this)}}if(e.set){var u=e.set;e.set=function(t){ef(i,n,r,s,a),u.call(this,t)}}Object.defineProperty(t,n,e)}(r,e,n,I,s,a);Object.defineProperty(t,n,{enumerable:!1})}}))}));var of,uf={};function hf(t){var e=uf[t];if(e){var i=e.newName,n=e.since;e.removed?i?z(16003,t,n,i):z(16002,t,n):i?G(16001,t,n,i):G(16e3,t,n)}}var cf,lf,_f,df,ff,pf,mf,gf,vf,yf,Tf,Ef,Sf,Af,Rf;!function(t){t[t.RGB565=et.R5G6B5]="RGB565",t[t.RGB5A1=et.RGB5A1]="RGB5A1",t[t.RGBA4444=et.RGBA4]="RGBA4444",t[t.RGB888=et.RGB8]="RGB888",t[t.RGB32F=et.RGB32F]="RGB32F",t[t.RGBA8888=et.RGBA8]="RGBA8888",t[t.RGBA32F=et.RGBA32F]="RGBA32F",t[t.A8=et.A8]="A8",t[t.I8=et.L8]="I8",t[t.AI8=et.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=et.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=et.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=1024]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=et.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=et.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=1025]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=et.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=1026]="RGBA_ETC1",t[t.RGB_ETC2=et.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=et.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=et.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=et.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=et.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=et.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=et.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=et.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=et.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=et.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=et.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=et.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=et.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=et.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=et.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=et.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(cf||(cf={})),function(t){t[t.REPEAT=pt.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=pt.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=pt.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=pt.BORDER]="CLAMP_TO_BORDER"}(lf||(lf={})),function(t){t[t.NONE=ft.NONE]="NONE",t[t.LINEAR=ft.LINEAR]="LINEAR",t[t.NEAREST=ft.POINT]="NEAREST"}(_f||(_f={})),kn(et);var wf,bf=new Xi("Tex"),Of=ao("cc.TextureBase")((Rf=Af=function(t){function e(){var e;return(e=t.call(this)||this)._format=pf&&pf(),e._minFilter=mf&&mf(),e._magFilter=gf&&gf(),e._mipFilter=vf&&vf(),e._wrapS=yf&&yf(),e._wrapT=Tf&&Tf(),e._wrapR=Ef&&Ef(),e._anisotropy=Sf&&Sf(),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new de,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=bf.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=pi(e._id,666),e}o(e,t);var i=e.prototype;return i.getId=function(){return this._id},i.getPixelFormat=function(){return this._format},i.getAnisotropy=function(){return this._anisotropy},i.setWrapMode=function(t,e,i){void 0===i&&(i=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=i,this._samplerInfo.addressW=i,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},i.destroy=function(){var e,i=t.prototype.destroy.call(this);return i&&null!==(e=v.director.root)&&void 0!==e&&e.batcher2D&&v.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),i},i.getHash=function(){return this._textureHash},i.getGFXTexture=function(){return null},i.getSamplerInfo=function(){return this._samplerInfo},i.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):z(9302)),this._gfxSampler},i._serialize=function(){return""},i._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},i._getGFXDevice=function(){return Wa.gfxDevice},i._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},i._setGFXFormat=function(t){this._format=void 0===t?cf.RGBA8888:t},i._getGFXPixelFormat=function(t){return t===cf.RGBA_ETC1?t=cf.RGB_ETC1:t===cf.RGB_A_PVRTC_4BPPV1?t=cf.RGB_PVRTC_4BPPV1:t===cf.RGB_A_PVRTC_2BPPV1&&(t=cf.RGB_PVRTC_2BPPV1),t},s(e,[{key:"isCompressed",get:function(){return this._format>=cf.RGB_ETC1&&this._format<=cf.RGBA_ASTC_12x12||this._format>=cf.RGB_A_PVRTC_2BPPV1&&this._format<=cf.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Tu),Af.PixelFormat=cf,Af.WrapMode=lf,Af.Filter=_f,pf=Za((ff=Rf).prototype,"_format",[mo],(function(){return cf.RGBA8888})),mf=Za(ff.prototype,"_minFilter",[mo],(function(){return _f.LINEAR})),gf=Za(ff.prototype,"_magFilter",[mo],(function(){return _f.LINEAR})),vf=Za(ff.prototype,"_mipFilter",[mo],(function(){return _f.NONE})),yf=Za(ff.prototype,"_wrapS",[mo],(function(){return lf.REPEAT})),Tf=Za(ff.prototype,"_wrapT",[mo],(function(){return lf.REPEAT})),Ef=Za(ff.prototype,"_wrapR",[mo],(function(){return lf.REPEAT})),Sf=Za(ff.prototype,"_anisotropy",[mo],(function(){return 0})),df=ff))||df;v.TextureBase=Of;var Mf=new be;Mf.format=et.RGBA8;var If=new Oe;If.format=et.DEPTH_STENCIL;var Cf,xf,Nf=new Ce([Mf],If),Bf={width:1,height:1,renderPassInfo:Nf},Pf=t("RenderTexture",ao("cc.RenderTexture")(wf=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._window=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},i.reset=function(t){this.initialize(t)},i.destroy=function(){if(this._window){var e=v.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},i.resize=function(t,e){this._width=Math.floor(As(t,1,2048)),this._height=Math.floor(As(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},i._serialize=function(){return{}},i._deserialize=function(e,i){var n=e;this._width=n.w,this._height=n.h,this._name=n.n,t.prototype._deserialize.call(this,n.base,i)},i.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},i.onLoaded=function(){this._initWindow()},i._initWindow=function(t){var e=v.director.root;Bf.title=this._name,Bf.width=this._width,Bf.height=this._height,Bf.renderPassInfo=t&&t.passInfo?t.passInfo:Nf,Mf.barrier=Wa.gfxDevice.getGeneralBarrier(new xe(Rt.FRAGMENT_SHADER_READ_TEXTURE,Rt.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(Wa.gfxDevice,Bf)):this._window=e.createWindow(Bf)},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},i.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},i.readPixels=function(t,e,i,n,r){void 0===t&&(t=0),void 0===e&&(e=0),i=i||this.width,n=n||this.height;var s=this.getGFXTexture();if(!s)return z(7606),null;var a=4*i*n;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return z(7607,a),null;var o=this._getGFXDevice(),u=[],h=[],c=new te;return c.texOffset.x=t,c.texOffset.y=e,c.texExtent.width=i,c.texExtent.height=n,h.push(c),u.push(r),null==o||o.copyTextureToBuffers(s,u,h),r},s(e,[{key:"window",get:function(){return this._window}}]),e}(Of))||wf);v.RenderTexture=Pf,$d(Of.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Jd(Pf.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var Df=t("BufferAsset",ao("cc.BufferAsset")((m((xf=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._buffer=null,e}o(e,t);var i=e.prototype;return i.buffer=function(){return this._buffer,this._buffer},i.validate=function(){return!!this.buffer},s(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Tu)).prototype,"_nativeAsset",[No],Object.getOwnPropertyDescriptor(xf.prototype,"_nativeAsset"),xf.prototype),Cf=xf))||Cf);function Ff(t,e){for(var i,n=p(e);!(i=n()).done;){var r=i.value;Array.isArray(r)?Ff(t,r):t.push(r)}}function Lf(t){var e=[];return Ff(e,t),e.join("")}v.BufferAsset=Df;var Uf=Vr.Flags.Destroyed,Gf=Vr.Flags.PersistentMask,kf=Dr.IDENTIFIER_RE,zf="var ",Hf="o",Vf={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},Wf=Dr.escapeForJS,Xf=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return zf+this.varName+"="+this.expression+";"},t}();function jf(t,e){return e instanceof Xf?new Xf(e.varName,t+e.expression):t+e}function Yf(t,e,i){Array.isArray(i)?(i[0]=jf(e,i[0]),t.push(i)):t.push(jf(e,i)+";")}var Kf=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var i=0;i<this._exps.length;i++){var n=this._exps[i];Yf(t,e+qf(n[0])+"=",n[1])}},t}();function qf(t){return kf.test(t)?"."+t:"["+Wf(t)+"]"}Kf.pool=void 0,Kf.pool=new Bn((function(t){t._exps.length=0,t._targetExp=null}),1),Kf.pool.get=function(t){var e=this._get()||new Kf;return e._targetExp=t,e};var Qf=function(){function t(t,e){var i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=rn(),pn(this.funcModuleCache,Vf),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=zf+this.globalVariables.join(",")+";");var n=Lf(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(var r=0,s=this.objsToClear_iN$t.length;r<s;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var i=sn(t);if(i){var n=this.funcModuleCache[i];if(n)return n;if(void 0===n){var r=-1!==i.indexOf(".");if(r)try{if(r=t===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(t){}}}var s=this.funcs.indexOf(t);s<0&&(s=this.funcs.length,this.funcs.push(t));var a="F["+s+"]";return e&&(a="("+a+")"),this.funcModuleCache[i]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,i,n){var r=Kf.pool.get(n),s=e.constructor.__props__;s||(s=Object.keys(e));for(var a=0;a<s.length;a++){var o=s[a],u=i[o];if(e[o]!==u){var h=this.enumerateField(i,o,u);r.append(o,h)}}r.writeCode(t),Kf.pool.put(r)},e.enumerateCCClass=function(t,e,i){for(var n=i.__values__,r=cr(i),s=0;s<n.length;s++){var a=n[s],o=e[a],u=r[a+"$_$default"];if(!Zf(u,o))if("object"==typeof o&&o instanceof v.ValueType&&(u=Dr.getDefault(u))&&u.constructor===o.constructor){var h=Hf+qf(a);this.setValueType(t,u,o,h)}else this.setObjProp(t,e,a,o)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,i=[new Xf(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var n=0;n<t.length;++n)Yf(i,e+"["+n+"]=",this.enumerateField(t,n,t[n]));return i},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var i="a"+ ++this.localVariableId,n=[new Xf(i,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&Yf(n,i+"["+r+"]=",t[r]);return n},e.enumerateField=function(t,e,i){if("object"==typeof i&&i){var n=i._iN$t;if(n){var r=n.globalVar;if(!r){r=n.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var s=n.source[0];n.source[0]=jf(r+"=",s)}return r}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?Wf(i):("_objFlags"===e&&Xr(t)&&(i&=Gf),i)},e.setObjProp=function(t,e,i,n){Yf(t,Hf+qf(i)+"=",this.enumerateField(e,i,n))},e.enumerateObject=function(t,e){var i=e.constructor;if(Fr(i))this.enumerateCCClass(t,e,i);else for(var n in e)if(e.hasOwnProperty(n)&&(95!==n.charCodeAt(0)||95!==n.charCodeAt(1)||"__type__"===n)){var r=e[n];"object"==typeof r&&r&&r===e._iN$t||this.setObjProp(t,e,n,r)}},e.instantiateObj=function(t){if(t instanceof v.ValueType)return Dr.getNewValueTypeCode(t);if(t instanceof v.Asset)return this.getObjRef(t);if(t._objFlags&Uf)return null;var e,i=t.constructor;if(Fr(i)){if(this.parent)if(this.parent instanceof v.Component){if(t instanceof v._BaseNode||t instanceof v.Component)return this.getObjRef(t)}else if(this.parent instanceof v._BaseNode)if(t instanceof v._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof v.Component){var n;if(null===(n=t.node)||void 0===n||!n.isChildOf(this.parent))return this.getObjRef(t)}e=new Xf(Hf,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)e=new Xf(Hf,"{}");else{if(i)return this.getObjRef(t);e=new Xf(Hf,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function Zf(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof v.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return Zi(t)&&Zi(e)}return!1}var Jf={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},$f=t("Layers",function(){function t(){}return t.init=function(){var e=Wn.querySettings(Vn.Category.ENGINE,"customLayers");if(e)for(var i=0;i<e.length;i++){var n=e[i];t.addLayer(n.name,n.bit)}},t.makeMaskInclude=function(t){for(var e,i=0,n=p(t);!(e=n()).done;)i|=e.value;return i},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,i){if(void 0!==i)if(i>19||i<0)console.warn("maximum layers reached.");else{var n=1<<i;t.Enum[e],X(2104,e),t.Enum[e]=n,Dn.value(t.Enum,String(n),e),t.BitMask[e]=n,Dn.value(t.BitMask,String(n),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var i=1<<e;delete t.Enum[t.Enum[i]],delete t.Enum[i],delete t.BitMask[t.BitMask[i]],delete t.BitMask[i]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):_s(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());$f.Enum=Ln(Jf),$f.BitMask=Fn(a({},Jf)),v.Layers=$f;var tp,ep,ip,np,rp,sp,ap,op,up,hp,cp=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},s(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?G(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();Vr.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed",t.COMPONENT_ADDED="component-added",t.COMPONENT_REMOVED="component-removed"}(tp||(tp=t("NodeEventType",{})));var lp=Vr.Flags.Destroying,_p=Vr.Flags.DontDestroy,dp=Vr.Flags.Deactivating,fp=new Xi("Node");function pp(t){return t?"string"==typeof t?Cn(t):t:(z(3804),null)}var mp,gp,vp,yp,Tp,Ep,Sp,Ap,Rp,wp,bp,Op,Mp,Ip=t("BaseNode",ao("cc.BaseNode")((hp=up=function(t){o(i,t),i._setScene=function(t){t._updateScene()},i._findComponent=function(t,e){var i=e,n=t._components;if(i._sealed)for(var r=0;r<n.length;++r){var s=n[r];if(s.constructor===e)return s}else for(var a=0;a<n.length;++a){var o=n[a];if(o instanceof e)return o}return null},i._findComponents=function(t,e,i){var n=e,r=t._components;if(n._sealed)for(var s=0;s<r.length;++s){var a=r[s];a.constructor===e&&i.push(a)}else for(var o=0;o<r.length;++o){var u=r[o];u instanceof e&&i.push(u)}},i._findChildComponent=function(t,e){for(var n=0;n<t.length;++n){var r=t[n],s=i._findComponent(r,e);if(s)return s;if(r._children.length>0&&(s=i._findChildComponent(r._children,e)))return s}return null},i._findChildComponents=function(t,e,n){for(var r=0;r<t.length;++r){var s=t[r];i._findComponents(s,e,n),s._children.length>0&&i._findChildComponents(s._children,e,n)}};var e=i.prototype;function i(e){var i;return(i=t.call(this,e)||this)._parent=np&&np(),i._children=rp&&rp(),i._active=sp&&sp(),i._components=ap&&ap(),i._prefab=op&&op(),i._scene=null,i._activeInHierarchy=!1,i._id=fp.getNewId(),i._name=void 0,i._eventProcessor=new v.NodeEventProcessor(d(i)),i._eventMask=0,i._siblingIndex=0,i._originalSceneId="",i._name=void 0!==e?e:"New Node",i}return e._updateScene=function(){null==this._parent?C("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){pn(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(tp.PARENT_CHANGED,i),i&&!(i._objFlags&lp)){var r=i._children.indexOf(this);i._children.splice(r,1),i._updateSiblingIndex(),i.emit&&i.emit(tp.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(tp.CHILD_ADDED,this)),this._onHierarchyChanged(i)}},e.getChildByUuid=function(t){if(!t)return M("Invalid uuid"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null},e.getChildByName=function(t){if(!t)return M("Invalid name"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null},e.getChildByPath=function(t){for(var e=t.split("/"),i=this,n=function(t){var n=e[t];if(0===n.length)return"continue";var r=i.children.find((function(t){return t.name===n}));if(!r)return{v:null};i=r},r=0;r<e.length;++r){var s=n(r);if("continue"!==s&&"object"==typeof s)return s.v}return i},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.setParent(this),t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&dp)z(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var n=1,r=null,s=null,a=0,o=i._stacks[i._stackId];o||(o=[],i._stacks.push(o)),i._stackId++,o.length=0,o[0]=this;for(var u=null,h=!1;n;)if(s=o[--n])if(!h&&t?t(s):h&&e&&e(s),o[n]=null,h){if(u===this._parent)break;if(h=!1,r)if(r[++a])o[n]=r[a],n++;else if(u&&(o[n]=u,n++,h=!0,u._parent?(a=(r=u._parent._children).indexOf(u),u=u._parent):(u=null,r=null),a<0))break}else s._children.length>0?(u=s,r=s._children,a=0,o[n]=r[a],n++):(o[n]=s,n++,h=!0);o.length=0,i._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var i=t[e];i&&(i.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=pp(t);return e?i._findComponent(this,e):null},e.getComponents=function(t){var e=pp(t),n=[];return e&&i._findComponents(this,e,n),n},e.getComponentInChildren=function(t){var e=pp(t);return e?i._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=pp(t),n=[];return e&&(i._findComponents(this,e,n),i._findChildComponents(this._children,e,n)),n},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=Cn(t)))throw v._RF.peek()&&z(3808,t),TypeError(X(3807,t))}else{if(!t)throw TypeError(X(3804));e=t}if("function"!=typeof e)throw TypeError(X(3809));if(!vn(e,v.Component))throw TypeError(X(3810));var i=e._requireComponent;if(i)if(Array.isArray(i))for(var n=0;n<i.length;n++){var r=i[n];this.getComponent(r)||this.addComponent(r)}else{var s=i;this.getComponent(s)||this.addComponent(s)}var a=new e;return a.node=this,this._components.push(a),this.emit(tp.COMPONENT_ADDED,a),this._activeInHierarchy&&v.director._nodeActivator.activateComp(a),a},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof el?t:this.getComponent(t))&&e.destroy()}else z(3813)},e.on=function(t,e,i,n){switch(void 0===n&&(n=!1),t){case tp.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)},e.off=function(t,e,i,n){if(void 0===n&&(n=!1),this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case tp.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,i,n){this._eventProcessor.once(t,e,i,n)},e.emit=function(t,e,i,n,r,s){this._eventProcessor.emit(t,e,i,n,r,s)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(tp.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&lp)){var e=this._components.indexOf(t);-1!==e?(this._components.splice(e,1),this.emit(tp.COMPONENT_REMOVED,t)):t.node!==this&&z(3815)}}else z(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(tp.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(i._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent._children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=v.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof v.Scene||v.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&v.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=lp;var t=this._parent,e=!!t&&0!=(t._objFlags&lp);if(this._persistNode&&v.game.removePersistRootNode(this),!e&&t){this.emit(tp.PARENT_CHANGED,this);var i=t._children.indexOf(this);t._children.splice(i,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(tp.CHILD_REMOVED,this)}this.emit(tp.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,r=0;r<n.length;++r)n[r]._destroyImmediate();for(var s=this._components,a=0;a<s.length;++a)s[a]._destroyImmediate();return e},s(i,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&_p)>0},set:function(t){t?this._objFlags|=_p:this._objFlags&=~_p}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(t=!!t,this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&v.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),i}(Vr),up.idGenerator=fp,up._stacks=[[]],up._stackId=0,m((ip=hp).prototype,"_persistNode",[co],Object.getOwnPropertyDescriptor(ip.prototype,"_persistNode"),ip.prototype),np=Za(ip.prototype,"_parent",[mo],(function(){return null})),rp=Za(ip.prototype,"_children",[mo],(function(){return[]})),sp=Za(ip.prototype,"_active",[mo],(function(){return!0})),ap=Za(ip.prototype,"_components",[mo],(function(){return[]})),op=Za(ip.prototype,"_prefab",[mo],(function(){return null})),ep=ip))||ep);v._BaseNode=Ip,function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(mp||(mp=t("NodeSpace",{}))),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(gp||(gp=t("TransformBit",{}))),v.internal.TransformBit=gp;var Cp=new js,xp=new sa,Np=new sa,Bp=new sa,Pp=new ia,Dp=new ia,Fp=new da,Lp=[],Up=Symbol("ReserveContentsForAllSyncablePrefab"),Gp=0,kp=t("Node",(vp=ao("cc.Node"),yp=xo(js),vp((Mp=Op=function(t){function e(e){var i;return(i=t.call(this,e)||this)._uiProps=new cp(d(i)),i._static=!1,i._lpos=Sp&&Sp(),i._lrot=Ap&&Ap(),i._lscale=Rp&&Rp(),i._layer=wp&&wp(),i._euler=bp&&bp(),i._dirtyFlags=gp.NONE,i._eulerDirty=!1,i._flagChangeVersion=0,i._hasChangedFlags=0,i._pos=new js,i._rot=new sa,i._scale=new js(1,1,1),i._mat=new da,i}o(e,t),e.isNode=function(t){return t instanceof e&&(t.constructor===e||!(t instanceof v.Scene))};var i=e.prototype;return i._onPreDestroy=function(){return this._onPreDestroyBase()},i[sl]=function(t){t.writeThis()},i.setParent=function(e,i){void 0===i&&(i=!1),i&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,i)},i._onSetParent=function(e,i){if(t.prototype._onSetParent.call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),Ss(da.determinant(n._mat),0,Ts)?(G(14300),this._dirtyFlags|=gp.TRS,this.updateWorldTransform()):(da.multiply(Fp,da.invert(Fp,n._mat),this._mat),da.toRTS(Fp,this._lrot,this._lpos,this._lscale))):(js.copy(this._lpos,this._pos),sa.copy(this._lrot,this._rot),js.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(gp.TRS)},i._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},i._onBatchCreated=function(t){this.hasChangedFlags=gp.TRS,this._dirtyFlags|=gp.TRS;for(var e=this._children.length,i=0;i<e;++i)this._children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},i._onBeforeSerialize=function(){this.eulerAngles},i._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(gp.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},i.translate=function(t,e){var i=e||mp.LOCAL;if(i===mp.LOCAL)js.transformQuat(Cp,t,this._lrot),this._lpos.x+=Cp.x,this._lpos.y+=Cp.y,this._lpos.z+=Cp.z;else if(i===mp.WORLD)if(this._parent){sa.invert(xp,this._parent.worldRotation),js.transformQuat(Cp,t,xp);var n=this.worldScale;this._lpos.x+=Cp.x/n.x,this._lpos.y+=Cp.y/n.y,this._lpos.z+=Cp.z/n.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(gp.POSITION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.POSITION)},i.rotate=function(t,e){var i=e||mp.LOCAL;if(sa.normalize(xp,t),i===mp.LOCAL)sa.multiply(this._lrot,this._lrot,xp);else if(i===mp.WORLD){var n=this.worldRotation;sa.multiply(Np,xp,n),sa.invert(xp,n),sa.multiply(Np,xp,Np),sa.multiply(this._lrot,this._lrot,Np)}this._eulerDirty=!0,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)},i.lookAt=function(t,e){this.getWorldPosition(Cp),js.subtract(Cp,Cp,t),js.normalize(Cp,Cp),sa.fromViewUp(xp,Cp,e),this.setWorldRotation(xp)},i.invalidateChildren=function(t){var e,i,n=0,r=0,s=0,a=0,o=t|gp.POSITION;for(Lp[0]=this;n>=0;){if(a=(e=Lp[n--]).hasChangedFlags,e.isValid&&(e._dirtyFlags&a&t)!==t)for(e._dirtyFlags|=t,e.hasChangedFlags=a|t,s=(i=e._children).length,r=0;r<s;r++)Lp[++n]=i[r];t=o}},i.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,i=0;e&&e._dirtyFlags;)Lp[i++]=e,e=e._parent;for(var n=0;i;)n|=(t=Lp[--i])._dirtyFlags,e?(n&gp.POSITION&&(js.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&gp.RS&&(da.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),da.multiply(t._mat,e._mat,t._mat),n&gp.ROTATION&&sa.multiply(t._rot,e._rot,t._lrot),ia.fromQuat(Pp,sa.conjugate(Bp,t._rot)),ia.multiplyMat4(Pp,Pp,t._mat),t._scale.x=Pp.m00,t._scale.y=Pp.m04,t._scale.z=Pp.m08)):(n&gp.POSITION&&(js.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&gp.RS&&(n&gp.ROTATION&&sa.copy(t._rot,t._lrot),n&gp.SCALE&&(js.copy(t._scale,t._lscale),da.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=gp.NONE,e=t}},i.setPosition=function(t,e,i){void 0===e&&void 0===i?js.copy(this._lpos,t):void 0===i?js.set(this._lpos,t,e,this._lpos.z):js.set(this._lpos,t,e,i),this.invalidateChildren(gp.POSITION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.POSITION)},i.getPosition=function(t){return t?js.set(t,this._lpos.x,this._lpos.y,this._lpos.z):js.copy(new js,this._lpos)},i.setRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?sa.copy(this._lrot,t):sa.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)},i.setRotationFromEuler=function(t,e,i){var n=void 0===i?this._euler.z:i;void 0===e?(js.copy(this._euler,t),sa.fromEuler(this._lrot,t.x,t.y,t.z)):(js.set(this._euler,t,e,n),sa.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)},i.getRotation=function(t){return t?sa.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):sa.copy(new sa,this._lrot)},i.setScale=function(t,e,i){void 0===e&&void 0===i?js.copy(this._lscale,t):void 0===i?js.set(this._lscale,t,e,this._lscale.z):js.set(this._lscale,t,e,i),this.invalidateChildren(gp.SCALE),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.SCALE)},i.getScale=function(t){return t?js.set(t,this._lscale.x,this._lscale.y,this._lscale.z):js.copy(new js,this._lscale)},i.inverseTransformPoint=function(t,e){js.copy(t,e);for(var i=this,n=0;i._parent;)Lp[n++]=i,i=i._parent;for(;n>=0;)js.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=Lp[--n];return t},i.setWorldPosition=function(t,e,i){void 0===e||void 0===i?js.copy(this._pos,t):js.set(this._pos,t,e,i);var n=this._parent,r=this._lpos;n?(n.updateWorldTransform(),js.transformMat4(r,this._pos,da.invert(Fp,n._mat))):js.copy(r,this._pos),this.invalidateChildren(gp.POSITION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.POSITION)},i.getWorldPosition=function(t){return this.updateWorldTransform(),t?js.copy(t,this._pos):js.copy(new js,this._pos)},i.setWorldRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?sa.copy(this._rot,t):sa.set(this._rot,t,e,i,n),this._parent?(this._parent.updateWorldTransform(),sa.multiply(this._lrot,sa.conjugate(this._lrot,this._parent._rot),this._rot)):sa.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)},i.setWorldRotationFromEuler=function(t,e,i){sa.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),sa.multiply(this._lrot,sa.conjugate(this._lrot,this._parent._rot),this._rot)):sa.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)},i.getWorldRotation=function(t){return this.updateWorldTransform(),t?sa.copy(t,this._rot):sa.copy(new sa,this._rot)},i.setWorldScale=function(t,e,i){void 0===e||void 0===i?js.copy(this._scale,t):js.set(this._scale,t,e,i);var n=this._parent;n?(n.updateWorldTransform(),ia.fromQuat(Pp,sa.conjugate(Bp,n._rot)),ia.multiplyMat4(Pp,Pp,n._mat),Dp.m00=this._scale.x,Dp.m04=this._scale.y,Dp.m08=this._scale.z,ia.multiply(Pp,Dp,ia.invert(Pp,Pp)),this._lscale.x=js.set(Cp,Pp.m00,Pp.m01,Pp.m02).length(),this._lscale.y=js.set(Cp,Pp.m03,Pp.m04,Pp.m05).length(),this._lscale.z=js.set(Cp,Pp.m06,Pp.m07,Pp.m08).length()):js.copy(this._lscale,this._scale),this.invalidateChildren(gp.SCALE),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.SCALE)},i.getWorldScale=function(t){return this.updateWorldTransform(),t?js.copy(t,this._scale):js.copy(new js,this._scale)},i.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new da;return da.copy(e,this._mat)},i.getWorldRS=function(t){this.updateWorldTransform();var e=t||new da;return da.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},i.getWorldRT=function(t){this.updateWorldTransform();var e=t||new da;return da.fromRT(e,this._rot,this._pos)},i.setRTS=function(t,e,i){var n=0;t&&(n|=gp.ROTATION,void 0!==t.w?(sa.copy(this._lrot,t),this._eulerDirty=!0):(js.copy(this._euler,t),sa.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(js.copy(this._lpos,e),n|=gp.POSITION),i&&(js.copy(this._lscale,i),n|=gp.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,n))},i.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},i.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},e.resetHasChangedFlags=function(){Gp+=1},e.clearNodeArray=function(){e.ClearFrame<e.ClearRound?e.ClearFrame++:(e.ClearFrame=0,Lp.length=0)},i.getPathInHierarchy=function(){for(var t=this.name,i=this.parent;i&&i instanceof e;)t=i.name+"/"+t,i=i.parent;return t},s(e,[{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(sa.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){js.set(this._euler,0,0,t),sa.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(gp.ROTATION),1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){da.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(gp.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(tp.TRANSFORM_CHANGED,gp.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return js.transformQuat(new js,js.FORWARD,this.worldRotation)},set:function(t){var e=t.length();js.multiplyScalar(Cp,t,-1/e),sa.fromViewUp(xp,Cp),this.setWorldRotation(xp)}},{key:"up",get:function(){return js.transformQuat(new js,js.UP,this.worldRotation)}},{key:"right",get:function(){return js.transformQuat(new js,js.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(tp.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._flagChangeVersion===Gp?this._hasChangedFlags:0},set:function(t){this._flagChangeVersion=Gp,this._hasChangedFlags=t}}]),e}(Ip),Op.EventType=tp,Op.NodeSpace=mp,Op.TransformDirtyBit=gp,Op.TransformBit=gp,Op.reserveContentsForAllSyncablePrefabTag=Up,Op.ClearFrame=0,Op.ClearRound=1e3,Sp=Za((Ep=Mp).prototype,"_lpos",[mo],(function(){return new js})),Ap=Za(Ep.prototype,"_lrot",[mo],(function(){return new sa})),Rp=Za(Ep.prototype,"_lscale",[mo],(function(){return new js(1,1,1)})),wp=Za(Ep.prototype,"_layer",[mo],(function(){return $f.Enum.DEFAULT})),bp=Za(Ep.prototype,"_euler",[mo],(function(){return new js})),m(Ep.prototype,"eulerAngles",[yp],Object.getOwnPropertyDescriptor(Ep.prototype,"eulerAngles"),Ep.prototype),Tp=Ep))||Tp));v.Node=kp,Dr.Attr.setClassAttr(Jc,"target","type","Object"),Dr.Attr.setClassAttr(Jc,"target","ctor",kp);var zp=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},e.destroy=function(){},s(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());zp.Priority=Ln({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var Hp,Vp,Wp="MainFlow",Xp="ForwardFlow",jp="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Hp||(Hp={})),v.RenderPassStage=Hp,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Vp||(Vp={}));var Yp,Kp={bindings:[],layouts:{}},qp={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.UBO_CSM=3]="UBO_CSM",t[t.SAMPLER_SHADOWMAP=4]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=5]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_SHADOW_MAP=6]="SAMPLER_SPOT_SHADOW_MAP",t[t.SAMPLER_DIFFUSEMAP=7]="SAMPLER_DIFFUSEMAP",t[t.COUNT=8]="COUNT"}(Yp||(Yp={}));var Qp,Zp=Yp.SAMPLER_SHADOWMAP,Jp=Yp.COUNT-Zp;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Qp||(Qp={}));var $p,tm=Qp.SAMPLER_JOINTS,em=Qp.STORAGE_REFLECTION-tm,im=Qp.COUNT-tm-em;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}($p||($p={}));var nm=new ne([Zp,0,tm],[Jp,0,em],[0,0,0],[0,0,0],[0,0,0],[0,0,im],[0,0,0],[0,2,1]),rm=function(){};rm.SIZE=4*(rm.COUNT=4+(rm.DEBUG_VIEW_COMPOSITE_PACK_3_OFFSET=4+(rm.DEBUG_VIEW_COMPOSITE_PACK_2_OFFSET=4+(rm.DEBUG_VIEW_COMPOSITE_PACK_1_OFFSET=4+(rm.DEBUG_VIEW_MODE_OFFSET=4+(rm.NATIVE_SIZE_OFFSET=4+(rm.SCREEN_SIZE_OFFSET=4+(rm.TIME_OFFSET=0)))))))),rm.NAME="CCGlobal",rm.BINDING=Yp.UBO_GLOBAL,rm.DESCRIPTOR=new De(rm.BINDING,Bt.UNIFORM_BUFFER,1,Et.ALL),rm.LAYOUT=new pe($p.GLOBAL,rm.BINDING,rm.NAME,[new fe("cc_time",nt.FLOAT4,1),new fe("cc_screenSize",nt.FLOAT4,1),new fe("cc_nativeSize",nt.FLOAT4,1),new fe("cc_debug_view_mode",nt.FLOAT,4),new fe("cc_debug_view_composite_pack_1",nt.FLOAT,4),new fe("cc_debug_view_composite_pack_2",nt.FLOAT,4),new fe("cc_debug_view_composite_pack_3",nt.FLOAT,4)],1),Kp.layouts[rm.NAME]=rm.LAYOUT,Kp.bindings[rm.BINDING]=rm.DESCRIPTOR;var sm=function(){};sm.SIZE=4*(sm.COUNT=4+(sm.VIEW_PORT_OFFSET=4+(sm.NEAR_FAR_OFFSET=4+(sm.GLOBAL_FOG_ADD_OFFSET=4+(sm.GLOBAL_FOG_BASE_OFFSET=4+(sm.GLOBAL_FOG_COLOR_OFFSET=4+(sm.AMBIENT_GROUND_OFFSET=4+(sm.AMBIENT_SKY_OFFSET=4+(sm.MAIN_LIT_COLOR_OFFSET=4+(sm.MAIN_LIT_DIR_OFFSET=4+(sm.EXPOSURE_OFFSET=4+(sm.SCREEN_SCALE_OFFSET=4+(sm.SURFACE_TRANSFORM_OFFSET=4+(sm.CAMERA_POS_OFFSET=16+(sm.MAT_VIEW_PROJ_INV_OFFSET=16+(sm.MAT_VIEW_PROJ_OFFSET=16+(sm.MAT_PROJ_INV_OFFSET=16+(sm.MAT_PROJ_OFFSET=16+(sm.MAT_VIEW_INV_OFFSET=16+(sm.MAT_VIEW_OFFSET=0)))))))))))))))))))),sm.NAME="CCCamera",sm.BINDING=Yp.UBO_CAMERA,sm.DESCRIPTOR=new De(sm.BINDING,Bt.UNIFORM_BUFFER,1,Et.ALL),sm.LAYOUT=new pe($p.GLOBAL,sm.BINDING,sm.NAME,[new fe("cc_matView",nt.MAT4,1),new fe("cc_matViewInv",nt.MAT4,1),new fe("cc_matProj",nt.MAT4,1),new fe("cc_matProjInv",nt.MAT4,1),new fe("cc_matViewProj",nt.MAT4,1),new fe("cc_matViewProjInv",nt.MAT4,1),new fe("cc_cameraPos",nt.FLOAT4,1),new fe("cc_surfaceTransform",nt.FLOAT4,1),new fe("cc_screenScale",nt.FLOAT4,1),new fe("cc_exposure",nt.FLOAT4,1),new fe("cc_mainLitDir",nt.FLOAT4,1),new fe("cc_mainLitColor",nt.FLOAT4,1),new fe("cc_ambientSky",nt.FLOAT4,1),new fe("cc_ambientGround",nt.FLOAT4,1),new fe("cc_fogColor",nt.FLOAT4,1),new fe("cc_fogBase",nt.FLOAT4,1),new fe("cc_fogAdd",nt.FLOAT4,1),new fe("cc_nearFar",nt.FLOAT4,1),new fe("cc_viewPort",nt.FLOAT4,1)],1),Kp.layouts[sm.NAME]=sm.LAYOUT,Kp.bindings[sm.BINDING]=sm.DESCRIPTOR;var am=function(){};am.SIZE=4*(am.COUNT=4+(am.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(am.SHADOW_COLOR_OFFSET=4+(am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(am.SHADOW_PROJ_INFO_OFFSET=4+(am.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(am.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(am.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(am.MAT_LIGHT_VIEW_OFFSET=0))))))))))),am.NAME="CCShadow",am.BINDING=Yp.UBO_SHADOW,am.DESCRIPTOR=new De(am.BINDING,Bt.UNIFORM_BUFFER,1,Et.ALL),am.LAYOUT=new pe($p.GLOBAL,am.BINDING,am.NAME,[new fe("cc_matLightView",nt.MAT4,1),new fe("cc_matLightViewProj",nt.MAT4,1),new fe("cc_shadowInvProjDepthInfo",nt.FLOAT4,1),new fe("cc_shadowProjDepthInfo",nt.FLOAT4,1),new fe("cc_shadowProjInfo",nt.FLOAT4,1),new fe("cc_shadowNFLSInfo",nt.FLOAT4,1),new fe("cc_shadowWHPBInfo",nt.FLOAT4,1),new fe("cc_shadowLPNNInfo",nt.FLOAT4,1),new fe("cc_shadowColor",nt.FLOAT4,1),new fe("cc_planarNDInfo",nt.FLOAT4,1)],1),Kp.layouts[am.NAME]=am.LAYOUT,Kp.bindings[am.BINDING]=am.DESCRIPTOR;var om=function(){};om.CSM_LEVEL_COUNT=4,om.SIZE=4*(om.COUNT=4+(om.CSM_SPLITS_INFO_OFFSET=(om.CSM_PROJ_INFO_OFFSET=(om.CSM_PROJ_DEPTH_INFO_OFFSET=(om.MAT_CSM_VIEW_PROJ_OFFSET=(om.CSM_ATLAS_OFFSET=(om.CSM_VIEW_DIR_2_OFFSET=(om.CSM_VIEW_DIR_1_OFFSET=(om.CSM_VIEW_DIR_0_OFFSET=0)+4*om.CSM_LEVEL_COUNT)+4*om.CSM_LEVEL_COUNT)+4*om.CSM_LEVEL_COUNT)+4*om.CSM_LEVEL_COUNT)+16*om.CSM_LEVEL_COUNT)+4*om.CSM_LEVEL_COUNT)+4*om.CSM_LEVEL_COUNT)),om.NAME="CCCSM",om.BINDING=Yp.UBO_CSM,om.DESCRIPTOR=new De(om.BINDING,Bt.UNIFORM_BUFFER,1,Et.ALL),om.LAYOUT=new pe($p.GLOBAL,om.BINDING,om.NAME,[new fe("cc_csmViewDir0",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmViewDir1",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmViewDir2",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmAtlas",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_matCSMViewProj",nt.MAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmProjDepthInfo",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmProjInfo",nt.FLOAT4,om.CSM_LEVEL_COUNT),new fe("cc_csmSplitsInfo",nt.FLOAT4,1)],1),Kp.layouts[om.NAME]=om.LAYOUT,Kp.bindings[om.BINDING]=om.DESCRIPTOR;var um=Yp.SAMPLER_SHADOWMAP,hm=new De(um,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),cm=new me($p.GLOBAL,um,"cc_shadowMap",nt.SAMPLER2D,1);Kp.layouts.cc_shadowMap=cm,Kp.bindings[um]=hm;var lm=Yp.SAMPLER_ENVIRONMENT,_m=new De(lm,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),dm=new me($p.GLOBAL,lm,"cc_environment",nt.SAMPLER_CUBE,1);Kp.layouts.cc_environment=dm,Kp.bindings[lm]=_m;var fm=Yp.SAMPLER_DIFFUSEMAP,pm=new De(fm,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),mm=new me($p.GLOBAL,fm,"cc_diffuseMap",nt.SAMPLER_CUBE,1);Kp.layouts.cc_diffuseMap=mm,Kp.bindings[fm]=pm;var gm=Yp.SAMPLER_SPOT_SHADOW_MAP,vm=new De(gm,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),ym=new me($p.GLOBAL,gm,"cc_spotShadowMap",nt.SAMPLER2D,1);Kp.layouts.cc_spotShadowMap=ym,Kp.bindings[gm]=vm;var Tm=function(){};Tm.SIZE=4*(Tm.COUNT=4+(Tm.LOCAL_SHADOW_BIAS=4+(Tm.LIGHTINGMAP_UVPARAM=16+(Tm.MAT_WORLD_IT_OFFSET=16+(Tm.MAT_WORLD_OFFSET=0))))),Tm.NAME="CCLocal",Tm.BINDING=Qp.UBO_LOCAL,Tm.DESCRIPTOR=new De(Tm.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX|Et.COMPUTE),Tm.LAYOUT=new pe($p.LOCAL,Tm.BINDING,Tm.NAME,[new fe("cc_matWorld",nt.MAT4,1),new fe("cc_matWorldIT",nt.MAT4,1),new fe("cc_lightingMapUVParam",nt.FLOAT4,1),new fe("cc_localShadowBias",nt.FLOAT4,1)],1),qp.layouts[Tm.NAME]=Tm.LAYOUT,qp.bindings[Tm.BINDING]=Tm.DESCRIPTOR;var Em=function(){};Em.SIZE=4*(Em.COUNT=4+(Em.WORLD_BOUND_HALF_EXTENTS=4+(Em.WORLD_BOUND_CENTER=0))),Em.NAME="CCWorldBound",Em.BINDING=Qp.UBO_LOCAL,Em.DESCRIPTOR=new De(Em.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX|Et.COMPUTE),Em.LAYOUT=new pe($p.LOCAL,Em.BINDING,Em.NAME,[new fe("cc_worldBoundCenter",nt.FLOAT4,1),new fe("cc_worldBoundHalfExtents",nt.FLOAT4,1)],1),qp.layouts[Em.NAME]=Em.LAYOUT,qp.bindings[Em.BINDING]=Em.DESCRIPTOR;var Sm="a_matWorld0",Am=function(){};Am.BATCHING_COUNT=10,Am.MAT_WORLDS_OFFSET=0,Am.SIZE=4*(Am.COUNT=16*Am.BATCHING_COUNT),Am.NAME="CCLocalBatched",Am.BINDING=Qp.UBO_LOCAL,Am.DESCRIPTOR=new De(Am.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX|Et.COMPUTE),Am.LAYOUT=new pe($p.LOCAL,Am.BINDING,Am.NAME,[new fe("cc_matWorlds",nt.MAT4,Am.BATCHING_COUNT)],1),qp.layouts[Am.NAME]=Am.LAYOUT,qp.bindings[Am.BINDING]=Am.DESCRIPTOR;var Rm=function(){};Rm.LIGHTS_PER_PASS=1,Rm.SIZE=4*(Rm.COUNT=(Rm.LIGHT_DIR_OFFSET=(Rm.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(Rm.LIGHT_COLOR_OFFSET=(Rm.LIGHT_POS_OFFSET=0)+4*Rm.LIGHTS_PER_PASS)+4*Rm.LIGHTS_PER_PASS)+4*Rm.LIGHTS_PER_PASS)+4*Rm.LIGHTS_PER_PASS),Rm.NAME="CCForwardLight",Rm.BINDING=Qp.UBO_FORWARD_LIGHTS,Rm.DESCRIPTOR=new De(Rm.BINDING,Bt.DYNAMIC_UNIFORM_BUFFER,1,Et.FRAGMENT),Rm.LAYOUT=new pe($p.LOCAL,Rm.BINDING,Rm.NAME,[new fe("cc_lightPos",nt.FLOAT4,Rm.LIGHTS_PER_PASS),new fe("cc_lightColor",nt.FLOAT4,Rm.LIGHTS_PER_PASS),new fe("cc_lightSizeRangeAngle",nt.FLOAT4,Rm.LIGHTS_PER_PASS),new fe("cc_lightDir",nt.FLOAT4,Rm.LIGHTS_PER_PASS)],1),qp.layouts[Rm.NAME]=Rm.LAYOUT,qp.bindings[Rm.BINDING]=Rm.DESCRIPTOR;var wm=function(){};wm.LIGHTS_PER_PASS=10;var bm=function(){};bm.SIZE=4*(bm.COUNT=4+(bm.JOINTS_TEXTURE_INFO_OFFSET=0)),bm.NAME="CCSkinningTexture",bm.BINDING=Qp.UBO_SKINNING_TEXTURE,bm.DESCRIPTOR=new De(bm.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX),bm.LAYOUT=new pe($p.LOCAL,bm.BINDING,bm.NAME,[new fe("cc_jointTextureInfo",nt.FLOAT4,1)],1),qp.layouts[bm.NAME]=bm.LAYOUT,qp.bindings[bm.BINDING]=bm.DESCRIPTOR;var Om=function(){};Om.SIZE=4*(Om.COUNT=4+(Om.JOINTS_ANIM_INFO_OFFSET=0)),Om.NAME="CCSkinningAnimation",Om.BINDING=Qp.UBO_SKINNING_ANIMATION,Om.DESCRIPTOR=new De(Om.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX),Om.LAYOUT=new pe($p.LOCAL,Om.BINDING,Om.NAME,[new fe("cc_jointAnimInfo",nt.FLOAT4,1)],1),qp.layouts[Om.NAME]=Om.LAYOUT,qp.bindings[Om.BINDING]=Om.DESCRIPTOR;var Mm="a_jointAnimInfo",Im=function(){function t(){}return t.initLayout=function(e){t._jointUniformCapacity=e,t._count=12*e,t._size=4*t._count,t.LAYOUT.members[0].count=3*e},s(t,null,[{key:"JOINT_UNIFORM_CAPACITY",get:function(){return t._jointUniformCapacity}},{key:"COUNT",get:function(){return t._count}},{key:"SIZE",get:function(){return t._size}}]),t}();function Cm(t){Im.initLayout(t),qp.layouts[Im.NAME]=Im.LAYOUT,qp.bindings[Im.BINDING]=Im.DESCRIPTOR}Im._jointUniformCapacity=0,Im._count=0,Im._size=0,Im.NAME="CCSkinning",Im.BINDING=Qp.UBO_SKINNING_TEXTURE,Im.DESCRIPTOR=new De(Im.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX),Im.LAYOUT=new pe($p.LOCAL,Im.BINDING,Im.NAME,[new fe("cc_joints",nt.FLOAT4,1)],1);var xm=function(){};xm.MAX_MORPH_TARGET_COUNT=60,xm.OFFSET_OF_WEIGHTS=0,xm.OFFSET_OF_VERTICES_COUNT=4+(xm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(xm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*xm.MAX_MORPH_TARGET_COUNT)),xm.COUNT_BASE_4_BYTES=4*Math.ceil(xm.MAX_MORPH_TARGET_COUNT/4)+4,xm.SIZE=4*xm.COUNT_BASE_4_BYTES,xm.NAME="CCMorph",xm.BINDING=Qp.UBO_MORPH,xm.DESCRIPTOR=new De(xm.BINDING,Bt.UNIFORM_BUFFER,1,Et.VERTEX),xm.LAYOUT=new pe($p.LOCAL,xm.BINDING,xm.NAME,[new fe("cc_displacementWeights",nt.FLOAT4,xm.MAX_MORPH_TARGET_COUNT/4),new fe("cc_displacementTextureInfo",nt.FLOAT4,1)],1),qp.layouts[xm.NAME]=xm.LAYOUT,qp.bindings[xm.BINDING]=xm.DESCRIPTOR;var Nm=function(){};Nm.NAME="CCUILocal",Nm.BINDING=Qp.UBO_UI_LOCAL,Nm.DESCRIPTOR=new De(Nm.BINDING,Bt.DYNAMIC_UNIFORM_BUFFER,1,Et.VERTEX),Nm.LAYOUT=new pe($p.LOCAL,Nm.BINDING,Nm.NAME,[new fe("cc_local_data",nt.FLOAT4,1)],1),qp.layouts[Nm.NAME]=Nm.LAYOUT,qp.bindings[Nm.BINDING]=Nm.DESCRIPTOR;var Bm=Qp.SAMPLER_JOINTS,Pm=new De(Bm,Bt.SAMPLER_TEXTURE,1,Et.VERTEX),Dm=new me($p.LOCAL,Bm,"cc_jointTexture",nt.SAMPLER2D,1);qp.layouts.cc_jointTexture=Dm,qp.bindings[Bm]=Pm;var Fm=Qp.SAMPLER_JOINTS,Lm=new De(Fm,Bt.SAMPLER_TEXTURE,1,Et.VERTEX),Um=new me($p.LOCAL,Fm,"cc_realtimeJoint",nt.SAMPLER2D,1);qp.layouts.cc_realtimeJoint=Um,qp.bindings[Fm]=Lm;var Gm=Qp.SAMPLER_MORPH_POSITION,km=new De(Gm,Bt.SAMPLER_TEXTURE,1,Et.VERTEX),zm=new me($p.LOCAL,Gm,"cc_PositionDisplacements",nt.SAMPLER2D,1);qp.layouts.cc_PositionDisplacements=zm,qp.bindings[Gm]=km;var Hm=Qp.SAMPLER_MORPH_NORMAL,Vm=new De(Hm,Bt.SAMPLER_TEXTURE,1,Et.VERTEX),Wm=new me($p.LOCAL,Hm,"cc_NormalDisplacements",nt.SAMPLER2D,1);qp.layouts.cc_NormalDisplacements=Wm,qp.bindings[Hm]=Vm;var Xm=Qp.SAMPLER_MORPH_TANGENT,jm=new De(Xm,Bt.SAMPLER_TEXTURE,1,Et.VERTEX),Ym=new me($p.LOCAL,Xm,"cc_TangentDisplacements",nt.SAMPLER2D,1);qp.layouts.cc_TangentDisplacements=Ym,qp.bindings[Xm]=jm;var Km=Qp.SAMPLER_LIGHTMAP,qm=new De(Km,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),Qm=new me($p.LOCAL,Km,"cc_lightingMap",nt.SAMPLER2D,1);qp.layouts.cc_lightingMap=Qm,qp.bindings[Km]=qm;var Zm=Qp.SAMPLER_SPRITE,Jm=new De(Zm,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),$m=new me($p.LOCAL,Zm,"cc_spriteTexture",nt.SAMPLER2D,1);qp.layouts.cc_spriteTexture=$m,qp.bindings[Zm]=Jm;var tg=Qp.SAMPLER_REFLECTION,eg=new De(tg,Bt.SAMPLER_TEXTURE,1,Et.FRAGMENT),ig=new me($p.LOCAL,tg,"cc_reflectionTexture",nt.SAMPLER2D,1);qp.layouts.cc_reflectionTexture=ig,qp.bindings[tg]=eg;var ng=Qp.STORAGE_REFLECTION,rg=new De(ng,Bt.STORAGE_IMAGE,1,Et.COMPUTE),sg=new ye($p.LOCAL,ng,"cc_reflectionStorage",nt.IMAGE2D,1);qp.layouts.cc_reflectionStorage=sg,qp.bindings[ng]=rg;var ag,og,ug,hg,cg,lg,_g,dg=$f.makeMaskExclude([$f.BitMask.UI_2D,$f.BitMask.GIZMOS,$f.BitMask.EDITOR,$f.BitMask.SCENE_GIZMO,$f.BitMask.PROFILER]),fg=$f.makeMaskExclude([$f.BitMask.UI_2D,$f.BitMask.PROFILER]),pg=$f.Enum.ALL;function mg(t){return(t.getFormatFeatures(et.R32F)&(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE))==(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE)&&!(t.gfxAPI===J.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Wp,PIPELINE_FLOW_FORWARD:Xp,PIPELINE_FLOW_SHADOW:jp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Hp},get RenderPriority(){return Vp},globalDescriptorSetLayout:Kp,localDescriptorSetLayout:qp,get PipelineGlobalBindings(){return Yp},get ModelLocalBindings(){return Qp},get SetIndex(){return $p},bindingMappingInfo:nm,UBOGlobal:rm,UBOCamera:sm,UBOShadow:am,UBOCSM:om,UNIFORM_SHADOWMAP_BINDING:um,UNIFORM_ENVIRONMENT_BINDING:lm,UNIFORM_DIFFUSEMAP_BINDING:fm,UNIFORM_SPOT_SHADOW_MAP_TEXTURE_BINDING:gm,UBOLocal:Tm,UBOWorldBound:Em,INST_MAT_WORLD:Sm,UBOLocalBatched:Am,UBOForwardLight:Rm,UBODeferredLight:wm,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:bm,UBOSkinningAnimation:Om,INST_JOINT_ANIM_INFO:Mm,UBOSkinning:Im,localDescriptorSetLayout_ResizeMaxJoints:Cm,UBOMorph:xm,UBOUILocal:Nm,UNIFORM_JOINT_TEXTURE_BINDING:Bm,UNIFORM_REALTIME_JOINT_TEXTURE_BINDING:Fm,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Gm,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Hm,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Xm,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Km,UNIFORM_SPRITE_TEXTURE_BINDING:Zm,UNIFORM_REFLECTION_TEXTURE_BINDING:tg,UNIFORM_REFLECTION_STORAGE_BINDING:ng,CAMERA_DEFAULT_MASK:dg,CAMERA_EDITOR_MASK:fg,MODEL_ALWAYS_MASK:pg,supportsR16HalfFloatTexture:function(t){return(t.getFormatFeatures(et.R16F)&(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE))==(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE)},supportsR32FloatTexture:mg})),function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(ag||(ag={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(og||(og={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(ug||(ug={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(hg||(hg={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(cg||(cg={})),function(t){t[t.DEFAULT=-1]="DEFAULT",t[t.LEFT_EYE=0]="LEFT_EYE",t[t.RIGHT_EYE=1]="RIGHT_EYE",t[t.MAIN=2]="MAIN"}(lg||(lg={})),function(t){t[t.NO_TRACKING=0]="NO_TRACKING",t[t.POSITION_AND_ROTATION=1]="POSITION_AND_ROTATION",t[t.POSITION=2]="POSITION",t[t.ROTATION=3]="ROTATION"}(_g||(_g={}));var gg,vg,yg,Tg,Eg,Sg,Ag,Rg,wg,bg,Og,Mg,Ig,Cg,xg,Ng,Bg,Pg,Dg,Fg,Lg,Ug,Gg,kg,zg,Hg,Vg,Wg,Xg,jg,Yg,Kg,qg,Qg,Zg,Jg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],$g=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],tv=[100,200,400,800],ev=new js,iv=new js,nv=new da,rv=Lt.STENCIL<<1,sv=[],av=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=ag.VERTICAL,this._fov=bs(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new ie(.2,.2,.2,1),this._viewport=new Ta(0,0,1,1),this._orientedViewport=new Ta(0,0,1,1),this._curTransform=$.IDENTITY,this._isProjDirty=!0,this._matView=new da,this._matProj=new da,this._matProjInv=new da,this._matViewProj=new da,this._matViewProjInv=new da,this._frustum=new vc,this._forward=new js,this._position=new js,this._priority=0,this._aperture=ug.F16_0,this._apertureValue=void 0,this._shutter=cg.D125,this._shutterValue=0,this._iso=hg.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Lt.NONE,this._clearDepth=1,this._visibility=dg,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._cameraType=lg.DEFAULT,this._trackingType=_g.NO_TRACKING,this._device=t,this._apertureValue=Jg[this._aperture],this._shutterValue=$g[this._shutter],this._isoValue=tv[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!sv.length){var e=t.capabilities.clipSpaceSignY;sv[$.IDENTITY]=new da(1,0,0,0,0,e),sv[$.ROTATE_90]=new da(0,1,0,0,-e,0),sv[$.ROTATE_180]=new da(-1,0,0,0,0,-e),sv[$.ROTATE_270]=new da(0,-1,0,0,e,0)}}var e=t.prototype;return e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||$.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e.initialize=function(t){void 0!==t.trackingType&&(this._trackingType=t.trackingType),void 0!==t.cameraType&&(this._cameraType=t.cameraType),this.node=t.node,this._width=1,this._height=1,this.clearFlag=Lt.NONE,this.clearDepth=1,this.visibility=dg,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e.destroy=function(){var t;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null===(t=this._geometryRenderer)||void 0===t||t.destroy()},e.attachToScene=function(t){this._enabled=!0,this._scene=t},e.detachFromScene=function(){this._enabled=!1,this._scene=null},e.resize=function(t,e){this._window&&(this._width=t,this._width=t,this._height=e,this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0)},e.setFixedSize=function(t,e){this._width=t,this._height=e,this._updateAspect(),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var i=!1;(this._node.hasChangedFlags||t)&&(da.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,da.multiply(this._matView,(new da).scale(this._node.worldScale),this._matView),this._node.getWorldPosition(this._position),i=!0);var n=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=n&&n.surfaceTransform||$.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var s=this._device.capabilities.clipSpaceSignY;if(this._proj===og.PERSPECTIVE)da.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===ag.VERTICAL,this._device.capabilities.clipSpaceMinZ,s,r);else{var a=this._orthoHeight*this._aspect,o=this._orthoHeight;da.ortho(this._matProj,-a,a,-o,o,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,s,r)}da.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(da.multiply(this._matViewProj,this._matProj,this._matView),da.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,i=t.x,n=t.width,r=t.height,s=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||$.IDENTITY){case $.ROTATE_90:this._viewport.x=1-s-r,this._viewport.y=i,this._viewport.width=r,this._viewport.height=n;break;case $.ROTATE_180:this._viewport.x=1-i-n,this._viewport.y=1-s-r,this._viewport.width=n,this._viewport.height=r;break;case $.ROTATE_270:this._viewport.x=s,this._viewport.y=1-i-n,this._viewport.width=r,this._viewport.height=n;break;case $.IDENTITY:this._viewport.x=i,this._viewport.y=s,this._viewport.width=n,this._viewport.height=r}this._orientedViewport.x=i,this._orientedViewport.y=s,this._orientedViewport.width=n,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.initGeometryRenderer=function(){var t;this._geometryRenderer||(this._geometryRenderer=v.internal.GeometryRenderer?new v.internal.GeometryRenderer:null,null===(t=this._geometryRenderer)||void 0===t||t.activate(this._device))},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||v.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var i=e.swapchain;(i&&i.surfaceTransform||$.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,i){if(!this._node)return null;var n=this.width,r=this.height,s=this._orientedViewport.x*n,a=this._orientedViewport.y*r,o=this._orientedViewport.width*n,u=this._orientedViewport.height*r,h=this._proj===og.PERSPECTIVE,c=this._device.capabilities.clipSpaceSignY,l=_a[this._curTransform];js.set(ev,(e-s)/o*2-1,(i-a)/u*2-1,h?1:-1);var _=ev.x,d=ev.y;return ev.x=_*l[0]+d*l[2]*c,ev.y=_*l[1]+d*l[3]*c,js.transformMat4(h?ev:t.o,ev,this._matViewProjInv),h?(this._node.getWorldPosition(iv),Du.fromPoints(t,iv,ev)):js.transformQuat(t.d,js.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var i=this.width,n=this.height,r=this._orientedViewport.x*i,s=this._orientedViewport.y*n,a=this._orientedViewport.width*i,o=this._orientedViewport.height*n,u=this._device.capabilities.clipSpaceSignY,h=_a[this._curTransform];if(this._proj===og.PERSPECTIVE){js.set(t,(e.x-r)/a*2-1,(e.y-s)/o*2-1,1);var c=t.x,l=t.y;t.x=c*h[0]+l*h[2]*u,t.y=c*h[1]+l*h[3]*u,js.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(ev),js.lerp(t,ev,t,ws(this._nearClip/this._farClip,1,e.z))}else{js.set(t,(e.x-r)/a*2-1,(e.y-s)/o*2-1,2*e.z-1);var _=t.x,d=t.y;t.x=_*h[0]+d*h[2]*u,t.y=_*h[1]+d*h[3]*u,js.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var i=this._device.capabilities.clipSpaceSignY,n=_a[this._curTransform];js.transformMat4(t,e,this._matViewProj);var r=t.x,s=t.y;t.x=r*n[0]+s*n[2]*i,t.y=r*n[1]+s*n[3]*i;var a=this.width,o=this.height,u=this._orientedViewport.x*a,h=this._orientedViewport.y*o,c=this._orientedViewport.width*a,l=this._orientedViewport.height*o;return t.x=u+.5*(t.x+1)*c,t.y=h+.5*(t.y+1)*l,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,i,n){da.multiply(t,this._matViewProj,e),da.multiply(t,sv[this._curTransform],t);var r=i/2,s=n/2;return da.identity(nv),da.transform(nv,nv,js.set(ev,r,s,0)),da.scale(nv,nv,js.set(ev,r,s,1)),da.multiply(t,nv,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},s(t,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=Jg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=$g[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=tv[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(t){G(8302),this.setViewportInOrientedSpace(t)}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"surfaceTransform",get:function(){return this._curTransform}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"cameraType",get:function(){return this._cameraType},set:function(t){this._cameraType=t}},{key:"trackingType",get:function(){return this._trackingType},set:function(t){this._trackingType=t}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),ov=new js,uv=Ln(og),hv=Ln(ag),cv=Ln(ug),lv=Ln(cg),_v=Ln(hg),dv=Ln({SKYBOX:rv|Lt.DEPTH_STENCIL,SOLID_COLOR:Lt.ALL,DEPTH_ONLY:Lt.DEPTH_STENCIL,DONT_CLEAR:Lt.NONE}),fv=t("Camera",(gg=ao("cc.Camera"),vg=xo($f.BitMask),yg=xo(dv),Tg=xo(uv),Eg=xo(hv),Sg=xo(cv),Ag=xo(lv),Rg=xo(_v),wg=xo(Pf),gg((qg=Kg=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._projection=Mg&&Mg(),e._priority=Ig&&Ig(),e._fov=Cg&&Cg(),e._fovAxis=xg&&xg(),e._orthoHeight=Ng&&Ng(),e._near=Bg&&Bg(),e._far=Pg&&Pg(),e._color=Dg&&Dg(),e._depth=Fg&&Fg(),e._stencil=Lg&&Lg(),e._clearFlags=Ug&&Ug(),e._rect=Gg&&Gg(),e._aperture=kg&&kg(),e._shutter=zg&&zg(),e._iso=Hg&&Hg(),e._screenScale=Vg&&Vg(),e._visibility=Wg&&Wg(),e._targetTexture=Xg&&Xg(),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e._cameraType=jg&&jg(),e._trackingType=Yg&&Yg(),e}o(e,t);var i=e.prototype;return i.onLoad=function(){this._createCamera()},i.onEnable=function(){this.node.hasChangedFlags|=gp.POSITION,this._camera&&this._attachToScene()},i.onDisable=function(){this._camera&&this._detachFromScene()},i.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},i.screenPointToRay=function(t,e,i){return i||(i=Du.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i},i.worldToScreen=function(t,e){return e||(e=new js),this._camera&&this._camera.worldToScreen(e,t),e},i.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},i.convertToUINode=function(t,e,i){if(i||(i=new js),!this._camera)return i;this.worldToScreen(t,ov);var n=e.getComponent("cc.UITransform"),r=v.view.getVisibleSize(),s=ov.x-.5*this._camera.width,a=ov.y-.5*this._camera.height;return ov.x=s/v.view.getScaleX()+.5*r.width,ov.y=a/v.view.getScaleY()+.5*r.height,n&&n.convertToNodeSpaceAR(ov,i),i},i._createCamera=function(){this._camera||(this._camera=v.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?v.director.root&&v.director.root.mainWindow:v.director.root&&v.director.root.tempWindow,priority:this._priority,cameraType:this.cameraType,trackingType:this.trackingType}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=bs(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},i._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},i._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},i._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},i._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},s(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===ag.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=bs(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var i=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(i),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?v.director.root&&v.director.root.mainWindow:v.director.root&&v.director.root.tempWindow)}},{key:"cameraType",get:function(){return this._cameraType},set:function(t){this._cameraType!==t&&(this._cameraType=t,this.camera&&(this.camera.cameraType=t))}},{key:"trackingType",get:function(){return this._trackingType},set:function(t){this._trackingType!==t&&(this._trackingType=t,this.camera&&(this.camera.trackingType=t))}}]),e}(el),Kg.ProjectionType=uv,Kg.FOVAxis=hv,Kg.ClearFlag=dv,Kg.Aperture=cv,Kg.Shutter=lv,Kg.ISO=_v,Kg.TARGET_TEXTURE_CHANGE="tex-change",Mg=Za((Og=qg).prototype,"_projection",[mo],(function(){return uv.PERSPECTIVE})),Ig=Za(Og.prototype,"_priority",[mo],(function(){return 0})),Cg=Za(Og.prototype,"_fov",[mo],(function(){return 45})),xg=Za(Og.prototype,"_fovAxis",[mo],(function(){return hv.VERTICAL})),Ng=Za(Og.prototype,"_orthoHeight",[mo],(function(){return 10})),Bg=Za(Og.prototype,"_near",[mo],(function(){return 1})),Pg=Za(Og.prototype,"_far",[mo],(function(){return 1e3})),Dg=Za(Og.prototype,"_color",[mo],(function(){return new Aa("#333333")})),Fg=Za(Og.prototype,"_depth",[mo],(function(){return 1})),Lg=Za(Og.prototype,"_stencil",[mo],(function(){return 0})),Ug=Za(Og.prototype,"_clearFlags",[mo],(function(){return dv.SOLID_COLOR})),Gg=Za(Og.prototype,"_rect",[mo],(function(){return new Ta(0,0,1,1)})),kg=Za(Og.prototype,"_aperture",[mo],(function(){return cv.F16_0})),zg=Za(Og.prototype,"_shutter",[mo],(function(){return lv.D125})),Hg=Za(Og.prototype,"_iso",[mo],(function(){return _v.ISO100})),Vg=Za(Og.prototype,"_screenScale",[mo],(function(){return 1})),Wg=Za(Og.prototype,"_visibility",[mo],(function(){return dg})),Xg=Za(Og.prototype,"_targetTexture",[mo],(function(){return null})),jg=Za(Og.prototype,"_cameraType",[mo],(function(){return lg.DEFAULT})),Yg=Za(Og.prototype,"_trackingType",[mo],(function(){return _g.NO_TRACKING})),m(Og.prototype,"visibility",[vg],Object.getOwnPropertyDescriptor(Og.prototype,"visibility"),Og.prototype),m(Og.prototype,"clearFlags",[yg],Object.getOwnPropertyDescriptor(Og.prototype,"clearFlags"),Og.prototype),m(Og.prototype,"projection",[Tg],Object.getOwnPropertyDescriptor(Og.prototype,"projection"),Og.prototype),m(Og.prototype,"fovAxis",[Eg],Object.getOwnPropertyDescriptor(Og.prototype,"fovAxis"),Og.prototype),m(Og.prototype,"aperture",[Sg],Object.getOwnPropertyDescriptor(Og.prototype,"aperture"),Og.prototype),m(Og.prototype,"shutter",[Ag],Object.getOwnPropertyDescriptor(Og.prototype,"shutter"),Og.prototype),m(Og.prototype,"iso",[Rg],Object.getOwnPropertyDescriptor(Og.prototype,"iso"),Og.prototype),m(Og.prototype,"targetTexture",[wg],Object.getOwnPropertyDescriptor(Og.prototype,"targetTexture"),Og.prototype),bg=Og))||bg));v.Camera=fv;var pv=4227858432,mv=66060288,gv=1044480,vv=function(t,e,i,n){return void 0===n&&(n=0),e<<26&pv|t<<20&mv|i<<12&gv|4095&n},yv=function(t){return(t&pv)>>>26},Tv=function(t){return(t&mv)>>>20},Ev=function(t){return(t&gv)>>>12},Sv=function(t){return 4095&t},Av=function(t,e){return 67108863&t|e<<26&pv},Rv=((Qg={})[nt.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Qg[nt.INT]=function(t,e,i){return void 0===i&&(i=0),t[i]},Qg[nt.INT2]=function(t,e,i){return void 0===i&&(i=0),Qs.fromArray(e,t,i)},Qg[nt.INT3]=function(t,e,i){return void 0===i&&(i=0),js.fromArray(e,t,i)},Qg[nt.INT4]=function(t,e,i){return void 0===i&&(i=0),ta.fromArray(e,t,i)},Qg[nt.FLOAT]=function(t,e,i){return void 0===i&&(i=0),t[i]},Qg[nt.FLOAT2]=function(t,e,i){return void 0===i&&(i=0),Qs.fromArray(e,t,i)},Qg[nt.FLOAT3]=function(t,e,i){return void 0===i&&(i=0),js.fromArray(e,t,i)},Qg[nt.FLOAT4]=function(t,e,i){return void 0===i&&(i=0),ta.fromArray(e,t,i)},Qg[nt.MAT3]=function(t,e,i){return void 0===i&&(i=0),ia.fromArray(e,t,i)},Qg[nt.MAT4]=function(t,e,i){return void 0===i&&(i=0),da.fromArray(e,t,i)},Qg),wv=((Zg={})[nt.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Zg[nt.INT]=function(t,e,i){return void 0===i&&(i=0),t[i]=e},Zg[nt.INT2]=function(t,e,i){return void 0===i&&(i=0),Qs.toArray(t,e,i)},Zg[nt.INT3]=function(t,e,i){return void 0===i&&(i=0),js.toArray(t,e,i)},Zg[nt.INT4]=function(t,e,i){return void 0===i&&(i=0),ta.toArray(t,e,i)},Zg[nt.FLOAT]=function(t,e,i){return void 0===i&&(i=0),t[i]=e},Zg[nt.FLOAT2]=function(t,e,i){return void 0===i&&(i=0),Qs.toArray(t,e,i)},Zg[nt.FLOAT3]=function(t,e,i){return void 0===i&&(i=0),js.toArray(t,e,i)},Zg[nt.FLOAT4]=function(t,e,i){return void 0===i&&(i=0),ta.toArray(t,e,i)},Zg[nt.MAT3]=function(t,e,i){return void 0===i&&(i=0),ia.toArray(t,e,i)},Zg[nt.MAT4]=function(t,e,i){return void 0===i&&(i=0),da.toArray(t,e,i)},Zg),bv=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Ov(t){switch(t){case nt.BOOL:case nt.INT:case nt.UINT:case nt.FLOAT:return bv[0];case nt.BOOL2:case nt.INT2:case nt.UINT2:case nt.FLOAT2:return bv[1];case nt.BOOL4:case nt.INT4:case nt.UINT4:case nt.FLOAT4:return bv[2];case nt.MAT4:return bv[3];case nt.SAMPLER2D:return"default-texture";case nt.SAMPLER_CUBE:return"default-cube-texture";case nt.SAMPLER2D_ARRAY:return"default-array-texture";case nt.SAMPLER3D:return"default-3d-texture"}return bv[0]}function Mv(t){switch(t){case nt.SAMPLER2D:return"-texture";case nt.SAMPLER_CUBE:return"-cube-texture";case nt.SAMPLER2D_ARRAY:return"-array-texture";case nt.SAMPLER3D:return"-3d-texture";default:return"-unknown"}}function Iv(t,e){for(var i=Object.entries(e),n=!1,r=0;r<i.length;r++)t[i[r][0]]!==i[r][1]&&(t[i[r][0]]=i[r][1],n=!0);return n}var Cv=new Fe;function xv(t){return Math.ceil(Math.log2(Math.max(t,2)))}function Nv(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function Bv(t,e,i,n,r){for(var s=t.builtins[n],a=[],o=function(t){var e=s.blocks[t],n=i.layouts[e.name],o=n&&i.bindings.find((function(t){return t.binding===n.binding}));if(!(n&&o&&o.descriptorType&qe))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(n),r&&!r.includes(o)&&r.push(o)},u=0;u<s.blocks.length;u++)o(u);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var h=[],c=function(t){var e=s.samplerTextures[t],n=i.layouts[e.name],a=n&&i.bindings.find((function(t){return t.binding===n.binding}));if(!(n&&a&&a.descriptorType&Qe))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";h.push(n),r&&!r.includes(a)&&r.push(a)},l=0;l<s.samplerTextures.length;l++)c(l);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,h),r&&r.sort((function(t,e){return t.binding-e.binding}))}function Pv(t){return t.members.reduce((function(t,e){return t+ni(e.type)*e.count}),0)}function Dv(t,e){for(var i=0;i<t.length;i++){var n=t[i];if("!"===n[0]){if(e[n.slice(1)])return!1}else if(!e[n])return!1}return!0}function Fv(t){switch(t.gfxAPI){case J.GLES2:case J.WEBGL:return"glsl1";case J.GLES3:case J.WEBGL2:return"glsl3";default:return"glsl4"}}var Lv,Uv,Gv,kv,zv,Hv,Vv,Wv,Xv=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var i=0;i<t.techniques.length;i++)for(var n=t.techniques[i],r=0;r<n.passes.length;r++){var s=n.passes[r];void 0!==s.propertyIndex&&void 0===s.properties&&(s.properties=n.passes[s.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var i=a({},t),n=0,r=function(t){var e=i.defines[t],r=1;if("number"===e.type){var s=e.range;r=xv(s[1]-s[0]+1),e._map=function(t){return t-s[0]}}else"string"===e.type?(r=xv(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=n,n+=r},s=0;s<i.defines.length;s++)r(s);for(var o in n>31&&(i.uber=!0),i.constantMacros="",i.builtins.statistics)i.constantMacros+="#define "+o+" "+i.builtins.statistics[o]+"\n";if(this._templates[t.name]=i,!this._templateInfos[i.hash]){var u={};u.samplerStartBinding=i.blocks.length,u.shaderInfo=new Re,u.blockSizes=[],u.bindings=[];for(var h=0;h<i.blocks.length;h++){var c=i.blocks[h];u.blockSizes.push(Pv(c)),u.bindings.push(new De(c.binding,Bt.UNIFORM_BUFFER,1,c.stageFlags)),u.shaderInfo.blocks.push(new pe($p.MATERIAL,c.binding,c.name,c.members.map((function(t){return new fe(t.name,t.type,t.count)})),1))}for(var l=0;l<i.samplerTextures.length;l++){var _=i.samplerTextures[l];u.bindings.push(new De(_.binding,Bt.SAMPLER_TEXTURE,_.count,_.stageFlags)),u.shaderInfo.samplerTextures.push(new me($p.MATERIAL,_.binding,_.name,_.type,_.count))}for(var d=0;d<i.samplers.length;d++){var f=i.samplers[d];u.bindings.push(new De(f.binding,Bt.SAMPLER,f.count,f.stageFlags)),u.shaderInfo.samplers.push(new ge($p.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<i.textures.length;p++){var m=i.textures[p];u.bindings.push(new De(m.binding,Bt.TEXTURE,m.count,m.stageFlags)),u.shaderInfo.textures.push(new ve($p.MATERIAL,m.binding,m.name,m.type,m.count))}for(var g=0;g<i.buffers.length;g++){var v=i.buffers[g];u.bindings.push(new De(v.binding,Bt.STORAGE_BUFFER,1,v.stageFlags)),u.shaderInfo.buffers.push(new Te($p.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var y=0;y<i.images.length;y++){var T=i.images[y];u.bindings.push(new De(T.binding,Bt.STORAGE_IMAGE,T.count,T.stageFlags)),u.shaderInfo.images.push(new ye($p.MATERIAL,T.binding,T.name,T.type,T.count,T.memoryAccess))}for(var E=0;E<i.subpassInputs.length;E++){var S=i.subpassInputs[E];u.bindings.push(new De(S.binding,Bt.INPUT_ATTACHMENT,S.count,S.stageFlags)),u.shaderInfo.subpassInputs.push(new Ee($p.MATERIAL,S.binding,S.name,S.count))}u.gfxAttributes=[];for(var A=0;A<i.attributes.length;A++){var R=i.attributes[A];u.gfxAttributes.push(new Ae(R.name,R.format,R.isNormalized,0,R.isInstanced,R.location))}Bv(i,u,qp,"locals"),u.shaderInfo.stages.push(new Se(Et.VERTEX,"")),u.shaderInfo.stages.push(new Se(Et.FRAGMENT,"")),u.handleMap=function(t){for(var e={},i=0;i<t.blocks.length;i++)for(var n=t.blocks[i],r=n.members,s=0,a=0;a<r.length;a++){var o=r[a];e[o.name]=vv(n.binding,o.type,o.count,s),s+=(ni(o.type)>>2)*o.count}for(var u=0;u<t.samplerTextures.length;u++){var h=t.samplerTextures[u];e[h.name]=vv(h.binding,h.type,h.count)}return e}(i),u.setLayouts=[],this._templateInfos[i.hash]=u}return i},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,i){void 0===i&&(i=!1);var n=this._templates[e],r=this._templateInfos[n.hash];return r.setLayouts.length||(Cv.bindings=r.bindings,r.setLayouts[$p.MATERIAL]=t.createDescriptorSetLayout(Cv),Cv.bindings=qp.bindings,r.setLayouts[$p.LOCAL]=t.createDescriptorSetLayout(Cv)),r.setLayouts[i?$p.LOCAL:$p.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var i=this._templates[t],n=i.defines;if(i.uber){for(var r="",s=0;s<n.length;s++){var a=n[s],o=e[a.name];if(o&&a._map){var u=a._map(o);r+=""+a._offset+u+"|"}}return""+r+i.hash}for(var h=0,c=0;c<n.length;c++){var l=n[c],_=e[l.name];_&&l._map&&(h|=l._map(_)<<l._offset)}return h.toString(16)+"|"+i.hash},e.destroyShaderByDefines=function(t){var e=this,i=Object.keys(t);if(i.length)for(var n=i.map((function(e){var i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(""+e+i)})),r=Object.keys(this._cache).filter((function(t){return n.every((function(i){return i.test(e._cache[t].name)}))})),s=0;s<r.length;s++){var a=r[s],o=this._cache[a];N("destroyed shader "+o.name),o.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,i,n,r){Object.assign(i,n.macros),r||(r=this.getKey(e,i));var s=this._cache[r];if(s)return s;var a=this._templates[e],o=this._templateInfos[a.hash];o.pipelineLayout||(this.getDescriptorSetLayout(t,e),Bv(a,o,Kp,"globals"),o.setLayouts[$p.GLOBAL]=n.descriptorSetLayout,o.pipelineLayout=t.createPipelineLayout(new Ue(o.setLayouts)));var u=function(t,e){for(var i=[],n=0;n<e.length;n++){var r=e[n],s=r.name,a=t[s],o=Nv(r,a),u=!a||"0"===a;i.push({name:s,value:o,isDefault:u})}return i}(i,a.defines),h=n.constantMacros+a.constantMacros+u.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),c=a.glsl3,l=Fv(t);return l?c=a[l]:console.error("Invalid GFX API!"),o.shaderInfo.stages[0].source=h+c.vert,o.shaderInfo.stages[1].source=h+c.frag,o.shaderInfo.attributes=function(t,e,i){for(var n=[],r=t.attributes,s=e.gfxAttributes,a=0;a<r.length;a++)Dv(r[a].defines,i)&&n.push(s[a]);return n}(a,o,i),o.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,u),this._cache[r]=t.createShader(o.shaderInfo)},t}());v.programLib=Xv;var jv,Yv,Kv,qv,Qv=["planar-shadow","skybox","deferred-lighting","bloom","post-process","profiler","splash-screen","standard","unlit","sprite","particle","particle-gpu","particle-trail","billboard","terrain","graphics","clear-stencil","spine","occlusion-query","geometry-renderer","debug-renderer"],Zv=t("EffectAsset",ao("cc.EffectAsset")((Wv=Vv=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).techniques=Gv&&Gv(),e.shaders=kv&&kv(),e.combinations=zv&&zv(),e.hideInEditor=Hv&&Hv(),e}o(e,t),e.register=function(t){e._effects[t.name]=t,e._layoutValid=!1},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name]===t&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var i in e._effects)if(e._effects[i]._uuid===t)return void delete e._effects[i]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var i in e._effects)if(e._effects[i]._uuid===t)return e._effects[i];return Qv.includes(t)&&G(16101,t),null},e.getAll=function(){return e._effects},e.isLayoutValid=function(){return e._layoutValid},e.setLayoutValid=function(){e._layoutValid=!0};var i=e.prototype;return i.onLoaded=function(){Xv.register(this),e.register(this),v.game.once(v.Game.EVENT_RENDERER_INITED,this._precompile,this)},i._precompile=function(){for(var t=this,e=v.director.root,i=function(i){var n=t.shaders[i],r=t.combinations[i];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,i){for(var n=r[e],s=0;s<n.length;++s){var o=a({},i);o[e]=n[s],t.push(o)}return t}),[])}),[{}]).forEach((function(t){return Xv.getGFXShader(Wa.gfxDevice,n.name,t,e.pipeline)}))},n=0;n<this.shaders.length;n++)i(n)},i.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},i.initDefault=function(i){t.prototype.initDefault.call(this,i);var n=e.get("builtin-unlit");this.name="builtin-unlit",this.shaders=n.shaders,this.combinations=n.combinations,this.techniques=n.techniques},i.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Tu),Vv._effects={},Vv._layoutValid=!0,Gv=Za((Uv=Wv).prototype,"techniques",[mo],(function(){return[]})),kv=Za(Uv.prototype,"shaders",[mo],(function(){return[]})),zv=Za(Uv.prototype,"combinations",[mo],(function(){return[]})),Hv=Za(Uv.prototype,"hideInEditor",[mo,vo],(function(){return!1})),Lv=Uv))||Lv);function Jv(t){return!!(za.hasFeature(za.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}v.EffectAsset=Zv;var $v=t("ImageAsset",ao("cc.ImageAsset")((qv=Kv=function(t){function e(e){var i;return(i=t.call(this)||this)._nativeData=void 0,i._exportedExts=void 0,i._format=cf.RGBA8888,i._width=0,i._height=0,i._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&i.reset(e),i}o(e,t);var i=e.prototype;return i.reset=function(t){Jv(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},i.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Jv(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},i._serialize=function(){},i._deserialize=function(t){var i="";"string"==typeof t?i=t:(this._width=t.w,this._height=t.h,i=t.fmt);for(var n,r=Wa.gfxDevice,s=i.split("_"),a=Number.MAX_VALUE,o=this._format,u="",h=Xn.SUPPORT_TEXTURE_FORMATS,c=p(s);!(n=c()).done;){var l=n.value.split("@"),_=parseInt(l[0],void 0),d=e.extnames[_]||l[0],f=h.indexOf(d);if(-1!==f&&f<a){var m=l[1]?parseInt(l[1]):this._format;if(!(".astc"!==d||r&&r.getFormatFeatures(et.ASTC_RGBA_4X4)&lt.SAMPLED_TEXTURE))continue;if(!(".pvr"!==d||r&&r.getFormatFeatures(et.PVRTC_RGBA4)&lt.SAMPLED_TEXTURE))continue;if(!(m!==cf.RGB_ETC1&&m!==cf.RGBA_ETC1||r&&r.getFormatFeatures(et.ETC_RGB8)&lt.SAMPLED_TEXTURE))continue;if(!(m!==cf.RGB_ETC2&&m!==cf.RGBA_ETC2||r&&r.getFormatFeatures(et.ETC2_RGB8)&lt.SAMPLED_TEXTURE))continue;if(".webp"===d&&!za.hasFeature(za.Feature.WEBP))continue;a=f,u=d,o=m}}u?(this._setRawAsset(u),this._format=o):G(3121)},i.initDefault=function(i){if(t.prototype.initDefault.call(this,i),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var n=document.createElement("canvas"),r=n.getContext("2d"),s=n.width=n.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,s,s),this.reset(n),e._sharedPlaceHolderCanvas=n}},i.validate=function(){return!!this.data},s(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||Jv(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Jv(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=cf.RGB_ETC1&&this._format<=cf.RGBA_ASTC_12x12||this._format>=cf.RGB_A_PVRTC_2BPPV1&&this._format<=cf.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Tu),Kv.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Kv._sharedPlaceHolderCanvas=null,m((Yv=qv).prototype,"_nativeAsset",[No],Object.getOwnPropertyDescriptor(Yv.prototype,"_nativeAsset"),Yv.prototype),jv=Yv))||jv);v.ImageAsset=$v;var ty=new WeakMap,ey=new WeakSet,iy=new WeakSet;function ny(t,e){var i;i=nl.safeFindClass;var n,r=yl.pool.get();try{n=xl(t,r,{classFinder:i,customEnv:e})}catch(t){throw C(t),yl.pool.put(r),t}n._uuid=e.__uuid__||"";for(var s=r.uuidList,a=r.uuidObjList,o=r.uuidPropList,u=r.uuidTypeList||[],h=[],c=0;c<s.length;c++){var l=s[c];h[c]={uuid:Zo(l),owner:a[c],prop:o[c],type:Dn.getClassById(u[c])}}return ty.set(n,h),n._native&&ey.add(n),yl.pool.put(r),n}var ry,sy=new(function(){function t(){this._depends=new Bo}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?a({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),i=[];return this._descend(t,e,i),i},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var i,n,r=null;if(Array.isArray(e)||e.__type__||e instanceof ol){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(n=(i=e[5])[i.length-1])&&n<0)try{var s=ny(e,{__uuid__:t});(r=this._parseDepsFromAsset(s)).nativeDep&&(r.nativeDep.uuid=t),Uo.add(t+"@import",s)}catch(e){Lo.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},i=ty.get(t),n=0,r=i.length;n<r;n++)e.deps.push(i[n].uuid);return ey.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return i=(e=t)[1],e[10].map((function(t){return i[t]}));var e,i}(t);return e.forEach((function(t,i){return e[i]=Zo(t)})),e},e._descend=function(t,e,i){for(var n=this.getDeps(t),r=0;r<n.length;r++){var s=n[r];e[s]||(e[s]=!0,i.push(s),this._descend(s,e,i))}},t}()),ay=[new te];function oy(t){return t&&0==(t&t-1)}var uy,hy,cy,ly,_y,dy=ao("cc.SimpleTexture")(ry=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gfxTexture=null,e._gfxTextureView=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e._baseLevel=0,e._maxLevel=1e3,e}o(e,t);var i=e.prototype;return i.getGFXTexture=function(){return this._gfxTextureView},i.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),t.prototype.destroy.call(this)},i.updateImage=function(){this.updateMipmaps(0)},i.updateMipmaps=function(){},i.uploadData=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var n=this._getGFXDevice();if(n){var r=ay[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?n.copyBuffersToTexture([t],this._gfxTexture,ay):n.copyTexImagesToTexture([t],this._gfxTexture,ay)}}},i._assignImage=function(t,e,i){var n=t.data;if(n&&(this.uploadData(n,e,i),this._checkTextureLoaded(),Xn.CLEANUP_IMAGE_CACHE)){var r=sy.getDeps(this._uuid),s=r.indexOf(t._uuid);-1!==s&&(Li(r,s),t.decRef())}},i._checkTextureLoaded=function(){this._textureReady()},i._textureReady=function(){this.loaded=!0,this.emit("load")},i._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},i._setMipRange=function(t,e){this._baseLevel=t<1?0:t,this._maxLevel=e<1?0:e},i.setMipRange=function(t,e){W(t<=e,3124),this._setMipRange(t,e);var i=this._getGFXDevice();if(i){var n=this._createTextureView(i);this._tryDestroyTextureView(),this._gfxTextureView=n}},i._getGfxTextureCreateInfo=function(){return null},i._getGfxTextureViewCreateInfo=function(){return null},i._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&(this._createTexture(t),this._gfxTextureView=this._createTextureView(t))}},i.isUsingOfflineMipmaps=function(){return!1},i._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=ct.NONE;this._mipFilter!==_f.NONE&&function(t,e,i){return!(t.gfxAPI===J.WEBGL)||oy(e)&&oy(i)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var i=Math.max(t,e),n=0;i;)i>>=1,n++;return n}(this._width,this._height),this.isUsingOfflineMipmaps()||(e=ct.GEN_MIPMAP));var i=this._getGfxTextureCreateInfo({usage:ht.SAMPLED|ht.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(i){var n=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}}},i._createTextureView=function(t){if(!this._gfxTexture)return null;var e=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,i=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:e-this._baseLevel+1});return i?t.createTexture(i):null},i._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},i._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},s(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Of))||ry;v.SimpleTexture=dy;var fy=t("Texture2D",(uy=ao("cc.Texture2D"),hy=xo([$v]),uy((ly=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._mipmaps=_y&&_y(),e}o(e,t);var i=e.prototype;return i.initialize=function(){this.mipmaps=this._mipmaps},i.onLoaded=function(){this.initialize()},i.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);var e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);var i=void 0===t.baseLevel?0:t.baseLevel,n=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,n),this._tryReset()},i.create=function(t,e,i,n,r,s){void 0===i&&(i=cf.RGBA8888),void 0===n&&(n=1),void 0===r&&(r=0),void 0===s&&(s=1e3),this.reset({width:t,height:e,format:i,mipmapLevel:n,baseLevel:r,maxLevel:s})},i.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},i.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),n=0;n<i;++n){var r=t+n;this._assignImage(this._mipmaps[r],r)}},i.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},i.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},i.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},i.releaseTexture=function(){this.destroy()},i._serialize=function(){return null},i._deserialize=function(e,i){var n=e;t.prototype._deserialize.call(this,n.base,i),this._mipmaps=new Array(n.mipmaps.length);for(var r=0;r<n.mipmaps.length;++r)if(this._mipmaps[r]=new $v,n.mipmaps[r]){var s=n.mipmaps[r];i.result.push(this._mipmaps,""+r,s,Dn.getClassId($v))}},i._getGfxTextureCreateInfo=function(t){var e=new le(ut.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t),e},i._getGfxTextureViewCreateInfo=function(t){var e=new _e;return e.type=ut.TEX2D,Object.assign(e,t),e},i.initDefault=function(e){t.prototype.initDefault.call(this,e);var i=new $v;i.initDefault(),this.image=i},i.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},s(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0];this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(t,i){e._assignImage(t,i)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(dy),_y=Za(ly.prototype,"_mipmaps",[hy],(function(){return[]})),cy=ly))||cy));v.Texture2D=fy;var py=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Bo,this.scenes=new Bo,this.paths=new Bo}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,i=t.paths,n=t.types,r=t.deps,s=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,o=e.length;a<o;a++)e[a]=Zo(e[a]);for(var u in i){var h=i[u],c=h[1];h[1]=n[c]}}else{for(var l=Object.create(null),_=0,d=e.length;_<d;_++){var f=e[_];e[_]=l[f]=Zo(f)}e=l}for(var p in i){var m=i[p];s[e[p]]=m}var g=t.scenes;for(var v in g){var y=g[v];g[v]=e[y]}var T=t.packs;for(var E in T)for(var S=T[E],A=0;A<S.length;++A)S[A]=e[S[A]];var R=t.versions;if(R)for(var w in R)for(var b=R[w],O=0;O<b.length;O+=2){var M=b[O];b[O]=e[M]||M}var I=t.redirect;if(I)for(var C=0;C<I.length;C+=2)I[C]=e[I[C]],I[C+1]=r[I[C+1]];if(t.extensionMap){var x=function(i){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,i))return"continue";t.extensionMap[i].forEach((function(n,r){t.extensionMap[i][r]=e[n]||n}))};for(var N in t.extensionMap)x(N)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var i=function(i){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,i))return"continue";t.extensionMap[i].forEach((function(t){var n=e.assetInfos.get(t);n&&(n.extension=i)}))};for(var n in t.extensionMap)i(n)},e.getInfoWithPath=function(t,e){if(!t)return null;t=eu(t);var i=this.paths.get(t);if(i){if(!e)return i[0];for(var n=0,r=i.length;n<r;n++){var s=i[n];if(Dn.isChildClassOf(s.ctor,e))return s}}return null},e.getDirWithPath=function(t,e,i){"/"===(t=eu(t))[t.length-1]&&(t=t.slice(0,-1));var n=i||[];return this.paths.forEach((function(i,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var s=0,a=i.length;s<a;s++){var o=i[s];e&&!Dn.isChildClassOf(o.ctor,e)||n.push(o)}})),n},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,i){return i.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,i=t.length;e<i;e++){var n=t[e];this.assetInfos.add(n,{uuid:n})}}},e._initPath=function(t){if(t){var e=this.paths;for(var i in e.clear(),t){var n=t[i],r=n[0],s=n[1],a=3===n.length,o=this.assetInfos.get(i);o.path=r,o.ctor=Dn.getClassById(s),e.has(r)?a?e.get(r).push(o):e.get(r).unshift(o):e.add(r,[o])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var i=this.assetInfos;for(var n in t){var r=t[n],s=i.get(r);s.url=n,e.add(n,s)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var i in t){var n=t[i],r={uuid:i,packedUuids:n,ext:".json"};e.add(i,r);for(var s=0,a=n.length;s<a;s++){var o=n[s],u=e.get(o),h=u.packs;h?1===a?h.unshift(r):h.push(r):u.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,i=t.import;if(i)for(var n=0,r=i.length;n<r;n+=2){var s=i[n];e.get(s).ver=i[n+1]}if(i=t.native)for(var a=0,o=i.length;a<o;a+=2){var u=i[a];e.get(u).nativeVer=i[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,i=0,n=t.length;i<n;i+=2){var r=t[i];e.get(r).redirect=t[i+1]}},t}();function my(t,e){t._uuid&&e.push(t._uuid)}function gy(t,e){for(var i=Object.getOwnPropertyNames(t),n=0;n<i.length;n++){var r=i[n];if("node"!==r&&"__eventTargets"!==r){var s=t[r];if("object"==typeof s&&s)if(Array.isArray(s))for(var a=0;a<s.length;a++){var o=s[a];o instanceof Tu&&my(o,e)}else if(s.constructor&&s.constructor!==Object)s instanceof Tu&&my(s,e);else for(var u=Object.getOwnPropertyNames(s),h=0;h<u.length;h++){var c=s[u[h]];c instanceof Tu&&my(c,e)}}}}function vy(t,e){for(var i=0;i<t._components.length;i++)gy(t._components[i],e);for(var n=0;n<t._children.length;n++)vy(t._children[n],e)}function yy(t,e,i,n){i.push(t._uuid);for(var r=sy.getDeps(t._uuid),s=0,a=r.length;s<a;s++){var o=Fo.get(r[s]);if(o){var u=o._uuid;u in e?e[u]+=n:e[u]=o.refCount+n,i.includes(u)||yy(o,e,i,n)}}}var Ty=[],Ey=new(function(){function t(){this._persistNodeDeps=new Bo,this._toDelete=new Bo,this._eventListener=!1,this._dontDestroyAssets=[]}var e=t.prototype;return e.addIgnoredAsset=function(t){this._dontDestroyAssets.push(t._uuid)},e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];vy(t,e);for(var i=0,n=e.length;i<n;i++){var r=Fo.get(e[i]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),i=0,n=e.length;i<n;i++){var r=Fo.get(e[i]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,i){if(t){for(var n=sy.getDeps(t.uuid),r=0,s=n.length;r<s;r++){var a=Fo.get(n[r]);a&&a.decRef(t.autoReleaseAssets)}var o=sy._depends.get(t.uuid);if(o&&o.persistDeps)for(var u=o.persistDeps,h=0,c=u.length;h<c;h++){var l=Fo.get(u[h]);l&&l.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&sy.remove(t.uuid)}var _=sy._depends.get(e.uuid);for(var d in _&&(_.persistDeps=[]),i){for(var f,m,g=i[d],v=this._persistNodeDeps.get(g.uuid),y=p(v);!(m=y()).done;){var T=m.value,E=Fo.get(T);E&&E.addRef()}_&&(f=_.persistDeps).push.apply(f,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Tu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,er(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var i=t._uuid;if(this._toDelete.remove(i),jr(t,!0)&&-1===this._dontDestroyAssets.indexOf(i)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,yy(t,e,Ty,-1),Ty.length=0,0!==e[t._uuid])return e[t._uuid];for(var i in e)0!==e[i]&&yy(Fo.get(i),e,Ty,1);return Ty.length=0,e[t._uuid]}(t)>0)){Fo.remove(i);for(var n=sy.getDeps(i),r=0,s=n.length;r<s;r++){var a=Fo.get(n[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),sy.remove(i)}},t}());function Sy(t,e){for(var i=0,n=t.input.length;i<n;i++){var r=t.input[i];e&&!r.isNative&&r.content instanceof Tu&&r.content.decRef(!1),r.recycle()}t.input=null}function Ay(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function Ry(t,e,i,n,r){void 0===r&&(r=0),t(r,(function(s,a){r++,!s||r>e?n&&n(s,a):setTimeout((function(){Ry(t,e,i,n,r)}),i)}))}function wy(t,e,i,n,r){try{for(var s=sy.parse(t,e),o=0,u=s.deps.length;o<u;o++){var h=s.deps[o];h in i||(i[h]=!0,n.push({uuid:h,bundle:r&&r.name}))}s.nativeDep&&(r&&(s.nativeDep.bundle=r.name),n.push(a({},s.nativeDep)))}catch(t){C(t.message,t.stack)}}function by(t,e,i){e&&(i=void 0!==i?i:v.assetManager.cacheAsset,tu(e)||!i||e.isDefault||Fo.add(t,e))}function Oy(t,e,i){var n=0,r=[],s=t.length;0===s&&i&&i(r);for(var a=function(t){t&&r.push(t),++n===s&&i&&i(r)},o=0;o<s;o++)e(t[o],a)}function My(t,e,i){var n=t,r=e,s=i;if(void 0===i){var a="function"==typeof t;e?(s=e,a||(r=null)):void 0===e&&a&&(s=t,n=null,r=null),void 0!==e&&a&&(r=t,n=null)}return{options:n||Object.create(null),onProgress:r,onComplete:s}}function Iy(t,e,i){var n=t,r=e,s=i;if(void 0===i){var a=Dn.isChildClassOf(t,Tu);e?(s=e,a&&(r=null)):void 0!==e||a||(s=t,r=null,n=null),void 0===e||a||(r=t,n=null)}return{type:n,onProgress:r||null,onComplete:s}}function Cy(t,e,i,n){if(void 0===n&&(n={}),!i[e]||n[e])return!1;n[e]=!0;var r=!1,s=sy.getDeps(e);if(s)for(var a=0,o=s.length;a<o;a++){var u=s[a];if(u===t||Cy(t,u,i,n)){r=!0;break}}return r}function xy(t){return function(e,i){t&&t(e,i)}}var Ny=function(){function t(){this._config=new py}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,i){return this._config.getDirWithPath(t,e,i)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),Go.add(t.name,this)},e.load=function(t,e,i,n){var r=Iy(e,i,n),s=r.type,a=r.onProgress,o=r.onComplete,u={__requestType__:Do.PATH,type:s,bundle:this.name,__outputAsArray__:Array.isArray(t)};v.assetManager.loadAny(t,u,a,o)},e.preload=function(t,e,i,n){var r=Iy(e,i,n),s=r.type,a=r.onProgress,o=r.onComplete;v.assetManager.preloadAny(t,{__requestType__:Do.PATH,type:s,bundle:this.name},a,o)},e.loadDir=function(t,e,i,n){var r=Iy(e,i,n),s=r.type,a=r.onProgress,o=r.onComplete;v.assetManager.loadAny(t,{__requestType__:Do.DIR,type:s,bundle:this.name,__outputAsArray__:!0},a,o)},e.preloadDir=function(t,e,i,n){var r=Iy(e,i,n),s=r.type,a=r.onProgress,o=r.onComplete;v.assetManager.preloadAny(t,{__requestType__:Do.DIR,type:s,bundle:this.name},a,o)},e.loadScene=function(t,e,i,n){var r=My(e,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"scene",s.bundle=this.name,v.assetManager.loadAny({scene:t},s,a,(function(t,e){if(t)C(t.message,t.stack);else if(e.scene){var i=e.scene;i._id=e._uuid,i.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");o&&o(t,e)}))},e.preloadScene=function(t,e,i,n){var r=My(e,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.bundle=this.name,v.assetManager.preloadAny({scene:t},s,a,(function(e){e&&z(1210,t,e.message),o&&o(e)}))},e.get=function(t,e){var i=this.getInfoWithPath(t,e);return i&&Fo.get(i.uuid)||null},e.release=function(t,e){var i=this.get(t,e);i&&Ey.tryRelease(i,!0)},e.releaseUnusedAssets=function(){var t=this;Fo.forEach((function(e){var i=t.getAssetInfo(e._uuid);i&&!i.redirect&&Ey.tryRelease(e)}))},e.releaseAll=function(){var t=this;Fo.forEach((function(e){var i=t.getAssetInfo(e._uuid);i&&!i.redirect&&Ey.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},s(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),By=t("resources",new Ny);function Py(t,e,i){var n=new Image,r=Wn.querySettings("custom","prefixServer")||"";function s(){console.timeEnd("phase downloadDomImage "+t),n.removeEventListener("load",s),n.removeEventListener("error",a),i&&i(null,n)}function a(){n.removeEventListener("load",s),n.removeEventListener("error",a),i&&i(new Error(X(4930,t)))}return r&&(t=""+r+t),"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),console.time("phase downloadDomImage "+t),n.addEventListener("load",s),n.addEventListener("error",a),n.src=t,n}function Dy(t,e,i,n){var r=new XMLHttpRequest,s="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?n&&n(null,r.response):n&&n(new Error(""+s+r.status+"(no response)"))},i&&(r.onprogress=function(t){t.lengthComputable&&i(t.loaded,t.total)}),r.onerror=function(){n&&n(new Error(""+s+r.status+"(error)"))},r.ontimeout=function(){n&&n(new Error(""+s+r.status+"(time out)"))},r.onabort=function(){n&&n(new Error(""+s+r.status+"(abort)"))},r.send(null),r}v.resources=By;var Fy={};function Ly(t,e,i){if(Fy[t])return i&&i(null),null;var n=document.createElement("script");function r(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",s,!1),Fy[t]=!0,i&&i(null)}function s(){n.parentNode.removeChild(n),n.removeEventListener("load",r,!1),n.removeEventListener("error",s,!1),i&&i(new Error(X(4928,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=e.scriptAsyncLoading||!1,n.src=t,n.addEventListener("load",r,!1),n.addEventListener("error",s,!1),document.body.appendChild(n),n}var Uy,Gy,ky,zy,Hy,Vy,Wy=/^(?:\w+:\/\/|\.+\/).+/,Xy=function(t,e,i){(za.hasFeature(za.Feature.IMAGE_BITMAP)&&v.assetManager.allowImageBitmap?jy:Py)(t,e,i)},jy=function(t,e,i){e.xhrResponseType="blob",Dy(t,e,e.onFileProgress,i)},Yy=function(t,e,i){e.xhrResponseType="json",Dy(t,e,e.onFileProgress,i)},Ky=function(t,e,i){e.xhrResponseType="arraybuffer",Dy(t,e,e.onFileProgress,i)},qy=function(t,e,i){Yy(t,e,(function(e,n){if(e)i(e);else{var r=ul(n);Promise.all(r.chunks.map((function(i){return new Promise((function(n,r){Ky(""+_u(t)+i,{},(function(t,i){e?r(e):n(new Uint8Array(i))}))}))}))).then((function(t){var e=new ol(r.document,t);i(null,e)})).catch((function(t){i(t)}))}}))},Qy=function(t,e,i){Ky(t,e,(function(t,e){if(t)i(t);else try{var n=hl(new Uint8Array(e));i(null,n)}catch(t){i(t)}}))},Zy=function(t,e,i){e.xhrResponseType="text",Dy(t,e,e.onFileProgress,i)},Jy=function(t,e,i){var n=du(t),r=t;Wy.test(r)||(r=-1!==$y.remoteBundles.indexOf(n)?$y.remoteServerAddress+"remote/"+n:"assets/"+n);var s=e.version||$y.bundleVers[n],a=0,o=null,u=null;Yy(r+"/config."+(s?s+".":"")+"json",e,(function(t,e){u=t,(o=e)&&(o.base=r+"/"),2==++a&&i(u,o)})),Ly(r+"/index."+(s?s+".":"")+"js",e,(function(t){u=t,2==++a&&i(t,o)}))},$y=new(function(){function t(){this.maxConcurrency=36,this.maxRequestsPerFrame=36,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=Py,this.downloadDomAudio=null,this.downloadFile=Dy,this.downloadScript=Ly,this._downloaders={".png":Xy,".jpg":Xy,".bmp":Xy,".jpeg":Xy,".gif":Xy,".ico":Xy,".tiff":Xy,".webp":Xy,".image":Xy,".pvr":Ky,".pkm":Ky,".astc":Ky,".txt":Zy,".xml":Zy,".vsh":Zy,".fsh":Zy,".atlas":Zy,".tmx":Zy,".tsx":Zy,".json":Yy,".ExportJson":Yy,".plist":Zy,".ccon":qy,".cconb":Qy,".fnt":Zy,".binary":Ky,".bin":Ky,".dbbin":Ky,".skel":Ky,".js":Ly,bundle:Jy,default:Zy},this._downloading=new Bo,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,i){void 0===t&&(t=""),void 0===e&&(e={}),void 0===i&&(i=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i},e.register=function(t,e){"object"==typeof t?Dn.mixin(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,i,n,r){var s=this,a=Lo.get(t);if(a)r(null,a);else{var o=this._downloading.get(t);if(o){o.push(r);var u=this._queue.find((function(e){return e.id===t}));if(!u)return;var h=n.priority||0;u.priority<h&&(u.priority=h,this._queueDirty=!0)}else{var c=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,l=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,_=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,d=this._downloaders[i]||this._downloaders.default;Ry((function(i,a){if(0===i&&s._downloading.add(t,[r]),s.limited){s._updateTime();var o=function(t,e){s._totalNum--,s._handleQueueInNextFrame(l,_),a(t,e)};s._totalNum<l&&s._totalNumThisPeriod<_?(d(Ay(e,s.appendTimeStamp),n,o),s._totalNum++,s._totalNumThisPeriod++):(s._queue.push({id:t,priority:n.priority||0,url:e,options:n,done:o,handler:d}),s._queueDirty=!0,s._totalNum<l&&s._handleQueueInNextFrame(l,_))}else d(Ay(e,s.appendTimeStamp),n,a)}),c,this.retryInterval,(function(e,i){e||Lo.add(t,i);for(var n=s._downloading.remove(t),r=0,a=n.length;r<a;r++)n[r](e,i)}))}}},e.loadSubpackage=function(t,e){v.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=v.game.deltaTime,i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var i=this._queue.pop();if(!i)break;this._totalNum++,this._totalNumThisPeriod++,i.handler(Ay(i.url,this.appendTimeStamp),i.options,i.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(er(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},s(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}()),tT=t("JsonAsset",ao("cc.JsonAsset")((Gy=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).json=ky&&ky(),e}return o(e,t),e}(Tu),ky=Za(Gy.prototype,"json",[mo],(function(){return null})),Uy=Gy))||Uy);v.JsonAsset=tT;var eT=t("TextAsset",ao("cc.TextAsset")((Hy=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).text=Vy&&Vy(),e}return o(e,t),e.prototype.toString=function(){return this.text},e}(Tu),Vy=Za(Hy.prototype,"text",[mo],(function(){return""})),zy=Hy))||zy);function iT(t,e,i,n){var r=null,s=null;try{(r=new $v)._nativeUrl=t,r._nativeAsset=e}catch(t){s=t}n(s,r)}function nT(t,e,i,n){var r=new tT;r.json=e,n(null,r)}function rT(t,e,i,n){var r=new eT;r.text=e,n(null,r)}function sT(t,e,i,n){var r=new Df;r._nativeUrl=t,r._nativeAsset=e,n(null,r)}function aT(t,e,i,n){var r=new Tu;r._nativeUrl=t,r._nativeAsset=e,n(null,r)}function oT(t,i,n,r){var s=Go.get(i.name);s||(s=i.name===Wo.RESOURCES?By:new Ny,i.base=i.base||t+"/",s.init(i)),e.import("virtual:///prerequisite-imports/"+s.name).then((function(){r(null,s)})).catch(r)}v.TextAsset=eT;var uT=new(function(){function t(){this._creating=new Bo,this._producers={".png":iT,".jpg":iT,".bmp":iT,".jpeg":iT,".gif":iT,".ico":iT,".tiff":iT,".webp":iT,".image":iT,".pvr":iT,".pkm":iT,".txt":rT,".xml":rT,".vsh":rT,".fsh":rT,".atlas":rT,".tmx":rT,".tsx":rT,".fnt":rT,".json":nT,".ExportJson":nT,".binary":sT,".bin":sT,".dbbin":sT,".skel":sT,bundle:oT,default:aT}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?Dn.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,i,n,r){var s=this,a=this._producers[i]||this._producers.default,o=Fo.get(t);if(n.reloadAsset||!o){var u=this._creating.get(t);u?u.push(r):(this._creating.add(t,[r]),a(t,e,n,(function(e,i){!e&&i instanceof Tu&&(i._uuid=t,by(t,i,n.cacheAsset));for(var r=s._creating.remove(t),a=0,o=r.length;a<o;a++)r[a](e,i)})))}else r(null,o)},t}()),hT=new(function(){function t(){this._loading=new Bo,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,i,n){var r=Dn.createMap(!0),s=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(X(5304,t[0]));Il(t,!0,void 0,xl.reportMissingClass),Cl(t);for(var e=new Nl(t[0]),i=t[1],n=t[2],r=t[3],s=t[4],a=t[5],o=0;o<a.length;++o)a[o].unshift(e,i,n,r,s);return a}(e)).length!==t.length&&z(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var o=Dn.getClassId(fy),u=Dn.getClassId($v);if(e.type===o&&e.data){var h=e.data;h.length!==t.length&&z(4915);for(var c=0;c<t.length;c++)r[t[c]+"@import"]=Bl(o,{base:h[c][0],mipmaps:h[c][1]})}else if(e.type===u&&e.data){var l=e.data;l.length!==t.length&&z(4915);for(var _=0;_<t.length;_++)r[t[_]+"@import"]=l[_]}else s=new Error("unmatched type pack!"),r=null}n(s,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?Dn.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,i,n,r){e?(0,this._unpackers[i])(t,e,n,r):r(new Error("package data is wrong!"))},e.load=function(t,e,i){var n=this;if(!t.isNative&&t.info&&t.info.packs)if(Lo.has(t.id))i(null,Lo.get(t.id));else{var r=t.info.packs,s=r.find((function(t){return n._loading.has(t.uuid)}));if(s)this._loading.get(s.uuid).push({onComplete:i,id:t.id});else{s=r[0],this._loading.add(s.uuid,[{onComplete:i,id:t.id}]);var a=iu(s.uuid,{ext:s.ext,bundle:t.config.name});$y.download(s.uuid,a,s.ext,t.options,(function(e,i){Lo.remove(s.uuid),e&&C(e.message,e.stack),n.unpack(s.packedUuids,i,s.ext,t.options,(function(t,i){if(!t)for(var r in i)Lo.add(r,i[r]);for(var a=n._loading.remove(s.uuid),o=0,u=a.length;o<u;o++){var h=a[o];if(e||t)h.onComplete(e||t);else{var c=i[h.id];c?h.onComplete(null,c):h.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else $y.download(t.id,t.url,t.ext,t.options,i)},t}());function cT(t,e){var i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);var n=t.options,r=t.progress,s=[],a=r.total,o=n.__exclude__=n.__exclude__||Object.create(null);t.output=[],Oy(t.input,(function(n,u){if(!n.isNative&&Fo.has(n.uuid)){var h=Fo.get(n.uuid);return n.content=h.addRef(),t.output.push(n),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n),void u()}hT.load(n,t.options,(function(h,c){h?t.isFinish||(!v.assetManager.force||i?(C(h.message,h.stack),r.canInvoke=!1,e(h)):(t.output.push(n),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n))):t.isFinish||(n.file=c,t.output.push(n),n.isNative||(o[n.uuid]=!0,wy(n.uuid,c,o,s,n.config),r.total=a+s.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,n)),u()}))}),(function(){if(t.isFinish)return Sy(t,!0),void t.dispatch("error");if(s.length>0){var a=jo.create({input:s,progress:r,options:n,onProgress:t.onProgress,onError:jo.prototype.recycle,onComplete:function(n){var r;n||((r=t.output).push.apply(r,a.output),a.recycle()),i&&lT(t),e(n)}});zo.async(a)}else i&&lT(t),e()}))}function lT(t){for(var e=t.output,i=0,n=e.length;i<n;i++)e[i].content&&e[i].content.decRef(!1)}var _T=new(function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return G(5100),{};for(var i=null,n=0,r=e.childNodes.length;n<r&&1!==(i=e.childNodes[n]).nodeType;n++);return this._parseNode(i)},i._parseNode=function(t){var e=null,i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var n=0;n<t.childNodes.length;n++)e+=t.childNodes[n].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e},i._parseArray=function(t){for(var e=[],i=0,n=t.childNodes.length;i<n;i++){var r=t.childNodes[i];1===r.nodeType&&e.push(this._parseNode(r))}return e},i._parseDict=function(t){for(var e={},i="",n=0,r=t.childNodes.length;n<r;n++){var s=t.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:e[i]=this._parseNode(s))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function dT(t,e){return t[e]<<8|t[e+1]}var fT=new(function(){function t(){this._parsing=new Bo,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){i(null,t)}),(function(t){i(t,null)}))},e.parsePVRTex=function(t,e,i){var n=null,r=null;try{var s=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(s,0,13);if(55727696===a[0]){var o=a[7],u=a[6],h=a[12]+52;r={_data:new Uint8Array(s,h),_compressed:!0,width:o,height:u,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var c=a[0],l=a[1],_=a[2];r={_data:new Uint8Array(s,c),_compressed:!0,width:_,height:l,format:0}}}catch(t){n=t}i(n,r)},e.parsePKMTex=function(t,e,i){var n=null,r=null;try{var s=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(s),o=dT(a,6);if(0!==o&&1!==o&&3!==o)throw new Error("Invalid magic number in ETC header");var u=dT(a,12),h=dT(a,14);dT(a,8),dT(a,10),r={_data:new Uint8Array(s,16),_compressed:!0,width:u,height:h,format:0}}catch(t){n=t}i(n,r)},e.parseASTCTex=function(t,e,i){var n=null,r=null;try{var s=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(s);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var o=a[4],u=a[5],h=a[6];if((o<3||o>6||u<3||u>6||h<3||h>6)&&(o<4||7===o||9===o||11===o||o>12||u<4||7===u||9===u||11===u||u>12||1!==h))throw new Error("Invalid block number in ASTC header");var c=function(t,e){return 4===t?cf.RGBA_ASTC_4x4:5===t?4===e?cf.RGBA_ASTC_5x4:cf.RGBA_ASTC_5x5:6===t?5===e?cf.RGBA_ASTC_6x5:cf.RGBA_ASTC_6x6:8===t?5===e?cf.RGBA_ASTC_8x5:6===e?cf.RGBA_ASTC_8x6:cf.RGBA_ASTC_8x8:10===t?5===e?cf.RGBA_ASTC_10x5:6===e?cf.RGBA_ASTC_10x6:8===e?cf.RGBA_ASTC_10x8:cf.RGBA_ASTC_10x10:10===e?cf.RGBA_ASTC_12x10:cf.RGBA_ASTC_12x12}(o,u),l=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(s,16),_compressed:!0,width:l,height:_,format:c}}catch(t){n=t}i(n,r)},e.parsePlist=function(t,e,i){var n=null,r=_T.parse(t);r||(n=new Error("parse failed")),i(n,r)},e.parseImport=function(t,e,i){if(t){var n=null,r=null;try{n=ny(t,e)}catch(t){r=t}i(r,n)}else i(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?Dn.mixin(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,i,n,r){var s=this,a=Uo.get(t);if(a)r(null,a);else{var o=this._parsing.get(t);if(o)o.push(r);else{var u=this._parsers[i];u?(this._parsing.add(t,[r]),u(e,n,(function(e,i){e?Lo.remove(t):tu(i)||Uo.add(t,i);for(var n=s._parsing.remove(t),r=0,a=n.length;r<a;r++)n[r](e,i)}))):r(null,e)}}},t}());function pT(t,e){var i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);var n=t.options,r=t.progress;n.__exclude__=n.__exclude__||Object.create(null),t.output=[],Oy(t.input,(function(s,a){var o=jo.create({input:s,onProgress:t.onProgress,options:n,progress:r,onComplete:function(n,u){n&&!t.isFinish&&(!v.assetManager.force||i?(C(n.message,n.stack),r.canInvoke=!1,e(n)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s)),t.output.push(u),o.recycle(),a(null)}});mT.async(o)}),(function(){if(n.__exclude__=null,t.isFinish)return Sy(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var i=t.output=[],n=0,r=e.length;n<r;n++)i.push(e[n].content);else t.output=e[0].content}(t),Sy(t,!0),e()}))}var mT=new Po("loadOneAsset",[function(t,e){var i=t.output=t.input,n=i.options,r=i.isNative,s=i.uuid,a=i.file,o=n.reloadAsset;a||!o&&!r&&Fo.has(s)?e():hT.load(i,t.options,(function(t,n){i.file=n,e(t)}))},function(t,e){var i=t.output=t.input,n=t.progress,r=t.options.__exclude__,s=i.id,a=i.file,o=i.options;if(i.isNative)fT.parse(s,a,i.ext,o,(function(r,a){r?e(r):(i.content=a,n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),Lo.remove(s),Uo.remove(s),e())}));else{var u=i.uuid;if(u in r){var h=r[u],c=h.finish,l=h.content,_=h.err,d=h.callbacks;n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),c||Cy(u,u,r)?(l&&l.addRef(),i.content=l,e(_)):d.push({done:e,item:i})}else if(!o.reloadAsset&&Fo.has(u)){var f=Fo.get(u);i.content=f.addRef(),n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),e()}else o.__uuid__=u,fT.parse(s,a,"import",o,(function(i,n){i?e(i):function(t,e,i){var n=t.input,r=t.progress,s=n,a=s.uuid,o=s.id,u=s.options,h=s.config,c=u.cacheAsset,l=[];e.addRef&&e.addRef(),wy(a,e,Object.create(null),l,h),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=l.length,n);var _=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:i,item:n}]},d=jo.create({input:l,options:t.options,onProgress:t.onProgress,onError:jo.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){for(var i,n=Array.isArray(d.output)?d.output:[d.output],r=Object.create(null),s=p(n);!(i=s()).done;){var u=i.value;u&&(r[u instanceof Tu?u._uuid+"@import":a+"@native"]=u)}!function(t,e,i){var n=ty.get(e);if(n){for(var r=0,s=n.length;r<s;r++){var a=n[r],o=i[a.uuid+"@import"];if(o)a.owner[a.prop]=o.addRef();else{if(C("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Tu){var u=new a.type;u.initDefault(a.uuid),a.owner[a.prop]=u}!0}}ty.delete(e)}ey.has(e)&&(i[t+"@native"]?e._nativeAsset=i[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),ey.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||iy.has(e)||ey.has(e)||(e.onLoaded(),iy.add(e))}catch(t){C("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}Lo.remove(o),Uo.remove(o),by(a,e,c),d.recycle()}for(var h=_.callbacks,l=0,f=h.length;l<f;l++){var m=h[l];e.addRef&&e.addRef(),m.item.content=e,m.done(t)}h.length=0}});ko.async(d)}(t,n,e)}))}}]);function gT(t,e){var i=t.options,n=Object.create(null),r=Object.create(null);for(var s in i)switch(s){case Do.PATH:case Do.UUID:case Do.DIR:case Do.SCENE:case Do.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[s]=i[s];break;case"__exclude__":case"__outputAsArray__":r[s]=i[s];break;default:n[s]=i[s],r[s]=i[s]}t.options=r;var a=jo.create({input:t.input,options:n}),o=null;try{t.output=t.source=Ho.sync(a)}catch(t){o=t;for(var u=0,h=a.output.length;u<h;u++)a.output[u].recycle()}a.recycle(),e(o)}var vT=function(){function t(){this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.overrideUuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},s(t,[{key:"id",get:function(){return this._id||(this._id=(this.overrideUuid||this.uuid)+"@"+(this.isNative?"native":"import")),this._id}}]),t}();vT.MAX_DEAD_NUM=500,vT._deadPool=[];var yT=[];function TT(t){var e=t.options,i=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var n=function(n){var r,s=i[n],a=vT.create(),o=null,u=null;if("string"==typeof s&&((s=Object.create(null))[e.__requestType__||Do.UUID]=i[n]),"object"==typeof s)for(var h in Dn.addon(s,e),s.preset&&Dn.addon(s,Xo[s.preset]),s){switch(h){case Do.UUID:if("break"===function(){var t,e=a.uuid=Zo(s.uuid);if(!s.bundle){var i=Go.find((function(t){return!!t.getAssetInfo(e)}));s.bundle=i&&i.name}if(Go.has(s.bundle)){if(o=Go.get(s.bundle).config,(u=o.getAssetInfo(e))&&u.redirect){if(!Go.has(u.redirect))throw new Error("Please load bundle "+u.redirect+" first");o=Go.get(u.redirect).config,u=o.getAssetInfo(e)}a.config=o,a.info=u}return a.ext=s.ext||(null===(t=u)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Do.DIR:if(Go.has(s.bundle)){Go.get(s.bundle).config.getDirWithPath(s.dir,s.type,yT);for(var c,l=p(yT);!(c=l()).done;){var _=c.value;i.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:s.bundle})}yT.length=0}a.recycle(),a=null;break;case Do.PATH:if(Go.has(s.bundle)){if(o=Go.get(s.bundle).config,(u=o.getInfoWithPath(s.path,s.type))&&u.redirect){if(!Go.has(u.redirect))throw new Error("you need to load bundle "+u.redirect+" first");o=Go.get(u.redirect).config,u=o.getAssetInfo(u.uuid)}if(!u)throw a.recycle(),new Error("Bundle "+s.bundle+" doesn't contain "+s.path);a.config=o,a.uuid=u.uuid,a.info=u}a.ext=s.ext||(null===(r=u)||void 0===r?void 0:r.extension)||".json";break;case Do.SCENE:if(!s.bundle){var d=Go.find((function(t){return!!t.getSceneInfo(s.scene)}));s.bundle=d&&d.name}if(Go.has(s.bundle)){if(o=Go.get(s.bundle).config,(u=o.getSceneInfo(s.scene))&&u.redirect){if(!Go.has(u.redirect))throw new Error("you need to load bundle "+u.redirect+" first");o=Go.get(u.redirect).config,u=o.getAssetInfo(u.uuid)}if(!u)throw a.recycle(),new Error("Bundle "+o.name+" doesn't contain scene "+s.scene);a.config=o,a.uuid=u.uuid,a.info=u}break;case"__isNative__":a.isNative=s.__isNative__;break;case Do.URL:a.url=s.url,a.uuid=s.uuid||s.url,a.ext=s.ext||lu(s.url),a.isNative=void 0===s.__isNative__||s.__isNative__;break;default:a.options[h]=s[h]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(s))},r=0;r<i.length;r++)n(r);return null}function ET(t){for(var e=t.output=t.input,i=0;i<e.length;i++){var n=e[i];!Vo.has(n.uuid)||function(){var t=Vo.get(n.uuid),e=Go.find((function(e){return!!e.getAssetInfo(t)}));if(e){var i;n.overrideUuid=t;var r=e.config,s=r.getAssetInfo(t);if(s&&s.redirect){if(!Go.has(s.redirect))throw new Error("Please load bundle "+s.redirect+" first");s=(r=Go.get(s.redirect).config).getAssetInfo(t)}n.config=r,n.info=s,n.ext=n.isNative?n.ext:(null===(i=s)||void 0===i?void 0:i.extension)||".json"}else G(16201,t,n.uuid)}()}}function ST(t){for(var e=t.output=t.input,i=0;i<e.length;i++){var n=e[i];if(!n.url){var r,s,a=n.config;s=n.isNative?a&&a.nativeBase?a.base+a.nativeBase:v.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:v.assetManager.generalImportBase;var o=n.overrideUuid||n.uuid,u="";n.info&&(u=n.isNative?n.info.nativeVer?"."+n.info.nativeVer:"":n.info.ver?"."+n.info.ver:""),r=".ttf"===n.ext?s+"/"+o.slice(0,2)+"/"+o+u+"/"+n.options.__nativeName__:s+"/"+o.slice(0,2)+"/"+o+u+n.ext,n.url=r}}return null}var AT=t("AssetManager",function(){function t(){this.pipeline=ko.append(gT).append(pT),this.fetchPipeline=zo.append(gT).append(cT),this.transformPipeline=Ho.append(TT).append(ET).append(ST),this.bundles=Go,this.assets=Fo,this.assetsOverrideMap=Vo,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=sy,this.force=!1,this.allowImageBitmap=!za.isMobile,this.utils=au,this.downloader=$y,this.parser=fT,this.packManager=hT,this.cacheAsset=!0,this.cacheManager=null,this.presets=Xo,this.factory=uT,this.preprocessPipe=gT,this.fetchPipe=cT,this.loadPipe=pT,this.references=null,this._releaseManager=Ey,this._files=Lo,this._parsed=Uo,this._parsePipeline=null,this._projectBundles=[]}var e=t.prototype;return e.init=function(t){void 0===t&&(t={});var e=t.server||Wn.querySettings(Vn.Category.ASSETS,"server")||"",i=t.bundleVers||Wn.querySettings(Vn.Category.ASSETS,"bundleVers")||{},n=t.remoteBundles||Wn.querySettings(Vn.Category.ASSETS,"remoteBundles")||[];this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e,i,n),this.parser.init(),this.dependUtil.init();var r=t.importBase||Wn.querySettings(Vn.Category.ASSETS,"importBase")||"";r&&r.endsWith("/")&&(r=r.substr(0,r.length-1));var s=t.nativeBase||Wn.querySettings(Vn.Category.ASSETS,"nativeBase")||"";s&&s.endsWith("/")&&(s=s.substr(0,s.length-1)),this.generalImportBase=r,this.generalNativeBase=s,this._projectBundles=Wn.querySettings(Vn.Category.ASSETS,"projectBundles")||[];var a=Wn.querySettings(Vn.Category.ASSETS,"assetsOverrides")||{};for(var o in a)this.assetsOverrideMap.set(o,a[o])},e.getBundle=function(t){return Go.get(t)||null},e.removeBundle=function(t){t._destroy(),Go.remove(t.name)},e.loadAny=function(t,e,i,n){var r=My(e,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;var u=jo.create({input:t,onProgress:a,onComplete:xy(o),options:s});ko.async(u)},e.preloadAny=function(t,e,i,n){var r=My(e,i,n),s=r.options,a=r.onProgress,o=r.onComplete;s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;var u=jo.create({input:t,onProgress:a,onComplete:xy(o),options:s});zo.async(u)},e.loadRemote=function(t,e,i){var n=My(e,void 0,i),r=n.options,s=n.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,i){e?(C(e.message,e.stack),s&&s(e,i)):uT.create(t,i,r.ext||lu(t),r,(function(t,e){s&&s(t,e)}))}))):xy(s)(null,this.assets.get(t))},e.loadBundle=function(t,e,i){var n=My(e,void 0,i),r=n.options,s=n.onComplete,a=du(t);this.bundles.has(a)?xy(s)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,i){e?(C(e.message,e.stack),s&&s(e,i)):uT.create(t,i,"bundle",r,(function(t,e){s&&s(t,e)}))})))},e.releaseAsset=function(t){Ey.tryRelease(t,!0)},e.releaseUnusedAssets=function(){Fo.forEach((function(t){Ey.tryRelease(t)}))},e.releaseAll=function(){Fo.forEach((function(t){Ey.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},s(t,[{key:"main",get:function(){return Go.get(Wo.MAIN)||null}},{key:"resources",get:function(){return Go.get(Wo.RESOURCES)||null}}]),t}());AT.Pipeline=Po,AT.Task=jo,AT.Cache=Bo,AT.RequestItem=vT,AT.Bundle=Ny,AT.BuiltinBundleName=Wo;var RT=t("assetManager",v.assetManager=new AT);v.AssetManager=AT;var wT,bT,OT,MT=function(){function t(){this._resources={},this._materialsToBeCompiled=[]}var e=t.prototype;return e.init=function(){for(var t=this._resources,e=new Uint8Array(16),i=new Uint8Array(16),n=new Uint8Array(16),r=new Uint8Array(16),s=new Uint8Array(16),a=0,o=0;o<4;o++)e[a]=0,e[a+1]=0,e[a+2]=0,e[a+3]=255,i[a]=0,i[a+1]=0,i[a+2]=0,i[a+3]=0,n[a]=119,n[a+1]=119,n[a+2]=119,n[a+3]=255,r[a]=255,r[a+1]=255,r[a+2]=255,r[a+3]=255,s[a]=127,s[a+1]=127,s[a+2]=255,s[a+3]=255,a+=4;var u=new Uint8Array(1024);a=0;for(var h=0;h<256;h++)u[a]=221,u[a+1]=221,u[a+2]=221,u[a+3]=255,a+=4;a=0;for(var c=0;c<8;c++){for(var l=0;l<8;l++)u[a]=85,u[a+1]=85,u[a+2]=85,u[a+3]=255,a+=4;a+=32}a+=32;for(var _=0;_<8;_++){for(var d=0;d<8;d++)u[a]=85,u[a+1]=85,u[a+2]=85,u[a+3]=255,a+=4;a+=32}var f={width:2,height:2,_data:e,_compressed:!1,format:fy.PixelFormat.RGBA8888},p={width:2,height:2,_data:i,_compressed:!1,format:fy.PixelFormat.RGBA8888},m={width:2,height:2,_data:n,_compressed:!1,format:fy.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:fy.PixelFormat.RGBA8888},y={width:2,height:2,_data:s,_compressed:!1,format:fy.PixelFormat.RGBA8888},T={width:16,height:16,_data:u,_compressed:!1,format:fy.PixelFormat.RGBA8888},E=new $v(f),S=new fy;S._uuid="black-texture",S.image=E,t[S._uuid]=S;var A=new $v(p),R=new fy;R._uuid="empty-texture",R.image=A,t[R._uuid]=R;var w=new $v(m),b=new fy;b._uuid="grey-texture",b.image=w,t[b._uuid]=b;var O=new $v(g),M=new fy;M._uuid="white-texture",M.image=O,t[M._uuid]=M;var I=new $v(y),C=new fy;C._uuid="normal-texture",C.image=I,t[C._uuid]=C;var x=new $v(T),N=new fy;if(N._uuid="default-texture",N.image=x,t[N._uuid]=N,v.SpriteFrame){var B=new v.SpriteFrame,P=E,D=new fy;D.image=P,B.texture=D,B._uuid="default-spriteframe",t[B._uuid]=B}},e.addAsset=function(t,e){this._resources[t]=e},e.get=function(t){return this._resources[t]},e.loadBuiltinAssets=function(){var t=this,e=Wn.querySettings(Vn.Category.ENGINE,"builtinAssets");if(!e)return Promise.resolve();console.time("phase 9.3");var i=this._resources;return new Promise((function(n,r){RT.loadBundle(Wo.INTERNAL,(function(s){s?r(s):(console.timeEnd("phase 9.3"),console.time("phase 9.4"),RT.loadAny(e,(function(e,s){e?r(e):(console.timeEnd("phase 9.4"),s.forEach((function(e){i[e.name]=e,Ey.addIgnoredAsset(e),e instanceof v.Material&&t._materialsToBeCompiled.push(e)})),console.timeEnd("phase 9.2"),n())})))}))}))},e.compileBuiltinMaterial=function(){for(var t=0;t<this._materialsToBeCompiled.length;++t)for(var e=this._materialsToBeCompiled[t],i=0;i<e.passes.length;++i)e.passes[i].tryCompile();this._materialsToBeCompiled.length=0},t}(),IT=t("builtinResMgr",v.builtinResMgr=new MT),CT=t("getPhaseID",(wT=new Map,bT=0,function(t){return"number"==typeof t?t:(wT.has(t)||(wT.set(t,1<<bT),bT++),wT.get(t))})),xT=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,i){void 0===i&&(i=null);var n=t.instancedAttributeBlock,r=n.buffer.length;if(r){var s=t.inputAssembler,a=t.descriptorSet.getTexture(Km),o=i;o||(o=t.shaders[e]);for(var u=t.descriptorSet,h=0;h<this.instances.length;++h){var c,l,_=this.instances[h];if(!((null===(c=_.ia.indexBuffer)||void 0===c?void 0:c.objectID)!==(null===(l=s.indexBuffer)||void 0===l?void 0:l.objectID)||_.count>=1024)&&_.lightingMap.objectID===a.objectID&&_.stride===r){if(_.count>=_.capacity){_.capacity<<=1;var d=_.stride*_.capacity,f=_.data;_.data=new Uint8Array(d),_.data.set(f),_.vb.resize(d)}return _.shader=o,_.descriptorSet=u,_.data.set(n.buffer,_.stride*_.count++),void(this.hasPendingModels=!0)}}for(var p=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,32*r,r)),m=new Uint8Array(32*r),g=s.vertexBuffers.slice(),v=s.attributes.slice(),y=s.indexBuffer,T=0;T<n.attributes.length;T++){var E=n.attributes[T],S=new Ae(E.name,E.format,E.isNormalized,g.length,!0);v.push(S)}m.set(n.buffer),g.push(p);var A=new we(v,g,y),R=this._device.createInputAssembler(A);this.instances.push({count:1,capacity:32,vb:p,data:m,ia:R,stride:r,shader:o,descriptorSet:u,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),NT=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],i=0;i<e.vbs.length;++i)e.vbs[i].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,i){var n=t.subMesh.flatBuffers;if(0!==n.length){for(var r=0,s=0,a=n[0].count,o=t.passes[e],u=t.shaders[e],h=t.descriptorSet,c=!1,l=0;l<this.batches.length;++l){var _=this.batches[l];if(_.vbs.length===n.length&&_.mergeCount<Am.BATCHING_COUNT){c=!0;for(var d=0;d<_.vbs.length;++d)if(_.vbs[d].stride!==n[d].stride){c=!1;break}if(c){for(var f=0;f<_.vbs.length;++f){var p=n[f],m=_.vbs[f],g=_.vbDatas[f];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[f]=new Uint8Array(r),_.vbDatas[f].set(g)),_.vbDatas[f].set(p.buffer,_.vbCount*p.stride)}var v=_.vbIdxData;(s=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(s),_.vbIdxData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(v),v=_.vbIdxData);var y=_.vbCount,T=y+a,E=_.mergeCount;if(v[y]!==E||v[T-1]!==E)for(var S=y;S<T;S++)v[S]=E+.1;return da.toArray(_.uboData,i.transform.worldMatrix,Am.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(h.bindBuffer(Am.BINDING,_.ubo),h.update(),_.pass=o,_.shader=u,_.descriptorSet=h),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var A=[],R=[],w=[],b=0;b<n.length;++b){var O=n[b],M=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,O.count*O.stride,O.stride));M.update(O.buffer.buffer),A.push(M),R.push(new Uint8Array(M.size)),w.push(M)}var I=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,4*a,4)),C=new Float32Array(a);C.fill(0),I.update(C),w.push(I);for(var x=t.inputAssembler.attributes,N=new Array(x.length+1),B=0;B<x.length;++B)N[B]=x[B];N[x.length]=new Ae("a_dyn_batch_id",et.R32F,!1,n.length);var P=new we(N,w),D=this._device.createInputAssembler(P),F=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,Am.SIZE,Am.SIZE));h.bindBuffer(Am.BINDING,F),h.update();var L=new Float32Array(Am.COUNT);da.toArray(L,i.transform.worldMatrix,Am.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:A,vbDatas:R,vbIdx:I,vbIdxData:C,vbCount:a,ia:D,ubo:F,uboData:L,pass:o,shader:u,descriptorSet:h})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),BT=new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE),PT=new oe(null),DT=new Le(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(OT||(OT={}));var FT=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ai,this._dss=new Ei,this._rs=new Ti,this._priority=Vp.DEFAULT,this._stage=Hp.DEFAULT,this._phase=CT("default"),this._primitive=Ot.TRIANGLE_LIST,this._batchingScheme=OT.NONE,this._dynamicStates=xt.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._rootBufferDirty=!1,this._root=t,this._device=Wa.gfxDevice}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&(t._priority=e.priority),void 0!==e.primitive&&(t._primitive=e.primitive),void 0!==e.stage&&(t._stage=e.stage),void 0!==e.dynamicStates&&(t._dynamicStates=e.dynamicStates),void 0!==e.phase&&(t._phase=CT(e.phase));var i=t._bs;if(e.blendState){var n=e.blendState,r=n.targets;r&&r.forEach((function(t,e){i.setTarget(e,t)})),void 0!==n.isA2C&&(i.isA2C=n.isA2C),void 0!==n.isIndepend&&(i.isIndepend=n.isIndepend),void 0!==n.blendColor&&(i.blendColor=n.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,i=Xv.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return i+=function(t){for(var e,i=",bs,"+t.isA2C,n=p(t.targets);!(e=n()).done;){var r=e.value;i+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,i+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return i}(t._bs),i+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),pi(i+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=nt.UNKNOWN);var n=this._propertyHandleMap[t];return n?(i?n=Av(n,i):e&&(n=Av(n,yv(n)-e)),n+e):0},e.getBinding=function(e){var i=this.getHandle(e);return i?t.getBindingFromHandle(i):-1},e.setUniform=function(e,i){var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),s=t.getOffsetFromHandle(e),a=this._getBlockView(r,n);wv[r](a,i,s),this._rootBufferDirty=!0},e.getUniform=function(e,i){var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),s=t.getOffsetFromHandle(e),a=this._getBlockView(r,n);return Rv[r](a,i,s)},e.setUniformArray=function(e,i){for(var n=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),s=ni(r)>>2,a=this._getBlockView(r,n),o=t.getOffsetFromHandle(e),u=0;u<i.length;u++,o+=s)null!==i[u]&&wv[r](a,i[u],o);this._rootBufferDirty=!0},e.bindTexture=function(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)},e.bindSampler=function(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)},e.setDynamicState=function(t,e){var i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()):z(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new xT(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new NT(this))},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var i in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[i].destroy();for(var n in this._batchedBuffers)this._batchedBuffers[n].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy()},e.resetUniform=function(e){var i=this.getHandle(e);if(i){for(var n=t.getTypeFromHandle(i),r=t.getBindingFromHandle(i),s=t.getOffsetFromHandle(i),a=t.getCountFromHandle(i),o=this._getBlockView(n,r),u=this._properties[e],h=u&&u.value||Ov(n),c=(ni(n)>>2)*a,l=0;l+h.length<=c;l+=h.length)o.set(h,s+l);this._rootBufferDirty=!0}},e.resetTexture=function(e,i){var n=this.getHandle(e);if(n){var r=t.getTypeFromHandle(n),s=t.getBindingFromHandle(n),a=this._properties[e],o=a&&a.value,u=o?""+o+Mv(r):Ov(r),h=IT.get(u),c=h&&h.getGFXTexture(),l=a&&void 0!==a.samplerHash?Mi.unpackFromHash(a.samplerHash):h&&h.getSamplerInfo(),_=this._device.getSampler(l);this._descriptorSet.bindSampler(s,_,i||0),this._descriptorSet.bindTexture(s,c,i||0)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],i=0,n=0;n<e.members.length;n++){for(var r=e.members[n],s=this._getBlockView(r.type,e.binding),a=this._properties[r.name],o=a&&a.value||Ov(r.type),u=(ni(r.type)>>2)*r.count,h=0;h+o.length<=u;h+=o.length)s.set(o,i+h);i+=u}this._rootBufferDirty=!0},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],i=0;i<e.count;i++)this.resetTexture(e.name,i)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var i=Xv.getGFXShader(this._device,this._programName,this._defines,e);return i?(this._shader=i,this._pipelineLayout=Xv.getTemplateInfo(this._programName).pipelineLayout,this._hash=t.getPassHash(this),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,i=0;i<t.length;i++){var n=t[i];this._defines[n.name]=n.value}for(var r=Xv.getGFXShader(this._device,this._programName,this._defines,e),s=0;s<t.length;s++){var a=t[s];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._doInit=function(e,i){void 0===i&&(i=!1),this._priority=Vp.DEFAULT,this._stage=Hp.DEFAULT,this._phase=CT("default"),this._primitive=Ot.TRIANGLE_LIST,this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=i?a({},e.defines):e.defines,this._shaderInfo=Xv.getTemplate(e.program),this._properties=e.properties||this._properties;var n=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),DT.layout=Xv.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(DT);for(var r=this._shaderInfo.blocks,s=Xv.getTemplateInfo(e.program),o=s.blockSizes,u=s.handleMap,h=n.capabilities.uboOffsetAlignment,c=[],l=0,_=0,d=0;d<r.length;d++){var f=o[d];c.push(_),_+=Math.ceil(f/h)*h,l=f}var p=c[c.length-1]+l;p&&(BT.size=16*Math.ceil(p/16),this._rootBuffer=n.createBuffer(BT),this._rootBlock=new ArrayBuffer(p));for(var m=0,g=0;m<r.length;m++){var v=r[m].binding,y=o[m];PT.buffer=this._rootBuffer,PT.offset=c[g++],PT.range=16*Math.ceil(y/16);var T=this._buffers[v]=n.createBuffer(PT);this._blocks[v]=new Float32Array(this._rootBlock,PT.offset,y/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,T)}var E=this._propertyHandleMap=u,S={};for(var A in this._properties){var R=this._properties[A];R.handleInfo&&(S[A]=this.getHandle.apply(this,R.handleInfo))}Object.assign(E,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(tt.INSTANCED_ARRAYS)?this._batchingScheme=OT.INSTANCING:(this._defines.USE_INSTANCING=!1,this._batchingScheme=OT.NONE):this._defines.USE_BATCHING?this._batchingScheme=OT.VB_MERGING:this._batchingScheme=OT.NONE},e._getBlockView=function(t,e){return t<nt.FLOAT?this._blocksInt[e]:this._blocks[e]},e._initPassFromTarget=function(t,e,i){this._priority=t.priority,this._stage=t.stage,this._phase=t.phase,this._batchingScheme=t.batchingScheme,this._primitive=t.primitive,this._dynamicStates=t.dynamicStates,this._bs=t.blendState,this._dss=e,this._descriptorSet=t.descriptorSet,this._rs=t.rasterizerState,this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._pipelineLayout=Xv.getTemplateInfo(this._programName).pipelineLayout,this._hash=t._hash^i},e._updatePassHash=function(){this._hash=t.getPassHash(this)},s(t,[{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Xv.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();FT.getTypeFromHandle=yv,FT.getBindingFromHandle=Tv,FT.getCountFromHandle=Ev,FT.getOffsetFromHandle=Sv;var LT=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,i,n,r){var s=e.hash^n.hash^r.attributesHash^i.typedID,a=this._PSOHashMap.get(s);if(!a){var o=e.pipelineLayout,u=new Ge(r.attributes),h=new Ri(i,o,n,u,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(h),this._PSOHashMap.set(s,a)}return a},t}());LT._PSOHashMap=new Map;var UT=new ee,GT=new Kt;function kT(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var zT,HT,VT,WT,XT,jT,YT,KT,qT,QT=null;function ZT(t,e,i,n,r){if(n&&n.enabled&&r===QT){var s=n.subModels[0],a=s.inputAssembler,o=s.passes,u=s.shaders,h=s.descriptorSet;UT.width=GT.width=r.window.width,UT.height=GT.height=r.window.height;var c=LT.getOrCreatePipelineState(t,o[0],u[0],e,a);i.setViewport(UT),i.setScissor(GT),i.bindPipelineState(c),i.bindDescriptorSet($p.MATERIAL,o[0].descriptorSet),i.bindDescriptorSet($p.LOCAL,h),i.bindInputAssembler(a),i.draw(a)}}var JT=new ta,$T=t("Material",(zT=ao("cc.Material"),HT=xo(Zv),zT((WT=function(t){function e(){var e;return(e=t.call(this)||this)._effectAsset=XT&&XT(),e._techIdx=jT&&jT(),e._defines=YT&&YT(),e._states=KT&&KT(),e._props=qT&&qT(),e._passes=[],e._hash=0,e}o(e,t),e.getHash=function(t){for(var e,i=0,n=p(t.passes);!(e=n()).done;)i^=e.value.hash;return i};var i=e.prototype;return i.initialize=function(t){this._passes.length?G(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},i.reset=function(t){this.initialize(t)},i.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},i.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},i.onLoaded=function(){this._update()},i.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var i,n=p(this._passes);!(i=n()).done;){var r=i.value;r.resetUBOs(),r.resetTextures()}},i.setProperty=function(t,e,i){var n=!1;if(void 0===i)for(var r=this._passes,s=r.length,a=0;a<s;a++){var o=r[a];this._uploadProperty(o,t,e)&&(this._props[o.propertyIndex][t]=e,n=!0)}else{if(i>=this._passes.length)return void console.warn("illegal pass index: "+i+".");var u=this._passes[i];this._uploadProperty(u,t,e)&&(this._props[u.propertyIndex][t]=e,n=!0)}n||console.warn("illegal property name: "+t+".")},i.getProperty=function(t,e){if(void 0===e)for(var i=this._props,n=i.length,r=0;r<n;r++){var s=i[r];if(t in s)return s[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},i.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var i=0;i<t._props.length;i++)this._props[i]=a({},t._props[i]);this._defines.length=t._defines.length;for(var n=0;n<t._defines.length;n++)this._defines[n]=a({},t._defines[n]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=a({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},i._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Zv.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},i._prepareInfo=function(t,e){var i=t;if(!Array.isArray(i)){var n=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(n).fill(i)}for(var r=0;r<i.length;++r)Object.assign(e[r]||(e[r]={}),i[r])},i._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,i=[],n=0;n<e;++n){var r=t.passes[n],s=r.passIndex=n,a=r.defines=this._defines[s]||(this._defines[s]={});if(r.stateOverrides=this._states[s]||(this._states[s]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var o=new FT(v.director.root);o.initialize(r),i.push(o)}}return i},i._update=function(t){var i=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var n=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=n,t)this._passes.forEach((function(t,e){var n=i._props[e];for(var r in n||(n=i._props[e]={}),void 0!==t.propertyIndex&&Object.assign(n,i._props[t.propertyIndex]),n)i._uploadProperty(t,r,n[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},i._uploadProperty=function(t,e,i){var n=t.getHandle(e);if(!n)return!1;if(FT.getTypeFromHandle(n)<nt.SAMPLER1D)if(Array.isArray(i))t.setUniformArray(n,i);else if(null!==i){var r;if(null!==(r=t.properties[e])&&void 0!==r&&r.linear){var s=i;kT(JT,s),JT.w=s.w,i=JT}t.setUniform(n,i)}else t.resetUniform(e);else if(Array.isArray(i))for(var a=0;a<i.length;a++)this._bindTexture(t,n,i[a],a);else i?this._bindTexture(t,n,i):t.resetTexture(e);return!0},i._bindTexture=function(t,e,i,n){var r=FT.getBindingFromHandle(e);if(i instanceof Ci)t.bindTexture(r,i,n);else if(i instanceof Of){var s=i.getGFXTexture();if(!s||!s.width||!s.height)return;t.bindTexture(r,s,n),t.bindSampler(r,i.getGFXSampler(),n)}},i._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=p(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"builtin-unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new Aa("#ff00ff"))},i.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},s(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Tu),XT=Za(WT.prototype,"_effectAsset",[HT],(function(){return null})),jT=Za(WT.prototype,"_techIdx",[mo],(function(){return 0})),YT=Za(WT.prototype,"_defines",[mo],(function(){return[]})),KT=Za(WT.prototype,"_states",[mo],(function(){return[]})),qT=Za(WT.prototype,"_props",[mo],(function(){return[]})),VT=WT))||VT));v.Material=$T;var tE,eE,iE,nE,rE,sE,aE,oE,uE,hE,cE,lE=function(t){function e(e,i){var n;(n=t.call(this,e.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=e,n._owner=i,n._doInit(n._parent,!0);for(var r=0;r<n._shaderInfo.blocks.length;r++){var s=n._shaderInfo.blocks[r],a=n._blocks[s.binding],o=n._parent.blocks[s.binding];a.set(o)}n._rootBufferDirty=!0;for(var u=n._parent,h=0;h<n._shaderInfo.samplerTextures.length;h++)for(var c=n._shaderInfo.samplerTextures[h],l=0;l<c.count;l++){var _=u._descriptorSet.getSampler(c.binding,l),f=u._descriptorSet.getTexture(c.binding,l);n._descriptorSet.bindSampler(c.binding,_,l),n._descriptorSet.bindTexture(c.binding,f,l)}return t.prototype.tryCompile.call(d(n)),n}o(e,t);var i=e.prototype;return i.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),FT.fillPipelineInfo(this,t),FT.fillPipelineInfo(this,e),this._onStateChange()},i.tryCompile=function(e){if(e&&!Iv(this._defines,e))return!1;var i=t.prototype.tryCompile.call(this);return this._onStateChange(),i},i.beginChangeStatesSilently=function(){this._dontNotify=!0},i.endChangeStatesSilently=function(){this._dontNotify=!1},i._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._batchingScheme=OT.NONE},i._onStateChange=function(){this._hash=FT.getPassHash(this),this._owner.onPassStateChange(this._dontNotify)},s(e,[{key:"parent",get:function(){return this._parent}}]),e}(FT),_E=function(t){function e(e){var i;return(i=t.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=e.parent,i._owner=e.owner||null,i._subModelIdx=e.subModelIdx||0,i.copy(i._parent),i}o(e,t);var i=e.prototype;return i.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var i,n=p(this._passes);!(i=n()).done;)i.value.tryCompile(t);else this._passes[e].tryCompile(t)},i.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var n=0;n<this._passes.length;n++){var r=this._passes[n],s=this._states[n]||(this._states[n]={});for(var a in t)s[a]=t[a];r.overridePipelineStates(i[r.passIndex],s)}else{var o=this._states[e]||(this._states[e]={});for(var u in t)o[u]=t[u];this._passes[e].overridePipelineStates(i[e],o)}}},i.destroy=function(){return this._doDestroy(),!0},i.onPassStateChange=function(t){this._hash=$T.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},i._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var i=0;i<e.length;++i)t.push(new lE(e[i],this));return t},s(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}($T),dE={parent:null,owner:null,subModelIdx:0},fE=t("Renderer",(tE=ao("cc.Renderer"),eE=xo($T),iE=xo([$T]),tE(nE=ho((m((rE=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._materials=sE&&sE(),e._materialInstances=[],e}o(e,t);var i=e.prototype;return i.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},i.setMaterial=function(t,e){t&&t instanceof _E&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var i=this._materialInstances[e];i&&(i.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},i.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){dE.parent=this._materials[t],dE.owner=this,dE.subModelIdx=t;var e=new _E(dE);dE.parent=null,dE.owner=null,dE.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},i.setMaterialInstance=function(t,e){if("number"==typeof t){G(12007);var i=t;t=e,e=i}var n=this._materialInstances[e];t&&t.parent?t!==n&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||n)&&this.setMaterial(t,e)},i.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},i._onMaterialModified=function(){},i._onRebuildPSO=function(){},i._clearMaterials=function(){},s(e,[{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var i=t.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(t.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){for(var e=t.length,i=this._materials.length,n=e;n<i;n++)this.setMaterialInstance(null,n);this._materials.length=e,this._materialInstances.length=e;for(var r=0;r<e;r++)this._materialInstances[r]!=t[r]&&this.setMaterialInstance(t[r],r)}}]),e}(el)).prototype,"sharedMaterials",[eE],Object.getOwnPropertyDescriptor(rE.prototype,"sharedMaterials"),rE.prototype),sE=Za(rE.prototype,"_materials",[iE],(function(){return[]})),nE=rE))||nE)||nE)),pE=t("ModelRenderer",ao("cc.ModelRenderer")((oE=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._visFlags=uE&&uE(),e._models=[],e._priority=0,e}o(e,t);var i=e.prototype;return i._collectModels=function(){return this._models},i.onEnable=function(){this._updatePriority()},i._attachToScene=function(){},i._detachFromScene=function(){},i._onVisibilityChange=function(){},i._updatePriority=function(){if(this._models.length>0)for(var t=0;t<this._models.length;t++)this._models[t].priority=this._priority},s(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"priority",get:function(){return this._priority},set:function(t){t!==this._priority&&(this._priority=t,this._updatePriority())}}]),e}(fE),uE=Za(oE.prototype,"_visFlags",[mo],(function(){return $f.Enum.NONE})),aE=oE))||aE),mE=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());mE.NO_TYPE="no_type",mE.TOUCH="touch",mE.MOUSE="mouse",mE.KEYBOARD="keyboard",mE.ACCELERATION="acceleration",mE.NONE=0,mE.CAPTURING_PHASE=1,mE.AT_TARGET=2,mE.BUBBLING_PHASE=3,v.Event=mE,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(hE||(hE=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.GAMEPAD_INPUT="gamepad-input",t.GAMEPAD_CHANGE="gamepad-change",t.HANDLE_INPUT="handle-input",t.HANDLE_POSE_INPUT="handle-pose-input",t.HMD_POSE_INPUT="hmd-pose-input"}(cE||(cE={})),v.SystemEventType=hE;var gE=t("EventAcceleration",function(t){function e(e,i){var n;return(n=t.call(this,hE.DEVICEMOTION,i)||this).acc=void 0,n.acc=e,n}return o(e,t),e}(mE));mE.EventAcceleration=gE;var vE=t("EventKeyboard",function(t){function e(e,i,n){var r;return"boolean"==typeof i&&(i=i?hE.KEY_DOWN:hE.KEY_UP),(r=t.call(this,i,n)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=i!==hE.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return o(e,t),s(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(mE));mE.EventKeyboard=vE;var yE=t("EventMouse",function(t){function e(i,n,r){var s;return(s=t.call(this,i,n)||this).movementX=0,s.movementY=0,s.preventSwallow=!1,s._eventType=void 0,s._button=e.BUTTON_MISSING,s._x=0,s._y=0,s._prevX=0,s._prevY=0,s._scrollX=0,s._scrollY=0,s._eventType=i,r&&(s._prevX=r.x,s._prevY=r.y),s}o(e,t);var i=e.prototype;return i.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(t,e){this._x=t,this._y=e},i.getLocation=function(t){return t||(t=new Qs),Qs.set(t,this._x,this._y),t},i.getLocationInView=function(t){return t||(t=new Qs),Qs.set(t,this._x,v.view._designResolutionSize.height-this._y),t},i.getUILocation=function(t){return t||(t=new Qs),Qs.set(t,this._x,this._y),v.view._convertToUISpace(t),t},i.getPreviousLocation=function(t){return t||(t=new Qs),Qs.set(t,this._prevX,this._prevY),t},i.getUIPreviousLocation=function(t){return t||(t=new Qs),Qs.set(t,this._prevX,this._prevY),v.view._convertToUISpace(t),t},i.getDelta=function(t){return t||(t=new Qs),Qs.set(t,this._x-this._prevX,this._y-this._prevY),t},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(t){return t||(t=new Qs),Qs.set(t,(this._x-this._prevX)/v.view.getScaleX(),(this._y-this._prevY)/v.view.getScaleY()),t},i.getUIDeltaX=function(){return(this._x-this._prevX)/v.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/v.view.getScaleY()},i.setButton=function(t){this._button=t},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var t=v.view.getViewportRect();return(this._x-t.x)/v.view.getScaleX()},i.getUILocationY=function(){var t=v.view.getViewportRect();return(this._y-t.y)/v.view.getScaleY()},s(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(mE));yE.BUTTON_MISSING=-1,yE.BUTTON_LEFT=0,yE.BUTTON_RIGHT=2,yE.BUTTON_MIDDLE=1,yE.BUTTON_4=3,yE.BUTTON_5=4,yE.BUTTON_6=5,yE.BUTTON_7=6,yE.BUTTON_8=7,mE.EventMouse=yE;var TE=new Qs,EE=t("EventTouch",function(t){function e(e,i,n,r){var s;return void 0===r&&(r=[]),(s=t.call(this,n,i)||this).touch=null,s.simulate=!1,s.preventSwallow=!1,s._eventCode=void 0,s._touches=void 0,s._allTouches=void 0,s._eventCode=n,s._touches=e||[],s._allTouches=r,s}o(e,t);var i=e.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},i.getLocation=function(t){return this.touch?this.touch.getLocation(t):new Qs},i.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new Qs},i.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new Qs},i.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new Qs},i.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new Qs},i.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new Qs},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(t){return this.touch?this.touch.getDelta(t):new Qs},i.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new Qs},i.getDeltaX=function(){return this.touch?this.touch.getDelta(TE).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(TE).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(mE));EE.MAX_TOUCHES=5,mE.EventTouch=EE;var SE,AE=t("EventGamepad",function(t){function e(e,i){var n;return(n=t.call(this,e,!1)||this).gamepad=void 0,n.gamepad=i,n}return o(e,t),e}(mE)),RE=(t("EventHandle",function(t){function e(e,i){var n;return(n=t.call(this,e,!1)||this).handleInputDevice=void 0,n.handleInputDevice=i,n}return o(e,t),e}(mE)),t("EventHMD",function(t){function e(e,i){var n;return(n=t.call(this,e,!1)||this).hmdInputDevice=void 0,n.hmdInputDevice=i,n}return o(e,t),e}(mE)),t("Acceleration",(function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=i,this.timestamp=n})));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(SE||(SE=t("KeyCode",{})));var wE=new Qs,bE=t("Touch",function(){function t(t,e,i){void 0===i&&(i=0),this._point=new Qs,this._prevPoint=new Qs,this._lastModified=0,this._id=0,this._startPoint=new Qs,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new Qs),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new Qs),t.set(this._point.x,this._point.y),v.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=v.view.getViewportRect();return(this._point.x-t.x)/v.view.getScaleX()},e.getUILocationY=function(){var t=v.view.getViewportRect();return(this._point.y-t.y)/v.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new Qs),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new Qs),t.set(this._prevPoint.x,this._prevPoint.y),v.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new Qs),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new Qs),t.set(this._startPoint.x,this._startPoint.y),v.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new Qs),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new Qs),wE.set(this._point),wE.subtract(this._prevPoint),t.set(v.view.getScaleX(),v.view.getScaleY()),Qs.divide(t,wE,t),t},e.getLocationInView=function(t){return t||(t=new Qs),t.set(this._point.x,v.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new Qs),t.set(this._prevPoint.x,v.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new Qs),t.set(this._startPoint.x,v.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,i){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new Qs(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new Qs(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=v.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new Qs(t.x,t.y):new Qs(t||0,e||0),this._lastModified=v.game.frameStartTime},s(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());v.Touch=bE;var OE,ME=new Array(16),IE=null,CE=new Qs,xE=[tp.TOUCH_START,tp.TOUCH_MOVE,tp.TOUCH_END,tp.TOUCH_CANCEL],NE=[tp.MOUSE_DOWN,tp.MOUSE_ENTER,tp.MOUSE_MOVE,tp.MOUSE_LEAVE,tp.MOUSE_UP,tp.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(OE||(OE={}));var BE,PE,DE,FE,LE,UE,GE,kE,zE,HE,VE=function(){function t(t){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._dispatchingTouch=null,this._isEnabled=!1,this._node=void 0,this._node=t}var e=t.prototype;return e.setEnabled=function(e,i){if(void 0===i&&(i=!1),this._isEnabled!==e){this._isEnabled=e;var n=this.node.children;if(e&&this._attachMask(),t.callbacksInvoker.emit(OE.MARK_LIST_DIRTY),i&&n.length>0)for(var r=0;r<n.length;++r)n[r]._eventProcessor.setEnabled(e,!0)}},e.reattach=function(){var e,i=this;this.node.walk((function(n){e||(e=i._searchComponentsInParent(t._maskComp)),n.eventProcessor.maskList=e}))},e.destroy=function(){if(IE===this._node&&(IE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(OE.REMOVE_POINTER_EVENT_PROCESSOR,this),this._dispatchingTouch){var e=new EE([this._dispatchingTouch],!0,cE.TOUCH_CANCEL);e.touch=this._dispatchingTouch,this.dispatchEvent(e),this._dispatchingTouch=null}},e.on=function(t,e,i,n){var r,s;return this._tryEmittingAddEvent(t),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,i),e},e.once=function(t,e,i,n){var r,s;return this._tryEmittingAddEvent(t),((n=!!n)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(s=this.bubblingTarget)&&void 0!==s?s:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,i,!0),e},e.off=function(t,e,i,n){var r;null===(r=(n=!!n)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,i)},e.targetOff=function(e){var i,n;null===(i=this.capturingTarget)||void 0===i||i.removeAll(e),null===(n=this.bubblingTarget)||void 0===n||n.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(OE.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(t,e,i,n,r,s){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,i,n,r,s)},e.dispatchEvent=function(t){var e,i=this.node,n=0;for(t.target=i,ME.length=0,this.getCapturingTargets(t.type,ME),t.eventPhase=1,n=ME.length-1;n>=0;--n)if((e=ME[n]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,ME),t.propagationStopped))return void(ME.length=0);if(ME.length=0,t.eventPhase=2,t.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,ME),t.eventPhase=3,n=0;n<ME.length;++n)if((e=ME[n]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(ME.length=0);ME.length=0},e.hasEventListener=function(t,e,i){var n=!1;return this.bubblingTarget&&(n=this.bubblingTarget.hasEventListener(t,e,i)),!n&&this.capturingTarget&&(n=this.capturingTarget.hasEventListener(t,e,i)),n},e.getCapturingTargets=function(t,e){for(var i=this._node.parent;i;){var n;null!==(n=i.eventProcessor.capturingTarget)&&void 0!==n&&n.hasEventListener(t)&&e.push(i),i=i.parent}},e.getBubblingTargets=function(t,e){for(var i=this._node.parent;i;){var n;null!==(n=i.eventProcessor.bubblingTarget)&&void 0!==n&&n.hasEventListener(t)&&e.push(i),i=i.parent}},e._searchComponentsInParent=function(t){var e=this.node;if(t){for(var i=0,n=[],r=e;r&&kp.isNode(r);r=r.parent,++i){var s=r.getComponent(t);if(s){var a={index:i,comp:s};n?n.push(a):n=[a]}}return n.length>0?n:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e._isTouchEvent=function(t){return-1!==xE.indexOf(t)},e._isMouseEvent=function(t){return-1!==NE.indexOf(t)},e._hasTouchListeners=function(){for(var t=0;t<xE.length;++t){var e=xE[t];if(this.hasEventListener(e))return!0}return!1},e._hasMouseListeners=function(){for(var t=0;t<NE.length;++t){var e=NE[t];if(this.hasEventListener(e))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var i=this._isTouchEvent(e),n=this._isMouseEvent(e);i?this.shouldHandleEventTouch=!0:n&&(this.shouldHandleEventMouse=!0),!i&&!n||this._hasPointerListeners()||t.callbacksInvoker.emit(OE.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,i=new $r;return i._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(OE.REMOVE_POINTER_EVENT_PROCESSOR,e)})),i},e._handleEventMouse=function(t){switch(t.type){case cE.MOUSE_DOWN:return this._handleMouseDown(t);case cE.MOUSE_MOVE:return this._handleMouseMove(t);case cE.MOUSE_UP:return this._handleMouseUp(t);case cE.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},e._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(CE),!e._uiProps.uiTransformComp.hitTest(CE)||(t.type=tp.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},e._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(CE),e._uiProps.uiTransformComp.hitTest(CE)?(this.previousMouseIn||(IE&&IE!==e&&(t.type=tp.MOUSE_LEAVE,IE.dispatchEvent(t),IE.eventProcessor.previousMouseIn=!1),IE=e,t.type=tp.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=tp.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=tp.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,IE=null),1)))},e._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(CE),!e._uiProps.uiTransformComp.hitTest(CE)||(t.type=tp.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},e._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(CE),!e._uiProps.uiTransformComp.hitTest(CE)||(t.type=tp.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},e._handleEventTouch=function(t){switch(t.type){case cE.TOUCH_START:return this._handleTouchStart(t);case cE.TOUCH_MOVE:return this._handleTouchMove(t);case cE.TOUCH_END:return this._handleTouchEnd(t);case cE.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},e._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getLocation(CE),!e._uiProps.uiTransformComp.hitTest(CE)||(t.type=tp.TOUCH_START,t.bubbles=!0,this._dispatchingTouch=t.touch,e.dispatchEvent(t),0)))},e._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=tp.TOUCH_MOVE,t.bubbles=!0,this._dispatchingTouch=t.touch,e.dispatchEvent(t),0))},e._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getLocation(CE),e._uiProps.uiTransformComp.hitTest(CE)?t.type=tp.TOUCH_END:t.type=tp.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t),this._dispatchingTouch=null)},e._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=tp.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},s(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();VE._maskComp=null,VE.callbacksInvoker=new $r,v.NodeEventProcessor=VE,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(zE||(zE={})),function(t){t[t.NONE=0]="NONE",t[t.AUTO=1]="AUTO",t[t.BAKED_CONVOLUTION_MAP=2]="BAKED_CONVOLUTION_MAP"}(HE||(HE={}));var WE=t("TextureCube",ao("cc.TextureCube")((kE=GE=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).isRGBE=DE&&DE(),e._mipmapAtlas=FE&&FE(),e._mipmapMode=LE&&LE(),e._mipmaps=UE&&UE(),e}o(e,t);var i=e.prototype;return i.isUsingOfflineMipmaps=function(){return this._mipmapMode===HE.BAKED_CONVOLUTION_MAP},e.fromTexture2DArray=function(t,i){for(var n=[],r=t.length/6,s=0;s<r;s++){var a=6*s;n.push({front:t[a+zE.front].image,back:t[a+zE.back].image,left:t[a+zE.left].image,right:t[a+zE.right].image,top:t[a+zE.top].image,bottom:t[a+zE.bottom].image})}return(i=i||new e).mipmaps=n,i},i.onLoaded=function(){this._mipmapMode===HE.BAKED_CONVOLUTION_MAP?this.mipmapAtlas=this._mipmapAtlas:this.mipmaps=this._mipmaps},i.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format);var e=void 0===t.mipmapLevel?1:t.mipmapLevel;this._setMipmapLevel(e);var i=void 0===t.baseLevel?0:t.baseLevel,n=void 0===t.maxLevel?1e3:t.maxLevel;this._setMipRange(i,n),this._tryReset()},i.updateMipmaps=function(t,e){var i=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var n=t+e;XE(i._mipmaps[n],(function(t,e){i._assignImage(t,n,e)}))},s=0;s<n;++s)r(s)},i.destroy=function(){return this._mipmaps=[],this._mipmapAtlas=null,t.prototype.destroy.call(this)},i.releaseTexture=function(){this.mipmaps=[],this._mipmapAtlas=null},i._serialize=function(){return null},i._deserialize=function(e,i){var n=e;if(t.prototype._deserialize.call(this,n.base,i),this.isRGBE=n.rgbe,this._mipmapMode=n.mipmapMode,this._mipmapMode===HE.BAKED_CONVOLUTION_MAP){var r=n.mipmapAtlas,s=n.mipmapLayout;this._mipmapAtlas={atlas:{},layout:s},this._mipmapAtlas.atlas={front:new $v,back:new $v,left:new $v,right:new $v,top:new $v,bottom:new $v};var a=Dn.getClassId($v);i.result.push(this._mipmapAtlas.atlas,"front",r.front,a),i.result.push(this._mipmapAtlas.atlas,"back",r.back,a),i.result.push(this._mipmapAtlas.atlas,"left",r.left,a),i.result.push(this._mipmapAtlas.atlas,"right",r.right,a),i.result.push(this._mipmapAtlas.atlas,"top",r.top,a),i.result.push(this._mipmapAtlas.atlas,"bottom",r.bottom,a)}else{this._mipmaps=new Array(n.mipmaps.length);for(var o=0;o<n.mipmaps.length;++o){this._mipmaps[o]={front:new $v,back:new $v,left:new $v,right:new $v,top:new $v,bottom:new $v};var u=n.mipmaps[o],h=Dn.getClassId($v);i.result.push(this._mipmaps[o],"front",u.front,h),i.result.push(this._mipmaps[o],"back",u.back,h),i.result.push(this._mipmaps[o],"left",u.left,h),i.result.push(this._mipmaps[o],"right",u.right,h),i.result.push(this._mipmaps[o],"top",u.top,h),i.result.push(this._mipmaps[o],"bottom",u.bottom,h)}}},i._getGfxTextureCreateInfo=function(t){var e=new le(ut.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},i._getGfxTextureViewCreateInfo=function(t){var e=new _e;return e.type=ut.CUBE,e.baseLayer=0,e.layerCount=6,Object.assign(e,t),e},i.initDefault=function(e){t.prototype.initDefault.call(this,e);var i=new $v;i.initDefault(),this.mipmaps=[{front:i,back:i,top:i,bottom:i,left:i,right:i}]},i.validate=function(){if(this._mipmapMode===HE.BAKED_CONVOLUTION_MAP){if(null===this.mipmapAtlas||0===this.mipmapAtlas.layout.length)return!1;var t=this.mipmapAtlas.atlas;return!!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},s(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var i=this._mipmaps[0].front;this.reset({width:i.width,height:i.height,format:i.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(t,i){XE(t,(function(t,n){e._assignImage(t,i,n)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"mipmapAtlas",get:function(){return this._mipmapAtlas},set:function(t){var e=this;if(this._mipmapAtlas=t,this._mipmapAtlas){var i=this._mipmapAtlas.atlas.front;if(i.data){var n=this._mipmapAtlas.atlas,r=this._mipmapAtlas.layout,s=r[0],a=Object.assign(document.createElement("canvas"),{width:i.width,height:i.height}).getContext("2d");this.reset({width:s.width,height:s.height,format:i.format,mipmapLevel:r.length});for(var o=function(t){var s=r[t];XE(n,(function(t,n){a.clearRect(0,0,i.width,i.height);var r=t.data;a.drawImage(r,0,0);var o=a.getImageData(s.left,s.top,s.width,s.height),u=new $v({_data:o.data,_compressed:t.isCompressed,width:o.width,height:o.height,format:t.format});e._assignImage(u,s.level,n)}))},u=0;u<r.length;u++)o(u)}}else this.reset({width:0,height:0,mipmapLevel:0})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(dy),GE.FaceIndex=zE,DE=Za((PE=kE).prototype,"isRGBE",[mo],(function(){return!1})),FE=Za(PE.prototype,"_mipmapAtlas",[mo],(function(){return null})),LE=Za(PE.prototype,"_mipmapMode",[mo],(function(){return HE.NONE})),UE=Za(PE.prototype,"_mipmaps",[mo],(function(){return[]})),BE=PE))||BE);function XE(t,e){e(t.front,zE.front),e(t.back,zE.back),e(t.left,zE.left),e(t.right,zE.right),e(t.top,zE.top),e(t.bottom,zE.bottom)}v.TextureCube=WE;var jE=function(){function t(){this._groundAlbedoHDR=new ta(.2,.2,.2,1),this._skyColorHDR=new ta(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new ta(.2,.2,.2,1),this._skyColorLDR=new ta(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}return t.prototype.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}}]),t}();jE.SUN_ILLUM=65e3,jE.SKY_ILLUM=2e4,v.Ambient=jE;var YE=Ln({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),KE=Ln({Planar:0,ShadowMap:1}),qE=Ln({HARD:0,SOFT:1,SOFT_2X:2,SOFT_4X:3}),QE=Ln({LEVEL_1:1,LEVEL_2:2,LEVEL_3:3,LEVEL_4:4}),ZE=Ln({NONE:1,RemoveDuplicates:2,DisableRotationFix:3}),JE=KE.ShadowMap+1,$E=function(){function t(){this.fixedSphere=new Hu(0,0,0,.01),this.maxReceived=4,this._matLight=new da,this._material=null,this._instancingMaterial=null,this._enabled=!1,this._type=JE,this._distance=0,this._normal=new js(0,1,0),this._shadowColor=new Aa(0,0,0,76),this._size=new Qs(1024,1024),this._shadowMapDirty=!1}var e=t.prototype;return e.getPlanarShader=function(t){this._material||(this._material=new $T,this._material.initialize({effectName:"pipeline/planar-shadow"}));var e=this._material.passes;return e.length>0?e[0].getShaderVariant(t):null},e.getPlanarInstanceShader=function(t){this._instancingMaterial||(this._instancingMaterial=new $T,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}));var e=this._instancingMaterial.passes;return e.length>0?e[0].getShaderVariant(t):null},e.initialize=function(t){this._enabled=t.enabled,this._type=this.enabled?t.type:JE,this.normal=t.planeDirection,this.distance=t.planeHeight,this.shadowColor=t.shadowColor,this.maxReceived=t.maxReceived,t.shadowMapSize!==this._size.x&&(this.size.set(t.shadowMapSize,t.shadowMapSize),this._shadowMapDirty=!0)},e.activate=function(){if(this._enabled)if(this.type===KE.Planar)this._updatePlanarInfo();else{var t=v.director.root;t.pipeline.macros.CC_SHADOW_TYPE=2,t.onGlobalPipelineStateChanged()}else{var e=v.director.root;e.pipeline.macros.CC_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()}},e._updatePlanarInfo=function(){this._material||(this._material=new $T,this._material.initialize({effectName:"pipeline/planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new $T,this._instancingMaterial.initialize({effectName:"pipeline/planar-shadow",defines:{USE_INSTANCING:!0}}));var t=v.director.root;t.pipeline.macros.CC_SHADOW_TYPE=1,t.onGlobalPipelineStateChanged()},e.destroy=function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,this.activate()}},{key:"type",get:function(){return this._type},set:function(t){this._type=this.enabled?t:JE,this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){js.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}}]),t}();$E.MAX_FAR=2e3,$E.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),v.Shadows=$E;var tS=null,eS=null,iS=Ln({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),nS=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1,this._editableMaterial=null,this._activated=!1,this._reflectionHDR=null,this._reflectionLDR=null,this._rotationAngle=0}var e=t.prototype;return e.initialize=function(t){this._activated=!1,this._enabled=t.enabled,this._useIBL=t.useIBL,this._useDiffuseMap=t.applyDiffuseMap,this._useHDR=t.useHDR},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.setSkyboxMaterial=function(t){t?(this._editableMaterial=new _E({parent:t}),this._editableMaterial.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})):this._editableMaterial=null,this._updatePipeline()},e.setReflectionMaps=function(t,e){this._reflectionHDR=t,this._reflectionLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.setRotationAngle=function(t){this._rotationAngle=t},e.getRotationAngle=function(){return this._rotationAngle},e.updateMaterialRenderInfo=function(){this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=v.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=IT.get("default-cube-texture"),this._model||(this._model=v.director.root.createModel(v.renderer.scene.Model));var e=this._default.isRGBE;if(this._default.isUsingOfflineMipmaps(),this.envmap&&(e=this.envmap.isRGBE,this.envmap.isUsingOfflineMipmaps()),!eS){var i=new $T;i.initialize({effectName:"pipeline/skybox",defines:{USE_RGBE_CUBEMAP:e}}),eS=new _E({parent:i})}this.enabled&&(tS||(tS=v.utils.createMesh(v.primitives.box({width:2,height:2,length:2}))),this._editableMaterial?this._model.initSubModel(0,tS.renderingSubMeshes[0],this._editableMaterial):this._model.initSubModel(0,tS.renderingSubMeshes[0],eS)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline(),this._activated=!0},e._updatePipeline=function(){var t=v.director.root,e=t.pipeline,i=this.useIBL?this.isRGBE?2:1:0,n=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR,s=this.useConvolutionMap;if(e.macros.CC_USE_IBL===i&&e.macros.CC_USE_DIFFUSEMAP===n&&e.macros.CC_USE_HDR===r&&e.macros.CC_IBL_CONVOLUTED===s||(e.macros.CC_USE_IBL=i,e.macros.CC_USE_DIFFUSEMAP=n,e.macros.CC_USE_HDR=r,e.macros.CC_IBL_CONVOLUTED=s,this._activated&&t.onGlobalPipelineStateChanged()),this.enabled){var a=this.envmap?this.envmap:this._default,o=this._editableMaterial?this._editableMaterial:eS;o&&(o.setProperty("environmentMap",a),o.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE})),this._model&&(this._model.setSubModelMaterial(0,o),this._updateSubModes())}},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=Wa.gfxDevice;if(this.reflectionMap){var e=this.reflectionMap.getGFXTexture(),i=t.getSampler(this.reflectionMap.getSamplerInfo());this._globalDSManager.bindSampler(lm,i),this._globalDSManager.bindTexture(lm,e)}else{var n=this.envmap?this.envmap:this._default;if(n){var r=n.getGFXTexture(),s=t.getSampler(n.getSamplerInfo());this._globalDSManager.bindSampler(lm,s),this._globalDSManager.bindTexture(lm,r)}}var a=this.diffuseMap?this.diffuseMap:this._default;if(a){var o=a.getGFXTexture(),u=t.getSampler(a.getSamplerInfo());this._globalDSManager.bindSampler(fm,u),this._globalDSManager.bindTexture(fm,o)}this._globalDSManager.update()}},e._updateSubModes=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;e++)t[e].update()},s(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._useHDR=t,this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"useConvolutionMap",get:function(){return this.reflectionMap?this.reflectionMap.isUsingOfflineMipmaps():!!this.envmap&&this.envmap.isUsingOfflineMipmaps()}},{key:"envmap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"reflectionMap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR}}]),t}();v.Skybox=nS;var rS,sS,aS,oS,uS,hS,cS,lS,_S,dS,fS,pS,mS,gS,vS,yS,TS,ES,SS,AS,RS,wS,bS,OS,MS,IS,CS,xS,NS,BS,PS,DS,FS,LS,US,GS,kS,zS,HS,VS,WS,XS,jS,YS,KS,qS,QS,ZS,JS,$S,tA,eA,iA,nA,rA,sA,aA,oA,uA,hA,cA,lA,_A,dA,fA,pA,mA,gA,vA,yA,TA,EA,SA,AA,RA,wA,bA,OA,MA,IA,CA,xA,NA,BA,PA,DA,FA,LA,UA,GA,kA,zA,HA,VA,WA=new ta,XA=Ln({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),jA=XA.LAYERED+1,YA=function(){function t(){this._fogColor=new Aa("#C8C8C8"),this._colorArray=new ta(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._activated=!1}var e=t.prototype;return e.initialize=function(t){this._activated=!1,this.fogColor=t.fogColor,this._enabled=t.enabled,this._type=this.enabled?t.type:jA,this._accurate=t.accurate,this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline(),this._activated=!0},e._updatePipeline=function(){var t=v.director.root,e=this.enabled?this.type:jA,i=this.accurate?1:0,n=t.pipeline;n.macros.CC_USE_FOG===e&&n.macros.CC_USE_ACCURATE_FOG===i||(n.macros.CC_USE_FOG=e,n.macros.CC_USE_ACCURATE_FOG=i,this._activated&&t.onGlobalPipelineStateChanged())},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t,t?this.activate():(this._type=jA,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate=t,this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),WA.set(t.x,t.y,t.z,t.w),kT(this._colorArray,WA)}},{key:"type",get:function(){return this._type},set:function(t){this._type=this.enabled?t:jA,this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}}]),t}();v.Fog=YA;var KA=new js(0,1,0),qA=new js,QA=new ta,ZA=new Aa,JA=new sa,$A=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},tR=t("AmbientInfo",(rS=ao("cc.AmbientInfo"),sS=xo(fr),aS=go("_skyColor"),oS=go("_skyIllum"),uS=go("_groundAlbedo"),rS((m((cS=function(){function t(){this._skyColorHDR=lS&&lS(),this._skyIllumHDR=_S&&_S(),this._groundAlbedoHDR=dS&&dS(),this._skyColorLDR=fS&&fS(),this._skyIllumLDR=pS&&pS(),this._groundAlbedoLDR=mS&&mS(),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},s(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=v.director.root.pipeline.pipelineSceneData.isHDR;return QA.set(t?this._skyColorHDR:this._skyColorLDR),$A(QA),ZA.set(255*QA.x,255*QA.y,255*QA.z,255)},set:function(t){QA.set(t.x,t.y,t.z,t.w),v.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(QA):this._skyColorLDR.set(QA),this._resource&&this._resource.skyColor.set(QA)}},{key:"skyColor",set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=v.director.root.pipeline.pipelineSceneData.isHDR;return QA.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),$A(QA),ZA.set(255*QA.x,255*QA.y,255*QA.z,255)},set:function(t){QA.set(t.x,t.y,t.z,t.w),v.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(QA):this._groundAlbedoLDR.set(QA),this._resource&&this._resource.groundAlbedo.set(QA)}},{key:"groundAlbedo",set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}()).prototype,"skyIllum",[sS],Object.getOwnPropertyDescriptor(cS.prototype,"skyIllum"),cS.prototype),lS=Za(cS.prototype,"_skyColorHDR",[mo,aS],(function(){return new ta(.2,.5,.8,1)})),_S=Za(cS.prototype,"_skyIllumHDR",[mo,oS],(function(){return jE.SKY_ILLUM})),dS=Za(cS.prototype,"_groundAlbedoHDR",[mo,uS],(function(){return new ta(.2,.2,.2,1)})),fS=Za(cS.prototype,"_skyColorLDR",[mo],(function(){return new ta(.2,.5,.8,1)})),pS=Za(cS.prototype,"_skyIllumLDR",[mo],(function(){return jE.SKY_ILLUM})),mS=Za(cS.prototype,"_groundAlbedoLDR",[mo],(function(){return new ta(.2,.2,.2,1)})),hS=cS))||hS));v.AmbientInfo=tR;var eR=t("SkyboxInfo",(gS=ao("cc.SkyboxInfo"),vS=xo(iS),yS=xo(WE),TS=xo(fr),ES=xo(WE),SS=xo(WE),AS=xo($T),RS=xo(WE),wS=go("_envmap"),bS=xo(WE),OS=xo(WE),MS=xo(WE),IS=xo($T),CS=xo(WE),xS=xo(WE),gS((m((BS=function(){function t(){this._envLightingType=PS&&PS(),this._envmapHDR=DS&&DS(),this._envmapLDR=FS&&FS(),this._diffuseMapHDR=LS&&LS(),this._diffuseMapLDR=US&&US(),this._enabled=GS&&GS(),this._useHDR=kS&&kS(),this._editableMaterial=zS&&zS(),this._reflectionHDR=HS&&HS(),this._reflectionLDR=VS&&VS(),this._rotationAngle=WS&&WS(),this._resource=null}return t.prototype.activate=function(t){this.envLightingType=this._envLightingType,this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setSkyboxMaterial(this._editableMaterial),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.setRotationAngle(this._rotationAngle),this._resource.activate()},s(t,[{key:"applyDiffuseMap",get:function(){return iS.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(t){this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(t){this.envmap||iS.HEMISPHERE_DIFFUSE===t?(iS.HEMISPHERE_DIFFUSE===t?(this.useIBL=!1,this.applyDiffuseMap=!1):iS.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===t?(this.useIBL=!0,this.applyDiffuseMap=!1):iS.DIFFUSEMAP_WITH_REFLECTION===t&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=t):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=iS.HEMISPHERE_DIFFUSE,G(15001))}},{key:"useIBL",get:function(){return iS.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(t){this._resource&&(this._resource.useIBL=t)}},{key:"useHDR",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&this.envLightingType===iS.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=iS.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,G(15e3)):this.diffuseMap.isDefault&&G(15002)),this._resource&&(this._resource.useHDR=this._useHDR,this._resource.updateMaterialRenderInfo())}},{key:"envmap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){var e=v.director.root.pipeline.pipelineSceneData.isHDR;e?(this._envmapHDR=t,this._reflectionHDR=null):(this._envmapLDR=t,this._reflectionLDR=null),t||(e?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=iS.HEMISPHERE_DIFFUSE,G(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=t)}},{key:"rotationAngle",get:function(){return this._rotationAngle},set:function(t){this._rotationAngle=t,this._resource&&this._resource.setRotationAngle(this._rotationAngle)}},{key:"diffuseMap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}},{key:"reflectionMap",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR:this._reflectionLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this._reflectionHDR=t:this._reflectionLDR=t,this._resource&&this._resource.setReflectionMaps(this._reflectionHDR,this._reflectionLDR)}},{key:"skyboxMaterial",get:function(){return this._editableMaterial},set:function(t){this._editableMaterial=t,this._resource&&this._resource.setSkyboxMaterial(this._editableMaterial)}}]),t}()).prototype,"envLightingType",[vS],Object.getOwnPropertyDescriptor(BS.prototype,"envLightingType"),BS.prototype),m(BS.prototype,"envmap",[yS],Object.getOwnPropertyDescriptor(BS.prototype,"envmap"),BS.prototype),m(BS.prototype,"rotationAngle",[TS],Object.getOwnPropertyDescriptor(BS.prototype,"rotationAngle"),BS.prototype),m(BS.prototype,"diffuseMap",[ES],Object.getOwnPropertyDescriptor(BS.prototype,"diffuseMap"),BS.prototype),m(BS.prototype,"reflectionMap",[SS],Object.getOwnPropertyDescriptor(BS.prototype,"reflectionMap"),BS.prototype),m(BS.prototype,"skyboxMaterial",[AS],Object.getOwnPropertyDescriptor(BS.prototype,"skyboxMaterial"),BS.prototype),PS=Za(BS.prototype,"_envLightingType",[mo],(function(){return iS.HEMISPHERE_DIFFUSE})),DS=Za(BS.prototype,"_envmapHDR",[mo,RS,wS],(function(){return null})),FS=Za(BS.prototype,"_envmapLDR",[mo,bS],(function(){return null})),LS=Za(BS.prototype,"_diffuseMapHDR",[mo,OS],(function(){return null})),US=Za(BS.prototype,"_diffuseMapLDR",[mo,MS],(function(){return null})),GS=Za(BS.prototype,"_enabled",[mo],(function(){return!1})),kS=Za(BS.prototype,"_useHDR",[mo],(function(){return!0})),zS=Za(BS.prototype,"_editableMaterial",[mo,IS],(function(){return null})),HS=Za(BS.prototype,"_reflectionHDR",[mo,CS],(function(){return null})),VS=Za(BS.prototype,"_reflectionLDR",[mo,xS],(function(){return null})),WS=Za(BS.prototype,"_rotationAngle",[mo],(function(){return 0})),NS=BS))||NS));v.SkyboxInfo=eR;var iR=t("FogInfo",(XS=ao("cc.FogInfo"),jS=xo(XA),YS=xo(fr),KS=xo(fr),qS=xo(fr),QS=xo(fr),ZS=xo(fr),JS=xo(fr),XS((_A=lA=function(){function t(){this._type=eA&&eA(),this._fogColor=iA&&iA(),this._enabled=nA&&nA(),this._fogDensity=rA&&rA(),this._fogStart=sA&&sA(),this._fogEnd=aA&&aA(),this._fogAtten=oA&&oA(),this._fogTop=uA&&uA(),this._fogRange=hA&&hA(),this._accurate=cA&&cA(),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),lA.FogType=XA,m((tA=_A).prototype,"type",[jS],Object.getOwnPropertyDescriptor(tA.prototype,"type"),tA.prototype),m(tA.prototype,"fogDensity",[YS],Object.getOwnPropertyDescriptor(tA.prototype,"fogDensity"),tA.prototype),m(tA.prototype,"fogStart",[KS],Object.getOwnPropertyDescriptor(tA.prototype,"fogStart"),tA.prototype),m(tA.prototype,"fogEnd",[qS],Object.getOwnPropertyDescriptor(tA.prototype,"fogEnd"),tA.prototype),m(tA.prototype,"fogAtten",[QS],Object.getOwnPropertyDescriptor(tA.prototype,"fogAtten"),tA.prototype),m(tA.prototype,"fogTop",[ZS],Object.getOwnPropertyDescriptor(tA.prototype,"fogTop"),tA.prototype),m(tA.prototype,"fogRange",[JS],Object.getOwnPropertyDescriptor(tA.prototype,"fogRange"),tA.prototype),eA=Za(tA.prototype,"_type",[mo],(function(){return XA.LINEAR})),iA=Za(tA.prototype,"_fogColor",[mo],(function(){return new Aa("#C8C8C8")})),nA=Za(tA.prototype,"_enabled",[mo],(function(){return!1})),rA=Za(tA.prototype,"_fogDensity",[mo],(function(){return.3})),sA=Za(tA.prototype,"_fogStart",[mo],(function(){return.5})),aA=Za(tA.prototype,"_fogEnd",[mo],(function(){return 300})),oA=Za(tA.prototype,"_fogAtten",[mo],(function(){return 5})),uA=Za(tA.prototype,"_fogTop",[mo],(function(){return 1.5})),hA=Za(tA.prototype,"_fogRange",[mo],(function(){return 1.2})),cA=Za(tA.prototype,"_accurate",[mo],(function(){return!1})),$S=tA))||$S)),nR=t("ShadowsInfo",(dA=ao("cc.ShadowsInfo"),fA=xo(KE),pA=xo(fr),mA=xo(dr),gA=xo(YE),dA((m((yA=function(){function t(){this._enabled=TA&&TA(),this._type=EA&&EA(),this._normal=SA&&SA(),this._distance=AA&&AA(),this._shadowColor=RA&&RA(),this._maxReceived=wA&&wA(),this._size=bA&&bA(),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(JA),this.planeDirection=js.transformQuat(qA,KA,JA),t.getWorldPosition(qA),this.planeHeight=js.dot(this._normal,qA)},e.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"planeDirection",get:function(){return this._normal},set:function(t){js.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"planeHeight",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}}]),t}()).prototype,"type",[fA],Object.getOwnPropertyDescriptor(yA.prototype,"type"),yA.prototype),m(yA.prototype,"planeHeight",[pA],Object.getOwnPropertyDescriptor(yA.prototype,"planeHeight"),yA.prototype),m(yA.prototype,"maxReceived",[mA],Object.getOwnPropertyDescriptor(yA.prototype,"maxReceived"),yA.prototype),m(yA.prototype,"shadowMapSize",[gA],Object.getOwnPropertyDescriptor(yA.prototype,"shadowMapSize"),yA.prototype),TA=Za(yA.prototype,"_enabled",[mo],(function(){return!1})),EA=Za(yA.prototype,"_type",[mo],(function(){return KE.Planar})),SA=Za(yA.prototype,"_normal",[mo],(function(){return new js(0,1,0)})),AA=Za(yA.prototype,"_distance",[mo],(function(){return 0})),RA=Za(yA.prototype,"_shadowColor",[mo],(function(){return new Aa(0,0,0,76)})),wA=Za(yA.prototype,"_maxReceived",[mo],(function(){return 4})),bA=Za(yA.prototype,"_size",[mo],(function(){return new Qs(1024,1024)})),vA=yA))||vA));v.ShadowsInfo=nR;var rR,sR,aR,oR,uR=t("DEFAULT_WORLD_MIN_POS",new js(-1024,-1024,-1024)),hR=t("DEFAULT_WORLD_MAX_POS",new js(1024,1024,1024)),cR=t("DEFAULT_OCTREE_DEPTH",8),lR=t("OctreeInfo",(OA=ao("cc.OctreeInfo"),MA=xo(dr),OA((m((CA=function(){function t(){this._enabled=xA&&xA(),this._minPos=NA&&NA(),this._maxPos=BA&&BA(),this._depth=PA&&PA(),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}()).prototype,"depth",[MA],Object.getOwnPropertyDescriptor(CA.prototype,"depth"),CA.prototype),xA=Za(CA.prototype,"_enabled",[mo],(function(){return!1})),NA=Za(CA.prototype,"_minPos",[mo],(function(){return new js(uR)})),BA=Za(CA.prototype,"_maxPos",[mo],(function(){return new js(hR)})),PA=Za(CA.prototype,"_depth",[mo],(function(){return cR})),IA=CA))||IA)),_R=t("SceneGlobals",(DA=ao("cc.SceneGlobals"),FA=xo(eR),DA((UA=function(){function t(){this.ambient=GA&&GA(),this.shadows=kA&&kA(),this._skybox=zA&&zA(),this.fog=HA&&HA(),this.octree=VA&&VA()}return t.prototype.activate=function(){var t=v.director.root.pipeline.pipelineSceneData;this.fog.activate(t.fog),v.director.root.onGlobalPipelineStateChanged()},s(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),GA=Za(UA.prototype,"ambient",[mo],(function(){return new tR})),kA=Za(UA.prototype,"shadows",[mo],(function(){return new nR})),zA=Za(UA.prototype,"_skybox",[mo],(function(){return new eR})),HA=Za(UA.prototype,"fog",[mo],(function(){return new iR})),m(UA.prototype,"skybox",[FA],Object.getOwnPropertyDescriptor(UA.prototype,"skybox"),UA.prototype),VA=Za(UA.prototype,"octree",[mo],(function(){return new lR})),LA=UA))||LA));function dR(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return z(3701,t.name),void(e.instance=void 0);var i=t._objFlags,n=t._parent,r=t._id,s=t._prefab;t[kr],v.game._isCloning=!0;var a=e.asset.data;a._iN$t=t,v.instantiate._clone(a,a),v.game._isCloning=!1,t._objFlags=i,t._parent=n,t._id=r,t._prefab&&(t._prefab.instance=null==s?void 0:s.instance)}}function fR(t,e,i){var n;if(e&&t){var r=e,s=null===(n=t._prefab)||void 0===n?void 0:n.instance;!i&&s&&(e[s.fileId]={},r=e[s.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var o=t.components,u=0;u<o.length;u++){var h=o[u];h.__prefab&&(r[h.__prefab.fileId]=h)}for(var c=0;c<t.children.length;c++)fR(t.children[c],r,!1)}}function pR(t,e){if(!t)return null;for(var i=e,n=0;n<t.length;n++){if(!i)return null;i=i[t[n]]}return i}function mR(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r&&r.targetInfo){var s=pR(r.targetInfo.localID,i);if(!s)continue;var a=i,o=r.targetInfo.localID;if(o.length>0)for(var u=0;u<o.length-1;u++)a=a[o[u]];if(r.nodes)for(var h=0;h<r.nodes.length;h++){var c=r.nodes[h];c&&!s._children.includes(c)&&(s._children.push(c),c._parent=s,fR(c,a,!1),c._siblingIndex=s._children.length-1,ER(c,!0))}}}}function gR(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r&&r.targetInfo){var s=pR(r.targetInfo.localID,i);if(!s)continue;if(r.components)for(var a=0;a<r.components.length;a++){var o=r.components[a];o&&(o.node=s,s._components.push(o))}}}}function vR(t,e,i){if(e)for(var n=0;n<e.length;n++){var r=e[n];if(r){var s=pR(r.localID,i);if(!s||!s.node)continue;var a=s.node.components.indexOf(s);a>=0&&s.node._components.splice(a,1)}}}function yR(t,e,i){if(!(e.length<=0))for(var n=null,r=0;r<e.length;r++){var s=e[r];if(s&&s.targetInfo){if(!(n=pR(s.targetInfo.localID,i)))continue;var a=n,o=s.propertyPath.slice();if(o.length>0){var u=o.pop();if(!u)continue;for(var h=0;h<o.length&&(a=a[o[h]]);h++);if(!a)continue;if(Array.isArray(a))if("length"===u)a[u]=s.value;else{var c=Number.parseInt(u);Number.isInteger(c)&&c<a.length&&(a[u]=s.value)}else a[u]instanceof Hn?a[u].set(s.value):a[u]=s.value}}}}function TR(t){var e,i=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(var n=0;n<i.length;n++){var r,s,a=i[n],o=a.source,u=a.sourceInfo;if(u){var h,c,l=null===(h=a.source)||void 0===h||null===(c=h._prefab)||void 0===c?void 0:c.instance;l&&l.targetMap&&(o=pR(u.localID,l.targetMap))}if(o){var _,d=a.targetInfo;if(d){var f=null===(r=a.target)||void 0===r||null===(s=r._prefab)||void 0===s?void 0:s.instance;if(f&&f.targetMap&&(_=pR(d.localID,f.targetMap))){var p=a.propertyPath.slice(),m=o;if(p.length>0){var g=p.pop();if(!g)return;for(var v=0;v<p.length&&(m=m[p[v]]);v++);if(!m)continue;m[g]=_}}}}}}function ER(t,e){void 0===e&&(e=!1);var i=t._prefab,n=null==i?void 0:i.instance;if(n&&!n.expanded){dR(t),e&&t&&t.children&&t.children.forEach((function(t){ER(t,!0)}));var r={};n.targetMap=r,fR(t,r,!0),mR(0,n.mountedChildren,r),vR(0,n.removedComponents,r),gR(0,n.mountedComponents,r),yR(0,n.propertyOverrides,r),n.expanded=!0}else e&&t&&t.children&&t.children.forEach((function(t){ER(t,!0)}))}function SR(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){ER(t)}))}v.SceneGlobals=_R;var AR=t("Scene",ao("cc.Scene")((sR=function(t){o(i,t);var e=i.prototype;function i(e){var i;return(i=t.call(this,e)||this).autoReleaseAssets=aR&&aR(),i._globals=oR&&oR(),i.dependAssets=null,i._renderScene=null,i._inited=void 0,i._prefabSyncedInLiveReload=!1,i._pos=js.ZERO,i._rot=sa.IDENTITY,i._scale=js.ONE,i._mat=da.IDENTITY,i._dirtyFlags=0,i._lpos=js.ZERO,i._lrot=sa.IDENTITY,i._lscale=js.ONE,i._activeInHierarchy=!1,v.director&&v.director.root&&(i._renderScene=v.director.root.createScene({})),i._inited=!v.game||!v.game._isCloning,i}return e._updateScene=function(){this._scene=this},e.destroy=function(){var t=Vr.prototype.destroy.call(this);if(t)for(var e=this._children,i=0;i<e.length;++i)e[i].active=!1;return this._renderScene&&v.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(X(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var i=this._children.length,n=0;n<i;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},e.getPosition=function(t){return js.copy(t||new js,js.ZERO)},e.getRotation=function(t){return sa.copy(t||new sa,sa.IDENTITY)},e.getScale=function(t){return js.copy(t||new js,js.ONE)},e.getWorldPosition=function(t){return js.copy(t||new js,js.ZERO)},e.getWorldRotation=function(t){return sa.copy(t||new sa,sa.IDENTITY)},e.getWorldScale=function(t){return js.copy(t||new js,js.ONE)},e.getWorldMatrix=function(t){return da.copy(t||new da,da.IDENTITY)},e.getWorldRS=function(t){return da.copy(t||new da,da.IDENTITY)},e.getWorldRT=function(t){return da.copy(t||new da,da.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(SR(this),TR(this),this._onBatchCreated(n),this._inited=!0),this.walk(Ip._setScene)},e._activate=function(t){t=!1!==t,v.director._nodeActivator.activateNode(this,t),this._globals.activate()},s(i,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"position",get:function(){return js.ZERO}},{key:"worldPosition",get:function(){return js.ZERO}},{key:"rotation",get:function(){return sa.IDENTITY}},{key:"worldRotation",get:function(){return sa.IDENTITY}},{key:"scale",get:function(){return js.ONE}},{key:"worldScale",get:function(){return js.ONE}},{key:"eulerAngles",get:function(){return js.ZERO}},{key:"worldMatrix",get:function(){return da.IDENTITY}}]),i}(Ip),aR=Za(sR.prototype,"autoReleaseAssets",[mo],(function(){return!1})),oR=Za(sR.prototype,"_globals",[mo],(function(){return new _R})),rR=sR))||rR);v.Scene=AR;var RR=Pn.fastRemoveAt,wR=Vr.Flags.IsStartCalled,bR=Vr.Flags.IsOnEnableCalled;function OR(t,e){for(var i=e.constructor._executionOrder,n=e._id,r=0,s=t.length-1,a=s>>>1;r<=s;a=r+s>>>1){var o=t[a],u=o.constructor._executionOrder;if(u>i)s=a-1;else if(u<i)r=a+1;else{var h=o._id;if(h>n)s=a-1;else{if(!(h<n))return a;r=a+1}}}return~r}function MR(t,e){for(var i=t.array,n=t.i+1;n<i.length;){var r=i[n];r.node._activeInHierarchy?++n:(t.removeAt(n),e&&(r._objFlags&=~e))}}Vr.Flags.IsEditorOnEnableCalled;var IR=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=Di;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function CR(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}IR.stableRemoveInactive=MR;var xR=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},i.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},i.cancelInactive=function(t){MR(this._zero,t),MR(this._neg,t),MR(this._pos,t)},i.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(CR),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(CR),this._invoke(e),e.array.length=0)},e}(IR),NR=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var i=e<0?this._neg.array:this._pos.array,n=OR(i,t);n<0&&i.splice(~n,0,t)}},i.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var i=e<0?this._neg:this._pos,n=OR(i.array,t);n>=0&&i.removeAt(n)}},i.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(IR);function BR(t,e,i){var n="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",r=e?Function("it","dt",n):Function("it",n);return function(t,e,i){return function(n,r){try{e(n,r)}catch(e){v._throw(e);var s=n.array;for(i&&(s[n.i]._objFlags|=i),++n.i;n.i<s.length;++n.i)try{t(s[n.i],r)}catch(t){v._throw(t),i&&(s[n.i]._objFlags|=i)}}}}(Function("c","dt",t),r,i)}var PR=BR("c.start();c._objFlags|="+wR,!1,wR),DR=BR("c.update(dt)",!0),FR=BR("c.lateUpdate(dt)",!0),LR=function(t){var e=v.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){var n=i[t.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||e._onEnabled(n))}},UR=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new xR(PR),this.updateInvoker=new NR(DR),this.lateUpdateInvoker=new NR(FR),this._updating=!1},e._onEnabled=function(t){v.director.getScheduler().resumeTarget(t),t._objFlags|=bR,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){v.director.getScheduler().pauseTarget(t),t._objFlags&=~bR;var e=this._deferredComps.indexOf(t);e>=0?RR(this._deferredComps,e):(!t.start||t._objFlags&wR||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&bR)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&bR&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&wR||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),GR=Vr.Flags.IsPreloadStarted,kR=Vr.Flags.IsOnLoadStarted,zR=Vr.Flags.IsOnLoadCalled,HR=Vr.Flags.Deactivating,VR=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.add=function(t){this._zero.array.push(t)},i.remove=function(t){this._zero.fastRemove(t)},i.cancelInactive=function(t){IR.stableRemoveInactive(this._zero,t)},i.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(IR),WR=BR("c.__preload();"),XR=BR("c.onLoad();c._objFlags|="+zR,!1,zR),jR=new Bn(4);function YR(t,e,i){z(3817,t.name,i),console.log("Corrupted component value:",e),e?t._removeComponent(e):Pn.removeAt(t._components,i)}jR.get=function(){var t=this._get()||{preload:new VR(WR),onLoad:new xR(XR),onEnable:new xR(LR)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var KR,qR,QR,ZR,JR,$R,tw,ew,iw,nw,rw,sw,aw,ow,uw,hw,cw,lw,_w,dw,fw,pw,mw,gw,vw,yw,Tw,Ew,Sw,Aw,Rw,ww,bw,Ow,Mw,Iw,Cw,xw,Nw,Bw,Pw,Dw,Fw,Lw,Uw,Gw,kw,zw,Hw,Vw,Ww,Xw,jw,Yw,Kw,qw,Qw,Zw,Jw,$w,tb,eb,ib,nb,rb,sb=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var i=jR.get();this._activatingStack.push(i),this._activateNodeRecursively(t,i.preload,i.onLoad,i.onEnable),i.preload.invoke(),i.onLoad.invoke(),i.onEnable.invoke(),this._activatingStack.pop(),jR.put(i)}else{this._deactivateNodeRecursively(t);for(var n,r=p(this._activatingStack);!(n=r()).done;){var s=n.value;s.preload.cancelInactive(GR),s.onLoad.cancelInactive(kR),s.onEnable.cancelInactive()}}t.emit(tp.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,i,n){if(jr(t,!0)&&(t._objFlags&GR||(t._objFlags|=GR,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&kR||(t._objFlags|=kR,t.onLoad?i?i.add(t):(t.onLoad(),t._objFlags|=zR):t._objFlags|=zR),t._enabled)){if(!t.node._activeInHierarchy)return;v.director._compScheduler.enableComp(t,n)}},e.destroyComp=function(t){v.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&zR&&t.onDestroy()},e._activateNodeRecursively=function(t,e,i,n){if(t._objFlags&HR)z(3816,t.name);else{t._activeInHierarchy=!0;for(var r=t._components.length,s=0;s<r;++s){var a=t._components[s];a instanceof v.Component?this.activateComp(a,e,i,n):(YR(t,a,s),--s,--r)}for(var o=0,u=t._children.length;o<u;++o){var h=t._children[o];h._active&&this._activateNodeRecursively(h,e,i,n)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=HR,t._activeInHierarchy=!1;for(var e=t._components.length,i=0;i<e;++i){var n=t._components[i];if(n._enabled&&(v.director._compScheduler.disableComp(n),t._activeInHierarchy))return void(t._objFlags&=~HR)}for(var r=0,s=t._children.length;r<s;++r){var a=t._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),t._activeInHierarchy))return void(t._objFlags&=~HR)}t._onPostActivated(!1),t._objFlags&=~HR},t}()),ab=ao("cc.TargetInfo")((qR=function(){this.localID=QR&&QR()},QR=Za(qR.prototype,"localID",[mo],(function(){return[]})),KR=qR))||KR,ob=(ZR=ao("cc.TargetOverrideInfo"),JR=xo(Vr),$R=xo(ab),tw=xo(kp),ew=xo(ab),ZR((nw=function(){this.source=rw&&rw(),this.sourceInfo=sw&&sw(),this.propertyPath=aw&&aw(),this.target=ow&&ow(),this.targetInfo=uw&&uw()},rw=Za(nw.prototype,"source",[mo,JR],(function(){return null})),sw=Za(nw.prototype,"sourceInfo",[mo,$R],(function(){return null})),aw=Za(nw.prototype,"propertyPath",[mo],(function(){return[]})),ow=Za(nw.prototype,"target",[mo,tw],(function(){return null})),uw=Za(nw.prototype,"targetInfo",[mo,ew],(function(){return null})),iw=nw))||iw),ub=ao("cc.CompPrefabInfo")((cw=function(){this.fileId=lw&&lw()},lw=Za(cw.prototype,"fileId",[mo],(function(){return""})),hw=cw))||hw,hb=(_w=ao("CCPropertyOverrideInfo"),dw=xo(ab),_w((pw=function(){function t(){this.targetInfo=mw&&mw(),this.propertyPath=gw&&gw(),this.value=vw&&vw()}return t.prototype.isTarget=function(){},t}(),mw=Za(pw.prototype,"targetInfo",[mo,dw],(function(){return null})),gw=Za(pw.prototype,"propertyPath",[mo],(function(){return[]})),vw=Za(pw.prototype,"value",[mo],null),fw=pw))||fw),cb=(yw=ao("cc.MountedChildrenInfo"),Tw=xo(ab),Ew=xo([kp]),yw((Aw=function(){function t(){this.targetInfo=Rw&&Rw(),this.nodes=ww&&ww()}return t.prototype.isTarget=function(){},t}(),Rw=Za(Aw.prototype,"targetInfo",[mo,Tw],(function(){return null})),ww=Za(Aw.prototype,"nodes",[mo,Ew],(function(){return[]})),Sw=Aw))||Sw),lb=(bw=ao("cc.MountedComponentsInfo"),Ow=xo(ab),Mw=xo([el]),bw((Cw=function(){function t(){this.targetInfo=xw&&xw(),this.components=Nw&&Nw()}return t.prototype.isTarget=function(){},t}(),xw=Za(Cw.prototype,"targetInfo",[mo,Ow],(function(){return null})),Nw=Za(Cw.prototype,"components",[mo,Mw],(function(){return[]})),Iw=Cw))||Iw),_b=(Bw=ao("cc.PrefabInstance"),Pw=xo(kp),Dw=xo([cb]),Fw=xo([lb]),Lw=xo([hb]),Uw=xo([ab]),Bw((kw=function(){function t(){this.fileId=zw&&zw(),this.prefabRootNode=Hw&&Hw(),this.mountedChildren=Vw&&Vw(),this.mountedComponents=Ww&&Ww(),this.propertyOverrides=Xw&&Xw(),this.removedComponents=jw&&jw(),this.targetMap={},this.expanded=!1}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),zw=Za(kw.prototype,"fileId",[mo],(function(){return""})),Hw=Za(kw.prototype,"prefabRootNode",[mo,Pw],null),Vw=Za(kw.prototype,"mountedChildren",[mo,Dw],(function(){return[]})),Ww=Za(kw.prototype,"mountedComponents",[mo,Fw],(function(){return[]})),Xw=Za(kw.prototype,"propertyOverrides",[mo,Lw],(function(){return[]})),jw=Za(kw.prototype,"removedComponents",[mo,Uw],(function(){return[]})),Gw=kw))||Gw),db=(Yw=ao("cc.PrefabInfo"),Kw=xo(kp),qw=xo(_b),Qw=xo([ob]),Yw((Jw=function(){this.root=$w&&$w(),this.asset=tb&&tb(),this.fileId=eb&&eb(),this.instance=ib&&ib(),this.targetOverrides=nb&&nb(),this.nestedPrefabInstanceRoots=rb&&rb()},$w=Za(Jw.prototype,"root",[mo,Kw],null),tb=Za(Jw.prototype,"asset",[mo],null),eb=Za(Jw.prototype,"fileId",[mo],(function(){return""})),ib=Za(Jw.prototype,"instance",[mo,qw],null),nb=Za(Jw.prototype,"targetOverrides",[mo,Qw],null),rb=Za(Jw.prototype,"nestedPrefabInstanceRoots",[mo],null),Zw=Jw))||Zw);v._PrefabInfo=db;var fb,pb,mb,gb,vb,yb,Tb,Eb=Object.freeze({__proto__:null,TargetInfo:ab,TargetOverrideInfo:ob,CompPrefabInfo:ub,PropertyOverrideInfo:hb,MountedChildrenInfo:cb,MountedComponentsInfo:lb,PrefabInstance:_b,PrefabInfo:db,createNodeWithPrefab:dR,generateTargetMap:fR,getTarget:pR,applyMountedChildren:mR,applyMountedComponents:gR,applyRemovedComponents:vR,applyPropertyOverrides:yR,applyTargetOverrides:TR,expandPrefabInstanceNode:ER,expandNestedPrefabInstanceNode:SR,applyNodeAndComponentId:function t(e,i){for(var n=e.components,r=e.children,s=0;s<n.length;s++){var a,o=n[s];o._id=""+i+(null===(a=o.__prefab)||void 0===a?void 0:a.fileId)}for(var u=0;u<r.length;u++){var h,c=r[u];c._id=""+i+(null===(h=c._prefab)||void 0===h?void 0:h.fileId),t(c,i)}}}),Sb=Ln({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),Ab=t("Prefab",ao("cc.Prefab")((Tb=yb=function(t){function e(){var e;return(e=t.call(this)||this).data=mb&&mb(),e.optimizationPolicy=gb&&gb(),e.persistent=vb&&vb(),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}o(e,t);var i=e.prototype;return i.createNode=function(t){var e=v.instantiate(this);e.name=this.name,t(null,e)},i.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof v._BaseNode&&t,new Qf(t,e).result)},i._doInstantiate=function(t){return this.data._prefab||G(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},i._instantiate=function(){var t;return this.optimizationPolicy!==Sb.SINGLE_INSTANCE&&(this.optimizationPolicy===Sb.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new kp,this.data.name="(Missing Node)";var i=new v._PrefabInfo;i.asset=this,i.root=this.data,this.data._prefab=i},i.validate=function(){return!!this.data},i.onLoaded=function(){var t=this.data;SR(t),TR(t)},e}(Tu),yb.OptimizationPolicy=Sb,yb.OptimizationPolicyThreshold=3,mb=Za((pb=Tb).prototype,"data",[mo],(function(){return null})),gb=Za(pb.prototype,"optimizationPolicy",[mo],(function(){return Sb.AUTO})),vb=Za(pb.prototype,"persistent",[mo],(function(){return!1})),fb=pb))||fb);Dn.value(Ab,"_utils",Eb),v.Prefab=Ab,an(v,"cc._Prefab","Prefab");var Rb,wb,bb,Ob=t("RenderingSubMesh",function(){function t(t,e,i,n,r,s){void 0===n&&(n=null),void 0===r&&(r=null),void 0===s&&(s=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._drawInfo=null,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=n,this._indirectBuffer=r,this._primitiveMode=i,this._iaInfo=new we(e,t,n,r),this._isOwnerOfIndexBuffer=s}var e=t.prototype;return e.invalidateGeometricInfo=function(){this._geometricInfo=void 0},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,i=t.struct.primitives[this.subMeshIdx];i.indexView&&(e=i.indexView.count);for(var n=0;n<i.vertexBundelIndices.length;n++){var r=i.vertexBundelIndices[n],s=t.struct.vertexBundles[r],a=i.indexView?i.indexView.count:s.view.count,o=s.view.stride,u=o*a,h=new Uint8Array(t.data.buffer,s.view.offset,s.view.length),c=new Uint8Array(i.indexView?u:s.view.length);if(i.indexView){for(var l=t.readIndices(this.subMeshIdx),_=0;_<e;++_)for(var d=_*o,f=l[_]*o,p=0;p<o;++p)c[d+p]=h[f+p];this._flatBuffers.push({stride:o,count:a,buffer:c})}else c.set(t.data.subarray(s.view.offset,s.view.offset+s.view.length)),this._flatBuffers.push({stride:o,count:a,buffer:c})}}},e.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(t);this._vertexBuffers.push(n),this._attributes.push(new Ae("a_vertexId",et.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}},e._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e),n=0;n<e;++n)i[n]=n+.5;var r=t.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return r.update(i),r},s(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:js.ZERO,max:js.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:js.ZERO,max:js.ZERO}};var t=this.mesh,e=this.subMeshIdx,i=t.readAttribute(e,Vt.ATTR_POSITION),n=t.readIndices(e),r=new js,s=new js,a=this.attributes.find((function(t){return t.name===Vt.ATTR_POSITION}));if(a){var o=Ke[a.format].count;2===o?(r.set(i[0],i[1],0),s.set(i[0],i[1],0)):(r.set(i[0],i[1],i[2]),s.set(i[0],i[1],i[2]));for(var u=0;u<i.length;u+=o)2===o?(r.x=i[u]>r.x?i[u]:r.x,r.y=i[u+1]>r.y?i[u+1]:r.y,s.x=i[u]<s.x?i[u]:s.x,s.y=i[u+1]<s.y?i[u+1]:s.y):(r.x=i[u]>r.x?i[u]:r.x,r.y=i[u+1]>r.y?i[u+1]:r.y,r.z=i[u+2]>r.z?i[u+2]:r.z,s.x=i[u]<s.x?i[u]:s.x,s.y=i[u+1]<s.y?i[u+1]:s.y,s.z=i[u+2]<s.z?i[u+2]:s.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:r,min:s}},this._geometricInfo}},{key:"drawInfo",get:function(){return this._drawInfo},set:function(t){this._drawInfo=t}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],i=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var n,r,s=this.mesh.struct,a=s.primitives[this.subMeshIdx];if(!s.jointMaps||void 0===a.jointMapIndex||!s.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var o=v.director.root.device,u=0;u<a.vertexBundelIndices.length;u++){var h=s.vertexBundles[a.vertexBundelIndices[u]];r=0,n=et.UNKNOWN;for(var c=0;c<h.attributes.length;c++){var l=h.attributes[c];if(l.name===Vt.ATTR_JOINTS){n=l.format;break}r+=Ke[l.format].size}n?function(){var c=new Uint8Array(t.mesh.data.buffer,h.view.offset,h.view.length),l=new DataView(c.slice().buffer),_=s.jointMaps[a.jointMapIndex];Qa(l,(function(t){return _.indexOf(t)}),n,r,h.view.length,h.view.stride,l);var d=o.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,h.view.length,h.view.stride));d.update(l.buffer),e.push(d),i.push(u)}():e.push(this.vertexBuffers[a.vertexBundelIndices[u]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(o)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}()),Mb=t("SceneAsset",ao("cc.SceneAsset")((wb=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).scene=bb&&bb(),e}o(e,t);var i=e.prototype;return i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new AR("New Scene")},i.validate=function(){return!!this.scene},e}(Tu),bb=Za(wb.prototype,"scene",[mo],(function(){return null})),Rb=wb))||Rb);v.SceneAsset=Mb;var Ib,Cb,xb,Nb,Bb,Pb=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(var n=0;n<i;++n){var r=this._mesh.struct.morph.subMeshMorphs[n];r&&(r.targets.length>xm.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[n]=new Fb(this._mesh,n,this._mesh.struct.morph,e):this._subMeshRenderings[n]=new Db(this._mesh,n,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,i=new Array(e),n=0;n<e;++n){var r,s;i[n]=null!==(r=null===(s=this._subMeshRenderings[n])||void 0===s?void 0:s.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var n;null===(n=i[t])||void 0===n||n.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var n=t._mesh.struct.morph.subMeshMorphs[e],r=i[e];if(null===r)return null;var s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(Vt.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(Vt.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(Vt.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push.apply(s,r.requiredPatches()),s},adaptPipelineState:function(t,e){var n;null===(n=i[t])||void 0===n||n.adaptPipelineState(e)},destroy:function(){for(var t,e=p(i);!(t=e()).done;){var n=t.value;null==n||n.destroy()}}}},t}(),Db=function(){function t(t,e,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;var r=i.subMeshMorphs[e];this._subMeshMorph=r,kb(t,e,n);var s=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=s;var a=r.targets.length,o=Gb(n,s*a);this._textureInfo={width:o.width,height:o.height},this._attributes=r.attributes.map((function(e,i){var n=o.create(),a=n.valueView;return r.targets.forEach((function(e,n){for(var r=e.displacements[i],o=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),u=s*n*4,h=0;h<s;++h)a[u+4*h+0]=o[3*h+0],a[u+4*h+1]=o[3*h+1],a[u+4*h+2]=o[3*h+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=p(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new Ub(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(i){for(var n,r=p(t._attributes);!(n=r()).done;){var s=n.value,a=void 0;switch(s.name){case Vt.ATTR_POSITION:a=Gm;break;case Vt.ATTR_NORMAL:a=Hm;break;case Vt.ATTR_TANGENT:a=Xm;break;default:I("Unexpected attribute!")}void 0!==a&&(i.bindSampler(a,s.morphTexture.sampler),i.bindTexture(a,s.morphTexture.texture))}i.bindBuffer(xm.BINDING,e.buffer),i.update()},destroy:function(){}}},t}(),Fb=function(){function t(t,e,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;var r=i.subMeshMorphs[e];kb(t,e,n),this._attributes=r.attributes.map((function(e,i){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)}}))}}))}return t.prototype.createInstance=function(){return new Lb(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},s(t,[{key:"data",get:function(){return this._attributes}}]),t}(),Lb=function(){function t(t,e,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new Ub(i,0);var n=Gb(i,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=n.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var i=this._attributes[e],n=i.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var s=0;s<r.targets.length;++s){var a=r.targets[s].displacements,o=t[s],u=a.length/3;if(0===s)for(var h=0;h<u;++h)n[4*h+0]=a[3*h+0]*o,n[4*h+1]=a[3*h+1]*o,n[4*h+2]=a[3*h+2]*o;else if(0!==o)for(var c=0;c<u;++c)n[4*c+0]+=a[3*c+0]*o,n[4*c+1]+=a[3*c+1]*o,n[4*c+2]+=a[3*c+2]*o}i.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,i=p(this._attributes);!(e=i()).done;){var n=e.value,r=void 0;switch(n.attributeName){case Vt.ATTR_POSITION:r=Gm;break;case Vt.ATTR_NORMAL:r=Hm;break;case Vt.ATTR_TANGENT:r=Xm;break;default:I("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,n.morphTexture.sampler),t.bindTexture(r,n.morphTexture.texture))}t.bindBuffer(xm.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),Ub=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(xm.SIZE)),this._remoteBuffer=t.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,xm.SIZE,xm.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(xm.OFFSET_OF_WEIGHTS+4*e,t[e],v.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(xm.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,v.sys.isLittleEndian),this._localBuffer.setFloat32(xm.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,v.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(xm.OFFSET_OF_VERTICES_COUNT,t,v.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},s(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function Gb(t,e){var i,n,r,s;t.getFormatFeatures(et.RGBA32F)&lt.SAMPLED_TEXTURE?(i=e,r=16,n=fy.PixelFormat.RGBA32F,s=Float32Array):(i=4*e,r=4,n=fy.PixelFormat.RGBA8888,s=Uint8Array);var a=function(t){t<5&&(t=5);var e=_s(ps(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i),o=a.width,u=a.height;return{width:o,height:u,create:function(){var e=new ArrayBuffer(o*u*r),i=new Float32Array(e),a=s===Float32Array?i:new s(e),h=new $v({width:o,height:u,_data:a,_compressed:!1,format:n}),c=new fy;c.setFilters(fy.Filter.NEAREST,fy.Filter.NEAREST),c.setMipFilter(fy.Filter.NONE),c.setWrapMode(fy.WrapMode.CLAMP_TO_EDGE,fy.WrapMode.CLAMP_TO_EDGE,fy.WrapMode.CLAMP_TO_EDGE),c.image=h,c.getGFXTexture()||I("Unexpected: failed to create morph texture?");var l=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return l},get valueView(){return i},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(a)}}}}}function kb(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}function zb(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var Hb=new js,Vb=new js,Wb=new Uint8Array,Xb=t("Mesh",ao("cc.Mesh")((Cb=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,e._struct=xb&&xb(),e._hash=Nb&&Nb(),e._data=Wb,e._initialized=!1,e._allowDataAccess=Bb&&Bb(),e._isMeshDataUploaded=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}o(e,t);var i=e.prototype;return i.onLoaded=function(){this.initialize()},i.initialize=function(){var t=this;if(!this._initialized)if(this._initialized=!0,this._struct.dynamic){for(var e=Wa.gfxDevice,i=[],n=[],r=0;r<this._struct.vertexBundles.length;r++){var s=this._struct.vertexBundles[r],a=e.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,s.view.length,s.view.stride));i.push(a)}for(var o=0;o<this._struct.primitives.length;o++){var u=this._struct.primitives[o],h=u.indexView,c=null;h&&(c=e.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,h.length,h.stride)));for(var l=[],_=0;_<u.vertexBundelIndices.length;_++){var d=u.vertexBundelIndices[_];l.push(i[d])}for(var f=[],m=0;m<u.vertexBundelIndices.length;m++)for(var g,v=u.vertexBundelIndices[m],y=p(this._struct.vertexBundles[v].attributes);!(g=y()).done;){var T=g.value,E=new Ae;E.copy(T),f.push(E)}var S=new Ob(l,f,u.primitiveMode,c);S.drawInfo=new ue,S.mesh=this,S.subMeshIdx=o,n.push(S)}this._renderingSubMeshes=n}else!function(){for(var e=t._data.buffer,i=Wa.gfxDevice,n=t._createVertexBuffers(i,e),r=[],s=0;s<t._struct.primitives.length;s++){var a=t._struct.primitives[s];if(0!==a.vertexBundelIndices.length){var o=null,u=null;if(a.indexView){var h=a.indexView,c=h.stride,l=h.length;if(4===c&&!i.hasFeature(tt.ELEMENT_INDEX_UINT)){var _=t._struct.vertexBundles[a.vertexBundelIndices[0]].view.count;if(_>=65536){G(10001,_,65536);continue}c>>=1,l>>=1}o=i.createBuffer(new ae(rt.INDEX,ot.DEVICE,l,c)),u=new(zb(h.stride))(e,h.offset,h.count),h.stride!==c&&(u=zb(c).from(u)),o.update(u)}var d=a.vertexBundelIndices.map((function(t){return n[t]})),f=[];if(a.vertexBundelIndices.length>0)for(var p=a.vertexBundelIndices[0],m=t._struct.vertexBundles[p].attributes,g=0;g<m.length;++g){var v=m[g];f[g]=new Ae(v.name,v.format,v.isNormalized,v.stream,v.isInstanced,v.location)}var y=new Ob(d,f,a.primitiveMode,o);y.mesh=t,y.subMeshIdx=s,r.push(y)}}t._renderingSubMeshes=r,t._struct.morph&&(t.morphRendering=function(t,e){return new Pb(t,e)}(t,i)),t._isMeshDataUploaded=!0,t._allowDataAccess||t.releaseData()}()},i.updateSubMesh=function(t,e){if(this._struct.dynamic)if(t>=this._struct.primitives.length)G(14201);else{var i=[];if(e.positions.length>0&&i.push(e.positions),e.normals&&e.normals.length>0&&i.push(e.normals),e.uvs&&e.uvs.length>0&&i.push(e.uvs),e.tangents&&e.tangents.length>0&&i.push(e.tangents),e.colors&&e.colors.length>0&&i.push(e.colors),e.customAttributes)for(var n=0;n<e.customAttributes.length;n++)i.push(e.customAttributes[n].values);for(var r=this._struct.dynamic,s=r.info,a=this._struct.primitives[t],o=this._renderingSubMeshes[t],u=o.drawInfo,h=0;h<i.length;h++){var c=i[h],l=this._struct.vertexBundles[a.vertexBundelIndices[h]],_=l.view.stride,d=c.byteLength/_,f=c.byteLength,m=new Uint8Array(this._data.buffer,l.view.offset,f),g=new Uint8Array(c.buffer,c.byteOffset,f),v=o.vertexBuffers[h];s.maxSubMeshVertices,f>0&&(m.set(g),v.update(g,f)),l.view.count=d,u.vertexCount=d}if(a.indexView){var y=a.indexView,T=y.stride,E=2===T?e.indices16.length:e.indices32.length,S=E*T,A=new Uint8Array(this._data.buffer,y.offset,S),R=2===T?new Uint8Array(e.indices16.buffer,e.indices16.byteOffset,S):new Uint8Array(e.indices32.buffer,e.indices32.byteOffset,S),w=o.indexBuffer;s.maxSubMeshIndices,S>0&&(A.set(R),w.update(R,S)),y.count=E,u.indexCount=E}if(e.minPos&&e.maxPos){var b=new js(e.minPos.x,e.minPos.y,e.minPos.z),O=new js(e.maxPos.x,e.maxPos.y,e.maxPos.z);r.bounds[t]||(r.bounds[t]=new sc),sc.fromPoints(r.bounds[t],b,O);for(var M,I=new js,C=new js,x=p(r.bounds);!(M=x()).done;){var N=M.value;N&&(N.getBoundary(I,C),js.min(b,I,b),js.max(O,C,O))}this._struct.minPosition=new js(b.x,b.y,b.z),this._struct.maxPosition=new js(O.x,O.y,O.z)}o.invalidateGeometricInfo()}else G(14200)},i.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},i.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1,this._isMeshDataUploaded=!1}},i.assign=function(t,e){this.reset({struct:t,data:e})},i.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},i.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var i=[],n=t.bindposes,r=0;r<n.length;r++)e.push(new sc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);for(var s=this._struct.primitives,a=0;a<s.length;a++){var o=this.readAttribute(a,Vt.ATTR_JOINTS),u=this.readAttribute(a,Vt.ATTR_WEIGHTS),h=this.readAttribute(a,Vt.ATTR_POSITION);if(o&&u&&h)for(var c=Math.min(o.length/4,u.length/4,h.length/3),l=0;l<c;l++){js.set(Hb,h[3*l+0],h[3*l+1],h[3*l+2]);for(var _=0;_<4;++_){var d=4*l+_,f=o[d];if(!(0===u[d]||f>=n.length)){js.transformMat4(Vb,Hb,n[f]),i[f]=!0;var p=e[f];js.min(p.center,p.center,Vb),js.max(p.halfExtents,p.halfExtents,Vb)}}}}for(var m=0;m<n.length;m++){var g=e[m];i[m]?sc.fromPoints(g,g.center,g.halfExtents):e[m]=null}return e},i.merge=function(t,e,i){if(i&&!this.validateMergingMesh(t))return!1;var n=new js,r=e&&new sa,s=e&&new sc;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(js.add(s.center,a.maxPosition,a.minPosition),js.multiplyScalar(s.center,s.center,.5),js.subtract(s.halfExtents,a.maxPosition,a.minPosition),js.multiplyScalar(s.halfExtents,s.halfExtents,.5),sc.transform(s,s,e),js.add(a.maxPosition,s.center,s.halfExtents),js.subtract(a.minPosition,s.center,s.halfExtents));for(var u=0;u<a.vertexBundles.length;u++)for(var h=a.vertexBundles[u],c=0;c<h.attributes.length;c++)if(h.attributes[c].name===Vt.ATTR_POSITION||h.attributes[c].name===Vt.ATTR_NORMAL){var l=h.attributes[c].format,_=new DataView(o.buffer,h.view.offset+jb(h.attributes,c)),d=qb(_,l),f=Qb(_,l);if(!d||!f)continue;for(var m=h.view.count,g=h.view.stride,v=Kb(l),y=0;y<m;y++){var T=y*g,E=T+v,S=E+v;switch(n.set(d(T),d(E),d(S)),h.attributes[c].name){case Vt.ATTR_POSITION:n.transformMat4(e);break;case Vt.ATTR_NORMAL:js.transformQuat(n,n,r)}f(T,n.x),f(E,n.y),f(S,n.z)}}}return this.reset({struct:a,data:o}),this.initialize(),!0}for(var A,R,w,b,O,M=new Eu,I=0,C=0,x=0,N=0,B=0,P=0,D=0,F=0,L=!1,U=new Array(this._struct.vertexBundles.length),G=0;G<this._struct.vertexBundles.length;++G){var k=this._struct.vertexBundles[G],z=t._struct.vertexBundles[G];x=k.view.offset,N=z.view.offset,C=k.view.stride,I=k.view.count+z.view.count,A=new ArrayBuffer(I*C),R=new Uint8Array(A),x+=(w=this._data.subarray(x,x+k.view.length)).length,N+=(b=t._data.subarray(N,N+z.view.length)).length,R.set(w),B=0;for(var H,V=p(k.attributes);!(H=V()).done;){var W=H.value;D=0,L=!1;for(var X,j=p(z.attributes);!(X=j()).done;){var Y=X.value;if(W.name===Y.name&&W.format===Y.format){L=!0;break}D+=Ke[Y.format].size}if(L){F=Ke[W.format].size,P=k.view.length+B;for(var K=0;K<z.view.count;++K){if(O=b.subarray(D,D+F),R.set(O,P),(W.name===Vt.ATTR_POSITION||W.name===Vt.ATTR_NORMAL)&&e){var q=new Float32Array(R.buffer,P,3);switch(n.set(q[0],q[1],q[2]),W.name){case Vt.ATTR_POSITION:n.transformMat4(e);break;case Vt.ATTR_NORMAL:js.transformQuat(n,n,r)}q[0]=n.x,q[1]=n.y,q[2]=n.z}P+=k.view.stride,D+=z.view.stride}}B+=Ke[W.format].size}U[G]={attributes:k.attributes,view:{offset:M.getLength(),length:A.byteLength,count:I,stride:C}},M.addBuffer(A)}for(var Q,Z,J,$=0,tt=2,et=0,it=new Array(this._struct.primitives.length),nt=0;nt<this._struct.primitives.length;++nt){var rt=this._struct.primitives[nt],st=t._struct.primitives[nt];it[nt]={primitiveMode:rt.primitiveMode,vertexBundelIndices:rt.vertexBundelIndices};for(var at,ot=p(rt.vertexBundelIndices);!(at=ot()).done;){var ut=at.value;et=Math.max(et,this._struct.vertexBundles[ut].view.count)}if(rt.indexView&&st.indexView){$=rt.indexView.count,$+=st.indexView.count,x=rt.indexView.offset,N=st.indexView.offset,tt=$<256?1:$<65536?2:4;var ht=new ArrayBuffer($*tt);if(Q=2===tt?new Uint16Array(ht):1===tt?new Uint8Array(ht):new Uint32Array(ht),Z=2===rt.indexView.stride?new Uint16Array(this._data.buffer,x,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(this._data.buffer,x,rt.indexView.count):new Uint32Array(this._data.buffer,x,rt.indexView.count),tt===rt.indexView.stride)Q.set(Z);else for(var ct=0;ct<rt.indexView.count;++ct)Q[ct]=Z[ct];x+=rt.indexView.length,J=2===st.indexView.stride?new Uint16Array(t._data.buffer,N,st.indexView.count):1===st.indexView.stride?new Uint8Array(t._data.buffer,N,st.indexView.count):new Uint32Array(t._data.buffer,N,st.indexView.count);for(var lt=0;lt<st.indexView.count;++lt)Q[rt.indexView.count+lt]=et+J[lt];N+=st.indexView.length,it[nt].indexView={offset:M.getLength(),length:ht.byteLength,count:$,stride:tt},M.setNextAlignment(tt),M.addBuffer(ht)}}var _t={vertexBundles:U,primitives:it,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _t.minPosition&&t._struct.minPosition&&_t.maxPosition&&t._struct.maxPosition&&(e?(js.add(s.center,t._struct.maxPosition,t._struct.minPosition),js.multiplyScalar(s.center,s.center,.5),js.subtract(s.halfExtents,t._struct.maxPosition,t._struct.minPosition),js.multiplyScalar(s.halfExtents,s.halfExtents,.5),sc.transform(s,s,e),js.add(n,s.center,s.halfExtents),js.max(_t.maxPosition,_t.maxPosition,n),js.subtract(n,s.center,s.halfExtents),js.min(_t.minPosition,_t.minPosition,n)):(js.min(_t.minPosition,_t.minPosition,t._struct.minPosition),js.max(_t.maxPosition,_t.maxPosition,t._struct.maxPosition))),this.reset({struct:_t,data:new Uint8Array(M.getCombined())}),this.initialize(),!0},i.validateMergingMesh=function(t){if(this._struct.dynamic||t._struct.dynamic)return!1;if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var i=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(i.attributes.length!==n.attributes.length)return!1;for(var r=0;r<i.attributes.length;++r)if(i.attributes[r].format!==n.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var s=0;s<this._struct.primitives.length;++s){var a=this._struct.primitives[s],o=t._struct.primitives[s];if(a.vertexBundelIndices.length!==o.vertexBundelIndices.length)return!1;for(var u=0;u<a.vertexBundelIndices.length;++u)if(a.vertexBundelIndices[u]!==o.vertexBundelIndices[u])return!1;if(a.primitiveMode!==o.primitiveMode)return!1;if(a.indexView){if(void 0===o.indexView)return!1}else if(o.indexView)return!1}return!0},i.readAttribute=function(t,e){var i=this,n=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,s=t.attributes[e].format,a=ri(Ke[s]);if(0!==r){var o=new DataView(i._data.buffer,t.view.offset+jb(t.attributes,e)),u=Ke[s],h=qb(o,s);if(a&&h){for(var c=u.count,l=new a(r*c),_=t.view.stride,d=0;d<r;++d)for(var f=0;f<c;++f)l[c*d+f]=h(_*d+l.BYTES_PER_ELEMENT*f);n=l}}})),n},i.copyAttribute=function(t,e,i,n,r){var s=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var o=t.view.count;if(0!==o){var u=t.attributes[e].format,h=new DataView(s._data.buffer,t.view.offset+jb(t.attributes,e)),c=new DataView(i,r),l=Ke[u],_=qb(h,u),d=Qb(c,u);if(_&&d){for(var f=l.count,p=t.view.stride,m=Kb(u),g=n,v=m,y=0;y<o;++y)for(var T=0;T<f;++T)d(g*y+v*T,_(p*y+m*T));a=!0}}else a=!0})),a},i.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var i=e.indexView.stride;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},i.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var i=this._struct.primitives[t];if(!i.indexView)return!1;for(var n=i.indexView.count,r=1===i.indexView.stride?et.R8UI:2===i.indexView.stride?et.R16UI:et.R32UI,s=qb(new DataView(this._data.buffer),r),a=0;a<n;++a)e[a]=s(i.indexView.offset+Ke[r].size*a);return!0},i.readAttributeFormat=function(t,e){var i=null;return this._accessAttribute(t,e,(function(t,e){var n=t.attributes[e].format;i=Ke[n]})),i},i._accessAttribute=function(t,e,i){if(!(t>=this._struct.primitives.length))for(var n,r=p(this._struct.primitives[t].vertexBundelIndices);!(n=r()).done;){var s=n.value,a=this._struct.vertexBundles[s],o=a.attributes.findIndex((function(t){return t.name===e}));if(!(o<0)){i(a,o);break}}},i._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(i){var n=t.createBuffer(new ae(rt.VERTEX,ot.DEVICE,i.view.length,i.view.stride)),r=new Uint8Array(e,i.view.offset,i.view.length);return n.update(r),n}))},i.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:Wb})},i.releaseData=function(){this._data=Wb},s(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=pi(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}},{key:"allowDataAccess",get:function(){return this._allowDataAccess},set:function(t){this._allowDataAccess=t,this._isMeshDataUploaded&&!this._allowDataAccess&&this.releaseData()}}]),e}(Tu),xb=Za(Cb.prototype,"_struct",[mo],(function(){return{vertexBundles:[],primitives:[]}})),Nb=Za(Cb.prototype,"_hash",[mo],(function(){return 0})),Bb=Za(Cb.prototype,"_allowDataAccess",[mo],(function(){return!0})),Ib=Cb))||Ib);function jb(t,e){for(var i=0,n=0;n<e;++n){var r=t[n];i+=Ke[r.format].size}return i}v.Mesh=Xb;var Yb=za.isLittleEndian;function Kb(t){var e=Ke[t];return e.size/e.count}function qb(t,e){var i=Ke[e],n=i.size/i.count;switch(i.type){case it.UNORM:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Yb)};case 4:return function(e){return t.getUint32(e,Yb)}}break;case it.SNORM:case it.INT:switch(n){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,Yb)};case 4:return function(e){return t.getInt32(e,Yb)}}break;case it.UINT:switch(n){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,Yb)};case 4:return function(e){return t.getUint32(e,Yb)}}break;case it.FLOAT:return function(e){return t.getFloat32(e,Yb)}}return null}function Qb(t,e){var i=Ke[e],n=i.size/i.count;switch(i.type){case it.UNORM:switch(n){case 1:return function(e,i){return t.setUint8(e,i)};case 2:return function(e,i){return t.setUint16(e,i,Yb)};case 4:return function(e,i){return t.setUint32(e,i,Yb)}}break;case it.SNORM:case it.INT:switch(n){case 1:return function(e,i){return t.setInt8(e,i)};case 2:return function(e,i){return t.setInt16(e,i,Yb)};case 4:return function(e,i){return t.setInt32(e,i,Yb)}}break;case it.UINT:switch(n){case 1:return function(e,i){return t.setUint8(e,i)};case 2:return function(e,i){return t.setUint16(e,i,Yb)};case 4:return function(e,i){return t.setUint32(e,i,Yb)}}break;case it.FLOAT:return function(e,i){return t.setFloat32(e,i,Yb)}}return null}var Zb=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_NORMAL,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RG32F),new Ae(Vt.ATTR_TANGENT,et.RGBA32F),new Ae(Vt.ATTR_COLOR,et.RGBA32F)],Jb=new js;function $b(t,e,i){i=i||{};var n,r=[],s=0,a=[],o=0,u=t.positions.slice();if(u.length>0){if(n=null,t.attributes)for(var h,c=p(t.attributes);!(h=c()).done;){var l=h.value;if(l.name===Vt.ATTR_POSITION){n=l;break}}n||(n=Zb[0]),r.push(n);var _=Ke[n.format];o=Math.max(o,Math.floor(u.length/_.count)),a.push({offset:s,data:u,attribute:n}),s+=_.size}if(t.normals&&t.normals.length>0){if(n=null,t.attributes)for(var d,f=p(t.attributes);!(d=f()).done;){var m=d.value;if(m.name===Vt.ATTR_NORMAL){n=m;break}}n||(n=Zb[1]);var g=Ke[n.format];r.push(n),o=Math.max(o,Math.floor(t.normals.length/g.count)),a.push({offset:s,data:t.normals,attribute:n}),s+=g.size}if(t.uvs&&t.uvs.length>0){if(n=null,t.attributes)for(var v,y=p(t.attributes);!(v=y()).done;){var T=v.value;if(T.name===Vt.ATTR_TEX_COORD){n=T;break}}n||(n=Zb[2]);var E=Ke[n.format];r.push(n),o=Math.max(o,Math.floor(t.uvs.length/E.count)),a.push({offset:s,data:t.uvs,attribute:n}),s+=E.size}if(t.tangents&&t.tangents.length>0){if(n=null,t.attributes)for(var S,A=p(t.attributes);!(S=A()).done;){var R=S.value;if(R.name===Vt.ATTR_TANGENT){n=R;break}}n||(n=Zb[3]);var w=Ke[n.format];r.push(n),o=Math.max(o,Math.floor(t.tangents.length/w.count)),a.push({offset:s,data:t.tangents,attribute:n}),s+=w.size}if(t.colors&&t.colors.length>0){if(n=null,t.attributes)for(var b,O=p(t.attributes);!(b=O()).done;){var M=b.value;if(M.name===Vt.ATTR_COLOR){n=M;break}}n||(n=Zb[4]);var I=Ke[n.format];r.push(n),o=Math.max(o,Math.floor(t.colors.length/I.count)),a.push({offset:s,data:t.colors,attribute:n}),s+=I.size}if(t.customAttributes)for(var C=0;C<t.customAttributes.length;C++){var x=t.customAttributes[C],N=Ke[x.attr.format];r.push(x.attr),o=Math.max(o,Math.floor(x.values.length/N.count)),a.push({offset:s,data:x.values,attribute:x.attr}),s+=N.size}for(var B=new Eu,P=new ArrayBuffer(o*s),D=new DataView(P),F=0,L=a;F<L.length;F++){var U=L[F];Ka(D,U.data,U.attribute.format,U.offset,s)}B.setNextAlignment(0);var G={attributes:r,view:{offset:B.getLength(),length:P.byteLength,count:o,stride:s}};B.addBuffer(P);var k=null,z=0;if(t.indices){var H=t.indices;z=H.length,k=new ArrayBuffer(2*z),Ka(new DataView(k),H,et.R16UI)}var V={primitiveMode:t.primitiveMode||Ot.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(B.setNextAlignment(2),V.indexView={offset:B.getLength(),length:k.byteLength,count:z,stride:2},B.addBuffer(k));var W=t.minPos;if(!W&&i.calculateBounds){W=js.set(new js,1/0,1/0,1/0);for(var X=0;X<o;++X)js.set(Jb,u[3*X+0],u[3*X+1],u[3*X+2]),js.min(W,W,Jb)}var j=t.maxPos;if(!j&&i.calculateBounds){j=js.set(new js,-1/0,-1/0,-1/0);for(var Y=0;Y<o;++Y)js.set(Jb,u[3*Y+0],u[3*Y+1],u[3*Y+2]),js.max(j,j,Jb)}var K={vertexBundles:[G],primitives:[V]};return W&&(K.minPosition=new js(W.x,W.y,W.z)),j&&(K.maxPosition=new js(j.x,j.y,j.z)),e||(e=new Xb),e.reset({struct:K,data:new Uint8Array(B.getCombined())}),e}function tO(t,e){if(e>0){var i=t%e;if(0!==i)return e-i}return 0}var eO=function(){function t(){}return t.createMesh=function(t,e,i){return $b(t,e,i)},t.createDynamicMesh=function(t,e,i,n){return function(t,e,i,n){n=n||{maxSubMeshes:1,maxSubMeshVertices:1024,maxSubMeshIndices:1024};var r=[],s=0;if(e.positions.length>0&&r.push(new Ae(Vt.ATTR_POSITION,et.RGB32F,!1,s++,!1,0)),e.normals&&e.normals.length>0&&r.push(new Ae(Vt.ATTR_NORMAL,et.RGB32F,!1,s++,!1,0)),e.uvs&&e.uvs.length>0&&r.push(new Ae(Vt.ATTR_TEX_COORD,et.RG32F,!1,s++,!1,0)),e.tangents&&e.tangents.length>0&&r.push(new Ae(Vt.ATTR_TANGENT,et.RGBA32F,!1,s++,!1,0)),e.colors&&e.colors.length>0&&r.push(new Ae(Vt.ATTR_COLOR,et.RGBA32F,!1,s++,!1,0)),e.customAttributes)for(var a=0;a<e.customAttributes.length;a++){var o=e.customAttributes[a],u=new Ae;u.copy(o.attr),u.stream=s++,r.push(u)}for(var h=[],c=[],l=0,_=0;_<n.maxSubMeshes;_++){for(var d,f={vertexBundelIndices:[],primitiveMode:e.primitiveMode||Ot.TRIANGLE_LIST},m=p(r);!(d=m()).done;){var g=d.value,v=Ke[g.format],y=n.maxSubMeshVertices*v.size,T={view:{offset:l,length:y,count:0,stride:v.size},attributes:[g]},E=h.length;f.vertexBundelIndices.push(E),h.push(T),l+=y}var S=0;if(e.indices16&&e.indices16.length>0?S=2:e.indices32&&e.indices32.length>0&&(S=4),S>0){l+=tO(l,S);var A=n.maxSubMeshIndices*S,R={offset:l,length:A,count:0,stride:S};f.indexView=R,l+=A}c.push(f)}var w={info:{maxSubMeshes:n.maxSubMeshes,maxSubMeshVertices:n.maxSubMeshVertices,maxSubMeshIndices:n.maxSubMeshIndices},bounds:[]};w.bounds.length=n.maxSubMeshes;var b={struct:{vertexBundles:h,primitives:c,dynamic:w},data:new Uint8Array(l)};return i||(i=new Xb),i.reset(b),i.initialize(),i.updateSubMesh(t,e),i}(t,e,i,n)},t}(),iO=Object.freeze({__proto__:null,find:q,toPPM:function(t,e,i){return"P3 "+e+" "+i+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:function(t,e){void 0===e&&(e=0);for(var i,n={positions:[]},r=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),s=t.struct,a=s.primitives[e],o=p(a.vertexBundelIndices);!(i=o()).done;)for(var u,h=i.value,c=s.vertexBundles[h],l=c.view.offset,_=c.view,d=_.length,f=_.stride,m=p(c.attributes);!(u=m()).done;){var g=u.value,v=Xa[g.name];v&&(n[v]=(n[v]||[]).concat(qa(r,g.format,l,d,f))),l+=Ke[g.format].size}var y=a.indexView;return n.indices=qa(r,et["R"+8*y.stride+"UI"],y.offset,y.length),n},createMesh:$b,MeshUtils:eO,readBuffer:qa,writeBuffer:Ka,mapBuffer:Qa});t("utils",iO);var nO,rO=0,sO={},aO=new Le(null),oO=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Vp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1}var e=t.prototype;return e.initialize=function(t,e,i){void 0===i&&(i=null);var n=v.director.root;this._device=Wa.gfxDevice,aO.layout=e[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(t.iaInfo),this._descriptorSet=this._device.createDescriptorSet(aO);var r=v.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass();if(r){var s=new Le(null);s.layout=r.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(s)}if(this._subMesh=t,this._patches=i,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===OT.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=Vp.DEFAULT,e[0].phase===CT("reflection")){var a=n.mainWindow.width,o=n.mainWindow.height,u=512;o<a?(a=u*a/o,o=u):o=u*o/(a=u),this._reflectionTex=this._device.createTexture(new le(ut.TEX2D,ht.STORAGE|ht.TRANSFER_SRC|ht.SAMPLED,et.RGBA8,a,o)),this.descriptorSet.bindTexture(tg,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new de(ft.LINEAR,ft.LINEAR,ft.NONE,pt.CLAMP,pt.CLAMP,pt.CLAMP)),this.descriptorSet.bindSampler(tg,this._reflectionSampler),this.descriptorSet.bindTexture(ng,this._reflectionTex)}},e.initPlanarShadowShader=function(){var t=v.director.root.pipeline.pipelineSceneData.shadows;this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=v.director.root.pipeline.pipelineSceneData.shadows;this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.destroy=function(){var t;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(t=this._worldBoundDescriptorSet)||void 0===t||t.destroy(),this._worldBoundDescriptorSet=null,this.priority=Vp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null},e.update=function(){for(var t,e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),null===(t=this._worldBoundDescriptorSet)||void 0===t||t.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var i=0;i<e.length;i++){var n=e[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onGeometryChanged=function(){if(this._subMesh){var t=this._subMesh.drawInfo;if(this._inputAssembler&&t){var e=this._inputAssembler.drawInfo;Object.keys(t).forEach((function(i){e[i]=t[i]})),this._inputAssembler.drawInfo=e}}},e.getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributeBlock.attributes,i=0;i<e.length;i++)if(e[i].name===t)return i;return-1},e.updateInstancedWorldMatrix=function(t,e){var i=this.instancedAttributeBlock.views,n=i[e],r=i[e+1],s=i[e+2];n[0]=t.m00,n[1]=t.m01,n[2]=t.m02,n[3]=t.m12,r[0]=t.m04,r[1]=t.m05,r[2]=t.m06,r[3]=t.m13,s[0]=t.m08,s[1]=t.m09,s[2]=t.m10,s[3]=t.m14},e.UpdateInstancedAttributes=function(t){this.instancedWorldMatrixIndex=-1;var e=this.passes[0];if(e.device.hasFeature(tt.INSTANCED_ARRAYS)){for(var i=0,n=0;n<t.length;n++){var r=t[n];r.isInstanced&&(i+=Ke[r.format].size)}var s=this.instancedAttributeBlock;s.buffer=new Uint8Array(i),s.views.length=s.attributes.length=0;for(var a=0,o=0;o<t.length;o++){var u=t[o];if(u.isInstanced){var h=new Ae;h.format=u.format,h.name=u.name,h.isNormalized=u.isNormalized,h.location=u.location,s.attributes.push(h);var c=Ke[u.format],l=new(ri(c))(s.buffer.buffer,a,c.count);s.views.push(l),a+=c.size}}e.batchingScheme===OT.INSTANCING&&e.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(Sm)}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},s(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?z(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===OT.VB_MERGING&&this.subMesh.genFlatBuffers(),this._descriptorSet&&(this._descriptorSet.destroy(),aO.layout=t[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(aO)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(t.iaInfo),this._passes[0].batchingScheme===OT.VB_MERGING&&this.subMesh.genFlatBuffers(),this._subMesh=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"instancedAttributeBlock",get:function(){return this._instancedAttributeBlock}},{key:"instancedWorldMatrixIndex",get:function(){return this._instancedWorldMatrixIndex},set:function(t){this._instancedWorldMatrixIndex=t}}]),t}(),uO=new da,hO=[{name:"CC_RECEIVE_SHADOW",value:!0}],cO=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(nO||(nO={}));var lO,_O=new de(ft.LINEAR,ft.LINEAR,ft.NONE,pt.CLAMP,pt.CLAMP,pt.CLAMP),dO=new de(ft.LINEAR,ft.LINEAR,ft.LINEAR,pt.CLAMP,pt.CLAMP,pt.CLAMP),fO=function(){function t(){this.type=nO.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Tm.COUNT),this._localBuffer=null,this._lightmap=null,this._lightmapUVParam=new ta,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=$f.Enum.NONE,this._priority=0,this._device=Wa.gfxDevice}var e=t.prototype;return e.initialize=function(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=$f.Enum.NONE,this._inited=!0)},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++)this._subModels[e].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateUBOs=function(t){for(var e=this._subModels,i=0;i<e.length;i++)e[i].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;for(var n=this.transform._mat,r=!1,s=0;s<e.length;s++){var a=e[s],o=a.instancedWorldMatrixIndex;o>=0?a.updateInstancedWorldMatrix(n,o):r=!0}r&&this._localBuffer&&(da.toArray(this._localData,n,Tm.MAT_WORLD_OFFSET),da.inverseTranspose(uO,n),da.toArray(this._localData,uO,Tm.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=sc.fromPoints(sc.create(),t,e),this._worldBounds=sc.clone(this._modelBounds))},e._createSubModel=function(){return new oO},e.initSubModel=function(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.onGeometryChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onGeometryChanged()},e.initLightingmap=function(t,e){this._lightmap=t,this._lightmapUVParam=e},e.updateLightingmap=function(t,e){ta.toArray(this._localData,e,Tm.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,this.onMacroPatchesStateChanged(),t||(t=IT.get("empty-texture"));var i=t.getGFXTexture();if(i)for(var n=this._device.getSampler(t.mipmaps.length>1?dO:_O),r=this._subModels,s=0;s<r.length;s++){var a=r[s].descriptorSet;a.bindTexture(Km,i),a.bindSampler(Km,n),a.update()}},e.updateLocalShadowBias=function(){var t=this._localData;t[Tm.LOCAL_SHADOW_BIAS+0]=this._shadowBias,t[Tm.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,t[Tm.LOCAL_SHADOW_BIAS+2]=0,t[Tm.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},e.getMacroPatches=function(){var t=this.receiveShadow?hO:null;return null!=this._lightmap&&(t=t?t.concat(cO):cO),t},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),e.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var i=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(i.attributes,e)}},e._updateInstancedAttributes=function(t,e){e.UpdateInstancedAttributes(t),this._localDataUpdated=!0},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE,Tm.SIZE,Tm.SIZE)))},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE,Em.SIZE,Em.SIZE)))},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(Tm.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(Em.BINDING,this._worldBoundBuffer)},s(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t,this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}}]),t}(),pO=function(){function t(){this._enabled=!1,this._minPos=new js(0,0,0),this._maxPos=new js(0,0,0),this._depth=0}return t.prototype.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},s(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}}]),t}();function mO(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),r=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),s=2*n-8*r+4,a=3*n/s,o=2*r/s,u=1/o*a,h=1/o*(1-a-o);t.x=3.2404542*u-1.5371385+-.4985314*h,t.y=-.969266*u+1.8760108+.041556*h,t.z=.0556434*u-.2040259+1.0572252*h}!function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(lO||(lO={}));var gO,vO,yO=function(t){return 4*Math.PI*Math.PI*t*t},TO=function(){function t(){this._baked=!1,this._color=new js(1,1,1),this._colorTemp=6550,this._colorTempRGB=new js(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=lO.UNKNOWN}var e=t.prototype;return e.initialize=function(){this.color=new js(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null},e.update=function(){},s(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,mO(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=gp.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}}]),t}(),EO=new js(0,0,-1),SO=new js,AO=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new js(1,-1,-1),e._illuminanceHDR=jE.SUN_ILLUM,e._illuminanceLDR=1,e._shadowEnabled=!1,e._shadowPcf=qE.HARD,e._shadowBias=1e-5,e._shadowNormalBias=0,e._shadowSaturation=1,e._shadowDistance=50,e._shadowInvisibleOcclusionRange=200,e._csmLevel=QE.LEVEL_4,e._csmNeedUpdate=!1,e._csmLayerLambda=.75,e._csmOptimizationMode=ZE.DisableRotationFix,e._shadowFixedArea=!1,e._shadowNear=.1,e._shadowFar=10,e._shadowOrthoSize=5,e._type=lO.DIRECTIONAL,e}o(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this.illuminance=jE.SUN_ILLUM,this.direction=new js(1,-1,-1)},i.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=js.transformQuat(SO,EO,this._node.worldRotation))},i._activate=function(){var t=v.director.root,e=t.pipeline;this._shadowEnabled?(this._shadowFixedArea||!e.pipelineSceneData.csmSupported?e.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:e.macros.CC_DIR_LIGHT_SHADOW_TYPE=this.csmLevel>1?2:1,e.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):e.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.onGlobalPipelineStateChanged()},s(e,[{key:"direction",get:function(){return this._dir},set:function(t){js.normalize(this._dir,t)}},{key:"illuminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled=t,this._activate()}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(t){this._shadowPcf=t,this._activate()}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(t){this._shadowSaturation=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,$E.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(t){this._shadowInvisibleOcclusionRange=Math.min(t,$E.MAX_FAR)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(t){this._csmLevel=t,this._activate()}},{key:"csmNeedUpdate",get:function(){return this._csmNeedUpdate},set:function(t){this._csmNeedUpdate=t}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(t){this._csmLayerLambda=t}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(t){this._csmOptimizationMode=t}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(t){this._shadowFixedArea=t,this._activate()}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(t){this._shadowNear=t}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(t){this._shadowFar=Math.min(t,$E.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(t){this._shadowOrthoSize=t}}]),e}(TO),RO=function(t){function e(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=sc.create(),e._pos=new js,e._type=lO.SPHERE,e}o(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/yO(.15),this.luminanceLDR=1},i.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;sc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},s(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),e}(TO),wO=new js(0,0,-1),bO=new sa,OO=new da,MO=new da,IO=new da,CO=new da,xO=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new js(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._shadowEnabled=!1,e._shadowPcf=qE.HARD,e._shadowBias=1e-5,e._shadowNormalBias=0,e._aabb=sc.create(),e._frustum=vc.create(),e._pos=new js,e._type=lO.SPOT,e}o(e,t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/yO(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new js(1,-1,-1))},i.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),js.transformQuat(this._dir,wO,this._node.getWorldRotation(bO)),js.normalize(this._dir,this._dir),sc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(OO),da.invert(OO,OO),da.perspective(MO,this._angle,1,.001,this._range),da.multiply(IO,MO,OO),this._frustum.update(IO,CO),this._needUpdate=!1)},s(e,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled=t}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(t){this._shadowPcf=t}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t}}]),e}(TO),NO=Object.freeze({__proto__:null,get CameraFOVAxis(){return ag},get CameraProjection(){return og},get CameraAperture(){return ug},get CameraISO(){return hg},get CameraShutter(){return cg},get CameraType(){return lg},get TrackingType(){return _g},SKYBOX_FLAG:rv,Camera:av,get ModelType(){return nO},Model:fO,SubModel:oO,Ambient:jE,EnvironmentLightingType:iS,Skybox:nS,ShadowSize:YE,ShadowType:KE,PCFType:qE,CSMLevel:QE,CSMOptimizationMode:ZE,Shadows:$E,FogType:XA,Fog:YA,Octree:pO,ColorTemperatureToRGB:mO,get LightType(){return lO},nt2lm:yO,Light:TO,DirectionalLight:AO,SphereLight:RO,SpotLight:xO});function BO(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function PO(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(gO||(gO={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(vO||(vO={}));var DO,FO,LO,UO,GO,kO,zO,HO,VO,WO=function(){function t(t){this._device=void 0,this._format=et.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new te,this._region1=new te,this._region2=new te,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=Ke[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=ri(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=PO(t,this._alignment);var i=-1,n=-1;if(void 0!==e&&(i=e,n=this._findAvailableSpace(t,i)),n<0)for(var r=0;r<this._chunkCount&&(i=r,!((n=this._findAvailableSpace(t,i))>=0));++r);if(n>=0){var s=this._chunks[i];s.start+=t;var a={chunkIdx:i,start:n,end:n+t,texture:s.texture};return this._handles.push(a),a}var o=Math.sqrt(t/this._formatSize),u=this._roundUpFn&&this._roundUpFn(o,this._formatSize)||Math.max(1024,BO(o)),h=this._chunks[this.createChunk(u)];h.start+=t;var c={chunkIdx:this._chunkCount-1,start:0,end:t,texture:h.texture};return this._handles.push(c),c},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;N("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var i={texture:this._device.createTexture(new le(ut.TEX2D,ht.SAMPLED|ht.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++},e.update=function(t,e){var i=[],n=[],r=t.start/this._formatSize,s=e.byteLength/this._formatSize,a=r%t.texture.width,o=Math.floor(r/t.texture.width),u=Math.min(t.texture.width-a,s),h=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=o,this._region0.texExtent.width=u,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,h*this._formatSize,u*this._channels)),n.push(this._region0),a=0,o+=1,s-=u,h+=u),s>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=o,s>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(s/t.texture.width),u=this._region1.texExtent.width*this._region1.texExtent.height):(u=s,this._region1.texExtent.width=u,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,h*this._formatSize,u*this._channels)),n.push(this._region1),a=0,o+=this._region1.texExtent.height,s-=u,h+=u),s>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=o,this._region2.texExtent.width=s,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,h*this._formatSize,s*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,n)},e._findAvailableSpace=function(t,e){var i=this._chunks[e],n=!1,r=i.start;if(r+t<=i.size)n=!0;else{r=0;for(var s=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<s.length;a++){var o=s[a];if(r+t<=o.start){n=!0;break}r=o.end}!n&&r+t<=i.size&&(n=!0)}return n?r:-1},e._McDonaldAlloc=function(t){t=PO(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var i=this._chunks[e],n=!1,r=i.start;if(r+t<=i.end?n=!0:r>i.end?r+t<=i.size?n=!0:t<=i.end&&(i.start=r=0,n=!0):r===i.end&&(i.start=r=0,i.end=i.size,t<=i.end&&(n=!0)),n){i.start+=t;var s={chunkIdx:e,start:r,end:r+t,texture:i.texture};return this._handles.push(s),s}}var a=Math.sqrt(t/this._formatSize),o=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,BO(a)),u=this._chunks[this.createChunk(o)];u.start+=t;var h={chunkIdx:this._chunkCount,start:0,end:t,texture:u.texture};return this._handles.push(h),h},t}(),XO=function(){function t(t,e,i){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=i*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(VO||(VO={}));var jO,YO,KO=function(){function t(t,e,i,n,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new XO(t,r,this._stride);var s=VO.NEVER,a=!1,o=!1;for(var u in e){if(a=this._hasFloat32,(o=this._hasUint32)&&a)break;s=e[u],a||s!==VO.FLOAT32?o||s!==VO.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}for(var n=this._nativePool.allocateNewChunk(),r=[],s=[],a=[],o=this._hasFloat32,u=this._hasUint32,h=0;h<this._entriesPerChunk;h++)o&&r.push(new Float32Array(n,this._stride*h,this._elementCount)),u&&s.push(new Uint32Array(n,this._stride*h,this._elementCount)),h&&a.push(h);return u&&this._uint32BufferViews.push(s),o&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(n),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][i]},e.getTypedArray=function(t,e){var i=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t,r=e,s=(this._dataType[e]===VO.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],a=this._dataMembers[e];return s.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freeLists[e].push(i)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB",t[t.RENDER2D=3]="RENDER2D"}(jO||(jO={})),function(t){t[t.POSITION=0]="POSITION",t[t.UV=3]="UV",t[t.COLOR=5]="COLOR",t[t.COUNT=9]="COUNT"}(YO||(YO={}));var qO,QO=((DO={})[YO.POSITION]=VO.FLOAT32,DO[YO.UV]=VO.FLOAT32,DO[YO.COLOR]=VO.UINT32,DO[YO.COUNT]=VO.NEVER,DO),ZO=((FO={})[YO.POSITION]=YO.UV-YO.POSITION,FO[YO.UV]=YO.COLOR-YO.UV,FO[YO.COLOR]=YO.COUNT-YO.COLOR,FO[YO.COUNT]=1,FO),JO=new KO(jO.RENDER2D,QO,ZO,YO);!function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(qO||(qO={}));var $O,tM=((LO={})[qO.DIRTY_FLAG]=VO.UINT32,LO[qO.LAYER]=VO.UINT32,LO[qO.WORLD_SCALE]=VO.FLOAT32,LO[qO.WORLD_POSITION]=VO.FLOAT32,LO[qO.WORLD_ROTATION]=VO.FLOAT32,LO[qO.WORLD_MATRIX]=VO.FLOAT32,LO[qO.LOCAL_SCALE]=VO.FLOAT32,LO[qO.LOCAL_POSITION]=VO.FLOAT32,LO[qO.LOCAL_ROTATION]=VO.FLOAT32,LO[qO.COUNT]=VO.NEVER,LO),eM=((UO={})[qO.DIRTY_FLAG]=qO.LAYER-qO.DIRTY_FLAG,UO[qO.LAYER]=qO.WORLD_SCALE-qO.LAYER,UO[qO.WORLD_SCALE]=qO.WORLD_POSITION-qO.WORLD_SCALE,UO[qO.WORLD_POSITION]=qO.WORLD_ROTATION-qO.WORLD_POSITION,UO[qO.WORLD_ROTATION]=qO.WORLD_MATRIX-qO.WORLD_ROTATION,UO[qO.WORLD_MATRIX]=qO.LOCAL_SCALE-qO.WORLD_MATRIX,UO[qO.LOCAL_SCALE]=qO.LOCAL_POSITION-qO.LOCAL_SCALE,UO[qO.LOCAL_POSITION]=qO.LOCAL_ROTATION-qO.LOCAL_POSITION,UO[qO.LOCAL_ROTATION]=qO.COUNT-qO.LOCAL_ROTATION,UO[qO.COUNT]=1,UO),iM=new KO(jO.NODE,tM,eM,qO);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}($O||($O={}));var nM,rM=((GO={})[$O.PRIORITY]=VO.UINT32,GO[$O.STAGE]=VO.UINT32,GO[$O.PHASE]=VO.UINT32,GO[$O.PRIMITIVE]=VO.UINT32,GO[$O.BATCHING_SCHEME]=VO.UINT32,GO[$O.DYNAMIC_STATE]=VO.UINT32,GO[$O.HASH]=VO.UINT32,GO[$O.COUNT]=VO.NEVER,GO),sM=((kO={})[$O.PRIORITY]=$O.STAGE-$O.PRIORITY,kO[$O.STAGE]=$O.PHASE-$O.STAGE,kO[$O.PHASE]=$O.PRIMITIVE-$O.PHASE,kO[$O.PRIMITIVE]=$O.BATCHING_SCHEME-$O.PRIMITIVE,kO[$O.BATCHING_SCHEME]=$O.DYNAMIC_STATE-$O.BATCHING_SCHEME,kO[$O.DYNAMIC_STATE]=$O.HASH-$O.DYNAMIC_STATE,kO[$O.HASH]=$O.COUNT-$O.HASH,kO[$O.COUNT]=1,kO),aM=new KO(jO.PASS,rM,sM,$O);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(nM||(nM={}));var oM=((zO={})[nM.CENTER]=VO.FLOAT32,zO[nM.HALFEXTENTS]=VO.FLOAT32,zO[nM.COUNT]=VO.NEVER,zO),uM=((HO={})[nM.CENTER]=nM.HALFEXTENTS-nM.CENTER,HO[nM.HALFEXTENTS]=nM.COUNT-nM.HALFEXTENTS,HO[nM.COUNT]=1,HO),hM=new KO(jO.AABB,oM,uM,nM),cM=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.update=function(t){var e=this._mainLight;e&&e.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var r=this._spotLights,s=0;s<r.length;s++)r[s].update();for(var a=this._models,o=0;o<a.length;o++){var u=a[o];u.enabled&&(u.updateTransform(t),u.updateUBOs(t))}},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=p(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=gp.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=p(this._models);!(t=e()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=p(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},s(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}}]),t}(),lM=function(t){if(void 0===sO[t]){var e=1<<rO;sO[t]=e,rO+=1}},_M=Object.freeze({__proto__:null,addStage:lM,scene:NO,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var i=[],n=e.positions.length/3,r=0;r<n;++r)i.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&i.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&i.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&i.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var s=[];s.push(new Ae(Vt.ATTR_POSITION,et.RGB32F)),e.normals&&s.push(new Ae(Vt.ATTR_NORMAL,et.RGB32F)),e.uvs&&s.push(new Ae(Vt.ATTR_TEX_COORD,et.RG32F)),e.colors&&s.push(new Ae(Vt.ATTR_COLOR,et.RGB32F));var a=t.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,4*i.length,4*i.length/n));a.update(new Float32Array(i));var o=null;return e.indices&&(o=t.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new we(s,[a],o))},get RenderQueue(){return gO},get PassStage(){return vO},genHandle:vv,getTypeFromHandle:yv,getBindingFromHandle:Tv,getCountFromHandle:Ev,getOffsetFromHandle:Sv,customizeType:Av,type2reader:Rv,type2writer:wv,getDefaultFromType:Ov,getStringFromType:Mv,overrideMacros:Iv,get BatchingSchemes(){return OT},Pass:FT,getDeviceShaderVersion:Fv,programLib:Xv,nearestPOT:BO,TextureBufferPool:WO,MaterialInstance:_E,PassInstance:lE,get PoolType(){return jO},NULL_HANDLE:0,get Render2dView(){return YO},Render2dPool:JO,get NodeView(){return qO},NodePool:iM,get PassView(){return $O},PassPool:aM,get AABBView(){return nM},AABBPool:hM,RenderScene:cM});t("renderer",_M);var dM,fM,pM,mM,gM,vM,yM,TM,EM,SM,AM,RM,wM,bM,OM,MM,IM,CM,xM,NM,BM,PM,DM,FM,LM,UM,GM,kM,zM,HM,VM,WM,XM=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}o(e,t);var i=e.prototype;return i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);if(this._morphRenderingInstance){var n=this._morphRenderingInstance.requiredPatches(e);if(n)return n.concat(null!=i?i:[])}return i},i.initSubModel=function(e,i,n){return t.prototype.initSubModel.call(this,e,i,this._launderMaterial(n))},i.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},i.setSubModelMaterial=function(e,i){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(i))},i.setMorphRendering=function(t){this._morphRenderingInstance=t},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,i)},i._launderMaterial=function(t){return t},e}(fO),jM=Ln({OFF:0,ON:1}),YM=Ln({OFF:0,ON:1}),KM=(dM=ao("cc.ModelLightmapSettings"),fM=go("_recieveShadow"),dM((mM=function(){function t(){this.texture=gM&&gM(),this.uvParam=vM&&vM(),this._bakeable=yM&&yM(),this._castShadow=TM&&TM(),this._receiveShadow=EM&&EM(),this._lightmapSize=SM&&SM()}return s(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),gM=Za(mM.prototype,"texture",[mo],(function(){return null})),vM=Za(mM.prototype,"uvParam",[mo],(function(){return new ta})),yM=Za(mM.prototype,"_bakeable",[mo],(function(){return!1})),TM=Za(mM.prototype,"_castShadow",[mo],(function(){return!1})),EM=Za(mM.prototype,"_receiveShadow",[fM],(function(){return!1})),SM=Za(mM.prototype,"_lightmapSize",[mo],(function(){return 64})),pM=mM))||pM),qM=t("MeshRenderer",(AM=ao("cc.MeshRenderer"),RM=uo(100),wM=xo(fr),bM=co({group:{name:"DynamicShadowSettings",displayOrder:0}}),OM=xo(fr),MM=co({group:{name:"DynamicShadowSettings",displayOrder:1}}),IM=xo(jM),CM=co({group:{name:"DynamicShadowSettings",displayOrder:2}}),xM=xo(YM),NM=co({group:{name:"DynamicShadowSettings",displayOrder:3}}),BM=xo(Xb),AM(PM=RM((WM=VM=function(t){function e(){var e;return(e=t.call(this)||this).lightmapSettings=FM&&FM(),e._mesh=LM&&LM(),e._shadowCastingMode=UM&&UM(),e._shadowReceivingMode=GM&&GM(),e._shadowBias=kM&&kM(),e._shadowNormalBias=zM&&zM(),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,e._enableMorph=HM&&HM(),e._modelType=fO,e}o(e,t);var i=e.prototype;return i.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},i.onRestore=function(){this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias()},i.onEnable=function(){t.prototype.onEnable.call(this),this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateShadowBias(),this._updateShadowNormalBias(),this._onUpdateLocalShadowBias(),this._attachToScene()},i.onDisable=function(){this._model&&this._detachFromScene()},i.onDestroy=function(){this._model&&(v.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},i.onGeometryChanged=function(){if(this._model&&this._mesh){var t=this._mesh.struct;this._model.createBoundingShape(t.minPosition,t.maxPosition),this._model.updateWorldBound(),this._model.onGeometryChanged()}},i.getWeight=function(t,e){this._subMeshShapesWeights.length;var i=this._subMeshShapesWeights[t];return i.length,i[e]},i.setWeights=function(t,e){var i=this._subMeshShapesWeights;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},i.setWeight=function(t,e,i){var n=this._subMeshShapesWeights;if(!(e>=n.length)){var r=n[e];i>=r.length||(r[i]=t,this._uploadSubMeshShapesWeights(e))}},i.setInstancedAttribute=function(t,e){if(this.model)for(var i=this.model.subModels,n=0;n<i.length;n++)for(var r=i[n].instancedAttributeBlock,s=r.attributes,a=r.views,o=0;o<s.length;o++)if(s[o].name===t){a[o].set(e);break}},i._updateLightmap=function(t,e,i,n,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},i._updateModels=function(){if(this.enabledInHierarchy){var t=this._model;if(t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model){if(this._mesh){var e=this._mesh.struct;this._model.createBoundingShape(e.minPosition,e.maxPosition)}this._model.initLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this._updateModelParams(),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias()}}},i._createModel=function(){var t=this._morphInstance&&this._modelType===fO?XM:this._modelType,e=this._model=v.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof XM&&e.setMorphRendering(this._morphInstance)},i._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=gp.POSITION,this._model.transform.hasChangedFlags|=gp.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var i=0;i<t;++i){var n=this.getRenderMaterial(i);n&&!n.isValid&&(n=null);var r=e[i];r&&this._model.initSubModel(i,r,n||this._getBuiltinMaterial())}this._model.enabled=!0}},i._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},i._onUpdateLocalShadowBias=function(){null!==this.model&&this.model.updateLocalShadowBias(),this.setInstancedAttribute("a_localShadowBias",[this._shadowBias,this._shadowNormalBias])},i._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},i._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap(),this._onUpdateLocalShadowBias())},i._onMeshChanged=function(){},i._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},i._getBuiltinMaterial=function(){return IT.get("missing-material")},i._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},i._updateShadowBias=function(){this._model&&(this._model.shadowBias=this._shadowBias)},i._updateShadowNormalBias=function(){this._model&&(this._model.shadowNormalBias=this._shadowNormalBias)},i._updateCastShadow=function(){this._model&&(this._shadowCastingMode===jM.OFF?this._model.castShadow=!1:(this._shadowCastingMode,jM.ON,this._shadowCastingMode,this._model.castShadow=!0))},i._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===YM.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},i._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var i=0;i<e.passes.length;++i)if(e.passes[i].batchingScheme)return!0}return!1},i._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof XM&&this._model.setMorphRendering(this._morphInstance)}},i._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):i?(i.length,t.targets.length,i.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},i._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var i=t.struct.morph;return i.subMeshMorphs.length===e.length&&e.every((function(t,e){var n,r,s=t.length;return(null!==(n=null===(r=i.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==n?n:0)===s}))},i._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},s(e,[{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t,this._updateShadowBias(),this._onUpdateLocalShadowBias()}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t,this._updateShadowNormalBias(),this._onUpdateLocalShadowBias()}},{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(pE),VM.ShadowCastingMode=jM,VM.ShadowReceivingMode=YM,FM=Za((DM=WM).prototype,"lightmapSettings",[mo],(function(){return new KM})),LM=Za(DM.prototype,"_mesh",[mo],(function(){return null})),UM=Za(DM.prototype,"_shadowCastingMode",[mo],(function(){return jM.OFF})),GM=Za(DM.prototype,"_shadowReceivingMode",[mo],(function(){return YM.ON})),kM=Za(DM.prototype,"_shadowBias",[mo],(function(){return 0})),zM=Za(DM.prototype,"_shadowNormalBias",[mo],(function(){return 0})),m(DM.prototype,"shadowBias",[wM,bM],Object.getOwnPropertyDescriptor(DM.prototype,"shadowBias"),DM.prototype),m(DM.prototype,"shadowNormalBias",[OM,MM],Object.getOwnPropertyDescriptor(DM.prototype,"shadowNormalBias"),DM.prototype),m(DM.prototype,"shadowCastingMode",[IM,CM],Object.getOwnPropertyDescriptor(DM.prototype,"shadowCastingMode"),DM.prototype),m(DM.prototype,"receiveShadow",[xM,NM],Object.getOwnPropertyDescriptor(DM.prototype,"receiveShadow"),DM.prototype),m(DM.prototype,"mesh",[BM],Object.getOwnPropertyDescriptor(DM.prototype,"mesh"),DM.prototype),HM=Za(DM.prototype,"_enableMorph",[mo],(function(){return!0})),PM=DM))||PM)||PM));function QM(t,e){var i=t.sharedMaterials.length;if(i!==e.sharedMaterials.length)return!1;for(var n=0;n<i;n++)if(t.getRenderMaterial(n)!==e.getRenderMaterial(n))return!1;return!0}t("BatchingUtility",function(){function t(){}return t.batchStaticModel=function(t,e){var i=t.getComponentsInChildren(qM);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var n=1;n<i.length;n++){if(!i[0].mesh.validateMergingMesh(i[n].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1;if(!QM(i[0],i[n]))return console.error("the materials of "+i[0].node.name+" and "+i[n].node.name+" can't be merged"),!1}var r=new Xb,s=new da,a=new da;t.getWorldMatrix(a),da.invert(a,a);for(var o=0;o<i.length;o++){var u=i[o];u.node.getWorldMatrix(s),da.multiply(s,a,s),r.merge(i[o].mesh,s),u.enabled=!1}var h=e.addComponent(qM);return h.mesh=r,h.sharedMaterials=i[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var i=t.getComponentsInChildren(qM),n=0;n<i.length;n++)i[n].enabled=!0;var r=e.getComponent(qM);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}());var ZM,JM,$M,tI,eI,iI,nI,rI,sI,aI,oI,uI,hI,cI,lI,_I,dI,fI,pI,mI,gI,vI,yI,TI,EI=t("Skeleton",(ZM=ao("cc.Skeleton"),JM=xo([mr]),$M=xo([da]),ZM((eI=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._joints=iI&&iI(),e._bindposes=nI&&nI(),e._hash=rI&&rI(),e._invBindposes=null,e}o(e,t);var i=e.prototype;return i.destroy=function(){var e,i;return null===(e=v.director.root)||void 0===e||null===(i=e.dataPoolManager)||void 0===i||i.releaseSkeleton(this),t.prototype.destroy.call(this)},i.validate=function(){return this.joints.length>0&&this.bindposes.length>0},s(e,[{key:"joints",get:function(){return this._joints},set:function(t){this._joints=t}},{key:"bindposes",get:function(){return this._bindposes},set:function(t){this._bindposes=t}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var t=0;t<this._bindposes.length;t++){var e=new da;da.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var t="",e=0;e<this._bindposes.length;e++){var i=this._bindposes[e];t+=i.m00.toPrecision(2)+" "+i.m01.toPrecision(2)+" "+i.m02.toPrecision(2)+" "+i.m03.toPrecision(2)+" "+i.m04.toPrecision(2)+" "+i.m05.toPrecision(2)+" "+i.m06.toPrecision(2)+" "+i.m07.toPrecision(2)+" "+i.m08.toPrecision(2)+" "+i.m09.toPrecision(2)+" "+i.m10.toPrecision(2)+" "+i.m11.toPrecision(2)+" "+i.m12.toPrecision(2)+" "+i.m13.toPrecision(2)+" "+i.m14.toPrecision(2)+" "+i.m15.toPrecision(2)+"\n"}this._hash=pi(t,666)}return this._hash}}]),e}(Tu),iI=Za(eI.prototype,"_joints",[JM],(function(){return[]})),nI=Za(eI.prototype,"_bindposes",[$M],(function(){return[]})),rI=Za(eI.prototype,"_hash",[mo],(function(){return 0})),tI=eI))||tI));v.Skeleton=EI;var SI=new js,AI=Ln({LUMINOUS_FLUX:0,LUMINANCE:1}),RI=ao("cc.StaticLightSettings")((aI=function(){function t(){this._baked=oI&&oI(),this._editorOnly=uI&&uI(),this._bakeable=hI&&hI(),this._castShadow=cI&&cI()}return s(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),oI=Za(aI.prototype,"_baked",[mo],(function(){return!1})),uI=Za(aI.prototype,"_editorOnly",[mo],(function(){return!1})),hI=Za(aI.prototype,"_bakeable",[mo],(function(){return!1})),cI=Za(aI.prototype,"_castShadow",[mo],(function(){return!1})),sI=aI))||sI,wI=t("Light",(lI=ao("cc.Light"),_I=xo(RI),lI((TI=yI=function(t){function e(){var e;return(e=t.call(this)||this)._color=pI&&pI(),e._useColorTemperature=mI&&mI(),e._colorTemperature=gI&&gI(),e._staticSettings=vI&&vI(),e._type=lO.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=TO,e}o(e,t);var i=e.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=v.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},i._destroyLight=function(){this._light&&(v.director.root.recycleLight(this._light),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case lO.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case lO.SPHERE:t.addSphereLight(this._light);break;case lO.SPOT:t.addSpotLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case lO.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case lO.SPHERE:t.removeSphereLight(this._light);break;case lO.SPOT:t.removeSpotLight(this._light)}}},s(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(SI.x=t.r/255,SI.y=t.g/255,SI.z=t.b/255,this._light.color=SI)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(el),yI.Type=lO,yI.PhotometricTerm=AI,pI=Za((fI=TI).prototype,"_color",[mo],(function(){return Aa.WHITE.clone()})),mI=Za(fI.prototype,"_useColorTemperature",[mo],(function(){return!1})),gI=Za(fI.prototype,"_colorTemperature",[mo],(function(){return 6550})),vI=Za(fI.prototype,"_staticSettings",[mo],(function(){return new RI})),m(fI.prototype,"staticSettings",[_I],Object.getOwnPropertyDescriptor(fI.prototype,"staticSettings"),fI.prototype),dI=fI))||dI)),bI=new js,OI=Hu.create(0,0,0,1),MI=new Hi((function(){return{model:null,depth:0}}),128);function II(t,e){var i=0;t.node&&(js.subtract(bI,t.node.worldPosition,e.position),i=js.dot(bI,e.forward));var n=MI.alloc();return n.model=t,n.depth=i,n}function CI(t,e){var i=t.pipelineSceneData.validPunctualLights;i.length=0;for(var n=e.scene.spotLights,r=0;r<n.length;r++){var s=n[r];s.baked||(Hu.set(OI,s.position.x,s.position.y,s.position.z,s.range),jh.sphereFrustum(OI,e.frustum)&&i.push(s))}for(var a=e.scene.sphereLights,o=0;o<a.length;o++){var u=a[o];u.baked||(Hu.set(OI,u.position.x,u.position.y,u.position.z,u.range),jh.sphereFrustum(OI,e.frustum)&&i.push(u))}}function xI(t,e){var i=e.scene,n=i.mainLight,r=t.pipelineSceneData,s=r.shadows,a=r.skybox,o=r.csmLayers,u=r.renderObjects;MI.freeArray(u),u.length=0;var h=o.castShadowObjects;h.length=0;var c=o.layerObjects;c.clear(),s.enabled&&(t.pipelineUBO.updateShadowUBORange(am.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===KE.ShadowMap&&n&&n.node&&o.update(r,e)),e.clearFlag&rv&&(a.enabled&&a.model?u.push(II(a.model,e)):e.clearFlag===rv&&v.warnID(15100,e.name));for(var l=i.models,_=e.visibility,d=0;d<l.length;d++){var f=l[d];if(f.enabled&&(f.castShadow&&(h.push(II(f,e)),c.push(II(f,e))),f.node&&(_&f.node.layer)===f.node.layer||_&f.visFlags)){if(f.worldBounds&&!jh.aabbFrustum(f.worldBounds,e.frustum))continue;u.push(II(f,e))}}}var NI,BI,PI,DI,FI,LI=new de(ft.LINEAR,ft.LINEAR,ft.NONE,pt.CLAMP,pt.CLAMP,pt.CLAMP),UI=new de(ft.POINT,ft.POINT,ft.NONE,pt.CLAMP,pt.CLAMP,pt.CLAMP),GI=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t,this._linearSampler=this._device.getSampler(LI),this._pointSampler=this._device.getSampler(UI);var e=new Fe(Kp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Le(this._descriptorSetLayout))}var e=t.prototype;return e.regenLayout=function(){var t=new Fe(Kp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Le(this._descriptorSetLayout))},e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindBuffer(t,e),n=i.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindSampler(t,e),n=i.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var i=this._descriptorSetMap.values(),n=i.next();!n.done;)n.value.bindTexture(t,e),n=i.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var i=this._globalDescriptorSet,n=e.createDescriptorSet(new Le(this._descriptorSetLayout));this._descriptorSetMap.set(t,n);for(var r=Yp.UBO_GLOBAL;r<Yp.COUNT;r++)n.bindBuffer(r,i.getBuffer(r)),n.bindSampler(r,i.getSampler(r)),n.bindTexture(r,i.getTexture(r));var s=e.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,am.SIZE,am.SIZE));n.bindBuffer(am.BINDING,s),n.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},s(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}(),kI=t("DebugView",function(){function t(){this._singleMode=0,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._nativeConfig=null,this._activate()}var e=t.prototype;return e.isCompositeModeEnabled=function(t){return 0!=(this._compositeModeValue&1<<t)},e.enableCompositeMode=function(t,e){this._enableCompositeMode(t,e),this._updatePipeline()},e.enableAllCompositeMode=function(t){this._enableAllCompositeMode(t),this._updatePipeline()},e.isEnabled=function(){return 0!==this._getType()},e.reset=function(){this._activate(),this._updatePipeline()},e._activate=function(){this._singleMode=0,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1},e._updatePipeline=function(){var t=v.director.root,e=t.pipeline,i=this._getType();e.macros.CC_USE_DEBUG_VIEW!==i&&(e.macros.CC_USE_DEBUG_VIEW=i,t.onGlobalPipelineStateChanged())},e._enableCompositeMode=function(t,e){e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)},e._enableAllCompositeMode=function(t){for(var e=0;e<12;e++)t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)},e._getType=function(){if(0!==this._singleMode)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var t=0;t<12;t++)if(!this.isCompositeModeEnabled(t))return 2;return 0},s(t,[{key:"singleMode",get:function(){return this._singleMode},set:function(t){this._singleMode=t,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(t){this._lightingWithAlbedo=t,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(t){this._csmLayerColoration=t,this._updatePipeline()}}]),t}()),zI=new da,HI=new da,VI=new da,WI=new ta,XI=new ta(0,0,1,0),jI=new js,YI=function(){function t(){this._globalUBO=new Float32Array(rm.COUNT),this._cameraUBO=new Float32Array(sm.COUNT),this._shadowUBO=new Float32Array(am.COUNT),this._csmUBO=new Float32Array(om.COUNT)}t.updateGlobalUBOView=function(t,e){var i=v.director,n=i.root,r=e,s=Math.floor(t.width),a=Math.floor(t.height);r[rm.TIME_OFFSET]=n.cumulativeTime,r[rm.TIME_OFFSET+1]=n.frameTime,r[rm.TIME_OFFSET+2]=i.getTotalFrames(),r[rm.SCREEN_SIZE_OFFSET]=s,r[rm.SCREEN_SIZE_OFFSET+1]=a,r[rm.SCREEN_SIZE_OFFSET+2]=1/s,r[rm.SCREEN_SIZE_OFFSET+3]=1/a,r[rm.NATIVE_SIZE_OFFSET]=s,r[rm.NATIVE_SIZE_OFFSET+1]=a,r[rm.NATIVE_SIZE_OFFSET+2]=1/r[rm.NATIVE_SIZE_OFFSET],r[rm.NATIVE_SIZE_OFFSET+3]=1/r[rm.NATIVE_SIZE_OFFSET+1];var o=n.debugView;if(o){r[rm.DEBUG_VIEW_MODE_OFFSET]=o.singleMode,r[rm.DEBUG_VIEW_MODE_OFFSET+1]=o.lightingWithAlbedo?1:0,r[rm.DEBUG_VIEW_MODE_OFFSET+2]=o.csmLayerColoration?1:0;for(var u=0;u<12;u++)r[rm.DEBUG_VIEW_COMPOSITE_PACK_1_OFFSET+u]=o.isCompositeModeEnabled(u)?1:0}else{r[rm.DEBUG_VIEW_MODE_OFFSET]=0,r[rm.DEBUG_VIEW_MODE_OFFSET+1]=1,r[rm.DEBUG_VIEW_MODE_OFFSET+2]=0;for(var h=0;h<12;h++)r[rm.DEBUG_VIEW_COMPOSITE_PACK_1_OFFSET+h]=1}},t.updateCameraUBOView=function(t,e,i){var n,r=(i.scene?i.scene:v.director.getScene().renderScene).mainLight,s=t.pipelineSceneData,a=s.ambient,o=s.skybox,u=s.fog,h=s.shadows,c=e,l=i.exposure,_=s.isHDR;if(c[sm.SCREEN_SCALE_OFFSET]=s.shadingScale,c[sm.SCREEN_SCALE_OFFSET+1]=s.shadingScale,c[sm.SCREEN_SCALE_OFFSET+2]=1/c[sm.SCREEN_SCALE_OFFSET],c[sm.SCREEN_SCALE_OFFSET+3]=1/c[sm.SCREEN_SCALE_OFFSET+1],c[sm.EXPOSURE_OFFSET]=l,c[sm.EXPOSURE_OFFSET+1]=1/l,c[sm.EXPOSURE_OFFSET+2]=_?1:0,c[sm.EXPOSURE_OFFSET+3]=1/av.standardExposureValue,r){var d=r.shadowEnabled&&h.type===KE.ShadowMap?1:0,f=r.direction;if(XI.set(f.x,f.y,f.z,d),ta.toArray(c,XI,sm.MAIN_LIT_DIR_OFFSET),js.toArray(c,r.color,sm.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var p=r.colorTemperatureRGB;c[sm.MAIN_LIT_COLOR_OFFSET]*=p.x,c[sm.MAIN_LIT_COLOR_OFFSET+1]*=p.y,c[sm.MAIN_LIT_COLOR_OFFSET+2]*=p.z}c[sm.MAIN_LIT_COLOR_OFFSET+3]=_?r.illuminance*l:r.illuminance}else XI.set(0,0,1,0),ta.toArray(c,XI,sm.MAIN_LIT_DIR_OFFSET),ta.toArray(c,ta.ZERO,sm.MAIN_LIT_COLOR_OFFSET);var m=a.skyColor;m.w=_?a.skyIllum*l:a.skyIllum,c[sm.AMBIENT_SKY_OFFSET+0]=m.x,c[sm.AMBIENT_SKY_OFFSET+1]=m.y,c[sm.AMBIENT_SKY_OFFSET+2]=m.z,c[sm.AMBIENT_SKY_OFFSET+3]=m.w,c[sm.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,c[sm.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,c[sm.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,c[sm.AMBIENT_GROUND_OFFSET+3]=o.envmap?null===(n=o.envmap)||void 0===n?void 0:n.mipmapLevel:1,da.toArray(c,i.matView,sm.MAT_VIEW_OFFSET),da.toArray(c,i.node.worldMatrix,sm.MAT_VIEW_INV_OFFSET),js.toArray(c,i.position,sm.CAMERA_POS_OFFSET),da.toArray(c,i.matProj,sm.MAT_PROJ_OFFSET),da.toArray(c,i.matProjInv,sm.MAT_PROJ_INV_OFFSET),da.toArray(c,i.matViewProj,sm.MAT_VIEW_PROJ_OFFSET),da.toArray(c,i.matViewProjInv,sm.MAT_VIEW_PROJ_INV_OFFSET),c[sm.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),c[sm.SURFACE_TRANSFORM_OFFSET]=i.surfaceTransform,c[sm.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(bs(s.skybox.getRotationAngle())),c[sm.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(bs(s.skybox.getRotationAngle()));var g=u.colorArray;c[sm.GLOBAL_FOG_COLOR_OFFSET]=g.x,c[sm.GLOBAL_FOG_COLOR_OFFSET+1]=g.y,c[sm.GLOBAL_FOG_COLOR_OFFSET+2]=g.z,c[sm.GLOBAL_FOG_COLOR_OFFSET+3]=g.z,c[sm.GLOBAL_FOG_BASE_OFFSET]=u.fogStart,c[sm.GLOBAL_FOG_BASE_OFFSET+1]=u.fogEnd,c[sm.GLOBAL_FOG_BASE_OFFSET+2]=u.fogDensity,c[sm.GLOBAL_FOG_ADD_OFFSET]=u.fogTop,c[sm.GLOBAL_FOG_ADD_OFFSET+1]=u.fogRange,c[sm.GLOBAL_FOG_ADD_OFFSET+2]=u.fogAtten,c[sm.NEAR_FAR_OFFSET]=i.nearClip,c[sm.NEAR_FAR_OFFSET+1]=i.farClip,c[sm.VIEW_PORT_OFFSET]=s.shadingScale*i.window.width*i.viewport.x,c[sm.VIEW_PORT_OFFSET+1]=s.shadingScale*i.window.height*i.viewport.y,c[sm.VIEW_PORT_OFFSET+2]=s.shadingScale*i.window.width*i.viewport.z,c[sm.VIEW_PORT_OFFSET+3]=s.shadingScale*i.window.height*i.viewport.w},t.getPCFRadius=function(t,e){var i=t.size.x;switch(e.shadowPcf){case qE.HARD:return 0;case qE.SOFT:return 1/(.5*i);case qE.SOFT_2X:return 2/(.5*i);case qE.SOFT_4X:return 3/(.5*i)}return 0},t.updatePlanarNormalAndDistance=function(t,e){js.normalize(jI,t.normal),e[am.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=jI.x,e[am.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=jI.y,e[am.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=jI.z,e[am.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-t.distance},t.updateShadowUBOView=function(e,i,n,r){var s=e.device,a=r.scene.mainLight,o=e.pipelineSceneData,u=o.shadows,h=o.csmLayers,c=i,l=n,_=o.csmSupported,d=mg(s)?0:1;if(a&&u.enabled){if(u.type===KE.ShadowMap){if(a.shadowEnabled){if(a.shadowFixedArea||a.csmLevel===QE.LEVEL_1||!_){var f=h.specialLayer.matShadowView,p=h.specialLayer.matShadowProj,m=h.specialLayer.matShadowViewProj,g=a.shadowNear,v=a.shadowFar;da.toArray(c,f,am.MAT_LIGHT_VIEW_OFFSET),c[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,c[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,c[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,c[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,c[am.SHADOW_PROJ_INFO_OFFSET+0]=p.m00,c[am.SHADOW_PROJ_INFO_OFFSET+1]=p.m05,c[am.SHADOW_PROJ_INFO_OFFSET+2]=1/p.m00,c[am.SHADOW_PROJ_INFO_OFFSET+3]=1/p.m05,da.toArray(c,m,am.MAT_LIGHT_VIEW_PROJ_OFFSET),WI.set(g,v,0,1-a.shadowSaturation),ta.toArray(c,WI,am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),WI.set(0,d,a.shadowNormalBias,0),ta.toArray(c,WI,am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var y=this.getPCFRadius(u,a),T=0;T<a.csmLevel;T++){var E=h.layers[T].matShadowView;WI.set(E.m00,E.m04,E.m08,y),ta.toArray(l,WI,om.CSM_VIEW_DIR_0_OFFSET+4*T),WI.set(E.m01,E.m05,E.m09,0),ta.toArray(l,WI,om.CSM_VIEW_DIR_1_OFFSET+4*T),WI.set(E.m02,E.m06,E.m10,0),ta.toArray(l,WI,om.CSM_VIEW_DIR_2_OFFSET+4*T);var S=h.layers[T].csmAtlas;ta.toArray(l,S,om.CSM_ATLAS_OFFSET+4*T),l[om.CSM_SPLITS_INFO_OFFSET+T]=h.layers[T].splitCameraFar/a.shadowDistance;var A=h.layers[T].matShadowViewProj;da.toArray(l,A,om.MAT_CSM_VIEW_PROJ_OFFSET+16*T);var R=h.layers[T].matShadowProj;l[om.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*T]=R.m10,l[om.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*T]=R.m14,l[om.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*T]=R.m11,l[om.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*T]=R.m15,l[om.CSM_PROJ_INFO_OFFSET+0+4*T]=R.m00,l[om.CSM_PROJ_INFO_OFFSET+1+4*T]=R.m05,l[om.CSM_PROJ_INFO_OFFSET+2+4*T]=1/R.m00,l[om.CSM_PROJ_INFO_OFFSET+3+4*T]=1/R.m05}WI.set(0,0,0,1-a.shadowSaturation),ta.toArray(c,WI,am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),WI.set(0,d,a.shadowNormalBias,a.csmLevel),ta.toArray(c,WI,am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}WI.set(u.size.x,u.size.y,a.shadowPcf,a.shadowBias),ta.toArray(c,WI,am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else t.updatePlanarNormalAndDistance(u,c);Aa.toArray(c,u.shadowColor,am.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,i,n){var r=t.device,s=t.pipelineSceneData,a=s.shadows,o=s.csmLayers,u=e,h=mg(r)?0:1,c=t.device.capabilities,l=s.csmSupported;switch(i.type){case lO.DIRECTIONAL:var _=i;if(a.enabled&&_&&_.shadowEnabled&&a.type===KE.ShadowMap){var d,f,p,m=.1,g=0,v=0;if(_.shadowFixedArea||_.csmLevel===QE.LEVEL_1||!l)d=o.specialLayer.matShadowView,f=o.specialLayer.matShadowProj,p=o.specialLayer.matShadowViewProj,_.shadowFixedArea?(m=_.shadowNear,g=_.shadowFar,v=0):(m=.1,g=o.specialLayer.shadowCameraFar,v=1),WI.set(0,h,_.shadowNormalBias,0),ta.toArray(u,WI,am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var y=o.layers[n];d=y.matShadowView,f=y.matShadowProj,p=y.matShadowViewProj,m=y.splitCameraNear,g=y.splitCameraFar,v=_.csmLevel}da.toArray(u,d,am.MAT_LIGHT_VIEW_OFFSET),u[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,u[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,u[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,u[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,u[am.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,u[am.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,u[am.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,u[am.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,da.toArray(u,p,am.MAT_LIGHT_VIEW_PROJ_OFFSET),WI.set(m,g,0,1-_.shadowSaturation),ta.toArray(u,WI,am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),WI.set(0,h,_.shadowNormalBias,v),ta.toArray(u,WI,am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),WI.set(a.size.x,a.size.y,_.shadowPcf,_.shadowBias),ta.toArray(u,WI,am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case lO.SPOT:var T=i;a.enabled&&T&&T.shadowEnabled&&(da.invert(zI,i.node.getWorldMatrix()),da.toArray(u,zI,am.MAT_LIGHT_VIEW_OFFSET),da.perspective(HI,i.angle,1,.001,i.range,!0,c.clipSpaceMinZ,c.clipSpaceSignY,0),da.multiply(VI,HI,zI),da.toArray(u,VI,am.MAT_LIGHT_VIEW_PROJ_OFFSET),WI.set(.01,i.range,0,0),ta.toArray(u,WI,am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),WI.set(a.size.x,a.size.y,T.shadowPcf,T.shadowBias),ta.toArray(u,WI,am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),WI.set(1,h,T.shadowNormalBias,0),ta.toArray(u,WI,am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}Aa.toArray(u,a.shadowColor,am.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var i=this._pipeline.descriptorSet;this._initCombineSignY();var n=t.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,rm.SIZE,rm.SIZE));i.bindBuffer(rm.BINDING,n);var r=t.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,sm.SIZE,sm.SIZE));i.bindBuffer(sm.BINDING,r);var s=t.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,am.SIZE,am.SIZE));i.bindBuffer(am.BINDING,s);var a=t.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,om.SIZE,om.SIZE));i.bindBuffer(om.BINDING,a)},e.updateGlobalUBO=function(e){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;n.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(n.getBuffer(rm.BINDING),this._globalUBO),i.bindBuffer(rm.BINDING,n.getBuffer(rm.BINDING)),i.update()},e.updateCameraUBO=function(e){var i=this._pipeline.globalDSManager,n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(n.getBuffer(sm.BINDING),this._cameraUBO),i.bindBuffer(sm.BINDING,n.getBuffer(sm.BINDING)),i.update()},e.updateShadowUBO=function(e){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var n=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,s=i.shadowFrameBufferMap,a=e.scene.mainLight;a&&s.has(a)&&n.bindTexture(um,s.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,e),n.update(),r[0].updateBuffer(n.getBuffer(am.BINDING),this._shadowUBO),r[0].updateBuffer(n.getBuffer(om.BINDING),this._csmUBO)}},e.updateShadowUBOLight=function(e,i,n){void 0===n&&(n=0),t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i,n),e.bindTexture(um,IT.get("default-texture").getGFXTexture()),e.bindTexture(gm,IT.get("default-texture").getGFXTexture()),e.update(),this._pipeline.commandBuffers[0].updateBuffer(e.getBuffer(am.BINDING),this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof da?da.toArray(this._shadowUBO,e,t):e instanceof Aa&&Aa.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();YI._combineSignY=0;var KI,qI,QI,ZI,JI,$I,tC,eC,iC=t("RenderStage",ao("RenderStage")((BI=function(){function t(){this._name=PI&&PI(),this._priority=DI&&DI(),this._enabled=!0,this._tag=FI&&FI()}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},s(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),PI=Za(BI.prototype,"_name",[mo],(function(){return""})),DI=Za(BI.prototype,"_priority",[mo],(function(){return 0})),FI=Za(BI.prototype,"_tag",[mo],(function(){return 0})),NI=BI))||NI);v.RenderStage=iC;var nC,rC=t("RenderFlow",(KI=ao("RenderFlow"),qI=xo([iC]),KI((ZI=function(){function t(){this._name=JI&&JI(),this._priority=$I&&$I(),this._tag=tC&&tC(),this._stages=eC&&eC()}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,i=this._stages.length;e<i;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,i=this._stages.length;e<i;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},s(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),JI=Za(ZI.prototype,"_name",[mo],(function(){return""})),$I=Za(ZI.prototype,"_priority",[mo],(function(){return 0})),tC=Za(ZI.prototype,"_tag",[mo],(function(){return 0})),eC=Za(ZI.prototype,"_stages",[qI,mo],(function(){return[]})),QI=ZI))||QI));v.RenderFlow=rC,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(nC||(nC=t("PipelineEventType",{})));var sC,aC,oC,uC,hC,cC=t("PipelineEventProcessor",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}o(e,t);var i=e.prototype;return i.on=function(t,e,i,n){return this.eventTargetOn(t,e,i,n)},i.once=function(t,e,i){return this.eventTargetOnce(t,e,i)},e}(es)),lC=(t("PrefabLink",(sC=ao("cc.PrefabLink"),aC=xo(Ab),sC((uC=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).prefab=hC&&hC(),e}return o(e,t),e}(el),hC=Za(uC.prototype,"prefab",[aC,mo],(function(){return null})),oC=uC))||oC)),new js);function _C(t,e,i,n){n||(n=new js),t.convertToUINode(e,i,n);var r=i.position;return n.add(r),n}function dC(t,e,i){return i||(i=new js),t.worldToScreen(e,i),i.x/=v.view.getScaleX(),i.y/=v.view.getScaleY(),i}var fC,pC,mC,gC,vC,yC,TC=t("convertUtils",{WorldNode3DToLocalNodeUI:_C,WorldNode3DToWorldNodeUI:dC});v.pipelineUtils=TC,Jd(v.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=e[0],r=e[3]||lC;return n.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]);var EC,SC,AC,RC,wC,bC,OC,MC,IC,CC,xC,NC,BC,PC,DC,FC,LC,UC,GC,kC,zC,HC,VC,WC,XC,jC,YC,KC,qC,QC,ZC,JC,$C,tx,ex,ix,nx,rx,sx,ax,ox,ux,hx,cx,lx,_x,dx,fx,px,mx,gx,vx,yx,Tx,Ex,Sx,Ax,Rx,wx,bx,Ox,Mx,Ix,Cx,xx,Nx,Bx,Px,Dx,Fx,Lx,Ux,Gx,kx,zx,Hx,Vx,Wx,Xx,jx,Yx,Kx,qx,Qx,Zx=new Kt,Jx=new ee,$x=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},tN=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},eN=t("RenderPipeline",(fC=ao("cc.RenderPipeline"),pC=xo([rC]),fC((gC=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._tag=vC&&vC(),e._flows=yC&&yC(),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new cC,e._commandBuffers=[],e._pipelineUBO=new YI,e._macros={},e._constantMacros="",e._profiler=null,e._geometryRenderer=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new Kt,e._clusterEnabled=!1,e._bloomEnabled=!1,e}o(e,t);var i=e.prototype;return i.getPipelineRenderData=function(){return this._pipelineRenderData},i.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},i.createRenderPass=function(t,e,i){var n=this._device,r=new be,s=new Oe;r.format=e,s.format=i,s.stencilStoreOp=At.DISCARD,s.depthStoreOp=At.DISCARD,t&Lt.COLOR||(t&rv?r.loadOp=St.CLEAR:(r.loadOp=St.LOAD,r.barrier=n.getGeneralBarrier(new xe(Rt.COLOR_ATTACHMENT_WRITE,Rt.COLOR_ATTACHMENT_WRITE)))),(t&Lt.DEPTH_STENCIL)!==Lt.DEPTH_STENCIL&&(t&Lt.DEPTH||(s.depthLoadOp=St.LOAD),t&Lt.STENCIL||(s.stencilLoadOp=St.LOAD)),s.barrier=n.getGeneralBarrier(new xe(Rt.DEPTH_STENCIL_ATTACHMENT_WRITE,Rt.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new Ce([r],s);return n.createRenderPass(a)},i.getRenderPass=function(t,e){var i=function(t){for(var e,i=666,n=p(t.colorTextures);!(e=n()).done;){var r=e.value,s=null==r?void 0:r.info;i=pi(s.type+"_"+s.usage+"_"+s.format+"_"+s.width+"_"+s.height+"_"+s.flags+"_\n            "+s.layerCount+"_"+s.levelCount+"_"+s.samples+"_"+s.depth+"_"+s.externalRes,i)}if(t.depthStencilTexture){var a=t.depthStencilTexture.info;i=pi(a.type+"_"+a.usage+"_"+a.format+"_"+a.width+"_"+a.height+"_"+a.flags+"_\n            "+a.layerCount+"_"+a.levelCount+"_"+a.samples+"_"+a.depth+"_"+a.externalRes,i)}return i}(e),n=pi(i+"_"+t,666),r=this._renderPasses.get(n);return r||(r=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(n,r),r)},i.newFramebufferByRatio=function(t){for(var e=this.pipelineSceneData,i=this._width*e.shadingScale,n=this._height*e.shadingScale,r=t.colorTextures,s=0;s<r.length;s++)r[s].resize(i,n);t.depthStencilTexture&&t.depthStencilTexture.resize(i,n);var a=this._device.createFramebuffer(new Pe(t.renderPass,r,t.depthStencilTexture));return t.destroy(),a},i.generateRenderArea=function(t,e){var i=t.viewport,n=t.window.width,r=t.window.height;e.x=i.x*n,e.y=i.y*r,e.width=i.width*n,e.height=i.height*r},i.generateViewport=function(t,e){this.generateRenderArea(t,Zx),e||(e=Jx);var i=this.pipelineSceneData.shadingScale;return e.left=Zx.x*i,e.top=Zx.y*i,e.width=Zx.width*i,e.height=Zx.height*i,e},i.generateScissor=function(t,e){e||(e=Zx),this.generateRenderArea(t,e);var i=this.pipelineSceneData.shadingScale;return e.x*=i,e.y*=i,e.width*=i,e.height*=i,e},i.getMacroString=function(t){var e=this._macros[t];return void 0===e?"":e},i.getMacroInt=function(t){var e=this._macros[t];return void 0===e?0:e},i.getMacroBool=function(t){var e=this._macros[t];return void 0!==e&&e},i.setMacroString=function(t,e){this._macros[t]=e},i.setMacroInt=function(t,e){this._macros[t]=e},i.setMacroBool=function(t,e){this._macros[t]=e},i.activate=function(){this._device=Wa.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new GI(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},i._ensureEnoughSize=function(){},i.render=function(t){if(0!==t.length){this.updateGeometryRenderer(t),this._commandBuffers[0].begin(),this.emit(nC.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var i=t[e];if(i.window.swapchain)return void(QT=i)}QT=null}(t);for(var e=0;e<t.length;e++){var i=t[e];if(i.scene){this.emit(nC.RENDER_CAMERA_BEGIN,i),CI(this,i),xI(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i);this.emit(nC.RENDER_CAMERA_END,i)}}this.emit(nC.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},i._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},i._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var i=0;i<e.downsampleTexs.length;++i)e.downsampleTexs[i].destroy(),e.downsampleFramebuffers[i].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var n=0;n<e.upsampleTexs.length;++n)e.upsampleTexs[n].destroy(),e.upsampleFramebuffers[n].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},i._genQuadVertexData=function(t,e){var i=new Float32Array(16),n=e.x/this._width,r=(e.x+e.width)/this._width,s=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=a;a=s,s=o}var u=0;switch(t){case $.IDENTITY:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=s;break;case $.ROTATE_90:u=0,i[u++]=-1,i[u++]=-1,i[u++]=r,i[u++]=a,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=n,i[u++]=s;break;case $.ROTATE_180:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=r,i[u++]=s,i[u++]=-1,i[u++]=1,i[u++]=n,i[u++]=a,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a;break;case $.ROTATE_270:u=0,i[u++]=-1,i[u++]=-1,i[u++]=n,i[u++]=s,i[u++]=1,i[u++]=-1,i[u++]=n,i[u++]=a,i[u++]=-1,i[u++]=1,i[u++]=r,i[u++]=s,i[u++]=1,i[u++]=1,i[u++]=r,i[u++]=a}return i},i._createQuadInputAssembler=function(){var t=new tN,e=4*Float32Array.BYTES_PER_ELEMENT,i=4*e,n=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE|ot.HOST,i,e));if(!n)return t;var r=Uint8Array.BYTES_PER_ELEMENT,s=6*r,a=this._device.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,s,r));if(!a)return t;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,a.update(o);var u=new Array(2);u[0]=new Ae("a_position",et.RG32F),u[1]=new Ae("a_texCoord",et.RG32F);var h=this._device.createInputAssembler(new we(u,[n],a));return t.quadIB=a,t.quadVB=n,t.quadIA=h,t},i.updateQuadVertexData=function(t,e){var i=this._lastUsedRenderArea;if(i.x!==t.x||i.y!==t.y||i.width!==t.width||i.height!==t.height){var n=this._genQuadVertexData($.IDENTITY,t);this._quadVBOffscreen.update(n);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||$.IDENTITY,t);this._quadVBOnscreen.update(r),i.copy(t)}},i.destroy=function(){for(var e,i,n=0;n<this._flows.length;n++)this._flows[n].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),t.prototype.destroy.call(this)},i.onGlobalPipelineStateChanged=function(){},i._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(et.RGBA32F)&(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(tt.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(hs.os===ss.ANDROID&&hs.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(Xn.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",t+="#define CC_JOINT_UNIFORM_CAPACITY "+Im.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=t},i.updateGeometryRenderer=function(t){if(!this._geometryRenderer)for(var e=0;e<t.length;e++){var i=t[e];if(i&&i.window&&i.window.swapchain)return i.initGeometryRenderer(),void(this._geometryRenderer=i.geometryRenderer)}},i.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new $x,e=this.device,i=new be;i.format=et.RGBA8,i.loadOp=St.CLEAR,i.storeOp=At.STORE,i.barrier=e.getGeneralBarrier(new xe(Rt.NONE,Rt.COLOR_ATTACHMENT_WRITE)),t.renderPass=e.createRenderPass(new Ce([i]));var n=this._width,r=this._height;t.prefiterTex=e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA8,n>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new Pe(t.renderPass,[t.prefiterTex])),n>>=1,r>>=1;for(var s=0;s<6;++s)t.downsampleTexs.push(e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA8,n>>1,r>>1))),t.downsampleFramebuffers[s]=e.createFramebuffer(new Pe(t.renderPass,[t.downsampleTexs[s]])),t.upsampleTexs.push(e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA8,n,r))),t.upsampleFramebuffers[s]=e.createFramebuffer(new Pe(t.renderPass,[t.upsampleTexs[s]])),n>>=1,r>>=1;t.combineTex=e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new Pe(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},i.on=function(t,e,i,n){return this._eventProcessor.on(t,e,i,n)},i.once=function(t,e,i){return this._eventProcessor.once(t,e,i)},i.off=function(t,e,i){this._eventProcessor.off(t,e,i)},i.emit=function(t,e,i,n,r,s){this._eventProcessor.emit(t,e,i,n,r,s)},i.targetOff=function(t){this._eventProcessor.targetOff(t)},i.removeAll=function(t){this._eventProcessor.removeAll(t)},i.hasEventListener=function(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)},s(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(t){this._pipelineSceneData.shadingScale!==t&&(this._pipelineSceneData.shadingScale=t,this.emit(nC.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(Tu),vC=Za(gC.prototype,"_tag",[mo],(function(){return 0})),yC=Za(gC.prototype,"_flows",[pC,mo],(function(){return[]})),mC=gC))||mC));v.RenderPipeline=eN,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(EC||(EC={})),function(t){t[t.FORWARD=10]="FORWARD"}(SC||(SC={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(AC||(AC={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(RC||(RC={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(wC||(wC={})),kn(ut),kn(ht),kn(At),kn(St),kn(Rt),kn(et),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(Qx||(Qx={})),kn(Qx),bC=ao("RenderTextureDesc"),OC=xo(ut),MC=xo(ht),IC=xo(et),bC((CC=function(){this.name=xC&&xC(),this.type=NC&&NC(),this.usage=BC&&BC(),this.format=PC&&PC(),this.width=DC&&DC(),this.height=FC&&FC()},xC=Za(CC.prototype,"name",[mo],(function(){return""})),NC=Za(CC.prototype,"type",[OC],(function(){return ut.TEX2D})),BC=Za(CC.prototype,"usage",[MC],(function(){return ht.COLOR_ATTACHMENT})),PC=Za(CC.prototype,"format",[IC],(function(){return et.UNKNOWN})),DC=Za(CC.prototype,"width",[mo],(function(){return-1})),FC=Za(CC.prototype,"height",[mo],(function(){return-1})),CC));var iN,nN=(LC=ao("RenderTextureConfig"),UC=xo(Pf),LC((kC=function(){this.name=zC&&zC(),this.texture=HC&&HC()},zC=Za(kC.prototype,"name",[mo],(function(){return""})),HC=Za(kC.prototype,"texture",[UC],(function(){return null})),GC=kC))||GC),rN=(VC=ao("MaterialConfig"),WC=xo($T),VC((XC=function(){this.name=jC&&jC(),this.material=YC&&YC()},jC=Za(XC.prototype,"name",[mo],(function(){return""})),YC=Za(XC.prototype,"material",[WC],(function(){return null})),XC)),KC=ao("FrameBufferDesc"),qC=xo([mr]),QC=xo(Pf),KC((ZC=function(){this.name=JC&&JC(),this.renderPass=$C&&$C(),this.colorTextures=tx&&tx(),this.depthStencilTexture=ex&&ex(),this.texture=ix&&ix()},JC=Za(ZC.prototype,"name",[mo],(function(){return""})),$C=Za(ZC.prototype,"renderPass",[mo],(function(){return 0})),tx=Za(ZC.prototype,"colorTextures",[qC],(function(){return[]})),ex=Za(ZC.prototype,"depthStencilTexture",[mo],(function(){return""})),ix=Za(ZC.prototype,"texture",[QC],(function(){return null})),ZC)),nx=ao("ColorDesc"),rx=xo(et),sx=xo(St),ax=xo(At),ox=xo([Rt]),ux=xo([Rt]),nx((cx=function(){this.format=lx&&lx(),this.loadOp=_x&&_x(),this.storeOp=dx&&dx(),this.sampleCount=fx&&fx(),this.beginAccesses=px&&px(),this.endAccesses=mx&&mx()},lx=Za(cx.prototype,"format",[rx],(function(){return et.UNKNOWN})),_x=Za(cx.prototype,"loadOp",[sx],(function(){return St.CLEAR})),dx=Za(cx.prototype,"storeOp",[ax],(function(){return At.STORE})),fx=Za(cx.prototype,"sampleCount",[mo],(function(){return 1})),px=Za(cx.prototype,"beginAccesses",[ox],(function(){return Rt.NONE})),mx=Za(cx.prototype,"endAccesses",[ux],(function(){return Rt.COLOR_ATTACHMENT_WRITE})),hx=cx))||hx),sN=(gx=ao("DepthStencilDesc"),vx=xo(et),yx=xo(St),Tx=xo(At),Ex=xo(St),Sx=xo(At),Ax=xo(Rt),Rx=xo(Rt),gx((bx=function(){this.format=Ox&&Ox(),this.depthLoadOp=Mx&&Mx(),this.depthStoreOp=Ix&&Ix(),this.stencilLoadOp=Cx&&Cx(),this.stencilStoreOp=xx&&xx(),this.sampleCount=Nx&&Nx(),this.beginAccesses=Bx&&Bx(),this.endAccesses=Px&&Px()},Ox=Za(bx.prototype,"format",[vx],(function(){return et.UNKNOWN})),Mx=Za(bx.prototype,"depthLoadOp",[yx],(function(){return St.CLEAR})),Ix=Za(bx.prototype,"depthStoreOp",[Tx],(function(){return At.STORE})),Cx=Za(bx.prototype,"stencilLoadOp",[Ex],(function(){return St.CLEAR})),xx=Za(bx.prototype,"stencilStoreOp",[Sx],(function(){return At.STORE})),Nx=Za(bx.prototype,"sampleCount",[mo],(function(){return 1})),Bx=Za(bx.prototype,"beginAccesses",[Ax],(function(){return Rt.NONE})),Px=Za(bx.prototype,"endAccesses",[Rx],(function(){return Rt.DEPTH_STENCIL_ATTACHMENT_WRITE})),wx=bx))||wx);Dx=ao("RenderPassDesc"),Fx=xo([rN]),Lx=xo(sN),Dx((Ux=function(){this.index=Gx&&Gx(),this.colorAttachments=kx&&kx(),this.depthStencilAttachment=zx&&zx()},Gx=Za(Ux.prototype,"index",[mo],(function(){return-1})),kx=Za(Ux.prototype,"colorAttachments",[Fx],(function(){return[]})),zx=Za(Ux.prototype,"depthStencilAttachment",[Lx],(function(){return new sN})),Ux)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(iN||(iN={})),kn(iN);var aN=(Hx=ao("RenderQueueDesc"),Vx=xo(iN),Wx=xo([mr]),Hx((jx=function(){this.isTransparent=Yx&&Yx(),this.sortMode=Kx&&Kx(),this.stages=qx&&qx()},Yx=Za(jx.prototype,"isTransparent",[mo],(function(){return!1})),Kx=Za(jx.prototype,"sortMode",[Vx],(function(){return iN.FRONT_TO_BACK})),qx=Za(jx.prototype,"stages",[Wx],(function(){return[]})),Xx=jx))||Xx);function oN(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function uN(t,e){return t.priority-e.priority||t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var hN=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Vi((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Wi(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,i){var n=t.model.subModels[e],r=n.passes[i],s=n.shaders[i];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|n.priority<<8|i,o=this._passPool.add();return o.priority=t.model.priority,o.hash=a,o.depth=t.depth||0,o.shaderId=s.typedID,o.subModel=n,o.passIdx=i,this.queue.push(o),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,u=s.passes[a],h=s.shaders[a],c=LT.getOrCreatePipelineState(t,u,h,e,o);i.bindPipelineState(c),i.bindDescriptorSet($p.MATERIAL,u.descriptorSet),i.bindDescriptorSet($p.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},t}();function cN(t){for(var e=0,i=0;i<t.stages.length;i++)e|=CT(t.stages[i]);var n=oN;switch(t.sortMode){case iN.BACK_TO_FRONT:n=uN;break;case iN.FRONT_TO_BACK:n=oN}return new hN({isTransparent:t.isTransparent,phases:e,sortFunc:n})}function lN(t){t.clear()}function _N(t){t.sort()}var dN=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),i=e.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}i=e.next()}},e.recordCommandBuffer=function(t,e,i,n,r){void 0===n&&(n=null);for(var s=this.queue.values(),a=s.next();!a.done;){for(var o=!1,u=0;u<a.value.batches.length;++u){var h=a.value.batches[u];if(h.mergeCount){if(!o){var c=h.shader,l=LT.getOrCreatePipelineState(t,h.pass,c,e,h.ia);i.bindPipelineState(l),i.bindDescriptorSet($p.MATERIAL,h.pass.descriptorSet),o=!0}n&&i.bindDescriptorSet($p.GLOBAL,n),r?i.bindDescriptorSet($p.LOCAL,h.descriptorSet,r):i.bindDescriptorSet($p.LOCAL,h.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(h.ia),i.draw(h.ia)}}a=s.next()}},t}(),fN=function(){function t(){this.queue=new Set,this._renderQueue=[]}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._renderQueue=[],this.queue.clear()},e.sort=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.pass.blendState.targets[0].blend||this._renderQueue.push(e.value),e=t.next();for(e=(t=this.queue.values()).next();!e.done;)e.value.pass.blendState.targets[0].blend&&this._renderQueue.push(e.value),e=t.next()},e.uploadBuffers=function(t){for(var e=this.queue.values(),i=e.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(t),i=e.next()},e.recordCommandBuffer=function(t,e,i,n,r){void 0===n&&(n=null);for(var s=0===this._renderQueue.length?this.queue.values():this._renderQueue.values(),a=s.next();!a.done;){var o=a.value,u=o.instances,h=o.pass;if(o.hasPendingModels){i.bindDescriptorSet($p.MATERIAL,h.descriptorSet);for(var c=null,l=0;l<u.length;++l){var _=u[l];if(_.count){var d=_.shader,f=LT.getOrCreatePipelineState(t,h,d,e,_.ia);c!==f&&(i.bindPipelineState(f),c=f),n&&i.bindDescriptorSet($p.GLOBAL,n),r?i.bindDescriptorSet($p.LOCAL,_.descriptorSet,r):i.bindDescriptorSet($p.LOCAL,_.descriptorSet,a.value.dynamicOffsets),i.bindInputAssembler(_.ia),i.draw(_.ia)}}}a=s.next()}},t}(),pN=new Hi((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),mN=new Float32Array(4),gN=[],vN=[],yN=new da,TN=new da;function EN(t,e){return!(!e.worldBounds||jh.aabbWithAABB(e.worldBounds,t.aabb))}function SN(t,e){return!(!e.worldBounds||jh.aabbWithAABB(e.worldBounds,t.aabb)&&jh.aabbFrustum(e.worldBounds,t.frustum))}var AN=CT("forward-add"),RN=[];function wN(t,e){e.length=0;for(var i=!1,n=0;n<t.length;n++){for(var r=t[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===AN){s=a,i=!0;break}e.push(s)}return i}var bN,ON,MN,IN,CN,xN,NN,BN,PN,DN,FN=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._instancedLightPassPool=pN.alloc(),this._batchedLightPassPool=pN.alloc(),this._shadowUBO=new Float32Array(am.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new fN,this._batchedQueue=new dN;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Rm.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new oe(this._lightBuffer,0,Rm.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}pN.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0,this._batchedLightPassPool.dynamicOffsets.length=0,this._batchedLightPassPool.lights.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,i=0;i<e.length;i++){var n=e[i],r=t.get(n);r&&(r.getBuffer(am.BINDING).destroy(),r.getTexture(um).destroy(),r.getTexture(gm).destroy(),r.destroy()),t.delete(n)}},e.gatherLightPasses=function(t,e){this.clear();var i=this._pipeline.pipelineSceneData.validPunctualLights;if(i.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var n=this._pipeline.pipelineSceneData.renderObjects,r=0;r<n.length;r++){var s=n[r].model,a=s.subModels;if(wN(a,RN)&&(vN.length=0,this._lightCulling(s,i),vN.length))for(var o=0;o<a.length;o++){var u=RN[o];if(!(u<0)){var h=a[o],c=h.passes[u];h.passes[0].blendState.targets[0].blend||(h.descriptorSet.bindBuffer(Rm.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(c,h,s,u))}}}for(var l=0;l<i.length;l++){var _=i[l];this._instancedLightPassPool.lights.push(_),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*l),this._batchedLightPassPool.lights.push(_),this._batchedLightPassPool.dynamicOffsets.push(this._lightBufferStride*l)}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,i){for(var n=this._pipeline.globalDSManager,r=0;r<this._instancedLightPassPool.lights.length;++r){var s=this._instancedLightPassPool.lights[r];gN[0]=this._instancedLightPassPool.dynamicOffsets[r];var a=n.getOrCreateDescriptorSet(s);this._instancedQueue.recordCommandBuffer(t,e,i,a,gN)}for(var o=0;o<this._batchedLightPassPool.lights.length;++o){var u=this._batchedLightPassPool.lights[o];gN[0]=this._batchedLightPassPool.dynamicOffsets[o];var h=n.getOrCreateDescriptorSet(u);this._batchedQueue.recordCommandBuffer(t,e,i,h,gN)}for(var c=0;c<this._lightPasses.length;c++){var l=this._lightPasses[c],_=l.subModel,d=l.passIdx,f=l.dynamicOffsets,p=l.lights,m=_.passes[d],g=_.shaders[d],v=_.inputAssembler,y=LT.getOrCreatePipelineState(t,m,g,e,v),T=m.descriptorSet,E=_.descriptorSet;i.bindPipelineState(y),i.bindDescriptorSet($p.MATERIAL,T),i.bindInputAssembler(v);for(var S=0;S<f.length;++S){var A=p[S],R=n.getOrCreateDescriptorSet(A);gN[0]=f[S],i.bindDescriptorSet($p.GLOBAL,R),i.bindDescriptorSet($p.LOCAL,E,gN),i.draw(v)}}},e._lightCulling=function(t,e){for(var i=!1,n=!function(t){for(var e=t.subModels,i=0;i<e.length;++i)for(var n=e[i].passes,r=0;r<n.length;++r){var s=n[r].batchingScheme;if(s===OT.INSTANCING)return!0;if(s===OT.VB_MERGING)return!0}return!1}(t),r=0;r<e.length;r++){var s=e[r];switch(s.type){case lO.SPHERE:n&&(i=EN(s,t));break;case lO.SPOT:n&&(i=SN(s,t))}i||vN.push(r)}},e._addRenderQueue=function(t,e,i,n){var r=this._pipeline.pipelineSceneData.validPunctualLights,s=t.batchingScheme;if(s===OT.INSTANCING){var a=t.getInstancedBuffer();a.merge(e,n),a.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueue.queue.add(a)}else if(s===OT.VB_MERGING){var o=t.getBatchedBuffer();o.merge(e,n,i),o.dynamicOffsets[0]=this._lightBufferStride,this._batchedQueue.queue.add(o)}else{var u=pN.alloc();u.subModel=e,u.passIdx=n;for(var h=0;h<vN.length;h++){var c=vN[h],l=r[c];u.lights.push(l),u.dynamicOffsets.push(this._lightBufferStride*c)}this._lightPasses.push(u)}},e._updateLightDescriptorSet=function(t,e){for(var i=this._pipeline.device,n=this._pipeline.pipelineSceneData,r=n.shadows,s=n.shadowFrameBufferMap,a=t.scene.mainLight,o=mg(i)?0:1,u=this._pipeline.globalDSManager,h=n.validPunctualLights,c=this._pipeline.device.capabilities,l=0;l<h.length;l++){var _=h[l],d=u.getOrCreateDescriptorSet(_);if(d){var f=void 0,p=void 0;switch(_.type){case lO.SPHERE:a&&YI.updatePlanarNormalAndDistance(r,this._shadowUBO),this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Aa.toArray(this._shadowUBO,r.shadowColor,am.SHADOW_COLOR_OFFSET);break;case lO.SPOT:var m=_;if(a&&YI.updatePlanarNormalAndDistance(r,this._shadowUBO),da.invert(yN,_.node.getWorldMatrix()),da.perspective(TN,_.angle,1,.001,_.range,!0,c.clipSpaceMinZ,c.clipSpaceSignY,0),f=TN.clone(),p=TN.clone().invert(),da.multiply(TN,TN,yN),da.toArray(this._shadowUBO,yN,am.MAT_LIGHT_VIEW_OFFSET),da.toArray(this._shadowUBO,TN,am.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[am.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=m.shadowPcf,this._shadowUBO[am.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=m.shadowBias,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=o,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=m.shadowNormalBias,this._shadowUBO[am.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[am.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[am.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[am.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[am.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[am.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[am.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[am.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[am.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[am.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,Aa.toArray(this._shadowUBO,r.shadowColor,am.SHADOW_COLOR_OFFSET),s.has(_)){var g,v=null===(g=s.get(_))||void 0===g?void 0:g.colorTextures[0];v&&d.bindTexture(gm,v)}}d.update(),e.updateBuffer(d.getBuffer(am.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var i=t.exposure,n=this._pipeline.pipelineSceneData,r=n.isHDR,s=n.shadows,a=n.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=Gs(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new oe(this._lightBuffer,0,Rm.SIZE)));for(var o=0,u=0;o<a.length;o++,u+=this._lightBufferElementCount){var h=a[o];switch(h.type){case lO.SPHERE:if(js.toArray(mN,h.position),mN[3]=0,this._lightBufferData.set(mN,u+Rm.LIGHT_POS_OFFSET),mN[0]=h.size,mN[1]=h.range,mN[2]=0,mN[3]=0,this._lightBufferData.set(mN,u+Rm.LIGHT_SIZE_RANGE_ANGLE_OFFSET),js.toArray(mN,h.color),h.useColorTemperature){var c=h.colorTemperatureRGB;mN[0]*=c.x,mN[1]*=c.y,mN[2]*=c.z}mN[3]=r?h.luminance*i*this._lightMeterScale:h.luminance,this._lightBufferData.set(mN,u+Rm.LIGHT_COLOR_OFFSET);break;case lO.SPOT:if(js.toArray(mN,h.position),mN[3]=1,this._lightBufferData.set(mN,u+Rm.LIGHT_POS_OFFSET),mN[0]=h.size,mN[1]=h.range,mN[2]=h.spotAngle,mN[3]=s.enabled&&h.shadowEnabled&&s.type===KE.ShadowMap?1:0,this._lightBufferData.set(mN,u+Rm.LIGHT_SIZE_RANGE_ANGLE_OFFSET),js.toArray(mN,h.direction),this._lightBufferData.set(mN,u+Rm.LIGHT_DIR_OFFSET),js.toArray(mN,h.color),h.useColorTemperature){var l=h.colorTemperatureRGB;mN[0]*=l.x,mN[1]*=l.y,mN[2]*=l.z}mN[3]=r?h.luminance*i*this._lightMeterScale:h.luminance,this._lightBufferData.set(mN,u+Rm.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),LN=new sc,UN=function(){function t(t){this._pendingSubModels=[],this._castModels=[],this._instancedQueue=new fN,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var i=this._pipeline.pipelineSceneData.shadows;if(this._instancedQueue.clear(),this._pendingSubModels.length=0,this._castModels.length=0,i.enabled&&i.type===KE.Planar&&!(i.normal.length()<1e-6)){var n=t.scene,r=t.frustum,s=0!=(t.visibility&$f.BitMask.DEFAULT);if(n.mainLight&&s){for(var a=n.models,o=0;o<a.length;o++){var u=a[o];u.enabled&&u.node&&u.castShadow&&this._castModels.push(u)}var h=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(h);for(var c=0;c<this._castModels.length;c++){var l=this._castModels[c];if(!l.worldBounds||(sc.transform(LN,l.worldBounds,i.matLight),jh.aabbFrustum(LN,r)))for(var _=l.subModels,d=0;d<_.length;d++)for(var f=_[d],p=f.passes,m=0;m<p.length;m++)p[m].batchingScheme===OT.INSTANCING?(h.merge(f,m,f.planarShader),this._instancedQueue.queue.add(h)):this._pendingSubModels.push(f)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,i){var n=this._pipeline.pipelineSceneData.shadows;if(n.enabled&&n.type===KE.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,i),this._pendingSubModels.length)){var r=n.material.passes[0],s=r.descriptorSet;i.bindDescriptorSet($p.MATERIAL,s);for(var a=this._pendingSubModels,o=0;o<a.length;o++){var u=a[o],h=u.planarShader,c=u.inputAssembler,l=LT.getOrCreatePipelineState(t,r,h,e,c);i.bindPipelineState(l),i.bindDescriptorSet($p.LOCAL,u.descriptorSet),i.bindInputAssembler(c),i.draw(c)}}},t}(),GN=function(){function t(){this._phaseID=CT("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=t.scene.batches,a=0;a<s.length;a++){var o=s[a],u=!1;if(t.visibility&o.visFlags&&(u=!0),u)for(var h=o.shaders.length,c=0;c<h;c++){var l=o.passes[c];if(l.phase===this._phaseID){var _=o.shaders[c],d=o.inputAssembler,f=LT.getOrCreatePipelineState(n,l,_,e,d);r.bindPipelineState(f),r.bindDescriptorSet($p.MATERIAL,l.descriptorSet);var p=o.descriptorSet;r.bindDescriptorSet($p.LOCAL,p),r.bindInputAssembler(d),r.draw(d)}}}},t}(),kN=[new ie(0,0,0,1)],zN=t("ForwardStage",(bN=ao("ForwardStage"),ON=xo([aN]),bN((NN=xN=function(t){function e(){var e;return(e=t.call(this)||this).renderQueues=CN&&CN(),e._renderQueues=[],e._renderArea=new Kt,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=CT("default"),e._clearFlag=4294967295,e.additiveInstanceQueues=[],e._batchedQueue=new dN,e._instancedQueue=new fN,e._uiPhase=new GN,e}o(e,t);var i=e.prototype;return i.addRenderInstancedQueue=function(t){this.additiveInstanceQueues.includes(t)||this.additiveInstanceQueues.push(t)},i.removeRenderInstancedQueue=function(t){var e=this.additiveInstanceQueues.indexOf(t);e>-1&&this.additiveInstanceQueues.splice(e,1)},i.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=cN(this.renderQueues[n]);this._additiveLightQueue=new FN(this._pipeline),this._planarQueue=new UN(this._pipeline),this._uiPhase.activate(e)},i.destroy=function(){},i.render=function(t){var e;this._instancedQueue.clear(),this._batchedQueue.clear();var i=this._pipeline,n=i.device;this._renderQueues.forEach(lN);for(var r=i.pipelineSceneData.renderObjects,s=0,a=0,o=0,u=0;u<r.length;++u){var h=r[u],c=h.model.subModels;for(s=0;s<c.length;++s){var l=c[s],_=l.passes;for(a=0;a<_.length;++a){var d=_[a];if(d.phase===this._phaseID){var f=d.batchingScheme;if(f===OT.INSTANCING){var p=d.getInstancedBuffer();p.merge(l,a),this._instancedQueue.queue.add(p)}else if(f===OT.VB_MERGING){var m=d.getBatchedBuffer();m.merge(l,a,h.model),this._batchedQueue.queue.add(m)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(h,s,a)}}}}this._instancedQueue.sort(),this._renderQueues.forEach(_N);var g=i.commandBuffers[0];i.pipelineUBO.updateShadowUBO(t);for(var v=0;v<this.additiveInstanceQueues.length;v++)this.additiveInstanceQueues[v].uploadBuffers(g);this._instancedQueue.uploadBuffers(g),this._batchedQueue.uploadBuffers(g),this._additiveLightQueue.gatherLightPasses(t,g),this._planarQueue.gatherShadowPasses(t,g),t.clearFlag&Lt.COLOR&&(kN[0].x=t.clearColor.x,kN[0].y=t.clearColor.y,kN[0].z=t.clearColor.z,kN[0].w=t.clearColor.w),i.generateRenderArea(t,this._renderArea);var y=t.window.framebuffer,T=i.getRenderPass(t.clearFlag&this._clearFlag,y);g.beginRenderPass(T,y,this._renderArea,kN,t.clearDepth,t.clearStencil),g.bindDescriptorSet($p.GLOBAL,i.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,T,g);for(var E=0;E<this.additiveInstanceQueues.length;E++)this.additiveInstanceQueues[E].recordCommandBuffer(n,T,g);this._instancedQueue.recordCommandBuffer(n,T,g),this._batchedQueue.recordCommandBuffer(n,T,g),this._additiveLightQueue.recordCommandBuffer(n,T,g),g.bindDescriptorSet($p.GLOBAL,i.descriptorSet),this._planarQueue.recordCommandBuffer(n,T,g),this._renderQueues[1].recordCommandBuffer(n,T,g),null===(e=t.geometryRenderer)||void 0===e||e.render(T,g,i.pipelineSceneData),this._uiPhase.render(t,T),ZT(n,T,g,i.profiler,t),g.endRenderPass()},e}(iC),xN.initInfo={name:"ForwardStage",priority:SC.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:iN.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:iN.BACK_TO_FRONT,stages:["default","planarShadow"]}]},CN=Za((IN=NN).prototype,"renderQueues",[ON,mo],(function(){return[]})),MN=IN))||MN)),HN=t("ForwardFlow",ao("ForwardFlow")((DN=PN=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new zN;i.initialize(zN.initInfo),this._stages.push(i)}return!0},i.activate=function(e){t.prototype.activate.call(this,e)},i.render=function(e){t.prototype.render.call(this,e)},i.destroy=function(){t.prototype.destroy.call(this)},e}(rC),PN.initInfo={name:Xp,priority:AC.FORWARD,stages:[]},BN=DN))||BN),VN=CT("shadow-caster");function WN(t){for(var e=t.passes,i=0;i<e.length;i++)if(e[i].phase===VN)return i;return-1}var XN,jN,YN,KN,qN,QN,ZN,JN,$N,tB,eB,iB,nB,rB,sB,aB,oB,uB,hB,cB,lB,_B,dB,fB,pB,mB,gB,vB,yB,TB,EB,SB,AB,RB,wB,bB,OB,MB=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new fN,this._batchedQueue=new dN}var e=t.prototype;return e.gatherLightPasses=function(t,e,i,n){void 0===n&&(n=0),this.clear();var r=this._pipeline.pipelineSceneData,s=r.shadows;if(e&&s.enabled&&s.type===KE.ShadowMap){switch(e.type){case lO.DIRECTIONAL:var a=e;if(a.shadowEnabled){var o,u=r.csmLayers;!function(t,e,i){var n=t.scene.mainLight,r=e.csmLayers.layerObjects,s=i.validFrustum,a=i.shadowObjects;a.length=0;for(var o=t.visibility,u=r.length-1;u>=0;u--){var h=r.array[u];if(h){var c=h.model;c.enabled&&c.node&&(o&c.node.layer)===c.node.layer&&null!=a&&c.castShadow&&c.worldBounds&&jh.aabbFrustum(c.worldBounds,s)&&(a.push(h),i.level<n.csmLevel&&n.csmOptimizationMode===ZE.RemoveDuplicates&&jh.aabbFrustumCompletelyInside(c.worldBounds,s)&&r.fastRemove(u))}}}(t,r,o=a.shadowFixedArea?u.specialLayer:u.layers[n]);for(var h=o.shadowObjects,c=0;c<h.length;c++){var l=h[c].model;this.add(l)}}break;case lO.SPOT:var _=e;if(_.shadowEnabled)for(var d=r.csmLayers.castShadowObjects,f=0;f<d.length;f++){var p=d[f].model;p.worldBounds&&!jh.aabbFrustum(p.worldBounds,_.frustum)||this.add(p)}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t){for(var e=t.subModels,i=0;i<e.length;i++){var n=e[i],r=WN(n);if(!(r<0)){var s=n.passes[r];if(s.batchingScheme===OT.INSTANCING){var a=s.getInstancedBuffer();a.merge(n,r),this._instancedQueue.queue.add(a)}else if(s.batchingScheme===OT.VB_MERGING){var o=s.getBatchedBuffer();o.merge(n,r,t),this._batchedQueue.queue.add(o)}else{var u=n.shaders[r];this._subModelsArray.push(n),u&&this._shaderArray.push(u),this._passArray.push(s)}}}},e.recordCommandBuffer=function(t,e,i){this._instancedQueue.recordCommandBuffer(t,e,i),this._batchedQueue.recordCommandBuffer(t,e,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,u=LT.getOrCreatePipelineState(t,a,s,e,o),h=a.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet($p.MATERIAL,h),i.bindDescriptorSet($p.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},t}(),IB=[new ie(1,1,1,1)],CB=t("ShadowStage",ao("ShadowStage")((YN=jN=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._shadowFrameBuffer=null,e._renderArea=new Kt,e._light=null,e._globalDS=null,e._level=0,e}o(e,t);var i=e.prototype;return i.setUsage=function(t,e,i,n){void 0===n&&(n=0),this._globalDS=t,this._light=e,this._shadowFrameBuffer=i,this._level=n},i.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},i.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){IB[0].w=t.clearColor.w;var e=this._pipeline,i=e.pipelineSceneData,n=i.shadingScale,r=i.shadows,s=t.viewport,a=r.size;this._renderArea.x=s.x*a.x,this._renderArea.y=s.y*a.y,this._renderArea.width=s.width*a.x*n,this._renderArea.height=s.height*a.y*n;var o=e.commandBuffers[0],u=this._shadowFrameBuffer.renderPass;o.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,IB,t.clearDepth,t.clearStencil),o.endRenderPass()}},i.render=function(t){var e=this._pipeline,i=e.pipelineSceneData,n=i.shadows,r=this._globalDS,s=e.commandBuffers[0],a=this._level,o=e.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(r,this._light,a),this._additiveShadowQueue.gatherLightPasses(t,this._light,s,a);var u=n.size;switch(this._light.type){case lO.DIRECTIONAL:var h=this._light;if(h.shadowFixedArea||h.csmLevel===QE.LEVEL_1||!i.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y;else{var c=o.capabilities.screenSpaceSignY;this._renderArea.x=a%2*.5*u.x,this._renderArea.y=c>0?.5*(1-Math.floor(a/2))*u.y:.5*Math.floor(a/2)*u.y,this._renderArea.width=.5*u.x,this._renderArea.height=.5*u.y}break;case lO.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=u.x,this._renderArea.height=u.y}var l=this._shadowFrameBuffer.renderPass;s.beginRenderPass(l,this._shadowFrameBuffer,this._renderArea,IB,t.clearDepth,t.clearStencil),s.bindDescriptorSet($p.GLOBAL,r),this._additiveShadowQueue.recordCommandBuffer(o,l,s),s.endRenderPass()}},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._additiveShadowQueue=new MB(e)},e}(iC),jN.initInfo={name:"ShadowStage",priority:SC.FORWARD,tag:0},XN=YN))||XN),xB=[],NB=t("ShadowFlow",ao("ShadowFlow")((QN=qN=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._shadowRenderPass=null,e}o(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new CB;i.initialize(CB.initInfo),this._stages.push(i)}return!0},i.activate=function(e){t.prototype.activate.call(this,e);var i=mg(e.device)?0:1;e.macros.CC_SHADOWMAP_FORMAT=i;var n=e.device.gfxAPI===J.WEBGL?1:0;e.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=n,e.pipelineSceneData.csmSupported=e.device.capabilities.maxFragmentUniformVectors>=(rm.COUNT+sm.COUNT+am.COUNT+om.COUNT)/4,e.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=e.pipelineSceneData.csmSupported,e.macros.CC_SHADOW_TYPE=0,e.macros.CC_DIR_SHADOW_PCF_TYPE=qE.HARD,e.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()},i.render=function(t){var e=this._pipeline,i=e.pipelineSceneData.shadows,n=e.pipelineSceneData.csmLayers,r=e.pipelineSceneData.shadowFrameBufferMap,s=n.castShadowObjects,a=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===KE.ShadowMap){for(var o=0,u=0;o<i.maxReceived&&u<a.length;){var h=a[u];h.type===lO.SPOT&&h.shadowEnabled&&(xB.push(h),o++),u++}if(0!==s.length){i.shadowMapDirty&&this.resizeShadowMap();var c=t.scene.mainLight;if(c&&c.shadowEnabled){var l=e.descriptorSet;r.has(c)||this._initShadowFrameBuffer(e,c,t.window.swapchain);var _=r.get(c);if(c.shadowFixedArea)this._renderStage(t,c,_,l);else for(var d=e.pipelineSceneData.csmSupported?c.csmLevel:1,f=0;f<d;f++)this._renderStage(t,c,_,l,f)}for(var p=0;p<xB.length;p++){var m=xB[p],g=e.globalDSManager.getOrCreateDescriptorSet(m);r.has(m)||this._initShadowFrameBuffer(e,m,t.window.swapchain);var v=r.get(m);this._renderStage(t,m,v,g)}xB.length=0}else this.clearShadowMap(xB,t)}},i.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(e.values()),n=0;n<i.length;n++){var r=i[n];if(r){for(var s=r.colorTextures,a=0;a<s.length;a++){var o=s[a];o&&o.destroy()}s.length=0;var u=r.depthStencilTexture;u&&u.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(t,e){var i=t.device,n=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,s=mg(i)?et.R32F:et.RGBA8;if(!this._shadowRenderPass){var a=new be;a.format=s,a.loadOp=St.CLEAR,a.storeOp=At.STORE,a.sampleCount=1;var o=new Oe;o.format=et.DEPTH_STENCIL,o.depthLoadOp=St.CLEAR,o.depthStoreOp=At.DISCARD,o.stencilLoadOp=St.CLEAR,o.stencilStoreOp=At.DISCARD,o.sampleCount=1;var u=new Ce([a],o);this._shadowRenderPass=i.createRenderPass(u)}var h=[];h.push(i.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,s,n.x,n.y)));var c=i.createTexture(new le(ut.TEX2D,ht.DEPTH_STENCIL_ATTACHMENT,et.DEPTH_STENCIL,n.x,n.y)),l=i.createFramebuffer(new Pe(this._shadowRenderPass,h,c));r.set(e,l)},i._renderStage=function(t,e,i,n,r){void 0===r&&(r=0);for(var s=0;s<this._stages.length;s++){var a=this._stages[s];a.setUsage(n,e,i,r),a.render(t)}},i.clearShadowMap=function(t,e){var i=this._pipeline,n=i.pipelineSceneData,r=e.scene.mainLight;if(r){var s=this._pipeline.descriptorSet;n.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=n.shadowFrameBufferMap.get(r),o=0;o<this._stages.length;o++){var u=this._stages[o];u.setUsage(s,r,a),u.clearFramebuffer(e)}}for(var h=0;h<t.length;h++){var c=t[h],l=i.globalDSManager.getOrCreateDescriptorSet(c);n.shadowFrameBufferMap.has(c)||this._initShadowFrameBuffer(this._pipeline,c,e.window.swapchain);for(var _=n.shadowFrameBufferMap.get(c),d=0;d<this._stages.length;d++){var f=this._stages[d];f.setUsage(l,c,_),f.clearFramebuffer(e)}}},i.resizeShadowMap=function(){for(var t,e=this._pipeline.pipelineSceneData.shadows,i=e.size,n=this._pipeline,r=n.device,s=n.pipelineSceneData.shadowFrameBufferMap,a=mg(r)?et.R32F:et.RGBA8,o=p(s.keys());!(t=o()).done;){var u=t.value,h=s.get(u);if(h){var c=[];c.push(n.device.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,a,i.x,i.y)));var l=h.depthStencilTexture;l&&l.resize(i.x,i.y);var _=h.renderPass;h.destroy();var d=r.createFramebuffer(new Pe(_,c,l));s.set(u,d)}}e.shadowMapDirty=!1},e}(rC),qN.initInfo={name:jp,priority:AC.SHADOW,tag:Qx.SCENE,stages:[]},KN=QN))||KN),BB=new da,PB=new da,DB=new da,FB=new da,LB=new da,UB=new da,GB=new da,kB=new js(0,0,0),zB=new js,HB=new Qs,VB=new js,WB=new js,XB=new js(1e7,1e7,1e7),jB=new js(-1e7,-1e7,-1e7),YB=new js,KB=0,qB=0,QB=function(){function t(t){this._shadowObjects=[],this._shadowCameraFar=0,this._level=void 0,this._matShadowView=new da,this._matShadowProj=new da,this._matShadowViewProj=new da,this._validFrustum=new vc,this._splitFrustum=new vc,this._lightViewFrustum=new vc,this._castLightViewBoundingBox=new sc,this._level=t,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}var e=t.prototype;return e.copyToValidFrustum=function(t){vc.copy(this._validFrustum,t)},e.calculateValidFrustumOrtho=function(t,e,i,n,r){vc.createOrtho(this._validFrustum,t,e,i,n,r)},e.calculateSplitFrustum=function(t,e,i,n){vc.split(this._splitFrustum,t,e,i,n)},e.destroy=function(){this._shadowObjects.length=0},e.createMatrix=function(t,e,i){var n=v.director.root.device,r=t.shadowInvisibleOcclusionRange;vc.copy(this._lightViewFrustum,this._splitFrustum),da.fromRT(PB,t.node.rotation,kB),da.invert(DB,PB);var s,a,o=DB.clone();this._lightViewFrustum.transform(DB),sc.fromPoints(this._castLightViewBoundingBox,XB,jB),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),t.csmOptimizationMode===ZE.DisableRotationFix?(s=2*this._castLightViewBoundingBox.halfExtents.x,a=2*this._castLightViewBoundingBox.halfExtents.y):s=a=js.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);var u=v.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1;if(u>1&&t.csmOptimizationMode===ZE.RemoveDuplicates)if(this._level>=u-1)qB=this._castLightViewBoundingBox.halfExtents.z,KB=this._castLightViewBoundingBox.center.z;else{var h=Math.abs(this._castLightViewBoundingBox.center.z-KB)+qB;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,h)}var c=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*c+r;var l=this._castLightViewBoundingBox.center;if(YB.set(l.x,l.y,l.z+c+r),js.transformMat4(YB,YB,PB),da.fromRT(PB,t.node.rotation,YB),da.invert(DB,PB),!i){var _=.5*s,d=.5*a;da.ortho(FB,-_,_,-d,d,.1,this._shadowCameraFar,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY),da.multiply(UB,FB,o),js.transformMat4(zB,YB,UB);var f=2/e;HB.set(f,f);var p=zB.x%HB.x,m=zB.y%HB.y;VB.set(zB.x-p,zB.y-m,zB.z),da.invert(GB,UB),js.transformMat4(WB,VB,GB),da.fromRT(PB,t.node.rotation,WB),da.invert(DB,PB),da.multiply(LB,FB,DB),da.copy(this._matShadowView,DB),da.copy(this._matShadowProj,FB),da.copy(this._matShadowViewProj,LB)}vc.createOrtho(this._validFrustum,s,a,.1,this._shadowCameraFar,PB)},s(t,[{key:"level",get:function(){return this._level}},{key:"shadowObjects",get:function(){return this._shadowObjects}},{key:"shadowCameraFar",get:function(){return this._shadowCameraFar},set:function(t){this._shadowCameraFar=t}},{key:"matShadowView",get:function(){return this._matShadowView},set:function(t){this._matShadowView=t}},{key:"matShadowProj",get:function(){return this._matShadowProj},set:function(t){this._matShadowProj=t}},{key:"matShadowViewProj",get:function(){return this._matShadowViewProj},set:function(t){this._matShadowViewProj=t}},{key:"validFrustum",get:function(){return this._validFrustum}},{key:"splitFrustum",get:function(){return this._splitFrustum}},{key:"lightViewFrustum",get:function(){return this._lightViewFrustum}},{key:"castLightViewBoundingBox",get:function(){return this._castLightViewBoundingBox}}]),t}(),ZB=function(t){function e(e){var i;return(i=t.call(this,e)||this)._splitCameraNear=0,i._splitCameraFar=0,i._csmAtlas=new ta,i._calculateAtlas(e),i}o(e,t);var i=e.prototype;return i.destroy=function(){t.prototype.destroy.call(this)},i._calculateAtlas=function(t){var e=v.director.root.device.capabilities.clipSpaceSignY,i=t%2-.5,n=(.5-Math.floor(t/2))*e;this._csmAtlas.set(.5,.5,i,n)},s(e,[{key:"splitCameraNear",get:function(){return this._splitCameraNear},set:function(t){this._splitCameraNear=t}},{key:"splitCameraFar",get:function(){return this._splitCameraFar},set:function(t){this._splitCameraFar=t}},{key:"csmAtlas",get:function(){return this._csmAtlas},set:function(t){this._csmAtlas=t}}]),e}(QB),JB=function(){function t(){this._castShadowObjects=[],this._layerObjects=new Wi(64),this._layers=[],this._levelCount=0,this._specialLayer=new QB(1),this._shadowDistance=0;for(var t=0;t<QE.LEVEL_4;t++)this._layers[t]=new ZB(t)}var e=t.prototype;return e.update=function(t,e){var i=e.scene.mainLight;if(null!==i){var n=t.shadows,r=v.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,s=i.shadowDistance;n.enabled&&i.shadowEnabled&&(i.shadowFixedArea?this._updateFixedArea(i):((i.csmNeedUpdate||this._levelCount!==r||this._shadowDistance!==s)&&(this._splitFrustumLevels(i),this._levelCount=r,this._shadowDistance=s),this._calculateCSM(e,i,n)))}},e.destroy=function(){this._castShadowObjects.length=0;for(var t=0;t<this._layers.length;t++)this._layers[t].destroy();this._layers.length=0},e._updateFixedArea=function(t){var e=v.director.root.device,i=t.shadowOrthoSize,n=t.shadowOrthoSize,r=t.shadowNear,s=t.shadowFar;da.fromRT(PB,t.node.getWorldRotation(),t.node.getWorldPosition()),da.invert(DB,PB),da.ortho(FB,-i,i,-n,n,r,s,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY),da.multiply(LB,FB,DB),this._specialLayer.matShadowView=DB,this._specialLayer.matShadowProj=FB,this._specialLayer.matShadowViewProj=LB,this._specialLayer.calculateValidFrustumOrtho(2*i,2*n,r,s,PB)},e._splitFrustumLevels=function(t){var e=.1,i=t.shadowDistance,n=i/e,r=v.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1,s=t.csmLayerLambda;this._layers[0].splitCameraNear=e;for(var a=1;a<r;a++){var o=a/r,u=s*e*Math.pow(n,o)+(1-s)*(e+(i-e)*o),h=1.005*u;this._layers[a].splitCameraNear=u,this._layers[a-1].splitCameraFar=h}this._layers[r-1].splitCameraFar=i,t.csmNeedUpdate=!1},e._calculateCSM=function(t,e,i){var n=v.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,r=n>1?.5*i.size.x:i.size.x;if(!(r<0)){this._getCameraWorldMatrix(BB,t);for(var s=n-1;s>=0;s--){var a=this._layers[s],o=a.splitCameraNear,u=a.splitCameraFar;a.calculateSplitFrustum(t,BB,o,u),a.createMatrix(e,r,!1)}n===QE.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,da.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),da.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),da.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(t,BB,.1,e.shadowDistance),this._specialLayer.createMatrix(e,r,!0))}},e._getCameraWorldMatrix=function(t,e){if(e.node){var i=e.node,n=i.getWorldPosition(),r=i.getWorldRotation();da.fromRT(t,r,n),t.m08*=-1,t.m09*=-1,t.m10*=-1}},s(t,[{key:"castShadowObjects",get:function(){return this._castShadowObjects}},{key:"layerObjects",get:function(){return this._layerObjects}},{key:"layers",get:function(){return this._layers}},{key:"specialLayer",get:function(){return this._specialLayer}}]),t}(),$B=t("PipelineSceneData",function(){function t(){this.fog=new YA,this.ambient=new jE,this.skybox=new nS,this.shadows=new $E,this.csmLayers=new JB,this.octree=new pO,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._shadingScale=1}var e=t.prototype;return e.activate=function(t){return this._device=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},e.initGeometryRendererMaterials=function(){for(var t=0,e=0;e<6;e++){this._geometryRendererMaterials[e]=new $T,this._geometryRendererMaterials[e]._uuid="geometry-renderer-material-"+e,this._geometryRendererMaterials[e].initialize({effectName:"builtin-geometry-renderer",technique:e});for(var i=0;i<this._geometryRendererMaterials[e].passes.length;++i)this._geometryRendererPasses[t]=this._geometryRendererMaterials[e].passes[i],this._geometryRendererShaders[t]=this._geometryRendererMaterials[e].passes[i].getShaderVariant(),t++}},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new $T;t._uuid="default-occlusion-query-material",t.initialize({effectName:"builtin-occlusion-query"}),this._occlusionQueryMaterial=t,t.passes.length>0&&(this._occlusionQueryShader=t.passes[0].getShaderVariant())}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null},e.updatePipelineSceneData=function(){},e.destroy=function(){var t,e,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,n=8*i;this._occlusionQueryVertexBuffer=t.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,n,i)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),s=Uint16Array.BYTES_PER_ELEMENT,a=36*s;this._occlusionQueryIndicesBuffer=t.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,a,s)),this._occlusionQueryIndicesBuffer.update(r);var o=[new Ae("a_position",et.RGB32F)],u=new we(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(u)},s(t,[{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale=t}},{key:"csmSupported",get:function(){return this._csmSupported},set:function(t){this._csmSupported=t}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),t}()),tP=t("ForwardPipeline",(ZN=ao("ForwardPipeline"),JN=xo([nN]),ZN((tB=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).renderTextures=eB&&eB(),e._postRenderPass=null,e}o(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var i=new NB;i.initialize(NB.initInfo),this._flows.push(i);var n=new HN;n.initialize(HN.initInfo),this._flows.push(n)}return!0},i.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new $B,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(z(2402),1))},i._ensureEnoughSize=function(t){for(var e=this._width,i=this._height,n=0;n<t.length;++n){var r=t[n].window;e=Math.max(r.width,e),i=Math.max(r.height,i)}e===this._width&&i===this._height||(this._width=e,this._height=i)},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},i._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(um,e),this._descriptorSet.bindTexture(um,IT.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(gm,e),this._descriptorSet.bindTexture(gm,IT.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(rm.BINDING).destroy(),this._descriptorSet.getBuffer(am.BINDING).destroy(),this._descriptorSet.getBuffer(sm.BINDING).destroy(),this._descriptorSet.getTexture(um).destroy(),this._descriptorSet.getTexture(gm).destroy())},s(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(eN),eB=Za(tB.prototype,"renderTextures",[JN,mo],(function(){return[]})),$N=tB))||$N)),eP=[new ie(0,0,0,0),new ie(0,0,0,0),new ie(0,0,0,0)],iP=t("GbufferStage",(iB=ao("GbufferStage"),nB=xo([aN]),iB((uB=oB=function(t){function e(){var e;return(e=t.call(this)||this).renderQueues=aB&&aB(),e._renderQueues=[],e._renderArea=new Kt,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=CT("default"),e._batchedQueue=new dN,e._instancedQueue=new fN,e}o(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=cN(this.renderQueues[n])},i.destroy=function(){},i.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,i=e.device;this._renderQueues.forEach(lN),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var n=e.pipelineSceneData.renderObjects,r=0,s=0,a=0,o=0;o<n.length;++o){var u=n[o],h=u.model.subModels;for(r=0;r<h.length;++r){var c=h[r],l=c.passes;for(s=0;s<l.length;++s){var _=l[s];if(_.phase===this._phaseID){var d=_.batchingScheme;if(d===OT.INSTANCING){var f=_.getInstancedBuffer();f.merge(c,s),this._instancedQueue.queue.add(f)}else if(d===OT.VB_MERGING){var p=_.getBatchedBuffer();p.merge(c,s,u.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(u,r,s)}}}}this._renderQueues.forEach(_N);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Lt.COLOR&&(e.pipelineSceneData.isHDR?kT(eP[0],t.clearColor):(eP[0].x=t.clearColor.x,eP[0].y=t.clearColor.y,eP[0].z=t.clearColor.z)),eP[0].w=t.clearColor.w;var g=e.getPipelineRenderData().gbufferFrameBuffer,v=g.renderPass;m.beginRenderPass(v,g,this._renderArea,eP,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet($p.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(i,v,m);this._instancedQueue.recordCommandBuffer(i,v,m),this._batchedQueue.recordCommandBuffer(i,v,m),m.endRenderPass()},e}(iC),oB.initInfo={name:"GbufferStage",priority:RC.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:iN.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:iN.BACK_TO_FRONT,stages:["default"]}]},aB=Za((sB=uB).prototype,"renderQueues",[nB,mo],(function(){return[]})),rB=sB))||rB)),nP=[new ie(0,0,0,1)],rP=t("LightingStage",(hB=ao("LightingStage"),cB=xo($T),lB=xo([aN]),hB((gB=mB=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=wm.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new Kt,e._uiPhase=void 0,e._deferredMaterial=fB&&fB(),e.renderQueues=pB&&pB(),e._phaseID=CT("default"),e._renderQueues=[],e._uiPhase=new GN,e}o(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.gatherLights=function(t){for(var e=this._pipeline,i=e.commandBuffers[0],n=t.scene.sphereLights,r=t.scene.spotLights,s=Hu.create(0,0,0,1),a=new Float32Array(4),o=t.exposure,u=0,h=ta.length,c=h*this._maxDeferredLights,l=0;l<n.length&&u<this._maxDeferredLights;l++,++u){var _=n[l];if(Hu.set(s,_.position.x,_.position.y,_.position.z,_.range),jh.sphereFrustum(s,t.frustum)){if(js.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,u*h),js.toArray(a,_.color),_.useColorTemperature){var d=_.colorTemperatureRGB;a[0]*=d.x,a[1]*=d.y,a[2]*=d.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*o*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,u*h+1*c),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,u*h+2*c)}}for(var f=0;f<r.length&&u<this._maxDeferredLights;f++,++u){var p=r[f];if(Hu.set(s,p.position.x,p.position.y,p.position.z,p.range),jh.sphereFrustum(s,t.frustum)){if(js.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,u*h+0*c),js.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=p.luminance*o*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,u*h+1*c),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,u*h+2*c),js.toArray(a,p.direction),this._lightBufferData.set(a,u*h+3*c)}}var g=3*c+3;this._lightBufferData.set([u],g),i.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},i._createStageDescriptor=function(t){var e=this._pipeline.device,i=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;i=Math.ceil(i/e.capabilities.uboOffsetAlignment)*e.capabilities.uboOffsetAlignment,this._deferredLitsBufs=e.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,i,e.capabilities.uboOffsetAlignment));var n=e.createBuffer(new oe(this._deferredLitsBufs,0,i));this._lightBufferData=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=e.createDescriptorSet(new Le(t.localSetLayout)),this._descriptorSet.bindBuffer(Rm.BINDING,n);var r=e.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE,Tm.SIZE,Tm.SIZE));this._descriptorSet.bindBuffer(Tm.BINDING,r)},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._uiPhase.activate(e);for(var n=0;n<this.renderQueues.length;n++)this._renderQueues[n]=cN(this.renderQueues[n]);this._planarQueue=new UN(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},i.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},i.render=function(t){var e,i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=i.pipelineSceneData,a=s.renderObjects;this._planarQueue.gatherShadowPasses(t,r),i.generateRenderArea(t,this._renderArea);for(var o=i.getPipelineRenderData(),u=s.deferredLightingMaterial.passes[0],h=u.getShaderVariant(),c=0;c<3;++c)u.descriptorSet.bindTexture(c,o.gbufferRenderTargets[c]),u.descriptorSet.bindSampler(c,o.sampler);u.descriptorSet.bindTexture(3,o.outputDepth),u.descriptorSet.bindSampler(3,o.sampler),u.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(u),this.gatherLights(t),t.clearFlag&Lt.COLOR&&(nP[0].x=t.clearColor.x,nP[0].y=t.clearColor.y,nP[0].z=t.clearColor.z),nP[0].w=0;var l=o.outputFrameBuffer,_=l.renderPass;i.pipelineUBO.updateShadowUBO(t),r.beginRenderPass(_,l,this._renderArea,nP,t.clearDepth,t.clearStencil),r.setScissor(i.generateScissor(t)),r.setViewport(i.generateViewport(t)),r.bindDescriptorSet($p.GLOBAL,i.descriptorSet);var d=i.quadIAOffscreen,f=null;null!=u&&null!=h&&null!=d&&(f=LT.getOrCreatePipelineState(n,u,h,_,d)),null!=f&&(this._descriptorSet.update(),r.bindPipelineState(f),r.bindDescriptorSet($p.MATERIAL,u.descriptorSet),r.bindDescriptorSet($p.LOCAL,this._descriptorSet),r.bindInputAssembler(d),r.draw(d)),this._renderQueues.forEach(lN);for(var p=0,m=0,g=0,v=0;v<a.length;++v){var y=a[v],T=y.model.subModels;for(p=0;p<T.length;++p){var E=T[p].passes;for(m=0;m<E.length;++m)if(E[m].phase===this._phaseID)for(g=0;g<this._renderQueues.length;g++)this._renderQueues[g].insertRenderPass(y,p,m)}}if(a.length>0){this._renderQueues.forEach(_N);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,_,r);this._planarQueue.recordCommandBuffer(n,_,r)}null===(e=t.geometryRenderer)||void 0===e||e.render(_,r,i.pipelineSceneData),this._uiPhase.render(t,_),r.endRenderPass()},e}(iC),mB.initInfo={name:"LightingStage",priority:RC.LIGHTING,tag:0},fB=Za((dB=gB).prototype,"_deferredMaterial",[cB,mo],(function(){return null})),pB=Za(dB.prototype,"renderQueues",[lB,mo],(function(){return[]})),_B=dB))||_B)),sP=[new ie(0,0,0,1)],aP=t("PostProcessStage",(vB=ao("PostProcessStage"),yB=xo($T),TB=xo([aN]),vB((bB=wB=function(t){function e(){var e;return(e=t.call(this)||this)._postProcessMaterial=AB&&AB(),e.renderQueues=RB&&RB(),e._renderArea=new Kt,e._stageDesc=void 0,e._localUBO=void 0,e._uiPhase=new GN,e}o(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},i.destroy=function(){},i.render=function(t){var e=this._pipeline,i=e.device,n=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var s=t.viewport;this._renderArea.x=s.x*t.window.width,this._renderArea.y=s.y*t.window.height,this._renderArea.width=s.width*t.window.width,this._renderArea.height=s.height*t.window.height;var a=e.getPipelineRenderData(),o=t.window.framebuffer,u=e.getRenderPass(t.clearFlag,o);t.clearFlag&Lt.COLOR&&(sP[0].x=t.clearColor.x,sP[0].y=t.clearColor.y,sP[0].z=t.clearColor.z),sP[0].w=t.clearColor.w,r.beginRenderPass(u,o,this._renderArea,sP,t.clearDepth,t.clearStencil),r.bindDescriptorSet($p.GLOBAL,e.descriptorSet);var h=n.postprocessMaterial.passes[0],c=h.getShaderVariant();e.bloomEnabled?h.descriptorSet.bindTexture(0,a.bloom.combineTex):h.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),h.descriptorSet.bindSampler(0,a.sampler),h.descriptorSet.update();var l=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,_=null;null!=h&&null!=c&&null!=l&&(_=LT.getOrCreatePipelineState(i,h,c,u,l));var d=e.pipelineSceneData.renderObjects;null!=_&&d.length>0&&(this._stageDesc||(this._stageDesc=i.createDescriptorSet(new Le(h.localSetLayout)),this._localUBO=i.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE,Tm.SIZE,Tm.SIZE)),this._stageDesc.bindBuffer(Tm.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(_),r.bindDescriptorSet($p.MATERIAL,h.descriptorSet),r.bindDescriptorSet($p.LOCAL,this._stageDesc),r.bindInputAssembler(l),r.draw(l)),this._uiPhase.render(t,u),ZT(i,u,r,e.profiler,t),r.endRenderPass()},e}(iC),wB.initInfo={name:"PostProcessStage",priority:EC.POST_PROCESS,tag:0},AB=Za((SB=bB).prototype,"_postProcessMaterial",[yB,mo],(function(){return null})),RB=Za(SB.prototype,"renderQueues",[TB,mo],(function(){return[]})),EB=SB))||EB));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(OB||(OB={}));var oP,uP,hP,cP,lP,_P,dP,fP=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._antiAliasing=OB.NONE,e}o(e,t);var i=e.prototype;return i.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=0;e<6;++e){var i=this._bloomMaterial.passes[1+e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var n=this._bloomMaterial.passes[7+e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}var r=this._bloomMaterial.passes[13];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var t=new $T;t._uuid="builtin-deferred-material",t.initialize({effectName:"pipeline/deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var i=new $T;i._uuid="builtin-bloom-material",i.initialize({effectName:"pipeline/bloom"});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._bloomMaterial=i;var r=new $T;r._uuid="builtin-post-process-material",Xn.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=OB.FXAA),r.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var s=0;s<r.passes.length;++s)r.passes[s].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(e){return t.prototype.activate.call(this,e),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){v.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},s(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var i=new $T;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var n=0;n<i.passes.length;++n)i.passes[n].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}($B),pP=[new ie(0,0,0,1)],mP=function(){};mP.SIZE=4*(mP.COUNT=4+(mP.TEXTURE_SIZE_OFFSET=0));var gP,vP,yP,TP,EP,SP,AP,RP,wP=t("BloomStage",(oP=ao("BloomStage"),uP=xo($T),oP((dP=_P=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,e._bloomMaterial=lP&&lP(),e._renderArea=new Kt,e._bloomUBO=[],e}o(e,t);var i=e.prototype;return i.initialize=function(e){return t.prototype.initialize.call(this,e),!0},i.activate=function(e,i){t.prototype.activate.call(this,e,i),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(t){var e,i=this._pipeline;if(i.generateBloomRenderData(),(null!==(e=t.window)&&void 0!==e&&e.swapchain||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var n=0;n<14;++n)this._bloomUBO[n]=i.device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,mP.SIZE,mP.SIZE));t.clearFlag&Lt.COLOR&&(pP[0].x=t.clearColor.x,pP[0].y=t.clearColor.y,pP[0].z=t.clearColor.z),pP[0].w=t.clearColor.w,this._prefilterPass(t,i),this._downsamplePass(t,i),this._upsamplePass(t,i),this._combinePass(t,i)}},i._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),s=r.bloom,a=new Float32Array(mP.COUNT);a[mP.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],a),i.beginRenderPass(s.renderPass,s.prefilterFramebuffer,this._renderArea,pP,0,0),i.bindDescriptorSet($p.GLOBAL,e.descriptorSet),n.descriptorSet.bindBuffer(0,this._bloomUBO[0]),n.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),n.descriptorSet.bindSampler(1,s.sampler),n.descriptorSet.update(),i.bindDescriptorSet($p.MATERIAL,n.descriptorSet);var o=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null,h=n.getShaderVariant();null!=n&&null!=h&&null!=o&&(u=LT.getOrCreatePipelineState(e.device,n,h,s.renderPass,o)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()},i._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,s=new Float32Array(mP.COUNT),a=0;a<this.iterations;++a){s[mP.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[mP.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[a+1],s),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,pP,0,0);var o=n.passes[1+a],u=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?o.descriptorSet.bindTexture(1,r.prefiterTex):o.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),o.descriptorSet.bindSampler(1,r.sampler),o.descriptorSet.update(),i.bindDescriptorSet($p.MATERIAL,o.descriptorSet);var h=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null;null!=o&&null!=u&&null!=h&&(c=LT.getOrCreatePipelineState(e.device,o,u,r.renderPass,h)),null!=c&&(i.bindPipelineState(c),i.bindInputAssembler(h),i.draw(h)),i.endRenderPass()}},i._upsamplePass=function(t,e){var i=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var n=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,s=new Float32Array(mP.COUNT),a=0;a<this.iterations;++a){var o=a+6+1;s[mP.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,s[mP.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[o],s),this._renderArea.width<<=1,this._renderArea.height<<=1,n.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-a],this._renderArea,pP,0,0);var u=r.passes[7+a],h=u.getShaderVariant();u.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===a?u.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):u.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-a]),u.descriptorSet.bindSampler(1,i.sampler),u.descriptorSet.update(),n.bindDescriptorSet($p.MATERIAL,u.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null;null!=u&&null!=h&&null!=c&&(l=LT.getOrCreatePipelineState(e.device,u,h,i.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()}},i._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var i=e.commandBuffers[0],n=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),s=r.bloom,a=new Float32Array(mP.COUNT);a[mP.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],a),i.beginRenderPass(s.renderPass,s.combineFramebuffer,this._renderArea,pP,0,0),i.bindDescriptorSet($p.GLOBAL,e.descriptorSet);var o=n.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,s.upsampleTexs[0]),o.descriptorSet.bindSampler(1,s.sampler),o.descriptorSet.bindSampler(2,s.sampler),o.descriptorSet.update(),i.bindDescriptorSet($p.MATERIAL,o.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null,c=o.getShaderVariant();null!=o&&null!=c&&null!=u&&(h=LT.getOrCreatePipelineState(e.device,o,c,s.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()},e}(iC),_P.initInfo={name:"BloomStage",priority:EC.BLOOM,tag:0},lP=Za((cP=dP).prototype,"_bloomMaterial",[uP,mo],(function(){return null})),hP=cP))||hP)),bP=t("MainFlow",ao("MainFlow")((yP=vP=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var i=new iP;i.initialize(iP.initInfo),this._stages.push(i);var n=new rP;n.initialize(rP.initInfo),this._stages.push(n);var r=new wP;r.initialize(wP.initInfo),this._stages.push(r);var s=new aP;s.initialize(aP.initInfo),this._stages.push(s)}return!0},i.activate=function(e){t.prototype.activate.call(this,e)},i.render=function(e){t.prototype.render.call(this,e)},i.destroy=function(){t.prototype.destroy.call(this)},e}(rC),vP.initInfo={name:Wp,priority:wC.MAIN,stages:[]},gP=yP))||gP),OP=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return o(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),MP=t("DeferredPipeline",(TP=ao("DeferredPipeline"),EP=xo([nN]),TP((AP=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,e.renderTextures=RP&&RP(),e}o(e,t);var i=e.prototype;return i.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var i=new NB;i.initialize(NB.initInfo),this._flows.push(i);var n=new bP;n.initialize(bP.initInfo),this._flows.push(n)}return!0},i.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new fP,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(z(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),i=e.next();!i.done;)i.value.destroy(),i=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},i.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(um,i),this._descriptorSet.bindTexture(um,IT.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(gm,i),this._descriptorSet.bindTexture(gm,IT.get("default-texture").getGFXTexture()),this._descriptorSet.update();var n=new tN;if(!(n=this._createQuadInputAssembler()).quadIB||!n.quadVB||!n.quadIA)return!1;this._quadIB=n.quadIB,this._quadVBOffscreen=n.quadVB,this._quadIAOffscreen=n.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var s=new be;s.format=et.RGBA16F,s.loadOp=St.CLEAR,s.storeOp=At.STORE;var a=new be;a.format=et.RGBA16F,a.loadOp=St.CLEAR,a.storeOp=At.STORE;var o=new be;o.format=et.RGBA16F,o.loadOp=St.CLEAR,o.storeOp=At.STORE;var u=new Oe;u.format=et.DEPTH_STENCIL,u.depthLoadOp=St.CLEAR,u.depthStoreOp=At.STORE,u.stencilLoadOp=St.CLEAR,u.stencilStoreOp=At.STORE;var h=new Ce([s,a,o],u);this._gbufferRenderPass=e.createRenderPass(h)}if(!this._lightingRenderPass){var c=new be;c.format=et.RGBA8,c.loadOp=St.CLEAR,c.storeOp=At.STORE,c.barrier=e.getGeneralBarrier(new xe(Rt.NONE,Rt.COLOR_ATTACHMENT_WRITE));var l=new Oe;l.format=et.DEPTH_STENCIL,l.depthLoadOp=St.LOAD,l.depthStoreOp=At.DISCARD,l.stencilLoadOp=St.LOAD,l.stencilStoreOp=At.DISCARD,c.barrier=e.getGeneralBarrier(new xe(Rt.DEPTH_STENCIL_ATTACHMENT_WRITE,Rt.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Ce([c],l);this._lightingRenderPass=e.createRenderPass(_)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(rm.BINDING).destroy(),this._descriptorSet.getBuffer(am.BINDING).destroy(),this._descriptorSet.getBuffer(sm.BINDING).destroy(),this._descriptorSet.getTexture(um).destroy(),this._descriptorSet.getTexture(gm).destroy())},i._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var i=0;i<t.outputRenderTargets.length;i++)t.outputRenderTargets[i].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(t){for(var e=this._width,i=this._height,n=0;n<t.length;++n){var r=t[n].window;e=Math.max(r.width,e),i=Math.max(r.height,i)}e===this._width&&i===this._height||(this._width=e,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var t=this,e=this.device,i=this._pipelineRenderData=new OP,n=this.pipelineSceneData,r=0;r<3;++r)i.gbufferRenderTargets.push(e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale)));i.outputDepth=e.createTexture(new le(ut.TEX2D,ht.DEPTH_STENCIL_ATTACHMENT|ht.SAMPLED,et.DEPTH_STENCIL,this._width*n.shadingScale,this._height*n.shadingScale)),i.gbufferFrameBuffer=e.createFramebuffer(new Pe(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(e.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED,et.RGBA16F,this._width*n.shadingScale,this._height*n.shadingScale))),i.outputFrameBuffer=e.createFramebuffer(new Pe(this._lightingRenderPass,i.outputRenderTargets,null)),i.sampler=this.globalDSManager.pointSampler,this.on(nC.ATTACHMENT_SCALE_CAHNGED,(function(e){i.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,i.gbufferFrameBuffer=t.newFramebufferByRatio(i.gbufferFrameBuffer),i.gbufferFrameBuffer=t.newFramebufferByRatio(i.outputFrameBuffer)}))},e}(eN),RP=Za(AP.prototype,"renderTextures",[EP,mo],(function(){return[]})),SP=AP))||SP));function IP(){var t=new tP;return t.initialize({flows:[]}),t}var CP=new Qs,xP=function(){var t=e.prototype;function e(){this._curTime=0}return t.init=function(){var t,e,i,n,r,s,a,o=this;return this.settings={enabled:null===(t=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"enabled"))||void 0===t||t,totalTime:null!==(e=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"totalTime"))&&void 0!==e?e:3e3,base64src:null!==(i=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"base64src"))&&void 0!==i?i:"",effect:null!==(n=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"effect"))&&void 0!==n?n:"FADE-INOUT",clearColor:null!==(r=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"clearColor"))&&void 0!==r?r:new ie(.88,.88,.88,1),displayRatio:null!==(s=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"displayRatio"))&&void 0!==s?s:.4,displayWatermark:null===(a=Wn.querySettings(Vn.Category.SPLASH_SCREEN,"displayWatermark"))||void 0===a||a},this._curTime=0,!this.settings.enabled||""===this.settings.base64src||this.settings.totalTime<=0?(this.settings.totalTime=0,Promise.resolve()):(this.device=v.director.root.device,this.swapchain=v.director.root.mainWindow.swapchain,this.framebuffer=v.director.root.mainWindow.framebuffer,this.preInit(),this.settings.displayWatermark&&this.initWarterMark(),new Promise((function(t,e){o.logoImage=new Image,o.logoImage.onload=function(){o.initLogo(),t()},o.logoImage.onerror=function(){e()},o.logoImage.src=o.settings.base64src})))},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new ie(t.x,t.y,t.z,t.w)];var e=this.device,i=this.swapchain;this.renderArea=new Kt(0,0,i.width,i.height),this.cmdBuff=e.commandBuffer;var n=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,s=4*r;this.vertexBuffers=e.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,s,r)),this.vertexBuffers.update(n);var a=new Uint16Array([0,1,2,1,3,2]),o=Uint16Array.BYTES_PER_ELEMENT,u=6*o;this.indicesBuffers=e.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,u,o)),this.indicesBuffers.update(a);var h=[new Ae("a_position",et.RG32F),new Ae("a_texCoord",et.RG32F)],c=new we(h,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(c),this.projection=new da,da.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,i.surfaceTransform)},t.update=function(t){var e=this.settings,i=this.device,n=this.swapchain;da.ortho(this.projection,-1,1,-1,1,-1,1,i.capabilities.clipSpaceMinZ,i.capabilities.clipSpaceSignY,n.surfaceTransform);var r=n.width,s=n.height,a=r<s?r:s;this._curTime+=1e3*t;var o=s_(Rs(this._curTime/e.totalTime));"NONE"===e.effect&&(o=1);var u=this.logoTexture.width,h=this.logoTexture.height,c=a*e.displayRatio,l=c*u/h,_=c;if(n.surfaceTransform!==$.ROTATE_90&&n.surfaceTransform!==$.ROTATE_270||(l=c*r/s,_=c*h/u*s/r),this.logoMat.setProperty("resolution",CP.set(r,s),0),this.logoMat.setProperty("scale",CP.set(l,_),0),this.logoMat.setProperty("translate",CP.set(.5*r,.5*s),0),this.logoMat.setProperty("percent",o),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),e.displayWatermark&&this.watermarkMat){var d=.5*a,f=this.watermarkTexture.width,p=d,m=d*this.watermarkTexture.height/f;n.surfaceTransform!==$.ROTATE_90&&n.surfaceTransform!==$.ROTATE_270||(p=.5*d,m=d*r/s*.5),this.watermarkMat.setProperty("resolution",CP.set(r,s),0),this.watermarkMat.setProperty("scale",CP.set(p,m),0),this.watermarkMat.setProperty("translate",CP.set(.5*r,.1*s),0),this.watermarkMat.setProperty("percent",o),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame()},t.initLogo=function(){var t=this.device;this.logoMat=new $T,this.logoMat.initialize({effectName:"util/splash-screen"});var e=new de;e.addressU=pt.CLAMP,e.addressV=pt.CLAMP,e.addressW=pt.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new le(ut.TEX2D,ht.SAMPLED|ht.TRANSFER_DST,et.RGBA8,this.logoImage.width,this.logoImage.height));var i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();var r=i.descriptorSet;r.bindSampler(n,this.sampler),r.update();var s=new te;s.texExtent.width=this.logoImage.width,s.texExtent.height=this.logoImage.height,s.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[s])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var i="Powered by Cocos Creator",n=e.measureText(i);e.fillText(i,(330-n.width)/2,6);var r=new te;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new le(ut.TEX2D,ht.SAMPLED|ht.TRANSFER_DST,et.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new $T,this.watermarkMat.initialize({effectName:"util/splash-screen"});var s=this.watermarkMat.passes[0],a=s.getBinding("mainTexture");s.bindTexture(a,this.watermarkTexture),s.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;if(!za.isXR||xr.entry.isRenderAllowable())for(var i=za.isXR?2:1,n=0;n<i;n++){za.isXR&&xr.entry.renderLoopStart(n),t.acquire([e]);var r=this.cmdBuff,s=this.framebuffer,a=this.renderArea;a.width=e.width,a.height=e.height,r.begin(),r.beginRenderPass(s.renderPass,s,a,this.clearColors,1,0);var o=this.logoMat.passes[0],u=LT.getOrCreatePipelineState(t,o,this.shader,s.renderPass,this.quadAssmebler);if(r.bindPipelineState(u),r.bindDescriptorSet($p.MATERIAL,o.descriptorSet),r.bindInputAssembler(this.quadAssmebler),r.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var h=this.watermarkMat.passes[0],c=LT.getOrCreatePipelineState(t,h,this.shader,s.renderPass,this.quadAssmebler);r.bindPipelineState(c),r.bindDescriptorSet($p.MATERIAL,h.descriptorSet),r.bindInputAssembler(this.quadAssmebler),r.draw(this.quadAssmebler)}r.endRenderPass(),r.end(),t.flushCommands([r]),t.queue.submit([r]),t.present(),za.isXR&&xr.entry.renderLoopEnd(n)}},t.destroy=function(){this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null},s(e,[{key:"isFinished",get:function(){return this._curTime>=this.settings.totalTime}},{key:"curTime",get:function(){return this._curTime},set:function(t){this._curTime=t}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();xP._ins=void 0,v.internal.SplashScreen=xP;var NP={topLeft:v.v2(0,0),topRight:v.v2(0,0),top:v.v2(0,0),bottomLeft:v.v2(0,0),bottomRight:v.v2(0,0),bottom:v.v2(0,0),center:v.v2(0,0),left:v.v2(0,0),right:v.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,i=this.height=t.height,n=t.x,r=t.y,s=r+i,a=n+e;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+e/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+e/2,this.bottom.y=r,this.center.x=n+e/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}};v.visibleRect=NP;var BP=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new es,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,hs.browserType===is.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var i=0,n=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var s=t.accelerationIncludingGravity;i=.1*((null==s?void 0:s.x)||0),n=.1*((null==s?void 0:s.y)||0),r=.1*((null==s?void 0:s.z)||0)}else{var a=t;i=(a.gamma||0)/90*.981,n=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(Fa.isFrameRotated){var o=i;i=-n,n=o}var u=i;90===window.orientation?(i=-n,n=u):-90===window.orientation?(i=n,n=-u):180===window.orientation&&(i=-i,n=-n),hs.os===ss.ANDROID&&hs.browserType!==is.MOBILE_QQ&&(i=-i,n=-n);var h=performance.now(),c=new RE(i,n,r,h),l=new gE(c);this._eventTarget.emit(cE.DEVICEMOTION,l)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}(),PP=function(){},DP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){throw new Error("Method not implemented.")},e}(PP),FP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){throw new Error("Method not implemented.")},e}(PP),LP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){throw new Error("Method not implemented.")},e}(PP),UP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){throw new Error("Method not implemented.")},e}(PP),GP=function(t){function e(e){var i;return(i=t.call(this)||this).positive=void 0,i.negative=void 0,i.positive=e.positive,i.negative=e.negative,i}return o(e,t),e.prototype.getValue=function(){var t=this.positive.getValue(),e=this.negative.getValue();return Math.abs(t)>Math.abs(e)?t:-e},e}(DP),kP=function(t){function e(e){var i;return(i=t.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.xAxis=void 0,i.yAxis=void 0,i.up=e.up,i.down=e.down,i.left=e.left,i.right=e.right,i.xAxis=new GP({positive:i.right,negative:i.left}),i.yAxis=new GP({positive:i.up,negative:i.down}),i}return o(e,t),e.prototype.getValue=function(){return new Qs(this.xAxis.getValue(),this.yAxis.getValue())},e}(FP),zP=(function(t){function e(e){var i;return(i=t.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.forward=void 0,i.backward=void 0,i.xAxis=void 0,i.yAxis=void 0,i.zAxis=void 0,i.up=e.up,i.down=e.down,i.left=e.left,i.right=e.right,i.forward=e.forward,i.backward=e.backward,i.xAxis=new GP({positive:i.right,negative:i.left}),i.yAxis=new GP({positive:i.up,negative:i.down}),i.zAxis=new GP({positive:i.forward,negative:i.backward}),i}o(e,t),e.prototype.getValue=function(){return new js(this.xAxis.getValue(),this.yAxis.getValue(),this.zAxis.getValue())}}(LP),function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){return t.prototype.getValue.call(this)},e}(DP)),HP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(kP),VP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e}(kP),WP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){return t.prototype.getValue.call(this)},e}(UP),XP=function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.getValue=function(){return t.prototype.getValue.call(this)},e}(LP),jP=function(){function t(t){this._deviceId=-1,this._connected=!1,this._deviceId=t,this._initInputSource()}t._init=function(){hs.hasFeature(os.EVENT_GAMEPAD)&&t._registerEvent()},t._on=function(e,i,n){t._eventTarget.on(e,i,n)},t._removeInputDevice=function(e){var i=t.all.findIndex((function(t){return t.deviceId===e}));-1!==i&&Li(t.all,i)},t._getOrCreateInputDevice=function(e,i){var n=t.all.find((function(t){return t.deviceId===e}));return n||(n=new t(e),t.all.push(n)),n._connected=i,n},t._ensureDirectorDefined=function(){return new Promise((function(e){t._intervalId=setInterval((function(){v.director&&v.Director&&(clearInterval(t._intervalId),t._intervalId=-1,e())}),50)}))},t._registerEvent=function(){t._ensureDirectorDefined().then((function(){v.director.on(v.Director.EVENT_BEGIN_FRAME,t._scanGamepads)})).catch((function(){})),window.addEventListener("gamepadconnected",(function(e){t._cachedWebGamepads[e.gamepad.index]=e.gamepad;var i=t._getOrCreateInputDevice(e.gamepad.index,!0);t._eventTarget.emit(cE.GAMEPAD_CHANGE,new AE(cE.GAMEPAD_CHANGE,i))})),window.addEventListener("gamepaddisconnected",(function(e){t._cachedWebGamepads[e.gamepad.index]=null;var i=t._getOrCreateInputDevice(e.gamepad.index,!1);t._removeInputDevice(e.gamepad.index),t._eventTarget.emit(cE.GAMEPAD_CHANGE,new AE(cE.GAMEPAD_CHANGE,i))}))},t._scanGamepads=function(){var e=t._getWebGamePads();if(e){for(var i=[],n=0;n<e.length;++n){var r=null==e?void 0:e[n];if(r){var s=t._cachedWebGamepads[r.index];if(s){for(var a=void 0,o=s.buttons,u=0;u<o.length;++u){var h=o[u],c=r.buttons[u];if(Math.abs(h.value-c.value)>.01){a=t._getOrCreateInputDevice(r.index,!0);break}}if(a){i.push(a);continue}for(var l=s.axes,_=0;_<l.length;++_){var d=l[_],f=r.axes[_];if(Math.abs(d-f)>.01){a=t._getOrCreateInputDevice(r.index,!0);break}}if(a){i.push(a);continue}}}}t._cachedWebGamepads=e;for(var p=0;p<i.length;++p){var m=i[p];t._eventTarget.emit(cE.GAMEPAD_INPUT,new AE(cE.GAMEPAD_INPUT,m))}}},t._getWebGamePads=function(){return"function"==typeof navigator.getGamepads?navigator.getGamepads():"function"==typeof navigator.webkitGetGamepads?navigator.webkitGetGamepads():[]},t._getWebGamepad=function(e){for(var i=t._getWebGamePads(),n=0;n<i.length;++n){var r=i[n];if(r&&r.index===e)return r}};var e=t.prototype;return e._axisToButtons=function(t){var e=Math.abs(t);return t>0?{negative:0,positive:e}:t<0?{negative:e,positive:0}:{negative:0,positive:0}},e._initInputSource=function(){var e=this;this._buttonNorth=new zP,this._buttonNorth.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[3].value:0},this._buttonEast=new zP,this._buttonEast.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[1].value:0},this._buttonWest=new zP,this._buttonWest.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[2].value:0},this._buttonSouth=new zP,this._buttonSouth.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[0].value:0},this._buttonL1=new zP,this._buttonL1.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[4].value:0},this._buttonL2=new zP,this._buttonL2.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[6].value:0},this._buttonL3=new zP,this._buttonL3.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[10].value:0},this._buttonR1=new zP,this._buttonR1.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[5].value:0},this._buttonR2=new zP,this._buttonR2.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[7].value:0},this._buttonR3=new zP,this._buttonR3.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[11].value:0},this._buttonShare=new zP,this._buttonShare.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[8].value:0},this._buttonOptions=new zP,this._buttonOptions.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[9].value:0};var i=new zP;i.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[12].value:0};var n=new zP;n.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[13].value:0};var r=new zP;r.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[14].value:0};var s=new zP;s.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?i.buttons[15].value:0},this._dpad=new HP({up:i,down:n,left:r,right:s});var a=new zP;a.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[1]).negative:0};var o=new zP;o.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[1]).positive:0};var u=new zP;u.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[0]).negative:0};var h=new zP;h.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[0]).positive:0},this._leftStick=new VP({up:a,down:o,left:u,right:h});var c=new zP;c.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[3]).negative:0};var l=new zP;l.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[3]).positive:0};var _=new zP;_.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[2]).negative:0};var d=new zP;d.getValue=function(){var i=t._getWebGamepad(e.deviceId);return i?e._axisToButtons(i.axes[2]).positive:0},this._rightStick=new VP({up:c,down:l,left:_,right:d}),this._buttonStart=new zP,this._buttonStart.getValue=function(){return 0}},s(t,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonL1",get:function(){return this._buttonL1}},{key:"buttonL2",get:function(){return this._buttonL2}},{key:"buttonL3",get:function(){return this._buttonL3}},{key:"buttonR1",get:function(){return this._buttonR1}},{key:"buttonR2",get:function(){return this._buttonR2}},{key:"buttonR3",get:function(){return this._buttonR3}},{key:"buttonShare",get:function(){return this._buttonShare}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"dpad",get:function(){return this._dpad}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"deviceId",get:function(){return this._deviceId}},{key:"connected",get:function(){return this._connected}}]),t}();jP.all=[],jP._eventTarget=new es,jP._cachedWebGamepads=[],jP._intervalId=-1;var YP,KP,qP=function(){function t(){this._eventTarget=new es,this._initInputSource()}var e=t.prototype;return e._on=function(t,e,i){this._eventTarget.on(t,e,i)},e._initInputSource=function(){this._buttonNorth=new zP,this._buttonNorth.getValue=function(){return 0},this._buttonEast=new zP,this._buttonEast.getValue=function(){return 0},this._buttonWest=new zP,this._buttonWest.getValue=function(){return 0},this._buttonSouth=new zP,this._buttonSouth.getValue=function(){return 0},this._buttonTriggerLeft=new zP,this._buttonTriggerLeft.getValue=function(){return 0},this._buttonTriggerRight=new zP,this._buttonTriggerRight.getValue=function(){return 0},this._triggerLeft=new zP,this._triggerLeft.getValue=function(){return 0},this._triggerRight=new zP,this._triggerRight.getValue=function(){return 0},this._gripLeft=new zP,this._gripLeft.getValue=function(){return 0},this._gripRight=new zP,this._gripRight.getValue=function(){return 0},this._buttonLeftStick=new zP,this._buttonLeftStick.getValue=function(){return 0};var t=new zP;t.getValue=function(){return 0};var e=new zP;e.getValue=function(){return 0};var i=new zP;i.getValue=function(){return 0};var n=new zP;n.getValue=function(){return 0},this._leftStick=new VP({up:t,down:e,left:i,right:n}),this._buttonRightStick=new zP,this._buttonRightStick.getValue=function(){return 0};var r=new zP;r.getValue=function(){return 0};var s=new zP;s.getValue=function(){return 0};var a=new zP;a.getValue=function(){return 0};var o=new zP;o.getValue=function(){return 0},this._rightStick=new VP({up:r,down:s,left:a,right:o}),this._handLeftPosition=new XP,this._handLeftPosition.getValue=function(){return js.ZERO},this._handLeftOrientation=new WP,this._handLeftOrientation.getValue=function(){return sa.IDENTITY},this._handRightPosition=new XP,this._handRightPosition.getValue=function(){return js.ZERO},this._handRightOrientation=new WP,this._handRightOrientation.getValue=function(){return sa.IDENTITY},this._aimLeftPosition=new XP,this._aimLeftPosition.getValue=function(){return js.ZERO},this._aimLeftOrientation=new WP,this._aimLeftOrientation.getValue=function(){return sa.IDENTITY},this._aimRightPosition=new XP,this._aimRightPosition.getValue=function(){return js.ZERO},this._aimRightOrientation=new WP,this._aimRightOrientation.getValue=function(){return sa.IDENTITY}},s(t,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonTriggerLeft",get:function(){return this._buttonTriggerLeft}},{key:"buttonTriggerRight",get:function(){return this._buttonTriggerRight}},{key:"triggerLeft",get:function(){return this._triggerLeft}},{key:"triggerRight",get:function(){return this._triggerRight}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonLeftStick",get:function(){return this._buttonLeftStick}},{key:"buttonRightStick",get:function(){return this._buttonRightStick}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}}]),t}(),QP=function(){function t(){this._eventTarget=new es,this._initInputSource()}var e=t.prototype;return e._on=function(t,e,i){this._eventTarget.on(t,e,i)},e._initInputSource=function(){this._viewLeftPosition=new XP,this._viewLeftPosition.getValue=function(){return js.ZERO},this._viewLeftOrientation=new WP,this._viewLeftOrientation.getValue=function(){return sa.IDENTITY},this._viewRightPosition=new XP,this._viewRightPosition.getValue=function(){return js.ZERO},this._viewRightOrientation=new WP,this._viewRightOrientation.getValue=function(){return sa.IDENTITY},this._headMiddlePosition=new XP,this._headMiddlePosition.getValue=function(){return js.ZERO},this._headMiddleOrientation=new WP,this._headMiddleOrientation.getValue=function(){return sa.IDENTITY}},s(t,[{key:"viewLeftPosition",get:function(){return this._viewLeftPosition}},{key:"viewLeftOrientation",get:function(){return this._viewLeftOrientation}},{key:"viewRightPosition",get:function(){return this._viewRightPosition}},{key:"viewRightOrientation",get:function(){return this._viewRightOrientation}},{key:"headMiddlePosition",get:function(){return this._headMiddlePosition}},{key:"headMiddleOrientation",get:function(){return this._headMiddleOrientation}}]),t}(),ZP={Backspace:SE.BACKSPACE,Tab:SE.TAB,Enter:SE.ENTER,ShiftLeft:SE.SHIFT_LEFT,ControlLeft:SE.CTRL_LEFT,AltLeft:SE.ALT_LEFT,ShiftRight:SE.SHIFT_RIGHT,ControlRight:SE.CTRL_RIGHT,AltRight:SE.ALT_RIGHT,Pause:SE.PAUSE,CapsLock:SE.CAPS_LOCK,Escape:SE.ESCAPE,Space:SE.SPACE,PageUp:SE.PAGE_UP,PageDown:SE.PAGE_DOWN,End:SE.END,Home:SE.HOME,ArrowLeft:SE.ARROW_LEFT,ArrowUp:SE.ARROW_UP,ArrowRight:SE.ARROW_RIGHT,ArrowDown:SE.ARROW_DOWN,Insert:SE.INSERT,Delete:SE.DELETE,Digit0:SE.DIGIT_0,Digit1:SE.DIGIT_1,Digit2:SE.DIGIT_2,Digit3:SE.DIGIT_3,Digit4:SE.DIGIT_4,Digit5:SE.DIGIT_5,Digit6:SE.DIGIT_6,Digit7:SE.DIGIT_7,Digit8:SE.DIGIT_8,Digit9:SE.DIGIT_9,KeyA:SE.KEY_A,KeyB:SE.KEY_B,KeyC:SE.KEY_C,KeyD:SE.KEY_D,KeyE:SE.KEY_E,KeyF:SE.KEY_F,KeyG:SE.KEY_G,KeyH:SE.KEY_H,KeyI:SE.KEY_I,KeyJ:SE.KEY_J,KeyK:SE.KEY_K,KeyL:SE.KEY_L,KeyM:SE.KEY_M,KeyN:SE.KEY_N,KeyO:SE.KEY_O,KeyP:SE.KEY_P,KeyQ:SE.KEY_Q,KeyR:SE.KEY_R,KeyS:SE.KEY_S,KeyT:SE.KEY_T,KeyU:SE.KEY_U,KeyV:SE.KEY_V,KeyW:SE.KEY_W,KeyX:SE.KEY_X,KeyY:SE.KEY_Y,KeyZ:SE.KEY_Z,Numpad0:SE.NUM_0,Numpad1:SE.NUM_1,Numpad2:SE.NUM_2,Numpad3:SE.NUM_3,Numpad4:SE.NUM_4,Numpad5:SE.NUM_5,Numpad6:SE.NUM_6,Numpad7:SE.NUM_7,Numpad8:SE.NUM_8,Numpad9:SE.NUM_9,NumpadMultiply:SE.NUM_MULTIPLY,NumpadAdd:SE.NUM_PLUS,NumpadSubtract:SE.NUM_SUBTRACT,NumpadDecimal:SE.NUM_DECIMAL,NumpadDivide:SE.NUM_DIVIDE,NumpadEnter:SE.NUM_ENTER,F1:SE.F1,F2:SE.F2,F3:SE.F3,F4:SE.F4,F5:SE.F5,F6:SE.F6,F7:SE.F7,F8:SE.F8,F9:SE.F9,F10:SE.F10,F11:SE.F11,F12:SE.F12,NumLock:SE.NUM_LOCK,ScrollLock:SE.SCROLL_LOCK,Semicolon:SE.SEMICOLON,Equal:SE.EQUAL,Comma:SE.COMMA,Minus:SE.DASH,Period:SE.PERIOD,Slash:SE.SLASH,Backquote:SE.BACK_QUOTE,BracketLeft:SE.BRACKET_LEFT,Backslash:SE.BACKSLASH,BracketRight:SE.BRACKET_RIGHT,Quote:SE.QUOTE},JP=function(){function t(){this._eventTarget=new es,this._registerEvent()}var e=t.prototype;return e.dispatchKeyboardDownEvent=function(t){this._handleKeyboardDown(t)},e.dispatchKeyboardUpEvent=function(t){this._handleKeyboardUp(t)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},e._registerEvent=function(){var t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",this._handleKeyboardDown.bind(this)),null==t||t.addEventListener("keyup",this._handleKeyboardUp.bind(this))},e._getInputEvent=function(t,e){var i,n=(i=t.code,ZP[i]||SE.NONE);return new vE(n,e)},e._handleKeyboardDown=function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var e=this._getInputEvent(t,cE.KEY_PRESSING);this._eventTarget.emit(cE.KEY_PRESSING,e)}else{var i=this._getInputEvent(t,cE.KEY_DOWN);this._eventTarget.emit(cE.KEY_DOWN,i)}},e._handleKeyboardUp=function(t){var e=this._getInputEvent(t,cE.KEY_UP);t.stopPropagation(),t.preventDefault(),this._eventTarget.emit(cE.KEY_UP,e)},t}(),$P=function(){function t(){this._canvas=void 0,this._eventTarget=new es,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Qs,this._handleMouseDown=void 0,this._handleMouseMove=void 0,this._handleMouseUp=void 0,hs.hasFeature(os.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._handleMouseDown=this._createCallback(cE.MOUSE_DOWN),this._handleMouseMove=this._createCallback(cE.MOUSE_MOVE),this._handleMouseUp=this._createCallback(cE.MOUSE_UP),this._registerEvent())}var e=t.prototype;return e.dispatchMouseDownEvent=function(t){this._handleMouseDown(t)},e.dispatchMouseMoveEvent=function(t){this._handleMouseMove(t)},e.dispatchMouseUpEvent=function(t){this._handleMouseUp(t)},e.dispatchScrollEvent=function(t){this._handleMouseWheel(t)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Ta(e.x,e.y,e.width,e.height):new Ta(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),i=Fa.devicePixelRatio,n=this._pointLocked?this._preMousePos.x/i+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/i-t.movementY:e.y+e.height-t.clientY;return new Qs(n*=i,r*=i)},e._registerEvent=function(){var t,e,i,n,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._handleMouseDown),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._handleMouseMove),window.addEventListener("mouseup",this._handleMouseUp),null===(i=this._canvas)||void 0===i||i.addEventListener("mouseup",this._handleMouseUp),null===(n=this._canvas)||void 0===n||n.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(i){var n,r=e._getLocation(i),s=i.button,a=i.buttons,o=s;switch(t){case cE.MOUSE_DOWN:null===(n=e._canvas)||void 0===n||n.focus(),e._isPressed=!0;break;case cE.MOUSE_UP:e._isPressed=!1;break;case cE.MOUSE_MOVE:o=1&a?yE.BUTTON_LEFT:2&a?yE.BUTTON_RIGHT:4&a?yE.BUTTON_MIDDLE:yE.BUTTON_MISSING}var u=new yE(t,!1,e._preMousePos);u.setLocation(r.x,r.y),u.setButton(o),u.movementX=i.movementX,u.movementY=i.movementY,e._preMousePos.set(r.x,r.y),i.stopPropagation(),i.target===e._canvas&&i.preventDefault(),e._eventTarget.emit(t,u)}},e._handleMouseWheel=function(t){var e=cE.MOUSE_WHEEL,i=this._getLocation(t),n=t.button,r=new yE(e,!1,this._preMousePos);r.setLocation(i.x,i.y),r.setButton(n),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(i.x,i.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},t}(),tD=new Qs,eD=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation(tD);var i=new bE(tD.x,tD.y,e);return t.getLocation(tD),i.setPoint(tD.x,tD.y),t.getPreviousLocation(tD),i.setPrevPoint(tD),i},e._createTouch=function(t,e,i){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var n=new bE(e,i,t);return this._touchMap.set(t,n),this._updateTouch(n,e,i),this._cloneTouch(n)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,i){var n=this._touchMap.get(t);return n?this._updateTouch(n,e,i):n=this._createTouch(t,e,i),n?this._cloneTouch(n):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(i){if(i){var n=t._cloneTouch(i);e.push(n)}})),e},e._updateTouch=function(t,e,i){t.getLocation(tD),t.setPrevPoint(tD),t.setPoint(e,i)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var i=Xn.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<i)return!1;var n=performance.now();return this._touchMap.forEach((function(t){n-t.lastModified>Xn.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),i>=this._touchMap.size},t}()),iD=function(){function t(){this._canvas=void 0,this._eventTarget=new es,hs.hasFeature(os.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,i,n;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(cE.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(cE.TOUCH_MOVE)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchend",this._createCallback(cE.TOUCH_END)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchcancel",this._createCallback(cE.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(i){for(var n,r=e._getCanvasRect(),s=[],a=i.changedTouches.length,o=0;o<a;++o){var u=i.changedTouches[o],h=u.identifier;if(null!==h){var c=e._getLocation(u,r),l=eD.getTouch(h,c.x,c.y);l&&(t!==cE.TOUCH_END&&t!==cE.TOUCH_CANCEL||eD.releaseTouch(h),s.push(l))}}if(i.stopPropagation(),i.target===e._canvas&&i.preventDefault(),t===cE.TOUCH_START&&(null===(n=e._canvas)||void 0===n||n.focus()),s.length>0){var _=new EE(s,!1,t,Xn.ENABLE_MULTI_TOUCH?eD.getAllTouches():s);e._eventTarget.emit(t,_)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new Ta(e.x,e.y,e.width,e.height):new Ta(0,0,0,0)},e._getLocation=function(t,e){var i=t.clientX-e.x,n=e.y+e.height-t.clientY;if(Fa.isFrameRotated){var r=i;i=e.height-n,n=r}var s=Fa.devicePixelRatio;return new Qs(i*=s,n*=s)},e.on=function(t,e,i){this._eventTarget.on(t,e,i)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(KP||(KP={}));var nD=function(){function t(t){this.priority=KP.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),rD=((YP={})[cE.MOUSE_DOWN]=cE.TOUCH_START,YP[cE.MOUSE_MOVE]=cE.TOUCH_MOVE,YP[cE.MOUSE_UP]=cE.TOUCH_END,YP),sD=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new es,this._touchInput=new iD,this._mouseInput=new $P,this._keyboardInput=new JP,this._accelerometerInput=new BP,this._handleInput=new qP,this._hmdInput=new QP,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._eventGamepadList=[],this._eventHandleList=[],this._eventHMDList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new nD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher),jP._init()}var e=t.prototype;return e._dispatchMouseDownEvent=function(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseDownEvent)||void 0===e||e.call(i,t)},e._dispatchMouseMoveEvent=function(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseMoveEvent)||void 0===e||e.call(i,t)},e._dispatchMouseUpEvent=function(t){var e,i;null===(e=(i=this._mouseInput).dispatchMouseUpEvent)||void 0===e||e.call(i,t)},e._dispatchMouseScrollEvent=function(t){var e,i;null===(e=(i=this._mouseInput).dispatchScrollEvent)||void 0===e||e.call(i,t)},e._dispatchKeyboardDownEvent=function(t){var e,i;null===(e=(i=this._keyboardInput).dispatchKeyboardDownEvent)||void 0===e||e.call(i,t)},e._dispatchKeyboardUpEvent=function(t){var e,i;null===(e=(i=this._keyboardInput).dispatchKeyboardUpEvent)||void 0===e||e.call(i,t)},e.on=function(t,e,i){return this._eventTarget.on(t,e,i),e},e.once=function(t,e,i){return this._eventTarget.once(t,e,i),e},e.off=function(t,e,i){this._eventTarget.off(t,e,i)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=rD[t.type],i=eD.getTouch(0,t.getLocationX(),t.getLocationY());if(i){var n=[i],r=new EE(n,!1,e,e===cE.TOUCH_END?[]:n);e===cE.TOUCH_END&&eD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,i=0;i<e&&this._eventDispatcherList[i].dispatchEvent(t);++i);},e._registerEvent=function(){var t=this;if(za.hasFeature(za.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(cE.TOUCH_START,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(cE.TOUCH_MOVE,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(cE.TOUCH_END,(function(i){t._dispatchOrPushEventTouch(i,e)})),this._touchInput.on(cE.TOUCH_CANCEL,(function(i){t._dispatchOrPushEventTouch(i,e)}))}if(za.hasFeature(za.Feature.EVENT_MOUSE)){var i=this._eventMouseList;this._mouseInput.on(cE.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(cE.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(cE.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,i)})),this._mouseInput.on(cE.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,i)}))}if(za.hasFeature(za.Feature.EVENT_KEYBOARD)){var n=this._eventKeyboardList;this._keyboardInput.on(cE.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,n)})),this._keyboardInput.on(cE.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,n)})),this._keyboardInput.on(cE.KEY_UP,(function(e){t._dispatchOrPushEvent(e,n)}))}if(za.hasFeature(za.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(cE.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}if(za.hasFeature(za.Feature.EVENT_GAMEPAD)){var s=this._eventGamepadList;jP._on(cE.GAMEPAD_CHANGE,(function(e){t._dispatchOrPushEvent(e,s)})),jP._on(cE.GAMEPAD_INPUT,(function(e){t._dispatchOrPushEvent(e,s)}))}if(za.hasFeature(za.Feature.EVENT_HANDLE)){var a=this._eventHandleList;this._handleInput._on(cE.HANDLE_INPUT,(function(e){t._dispatchOrPushEvent(e,a)})),this._handleInput._on(cE.HANDLE_POSE_INPUT,(function(e){t._dispatchOrPushEvent(e,a)}))}if(za.hasFeature(za.Feature.EVENT_HMD)){var o=this._eventHMDList;this._hmdInput._on(cE.HMD_POSE_INPUT,(function(e){t._dispatchOrPushEvent(e,o)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0,this._eventGamepadList.length=0,this._eventHandleList.length=0,this._eventHMDList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var i=t.getTouches(),n=i.length,r=0;r<n;++r)t.touch=i[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,i=t.length;e<i;++e){var n=t[e];this._emitEvent(n)}for(var r=this._eventTouchList,s=0,a=r.length;s<a;++s)for(var o=r[s],u=o.getTouches(),h=u.length,c=0;c<h;++c)o.touch=u[c],o.propagationStopped=o.propagationImmediateStopped=!1,this._emitEvent(o);for(var l=this._eventKeyboardList,_=0,d=l.length;_<d;++_){var f=l[_];this._emitEvent(f)}for(var p=this._eventAccelerationList,m=0,g=p.length;m<g;++m){var v=p[m];this._emitEvent(v)}for(var y=this._eventGamepadList,T=0,E=y.length;T<E;++T){var S=y[T];this._emitEvent(S)}for(var A=this._eventHandleList,R=0,w=A.length;R<w;++R){var b=A[R];this._emitEvent(b)}for(var O=this._eventHMDList,M=0,I=O.length;M<I;++M){var C=O[M];this._emitEvent(C)}this._clearEvents()},t}());sD.EventType=cE;var aD=t("input",new sD),oD=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,aD.on(cE.MOUSE_DOWN,(function(t){e.emit(hE.MOUSE_DOWN,t)})),aD.on(cE.MOUSE_MOVE,(function(t){e.emit(hE.MOUSE_MOVE,t)})),aD.on(cE.MOUSE_UP,(function(t){e.emit(hE.MOUSE_UP,t)})),aD.on(cE.MOUSE_WHEEL,(function(t){e.emit(hE.MOUSE_WHEEL,t)})),aD.on(cE.TOUCH_START,(function(t){e.emit(hE.TOUCH_START,t.touch,t)})),aD.on(cE.TOUCH_MOVE,(function(t){e.emit(hE.TOUCH_MOVE,t.touch,t)})),aD.on(cE.TOUCH_END,(function(t){e.emit(hE.TOUCH_END,t.touch,t)})),aD.on(cE.TOUCH_CANCEL,(function(t){e.emit(hE.TOUCH_CANCEL,t.touch,t)})),aD.on(cE.KEY_DOWN,(function(t){e.emit(hE.KEY_DOWN,t)})),aD.on(cE.KEY_PRESSING,(function(t){e.emit(hE.KEY_DOWN,t)})),aD.on(cE.KEY_UP,(function(t){e.emit(hE.KEY_UP,t)})),aD.on(cE.DEVICEMOTION,(function(t){e.emit(hE.DEVICEMOTION,t)})),e}o(e,t);var i=e.prototype;return i.setAccelerometerEnabled=function(t){aD.setAccelerometerEnabled(t)},i.setAccelerometerInterval=function(t){aD.setAccelerometerInterval(t)},i.on=function(e,i,n,r){return t.prototype.on.call(this,e,i,n,r),i},i.off=function(e,i,n){t.prototype.off.call(this,e,i,n)},e}(es));oD.EventType=hE,v.SystemEvent=oD;var uD,hD=t("systemEvent",new oD);v.systemEvent=hD;var cD=((uD={})[Ca.PORTRAIT]=$.IDENTITY,uD[Ca.LANDSCAPE_RIGHT]=$.ROTATE_90,uD[Ca.PORTRAIT_UPSIDE_DOWN]=$.ROTATE_180,uD[Ca.LANDSCAPE_LEFT]=$.ROTATE_270,uD),lD=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._device=t,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._swapchain=e.swapchain,this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var i=0;i<e.renderPassInfo.colorAttachments.length;i++)this._colorTextures.push(t.createTexture(new le(ut.TEX2D,ht.COLOR_ATTACHMENT|ht.SAMPLED|ht.TRANSFER_SRC,e.renderPassInfo.colorAttachments[i].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==et.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new le(ut.TEX2D,ht.DEPTH_STENCIL_ATTACHMENT|ht.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=t.createFramebuffer(new Pe(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._device=null},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,cD[Fa.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var i=0;i<this._colorTextures.length;i++)this._colorTextures[i].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new Pe(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,r=p(this._cameras);!(n=r()).done;)n.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},s(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}}]),t}(),_D=t("Root",function(){function t(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=null,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new kI,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=v.internal.DataPoolManager&&new v.internal.DataPoolManager(t),cM.registerCreateFunc(this),lD.registerCreateFunc(this),this._cameraPool=new Hi((function(){return new av(e._device)}),4,(function(t){return t.destroy()}))}var e=t.prototype;return e.initialize=function(){var t,e=Wa.swapchain,i=new be;i.format=e.colorTexture.format;var n=new Oe;n.format=e.depthStencilTexture.format,n.depthStoreOp=At.DISCARD,n.stencilStoreOp=At.DISCARD;var r=new Ce([i],n);this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:r,swapchain:e}),this._curWindow=this._mainWindow;var s=Wn.querySettings(Vn.Category.ANIMATION,"customJointTextureLayouts")||[];null===(t=this._dataPoolMgr)||void 0===t||t.jointTexturePool.registerCustomTextureLayouts(s),this._resizeMaxJointForDS()},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear()},e.resize=function(t,e){for(var i,n=p(this._windows);!(i=n()).done;){var r=i.value;r.swapchain&&r.resize(t,e)}},e.setRenderPipeline=function(t){t instanceof MP&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=IP(),e=!0),this._useDeferredPipeline&&this.device.hasFeature(tt.COMPUTE_SHADER)||(t.clusterEnabled=!1),t.bloomEnabled=!1,this.usesCustomPipeline&&v.internal.createCustomPipeline?(this._customPipeline=v.internal.createCustomPipeline(),e=!0,this._pipeline=this._customPipeline):(this._classicPipeline=t,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1),!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var i=v.director.getScene();return i&&i.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&v.internal.Batcher2D&&(this._batcher=new v.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.onGlobalPipelineStateChanged()},e.activeWindow=function(t){this._curWindow=t},e.resetCumulativeTime=function(){this._cumulativeTime=0},e.frameMove=function(t){this._frameTime=t,++this._frameCount,this._cumulativeTime+=t,this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var i=this._windows,n=[],r=0;r<i.length;r++)i[r].extractRenderCameras(n);if(this._pipeline&&n.length>0){this._device.acquire([Wa.swapchain]);var s=this._scenes,a=v.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var o=0;o<s.length;o++)s[o].update(a);v.director.emit(v.Director.EVENT_BEFORE_COMMIT),n.sort((function(t,e){return t.priority-e.priority}));for(var u=0;u<n.length;++u){var h;null===(h=n[u].geometryRenderer)||void 0===h||h.update()}this._pipeline.render(n),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},e.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},e.destroyWindows=function(){for(var t,e=p(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},e.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},e.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},e.destroyScenes=function(){for(var t,e=p(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},e.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new Hi((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var i=e.alloc();return i.initialize(),i},e.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):G(1300,t.constructor.name),t.destroy()},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new Hi((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var i=e.alloc();return i.initialize(),i},e.destroyLight=function(t){if(t.scene)switch(t.type){case lO.DIRECTIONAL:t.scene.removeDirectionalLight(t);break;case lO.SPHERE:t.scene.removeSphereLight(t);break;case lO.SPOT:t.scene.removeSpotLight(t)}t.destroy()},e.recycleLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case lO.DIRECTIONAL:t.scene.removeDirectionalLight(t);break;case lO.SPHERE:t.scene.removeSphereLight(t);break;case lO.SPOT:t.scene.removeSpotLight(t)}},e._resizeMaxJointForDS=function(){var t=Math.floor((Wa.gfxDevice.capabilities.maxVertexUniformVectors-38)/3);Cm(t=t<256?t:256)},s(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline&&""!==Xn.CUSTOM_PIPELINE_NAME}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}());v.Root=_D;var dD=new Xi("Scheduler"),fD=function(t,e,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=n};fD.get=function(t,e,i,n){var r=fD._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=i,r.markedForDeletion=n):r=new fD(t,e,i,n),r},fD.put=function(t){fD._listEntries.length<20&&(t.target=null,fD._listEntries.push(t))},fD._listEntries=[];var pD=function(t,e,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=n};pD.get=function(t,e,i,n){var r=pD._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=i,r.callback=n):r=new pD(t,e,i,n),r},pD.put=function(t){pD._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,pD._hashUpdateEntries.push(t))},pD._hashUpdateEntries=[];var mD=function(t,e,i,n,r,s){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=r,this.paused=s};mD.get=function(t,e,i,n,r,s){var a=mD._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=i,a.currentTimer=n,a.currentTimerSalvaged=r,a.paused=s):a=new mD(t,e,i,n,r,s),a},mD.put=function(t){mD._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,mD._hashTimerEntries.push(t))},mD._hashTimerEntries=[];var gD=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,i,n,r,s){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._elapsed=-1,this._interval=n,this._delay=s,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===v.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();gD._timers=[],gD.get=function(){return gD._timers.pop()||new gD},gD.put=function(t){gD._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,gD._timers.push(t))};var vD=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=rn(!0),e._hashForTimers=rn(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}o(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?G(1513):t.id=dD.getNewId())};var i=e.prototype;return i.setTimeScale=function(t){this._timeScale=t},i.getTimeScale=function(){return this._timeScale},i.update=function(t){var e,i,n,r,s;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,n=(i=this._updatesNegList).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,n=(i=this._updates0List).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,n=(i=this._updatesPosList).length;e<n;e++)(r=i[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(s=a[e],this._currentTarget=s,this._currentTargetSalvaged=!1,!s.paused)for(s.timerIndex=0;s.timerIndex<s.timers.length;++s.timerIndex)s.currentTimer=s.timers[s.timerIndex],s.currentTimerSalvaged=!1,s.currentTimer.update(t),s.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updates0List;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,i=this._updatesPosList;e<i.length;)(r=i[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},i.schedule=function(t,e,i,n,r,s){if("function"!=typeof t){var a=t;t=e,e=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(s=!!n,n=v.macro.REPEAT_FOREVER,r=0),W(e,1502);var o=e.uuid||e.id;if(o){var u,h,c=this._hashForTimers[o];if(c?c.paused!==s&&G(1511):(c=mD.get(null,e,0,null,null,s),this._arrayForTimers.push(c),this._hashForTimers[o]=c),null==c.timers)c.timers=[];else for(h=0;h<c.timers.length;++h)if((u=c.timers[h])&&t===u._callback)return L(1507,u.getInterval(),i),void(u._interval=i);(u=gD.get()).initWithCallback(this,t,e,i,n,r),c.timers.push(u),this._currentTarget===c&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else z(1510)},i.scheduleUpdate=function(t,e,i){var n=t.uuid||t.id;if(n){var r=this._hashForUpdates[n];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=i);if(this._updateHashLocked)return L(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=i);this.unscheduleUpdate(t)}var s,a=fD.get(t,e,i,!1);0===e?(s=this._updates0List,this._appendIn(s,a)):(s=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(s,a,e)),this._hashForUpdates[n]=pD.get(s,a,t,null)}else z(1510)},i.unschedule=function(t,e){if(e&&t){var i=e.uuid||e.id;if(i){var n=this._hashForTimers[i];if(n)for(var r=n.timers,s=0,a=r.length;s<a;s++){var o=r[s];if(t===o._callback)return o!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),r.splice(s,1),gD.put(o),n.timerIndex>=s&&n.timerIndex--,void(0===r.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}else z(1510)}},i.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var i=this._hashForUpdates[e];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}else z(1510)}},i.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];if(i){var n=i.timers;n.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(var r=0,s=n.length;r<s;r++)gD.put(n[r]);n.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}else z(1510)}},i.unscheduleAll=function(){this.unscheduleAllWithMinPriority(zp.Priority.SCHEDULER)},i.unscheduleAllWithMinPriority=function(t){var e,i,n,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)i=r[e],this.unscheduleAllForTarget(i.target);var s=0;if(t<0)for(e=0;e<this._updatesNegList.length;)s=this._updatesNegList.length,(n=this._updatesNegList[e])&&n.priority>=t&&this.unscheduleUpdate(n.target),s===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)s=this._updates0List.length,(n=this._updates0List[e])&&this.unscheduleUpdate(n.target),s===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)s=this._updatesPosList.length,(n=this._updatesPosList[e])&&n.priority>=t&&this.unscheduleUpdate(n.target),s===this._updatesPosList.length&&e++},i.isScheduled=function(t,e){W(t,1508),W(e,1509);var i=e.uuid||e.id;if(!i)return z(1510),!1;var n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;for(var r=n.timers,s=0;s<r.length;++s)if(t===r[s]._callback)return!0;return!1},i.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(zp.Priority.SCHEDULER)},i.pauseAllTargetsWithMinPriority=function(t){var e,i,n,r,s=[],a=this._arrayForTimers;for(i=0,n=a.length;i<n;i++)(e=a[i])&&(e.paused=!0,s.push(e.target));if(t<0)for(i=0;i<this._updatesNegList.length;i++)(r=this._updatesNegList[i])&&r.priority>=t&&(r.paused=!0,s.push(r.target));if(t<=0)for(i=0;i<this._updates0List.length;i++)(r=this._updates0List[i])&&(r.paused=!0,s.push(r.target));for(i=0;i<this._updatesPosList.length;i++)(r=this._updatesPosList[i])&&r.priority>=t&&(r.paused=!0,s.push(r.target));return s},i.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},i.pauseTarget=function(t){W(t,1503);var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];i&&(i.paused=!0);var n=this._hashForUpdates[e];n&&(n.entry.paused=!0)}else z(1510)},i.resumeTarget=function(t){W(t,1504);var e=t.uuid||t.id;if(e){var i=this._hashForTimers[e];i&&(i.paused=!1);var n=this._hashForUpdates[e];n&&(n.entry.paused=!1)}else z(1510)},i.isTargetPaused=function(t){W(t,1505);var e=t.uuid||t.id;if(!e)return z(1510),!1;var i=this._hashForTimers[e];if(i)return i.paused;var n=this._hashForUpdates[e];return!!n&&n.entry.paused},i._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var i=this._arrayForTimers,n=0,r=i.length;n<r;n++)if(i[n]===t){i.splice(n,1);break}mD.put(t)},i._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,i=this._hashForUpdates[e];if(i){for(var n=i.list,r=i.entry,s=0,a=n.length;s<a;s++)if(n[s]===r){n.splice(s,1);break}delete this._hashForUpdates[e],fD.put(r),pD.put(i)}},i._priorityIn=function(t,e,i){for(var n=0;n<t.length;n++)if(i<t[n].priority)return void t.splice(n,0,e);t.push(e)},i._appendIn=function(t,e){t.push(e)},e}(zp));vD.ID="scheduler",v.Scheduler=vD;var yD=new(function(){function t(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}var e=t.prototype;return e.addRenderer=function(t){-1===t._internalId&&(t._internalId=this._allRenderers.length,this._allRenderers.push(t))},e.removeRenderer=function(t){if(-1!==t._internalId){var e=t._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=e,Dn.array.fastRemoveAt(this._allRenderers,e),t._internalId=-1,t._dirtyVersion===this._dirtyVersion&&(Dn.array.fastRemove(this._dirtyRenderers,t),t._dirtyVersion=-1)}},e.markDirtyRenderer=function(t){t._dirtyVersion!==this._dirtyVersion&&-1!==t._internalId&&(this._dirtyRenderers.push(t),t._dirtyVersion=this._dirtyVersion)},e.updateAllDirtyRenderers=function(){for(var t=this._dirtyRenderers.length,e=this._dirtyRenderers,i=0;i<t;i++)e[i].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++},t}()),TD=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._persistRootNodes={},e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new vD,e._compScheduler=new UR,e._nodeActivator=new sb,e._systems=[],e}o(e,t);var i=e.prototype;return i.calculateDeltaTime=function(){},i.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},i.pause=function(){this._paused||(this._paused=!0)},i.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),v.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),v.assetManager.releaseAll()},i.reset=function(){var t;for(var i in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[i]);null===(t=this.getScene())||void 0===t||t.destroy(),this.emit(e.EVENT_RESET),this.startAnimation()},i.runSceneImmediate=function(t,i,n){var r=this;t instanceof Mb&&(t=t.scene),W(t instanceof AR,1216),t._load();for(var s=Object.keys(this._persistRootNodes).map((function(t){return r._persistRootNodes[t]})),a=0;a<s.length;a++){var o=s[a];o.emit(kp.EventType.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var u=t.uuid===o._originalSceneId&&t.getChildByUuid(o.uuid);if(u){var h=u.getSiblingIndex();o.hideFlags&=~Vr.Flags.DontSave,o.hideFlags|=Vr.Flags.DontSave&u.hideFlags,u._destroyImmediate(),t.insertChild(o,h)}else o.hideFlags|=Vr.Flags.DontSave,o.parent=t}var c=this._scene;v.isValid(c)&&c.destroy(),v.assetManager._releaseManager._autoRelease(c,t,this._persistRootNodes),this._scene=null,Vr._deferredDestroy(),i&&i(),this.emit(e.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(e.EVENT_AFTER_SCENE_LAUNCH,t)},i.runScene=function(t,i,n){var r=this;t instanceof Mb&&(t=t.scene),W(t,1205),W(t instanceof AR,1216),this.once(e.EVENT_END_FRAME,(function(){r.runSceneImmediate(t,i,n)}))},i.loadScene=function(t,i,n){var r=this;if(this._loadingScene)return G(1208,t,this._loadingScene),!1;var s=v.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return s?(this.emit(e.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("phase LoadScene "+t),s.loadScene(t,(function(e,s){console.timeEnd("phase LoadScene "+t),r._loadingScene="",e?(C(e),i&&i(e)):r.runSceneImmediate(s,n,i)})),!0):(z(1209,t),!1)},i.preloadScene=function(t,e,i){var n=v.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(n)n.preloadScene(t,null,e,i);else{var r='Can not preload the scene "'+t+'" because it is not in the build settings.';i&&i(new Error(r)),C("preloadScene: "+r)}},i.resume=function(){this._paused&&(this._paused=!1)},i.getScene=function(){return this._scene},i.getDeltaTime=function(){return v.game.deltaTime},i.getTotalTime=function(){return v.game.totalTime},i.getCurrentTime=function(){return v.game.frameStartTime},i.getTotalFrames=function(){return this._totalFrames},i.isPaused=function(){return this._paused},i.getScheduler=function(){return this._scheduler},i.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(vD.ID,t,200))},i.registerSystem=function(t,e,i){e.id=t,e.priority=i,this._systems.push(e),this._systems.sort(zp.sortByPriority)},i.unregisterSystem=function(t){Dn.array.fastRemove(this._systems,t),this._systems.sort(zp.sortByPriority)},i.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},i.getAnimationManager=function(){return this.getSystem(v.AnimationManager.ID)},i.startAnimation=function(){this._invalid=!1},i.stopAnimation=function(){this._invalid=!0},i.mainLoop=function(t){var e;e=v.game._calculateDT(t),this.tick(e)},i.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),aD._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var i=0;i<this._systems.length;++i)this._systems[i].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),Vr._deferredDestroy();for(var n=0;n<this._systems.length;++n)this._systems[n].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),yD.updateAllDirtyRenderers(),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),kp.resetHasChangedFlags(),kp.clearNodeArray(),ki.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},i.init=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(vD.ID,this._scheduler,200),this._root=new _D(Wa.gfxDevice),console.time("phase 9.1.1"),this._root.initialize({}),console.timeEnd("phase 9.1.1"),console.time("phase 9.1.2");for(var t=0;t<this._systems.length;t++)this._systems[t].init();console.timeEnd("phase 9.1.2"),this.emit(e.EVENT_INIT)},i.addPersistRootNode=function(t){if(v.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var i=this._scene;if(v.isValid(i))if(t.parent){if(!(t.parent instanceof AR))return void G(3801);if(t.parent!==i)return void G(3802);t._originalSceneId=i.uuid}else t.parent=i,t._originalSceneId=i.uuid;this._persistRootNodes[e]=t,t._persistNode=!0,v.assetManager._releaseManager._addPersistNodeRef(t)}}else G(3800)},i.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",v.assetManager._releaseManager._removePersistNodeRef(t))},i.isPersistRootNode=function(t){return!!t._persistNode},s(e,[{key:"root",get:function(){return this._root}}]),e}(es));TD.EVENT_INIT="director_init",TD.EVENT_RESET="director_reset",TD.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",TD.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",TD.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",TD.EVENT_BEFORE_UPDATE="director_before_update",TD.EVENT_AFTER_UPDATE="director_after_update",TD.EVENT_BEFORE_DRAW="director_before_draw",TD.EVENT_AFTER_DRAW="director_after_draw",TD.EVENT_BEFORE_COMMIT="director_before_commit",TD.EVENT_BEFORE_PHYSICS="director_before_physics",TD.EVENT_AFTER_PHYSICS="director_after_physics",TD.EVENT_BEGIN_FRAME="director_begin_frame",TD.EVENT_END_FRAME="director_end_frame",TD.instance=void 0,v.Director=TD;var ED,SD=t("director",TD.instance=v.director=new TD),AD=new va,RD=((ED={})[Xn.ORIENTATION_AUTO]=Ca.AUTO,ED[Xn.ORIENTATION_LANDSCAPE]=Ca.LANDSCAPE,ED[Xn.ORIENTATION_PORTRAIT]=Ca.PORTRAIT,ED),wD=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var i=bD,n=OD;return e._designResolutionSize=new va(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new Ta(0,0,0,0),e._visibleRect=new Ta(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new MD(i.EQUAL_TO_FRAME,n.EXACT_FIT),e._rpShowAll=new MD(i.EQUAL_TO_FRAME,n.SHOW_ALL),e._rpNoBorder=new MD(i.EQUAL_TO_FRAME,n.NO_BORDER),e._rpFixedHeight=new MD(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),e._rpFixedWidth=new MD(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}o(e,t);var i=e.prototype;return i.init=function(){var t=Ua.windowSize,e=t.width,i=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=i,this._viewportRect.width=e,this._viewportRect.height=i,this._visibleRect.width=e,this._visibleRect.height=i,AD.width=this._visibleRect.width,AD.height=this._visibleRect.height,NP&&NP.init(this._visibleRect),this.resizeWithBrowserSize(!0);var n=Wn.querySettings(Vn.Category.SCREEN,"designResolution");n&&(console.time("phase 9.1.2.1"),this.setDesignResolutionSize(Number(n.width),Number(n.height),n.policy||MD.FIXED_HEIGHT),console.timeEnd("phase 9.1.2.1")),Fa.on("window-resize",this._updateAdaptResult,this),Fa.on("orientation-change",this._updateAdaptResult,this),Fa.on("fullscreen-change",this._updateAdaptResult,this)},i.resizeWithBrowserSize=function(t){Fa.handleResizeEvent=t},i.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},i.setOrientation=function(t){Fa.orientation=RD[t]},i.adjustViewportMeta=function(){},i.enableRetina=function(t){this._retinaEnabled=!!t},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&Ua.requestFullScreen().catch((function(){})))},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(t,e){Fa.resolutionScale=1;var i=Fa.devicePixelRatio,n=new va(t*i,e*i);Ua.windowSize=n},i.getCanvasSize=function(){return Ua.windowSize},i.getFrameSize=function(){var t=Fa.devicePixelRatio,e=Ua.windowSize;return e.width/=t,e.height/=t,e},i.setFrameSize=function(t,e){var i=Fa.devicePixelRatio;Ua.windowSize=new va(t*i,e*i)},i.getVisibleSize=function(){return new va(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new va(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new Qs(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new Qs(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i._updateResolutionPolicy=function(t){if(t instanceof MD)this._resolutionPolicy=t;else{var e=MD;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=ID.getDesignResolutionSize();ID.setDesignResolutionSize(e.width,e.height,t)},i.setDesignResolutionSize=function(t,e,i){if(t>0&&e>0){this._updateResolutionPolicy(i);var n=this._resolutionPolicy;n&&n.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=n.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var s=this._viewportRect,a=this._visibleRect,o=r.viewport;s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,a.x=0,a.y=0,a.width=o.width/this._scaleX,a.height=o.height/this._scaleY}n.postApply(this),AD.width=this._visibleRect.width,AD.height=this._visibleRect.height,NP&&NP.init(this._visibleRect),this.emit("design-resolution-changed")}else z(2200)},i.getDesignResolutionSize=function(){return new va(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(t,e,i){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return Fa.devicePixelRatio},i.convertToLocationInView=function(t,e,i,n){void 0===n&&(n=new Qs);var r=Fa.devicePixelRatio*(t-i.left),s=Fa.devicePixelRatio*(i.top+i.height-e);return Fa.isFrameRotated?(n.x=Ua.windowSize.width-s,n.y=r):(n.x=r,n.y=s),n},i._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},i._updateAdaptResult=function(){var t;v.director.root.resize(Ua.windowSize.width,Ua.windowSize.height);var e=this._designResolutionSize.width,i=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,i,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(ts(zp)));wD.instance=void 0;var bD=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=v.game.canvas;if(t){var e=Ua.windowSize;t.width!==e.width&&(t.width=e.width),t.height!==e.height&&(t.height=e.height)}},t}();bD.EQUAL_TO_FRAME=void 0,bD.PROPORTION_TO_FRAME=void 0;var OD=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,i,n,r,s){Math.abs(t-i)<2&&(i=t),Math.abs(e-n)<2&&(n=e);var a=new Ta(Math.round((t-i)/2),Math.round((e-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result},t}();OD.EXACT_FIT=void 0,OD.SHOW_ALL=void 0,OD.NO_BORDER=void 0,OD.FIXED_HEIGHT=void 0,OD.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="EqualToFrame",e}return o(e,t),e.prototype.apply=function(){Fa.isProportionalToFrame=!1,this._setupCanvas()},e}(bD),e=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ProportionalToFrame",e}return o(e,t),e.prototype.apply=function(){Fa.isProportionalToFrame=!0,this._setupCanvas()},e}(bD);bD.EQUAL_TO_FRAME=new t,bD.PROPORTION_TO_FRAME=new e;var i=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ExactFit",e}return o(e,t),e.prototype.apply=function(t,e){var i=Ua.windowSize,n=i.width,r=i.height,s=n/e.width,a=r/e.height;return this._buildResult(n,r,n,r,s,a)},e}(OD),n=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="ShowAll",e}return o(e,t),e.prototype.apply=function(t,e){var i,n,r=Ua.windowSize,s=r.width,a=r.height,o=e.width,u=e.height,h=s/o,c=a/u,l=0;return h<c?(i=s,n=u*(l=h)):(i=o*(l=c),n=a),this._buildResult(s,a,i,n,l,l)},e}(OD),r=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="NoBorder",e}return o(e,t),e.prototype.apply=function(t,e){var i,n,r,s=Ua.windowSize,a=s.width,o=s.height,u=e.width,h=e.height,c=a/u,l=o/h;return c<l?(n=u*(i=l),r=o):(n=a,r=h*(i=c)),this._buildResult(a,o,n,r,i,i)},e}(OD),s=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="FixedHeight",e}return o(e,t),e.prototype.apply=function(t,e){var i=Ua.windowSize,n=i.width,r=i.height,s=r/e.height,a=n,o=r;return this._buildResult(n,r,a,o,s,s)},e}(OD),a=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).name="FixedWidth",e}return o(e,t),e.prototype.apply=function(t,e){var i=Ua.windowSize,n=i.width,r=i.height,s=n/e.width,a=n,o=r;return this._buildResult(n,r,a,o,s,s)},e}(OD);OD.EXACT_FIT=new i,OD.SHOW_ALL=new n,OD.NO_BORDER=new r,OD.FIXED_HEIGHT=new s,OD.FIXED_WIDTH=new a}();var MD=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof bD&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof OD&&(this._contentStrategy=t)},s(t,[{key:"canvasSize",get:function(){return Ua.windowSize}}]),t}());MD.EXACT_FIT=0,MD.NO_BORDER=1,MD.SHOW_ALL=2,MD.FIXED_HEIGHT=3,MD.FIXED_WIDTH=4,MD.UNKNOWN=5,MD.ContainerStrategy=bD,MD.ContentStrategy=OD,v.ResolutionPolicy=MD;var ID=t("view",wD.instance=v.view=new wD);SD.registerSystem("view",ID,0),v.winSize=AD;var CD=function(){function t(){this._rafHandle=0,this._stHandle=0,this._onTick=null,this._targetFrameRate=60,this._frameTime=0,this._startTime=0,this._isPlaying=!1,this._rAF=void 0,this._cAF=void 0,this._rAF=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||this._stTime.bind(this),this._cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime.bind(this)}var e=t.prototype;return e.start=function(){var t=this;this._isPlaying||(60===this._targetFrameRate?this._rafHandle=this._rAF.call(window,(function e(){t._isPlaying&&(t._rafHandle=t._rAF.call(window,e)),t._onTick&&t._onTick()})):(this._startTime=performance.now(),this._stHandle=this._stTime((function e(){t._startTime=performance.now(),t._isPlaying&&(t._stHandle=t._stTime(e)),t._onTick&&t._onTick()}))),this._isPlaying=!0)},e.stop=function(){this._isPlaying&&(this._cAF.call(window,this._rafHandle),this._ctTime(this._stHandle),this._rafHandle=this._stHandle=0,this._isPlaying=!1)},e._stTime=function(t){var e=performance.now(),i=Math.max(0,e-this._startTime),n=Math.max(0,this._frameTime-i);return setTimeout(t,n)},e._ctTime=function(t){clearTimeout(t)},s(t,[{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(t){this._targetFrameRate!==t&&(this._targetFrameRate=t,this._frameTime=1e3/this._targetFrameRate,this._isPlaying&&(this.stop(),this.start()))}},{key:"onTick",get:function(){return this._onTick},set:function(t){this._onTick=t}}]),t}(),xD=t("Game",function(t){function i(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._pacer=null,e._initTime=0,e._startTime=0,e._deltaTime=0,e._shouldLoadLaunchScene=!0,e.onPreBaseInitDelegate=new us,e.onPostBaseInitDelegate=new us,e.onPreInfrastructureInitDelegate=new us,e.onPostInfrastructureInitDelegate=new us,e.onPreSubsystemInitDelegate=new us,e.onPostSubsystemInitDelegate=new us,e.onPreProjectInitDelegate=new us,e.onPostProjectInitDelegate=new us,e}o(i,t);var n=i.prototype;return n.setFrameRate=function(t){this.frameRate=t},n.getFrameRate=function(){return this.frameRate},n.step=function(){SD.tick(this.frameTime/1e3)},n.pause=function(){var t;this._paused||(this._paused=!0,null===(t=this._pacer)||void 0===t||t.stop())},n.resume=function(){var t;this._paused&&(aD._clearEvents(),this._paused=!1,null===(t=this._pacer)||void 0===t||t.start())},n.isPaused=function(){return this._paused},n.restart=function(){var t=this;return new Promise((function(t){SD.once(TD.EVENT_END_FRAME,(function(){return t()}))})).then((function(){SD.reset(),v.Object._deferredDestroy(),t.pause(),t.resume(),t._shouldLoadLaunchScene=!0,t._safeEmit(i.EVENT_RESTART)}))},n.end=function(){hs.close()},n.on=function(t,e,n,r){return(this._engineInited&&t===i.EVENT_ENGINE_INITED||this._inited&&t===i.EVENT_GAME_INITED||this._rendererInitialized&&t===i.EVENT_RENDERER_INITED)&&e.call(n),this.eventTargetOn(t,e,n,r)},n.once=function(t,e,n){return this._engineInited&&t===i.EVENT_ENGINE_INITED?e.call(n):this.eventTargetOnce(t,e,n)},n.init=function(t){var n=this;return this._compatibleWithOldParams(t),Promise.resolve().then((function(){return n.emit(i.EVENT_PRE_BASE_INIT),n.onPreBaseInitDelegate.dispatch()})).then((function(){B(t.debugMode||H.NONE),za.init(),n._initEvents()})).then((function(){return console.time("phase 4"),Wn.init(t.settingsPath,t.overrideSettings)})).then((function(){return console.timeEnd("phase 4"),n.emit(i.EVENT_POST_BASE_INIT),n.onPostBaseInitDelegate.dispatch()})).then((function(){return n.emit(i.EVENT_PRE_INFRASTRUCTURE_INIT),n.onPreInfrastructureInitDelegate.dispatch()})).then((function(){console.time("phase 6"),Xn.init(),n._initXR();var t={frame:document.querySelector("#GameDiv"),container:document.querySelector("#Cocos3dGameContainer"),canvas:document.querySelector("#GameCanvas")};t&&(n.canvas=t.canvas,n.frame=t.frame,n.container=t.container),Ua.init(),kt.init(),console.time("phase 6.5"),console.time("phase resize canvas");var e=n.canvas;if(e){var i=Ua.windowSize;e.width!==i.width&&(e.width=i.width),e.height!==i.height&&(e.height=i.height)}console.timeEnd("phase resize canvas"),Wa.init(n.canvas,nm),console.timeEnd("phase 6.5"),RT.init(),console.time("phase 6.7"),IT.init(),console.timeEnd("phase 6.7"),$f.init(),n.initPacer()})).then((function(){return console.timeEnd("phase 6"),n.emit(i.EVENT_POST_INFRASTRUCTURE_INIT),n.onPostInfrastructureInitDelegate.dispatch()})).then((function(){return n.emit(i.EVENT_PRE_SUBSYSTEM_INIT),n.onPreSubsystemInitDelegate.dispatch()})).then((function(){return console.time("phase 9"),console.time("phase 9.1"),SD.init(),console.timeEnd("phase 9.1"),console.time("phase 9.2"),IT.loadBuiltinAssets()})).then((function(){return console.timeEnd("phase 9"),n.emit(i.EVENT_POST_SUBSYSTEM_INIT),n.onPostSubsystemInitDelegate.dispatch()})).then((function(){M("Cocos Creator v"+y),n.emit(i.EVENT_ENGINE_INITED),n._engineInited=!0})).then((function(){return n.emit(i.EVENT_PRE_PROJECT_INIT),n.onPreProjectInitDelegate.dispatch()})).then((function(){var t=Wn.querySettings(Vn.Category.PLUGINS,"jsList"),e=Promise.resolve();return t&&(Wn.querySettings(Vn.Category.PATH,"projectPath"),t.forEach((function(t){e=e.then((function(){return e="src/"+t,new Promise((function(t,i){var n;function r(t){t.filename===e&&(n=t.error)}window.addEventListener("error",r);var s=document.createElement("script");s.charset="utf-8",s.async=!0,s.crossOrigin="anonymous",s.addEventListener("error",(function(){window.removeEventListener("error",r),i(Error("Error loading "+e))})),s.addEventListener("load",(function(){window.removeEventListener("error",r),document.head.removeChild(s),n?i(n):t()})),s.src=e.replace("#","%23"),document.head.appendChild(s)}));var e}))}))),e})).then((function(){console.time("phase 14"),console.time("phase 14.1");var t=Wn.querySettings(Vn.Category.SCRIPTING,"scriptPackages");return t?Promise.all(t.map((function(t){return e.import(t)}))):Promise.resolve([])})).then((function(){return console.timeEnd("phase 14.1"),console.time("phase 14.2"),n._loadProjectBundles()})).then((function(){return console.timeEnd("phase 14.2"),n._loadCCEScripts()})).then((function(){return console.time("phase 14.4"),n._setupRenderPipeline()})).then((function(){return console.timeEnd("phase 14.4"),n._loadPreloadAssets()})).then((function(){return console.timeEnd("phase 14"),IT.compileBuiltinMaterial(),n.emit(i.EVENT_POST_PROJECT_INIT),n.onPostProjectInitDelegate.dispatch()})).then((function(){n._inited=!0,n._safeEmit(i.EVENT_GAME_INITED)}))},n._initXR=function(){if(za.isXR){var t,e;xr.entry=xr.XrEntry.getInstance();var i=null!==(t=Wn.querySettings(Vn.Category.RENDERING,"msaa"))&&void 0!==t?t:1,n=null!==(e=Wn.querySettings(Vn.Category.RENDERING,"renderingScale"))&&void 0!==e?e:1;xr.entry.setMultisamplesRTT(i),xr.entry.setRenderingScale(n)}},n._compatibleWithOldParams=function(t){var e=t.overrideSettings=t.overrideSettings||{};"showFPS"in t&&(e.profiling=e.profiling||{},e.profiling.showFPS=t.showFPS),"frameRate"in t&&(e.screen=e.screen||{},e.screen.frameRate=t.frameRate),"renderMode"in t&&(e.rendering=e.rendering||{},e.rendering.renderMode=t.renderMode),"renderPipeline"in t&&(e.rendering=e.rendering||{},e.rendering.renderPipeline=t.renderPipeline),"assetOptions"in t&&(e.assets=e.assets||{},Object.assign(e.assets,t.assetOptions)),"customJointTextureLayouts"in t&&(e.animation=e.animation||{},e.animation.customJointTextureLayouts=t.customJointTextureLayouts),"physics"in t&&(e.physics=e.physics||{},Object.assign(e.physics,t.physics)),"orientation"in t&&(e.screen=e.screen||{},e.screen.orientation=t.orientation),"exactFitScreen"in t&&(e.screen=e.screen||{},e.screen.exactFitScreen=t.exactFitScreen)},n._loadPreloadAssets=function(){var t=Wn.querySettings(Vn.Category.ASSETS,"preloadAssets");return t?Promise.all(t.map((function(t){return new Promise((function(e,i){RT.loadAny(t,(function(t){t?i(t):e()}))}))}))):Promise.resolve([])},n._loadCCEScripts=function(){return new Promise((function(t){t()}))},n._loadProjectBundles=function(){var t=Wn.querySettings(Vn.Category.ASSETS,"preloadBundles");return t?Promise.all(t.map((function(t){var e=t.bundle,i=t.version;return new Promise((function(t,n){console.time("phase 14.2.3");var r={};i&&(r.version=i),RT.loadBundle(e,r,(function(e){e?n(e):(console.timeEnd("phase 14.2.3"),t())}))}))}))):Promise.resolve([])},n.run=function(t){t&&(this.onStart=t),this._inited&&this.resume()},n._calculateDT=function(){var t=performance.now();return this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>i.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},n._updateCallback=function(){var t=this;if(this._inited)if(this._shouldLoadLaunchScene){this._shouldLoadLaunchScene=!1;var e,i=Wn.querySettings(Vn.Category.LAUNCH,"launchScene");i?SD.loadScene(i,(function(){var e;console.log("Success to load scene: "+i),t._initTime=performance.now(),t._startTime=performance.now(),SD.startAnimation(),null===(e=t.onStart)||void 0===e||e.call(t)})):(this._initTime=performance.now(),SD.startAnimation(),null===(e=this.onStart)||void 0===e||e.call(this))}else{var n=this._calculateDT(),r=1/60;SD.tick(n>r?r:n)}},n.initPacer=function(){var t,e=null!==(t=Wn.querySettings(Vn.Category.SCREEN,"frameRate"))&&void 0!==t?t:60;x("number"==typeof e),this._pacer=new CD,this._pacer.onTick=this._updateCallback.bind(this),this.frameRate=e},n._initEvents=function(){hs.on("show",this._onShow,this),hs.on("hide",this._onHide,this)},n._onHide=function(){this.emit(i.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(i.EVENT_SHOW),this.resume()},n.addPersistRootNode=function(t){SD.addPersistRootNode(t)},n.removePersistRootNode=function(t){SD.removePersistRootNode(t)},n.isPersistRootNode=function(t){return SD.isPersistRootNode(t)},n._setupRenderPipeline=function(){var t=this,e=Wn.querySettings(Vn.Category.RENDERING,"renderPipeline");return e?new Promise((function(t,i){RT.loadAny(e,(function(e,n){return!e&&n instanceof eN?t(n):i(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(i){I(i),I("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},n._setRenderPipeline=function(t){SD.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(i.EVENT_RENDERER_INITED)},n._safeEmit=function(t){this.emit(t)},s(i,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._pacer&&(this._pacer.targetFrameRate=this._frameRate)}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),i}(es));xD.EVENT_HIDE="game_on_hide",xD.EVENT_SHOW="game_on_show",xD.EVENT_LOW_MEMORY="game_on_low_memory",xD.EVENT_GAME_INITED="game_inited",xD.EVENT_ENGINE_INITED="engine_inited",xD.EVENT_RENDERER_INITED="renderer_inited",xD.EVENT_PRE_BASE_INIT="pre_base_init",xD.EVENT_POST_BASE_INIT="post_base_init",xD.EVENT_PRE_INFRASTRUCTURE_INIT="pre_infrastructure_init",xD.EVENT_POST_INFRASTRUCTURE_INIT="post_infrastructure_init",xD.EVENT_PRE_SUBSYSTEM_INIT="pre_subsystem_init",xD.EVENT_POST_SUBSYSTEM_INIT="post_subsystem_init",xD.EVENT_PRE_PROJECT_INIT="pre_project_init",xD.EVENT_POST_PROJECT_INIT="post_project_init",xD.EVENT_RESTART="game_on_restart",xD.RENDER_TYPE_CANVAS=0,xD.RENDER_TYPE_WEBGL=1,xD.RENDER_TYPE_OPENGL=2,xD.RENDER_TYPE_HEADLESS=3,xD.DEBUG_DT_THRESHOLD=1,v.Game=xD,t("game",v.game=new xD);var ND,BD,PD,DD,FD,LD=function(t,e,i,n,r,s,a){void 0===t&&(t=""),void 0===e&&(e=2),void 0===i&&(i=0),void 0===n&&(n=St.LOAD),void 0===r&&(r=At.STORE),void 0===s&&(s=Lt.ALL),void 0===a&&(a=new ie),this.slotName=void 0,this.accessType=void 0,this.attachmentType=void 0,this.loadOp=void 0,this.storeOp=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.slotName=t,this.accessType=e,this.attachmentType=i,this.loadOp=n,this.storeOp=r,this.clearFlags=s,this.clearColor=a},UD=function(){this.name="",this.accessType=0,this.clearFlags=Lt.NONE,this.clearColor=new ie,this.clearValueType=0},GD=function(t,e){void 0===t&&(t=null),void 0===e&&(e=0),this.light=void 0,this.level=void 0,this.light=t,this.level=e},kD=function(){},zD=(o((function(){return FD.apply(this,arguments)||this}),FD=kD),o((function(){return DD.apply(this,arguments)||this}),DD=kD),o((function(){return PD.apply(this,arguments)||this}),PD=kD),o((function(){return BD.apply(this,arguments)||this}),BD=kD),o((function(){return ND.apply(this,arguments)||this}),ND=function(){}),function(){});function HD(t,e,i,n,r){void 0===n&&(n=null),void 0===r&&(r=0);var s=new Kt,a=t.viewport,o=e,u=i;if(s.x=a.x*o,s.y=a.y*u,s.width=a.width*o,s.height=a.height*u,n)switch(n.type){case lO.DIRECTIONAL:var h=n;h.shadowFixedArea||h.csmLevel===QE.LEVEL_1?(s.x=0,s.y=0,s.width=o,s.height=u):(s.x=r%2*.5*o,s.y=.5*(1-Math.floor(r/2))*u,s.width=.5*o,s.height=.5*u);break;case lO.SPOT:s.x=0,s.y=0,s.width=o,s.height=u}return s}function VD(t,e,i,n,r,s,a){var o=e.device,u=t;if(!e.containsResource(u)){var h=mg(o)?et.R32F:et.RGBA8;e.addRenderTarget(u,h,s,a,0),e.addDepthStencil(u+"Depth",et.DEPTH_STENCIL,s,a,0)}var c=e.addRasterPass(s,a,"default",t);c.addRasterView(u,new LD("_",2,0,St.CLEAR,At.STORE,Lt.COLOR,new ie(1,1,1,i.clearColor.w))),c.addRasterView(u+"Depth",new LD("_",2,1,St.CLEAR,At.DISCARD,Lt.DEPTH_STENCIL,new ie(i.clearDepth,i.clearStencil,0,0)));var l=HD(i,s,a,n,r);c.setViewport(new ee(l.x,l.y,l.width,l.height)),c.addQueue(1).addSceneOfCamera(i,new GD(n,r),8)}var WD=function(){this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array};function XD(t,e,i){var n=i,r=n.pipelineSceneData.shadows,s=i.pipelineSceneData.validPunctualLights,a=new WD,o=i.pipelineSceneData.shadows;if(!r.enabled||r.type!==KE.ShadowMap)return a;a.shadowEnabled=!0;for(var u=[],h=0,c=0;h<r.maxReceived&&c<s.length;){var l=s[c];l.type===lO.SPOT&&l.shadowEnabled&&(u.push(l),h++),c++}var _=e.scene.mainLight,d=o.size.x,f=o.size.y;if(_&&_.shadowEnabled)if(a.mainLightShadowNames[0]="MainLightShadow"+t,_.shadowFixedArea)VD(a.mainLightShadowNames[0],i,e,_,0,d,f);else for(var p=n.pipelineSceneData.csmSupported?_.csmLevel:1,m=0;m<p;m++)a.mainLightShadowNames[m]="MainLightShadow"+t,VD(a.mainLightShadowNames[m],i,e,_,m,d,f);for(var g=0;g<u.length;g++){var v=u[g],y="SpotLightShadow"+g.toString()+t;a.spotLightShadowNames[g]=y,VD(y,i,e,v,0,d,f)}return a}var jD,YD=[];function KD(t){return YD.includes(t)||YD.push(t),YD.indexOf(t)}function qD(t,e){var i=St.CLEAR;return t&Lt.COLOR||0!==e||(i=t&rv?St.DISCARD:St.LOAD),(t&Lt.DEPTH_STENCIL)!==Lt.DEPTH_STENCIL&&1===e&&(t&Lt.DEPTH||(i=St.LOAD),t&Lt.STENCIL||(i=St.LOAD)),i}t("ForwardPipelineBuilder",function(t){function e(){return t.apply(this,arguments)||this}return o(e,t),e.prototype.setup=function(t,e){for(var i=0;i<t.length;i++){var n=t[i];if(null!==n.scene){YF(e,n);var r=KD(n),s="Camera"+r,a=XD(s,n,e),o=n.window.width,u=n.window.height,h="dsForwardPassColor"+s,c="dsForwardPassDS"+s;e.containsResource(h)||(e.addRenderTexture(h,et.RGBA8,o,u,n.window),e.addDepthStencil(c,et.DEPTH_STENCIL,o,u,0));for(var l,_=e.addRasterPass(o,u,"default","CameraForwardPass"+r),d=p(a.mainLightShadowNames);!(l=d()).done;){var f=l.value;if(e.containsResource(f)){var m=new UD;_.addComputeView(f,m)}}for(var g,v=p(a.spotLightShadowNames);!(g=v()).done;){var y=g.value;if(e.containsResource(y)){var T=new UD;_.addComputeView(y,T)}}var E=new LD("_",2,0,qD(n.clearFlag,0),At.STORE,n.clearFlag,new ie(n.clearColor.x,n.clearColor.y,n.clearColor.z,n.clearColor.w)),S=new LD("_",2,1,qD(n.clearFlag,1),At.STORE,n.clearFlag,new ie(n.clearDepth,n.clearStencil,0,0));_.addRasterView(h,E),_.addRasterView(c,S),_.addQueue(1).addSceneOfCamera(n,new GD,291),_.addQueue(3).addSceneOfCamera(n,new GD,1556)}}},e}(zD)),function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(jD||(jD=t("AntiAliasing",{})));var QD,ZD,JD,$D,tF,eF,iF,nF,rF,sF,aF,oF,uF,hF,cF,lF,_F,dF,fF,pF,mF,gF,vF,yF,TF,EF,SF,AF,RF,wF,bF,OF,MF,IF,CF,xF,NF,BF,PF,DF,FF,LF,UF,GF,kF,zF,HF,VF,WF,XF,jF=function(){this._deferredLightingMaterial=void 0,this._deferredPostMaterial=void 0,this._antiAliasing=jD.NONE,this._deferredLightingMaterial=new $T,this._deferredLightingMaterial.name="builtin-deferred-material",this._deferredLightingMaterial.initialize({effectName:"pipeline/deferred-lighting",defines:{CC_RECEIVE_SHADOW:1}});for(var t=0;t<this._deferredLightingMaterial.passes.length;++t)this._deferredLightingMaterial.passes[t].tryCompile();this._deferredPostMaterial=new $T,this._deferredPostMaterial.name="builtin-post-process-material",Xn.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=jD.FXAA),this._deferredPostMaterial.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var e=0;e<this._deferredPostMaterial.passes.length;++e)this._deferredPostMaterial.passes[e].tryCompile()};function YF(t,e){var i=t.pipelineSceneData.validPunctualLights;i.length=0;for(var n=Hu.create(0,0,0,1),r=e.scene.spotLights,s=0;s<r.length;s++){var a=r[s];a.baked||(Hu.set(n,a.position.x,a.position.y,a.position.z,a.range),jh.sphereFrustum(n,e.frustum)&&i.push(a))}for(var o=e.scene.sphereLights,u=0;u<o.length;u++){var h=o[u];h.baked||(Hu.set(n,h.position.x,h.position.y,h.position.z,h.range),jh.sphereFrustum(n,e.frustum)&&i.push(h))}}t("DeferredPipelineBuilder",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._deferredData=new jF,e}return o(e,t),e.prototype.setup=function(t,e){for(var i=0;i<t.length;++i){var n=t[i];if(n.scene){YF(e,n);var r=KD(n),s=XD("Camera"+r,n,e),a=n.window.width,o=n.window.height,u="dsDeferredPassColorCamera",h="deferredGbufferPassNormal",c="deferredGbufferPassEmissive",l="dsDeferredPassDSCamera";if(!e.containsResource(u)){var _=et.RGBA16F;e.addRenderTarget(u,_,a,o,0),e.addRenderTarget(h,_,a,o,0),e.addRenderTarget(c,_,a,o,0),e.addDepthStencil(l,et.DEPTH_STENCIL,a,o,0)}var d=e.addRasterPass(a,o,"Geometry","CameraGbufferPass"+r),f=new ie(0,0,0,0);n.clearFlag&Lt.COLOR&&(e.pipelineSceneData.isHDR?kT(f,n.clearColor):(f.x=n.clearColor.x,f.y=n.clearColor.y,f.z=n.clearColor.z));var m=new LD("_",2,0,St.CLEAR,At.STORE,n.clearFlag,f),g=new LD("_",2,0,St.CLEAR,At.STORE,n.clearFlag,new ie(0,0,0,0)),v=new LD("_",2,0,St.CLEAR,At.STORE,n.clearFlag,new ie(0,0,0,0)),y=new LD("_",2,1,St.CLEAR,At.STORE,n.clearFlag,new ie(n.clearDepth,n.clearStencil,0,0));d.addRasterView(u,m),d.addRasterView(h,g),d.addRasterView(c,v),d.addRasterView(l,y),d.addQueue(1).addSceneOfCamera(n,new GD,3);var T="deferredLightingPassRTName";e.containsResource(T)||(e.addRenderTarget(T,et.RGBA8,a,o,0),e.addDepthStencil("deferredLightingPassDS",et.DEPTH_STENCIL,a,o,0));for(var E,S=e.addRasterPass(a,o,"Lighting","CameraLightingPass"+r),A=p(s.mainLightShadowNames);!(E=A()).done;){var R=E.value;if(e.containsResource(R)){var w=new UD;S.addComputeView(R,w)}}for(var b,O=p(s.spotLightShadowNames);!(b=O()).done;){var M=b.value;if(e.containsResource(M)){var I=new UD;S.addComputeView(M,I)}}if(e.containsResource(u)){var C=new UD;C.name="gbuffer_albedoMap",S.addComputeView(u,C);var x=new UD;x.name="gbuffer_normalMap",S.addComputeView(h,x);var N=new UD;N.name="gbuffer_emissiveMap",S.addComputeView(c,N);var B=new UD;B.name="depth_stencil",S.addComputeView(l,B)}var P=new ie(0,0,0,0);n.clearFlag&Lt.COLOR&&(P.x=n.clearColor.x,P.y=n.clearColor.y,P.z=n.clearColor.z),P.w=0;var D=new LD("_",2,0,St.CLEAR,At.STORE,n.clearFlag,P);S.addRasterView(T,D),S.addQueue(3).addCameraQuad(n,this._deferredData._deferredLightingMaterial,64),S.addQueue(3).addSceneOfCamera(n,new GD,772);var F="postprocessPassRTName"+r,L="postprocessPassDS"+r;e.containsResource(F)||(e.addRenderTexture(F,et.RGBA8,a,o,n.window),e.addDepthStencil(L,et.DEPTH_STENCIL,a,o,0));var U=e.addRasterPass(a,o,"Postprocess","CameraPostprocessPass"+r);if(e.containsResource(T)){var G=new UD;G.name="outputResultMap",U.addComputeView(T,G)}var k=new ie(0,0,0,n.clearColor.w);n.clearFlag&Lt.COLOR&&(k.x=n.clearColor.x,k.y=n.clearColor.y,k.z=n.clearColor.z);var z=new LD("_",2,0,qD(n.clearFlag,0),At.STORE,n.clearFlag,k),H=new LD("_",2,1,qD(n.clearFlag,1),At.STORE,n.clearFlag,new ie(n.clearDepth,n.clearStencil,0,0));U.addRasterView(F,z),U.addRasterView(L,H),U.addQueue(0).addFullscreenQuad(this._deferredData._deferredPostMaterial,0),U.addQueue(3).addSceneOfCamera(n,new GD,1040)}}},e}(zD)),v.math=Ba,v.geometry=Zd,t("DirectionalLight",(QD=ao("cc.DirectionalLight"),ZD=go("_illuminance"),JD=co({group:{name:"DynamicShadowSettings",displayOrder:1}}),$D=xo(pr),tF=co({group:{name:"DynamicShadowSettings",displayOrder:5}}),eF=xo(qE),iF=co({group:{name:"DynamicShadowSettings",displayOrder:6}}),nF=xo(fr),rF=co({group:{name:"DynamicShadowSettings",displayOrder:7}}),sF=xo(fr),aF=co({group:{name:"DynamicShadowSettings",displayOrder:8}}),oF=xo(fr),uF=co({group:{name:"DynamicShadowSettings",displayOrder:9}}),hF=xo(fr),cF=co({group:{name:"DynamicShadowSettings",displayOrder:10}}),lF=xo(fr),_F=co({group:{name:"DynamicShadowSettings",displayOrder:11}}),dF=xo(QE),fF=co({group:{name:"DynamicShadowSettings",displayOrder:12}}),pF=xo(pr),mF=co({group:{name:"DynamicShadowSettings",displayOrder:13}}),gF=xo(fr),vF=co({group:{name:"DynamicShadowSettings",displayOrder:14}}),yF=xo(ZE),TF=co({group:{name:"DynamicShadowSettings",displayOrder:15}}),EF=xo(pr),SF=co({group:{name:"DynamicShadowSettings",displayOrder:16}}),AF=xo(fr),RF=co({group:{name:"DynamicShadowSettings",displayOrder:17}}),wF=xo(fr),bF=co({group:{name:"DynamicShadowSettings",displayOrder:18}}),OF=xo(fr),QD((IF=function(t){function e(){var e;return(e=t.call(this)||this)._illuminanceHDR=CF&&CF(),e._illuminanceLDR=xF&&xF(),e._shadowEnabled=NF&&NF(),e._shadowPcf=BF&&BF(),e._shadowBias=PF&&PF(),e._shadowNormalBias=DF&&DF(),e._shadowSaturation=FF&&FF(),e._shadowDistance=LF&&LF(),e._shadowInvisibleOcclusionRange=UF&&UF(),e._csmLevel=GF&&GF(),e._csmLayerLambda=kF&&kF(),e._csmOptimizationMode=zF&&zF(),e._shadowFixedArea=HF&&HF(),e._shadowNear=VF&&VF(),e._shadowFar=WF&&WF(),e._shadowOrthoSize=XF&&XF(),e._type=lO.DIRECTIONAL,e._light=null,e._lightType=AO,e}return o(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias,this._light.shadowSaturation=this._shadowSaturation,this._light.shadowDistance=this._shadowDistance,this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,this._light.shadowFixedArea=this._shadowFixedArea,this._light.shadowNear=this._shadowNear,this._light.shadowFar=this._shadowFar,this._light.shadowOrthoSize=this._shadowOrthoSize,this._light.csmLevel=this._csmLevel,this._light.csmLayerLambda=this._csmLayerLambda,this._light.csmOptimizationMode=this._csmOptimizationMode)},s(e,[{key:"illuminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled=t,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(t){this._shadowPcf=t,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(t){this._shadowSaturation=As(t,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,$E.MAX_FAR),this._shadowDistance/.1<10&&G(15003,this._shadowDistance),this._light&&(this._light.shadowDistance=this._shadowDistance,this._light.csmNeedUpdate=!0)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(t){this._shadowInvisibleOcclusionRange=Math.min(t,$E.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(t){this._csmLevel=t,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"enableCSM",get:function(){return this._csmLevel>QE.LEVEL_1},set:function(t){this._csmLevel=t?QE.LEVEL_4:QE.LEVEL_1,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(t){this._csmLayerLambda=t,this._light&&(this._light.csmLayerLambda=this._csmLayerLambda,this._light.csmNeedUpdate=!0)}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(t){this._csmOptimizationMode=t,this._light&&(this._light.csmOptimizationMode=this._csmOptimizationMode)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(t){this._shadowFixedArea=t,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(t){this._shadowNear=t,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(t){this._shadowFar=Math.min(t,$E.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(t){this._shadowOrthoSize=t,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}}]),e}(wI),CF=Za(IF.prototype,"_illuminanceHDR",[co,ZD],(function(){return 65e3})),xF=Za(IF.prototype,"_illuminanceLDR",[mo],(function(){return 65e3*av.standardExposureValue})),NF=Za(IF.prototype,"_shadowEnabled",[mo],(function(){return!1})),BF=Za(IF.prototype,"_shadowPcf",[mo],(function(){return qE.HARD})),PF=Za(IF.prototype,"_shadowBias",[mo],(function(){return 1e-5})),DF=Za(IF.prototype,"_shadowNormalBias",[mo],(function(){return 0})),FF=Za(IF.prototype,"_shadowSaturation",[mo],(function(){return 1})),LF=Za(IF.prototype,"_shadowDistance",[mo],(function(){return 50})),UF=Za(IF.prototype,"_shadowInvisibleOcclusionRange",[mo],(function(){return 200})),GF=Za(IF.prototype,"_csmLevel",[mo],(function(){return QE.LEVEL_4})),kF=Za(IF.prototype,"_csmLayerLambda",[mo],(function(){return.75})),zF=Za(IF.prototype,"_csmOptimizationMode",[mo],(function(){return ZE.RemoveDuplicates})),HF=Za(IF.prototype,"_shadowFixedArea",[mo],(function(){return!1})),VF=Za(IF.prototype,"_shadowNear",[mo],(function(){return.1})),WF=Za(IF.prototype,"_shadowFar",[mo],(function(){return 10})),XF=Za(IF.prototype,"_shadowOrthoSize",[mo],(function(){return 5})),m(IF.prototype,"shadowEnabled",[JD,$D],Object.getOwnPropertyDescriptor(IF.prototype,"shadowEnabled"),IF.prototype),m(IF.prototype,"shadowPcf",[tF,eF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowPcf"),IF.prototype),m(IF.prototype,"shadowBias",[iF,nF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowBias"),IF.prototype),m(IF.prototype,"shadowNormalBias",[rF,sF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowNormalBias"),IF.prototype),m(IF.prototype,"shadowSaturation",[aF,oF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowSaturation"),IF.prototype),m(IF.prototype,"shadowDistance",[uF,hF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowDistance"),IF.prototype),m(IF.prototype,"shadowInvisibleOcclusionRange",[cF,lF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowInvisibleOcclusionRange"),IF.prototype),m(IF.prototype,"csmLevel",[_F,dF],Object.getOwnPropertyDescriptor(IF.prototype,"csmLevel"),IF.prototype),m(IF.prototype,"enableCSM",[fF,pF],Object.getOwnPropertyDescriptor(IF.prototype,"enableCSM"),IF.prototype),m(IF.prototype,"csmLayerLambda",[mF,gF],Object.getOwnPropertyDescriptor(IF.prototype,"csmLayerLambda"),IF.prototype),m(IF.prototype,"csmOptimizationMode",[vF,yF],Object.getOwnPropertyDescriptor(IF.prototype,"csmOptimizationMode"),IF.prototype),m(IF.prototype,"shadowFixedArea",[TF,EF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowFixedArea"),IF.prototype),m(IF.prototype,"shadowNear",[SF,AF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowNear"),IF.prototype),m(IF.prototype,"shadowFar",[RF,wF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowFar"),IF.prototype),m(IF.prototype,"shadowOrthoSize",[bF,OF],Object.getOwnPropertyDescriptor(IF.prototype,"shadowOrthoSize"),IF.prototype),MF=IF))||MF)),t("SphereLight",(KF=ao("cc.SphereLight"),qF=go("_luminance"),QF=xo(AI),KF((JF=function(t){function e(){var e;return(e=t.call(this)||this)._size=$F&&$F(),e._luminanceHDR=tL&&tL(),e._luminanceLDR=eL&&eL(),e._term=iL&&iL(),e._range=nL&&nL(),e._type=lO.SPHERE,e._light=null,e._lightType=RO,e}return o(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},s(e,[{key:"luminousFlux",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yO(this._size):this._luminanceLDR},set:function(t){var e=0;v.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yO(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(wI),$F=Za(JF.prototype,"_size",[mo],(function(){return.15})),tL=Za(JF.prototype,"_luminanceHDR",[mo,qF],(function(){return 1700/yO(.15)})),eL=Za(JF.prototype,"_luminanceLDR",[mo],(function(){return 1700/yO(.15)*av.standardExposureValue*av.standardLightMeterScale})),iL=Za(JF.prototype,"_term",[mo],(function(){return AI.LUMINOUS_FLUX})),nL=Za(JF.prototype,"_range",[mo],(function(){return 1})),m(JF.prototype,"term",[QF],Object.getOwnPropertyDescriptor(JF.prototype,"term"),JF.prototype),ZF=JF))||ZF)),t("SpotLight",(rL=ao("cc.SpotLight"),sL=go("_luminance"),aL=xo(AI),oL=co({group:{name:"DynamicShadowSettings",displayOrder:1}}),uL=xo(pr),hL=co({group:{name:"DynamicShadowSettings",displayOrder:2}}),cL=xo(qE),lL=co({group:{name:"DynamicShadowSettings",displayOrder:3}}),_L=xo(fr),dL=co({group:{name:"DynamicShadowSettings",displayOrder:4}}),fL=xo(fr),rL((mL=function(t){function e(){var e;return(e=t.call(this)||this)._size=gL&&gL(),e._luminanceHDR=vL&&vL(),e._luminanceLDR=yL&&yL(),e._term=TL&&TL(),e._range=EL&&EL(),e._spotAngle=SL&&SL(),e._shadowEnabled=AL&&AL(),e._shadowPcf=RL&&RL(),e._shadowBias=wL&&wL(),e._shadowNormalBias=bL&&bL(),e._type=lO.SPOT,e._light=null,e._lightType=xO,e}return o(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR,this._light.shadowEnabled=this._shadowEnabled,this._light.shadowPcf=this._shadowPcf,this._light.shadowBias=this._shadowBias,this._light.shadowNormalBias=this._shadowNormalBias)},s(e,[{key:"luminousFlux",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*yO(this._size):this._luminanceLDR},set:function(t){var e=0;v.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/yO(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return v.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){v.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=bs(t))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(t){this._shadowEnabled=t,this._light&&(this._light.shadowEnabled=t)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(t){this._shadowPcf=t,this._light&&(this._light.shadowPcf=t)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(t){this._shadowBias=t,this._light&&(this._light.shadowBias=t)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(t){this._shadowNormalBias=t,this._light&&(this._light.shadowNormalBias=t)}}]),e}(wI),gL=Za(mL.prototype,"_size",[mo],(function(){return.15})),vL=Za(mL.prototype,"_luminanceHDR",[mo,sL],(function(){return 1700/yO(.15)})),yL=Za(mL.prototype,"_luminanceLDR",[mo],(function(){return 1700/yO(.15)*av.standardExposureValue*av.standardLightMeterScale})),TL=Za(mL.prototype,"_term",[mo],(function(){return AI.LUMINOUS_FLUX})),EL=Za(mL.prototype,"_range",[mo],(function(){return 1})),SL=Za(mL.prototype,"_spotAngle",[mo],(function(){return 60})),AL=Za(mL.prototype,"_shadowEnabled",[mo],(function(){return!1})),RL=Za(mL.prototype,"_shadowPcf",[mo],(function(){return qE.HARD})),wL=Za(mL.prototype,"_shadowBias",[mo],(function(){return 1e-5})),bL=Za(mL.prototype,"_shadowNormalBias",[mo],(function(){return 0})),m(mL.prototype,"term",[aL],Object.getOwnPropertyDescriptor(mL.prototype,"term"),mL.prototype),m(mL.prototype,"shadowEnabled",[oL,uL],Object.getOwnPropertyDescriptor(mL.prototype,"shadowEnabled"),mL.prototype),m(mL.prototype,"shadowPcf",[hL,cL],Object.getOwnPropertyDescriptor(mL.prototype,"shadowPcf"),mL.prototype),m(mL.prototype,"shadowBias",[lL,_L],Object.getOwnPropertyDescriptor(mL.prototype,"shadowBias"),mL.prototype),m(mL.prototype,"shadowNormalBias",[dL,fL],Object.getOwnPropertyDescriptor(mL.prototype,"shadowNormalBias"),mL.prototype),pL=mL))||pL));var KF,qF,QF,ZF,JF,$F,tL,eL,iL,nL,rL,sL,aL,oL,uL,hL,cL,lL,_L,dL,fL,pL,mL,gL,vL,yL,TL,EL,SL,AL,RL,wL,bL,OL=Symbol("BakeNodeCurves"),ML=function(){function t(){}return t.getOrExtract=function(e){var i=t.pool.get(e);if(!i||i.samples!==e.sample){i&&v.director.root.dataPoolManager.releaseAnimationClip(e);var n=Math.ceil(e.sample*e.duration)+1,r=e.sample;i=e[OL](0,r,n),t.pool.set(e,i)}return i},t.destroy=function(e){t.pool.delete(e)},t}();ML.pool=new Map;var IL=new da;function CL(t,e,i){for(da.identity(i);t!==e;)da.fromRTS(IL,t.rotation,t.position,t.scale),da.multiply(i,IL,i),t=t.parent;return i}var xL=new de(ft.POINT,ft.POINT,ft.NONE,pt.CLAMP,pt.CLAMP,pt.CLAMP),NL=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function BL(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new sa,new sa,new js,new sa,new js;var PL=new js,DL=new js,FL=new js,LL=new js,UL=new da,GL=new da,kL=new sc,zL=Number.MAX_SAFE_INTEGER,HL=(function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.getFormatFeatures(et.RGBA32F)&lt.SAMPLED_TEXTURE?et.RGBA32F:et.RGBA8}(this._device);this._formatSize=Ke[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new WO(t),this._pool.initialize({format:e,roundUpFn:BL}),this._customPool=new WO(t),this._customPool.initialize({format:e,roundUpFn:BL})}var e=t.prototype;e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var i=t[e],n=this._customPool.createChunk(i.textureLength),r=0;r<i.contents.length;r++){var s=i.contents[r],a=s.skeleton;this._chunkIdxMap.set(a,n);for(var o=0;o<s.clips.length;o++){var u=s.clips[o];this._chunkIdxMap.set(a^u,n)}}},e.getDefaultPoseTexture=function(t,e,i){var n=0^t.hash,r=this._textureBuffers.get(n)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var s=t.joints,a=t.bindposes,o=null,u=!1,h=s.length;if(r)r.refCount++;else{var c=12*h,l=this._chunkIdxMap.get(n),_=void 0!==l?this._customPool.alloc(c*Float32Array.BYTES_PER_ELEMENT,l):this._pool.alloc(c*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:_},o=new Float32Array(c),u=!0}js.set(FL,zL,zL,zL),js.set(LL,-zL,-zL,-zL);for(var d=e.getBoneSpaceBounds(t),f=0,p=0;f<h;f++,p+=12){var m=i.getChildByPath(s[f]),g=m?CL(m,i,UL):t.inverseBindposes[f],v=d[f];v&&(sc.transform(kL,v,g),kL.getBoundary(PL,DL),js.min(FL,FL,PL),js.max(LL,LL,DL)),u&&(m&&da.multiply(g,g,a[f]),NL(o,p,m?g:da.IDENTITY))}var y=[new sc];return r.bounds.set(e.hash,y),sc.fromPoints(y[0],FL,LL),u&&(this._pool.update(r.handle,o.buffer),this._textureBuffers.set(n,r)),r},e.getSequencePoseTexture=function(t,e,i,n){var r=t.hash^e.hash,s=this._textureBuffers.get(r)||null;if(s&&s.bounds.has(i.hash))return s.refCount++,s;var a=t.joints,o=t.bindposes,u=ML.getOrExtract(e).frames,h=null,c=!1,l=a.length;if(s)s.refCount++;else{var _=12*l*u,d=this._chunkIdxMap.get(r),f=void 0!==d?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,d):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!f)return null;var p=this._createAnimInfos(t,e,n);s={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:f,animInfos:p},h=new Float32Array(_),c=!0}var m=i.getBoneSpaceBounds(t),g=[];s.bounds.set(i.hash,g);for(var v=0;v<u;v++)g.push(new sc(zL,zL,zL,-zL,-zL,-zL));for(var y=0,T=0;y<u;y++){for(var E=g[y],S=0;S<l;S++,T+=12){var A=s.animInfos[S],R=A.curveData,w=A.downstream,b=A.bindposeIdx,O=A.bindposeCorrection,M=void 0,I=!0;R&&w?M=da.multiply(UL,R[y],w):R?M=R[y]:w?M=w:(M=t.inverseBindposes[b],I=!1);var C=m[S];if(C){var x=O?da.multiply(GL,M,O):M;sc.transform(kL,C,x),kL.getBoundary(PL,DL),js.min(E.center,E.center,PL),js.max(E.halfExtents,E.halfExtents,DL)}c&&(I&&da.multiply(UL,M,o[b]),NL(h,T,I?UL:da.IDENTITY))}sc.fromPoints(E,E.center,E.halfExtents)}return c&&(this._pool.update(s.handle,h.buffer),this._textureBuffers.set(r,s)),s},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e._createAnimInfos=function(t,e,i){for(var n=[],r=t.joints,s=t.bindposes,a=r.length,o=ML.getOrExtract(e),u=0;u<a;u++){for(var h=r[u],c=o.joints[h],l=i.getChildByPath(h),_=void 0,d=void 0;!c;){var f=h.lastIndexOf("/");if(h=h.substring(0,f),c=o.joints[h],l?(_||(_=new da),da.fromRTS(UL,l.rotation,l.position,l.scale),da.multiply(_,UL,_),l=l.parent):d=h,f<0)break}var p=u,m=void 0;if(void 0!==d&&c){p=u-1;for(var g=0;g<a;g++)if(r[g]===d){p=g,m=new da,da.multiply(m,s[g],t.inverseBindposes[u]);break}}n.push({curveData:c&&c.transforms,downstream:_,bindposeIdx:p,bindposeCorrection:m})}return n},s(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}])}(),[]),VL=new Map;function WL(t,e){for(var i=0,n=da.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){n=t.world,t.stamp=e;break}t.stamp=e,HL[i++]=t,t=t.parent}for(;i>0;){t=HL[--i],HL[i]=null;var r=t.node;da.fromRTS(t.local,r.rotation,r.position,r.scale),n=da.multiply(t.world,n,t.local)}return n}function XL(t,e){for(var i,n=null,r=0;t!==e;){var s=t.uuid;if(VL.has(s)){n=VL.get(s);break}n={node:t,local:new da,world:new da,stamp:-1,parent:null},VL.set(s,n),HL[r++]=n,t=t.parent,n=null}for(;r>0;)i=HL[--r],HL[r]=null,i.parent=n,n=i;return n}function jL(t){for(var e=VL.get(t.uuid)||null;e;)VL.delete(e.node.uuid),e=e.parent}var YL=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!1}],KL=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!0}];function qL(t,e,i,n){for(var r=0;r<i.length;r++){for(var s=i[r],a=-1,o=0;o<s.length;o++)if(s[o]===n){a=o;break}a>=0&&(e.push(r),t.push(a))}}var QL=new js,ZL=new js,JL=new js,$L=new js,tU=new da,eU=new sc,iU=function(){this._format=cf.RGBA32F,this._textures=[],this._buffers=[]};iU.WIDTH=256,iU.HEIGHT=3;var nU,rU,sU,aU,oU,uU,hU,cU,lU,_U,dU,fU,pU,mU,gU,vU,yU,TU,EU,SU,AU,RU,wU,bU,OU,MU,IU,CU,xU,NU,BU,PU,DU=function(t){function e(){var e;return(e=t.call(this)||this)._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e._realTimeJointTexture=new iU,e._realTimeTextureMode=!1,e.type=nO.SKINNING,e}o(e,t);var i=e.prototype;return i.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}this._dataArray.length=0,this._realTimeJointTexture._textures.forEach((function(t){t.destroy()})),this._realTimeJointTexture._textures.length=0,this._realTimeJointTexture._buffers.length=0,t.prototype.destroy.call(this)},i.uploadAnimation=function(){},i.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)jL(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this._realTimeTextureMode=!1,Im.JOINT_UNIFORM_CAPACITY<t.joints.length&&(this._realTimeTextureMode=!0),this.transform=e;var r=i.getBoneSpaceBounds(t),s=i.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=i.jointBufferIndices,this._initRealTimeJointTexture();for(var a=0;a<t.joints.length;a++){var o=r[a],u=e.getChildByPath(t.joints[a]);if(o&&u){var h=XL(u,e),c=t.bindposes[a],l=[],_=[];s?qL(l,_,s,a):(l.push(a),_.push(0)),this._joints.push({indices:l,buffers:_,bound:o,target:u,bindpose:c,transform:h})}}}},i.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),js.set(QL,1/0,1/0,1/0),js.set(ZL,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.bound,s=WL(n.transform,t);sc.transform(eU,r,s),eU.getBoundary(JL,$L),js.min(QL,QL,JL),js.max(ZL,ZL,$L)}var a=this._worldBounds;this._modelBounds&&a&&(sc.fromPoints(this._modelBounds,QL,ZL),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],r=n.indices,s=n.buffers,a=n.transform,o=n.bindpose;da.multiply(tU,a.world,o);for(var u=0;u<s.length;u++)NL(this._dataArray[s[u]],12*r[u],tU)}if(this._realTimeTextureMode)this._updateRealTimeJointTextureBuffer();else for(var h=0;h<this._buffers.length;h++)this._buffers[h].update(this._dataArray[h]);return!0},i.initSubModel=function(e,i,n){var r=i.vertexBuffers,s=i.iaInfo;s.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),s.vertexBuffers=r},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e),n=YL;return this._realTimeTextureMode&&(n=KL),i?n.concat(i):n},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._bufferIndices[e];if(this._realTimeTextureMode)this._bindRealTimeJointTexture(n,i);else{var r=this._buffers[n];r&&i.bindBuffer(Im.BINDING,r)}},i._updateInstancedAttributes=function(e,i){i.passes[0].batchingScheme!==OT.NONE&&G(3936,this.node.getPathInHierarchy()),t.prototype._updateInstancedAttributes.call(this,e,i)},i._ensureEnoughBuffers=function(t){if(this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}if(this._dataArray.length&&(this._dataArray.length=0),this._realTimeTextureMode)for(var i=0;i<t;i++){var n=iU.WIDTH;this._dataArray[i]=new Float32Array(12*n)}else for(var r=0;r<t;r++){this._buffers[r]=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,Im.SIZE,Im.SIZE));var s=Im.JOINT_UNIFORM_CAPACITY;this._dataArray[r]=new Float32Array(12*s)}},i._initRealTimeJointTexture=function(){if(this._realTimeJointTexture._textures.length&&(this._realTimeJointTexture._textures.forEach((function(t){t.destroy()})),this._realTimeJointTexture._textures.length=0),this._realTimeJointTexture._buffers.length=0,this._realTimeTextureMode){var t=SD.root.device,e=iU.WIDTH,i=iU.HEIGHT;0==(t.getFormatFeatures(et.RGBA32F)&lt.SAMPLED_TEXTURE)&&(this._realTimeJointTexture._format=cf.RGBA8888,e=4*iU.WIDTH);for(var n=this._realTimeJointTexture._textures,r=this._realTimeJointTexture._buffers,s=this._realTimeJointTexture._format,a=0;a<this._dataArray.length;a++){r[a]=new Float32Array(4*iU.HEIGHT*iU.WIDTH);var o=r[a],u=s===cf.RGBA32F?o:new Uint8Array(o.buffer),h=new $v({width:e,height:i,_data:u,_compressed:!1,format:s}),c=new fy;c.setFilters(fy.Filter.NEAREST,fy.Filter.NEAREST),c.setMipFilter(fy.Filter.NONE),c.setWrapMode(fy.WrapMode.CLAMP_TO_EDGE,fy.WrapMode.CLAMP_TO_EDGE,fy.WrapMode.CLAMP_TO_EDGE),c.image=h,n[a]=c}}},i._bindRealTimeJointTexture=function(t,e){if(this._realTimeTextureMode){var i=this._realTimeJointTexture._textures[t];if(i){var n=i.getGFXTexture(),r=i.getGFXSampler();e.bindTexture(Fm,n),e.bindSampler(Fm,r)}}},i._updateRealTimeJointTextureBuffer=function(){if(this._realTimeTextureMode)for(var t=this._realTimeJointTexture._textures,e=this._realTimeJointTexture._buffers,i=0;i<t.length;i++){for(var n=e[i],r=this._dataArray[i],s=r.length/12,a=0,o=0,u=0;u<s;u++)o=4*u,n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++],o=4*(u+iU.WIDTH),n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++],o=4*(u+2*iU.WIDTH),n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++],n[o++]=r[a++];var h=this._realTimeJointTexture._format===cf.RGBA32F?n:new Uint8Array(n.buffer);t[i].uploadData(h)}},e}(XM),FU=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],LU=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=nO.BAKED_SKINNING,e._dataPoolManager=v.director.root.dataPoolManager;var i=new Float32Array(4),n=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:i,animInfo:n,texture:null,boundsInfo:null},e}o(e,t);var i=e.prototype;return i.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),t.prototype.destroy.call(this)},i.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new ae(rt.UNIFORM|rt.TRANSFER_DST,ot.DEVICE,bm.SIZE,bm.SIZE)))}},i.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],s=this._worldBounds;if(s&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,s)}}},i.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=this._jointsMedium.animInfo,n=!1,r=this._instAnimInfoIdx,s=0;s<this._subModels.length;s++){var a=this._subModels[s];r>=0?a.instancedAttributeBlock.views[r][0]=i.data[0]:n=!0}return n&&i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},i.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(FU):FU},i.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}},i._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var s=t.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Bm,s)}},i._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,s=n.texture,a=n.animInfo;if(i.bindBuffer(bm.BINDING,r),i.bindBuffer(Om.BINDING,a.buffer),s){var o=this._device.getSampler(xL);i.bindTexture(Bm,s.handle.texture),i.bindSampler(Bm,o)}},i._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._instAnimInfoIdx=i.getInstancedAttributeIndex(Mm),this.updateInstancedJointTextureInfo()},i.updateInstancedJointTextureInfo=function(){for(var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx,r=0;r<this._subModels.length;r++){var s=this._subModels[r].instancedAttributeBlock.views;if(n>=0&&s.length>0){var a=s[n];a[0]=i.data[0],a[1]=e[1],a[2]=e[2]}}},e}(XM),UU=t("SkinnedMeshRenderer",(nU=ao("cc.SkinnedMeshRenderer"),rU=uo(100),sU=xo(EI),aU=xo(kp),oU=xo(EI),uU=xo(kp),nU(hU=rU((cU=function(t){function e(){var e;return(e=t.call(this)||this)._skeleton=lU&&lU(),e._skinningRoot=_U&&_U(),e._clip=null,e.associatedAnimation=null,e._modelType=LU,e}o(e,t);var i=e.prototype;return i.onLoad=function(){t.prototype.onLoad.call(this),this._tryBindAnimation()},i.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),t.prototype.onDestroy.call(this)},i.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},i.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var i=t?LU:DU;(e||this._modelType!==i)&&(this._modelType=i,this._model&&(v.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this.enabledInHierarchy&&this._attachToScene()))},i.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===DU&&this.getMaterialInstance(i)},i._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},i._tryBindAnimation=function(){var t=this._skinningRoot;if(t){for(var e=!1,i=this.node;i;i=i.parent)if(i===t){e=!0;break}if(e){var n=t.getComponent("cc.SkeletalAnimation");n?n.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},i._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},s(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){this._skinningRoot=t,this._tryBindAnimation(),t!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),e}(qM),lU=Za(cU.prototype,"_skeleton",[sU],(function(){return null})),_U=Za(cU.prototype,"_skinningRoot",[aU],(function(){return null})),m(cU.prototype,"skeleton",[oU],Object.getOwnPropertyDescriptor(cU.prototype,"skeleton"),cU.prototype),m(cU.prototype,"skinningRoot",[uU],Object.getOwnPropertyDescriptor(cU.prototype,"skinningRoot"),cU.prototype),hU=cU))||hU)||hU)),GU=new Ae(Vt.ATTR_BATCH_ID,et.R32F),kU=new Ae(Vt.ATTR_BATCH_UV,et.RG32F),zU=Ke[GU.format].size+Ke[kU.format].size,HU=t("SkinnedMeshUnit",(dU=ao("cc.SkinnedMeshUnit"),fU=xo(Xb),pU=xo(EI),mU=xo($T),gU=xo(UU),dU((yU=function(){function t(){this.mesh=TU&&TU(),this.skeleton=EU&&EU(),this.material=SU&&SU(),this._localTransform=AU&&AU(),this._offset=RU&&RU(),this._size=wU&&wU()}return s(t,[{key:"offset",get:function(){return this._offset},set:function(t){Qs.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){Qs.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&CL(t.node,t.skinningRoot,this._localTransform))}}]),t}(),TU=Za(yU.prototype,"mesh",[fU],(function(){return null})),EU=Za(yU.prototype,"skeleton",[pU],(function(){return null})),SU=Za(yU.prototype,"material",[mU],(function(){return null})),AU=Za(yU.prototype,"_localTransform",[mo],(function(){return new da})),RU=Za(yU.prototype,"_offset",[mo],(function(){return new Qs(0,0)})),wU=Za(yU.prototype,"_size",[mo],(function(){return new Qs(1,1)})),m(yU.prototype,"copyFrom",[gU],Object.getOwnPropertyDescriptor(yU.prototype,"copyFrom"),yU.prototype),vU=yU))||vU)),VU=new da,WU=(new da,new js);t("SkinnedMeshBatchRenderer",(bU=ao("cc.SkinnedMeshBatchRenderer"),OU=uo(100),MU=xo([mr]),IU=xo([HU]),bU(CU=OU((xU=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).atlasSize=NU&&NU(),e.batchableTextureNames=BU&&BU(),e.units=PU&&PU(),e._textures={},e._batchMaterial=null,e}o(e,t);var i=e.prototype;return i.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},i.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},i._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},i.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},i.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var s=function(i){if(r.properties[i].type>=nt.SAMPLER1D){var s=null;t.batchableTextureNames.find((function(t){return t===i}))?((s=t._textures[i])||(s=t.createTexture(i)),t.cookTextures(s,i,n)):t.units.some((function(t){return s=t.material&&t.material.getProperty(i,n)})),s&&e.setProperty(i,s,n)}else{for(var a=[],o=0;o<t.units.length;o++){var u=t.units[o];u.material&&a.push(u.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,a,n)}};for(var a in r.properties)s(a)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},i.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],i=0;i<this.units.length;i++){var n=this.units[i];if(n&&n.skeleton){var r=n.skeleton;da.invert(VU,n._localTransform);for(var s=function(i){var n=r.joints[i];if(t.findIndex((function(t){return t===n}))>=0)return"continue";t.push(n),e.push(da.multiply(new da,r.bindposes[i]||da.IDENTITY,VU))},a=0;a<r.joints.length;a++)s(a)}}var o=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),u=new EI;u.joints=t.map((function(t,e,i){return i[o[e]]})),u.bindposes=e.map((function(t,e,i){return i[o[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=u}else console.warn("no skinning root specified!")},i.cookMeshes=function(){for(var t=this,e=!1,i=0;i<this.units.length;i++)if(this.units[i].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new Xb;for(var n=0,r=et.UNKNOWN,s=0,a=et.UNKNOWN,o=0,u=et.UNKNOWN,h=0,c=et.UNKNOWN,l=0,_=et.UNKNOWN,d=new Array(this.units.length),f=this.units.length,p=0;p<f;p++){var m=this.units[p];m&&m.skeleton&&(d[p]=m.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var g=function(e){var i=t.units[e];if(!i||!i.mesh||!i.mesh.data)return"continue";var f=t._createUnitMesh(e,i.mesh),p=new DataView(f.data.buffer);da.inverseTranspose(VU,i._localTransform);for(var m=i.offset,g=i.size,v=function(t){var v=f.struct.vertexBundles[t];n=v.view.offset,r=et.UNKNOWN;for(var y=0;y<v.attributes.length;y++){var T=v.attributes[y];if(T.name===Vt.ATTR_POSITION){r=T.format;break}n+=Ke[T.format].size}if(r){for(var E=qa(p,r,n,v.view.length,v.view.stride),S=0;S<E.length;S+=3)js.fromArray(WU,E,S),js.transformMat4(WU,WU,i._localTransform),js.toArray(E,WU,S);Ka(p,E,r,n,v.view.stride)}s=v.view.offset,a=et.UNKNOWN;for(var A=0;A<v.attributes.length;A++){var R=v.attributes[A];if(R.name===Vt.ATTR_NORMAL){a=R.format;break}s+=Ke[R.format].size}if(a){for(var w=qa(p,a,s,v.view.length,v.view.stride),b=0;b<w.length;b+=3)js.fromArray(WU,w,b),js.transformMat4Normal(WU,WU,VU),js.toArray(w,WU,b);Ka(p,w,a,s,v.view.stride)}o=v.view.offset,u=et.UNKNOWN;for(var O=0;O<v.attributes.length;O++){var M=v.attributes[O];if(M.name===Vt.ATTR_TANGENT){u=M.format;break}o+=Ke[M.format].size}if(u){for(var I=qa(p,u,o,v.view.length,v.view.stride),C=0;C<I.length;C+=3)js.fromArray(WU,I,C),js.transformMat4Normal(WU,WU,VU),js.toArray(I,WU,C);Ka(p,I,u,o,v.view.stride)}h=v.view.offset,c=et.UNKNOWN;for(var x=0;x<v.attributes.length;x++){var N=v.attributes[x];if(N.name===Vt.ATTR_BATCH_UV){c=N.format;break}h+=Ke[N.format].size}c&&Qa(p,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*g[n]+m[n]}),c,h,v.view.length,v.view.stride,p);var B=d[e];if(!B)return"continue";l=v.view.offset,_=et.UNKNOWN;for(var P=0;P<v.attributes.length;P++){var D=v.attributes[P];if(D.name===Vt.ATTR_JOINTS){_=D.format;break}l+=Ke[D.format].size}_&&Qa(p,(function(t){return B[t]}),_,l,v.view.length,v.view.stride,p)},y=0;y<f.struct.vertexBundles.length;y++)v(y);t._mesh.merge(f)},v=0;v<f;v++)g(v);this._onMeshChanged(this._mesh),this._updateModels()}},i.cookTextures=function(t,e,i){for(var n=[],r=[],s=[],a=[],o=0;o<this.units.length;o++){var u=this.units[o];if(u.material){var h=u.material.getProperty(e,i);if(h&&h.image&&h.image.data){var c=new te;c.texOffset.x=u.offset.x*this.atlasSize,c.texOffset.y=u.offset.y*this.atlasSize,c.texExtent.width=u.size.x*this.atlasSize,c.texExtent.height=u.size.y*this.atlasSize;var l=h.image.data;ArrayBuffer.isView(l)?(s.push(l),a.push(c)):(n.push(l),r.push(c))}}}var _=t.getGFXTexture(),d=v.director.root.device;s.length>0&&d.copyBuffersToTexture(s,_,a),n.length>0&&d.copyTexImagesToTexture(n,_,r)},i.createTexture=function(t){var e=new fy;return e.setFilters(_f.LINEAR,_f.LINEAR),e.setMipFilter(_f.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:cf.RGBA8888}),this._textures[t]=e,e},i.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:cf.RGBA8888})},i._createUnitMesh=function(t,e){for(var i=JSON.parse(JSON.stringify(e.struct)),n={},r=0;r<e.struct.primitives.length;r++){for(var s=e.struct.primitives[r],a=0,o=et.UNKNOWN,u=0;u<s.vertexBundelIndices.length;u++){var h=e.struct.vertexBundles[s.vertexBundelIndices[u]];a=h.view.offset,o=et.UNKNOWN;for(var c=0;c<h.attributes.length;c++){var l=h.attributes[c];if(l.name===Vt.ATTR_TEX_COORD){o=l.format;break}a+=Ke[l.format].size}if(o)break}if(void 0===n[u]){n[u]=[o,a];var _=i.vertexBundles[u];_.attributes.push(GU),_.attributes.push(kU),_.view.offset=0,_.view.length+=_.view.count*zU,_.view.stride+=zU}}for(var d=0,f=0;f<i.vertexBundles.length;f++)d+=i.vertexBundles[f].view.length;for(var p=0;p<i.primitives.length;p++){var m=i.primitives[p];m.indexView&&(m.indexView.offset=d,d+=m.indexView.length)}var g=new Uint8Array(d),y=e.data,T=new DataView(g.buffer),E=new DataView(y.buffer),S=v.sys.isLittleEndian;for(var A in n)for(var R=i.vertexBundles[A],w=e.struct.vertexBundles[A],b=n[A],O=qa(E,b[0],b[1],w.view.length,w.view.stride),M=w.view,I=R.view,C=M.stride,x=I.stride,N=M.offset,B=I.offset,P=0;P<I.count;P++){var D=y.subarray(N,N+C);g.set(D,B),T.setFloat32(B+C,t),T.setFloat32(B+C+4,O[2*P],S),T.setFloat32(B+C+8,O[2*P+1],S),B+=x,N+=C}for(var F=0;F<i.primitives.length;F++){var L=e.struct.primitives[F],U=i.primitives[F];if(L.indexView&&U.indexView)for(var G=L.indexView.stride,k=U.indexView.stride,z=L.indexView.offset,H=U.indexView.offset,V=0;V<U.indexView.count;V++){var W=y.subarray(z,z+G);g.set(W,H),H+=k,z+=G}}var X=new Xb;return X.reset({struct:i,data:g}),X},s(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(UU),NU=Za(xU.prototype,"atlasSize",[mo],(function(){return 1024})),BU=Za(xU.prototype,"batchableTextureNames",[MU,mo],(function(){return[]})),PU=Za(xU.prototype,"units",[IU,mo],(function(){return[]})),m(xU.prototype,"mesh",[No],Object.getOwnPropertyDescriptor(xU.prototype,"mesh"),xU.prototype),m(xU.prototype,"skeleton",[No],Object.getOwnPropertyDescriptor(xU.prototype,"skeleton"),xU.prototype),CU=xU))||CU)||CU)),v.utils=iO,v.log=M,v.warn=I,v.error=C,v.assert=x,v._throw=P,v.logID=L,v.warnID=G,v.errorID=z,v.assertID=W,v.debug=K,v.path={join:cu,extname:lu,mainFileName:_u,basename:du,dirname:fu,changeExtname:pu,changeBasename:mu,_normalize:gu,stripSep:vu,get sep(){return yu()}};var XU,jU,YU=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];var n=this._pool.length-1;if(n<0)return null;var r=this._pool[n];this._pool.length=n;var s=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return s&&s.reuse&&s.reuse(arguments),r},t}());v.NodePool=YU;var KU=null!==(XU=globalThis.jsb)&&void 0!==XU?XU:{};t("native",{DownloaderHints:KU.DownloaderHints,Downloader:KU.Downloader,zipUtils:KU.zipUtils,fileUtils:KU.fileUtils,DebugRenderer:KU.DebugRenderer,copyTextToClipboard:null===(jU=KU.copyTextToClipboard)||void 0===jU?void 0:jU.bind(KU),garbageCollect:KU.garbageCollect,reflection:KU.reflection,bridge:KU.bridge,jsbBridgeWrapper:KU.jsbBridgeWrapper,AssetsManager:KU.AssetsManager,EventAssetsManager:KU.EventAssetsManager,Manifest:KU.Manifest,saveImageData:KU.saveImageData}),v.renderer=_M;var qU,QU=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuDescriptorSet=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,i=e.bindings,n=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(var a=0;a<i.length;++a)for(var o=i[a],u=0;u<o.count;u++)s.push({type:o.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},i.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},i.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&qe){var i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&Qe&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},s(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(gi);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(qU||(qU={}));var ZU=function(){function t(){}return t.setInstance=function(e){t._instance=e},s(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function JU(t,e){switch(t){case et.R8:return e.UNSIGNED_BYTE;case et.R8SN:return e.BYTE;case et.R8UI:return e.UNSIGNED_BYTE;case et.R8I:return e.BYTE;case et.R16F:return qU.HALF_FLOAT_OES;case et.R16UI:return e.UNSIGNED_SHORT;case et.R16I:return e.SHORT;case et.R32F:return e.FLOAT;case et.R32UI:return e.UNSIGNED_INT;case et.R32I:return e.INT;case et.RG8:return e.UNSIGNED_BYTE;case et.RG8SN:return e.BYTE;case et.RG8UI:return e.UNSIGNED_BYTE;case et.RG8I:return e.BYTE;case et.RG16F:return qU.HALF_FLOAT_OES;case et.RG16UI:return e.UNSIGNED_SHORT;case et.RG16I:return e.SHORT;case et.RG32F:return e.FLOAT;case et.RG32UI:return e.UNSIGNED_INT;case et.RG32I:return e.INT;case et.RGB8:case et.SRGB8:return e.UNSIGNED_BYTE;case et.RGB8SN:return e.BYTE;case et.RGB8UI:return e.UNSIGNED_BYTE;case et.RGB8I:return e.BYTE;case et.RGB16F:return qU.HALF_FLOAT_OES;case et.RGB16UI:return e.UNSIGNED_SHORT;case et.RGB16I:return e.SHORT;case et.RGB32F:return e.FLOAT;case et.RGB32UI:return e.UNSIGNED_INT;case et.RGB32I:return e.INT;case et.BGRA8:case et.RGBA8:case et.SRGB8_A8:return e.UNSIGNED_BYTE;case et.RGBA8SN:return e.BYTE;case et.RGBA8UI:return e.UNSIGNED_BYTE;case et.RGBA8I:return e.BYTE;case et.RGBA16F:return qU.HALF_FLOAT_OES;case et.RGBA16UI:return e.UNSIGNED_SHORT;case et.RGBA16I:return e.SHORT;case et.RGBA32F:return e.FLOAT;case et.RGBA32UI:return e.UNSIGNED_INT;case et.RGBA32I:return e.INT;case et.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case et.R11G11B10F:return e.FLOAT;case et.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case et.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case et.RGB10A2:return e.UNSIGNED_BYTE;case et.RGB10A2UI:return e.UNSIGNED_INT;case et.RGB9E5:return e.UNSIGNED_BYTE;case et.DEPTH:return e.UNSIGNED_INT;case et.DEPTH_STENCIL:return qU.UNSIGNED_INT_24_8_WEBGL;case et.BC1:case et.BC1_SRGB:case et.BC2:case et.BC2_SRGB:case et.BC3:case et.BC3_SRGB:case et.BC4:return e.UNSIGNED_BYTE;case et.BC4_SNORM:return e.BYTE;case et.BC5:return e.UNSIGNED_BYTE;case et.BC5_SNORM:return e.BYTE;case et.BC6H_SF16:case et.BC6H_UF16:return e.FLOAT;case et.BC7:case et.BC7_SRGB:case et.ETC_RGB8:case et.ETC2_RGB8:case et.ETC2_SRGB8:case et.ETC2_RGB8_A1:case et.ETC2_SRGB8_A1:case et.EAC_R11:return e.UNSIGNED_BYTE;case et.EAC_R11SN:return e.BYTE;case et.EAC_RG11:return e.UNSIGNED_BYTE;case et.EAC_RG11SN:return e.BYTE;case et.PVRTC_RGB2:case et.PVRTC_RGBA2:case et.PVRTC_RGB4:case et.PVRTC_RGBA4:case et.PVRTC2_2BPP:case et.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case et.ASTC_RGBA_4X4:case et.ASTC_RGBA_5X4:case et.ASTC_RGBA_5X5:case et.ASTC_RGBA_6X5:case et.ASTC_RGBA_6X6:case et.ASTC_RGBA_8X5:case et.ASTC_RGBA_8X6:case et.ASTC_RGBA_8X8:case et.ASTC_RGBA_10X5:case et.ASTC_RGBA_10X6:case et.ASTC_RGBA_10X8:case et.ASTC_RGBA_10X10:case et.ASTC_RGBA_12X10:case et.ASTC_RGBA_12X12:case et.ASTC_SRGBA_4X4:case et.ASTC_SRGBA_5X4:case et.ASTC_SRGBA_5X5:case et.ASTC_SRGBA_6X5:case et.ASTC_SRGBA_6X6:case et.ASTC_SRGBA_8X5:case et.ASTC_SRGBA_8X6:case et.ASTC_SRGBA_8X8:case et.ASTC_SRGBA_10X5:case et.ASTC_SRGBA_10X6:case et.ASTC_SRGBA_10X8:case et.ASTC_SRGBA_10X10:case et.ASTC_SRGBA_12X10:case et.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function $U(t,e){switch(t){case nt.BOOL:return e.BOOL;case nt.BOOL2:return e.BOOL_VEC2;case nt.BOOL3:return e.BOOL_VEC3;case nt.BOOL4:return e.BOOL_VEC4;case nt.INT:return e.INT;case nt.INT2:return e.INT_VEC2;case nt.INT3:return e.INT_VEC3;case nt.INT4:return e.INT_VEC4;case nt.UINT:return e.UNSIGNED_INT;case nt.FLOAT:return e.FLOAT;case nt.FLOAT2:return e.FLOAT_VEC2;case nt.FLOAT3:return e.FLOAT_VEC3;case nt.FLOAT4:return e.FLOAT_VEC4;case nt.MAT2:return e.FLOAT_MAT2;case nt.MAT3:return e.FLOAT_MAT3;case nt.MAT4:return e.FLOAT_MAT4;case nt.SAMPLER2D:return e.SAMPLER_2D;case nt.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),nt.UNKNOWN}}function tG(t){switch(t){case nt.BOOL:case nt.BOOL2:case nt.BOOL3:case nt.BOOL4:case nt.INT:case nt.INT2:case nt.INT3:case nt.INT4:case nt.UINT:return Int32Array;case nt.FLOAT:case nt.FLOAT2:case nt.FLOAT3:case nt.FLOAT4:case nt.MAT2:case nt.MAT3:case nt.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function eG(t,e){switch(t){case e.BOOL:return nt.BOOL;case e.BOOL_VEC2:return nt.BOOL2;case e.BOOL_VEC3:return nt.BOOL3;case e.BOOL_VEC4:return nt.BOOL4;case e.INT:return nt.INT;case e.INT_VEC2:return nt.INT2;case e.INT_VEC3:return nt.INT3;case e.INT_VEC4:return nt.INT4;case e.UNSIGNED_INT:return nt.UINT;case e.FLOAT:return nt.FLOAT;case e.FLOAT_VEC2:return nt.FLOAT2;case e.FLOAT_VEC3:return nt.FLOAT3;case e.FLOAT_VEC4:return nt.FLOAT4;case e.FLOAT_MAT2:return nt.MAT2;case e.FLOAT_MAT3:return nt.MAT3;case e.FLOAT_MAT4:return nt.MAT4;case e.SAMPLER_2D:return nt.SAMPLER2D;case e.SAMPLER_CUBE:return nt.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),nt.UNKNOWN}}function iG(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function nG(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}ZU._instance=null;var rG,sG=[512,513,514,515,516,517,518,519],aG=[0,7680,7681,7682,7683,5386,34055,34056],oG=[32774,32778,32779,32775,32776],uG=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(rG||(rG={}));var hG=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},cG=function(t){function e(){var e;return(e=t.call(this,rG.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new Kt,e.clearFlag=Lt.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return o(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(hG),lG=function(t){function e(){var e;return(e=t.call(this,rG.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new je,e}return o(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(hG),_G=function(t){function e(){var e;return(e=t.call(this,rG.DRAW)||this).drawInfo=new ue,e}return o(e,t),e.prototype.clear=function(){},e}(hG),dG=function(t){function e(){var e;return(e=t.call(this,rG.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return o(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(hG),fG=function(t){function e(){var e;return(e=t.call(this,rG.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return o(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(hG),pG=function(){function t(){this.cmds=new Wi(1),this.beginRenderPassCmds=new Wi(1),this.bindStatesCmds=new Wi(1),this.drawCmds=new Wi(1),this.updateBufferCmds=new Wi(1),this.copyBufferToTextureCmds=new Wi(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function mG(t,e,i,n,r){if(e.usage&rt.UNIFORM)ArrayBuffer.isView(i)?e.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&rt.INDIRECT){e.indirects.clearDraws();for(var s=i.drawInfos,a=0;a<s.length;++a)e.indirects.setDrawInfo(n+a,s[a])}else{var o=i,u=t.gl,h=t.stateCache;switch(e.glTarget){case u.ARRAY_BUFFER:t.extensions.useVAO&&h.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),h.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(u.bindBuffer(u.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case u.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&h.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),h.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===o.byteLength?u.bufferSubData(e.glTarget,n,o):u.bufferSubData(e.glTarget,n,o.slice(0,r))}}var gG={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},vG=new Kt;function yG(t,e,i,n,r,s,a){var o=t.gl,u=t.stateCache,h=0;if(i&&(vG.x=n.x<<i.lodLevel,vG.y=n.y<<i.lodLevel,vG.width=n.width<<i.lodLevel,vG.height=n.height<<i.lodLevel),i&&e){u.glFramebuffer!==i.glFramebuffer&&(o.bindFramebuffer(o.FRAMEBUFFER,i.glFramebuffer),u.glFramebuffer=i.glFramebuffer),u.viewport.left===vG.x&&u.viewport.top===vG.y&&u.viewport.width===vG.width&&u.viewport.height===vG.height||(o.viewport(vG.x,vG.y,vG.width,vG.height),u.viewport.left=vG.x,u.viewport.top=vG.y,u.viewport.width=vG.width,u.viewport.height=vG.height),u.scissorRect.x===vG.x&&u.scissorRect.y===vG.y&&u.scissorRect.width===vG.width&&u.scissorRect.height===vG.height||(o.scissor(vG.x,vG.y,vG.width,vG.height),u.scissorRect.x=vG.x,u.scissorRect.y=vG.y,u.scissorRect.width=vG.width,u.scissorRect.height=vG.height);var c=r.length;t.extensions.WEBGL_draw_buffers||(c=1);for(var l=0;l<c;++l){var _=e.colorAttachments[l];if(_.format!==et.UNKNOWN)switch(_.loadOp){case St.LOAD:break;case St.CLEAR:u.bs.targets[0].blendColorMask!==Tt.ALL&&o.colorMask(!0,!0,!0,!0);var d=r[0];o.clearColor(d.x,d.y,d.z,d.w),h|=o.COLOR_BUFFER_BIT;break;case St.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==et.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case St.LOAD:break;case St.CLEAR:u.dss.depthWrite||o.depthMask(!0),o.clearDepth(s),h|=o.DEPTH_BUFFER_BIT;break;case St.DISCARD:}if(Ke[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case St.LOAD:break;case St.CLEAR:u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,65535),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,65535),o.clearStencil(a),h|=o.STENCIL_BUFFER_BIT;break;case St.DISCARD:}}if(h&&o.clear(h),h&o.COLOR_BUFFER_BIT){var f=u.bs.targets[0].blendColorMask;if(f!==Tt.ALL){var p=(f&Tt.R)!==Tt.NONE,m=(f&Tt.G)!==Tt.NONE,g=(f&Tt.B)!==Tt.NONE,v=(f&Tt.A)!==Tt.NONE;o.colorMask(p,m,g,v)}}h&o.DEPTH_BUFFER_BIT&&!u.dss.depthWrite&&o.depthMask(!1),h&o.STENCIL_BUFFER_BIT&&(u.dss.stencilWriteMaskFront||o.stencilMaskSeparate(o.FRONT,0),u.dss.stencilWriteMaskBack||o.stencilMaskSeparate(o.BACK,0))}}function TG(t,e,i,n,r,s){var a,o,u,h=t.gl,c=t.stateCache,l=e&&e.gpuShader,_=!1;if(e&&gG.gpuPipelineState!==e){if(gG.gpuPipelineState=e,gG.glPrimitive=e.glPrimitive,e.gpuShader){var d=e.gpuShader.glProgram;c.glProgram!==d&&(h.useProgram(d),c.glProgram=d,_=!0)}var f=e.rs;if(f){if(c.rs.cullMode!==f.cullMode){switch(f.cullMode){case Ct.NONE:h.disable(h.CULL_FACE);break;case Ct.FRONT:h.enable(h.CULL_FACE),h.cullFace(h.FRONT);break;case Ct.BACK:h.enable(h.CULL_FACE),h.cullFace(h.BACK)}c.rs.cullMode=f.cullMode}var p=f.isFrontFaceCCW;c.rs.isFrontFaceCCW!==p&&(h.frontFace(p?h.CCW:h.CW),c.rs.isFrontFaceCCW=p),c.rs.depthBias===f.depthBias&&c.rs.depthBiasSlop===f.depthBiasSlop||(h.polygonOffset(f.depthBias,f.depthBiasSlop),c.rs.depthBias=f.depthBias,c.rs.depthBiasSlop=f.depthBiasSlop),c.rs.lineWidth!==f.lineWidth&&(h.lineWidth(f.lineWidth),c.rs.lineWidth=f.lineWidth)}var m=e.dss;m&&(c.dss.depthTest!==m.depthTest&&(m.depthTest?h.enable(h.DEPTH_TEST):h.disable(h.DEPTH_TEST),c.dss.depthTest=m.depthTest),c.dss.depthWrite!==m.depthWrite&&(h.depthMask(m.depthWrite),c.dss.depthWrite=m.depthWrite),c.dss.depthFunc!==m.depthFunc&&(h.depthFunc(sG[m.depthFunc]),c.dss.depthFunc=m.depthFunc),c.dss.stencilTestFront===m.stencilTestFront&&c.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?h.enable(h.STENCIL_TEST):h.disable(h.STENCIL_TEST),c.dss.stencilTestFront=m.stencilTestFront,c.dss.stencilTestBack=m.stencilTestBack),c.dss.stencilFuncFront===m.stencilFuncFront&&c.dss.stencilRefFront===m.stencilRefFront&&c.dss.stencilReadMaskFront===m.stencilReadMaskFront||(h.stencilFuncSeparate(h.FRONT,sG[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),c.dss.stencilFuncFront=m.stencilFuncFront,c.dss.stencilRefFront=m.stencilRefFront,c.dss.stencilReadMaskFront=m.stencilReadMaskFront),c.dss.stencilFailOpFront===m.stencilFailOpFront&&c.dss.stencilZFailOpFront===m.stencilZFailOpFront&&c.dss.stencilPassOpFront===m.stencilPassOpFront||(h.stencilOpSeparate(h.FRONT,aG[m.stencilFailOpFront],aG[m.stencilZFailOpFront],aG[m.stencilPassOpFront]),c.dss.stencilFailOpFront=m.stencilFailOpFront,c.dss.stencilZFailOpFront=m.stencilZFailOpFront,c.dss.stencilPassOpFront=m.stencilPassOpFront),c.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(h.stencilMaskSeparate(h.FRONT,m.stencilWriteMaskFront),c.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),c.dss.stencilFuncBack===m.stencilFuncBack&&c.dss.stencilRefBack===m.stencilRefBack&&c.dss.stencilReadMaskBack===m.stencilReadMaskBack||(h.stencilFuncSeparate(h.BACK,sG[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),c.dss.stencilFuncBack=m.stencilFuncBack,c.dss.stencilRefBack=m.stencilRefBack,c.dss.stencilReadMaskBack=m.stencilReadMaskBack),c.dss.stencilFailOpBack===m.stencilFailOpBack&&c.dss.stencilZFailOpBack===m.stencilZFailOpBack&&c.dss.stencilPassOpBack===m.stencilPassOpBack||(h.stencilOpSeparate(h.BACK,aG[m.stencilFailOpBack],aG[m.stencilZFailOpBack],aG[m.stencilPassOpBack]),c.dss.stencilFailOpBack=m.stencilFailOpBack,c.dss.stencilZFailOpBack=m.stencilZFailOpBack,c.dss.stencilPassOpBack=m.stencilPassOpBack),c.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(h.stencilMaskSeparate(h.BACK,m.stencilWriteMaskBack),c.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var g=e.bs;if(g){c.bs.isA2C!==g.isA2C&&(g.isA2C?h.enable(h.SAMPLE_ALPHA_TO_COVERAGE):h.disable(h.SAMPLE_ALPHA_TO_COVERAGE),c.bs.isA2C=g.isA2C),c.bs.blendColor.x===g.blendColor.x&&c.bs.blendColor.y===g.blendColor.y&&c.bs.blendColor.z===g.blendColor.z&&c.bs.blendColor.w===g.blendColor.w||(h.blendColor(g.blendColor.x,g.blendColor.y,g.blendColor.z,g.blendColor.w),c.bs.blendColor.x=g.blendColor.x,c.bs.blendColor.y=g.blendColor.y,c.bs.blendColor.z=g.blendColor.z,c.bs.blendColor.w=g.blendColor.w);var v=g.targets[0],y=c.bs.targets[0];y.blend!==v.blend&&(v.blend?h.enable(h.BLEND):h.disable(h.BLEND),y.blend=v.blend),y.blendEq===v.blendEq&&y.blendAlphaEq===v.blendAlphaEq||(h.blendEquationSeparate(oG[v.blendEq],oG[v.blendAlphaEq]),y.blendEq=v.blendEq,y.blendAlphaEq=v.blendAlphaEq),y.blendSrc===v.blendSrc&&y.blendDst===v.blendDst&&y.blendSrcAlpha===v.blendSrcAlpha&&y.blendDstAlpha===v.blendDstAlpha||(h.blendFuncSeparate(uG[v.blendSrc],uG[v.blendDst],uG[v.blendSrcAlpha],uG[v.blendDstAlpha]),y.blendSrc=v.blendSrc,y.blendDst=v.blendDst,y.blendSrcAlpha=v.blendSrcAlpha,y.blendDstAlpha=v.blendDstAlpha),y.blendColorMask!==v.blendColorMask&&(h.colorMask((v.blendColorMask&Tt.R)!==Tt.NONE,(v.blendColorMask&Tt.G)!==Tt.NONE,(v.blendColorMask&Tt.B)!==Tt.NONE,(v.blendColorMask&Tt.A)!==Tt.NONE),y.blendColorMask=v.blendColorMask)}}if(e&&e.gpuPipelineLayout&&l){for(var T=l.glBlocks.length,E=e.gpuPipelineLayout.dynamicOffsetIndices,S=0;S<T;S++){var A=l.glBlocks[S],R=n[A.set],w=R&&R.descriptorIndices[A.binding],b=w>=0&&R.gpuDescriptors[w],O=null,M=0;if(b&&b.gpuBuffer){var I=b.gpuBuffer,x=E[A.set],N=x&&x[A.binding];N>=0&&(M=r[N]),"vf32"in I?O=I.vf32:(M+=I.offset,O=I.gpuBuffer.vf32),M>>=2}if(O)for(var B=A.glActiveUniforms.length,P=0;P<B;P++){var D=A.glActiveUniforms[P];switch(D.glType){case h.BOOL:case h.INT:for(var F=0;F<D.array.length;++F){var L=D.offset+M+F;if(O[L]!==D.array[F]){for(var U=F,G=L;U<D.array.length;++U,++G)D.array[U]=O[G];h.uniform1iv(D.glLoc,D.array);break}}break;case h.BOOL_VEC2:case h.INT_VEC2:for(var k=0;k<D.array.length;++k){var z=D.offset+M+k;if(O[z]!==D.array[k]){for(var H=k,V=z;H<D.array.length;++H,++V)D.array[H]=O[V];h.uniform2iv(D.glLoc,D.array);break}}break;case h.BOOL_VEC3:case h.INT_VEC3:for(var W=0;W<D.array.length;++W){var X=D.offset+M+W;if(O[X]!==D.array[W]){for(var j=W,Y=X;j<D.array.length;++j,++Y)D.array[j]=O[Y];h.uniform3iv(D.glLoc,D.array);break}}break;case h.BOOL_VEC4:case h.INT_VEC4:for(var K=0;K<D.array.length;++K){var q=D.offset+M+K;if(O[q]!==D.array[K]){for(var Q=K,Z=q;Q<D.array.length;++Q,++Z)D.array[Q]=O[Z];h.uniform4iv(D.glLoc,D.array);break}}break;case h.FLOAT:for(var J=0;J<D.array.length;++J){var $=D.offset+M+J;if(O[$]!==D.array[J]){for(var tt=J,et=$;tt<D.array.length;++tt,++et)D.array[tt]=O[et];h.uniform1fv(D.glLoc,D.array);break}}break;case h.FLOAT_VEC2:for(var it=0;it<D.array.length;++it){var nt=D.offset+M+it;if(O[nt]!==D.array[it]){for(var rt=it,st=nt;rt<D.array.length;++rt,++st)D.array[rt]=O[st];h.uniform2fv(D.glLoc,D.array);break}}break;case h.FLOAT_VEC3:for(var at=0;at<D.array.length;++at){var ot=D.offset+M+at;if(O[ot]!==D.array[at]){for(var ut=at,ht=ot;ut<D.array.length;++ut,++ht)D.array[ut]=O[ht];h.uniform3fv(D.glLoc,D.array);break}}break;case h.FLOAT_VEC4:for(var ct=0;ct<D.array.length;++ct){var lt=D.offset+M+ct;if(O[lt]!==D.array[ct]){for(var _t=ct,dt=lt;_t<D.array.length;++_t,++dt)D.array[_t]=O[dt];h.uniform4fv(D.glLoc,D.array);break}}break;case h.FLOAT_MAT2:for(var ft=0;ft<D.array.length;++ft){var pt=D.offset+M+ft;if(O[pt]!==D.array[ft]){for(var mt=ft,gt=pt;mt<D.array.length;++mt,++gt)D.array[mt]=O[gt];h.uniformMatrix2fv(D.glLoc,!1,D.array);break}}break;case h.FLOAT_MAT3:for(var vt=0;vt<D.array.length;++vt){var yt=D.offset+M+vt;if(O[yt]!==D.array[vt]){for(var Et=vt,St=yt;Et<D.array.length;++Et,++St)D.array[Et]=O[St];h.uniformMatrix3fv(D.glLoc,!1,D.array);break}}break;case h.FLOAT_MAT4:for(var At=0;At<D.array.length;++At){var Rt=D.offset+M+At;if(O[Rt]!==D.array[At]){for(var wt=At,bt=Rt;wt<D.array.length;++wt,++bt)D.array[wt]=O[bt];h.uniformMatrix4fv(D.glLoc,!1,D.array);break}}}}else C("Buffer binding '"+A.name+"' at set "+A.set+" binding "+A.binding+" is not bounded")}for(var Ot=l.glSamplerTextures.length,Mt=0;Mt<Ot;Mt++)for(var It=l.glSamplerTextures[Mt],Nt=n[It.set],Bt=Nt&&Nt.descriptorIndices[It.binding],Pt=Bt>=0&&Nt.gpuDescriptors[Bt],Dt=It.units.length,Ft=0;Ft<Dt;Ft++){var Lt=It.units[Ft];if(Pt&&Pt.gpuSampler){if(Pt.gpuTexture&&Pt.gpuTexture.size>0){var Ut=Pt.gpuTexture,Gt=c.glTexUnits[Lt];Gt.glTexture!==Ut.glTexture&&(c.texUnit!==Lt&&(h.activeTexture(h.TEXTURE0+Lt),c.texUnit=Lt),Ut.glTexture?h.bindTexture(Ut.glTarget,Ut.glTexture):h.bindTexture(Ut.glTarget,t.nullTex2D.gpuTexture.glTexture),Gt.glTexture=Ut.glTexture);var kt=Pt.gpuSampler;Ut.isPowerOf2?(a=kt.glWrapS,o=kt.glWrapT):(a=h.CLAMP_TO_EDGE,o=h.CLAMP_TO_EDGE),u=Ut.isPowerOf2?Ut.mipLevel<=1&&(kt.glMinFilter===h.LINEAR_MIPMAP_NEAREST||kt.glMinFilter===h.LINEAR_MIPMAP_LINEAR)?h.LINEAR:kt.glMinFilter:kt.glMinFilter===h.LINEAR||kt.glMinFilter===h.LINEAR_MIPMAP_NEAREST||kt.glMinFilter===h.LINEAR_MIPMAP_LINEAR?h.LINEAR:h.NEAREST,Ut.glWrapS!==a&&(c.texUnit!==Lt&&(h.activeTexture(h.TEXTURE0+Lt),c.texUnit=Lt),h.texParameteri(Ut.glTarget,h.TEXTURE_WRAP_S,a),Ut.glWrapS=a),Ut.glWrapT!==o&&(c.texUnit!==Lt&&(h.activeTexture(h.TEXTURE0+Lt),c.texUnit=Lt),h.texParameteri(Ut.glTarget,h.TEXTURE_WRAP_T,o),Ut.glWrapT=o),Ut.glMinFilter!==u&&(c.texUnit!==Lt&&(h.activeTexture(h.TEXTURE0+Lt),c.texUnit=Lt),h.texParameteri(Ut.glTarget,h.TEXTURE_MIN_FILTER,u),Ut.glMinFilter=u),Ut.glMagFilter!==kt.glMagFilter&&(c.texUnit!==Lt&&(h.activeTexture(h.TEXTURE0+Lt),c.texUnit=Lt),h.texParameteri(Ut.glTarget,h.TEXTURE_MAG_FILTER,kt.glMagFilter),Ut.glMagFilter=kt.glMagFilter)}Pt=Nt.gpuDescriptors[++Bt]}else C("Sampler binding '"+It.name+"' at set "+It.set+" binding "+It.binding+" index "+Ft+" is not bounded")}}if(i&&l&&(_||gG.gpuInputAssembler!==i)){gG.gpuInputAssembler=i;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Ht=t.extensions.OES_vertex_array_object,Vt=i.glVAOs.get(l.glProgram);if(!Vt){var Wt;Vt=Ht.createVertexArrayOES(),i.glVAOs.set(l.glProgram,Vt),Ht.bindVertexArrayOES(Vt),h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),c.glArrayBuffer=null,c.glElementArrayBuffer=null;for(var Xt=l.glInputs.length,jt=0;jt<Xt;jt++){var Yt=l.glInputs[jt];Wt=null;for(var Kt=i.glAttribs.length,qt=0;qt<Kt;qt++){var Qt=i.glAttribs[qt];if(Qt.name===Yt.name){Wt=Qt;break}}if(Wt){c.glArrayBuffer!==Wt.glBuffer&&(h.bindBuffer(h.ARRAY_BUFFER,Wt.glBuffer),c.glArrayBuffer=Wt.glBuffer);for(var Zt=0;Zt<Wt.componentCount;++Zt){var Jt=Yt.glLoc+Zt,$t=Wt.offset+Wt.size*Zt;h.enableVertexAttribArray(Jt),c.glCurrentAttribLocs[Jt]=!0,h.vertexAttribPointer(Jt,Wt.count,Wt.glType,Wt.isNormalized,Wt.stride,$t),zt&&zt.vertexAttribDivisorANGLE(Jt,Wt.isInstanced?1:0)}}}var te=i.gpuIndexBuffer;te&&h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,te.glBuffer),Ht.bindVertexArrayOES(null),h.bindBuffer(h.ARRAY_BUFFER,null),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,null),c.glArrayBuffer=null,c.glElementArrayBuffer=null}c.glVAO!==Vt&&(Ht.bindVertexArrayOES(Vt),c.glVAO=Vt)}else{for(var ee=0;ee<t.capabilities.maxVertexAttributes;++ee)c.glCurrentAttribLocs[ee]=!1;for(var ie=l.glInputs.length,ne=0;ne<ie;ne++){for(var re=l.glInputs[ne],se=null,ae=i.glAttribs.length,oe=0;oe<ae;oe++){var ue=i.glAttribs[oe];if(ue.name===re.name){se=ue;break}}if(se){c.glArrayBuffer!==se.glBuffer&&(h.bindBuffer(h.ARRAY_BUFFER,se.glBuffer),c.glArrayBuffer=se.glBuffer);for(var he=0;he<se.componentCount;++he){var ce=re.glLoc+he,le=se.offset+se.size*he;!c.glEnabledAttribLocs[ce]&&ce>=0&&(h.enableVertexAttribArray(ce),c.glEnabledAttribLocs[ce]=!0),c.glCurrentAttribLocs[ce]=!0,h.vertexAttribPointer(ce,se.count,se.glType,se.isNormalized,se.stride,le),zt&&zt.vertexAttribDivisorANGLE(ce,se.isInstanced?1:0)}}}var _e=i.gpuIndexBuffer;_e&&c.glElementArrayBuffer!==_e.glBuffer&&(h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,_e.glBuffer),c.glElementArrayBuffer=_e.glBuffer);for(var de=0;de<t.capabilities.maxVertexAttributes;++de)c.glEnabledAttribLocs[de]!==c.glCurrentAttribLocs[de]&&(h.disableVertexAttribArray(de),c.glEnabledAttribLocs[de]=!1)}}if(e&&e.dynamicStates.length)for(var fe=e.dynamicStates.length,pe=0;pe<fe;pe++)switch(e.dynamicStates[pe]){case xt.LINE_WIDTH:c.rs.lineWidth!==s.lineWidth&&(h.lineWidth(s.lineWidth),c.rs.lineWidth=s.lineWidth);break;case xt.DEPTH_BIAS:c.rs.depthBias===s.depthBiasConstant&&c.rs.depthBiasSlop===s.depthBiasSlope||(h.polygonOffset(s.depthBiasConstant,s.depthBiasSlope),c.rs.depthBias=s.depthBiasConstant,c.rs.depthBiasSlop=s.depthBiasSlope);break;case xt.BLEND_CONSTANTS:var me=s.blendConstant;c.bs.blendColor.x===me.x&&c.bs.blendColor.y===me.y&&c.bs.blendColor.z===me.z&&c.bs.blendColor.w===me.w||(h.blendColor(me.x,me.y,me.z,me.w),c.bs.blendColor.copy(me));break;case xt.STENCIL_WRITE_MASK:var ge=s.stencilStatesFront,ve=s.stencilStatesBack;c.dss.stencilWriteMaskFront!==ge.writeMask&&(h.stencilMaskSeparate(h.FRONT,ge.writeMask),c.dss.stencilWriteMaskFront=ge.writeMask),c.dss.stencilWriteMaskBack!==ve.writeMask&&(h.stencilMaskSeparate(h.BACK,ve.writeMask),c.dss.stencilWriteMaskBack=ve.writeMask);break;case xt.STENCIL_COMPARE_MASK:var ye=s.stencilStatesFront,Te=s.stencilStatesBack;c.dss.stencilRefFront===ye.reference&&c.dss.stencilReadMaskFront===ye.compareMask||(h.stencilFuncSeparate(h.FRONT,sG[c.dss.stencilFuncFront],ye.reference,ye.compareMask),c.dss.stencilRefFront=ye.reference,c.dss.stencilReadMaskFront=ye.compareMask),c.dss.stencilRefBack===Te.reference&&c.dss.stencilReadMaskBack===Te.compareMask||(h.stencilFuncSeparate(h.BACK,sG[c.dss.stencilFuncBack],Te.reference,Te.compareMask),c.dss.stencilRefBack=Te.reference,c.dss.stencilReadMaskBack=Te.compareMask)}}function EG(t,e){var i=t.gl,n=t.extensions,r=n.ANGLE_instanced_arrays,s=n.WEBGL_multi_draw,a=gG.gpuInputAssembler,o=gG.glPrimitive;if(a){var u=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var h=a.gpuIndirectBuffer.indirects;if(h.drawByIndex){for(var c=0;c<h.drawCount;c++)h.byteOffsets[c]=h.offsets[c]*u.stride;if(s)h.instancedDraw?s.multiDrawElementsInstancedWEBGL(o,h.counts,0,a.glIndexType,h.byteOffsets,0,h.instances,0,h.drawCount):s.multiDrawElementsWEBGL(o,h.counts,0,a.glIndexType,h.byteOffsets,0,h.drawCount);else for(var l=0;l<h.drawCount;l++)h.instances[l]&&r?r.drawElementsInstancedANGLE(o,h.counts[l],a.glIndexType,h.byteOffsets[l],h.instances[l]):i.drawElements(o,h.counts[l],a.glIndexType,h.byteOffsets[l])}else if(s)h.instancedDraw?s.multiDrawArraysInstancedWEBGL(o,h.offsets,0,h.counts,0,h.instances,0,h.drawCount):s.multiDrawArraysWEBGL(o,h.offsets,0,h.counts,0,h.drawCount);else for(var _=0;_<h.drawCount;_++)h.instances[_]&&r?r.drawArraysInstancedANGLE(o,h.offsets[_],h.counts[_],h.instances[_]):i.drawArrays(o,h.offsets[_],h.counts[_])}else if(e.instanceCount&&r)if(u){if(e.indexCount>0){var d=e.firstIndex*u.stride;r.drawElementsInstancedANGLE(o,e.indexCount,a.glIndexType,d,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(o,e.firstVertex,e.vertexCount,e.instanceCount);else if(u){if(e.indexCount>0){var f=e.firstIndex*u.stride;i.drawElements(o,e.indexCount,a.glIndexType,f)}}else e.vertexCount>0&&i.drawArrays(o,e.firstVertex,e.vertexCount)}}var SG=new Array(rG.COUNT);function AG(t,e){SG.fill(0);for(var i=0;i<e.cmds.length;++i){var n=e.cmds.array[i],r=SG[n]++;switch(n){case rG.BEGIN_RENDER_PASS:var s=e.beginRenderPassCmds.array[r];yG(t,s.gpuRenderPass,s.gpuFramebuffer,s.renderArea,s.clearColors,s.clearDepth,s.clearStencil);break;case rG.BIND_STATES:var a=e.bindStatesCmds.array[r];TG(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case rG.DRAW:EG(t,e.drawCmds.array[r].drawInfo);break;case rG.UPDATE_BUFFER:var o=e.updateBufferCmds.array[r];mG(t,o.gpuBuffer,o.buffer,o.offset,o.size);break;case rG.COPY_BUFFER_TO_TEXTURE:var u=e.copyBufferToTextureCmds.array[r];bG(t,u.buffers,u.gpuTexture,u.regions)}}}var RG=new Uint8Array(1);function wG(t,e,i,n,r){var s=si(e).height,a=ti(e,r.width,r.height,r.depth),o=ti(e,n.width,1,1),u=ti(e,n.width,n.height,1),h=ti(e,r.width,1,1),c=ri(Ke[e]);RG.byteLength<a&&(RG=new Uint8Array(a));for(var l=0,_=i,d=0;d<r.depth;d++){_=i+u*d;for(var f=0;f<r.height;f+=s)RG.subarray(l,l+h).set(new Uint8Array(t.buffer,t.byteOffset+_,h)),l+=h,_+=o}return new c(RG.buffer)}function bG(t,e,i,n){var r=t.gl,s=t.stateCache.glTexUnits[t.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0,u=Ke[i.format],h=ri(u),c=u.isCompressed,l=si(i.format),_=new qt,d=new Yt,f=new qt;switch(i.glTarget){case r.TEXTURE_2D:for(var p=0;p<n.length;p++){var m=n[p],g=m.texSubres.mipLevel;d.x=0===m.texOffset.x?0:ai(m.texOffset.x,l.width),d.y=0===m.texOffset.y?0:ai(m.texOffset.y,l.height),_.width=m.texExtent.width<l.width?m.texExtent.width:ai(m.texExtent.width,l.width),_.height=m.texExtent.height<l.height?m.texExtent.width:ai(m.texExtent.height,l.height),f.width=m.buffStride>0?m.buffStride:_.width,f.height=m.buffTexHeight>0?m.buffTexHeight:_.height;var v,y=m.texExtent.width+d.x===i.width>>g?m.texExtent.width:_.width,T=m.texExtent.height+d.y===i.height>>g?m.texExtent.height:_.height,E=e[a++];v=f.width===_.width&&f.height===_.height?new h(E.buffer,E.byteOffset+m.buffOffset):wG(E,i.format,m.buffOffset,f,_),c?i.glInternalFmt===qU.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,g,i.glInternalFmt,y,T,0,v):r.compressedTexSubImage2D(r.TEXTURE_2D,g,d.x,d.y,y,T,i.glFormat,v):r.texSubImage2D(r.TEXTURE_2D,g,d.x,d.y,y,T,i.glFormat,i.glType,v)}break;case r.TEXTURE_CUBE_MAP:for(var S=0;S<n.length;S++){var A=n[S],R=A.texSubres.mipLevel;d.x=0===A.texOffset.x?0:ai(A.texOffset.x,l.width),d.y=0===A.texOffset.y?0:ai(A.texOffset.y,l.height),_.width=A.texExtent.width<l.width?A.texExtent.width:ai(A.texExtent.width,l.width),_.height=A.texExtent.height<l.height?A.texExtent.width:ai(A.texExtent.height,l.height),f.width=A.buffStride>0?A.buffStride:_.width,f.height=A.buffTexHeight>0?A.buffTexHeight:_.height;var w=A.texExtent.width+d.x===i.width>>R?A.texExtent.width:_.width,b=A.texExtent.height+d.y===i.height>>R?A.texExtent.height:_.height,O=A.texSubres.baseArrayLayer+A.texSubres.layerCount;for(o=A.texSubres.baseArrayLayer;o<O;++o){var M,I=e[a++];M=f.width===_.width&&f.height===_.height?new h(I.buffer,I.byteOffset+A.buffOffset):wG(I,i.format,A.buffOffset,f,_),c?i.glInternalFmt===qU.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,R,i.glInternalFmt,w,b,0,M):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,R,d.x,d.y,w,b,i.glFormat,M):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,R,d.x,d.y,w,b,i.glFormat,i.glType,M)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&ct.GEN_MIPMAP&&r.generateMipmap(i.glTarget)}var OG=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=ps(t);var e=new Int32Array(this._capacity),i=new Int32Array(this._capacity),n=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),i.set(this.offsets),n.set(this.instances),this.counts=e,this.offsets=i,this.instances=n}},t}(),MG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&rt.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new OG,glTarget:0,glBuffer:null},this._usage&rt.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var i=t.gl,n=t.stateCache,r=e.memUsage&ot.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&rt.VERTEX){e.glTarget=i.ARRAY_BUFFER;var s=i.createBuffer();s&&(e.glBuffer=s,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&rt.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;var a=i.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&rt.UNIFORM?(e.glTarget=i.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&rt.INDIRECT||e.usage&rt.TRANSFER_DST||e.usage&rt.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(ZU.instance,this._gpuBuffer),ZU.instance.memoryStatus.bufferSize+=this._size},i.destroy=function(){this._gpuBuffer&&(function(t,e){var i=t.gl,n=t.stateCache;if(e.glBuffer){switch(e.glTarget){case i.ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),gG.gpuInputAssembler=null,i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case i.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),gG.gpuInputAssembler=null,i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}i.deleteBuffer(e.glBuffer),e.glBuffer=null}}(ZU.instance,this._gpuBuffer),ZU.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},i.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var i=t.gl,n=t.stateCache,r=e.memUsage&ot.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&rt.VERTEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,r):i.bufferData(i.ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&rt.INDEX?(t.extensions.useVAO&&n.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=null),gG.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,r):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,r),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&rt.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&rt.INDIRECT||e.usage&rt.TRANSFER_DST||e.usage&rt.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(ZU.instance,this._gpuBuffer),ZU.instance.memoryStatus.bufferSize-=e,ZU.instance.memoryStatus.bufferSize+=t)))}},i.update=function(t,e){var i;this._isBufferView?console.warn("cannot update through buffer views!"):(i=void 0!==e?e:this._usage&rt.INDIRECT?0:t.byteLength,mG(ZU.instance,this._gpuBuffer,t,0,i))},s(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(ui),IG=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new Wi(e);for(var i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,i=this._frees;this._frees=new Array(e);for(var n=e-i.length,r=0;r<n;++r)this._frees[r]=new t;for(var s=n,a=0;s<e;++s,++a)this._frees[s]=i[a];this._freeIdx+=n}var o=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++o.refCount,o},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),CG=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new IG(cG,1),this.bindStatesCmdPool=new IG(lG,1),this.drawCmdPool=new IG(_G,1),this.updateBufferCmdPool=new IG(dG,1),this.copyBufferToTextureCmdPool=new IG(fG,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),xG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).cmdPackage=new pG,e._cmdAllocator=new CG,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new je,e._isStateInvalied=!1,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=ZU.instance.bindingMappings.blockOffsets.length,i=0;i<e;i++)this._curGPUDescriptorSets.push(null)},i.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},i.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},i.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},i.beginRenderPass=function(t,e,i,n,r,s){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(cG);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea.copy(i),a.clearColors.length=n.length;for(var o=0;o<n.length;++o)a.clearColors[o]=n[o];a.clearDepth=r,a.clearStencil=s,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(rG.BEGIN_RENDER_PASS),this._isInRenderPass=!0},i.endRenderPass=function(){this._isInRenderPass=!1},i.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},i.bindDescriptorSet=function(t,e,i){var n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){var r,s=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(s){for(var a=this._curDynamicOffsets,o=s.dynamicOffsetOffsets[t],u=0;u<i.length;u++)a[o+u]=i[u];this._isStateInvalied=!0}}},i.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},i.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},i.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},i.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},i.setDepthBias=function(t,e,i){var n=this._curDynamicStates;n.depthBiasConstant===t&&n.depthBiasClamp===e&&n.depthBiasSlope===i||(n.depthBiasConstant=t,n.depthBiasClamp=e,n.depthBiasSlope=i,this._isStateInvalied=!0)},i.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},i.setDepthBound=function(t,e){var i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)},i.setStencilWriteMask=function(t,e){var i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;t&Nt.FRONT&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),t&Nt.BACK&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0)},i.setStencilCompareMask=function(t,e,i){var n=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Nt.FRONT&&(n.compareMask===i&&n.reference===e||(n.reference=e,n.compareMask=i,this._isStateInvalied=!0)),t&Nt.BACK&&(r.compareMask===i&&r.reference===e||(r.reference=e,r.compareMask=i,this._isStateInvalied=!0))},i.draw=function(t){if(this._type===Ft.PRIMARY&&this._isInRenderPass||this._type===Ft.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,i=this._cmdAllocator.drawCmdPool.alloc(_G);i.drawInfo.copy(e),this.cmdPackage.drawCmds.push(i),this.cmdPackage.cmds.push(rG.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},i.updateBuffer=function(t,e,i){if(this._type===Ft.PRIMARY&&!this._isInRenderPass||this._type===Ft.SECONDARY){var n=t.gpuBuffer;if(n){var r,s=this._cmdAllocator.updateBufferCmdPool.alloc(dG),a=0;t.usage&rt.INDIRECT||(a=void 0!==i?i:e.byteLength),r=e,s.gpuBuffer=n,s.buffer=r,s.offset=0,s.size=a,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(rG.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},i.copyBuffersToTexture=function(t,e,i){if(this._type===Ft.PRIMARY&&!this._isInRenderPass||this._type===Ft.SECONDARY){var n=e.gpuTexture;if(n){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(fG);r&&(r.gpuTexture=n,r.regions=i,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(rG.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},i.execute=function(t,e){for(var i=0;i<e;++i){for(var n=t[i],r=0;r<n.cmdPackage.beginRenderPassCmds.length;++r){var s=n.cmdPackage.beginRenderPassCmds.array[r];++s.refCount,this.cmdPackage.beginRenderPassCmds.push(s)}for(var a=0;a<n.cmdPackage.bindStatesCmds.length;++a){var o=n.cmdPackage.bindStatesCmds.array[a];++o.refCount,this.cmdPackage.bindStatesCmds.push(o)}for(var u=0;u<n.cmdPackage.drawCmds.length;++u){var h=n.cmdPackage.drawCmds.array[u];++h.refCount,this.cmdPackage.drawCmds.push(h)}for(var c=0;c<n.cmdPackage.updateBufferCmds.length;++c){var l=n.cmdPackage.updateBufferCmds.array[c];++l.refCount,this.cmdPackage.updateBufferCmds.push(l)}for(var _=0;_<n.cmdPackage.copyBufferToTextureCmds.length;++_){var d=n.cmdPackage.copyBufferToTextureCmds.array[_];++d.refCount,this.cmdPackage.copyBufferToTextureCmds.push(d)}this.cmdPackage.cmds.concat(n.cmdPackage.cmds.array),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},i.pipelineBarrier=function(){},i.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(lG);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(rG.BIND_STATES),this._isStateInvalied=!1)},e}(hi),NG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuFramebuffer=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=0,i=[],n=0;n<t.colorTextures.length;++n){var r=t.colorTextures[n];r&&(i.push(r.gpuTexture),e=r.lodLevel)}var s=null;t.depthStencilTexture&&(s=t.depthStencilTexture.gpuTexture,e=t.depthStencilTexture.lodLevel);var a=Number.MAX_SAFE_INTEGER,o=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:i,gpuDepthStencilTexture:s,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(t){a=t},get height(){return this.isOffscreen?o:this.gpuColorTextures[0].height},set height(t){o=t},lodLevel:e},function(t,e){for(var i=0;i<e.gpuColorTextures.length;++i)if(e.gpuColorTextures[i].isSwapchainTexture)return void(e.isOffscreen=!1);var n=t.gl,r=[],s=n.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var o=e.gpuColorTextures[a];o&&(o.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,o.glTarget,o.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+a,n.RENDERBUFFER,o.glRenderbuffer),r.push(n.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,o.width),e.height=Math.min(e.height,o.height))}var u=e.gpuDepthStencilTexture;if(u){var h=Ke[u.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;u.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,h,u.glTarget,u.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,h,n.RENDERBUFFER,u.glRenderbuffer),e.width=Math.min(e.width,u.width),e.height=Math.min(e.height,u.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var c=n.checkFramebufferStatus(n.FRAMEBUFFER);if(c!==n.FRAMEBUFFER_COMPLETE)switch(c){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(ZU.instance,this._gpuFramebuffer)},i.destroy=function(){var t,e;this._gpuFramebuffer&&(t=ZU.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},s(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(_i),BG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuInputAssembler=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var i=new Array(t.vertexBuffers.length),n=0;n<t.vertexBuffers.length;++n){var r=t.vertexBuffers[n];r.gpuBuffer&&(i[n]=r.gpuBuffer)}var s=null,a=0;if(t.indexBuffer&&(s=t.indexBuffer.gpuBuffer))switch(s.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var o=null;t.indirectBuffer&&(o=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:i,gpuIndexBuffer:s,gpuIndirectBuffer:o,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var i=t.gl;e.glAttribs=new Array(e.attributes.length);for(var n=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var s=e.attributes[r],a=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[a],u=JU(s.format,i),h=Ke[s.format].size;e.glAttribs[r]={name:s.name,glBuffer:o.glBuffer,glType:u,size:h,count:Ke[s.format].count,stride:o.stride,componentCount:nG(u,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[a]},n[a]+=h}}(ZU.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},i.destroy=function(){var t=ZU.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var i=e.glVAOs.values(),n=i.next(),r=t.extensions.OES_vertex_array_object,s=t.stateCache.glVAO;!n.done;)r.deleteVertexArrayOES(n.value),s===n.value&&(r.bindVertexArrayOES(null),s=null),n=i.next();t.stateCache.glVAO=s,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},s(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(mi),PG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuDescriptorSetLayout=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,i=-1,n=[],r=0;r<this._bindings.length;r++){var s=this._bindings[r];n.push(e),e+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);for(var a=this._descriptorIndices=Array(i+1).fill(-1),o=0;o<this._bindings.length;o++){var u=this._bindings[o];this._bindingIndices[u.binding]=o,a[u.binding]=n[o]}for(var h=[],c=0;c<this._bindings.length;c++){var l=this._bindings[c];if(l.descriptorType&Ze)for(var _=0;_<l.count;_++)h.push(l.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:h,descriptorIndices:a,descriptorCount:e}},i.destroy=function(){this._bindings.length=0},s(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(vi),DG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuPipelineLayout=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],i=[],n=0,r=[],s=0;s<this._setLayouts.length;s++){for(var a=this._setLayouts[s],o=a.gpuDescriptorSetLayout.dynamicBindings,u=Array(a.bindingIndices.length).fill(-1),h=0;h<o.length;h++){var c=o[h];u[c]<0&&(u[c]=n+h)}i.push(a.gpuDescriptorSetLayout),e.push(u),r.push(n),n+=o.length}this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n,dynamicOffsetOffsets:r}},i.destroy=function(){this._setLayouts.length=0},s(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(yi),FG=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],LG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuPipelineState=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var i=t.blendState,n=i.targets;n&&n.forEach((function(t,i){e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],s=0;s<31;s++)this._dynamicStates&1<<s&&r.push(1<<s);this._gpuPipelineState={glPrimitive:FG[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},i.destroy=function(){this._gpuPipelineState=null},s(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(wi),UG=function(t){function e(){return t.apply(this,arguments)||this}o(e,t);var i=e.prototype;return i.beginRenderPass=function(t,e,i,n,r,s){yG(ZU.instance,t.gpuRenderPass,e.gpuFramebuffer,i,n,r,s),this._isInRenderPass=!0},i.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;EG(ZU.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},i.setViewport=function(t){var e=ZU.instance,i=e.stateCache,n=e.gl;i.viewport.left===t.left&&i.viewport.top===t.top&&i.viewport.width===t.width&&i.viewport.height===t.height||(n.viewport(t.left,t.top,t.width,t.height),i.viewport.left=t.left,i.viewport.top=t.top,i.viewport.width=t.width,i.viewport.height=t.height)},i.setScissor=function(t){var e=ZU.instance,i=e.stateCache,n=e.gl;i.scissorRect.x===t.x&&i.scissorRect.y===t.y&&i.scissorRect.width===t.width&&i.scissorRect.height===t.height||(n.scissor(t.x,t.y,t.width,t.height),i.scissorRect.x=t.x,i.scissorRect.y=t.y,i.scissorRect.width=t.width,i.scissorRect.height=t.height)},i.updateBuffer=function(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var n,r=t.gpuBuffer;r&&(n=void 0!==i?i:t.usage&rt.INDIRECT?0:e.byteLength,mG(ZU.instance,r,e,0,n))}},i.copyBuffersToTexture=function(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var n=e.gpuTexture;n&&bG(ZU.instance,t,n,i)}},i.execute=function(t,e){for(var i=0;i<e;++i){var n=t[i];AG(ZU.instance,n.cmdPackage),this._numDrawCalls+=n._numDrawCalls,this._numInstances+=n._numInstances,this._numTris+=n._numTris}},i.bindStates=function(){TG(ZU.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(xG),GG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._type=t.type},i.destroy=function(){},i.submit=function(t){for(var e=t.length,i=0;i<e;i++){var n=t[i];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},i.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(bi),kG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuRenderPass=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},i.destroy=function(){this._gpuRenderPass=null},s(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(Oi),zG=[10497,33648,33071,33071],HG=function(t){function e(e,i){var n;(n=t.call(this,e,i)||this)._gpuSampler=null;var r,s,a=n._info.minFilter,o=n._info.magFilter,u=n._info.mipFilter;r=a===ft.LINEAR||a===ft.ANISOTROPIC?u===ft.LINEAR||u===ft.ANISOTROPIC?9987:u===ft.POINT?9985:9729:u===ft.LINEAR||u===ft.ANISOTROPIC?9986:u===ft.POINT?9984:9728,s=o===ft.LINEAR||o===ft.ANISOTROPIC?9729:9728;var h=zG[n._info.addressU],c=zG[n._info.addressV],l=zG[n._info.addressW];return n._gpuSampler={glMinFilter:r,glMagFilter:s,glWrapS:h,glWrapT:c,glWrapR:l},n}return o(e,t),s(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Mi),VG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuShader=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}},i.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var i=t.gl;if(!t.extensions.destroyShadersImmediately)for(var n=0;n<e.gpuStages.length;n++){var r=e.gpuStages[n];r.glShader&&(i.detachShader(e.glProgram,r.glShader),i.deleteShader(r.glShader),r.glShader=null)}i.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(ZU.instance,this._gpuShader),this._gpuShader=null)},s(e,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&function(t,e){for(var i=t.gl,n=function(t){var n=e.gpuStages[t],r=0,s="",a=1;switch(n.type){case Et.VERTEX:s="VertexShader",r=i.VERTEX_SHADER;break;case Et.FRAGMENT:s="FragmentShader",r=i.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var o=i.createShader(r);if(o&&(n.glShader=o,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(s+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",n.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(i.getShaderInfoLog(n.glShader));for(var u=0;u<e.gpuStages.length;u++){var h=e.gpuStages[t];h.glShader&&(i.deleteShader(h.glShader),h.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var s=n(r);if("object"==typeof s)return s.v}var a=i.createProgram();if(a){e.glProgram=a;for(var o=0;o<e.gpuStages.length;o++){var u=e.gpuStages[o];i.attachShader(e.glProgram,u.glShader)}if(i.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var h=0;h<e.gpuStages.length;h++){var c=e.gpuStages[h];c.glShader&&(i.detachShader(e.glProgram,c.glShader),i.deleteShader(c.glShader),c.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(i.getProgramInfoLog(e.glProgram));N("Shader '"+e.name+"' compilation succeeded.");var l=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(l);for(var _=0;_<l;++_){var d=i.getActiveAttrib(e.glProgram,_);if(d){var f,p=d.name.indexOf("[");f=-1!==p?d.name.substr(0,p):d.name;var m=i.getAttribLocation(e.glProgram,f),g=eG(d.type,i),v=iG(d.type,i);e.glInputs[_]={binding:m,name:f,type:g,stride:v,count:d.size,size:v*d.size,glType:d.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var y=0;y<e.blocks.length;++y){var T=e.blocks[y],E={set:T.set,binding:T.binding,name:T.name,size:0,glUniforms:new Array(T.members.length),glActiveUniforms:[]};e.glBlocks[y]=E;for(var S=0;S<T.members.length;++S){var A=T.members[S],R=$U(A.type,i),w=iG(R,i),b=w*A.count;E.glUniforms[S]={binding:-1,name:A.name,type:A.type,stride:w,count:A.count,size:b,offset:0,glType:R,glLoc:null,array:null}}}}for(var O=0;O<e.subpassInputs.length;++O){var M=e.subpassInputs[O];e.samplerTextures.push(new me(M.set,M.binding,M.name,nt.SAMPLER2D,M.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var I=0;I<e.samplerTextures.length;++I){var C=e.samplerTextures[I];e.glSamplerTextures[I]={set:C.set,binding:C.binding,name:C.name,type:C.type,count:C.count,units:[],glUnits:null,glType:$U(C.type,i),glLoc:null}}}for(var x=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORMS),B=0;B<x;++B){var P=i.getActiveUniform(e.glProgram,B);if(P&&P.type!==i.SAMPLER_2D&&P.type!==i.SAMPLER_CUBE){var D=i.getUniformLocation(e.glProgram,P.name);if(t.extensions.isLocationActive(D)){var F,L=P.name.indexOf("[");F=-1!==L?P.name.substr(0,L):P.name;for(var U=0;U<e.glBlocks.length;U++)for(var G=e.glBlocks[U],k=0;k<G.glUniforms.length;k++){var z=G.glUniforms[k];if(z.name===F){z.glLoc=D,z.count=P.size,z.size=z.stride*z.count,z.array=new(tG(z.type))(z.size/4),G.glActiveUniforms.push(z);break}}}}}for(var H=0;H<e.glBlocks.length;H++)for(var V=e.glBlocks[H],W=0;W<V.glUniforms.length;W++){var X=V.glUniforms[W];X.offset=V.size/4,V.size+=X.size}for(var j=[],Y=[],K=t.bindingMappings,q=t.stateCache.texUnitCacheMap,Q=0,Z=0;Z<e.blocks.length;++Z)e.blocks[Z].set===K.flexibleSet&&Q++;for(var J=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=i.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(j.push(e.glSamplerTextures[$]),Y.push(et)),void 0===q[tt.name]){var it=tt.binding+K.samplerTextureOffsets[tt.set]+J;tt.set===K.flexibleSet&&(it-=Q),q[tt.name]=it%t.capabilities.maxTextureUnits,J+=tt.count-1}}if(j.length){for(var rt=[],st=0;st<j.length;++st){var at=j[st],ot=q[at.name];if(void 0!==ot){at.glLoc=Y[st];for(var ut=0;ut<at.count;++ut){for(;rt[ot];)ot=(ot+1)%t.capabilities.maxTextureUnits;at.units.push(ot),rt[ot]=!0}}}for(var ht=0,ct=0;ct<j.length;++ct){var lt=j[ct];if(!t.extensions.isLocationActive(lt.glLoc)){lt.glLoc=Y[ct];for(var _t=0;_t<lt.count;++_t){for(;rt[ht];)ht=(ht+1)%t.capabilities.maxTextureUnits;void 0===q[lt.name]&&(q[lt.name]=ht),lt.units.push(ht),rt[ht]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(var dt=0;dt<j.length;dt++){var ft=j[dt];ft.glUnits=new Int32Array(ft.units),i.uniform1iv(ft.glLoc,ft.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}for(var pt=0;pt<e.glBlocks.length;)e.glBlocks[pt].glActiveUniforms.length?pt++:(e.glBlocks[pt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=j}}(ZU.instance,this._gpuShader),this._gpuShader}}]),e}(Ii),WG=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ee,this.scissorRect=new Kt(0,0,0,0),this.rs=new Ti,this.dss=new Ei,this.bs=new Ai,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),XG=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._gpuTexture=null,e._lodLevel=0,e}o(e,t);var i=e.prototype;return i.initialize=function(t,e){var i=t,n=t;"texture"in t&&(i=n.texture.info,this._isTextureView=!0),this._info.copy(i),this._isPowerOf2=$e(this._info.width)&&$e(this._info.height),this._size=ei(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(n),this._lodLevel=n.baseLevel,this._gpuTexture=n.texture._gpuTexture):(this._gpuTexture={type:i.type,format:i.format,usage:i.usage,width:i.width,height:i.height,depth:i.depth,size:this._size,arrayLayer:i.layerCount,mipLevel:i.levelCount,samples:i.samples,flags:i.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var i=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case et.A8:return e.ALPHA;case et.L8:return e.LUMINANCE;case et.LA8:return e.LUMINANCE_ALPHA;case et.RGB8:case et.RGB16F:case et.RGB32F:return e.RGB;case et.BGRA8:case et.RGBA8:case et.SRGB8_A8:case et.RGBA16F:case et.RGBA32F:return e.RGBA;case et.R5G6B5:return e.RGB;case et.RGB5A1:case et.RGBA4:return e.RGBA;case et.DEPTH:return e.DEPTH_COMPONENT;case et.DEPTH_STENCIL:return e.DEPTH_STENCIL;case et.BC1:return qU.COMPRESSED_RGB_S3TC_DXT1_EXT;case et.BC1_ALPHA:return qU.COMPRESSED_RGBA_S3TC_DXT1_EXT;case et.BC1_SRGB:return qU.COMPRESSED_SRGB_S3TC_DXT1_EXT;case et.BC1_SRGB_ALPHA:return qU.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case et.BC2:return qU.COMPRESSED_RGBA_S3TC_DXT3_EXT;case et.BC2_SRGB:return qU.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case et.BC3:return qU.COMPRESSED_RGBA_S3TC_DXT5_EXT;case et.BC3_SRGB:return qU.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case et.ETC_RGB8:return qU.COMPRESSED_RGB_ETC1_WEBGL;case et.ETC2_RGB8:return qU.COMPRESSED_RGB8_ETC2;case et.ETC2_SRGB8:return qU.COMPRESSED_SRGB8_ETC2;case et.ETC2_RGB8_A1:return qU.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case et.ETC2_SRGB8_A1:return qU.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case et.ETC2_RGBA8:return qU.COMPRESSED_RGBA8_ETC2_EAC;case et.ETC2_SRGB8_A8:return qU.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case et.EAC_R11:return qU.COMPRESSED_R11_EAC;case et.EAC_R11SN:return qU.COMPRESSED_SIGNED_R11_EAC;case et.EAC_RG11:return qU.COMPRESSED_RG11_EAC;case et.EAC_RG11SN:return qU.COMPRESSED_SIGNED_RG11_EAC;case et.PVRTC_RGB2:return qU.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case et.PVRTC_RGBA2:return qU.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case et.PVRTC_RGB4:return qU.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case et.PVRTC_RGBA4:return qU.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case et.ASTC_RGBA_4X4:return qU.COMPRESSED_RGBA_ASTC_4x4_KHR;case et.ASTC_RGBA_5X4:return qU.COMPRESSED_RGBA_ASTC_5x4_KHR;case et.ASTC_RGBA_5X5:return qU.COMPRESSED_RGBA_ASTC_5x5_KHR;case et.ASTC_RGBA_6X5:return qU.COMPRESSED_RGBA_ASTC_6x5_KHR;case et.ASTC_RGBA_6X6:return qU.COMPRESSED_RGBA_ASTC_6x6_KHR;case et.ASTC_RGBA_8X5:return qU.COMPRESSED_RGBA_ASTC_8x5_KHR;case et.ASTC_RGBA_8X6:return qU.COMPRESSED_RGBA_ASTC_8x6_KHR;case et.ASTC_RGBA_8X8:return qU.COMPRESSED_RGBA_ASTC_8x8_KHR;case et.ASTC_RGBA_10X5:return qU.COMPRESSED_RGBA_ASTC_10x5_KHR;case et.ASTC_RGBA_10X6:return qU.COMPRESSED_RGBA_ASTC_10x6_KHR;case et.ASTC_RGBA_10X8:return qU.COMPRESSED_RGBA_ASTC_10x8_KHR;case et.ASTC_RGBA_10X10:return qU.COMPRESSED_RGBA_ASTC_10x10_KHR;case et.ASTC_RGBA_12X10:return qU.COMPRESSED_RGBA_ASTC_12x10_KHR;case et.ASTC_RGBA_12X12:return qU.COMPRESSED_RGBA_ASTC_12x12_KHR;case et.ASTC_SRGBA_4X4:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case et.ASTC_SRGBA_5X4:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case et.ASTC_SRGBA_5X5:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case et.ASTC_SRGBA_6X5:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case et.ASTC_SRGBA_6X6:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case et.ASTC_SRGBA_8X5:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case et.ASTC_SRGBA_8X6:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case et.ASTC_SRGBA_8X8:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case et.ASTC_SRGBA_10X5:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case et.ASTC_SRGBA_10X6:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case et.ASTC_SRGBA_10X8:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case et.ASTC_SRGBA_10X10:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case et.ASTC_SRGBA_12X10:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case et.ASTC_SRGBA_12X12:return qU.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,i),e.glType=JU(e.format,i);var n=e.width,r=e.height;switch(e.type){case ut.TEX2D:if(e.glTarget=i.TEXTURE_2D,e.isSwapchainTexture)break;var s=Math.max(n,r);if(s>t.capabilities.maxTextureSize&&z(9100,s,t.capabilities.maxTextureSize),t.textureExclusive[e.format]||t.extensions.WEBGL_depth_texture||!Ke[e.format].hasDepth){if(e.glTexture=i.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Ke[e.format].isCompressed)for(var o=0;o<e.mipLevel;++o){var u=ti(e.format,n,r,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,o,e.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var c=0;c<e.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}}else e.glInternalFmt=function(t,e){switch(t){case et.R5G6B5:return e.RGB565;case et.RGB5A1:return e.RGB5_A1;case et.RGBA4:return e.RGBA4;case et.RGBA16F:return qU.RGBA16F_EXT;case et.RGBA32F:return qU.RGBA32F_EXT;case et.SRGB8_A8:return qU.SRGB8_ALPHA8_EXT;case et.DEPTH:return e.DEPTH_COMPONENT16;case et.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,i),e.glRenderbuffer=i.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,r));break;case ut.CUBE:e.glTarget=i.TEXTURE_CUBE_MAP;var l=Math.max(n,r);if(l>t.capabilities.maxCubeMapTextureSize&&z(9100,l,t.capabilities.maxTextureSize),e.glTexture=i.createTexture(),e.size>0){var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Ke[e.format].isCompressed)for(var d=0;d<6;++d){n=e.width,r=e.height;for(var f=0;f<e.mipLevel;++f){var p=ti(e.format,n,r,1),m=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,f,e.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var g=0;g<6;++g){n=e.width,r=e.height;for(var v=0;v<e.mipLevel;++v)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,v,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=ut.TEX2D,e.glTarget=i.TEXTURE_2D}}(ZU.instance,this._gpuTexture),ZU.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=t.type,this._viewInfo.format=t.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=t.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=t.layerCount)},i.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(t,e){var i=t.gl;if(e.glTexture){var n=t.stateCache.glTexUnits,r=t.stateCache.texUnit;i.deleteTexture(e.glTexture);for(var s=0;s<n.length;s++)n[s].glTexture===e.glTexture&&(i.activeTexture(i.TEXTURE0+s),r=s,i.bindTexture(e.glTarget,null),n[s].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;i.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(ZU.instance,this._gpuTexture),ZU.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},i.resize=function(t,i){if(this._info.width!==t||this._info.height!==i){this._info.levelCount===e.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=e.getLevelCount(t,i):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,e.getLevelCount(t,i)));var n=this._size;this._info.width=t,this._info.height=i,this._size=ei(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=i,this._gpuTexture.size=this._size,function(t,e){if(e.size){var i=t.gl,n=e.width,r=e.height;switch(e.type){case ut.TEX2D:e.glTarget=i.TEXTURE_2D;var s=Math.max(n,r);if(s>t.capabilities.maxTextureSize&&z(9100,s,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Ke[e.format].isCompressed)for(var o=0;o<e.mipLevel;++o){var u=ti(e.format,n,r,1),h=new Uint8Array(u);i.compressedTexImage2D(i.TEXTURE_2D,o,e.glInternalFmt,n,r,0,h),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}else for(var c=0;c<e.mipLevel;++c)i.texImage2D(i.TEXTURE_2D,c,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;case ut.CUBE:e.glTarget=i.TEXTURE_CUBE_MAP;var l=Math.max(n,r);l>t.capabilities.maxCubeMapTextureSize&&z(9100,l,t.capabilities.maxTextureSize);var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Ke[e.format].isCompressed)for(var d=0;d<6;++d){n=e.width,r=e.height;for(var f=0;f<e.mipLevel;++f){var p=ti(e.format,n,r,1),m=new Uint8Array(p);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+d,f,e.glInternalFmt,n,r,0,m),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}}else for(var g=0;g<6;++g){n=e.width,r=e.height;for(var v=0;v<e.mipLevel;++v)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+g,v,e.glInternalFmt,n,r,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=ut.TEX2D,e.glTarget=i.TEXTURE_2D}}}(ZU.instance,this._gpuTexture),ZU.instance.memoryStatus.textureSize-=n,ZU.instance.memoryStatus.textureSize+=this._size)}},i.initAsSwapchainTexture=function(t){var e=new le;e.format=t.format,e.usage=Ke[t.format].hasDepth?ht.DEPTH_STENCIL_ATTACHMENT:ht.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},s(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),e}(Ci),jG="webglcontextlost";function YG(t,e){for(var i=["","WEBKIT_","MOZ_"],n=0;n<i.length;++n){var r=t.getExtension(i[n]+e);if(r)return r}return null}function KG(t){var e={EXT_texture_filter_anisotropic:YG(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:YG(t,"EXT_blend_minmax"),EXT_frag_depth:YG(t,"EXT_frag_depth"),EXT_shader_texture_lod:YG(t,"EXT_shader_texture_lod"),EXT_sRGB:YG(t,"EXT_sRGB"),OES_vertex_array_object:YG(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:YG(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:YG(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:YG(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:YG(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:YG(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:YG(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:YG(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:YG(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:YG(t,"WEBGL_draw_buffers"),WEBGL_lose_context:YG(t,"WEBGL_lose_context"),WEBGL_depth_texture:YG(t,"WEBGL_depth_texture"),OES_texture_half_float:YG(t,"OES_texture_half_float"),OES_texture_half_float_linear:YG(t,"OES_texture_half_float_linear"),OES_texture_float:YG(t,"OES_texture_float"),OES_texture_float_linear:YG(t,"OES_texture_float_linear"),OES_standard_derivatives:YG(t,"OES_standard_derivatives"),OES_element_index_uint:YG(t,"OES_element_index_uint"),ANGLE_instanced_arrays:YG(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:YG(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return hs.os===ss.IOS&&14===hs.osMainVersion&&hs.isBrowser||(e.WEBGL_compressed_texture_astc=YG(t,"WEBGL_compressed_texture_astc")),hs.os!==ss.ANDROID&&hs.os!==ss.IOS&&(e.WEBGL_multi_draw=YG(t,"WEBGL_multi_draw")),hs.browserType===is.UC&&(e.ANGLE_instanced_arrays=null),hs.os===ss.IOS&&hs.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var qG,QG,ZG,JG,$G,tk,ek,ik,nk,rk=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).stateCache=new WG,e.cmdAllocator=new CG,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}o(e,t);var i=e.prototype;return i.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(jG,this._onWebGLContextLost);var e=ZU.instance.gl;this.stateCache.initialize(ZU.instance.capabilities.maxTextureUnits,ZU.instance.capabilities.maxVertexAttributes),this._extensions=KG(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var i=et.RGBA8,n=et.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),s=e.getParameter(e.STENCIL_BITS);r&&s?n=et.DEPTH_STENCIL:r&&(n=et.DEPTH),this._colorTexture=new XG,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this._depthStencilTexture=new XG,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this.nullTex2D=ZU.instance.createTexture(new le(ut.TEX2D,ht.SAMPLED,et.RGBA8,2,2,ct.GEN_MIPMAP)),this.nullTexCube=ZU.instance.createTexture(new le(ut.CUBE,ht.SAMPLED,et.RGBA8,2,2,ct.GEN_MIPMAP,6));var a=new te;a.texExtent.width=2,a.texExtent.height=2;var o=new Uint8Array(this.nullTex2D.size);o.fill(0),ZU.instance.copyBuffersToTexture([o],this.nullTex2D,[a]),a.texSubres.layerCount=6,ZU.instance.copyBuffersToTexture([o,o,o,o,o,o],this.nullTexCube,[a])},i.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(jG,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},i.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(N("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},i._onWebGLContextLost=function(t){G(11e3),I(t)},s(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(li),sk=t("WebGLDevice",function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._swapchain=null,e._context=null,e._bindingMappings=null,e._textureExclusive=new Array(et.COUNT),e}o(e,t);var i=e.prototype;return i.initialize=function(t){ZU.setInstance(this),this._gfxAPI=J.WEBGL;var e=this._bindingMappingInfo=t.bindingMappingInfo,i=[],n=[],r=e.setIndices[0];i[r]=0,n[r]=0;for(var s=1;s<e.setIndices.length;++s){var a=e.setIndices[s],o=e.setIndices[s-1];i[a]=e.maxBlockCounts[o]+i[o],n[a]=e.maxSamplerTextureCounts[o]+n[o]}for(var u=0;u<e.setIndices.length;++u){var h=e.setIndices[u];n[h]-=e.maxBlockCounts[h]}this._bindingMappings={blockOffsets:i,samplerTextureOffsets:n,flexibleSet:e.setIndices[e.setIndices.length-1]};var c=this._context=function(t){var e=null;try{var i={alpha:Xn.ENABLE_TRANSPARENT_CANVAS,antialias:Xn.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",i)}catch(t){return null}return e}(ci.canvas);if(!c)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new ze(Pt.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ke(this._queue)),this._caps.maxVertexAttributes=c.getParameter(c.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=c.getParameter(c.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var l=c.getSupportedExtensions(),_="";if(l)for(var d,f=p(l);!(d=f()).done;)_+=d.value+" ";var m=KG(c);m.WEBGL_debug_renderer_info?(this._renderer=c.getParameter(m.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=c.getParameter(m.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=c.getParameter(c.RENDERER),this._vendor=c.getParameter(c.VENDOR));var g=c.getParameter(c.VERSION);this._features.fill(!1),this.initFormatFeatures(m),m.EXT_blend_minmax&&(this._features[tt.BLEND_MINMAX]=!0),m.OES_element_index_uint&&(this._features[tt.ELEMENT_INDEX_UINT]=!0),m.ANGLE_instanced_arrays&&(this._features[tt.INSTANCED_ARRAYS]=!0),m.WEBGL_draw_buffers&&(this._features[tt.MULTIPLE_RENDER_TARGETS]=!0);var v="";return this.getFormatFeatures(et.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(et.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(et.BC1)&&(v+="dxt "),this.getFormatFeatures(et.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(et.ASTC_RGBA_4X4)&&(v+="astc "),N("WebGL device initialized."),N("RENDERER: "+this._renderer),N("VENDOR: "+this._vendor),N("VERSION: "+g),N("COMPRESSED_FORMAT: "+v),N("EXTENSIONS: "+_),!0},i.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null},i.flushCommands=function(){},i.acquire=function(){},i.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},i.initFormatFeatures=function(t){this._formatFeatures.fill(lt.NONE),this._textureExclusive.fill(!0);var e=lt.RENDER_TARGET|lt.SAMPLED_TEXTURE|lt.LINEAR_FILTER;this._formatFeatures[et.RGB8]=e,this._formatFeatures[et.R5G6B5]=e,this._textureExclusive[et.R5G6B5]=!1,this._formatFeatures[et.RGBA8]=e,this._formatFeatures[et.RGBA4]=e,this._textureExclusive[et.RGBA4]=!1,this._formatFeatures[et.RGB5A1]=e,this._textureExclusive[et.RGB5A1]=!1,this._formatFeatures[et.DEPTH]=lt.RENDER_TARGET,this._textureExclusive[et.DEPTH]=!1,this._formatFeatures[et.DEPTH_STENCIL]=lt.RENDER_TARGET,this._textureExclusive[et.DEPTH_STENCIL]=!1,this._formatFeatures[et.R8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RG8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGB8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGBA8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.R8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RG8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGB8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGBA8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.R8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RG8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGB8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGBA8I]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.R8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RG8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGB8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGBA8UI]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.R32F]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RG32F]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGB32F]|=lt.VERTEX_ATTRIBUTE,this._formatFeatures[et.RGBA32F]|=lt.VERTEX_ATTRIBUTE,t.EXT_sRGB&&(this._formatFeatures[et.SRGB8]=e,this._formatFeatures[et.SRGB8_A8]=e,this._textureExclusive[et.SRGB8_A8]=!1),t.WEBGL_depth_texture&&(this._formatFeatures[et.DEPTH]|=e,this._formatFeatures[et.DEPTH_STENCIL]|=e),t.WEBGL_color_buffer_float&&(this._formatFeatures[et.RGB32F]|=lt.RENDER_TARGET,this._formatFeatures[et.RGBA32F]|=lt.RENDER_TARGET,this._textureExclusive[et.RGB32F]=!1,this._textureExclusive[et.RGBA32F]=!1),t.EXT_color_buffer_half_float&&(this._formatFeatures[et.RGB16F]|=lt.RENDER_TARGET,this._formatFeatures[et.RGBA16F]|=lt.RENDER_TARGET,this._textureExclusive[et.RGB16F]=!1,this._textureExclusive[et.RGBA16F]=!1),t.OES_texture_float&&(this._formatFeatures[et.RGB32F]|=lt.RENDER_TARGET|lt.SAMPLED_TEXTURE,this._formatFeatures[et.RGBA32F]|=lt.RENDER_TARGET|lt.SAMPLED_TEXTURE),t.OES_texture_half_float&&(this._formatFeatures[et.RGB16F]|=lt.RENDER_TARGET|lt.SAMPLED_TEXTURE,this._formatFeatures[et.RGBA16F]|=lt.RENDER_TARGET|lt.SAMPLED_TEXTURE),t.OES_texture_float_linear&&(this._formatFeatures[et.RGB32F]|=lt.LINEAR_FILTER,this._formatFeatures[et.RGBA32F]|=lt.LINEAR_FILTER),t.OES_texture_half_float_linear&&(this._formatFeatures[et.RGB16F]|=lt.LINEAR_FILTER,this._formatFeatures[et.RGBA16F]|=lt.LINEAR_FILTER);var i=lt.SAMPLED_TEXTURE|lt.LINEAR_FILTER;t.WEBGL_compressed_texture_etc1&&(this._formatFeatures[et.ETC_RGB8]=i),t.WEBGL_compressed_texture_etc&&(this._formatFeatures[et.ETC2_RGB8]=i,this._formatFeatures[et.ETC2_RGBA8]=i,this._formatFeatures[et.ETC2_SRGB8]=i,this._formatFeatures[et.ETC2_SRGB8_A8]=i,this._formatFeatures[et.ETC2_RGB8_A1]=i,this._formatFeatures[et.ETC2_SRGB8_A1]=i),t.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[et.BC1]=i,this._formatFeatures[et.BC1_ALPHA]=i,this._formatFeatures[et.BC1_SRGB]=i,this._formatFeatures[et.BC1_SRGB_ALPHA]=i,this._formatFeatures[et.BC2]=i,this._formatFeatures[et.BC2_SRGB]=i,this._formatFeatures[et.BC3]=i,this._formatFeatures[et.BC3_SRGB]=i),t.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[et.PVRTC_RGB2]|=i,this._formatFeatures[et.PVRTC_RGBA2]|=i,this._formatFeatures[et.PVRTC_RGB4]|=i,this._formatFeatures[et.PVRTC_RGBA4]|=i),t.WEBGL_compressed_texture_astc&&(this._formatFeatures[et.ASTC_RGBA_4X4]|=i,this._formatFeatures[et.ASTC_RGBA_5X4]|=i,this._formatFeatures[et.ASTC_RGBA_5X5]|=i,this._formatFeatures[et.ASTC_RGBA_6X5]|=i,this._formatFeatures[et.ASTC_RGBA_6X6]|=i,this._formatFeatures[et.ASTC_RGBA_8X5]|=i,this._formatFeatures[et.ASTC_RGBA_8X6]|=i,this._formatFeatures[et.ASTC_RGBA_8X8]|=i,this._formatFeatures[et.ASTC_RGBA_10X5]|=i,this._formatFeatures[et.ASTC_RGBA_10X6]|=i,this._formatFeatures[et.ASTC_RGBA_10X8]|=i,this._formatFeatures[et.ASTC_RGBA_10X10]|=i,this._formatFeatures[et.ASTC_RGBA_12X10]|=i,this._formatFeatures[et.ASTC_RGBA_12X12]|=i,this._formatFeatures[et.ASTC_SRGBA_4X4]|=i,this._formatFeatures[et.ASTC_SRGBA_5X4]|=i,this._formatFeatures[et.ASTC_SRGBA_5X5]|=i,this._formatFeatures[et.ASTC_SRGBA_6X5]|=i,this._formatFeatures[et.ASTC_SRGBA_6X6]|=i,this._formatFeatures[et.ASTC_SRGBA_8X5]|=i,this._formatFeatures[et.ASTC_SRGBA_8X6]|=i,this._formatFeatures[et.ASTC_SRGBA_8X8]|=i,this._formatFeatures[et.ASTC_SRGBA_10X5]|=i,this._formatFeatures[et.ASTC_SRGBA_10X6]|=i,this._formatFeatures[et.ASTC_SRGBA_10X8]|=i,this._formatFeatures[et.ASTC_SRGBA_10X10]|=i,this._formatFeatures[et.ASTC_SRGBA_12X10]|=i,this._formatFeatures[et.ASTC_SRGBA_12X12]|=i)},i.createCommandBuffer=function(t){var e=new(t.type===Ft.PRIMARY?UG:xG);return e.initialize(t),e},i.createSwapchain=function(t){var e=new rk;return this._swapchain=e,e.initialize(t),e},i.createBuffer=function(t){var e=new MG;return e.initialize(t),e},i.createTexture=function(t){var e=new XG;return e.initialize(t),e},i.createDescriptorSet=function(t){var e=new QU;return e.initialize(t),e},i.createShader=function(t){var e=new VG;return e.initialize(t),e},i.createInputAssembler=function(t){var e=new BG;return e.initialize(t),e},i.createRenderPass=function(t){var e=new kG;return e.initialize(t),e},i.createFramebuffer=function(t){var e=new NG;return e.initialize(t),e},i.createDescriptorSetLayout=function(t){var e=new PG;return e.initialize(t),e},i.createPipelineLayout=function(t){var e=new DG;return e.initialize(t),e},i.createPipelineState=function(t){var e=new LG;return e.initialize(t),e},i.createQueue=function(t){var e=new GG;return e.initialize(t),e},i.getSampler=function(t){var e=Mi.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new HG(t,e)),this._samplers.get(e)},i.getSwapchains=function(){return[this._swapchain]},i.getGeneralBarrier=function(t){var e=xi.computeHash(t);return this._generalBarrierss.has(e)||this._generalBarrierss.set(e,new xi(t,e)),this._generalBarrierss.get(e)},i.getTextureBarrier=function(t){var e=Ni.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Ni(t,e)),this._textureBarriers.get(e)},i.getBufferBarrier=function(t){var e=Bi.computeHash(t);return this._bufferBarriers.has(e)||this._bufferBarriers.set(e,new Bi(t,e)),this._bufferBarriers.get(e)},i.copyBuffersToTexture=function(t,e,i){bG(this,t,e.gpuTexture,i)},i.copyTextureToBuffers=function(t,e,i){!function(t,e,i,n){var r=t.gl,s=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var o=0,u=0,h=1,c=1;switch(e.glTarget){case r.TEXTURE_2D:for(var l=0;l<n.length;l++){var _=n[l];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),o=_.texOffset.x,u=_.texOffset.y,h=_.texExtent.width,c=_.texExtent.height,r.readPixels(o,u,h,c,e.glFormat,e.glType,i[l])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),s.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,i)},i.copyTexImagesToTexture=function(t,e,i){!function(t,e,i,n){var r=t.gl,s=t.stateCache.glTexUnits[t.stateCache.texUnit];s.glTexture!==i.glTexture&&(r.bindTexture(i.glTarget,i.glTexture),s.glTexture=i.glTexture);var a=0,o=0;switch(i.glTarget){case r.TEXTURE_2D:for(var u=0;u<n.length;u++){var h=n[u];r.texSubImage2D(r.TEXTURE_2D,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,i.glFormat,i.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var c=0;c<n.length;c++){var l=n[c],_=l.texSubres.baseArrayLayer+l.texSubres.layerCount;for(o=l.texSubres.baseArrayLayer;o<_;++o)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+o,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,i.glFormat,i.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&ct.GEN_MIPMAP&&i.isPowerOf2&&r.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)},s(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),e}(ci));v.WebGLDevice=sk,t("Billboard",(qG=ao("cc.Billboard"),QG=xo(fy),ZG=xo(fy),qG(($G=function(t){function e(){var e;return(e=t.call(this)||this)._texture=tk&&tk(),e._height=ek&&ek(),e._width=ik&&ik(),e._rotation=nk&&nk(),e._model=null,e._mesh=null,e._material=null,e._uniform=new ta(1,1,0,0),e}o(e,t);var i=e.prototype;return i.onLoad=function(){this.createModel()},i.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},i.onDisable=function(){this.detachFromScene()},i.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},i.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i.createModel=function(){this._mesh=$b({primitiveMode:Ot.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Aa.WHITE.r,Aa.WHITE.g,Aa.WHITE.b,Aa.WHITE.a,Aa.WHITE.r,Aa.WHITE.g,Aa.WHITE.b,Aa.WHITE.a,Aa.WHITE.r,Aa.WHITE.g,Aa.WHITE.b,Aa.WHITE.a,Aa.WHITE.r,Aa.WHITE.g,Aa.WHITE.b,Aa.WHITE.a],attributes:[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RG32F),new Ae(Vt.ATTR_COLOR,et.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=v.director.root.createModel(fO,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new $T,this._material.copy(IT.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},s(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*Os(this._rotation))/100},set:function(t){this._rotation=bs(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}(el),tk=Za($G.prototype,"_texture",[QG],(function(){return null})),m($G.prototype,"texture",[ZG],Object.getOwnPropertyDescriptor($G.prototype,"texture"),$G.prototype),ek=Za($G.prototype,"_height",[mo],(function(){return 0})),ik=Za($G.prototype,"_width",[mo],(function(){return 0})),nk=Za($G.prototype,"_rotation",[mo],(function(){return 0})),JG=$G))||JG));var ak,ok,uk,hk=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RGBA32F),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0)],ck=new js,lk=new js,_k=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e.type=nO.LINE,e._capacity=100,e._iaInfo=new ce([new ue]),e._iaInfoBuffer=e._device.createBuffer(new ae(rt.INDIRECT,ot.DEVICE,Je,Je)),e}o(e,t);var i=e.prototype;return i.setCapacity=function(t){this._capacity=t,this.createBuffer()},i.createBuffer=function(){this._vertSize=0;for(var t,e=p(hk);!(t=e()).done;){var i=t.value;i.offset=this._vertSize,this._vertSize+=Ke[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},i.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),n=0,r=0;r<this._capacity-1;++r){var s=2*r;i[n++]=s,i[n++]=s+1,i[n++]=s+2,i[n++]=s+3,i[n++]=s+2,i[n++]=s+1}var a=this._device.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(i),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Ob([t],hk,Ot.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.addLineVertexData=function(t,e,i){if(t.length>1){var n=0;js.subtract(ck,t[1],t[0]),this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=0,this._vdataF32[n++]=ck.x,this._vdataF32[n++]=ck.y,this._vdataF32[n++]=ck.z,this._vdataUint32[n++]=i.evaluate(0,1)._val,this._vdataF32[n++]=t[0].x,this._vdataF32[n++]=t[0].y,this._vdataF32[n++]=t[0].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(0,1),this._vdataF32[n++]=0,this._vdataF32[n++]=1,this._vdataF32[n++]=ck.x,this._vdataF32[n++]=ck.y,this._vdataF32[n++]=ck.z,this._vdataUint32[n++]=i.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){js.subtract(ck,t[r-1],t[r]),js.subtract(lk,t[r+1],t[r]),js.subtract(lk,lk,ck);var s=r/t.length;this._vdataF32[n++]=t[r].x,this._vdataF32[n++]=t[r].y,this._vdataF32[n++]=t[r].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(s,1),this._vdataF32[n++]=s,this._vdataF32[n++]=0,this._vdataF32[n++]=lk.x,this._vdataF32[n++]=lk.y,this._vdataF32[n++]=lk.z,this._vdataUint32[n++]=i.evaluate(s,1)._val,this._vdataF32[n++]=t[r].x,this._vdataF32[n++]=t[r].y,this._vdataF32[n++]=t[r].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(s,1),this._vdataF32[n++]=s,this._vdataF32[n++]=1,this._vdataF32[n++]=lk.x,this._vdataF32[n++]=lk.y,this._vdataF32[n++]=lk.z,this._vdataUint32[n++]=i.evaluate(s,1)._val}js.subtract(ck,t[t.length-1],t[t.length-2]),this._vdataF32[n++]=t[t.length-1].x,this._vdataF32[n++]=t[t.length-1].y,this._vdataF32[n++]=t[t.length-1].z,this._vdataF32[n++]=0,this._vdataF32[n++]=e.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=0,this._vdataF32[n++]=ck.x,this._vdataF32[n++]=ck.y,this._vdataF32[n++]=ck.z,this._vdataUint32[n++]=i.evaluate(1,1)._val,this._vdataF32[n++]=t[t.length-1].x,this._vdataF32[n++]=t[t.length-1].y,this._vdataF32[n++]=t[t.length-1].z,this._vdataF32[n++]=1,this._vdataF32[n++]=e.evaluate(1,1),this._vdataF32[n++]=1,this._vdataF32[n++]=1,this._vdataF32[n++]=ck.x,this._vdataF32[n++]=ck.y,this._vdataF32[n++]=ck.z,this._vdataUint32[n++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},i.updateIA=function(t){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(fO),dk=Dr.Attr.setClassAttr,fk=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],pk=Ln({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),mk=t("CurveRange",ao("cc.CurveRange")((uk=ok=function(){function t(){this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1,this._mode=pk.Constant}var e=t.prototype;return e.evaluate=function(t,e){switch(this.mode){default:case pk.Constant:return this.constant;case pk.Curve:return this.spline.evaluate(t)*this.multiplier;case pk.TwoCurves:return ws(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case pk.TwoConstants:return ws(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this.mode){default:case pk.Constant:return this.constant;case pk.Curve:return this.multiplier;case pk.TwoConstants:return this.constantMax;case pk.TwoCurves:return this.multiplier}},e.getMaxAbs=function(){switch(this.mode){default:case pk.Constant:return this.constant;case pk.Curve:return this.multiplier;case pk.TwoConstants:return Math.max(Math.abs(this.constantMax),Math.abs(this.constantMin));case pk.TwoCurves:return this.multiplier}},e._onBeforeSerialize=function(){return fk[this.mode]},s(t,[{key:"mode",get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case pk.Constant:case pk.TwoConstants:break;case pk.Curve:this.spline||(this.spline=Wd());break;case pk.TwoCurves:this.splineMax||(this.splineMax=Wd()),this.splineMin||(this.splineMin=Wd())}}},{key:"curve",get:function(){var t;return null!==(t=this._curve)&&void 0!==t?t:this._curve=new zd(this.spline)},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){var t;return null!==(t=this._curveMin)&&void 0!==t?t:this._curveMin=new zd(this.splineMin)},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){var t;return null!==(t=this._curveMax)&&void 0!==t?t:this._curveMax=new zd(this.splineMax)},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}(),ok.Mode=pk,ak=uk))||ak);function gk(t,e,i){switch(t.mode){case pk.Constant:return t.constant;case pk.Curve:return t.spline.evaluate(e)*t.multiplier;case pk.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case pk.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function vk(t){switch(t.mode){case pk.TwoConstants:case pk.TwoCurves:return 2;default:return 1}}function yk(t,e,i,n){return null===t||i!==t.width||n!==t.height?(t&&t.destroy(),t=function(t,e,i){var n=new $v({width:e,height:i,_data:t,_compressed:!1,format:cf.RGBA32F}),r=new fy;return r.setFilters(_f.NEAREST,_f.NEAREST),r.setMipFilter(_f.NONE),r.setWrapMode(lf.CLAMP_TO_EDGE,lf.CLAMP_TO_EDGE,lf.CLAMP_TO_EDGE),r.image=n,r}(e,i,n)):t.uploadData(e),t}function Tk(t,e,i,n,r,s,a){var o=Math.max(vk(n),vk(r),vk(s)),u=i*o*4;null!==e&&e.length===u||(e=new Float32Array(i*o*4));for(var h=[n,r,s],c=1/(i-1),l=0;l<o;l++)for(var _=0;_<3;_++)for(var d=h[_],f=0,p=0,m=0;m<i;m++){var g=gk(d,c*m,l);p=a?g:(f+=g)/(m+1),e[4*(l*i+m)+_]=p}return{texture:yk(t,e,i,o),texdata:e}}Dr.fastDefine("cc.CurveRange",mk,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:pk.Constant,splineMax:Object.freeze(Wd()),splineMin:Object.freeze(Wd()),spline:Object.freeze(Wd())}),dk(mk,"multiplier","visible",!0),dk(mk,"constantMax","visible",!0),dk(mk,"constantMin","visible",!0),dk(mk,"constant","visible",!0),dk(mk,"mode","type","Enum"),dk(mk,"mode","enumList",Ln.getList(pk)),dk(mk,"mode","visible",!0),dk(mk,"splineMax","type","Object"),dk(mk,"splineMax","ctor",X_),dk(mk,"splineMax","visible",!0),dk(mk,"splineMin","type","Object"),dk(mk,"splineMin","ctor",X_),dk(mk,"splineMin","visible",!0),dk(mk,"spline","type","Object"),dk(mk,"spline","ctor",X_),dk(mk,"spline","visible",!0);var Ek=Ln({Blend:0,Fixed:1}),Sk=t("ColorKey",(function(){this.color=Aa.WHITE.clone(),this.time=0}));Dr.fastDefine("cc.ColorKey",Sk,{color:Aa.WHITE.clone(),time:0}),Dr.Attr.setClassAttr(Sk,"color","visible",!0),Dr.Attr.setClassAttr(Sk,"time","visible",!0);var Ak=t("AlphaKey",(function(){this.alpha=1,this.time=0}));Dr.fastDefine("cc.AlphaKey",Ak,{alpha:1,time:0}),Dr.Attr.setClassAttr(Ak,"alpha","visible",!0),Dr.Attr.setClassAttr(Ak,"time","visible",!0);var Rk,wk,bk,Ok,Mk,Ik,Ck,xk,Nk,Bk,Pk,Dk,Fk,Lk,Uk,Gk,kk,zk=t("Gradient",function(){function t(){this.colorKeys=new Array,this.alphaKeys=new Array,this.mode=Ek.Blend,this._color=void 0,this._color=Aa.WHITE.clone()}var e=t.prototype;return e.setKeys=function(t,e){this.colorKeys=t,this.alphaKeys=e},e.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(t,e){return t.time-e.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(t,e){return t.time-e.time}))},e.evaluate=function(t){return this.getRGB(t),this._color._set_a_unsafe(this.getAlpha(t)),this._color},e.randomColor=function(){var t=this.colorKeys[Math.trunc(Is()*this.colorKeys.length)],e=this.alphaKeys[Math.trunc(Is()*this.alphaKeys.length)];return this._color.set(t.color),this._color._set_a_unsafe(e.alpha),this._color},e.getRGB=function(t){if(this.colorKeys.length>1){t=ks(t,1);for(var e=1;e<this.colorKeys.length;++e){var i=this.colorKeys[e-1].time,n=this.colorKeys[e].time;if(t>=i&&t<n){if(this.mode===Ek.Fixed)return this.colorKeys[e].color;var r=(t-i)/(n-i);return Aa.lerp(this._color,this.colorKeys[e-1].color,this.colorKeys[e].color,r),this._color}}var s=this.colorKeys.length-1;return t<this.colorKeys[0].time?Aa.lerp(this._color,Aa.BLACK,this.colorKeys[0].color,t/this.colorKeys[0].time):t>this.colorKeys[s].time&&Aa.lerp(this._color,this.colorKeys[s].color,Aa.BLACK,(t-this.colorKeys[s].time)/(1-this.colorKeys[s].time)),this._color}return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Aa.WHITE),this._color)},e.getAlpha=function(t){if(this.alphaKeys.length>1){t=ks(t,1);for(var e=1;e<this.alphaKeys.length;++e){var i=this.alphaKeys[e-1].time,n=this.alphaKeys[e].time;if(t>=i&&t<n){if(this.mode===Ek.Fixed)return this.alphaKeys[e].alpha;var r=(t-i)/(n-i);return ws(this.alphaKeys[e-1].alpha,this.alphaKeys[e].alpha,r)}}var s=this.alphaKeys.length-1;return t<this.alphaKeys[0].time?ws(0,this.alphaKeys[0].alpha,t/this.alphaKeys[0].time):t>this.alphaKeys[s].time?ws(this.alphaKeys[s].alpha,0,(t-this.alphaKeys[s].time)/(1-this.alphaKeys[s].time)):255}return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255},t}());zk.Mode=Ek,Dr.fastDefine("cc.Gradient",zk,{colorKeys:[],alphaKeys:[],mode:Ek.Blend}),Dr.Attr.setClassAttr(zk,"colorKeys","visible",!0),Dr.Attr.setClassAttr(zk,"alphaKeys","visible",!0),Dr.Attr.setClassAttr(zk,"mode","visible",!0);var Hk,Vk,Wk,Xk,jk,Yk,Kk,qk,Qk,Zk,Jk,$k,tz,ez,iz,nz,rz,sz,az,oz,uz,hz,cz=Ln({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),lz=t("GradientRange",(Rk=ao("cc.GradientRange"),wk=xo(cz),bk=xo(zk),Ok=xo(zk),Mk=xo(zk),Ik=xo(cz),Rk((kk=Gk=function(){function t(){this.color=Nk&&Nk(),this.colorMin=Bk&&Bk(),this.colorMax=Pk&&Pk(),this.gradient=Dk&&Dk(),this.gradientMin=Fk&&Fk(),this.gradientMax=Lk&&Lk(),this._mode=Uk&&Uk(),this._color=Aa.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case cz.Color:return this.color;case cz.TwoColors:return Aa.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case cz.RandomColor:return this.gradient.randomColor();case cz.Gradient:return this.gradient.evaluate(t);case cz.TwoGradients:return Aa.lerp(this._color,this.gradientMin.evaluate(t),this.gradientMax.evaluate(t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return(!1)[this._mode]},s(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}(),Gk.Mode=cz,m((xk=kk).prototype,"mode",[wk],Object.getOwnPropertyDescriptor(xk.prototype,"mode"),xk.prototype),Nk=Za(xk.prototype,"color",[mo],(function(){return Aa.WHITE.clone()})),Bk=Za(xk.prototype,"colorMin",[mo],(function(){return Aa.WHITE.clone()})),Pk=Za(xk.prototype,"colorMax",[mo],(function(){return Aa.WHITE.clone()})),Dk=Za(xk.prototype,"gradient",[bk],(function(){return new zk})),Fk=Za(xk.prototype,"gradientMin",[Ok],(function(){return new zk})),Lk=Za(xk.prototype,"gradientMax",[Mk],(function(){return new zk})),Uk=Za(xk.prototype,"_mode",[Ik],(function(){return cz.Color})),Ck=xk))||Ck));function _z(t,e,i){switch(t.mode){case cz.Color:return t.color;case cz.TwoColors:return 0===i?t.colorMin:t.colorMax;case cz.RandomColor:return t.gradient.randomColor();case cz.Gradient:return t.gradient.evaluate(e);case cz.TwoGradients:return 0===i?t.gradientMin.evaluate(e):t.gradientMax.evaluate(e);default:return t.color}}var dz={parent:null,owner:null,subModelIdx:0},fz={CC_USE_WORLD_SPACE:!1},pz=(t("Line",(Hk=ao("cc.Line"),Vk=xo(fy),Wk=xo(fy),Xk=xo($T),jk=xo([js]),Yk=xo([js]),Kk=xo(mk),qk=xo(mk),Qk=xo(Qs),Zk=xo(Qs),Jk=xo(lz),$k=xo(lz),Hk((ez=function(t){function e(){var e;return(e=t.call(this)||this)._texture=iz&&iz(),e._material=nz&&nz(),e._materialInstance=null,e._worldSpace=rz&&rz(),e._positions=sz&&sz(),e._width=az&&az(),e._tile=oz&&oz(),e._offset=uz&&uz(),e._color=hz&&hz(),e._model=null,e._tile_offset=new ta,e}o(e,t);var i=e.prototype;return i.onLoad=function(){var t=this._model=v.director.root.createModel(_k);t.node=t.transform=this.node,null===this._material&&(this._material=new $T,this._material.copy(IT.get("default-trail-material"))),this._material&&(fz.CC_USE_WORLD_SPACE=this.worldSpace,dz.parent=this._material,dz.subModelIdx=0,this._materialInstance=new _E(dz),dz.parent=null,dz.subModelIdx=0,this._materialInstance.recompileShaders(fz)),t.updateMaterial(this._materialInstance),t.setCapacity(100)},i.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},i.onDisable=function(){this._model&&this._detachFromScene()},i._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},i._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},s(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._materialInstance&&this._materialInstance.setProperty("mainTexture",t)}},{key:"material",get:function(){return this._material},set:function(t){this._material=t}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t,this._materialInstance&&(fz.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(fz),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),e}(el),iz=Za(ez.prototype,"_texture",[Vk],(function(){return null})),m(ez.prototype,"texture",[Wk],Object.getOwnPropertyDescriptor(ez.prototype,"texture"),ez.prototype),nz=Za(ez.prototype,"_material",[mo],(function(){return null})),m(ez.prototype,"material",[Xk],Object.getOwnPropertyDescriptor(ez.prototype,"material"),ez.prototype),rz=Za(ez.prototype,"_worldSpace",[mo],(function(){return!1})),sz=Za(ez.prototype,"_positions",[jk],(function(){return[]})),m(ez.prototype,"positions",[Yk],Object.getOwnPropertyDescriptor(ez.prototype,"positions"),ez.prototype),az=Za(ez.prototype,"_width",[Kk],(function(){return new mk})),m(ez.prototype,"width",[qk],Object.getOwnPropertyDescriptor(ez.prototype,"width"),ez.prototype),oz=Za(ez.prototype,"_tile",[mo],(function(){return new Qs(1,1)})),m(ez.prototype,"tile",[Qk],Object.getOwnPropertyDescriptor(ez.prototype,"tile"),ez.prototype),uz=Za(ez.prototype,"_offset",[mo],(function(){return new Qs(0,0)})),m(ez.prototype,"offset",[Zk],Object.getOwnPropertyDescriptor(ez.prototype,"offset"),ez.prototype),hz=Za(ez.prototype,"_color",[Jk],(function(){return new lz})),m(ez.prototype,"color",[$k],Object.getOwnPropertyDescriptor(ez.prototype,"color"),ez.prototype),tz=ez))||tz)),function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.initialVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.custom1=void 0,this.custom2=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.id=void 0,this.delay=void 0,this.active=void 0,this.parentParticle=void 0,this.trigged=void 0,this.dir=void 0,this.time=void 0,this.timeCounter=void 0,this.distanceCounter=void 0,this.particleSystem=t,this.position=new js(0,0,0),this.velocity=new js(0,0,0),this.animatedVelocity=new js(0,0,0),this.ultimateVelocity=new js(0,0,0),this.angularVelocity=new js(0,0,0),this.initialVelocity=new js(0,0,0),this.axisOfRotation=new js(0,0,0),this.rotation=new js(0,0,0),this.startEuler=new js(0,0,0),this.startRotation=new sa,this.startRotated=!1,this.deltaQuat=new sa,this.deltaMat=new da,this.localMat=new da,this.startSize=new js(0,0,0),this.size=new js(0,0,0),this.startColor=Aa.WHITE.clone(),this.color=Aa.WHITE.clone(),this.custom1=new ta,this.custom2=new ta,this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0,this.id=-1,this.active=!1,this.parentParticle=null,this.trigged=!1,this.dir=new sa,this.time=0,this.timeCounter=0,this.distanceCounter=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity(),this.delay=0,this.parentParticle=null,this.trigged=!1,this.initialVelocity.set(0,0,0),this.dir.set(sa.IDENTITY),this.time=0,this.timeCounter=0,this.distanceCounter=0,this.custom1.set(0,0,0,0),this.custom2.set(0,0,0,0)},t}());pz.INDENTIFY_NEG_QUAT=10,pz.R2D=180/Math.PI;var mz,gz,vz,yz,Tz,Ez,Sz,Az,Rz,wz,bz,Oz,Mz,Iz,Cz,xz,Nz,Bz,Pz="colorModule",Dz="rotationModule",Fz="sizeModule",Lz="textureModule",Uz="noiseModule",Gz="rotationSpeedModule",kz=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule","noiseModule","forcefieldModule","inheritVelocityModule","customDataModule","rotationSpeedModule"],zz=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_trailModule","_forcefieldModule","_inheritVelocityModule","_customDataModule","_rotationSpeedModule"],Hz=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),Vz=Ln({World:0,Local:1,Custom:2}),Wz=Ln({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),Xz=Ln({World:0,Local:1,View:2}),jz=Ln({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),Yz=Ln({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),Kz=Ln({Base:0,Edge:1,Shell:2,Volume:3}),qz=Ln({Random:0,Loop:1,PingPong:2}),Qz=Ln({Particles:0}),Zz=Ln({Stretch:0}),Jz=(mz=ao("cc.ColorOvertimeModule"),gz=xo(lz),mz((yz=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=Tz&&Tz(),e.color=Ez&&Ez(),e.name=Pz,e}return o(e,t),e.prototype.animate=function(t){t.color.set(t.startColor),t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,Fs(t.randomSeed+91041)))},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),Tz=Za(yz.prototype,"_enable",[mo],(function(){return!1})),Ez=Za(yz.prototype,"color",[gz,mo],(function(){return new lz})),vz=yz))||vz),$z=new js(0,0,-1);function tH(t,e,i,n){return e!==t?(t===Vz.World||da.invert(i,i),da.getRotation(n,i),!0):(sa.set(n,0,0,0,1),!1)}function eH(t,e){Qs.set(t,Math.cos(e),Math.sin(e))}function iH(t){var e=Ps(-1,1),i=Ps(0,2*Math.PI),n=Math.sqrt(1-e*e),r=n*Math.cos(i),s=n*Math.sin(i);js.set(t,r,s,e)}function nH(t,e,i){iH(t),js.multiplyScalar(t,t,e+(i-e)*Is())}function rH(t,e,i,n){eH(t,n),t.z=0,js.multiplyScalar(t,t,e+(i-e)*Is())}function sH(t){for(var e=0;e<t.length;e++){var i=e+Ds(0,t.length-e),n=t[i];t[i]=t[e],t[e]=n}}function aH(){var t=Ps(-1,1);return 0===t&&t++,ls(t)}var oH,uH,hH,cH,lH,_H,dH,fH,pH,mH,gH,vH,yH,TH,EH,SH,AH,RH,wH,bH,OH,MH,IH,CH,xH,NH,BH,PH,DH,FH,LH,UH,GH,kH,zH,HH=212165,VH=new js,WH=(Sz=ao("cc.ForceOvertimeModule"),Az=xo(mk),Rz=xo(mk),wz=xo(mk),bz=xo(Vz),Sz((Mz=function(t){function e(){var e;return(e=t.call(this)||this)._enable=Iz&&Iz(),e.x=Cz&&Cz(),e.y=xz&&xz(),e.z=Nz&&Nz(),e.space=Bz&&Bz(),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new sa,e.needTransform=!1,e.needUpdate=!0,e}o(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=tH(t,this.space,e,this.rotation)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,n=js.set(VH,this.x.evaluate(i,Fs(t.randomSeed+HH)),this.y.evaluate(i,Fs(t.randomSeed+HH)),this.z.evaluate(i,Fs(t.randomSeed+HH)));this.needTransform&&js.transformQuat(n,n,this.rotation),js.scaleAndAdd(t.velocity,t.velocity,n,e),js.copy(t.ultimateVelocity,t.velocity)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),Iz=Za(Mz.prototype,"_enable",[mo],(function(){return!1})),Cz=Za(Mz.prototype,"x",[Az,mo],(function(){return new mk})),xz=Za(Mz.prototype,"y",[Rz,mo],(function(){return new mk})),Nz=Za(Mz.prototype,"z",[wz,mo],(function(){return new mk})),Bz=Za(Mz.prototype,"space",[bz,mo],(function(){return Vz.Local})),Oz=Mz))||Oz),XH=23541,jH=new js,YH=new js,KH=new js,qH=(oH=ao("cc.LimitVelocityOvertimeModule"),uH=xo(mk),hH=xo(mk),cH=xo(mk),lH=xo(mk),_H=xo(Vz),dH=xo(mk),fH=xo(fr),pH=xo(pr),mH=xo(pr),oH((vH=function(t){function e(){var e;return(e=t.call(this)||this)._enable=yH&&yH(),e.limitX=TH&&TH(),e.limitY=EH&&EH(),e.limitZ=SH&&SH(),e.limit=AH&&AH(),e.dampen=RH&&RH(),e.separateAxes=wH&&wH(),e.space=bH&&bH(),e.drag=OH&&OH(),e.sizeFactor=MH&&MH(),e.multiplyDragByParticleSize=IH&&IH(),e.multiplyDragByParticleVelocity=CH&&CH(),e.name="limitModule",e.rotation=void 0,e.invRot=void 0,e.needTransform=void 0,e.rotation=new sa,e.invRot=new sa,e.needTransform=!1,e.needUpdate=!0,e}o(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=tH(t,this.space,e,this.rotation)},i.applyDrag=function(t,e,i,n){if(0!==this.drag.getMaxAbs()){var r=1-t.remainingLifetime/t.startLifetime,s=this.drag.evaluate(r,Fs(t.randomSeed+23542)),a=t.size.x>t.size.y?t.size.x:t.size.y;a=a>t.size.z?a:t.size.z,a*=.5,a*=this.sizeFactor;var o=Math.PI*a*a,u=s;u*=this.multiplyDragByParticleSize?o:1;var h=n-(u*=this.multiplyDragByParticleVelocity?n*n:1)*e;h=h<0?0:h,YH.set(i.x*h,i.y*h,i.z*h)}},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime;if(jH.set(t.animatedVelocity),YH.set(t.velocity.x+jH.x,t.velocity.y+jH.y,t.velocity.z+jH.z),this.separateAxes){var n=this.limitX.evaluate(i,Fs(t.randomSeed+XH)),r=this.limitY.evaluate(i,Fs(t.randomSeed+XH)),s=this.limitZ.evaluate(i,Fs(t.randomSeed+XH));this.needTransform&&js.transformQuat(YH,YH,this.rotation),js.set(YH,QH(YH.x,n,this.dampen),QH(YH.y,r,this.dampen),QH(YH.z,s,this.dampen)),js.normalize(KH,YH);var a=YH.length();this.applyDrag(t,e,KH,a),YH.set(YH.x-jH.x,YH.y-jH.y,YH.z-jH.z),this.needTransform&&(sa.invert(this.invRot,this.rotation),js.transformQuat(YH,YH,this.invRot))}else{var o=this.limit.evaluate(i,Fs(t.randomSeed+XH)),u=YH.length();js.normalize(KH,YH);var h=QH(u,o,this.dampen);YH.set(KH.x*h,KH.y*h,KH.z*h),js.normalize(KH,YH),u=YH.length(),this.applyDrag(t,e,KH,u),YH.set(YH.x-jH.x,YH.y-jH.y,YH.z-jH.z)}t.velocity.set(YH)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),yH=Za(vH.prototype,"_enable",[mo],(function(){return!1})),TH=Za(vH.prototype,"limitX",[uH,mo],(function(){return new mk})),EH=Za(vH.prototype,"limitY",[hH,mo],(function(){return new mk})),SH=Za(vH.prototype,"limitZ",[cH,mo],(function(){return new mk})),AH=Za(vH.prototype,"limit",[lH,mo],(function(){return new mk})),RH=Za(vH.prototype,"dampen",[mo],(function(){return 3})),wH=Za(vH.prototype,"separateAxes",[mo],(function(){return!1})),bH=Za(vH.prototype,"space",[_H,mo],(function(){return Vz.Local})),OH=Za(vH.prototype,"drag",[dH,mo],(function(){return new mk})),MH=Za(vH.prototype,"sizeFactor",[fH,mo],(function(){return 1})),IH=Za(vH.prototype,"multiplyDragByParticleSize",[pH,mo],(function(){return!1})),CH=Za(vH.prototype,"multiplyDragByParticleVelocity",[mH,mo],(function(){return!1})),gH=vH))||gH);function QH(t,e,i){var n=Math.sign(t),r=Math.abs(t);return r>e&&(r=ws(r,e,i)),r*n}var ZH,JH,$H,tV,eV,iV,nV,rV,sV,aV,oV,uV,hV,cV,lV,_V,dV,fV,pV,mV,gV,vV,yV,TV,EV,SV,AV,RV,wV,bV,OV,MV,IV,CV,xV,NV,BV,PV,DV,FV,LV,UV,GV,kV,zV,HV,VV,WV,XV,jV,YV,KV,qV,QV,ZV,JV,$V,tW,eW,iW,nW,rW,sW,aW,oW,uW,hW,cW,lW,_W,dW,fW,pW,mW,gW,vW,yW,TW,EW,SW,AW,RW,wW,bW,OW,MW,IW,CW,xW,NW,BW,PW,DW,FW,LW,UW,GW,kW,zW,HW,VW=(xH=ao("cc.RotationOvertimeModule"),NH=xo(mk),BH=xo(mk),PH=xo(mk),xH((FH=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=LH&&LH(),e._separateAxes=UH&&UH(),e.x=GH&&GH(),e.y=kH&&kH(),e.z=zH&&zH(),e.name=Dz,e._startMat=new da,e._matRot=new da,e._quatRot=new sa,e._otherEuler=new js,e}o(e,t);var i=e.prototype;return i._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==jz.Mesh&&e===jz.StrecthedBillboard&&this._quatRot.set(0,0,0,1),sa.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=pz.INDENTIFY_NEG_QUAT)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,n=Fs(t.randomSeed+125292),r=t.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==jz.VerticalBillboard&&r!==jz.HorizontalBillboard?sa.fromEuler(t.deltaQuat,this.x.evaluate(i,n)*e*pz.R2D,this.y.evaluate(i,n)*e*pz.R2D,this.z.evaluate(i,n)*e*pz.R2D):sa.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,n)*e*pz.R2D),t.deltaMat=da.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==jz.Mesh&&(r===jz.StrecthedBillboard?t.startEuler.set(0,0,0):r!==jz.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),sa.fromEuler(t.startRotation,t.startEuler.x*pz.R2D,t.startEuler.y*pz.R2D,t.startEuler.z*pz.R2D),t.startRotated=!0),this._startMat=da.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),da.getRotation(this._quatRot,this._matRot),this._processRotation(t,pz.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(Hz),LH=Za(FH.prototype,"_enable",[mo],(function(){return!1})),UH=Za(FH.prototype,"_separateAxes",[mo],(function(){return!1})),GH=Za(FH.prototype,"x",[NH,mo],(function(){return new mk})),kH=Za(FH.prototype,"y",[BH,mo],(function(){return new mk})),zH=Za(FH.prototype,"z",[PH,mo],(function(){return new mk})),DH=FH))||DH),WW=(ZH=ao("cc.SizeOvertimeModule"),JH=xo(mk),$H=xo(mk),tV=xo(mk),eV=xo(mk),ZH((nV=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=rV&&rV(),e.separateAxes=sV&&sV(),e.size=aV&&aV(),e.x=oV&&oV(),e.y=uV&&uV(),e.z=hV&&hV(),e.name=Fz,e}return o(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=Fs(t.randomSeed+39825);t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,i),t.size.z=t.startSize.z*this.z.evaluate(e,i)}else js.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,Fs(t.randomSeed+39825)))},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),rV=Za(nV.prototype,"_enable",[mo],(function(){return!1})),sV=Za(nV.prototype,"separateAxes",[mo],(function(){return!1})),aV=Za(nV.prototype,"size",[JH,mo],(function(){return new mk})),oV=Za(nV.prototype,"x",[$H,mo],(function(){return new mk})),uV=Za(nV.prototype,"y",[tV,mo],(function(){return new mk})),hV=Za(nV.prototype,"z",[eV,mo],(function(){return new mk})),iV=nV))||iV),XW=90794,jW=Ln({Grid:0}),YW=Ln({WholeSheet:0,SingleRow:1}),KW=(cV=ao("cc.TextureAnimationModule"),lV=go("numTilesX"),_V=go("numTilesY"),dV=xo(jW),fV=xo(jW),pV=xo(YW),mV=xo(mk),gV=xo(mk),cV((yV=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=TV&&TV(),e._numTilesX=EV&&EV(),e._numTilesY=SV&&SV(),e._mode=AV&&AV(),e.animation=RV&&RV(),e.frameOverTime=wV&&wV(),e.startFrame=bV&&bV(),e.cycleCount=OV&&OV(),e._flipU=MV&&MV(),e._flipV=IV&&IV(),e._uvChannelMask=CV&&CV(),e.randomRow=xV&&xV(),e.rowIndex=NV&&NV(),e.name=Lz,e}o(e,t);var i=e.prototype;return i.init=function(t){t.startRow=Math.floor(Is()*this.numTilesY)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=this.startFrame.evaluate(e,Fs(t.randomSeed+XW))/(this.numTilesX*this.numTilesY);if(this.animation===YW.WholeSheet)t.frameIndex=ks(this.cycleCount*(this.frameOverTime.evaluate(e,Fs(t.randomSeed+XW))+i),1);else if(this.animation===YW.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var r=ks(this.cycleCount*(this.frameOverTime.evaluate(e,Fs(t.randomSeed+XW))+i),1),s=t.startRow*n,a=s+n;t.frameIndex=ws(s,a,r)}else{var o=this.rowIndex*n,u=o+n;t.frameIndex=ws(o,u,ks(this.cycleCount*(this.frameOverTime.evaluate(e,Fs(t.randomSeed+XW))+i),1))}}},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==jW.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(Hz),TV=Za(yV.prototype,"_enable",[mo],(function(){return!1})),EV=Za(yV.prototype,"_numTilesX",[lV],(function(){return 0})),SV=Za(yV.prototype,"_numTilesY",[_V],(function(){return 0})),AV=Za(yV.prototype,"_mode",[dV],(function(){return jW.Grid})),m(yV.prototype,"mode",[fV],Object.getOwnPropertyDescriptor(yV.prototype,"mode"),yV.prototype),RV=Za(yV.prototype,"animation",[pV,mo],(function(){return YW.WholeSheet})),wV=Za(yV.prototype,"frameOverTime",[mV,mo],(function(){return new mk})),bV=Za(yV.prototype,"startFrame",[gV,mo],(function(){return new mk})),OV=Za(yV.prototype,"cycleCount",[mo],(function(){return 0})),MV=Za(yV.prototype,"_flipU",[mo],(function(){return 0})),IV=Za(yV.prototype,"_flipV",[mo],(function(){return 0})),CV=Za(yV.prototype,"_uvChannelMask",[mo],(function(){return-1})),xV=Za(yV.prototype,"randomRow",[mo],(function(){return!1})),NV=Za(yV.prototype,"rowIndex",[mo],(function(){return 0})),vV=yV))||vV),qW=197866,QW=156497,ZW=984136,JW=new js,$W=new sa,tX=new ia,eX=new js,iX=new js,nX=new js,rX=(BV=ao("cc.VelocityOvertimeModule"),PV=xo(mk),DV=xo(mk),FV=xo(mk),LV=xo(mk),UV=xo(mk),GV=xo(mk),kV=xo(mk),zV=xo(mk),HV=xo(mk),VV=xo(mk),WV=xo(mk),XV=xo(Vz),BV((YV=function(t){function e(){var e;return(e=t.call(this)||this)._enable=KV&&KV(),e.x=qV&&qV(),e.y=QV&&QV(),e.z=ZV&&ZV(),e.speedModifier=JV&&JV(),e.orbitX=$V&&$V(),e.orbitY=tW&&tW(),e.orbitZ=eW&&eW(),e.offsetX=iW&&iW(),e.offsetY=nW&&nW(),e.offsetZ=rW&&rW(),e.radius=sW&&sW(),e.space=aW&&aW(),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.worldToLocal=void 0,e.localToWorld=void 0,e.rotation=new sa,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e.worldToLocal=new ia,e.localToWorld=new ia,e}o(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=tH(t,this.space,e,this.rotation),this.needTransform&&(this.offsetX.getMaxAbs()>0||this.offsetY.getMaxAbs()>0||this.offsetZ.getMaxAbs()>0||this.orbitX.getMaxAbs()>0||this.orbitY.getMaxAbs()>0||this.orbitZ.getMaxAbs()>0)&&(ia.fromMat4(this.localToWorld,e),ia.invert(this.worldToLocal,this.localToWorld))},i.calculateOrbital=function(t,e,i){var n=this.offsetX.evaluate(i,Fs(t.randomSeed^qW)),r=this.offsetY.evaluate(i,Fs(t.randomSeed^qW)),s=this.offsetZ.evaluate(i,Fs(t.randomSeed^qW)),a=js.set(JW,n,r,s),o=this.radius.evaluate(i,Fs(t.randomSeed))*e,u=this.orbitX.evaluate(i,Fs(t.randomSeed^qW))*e*pz.R2D,h=this.orbitY.evaluate(i,Fs(t.randomSeed^QW))*e*pz.R2D,c=this.orbitZ.evaluate(i,Fs(t.randomSeed^ZW))*e*pz.R2D,l=ia.fromQuat(tX,sa.fromEuler($W,u,h,c));nX.set(t.position),this.needTransform&&js.transformMat3(nX,nX,this.worldToLocal),js.subtract(nX,nX,a),eX.set(nX),js.transformMat3(eX,eX,l),js.normalize(iX,eX),js.multiplyScalar(iX,iX,o),js.add(eX,eX,iX);var _=js.subtract(eX,eX,nX);this.needTransform&&(_=js.transformMat3(eX,eX,this.localToWorld)),js.multiplyScalar(_,_,1/e),js.add(t.animatedVelocity,t.animatedVelocity,_)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,n=js.set(JW,this.x.evaluate(i,Fs(t.randomSeed^qW)),this.y.evaluate(i,Fs(t.randomSeed^QW)),this.z.evaluate(i,Fs(t.randomSeed^ZW)));this.needTransform&&js.transformQuat(n,n,this.rotation),js.add(t.animatedVelocity,t.animatedVelocity,n);var r=this.speedModifier.evaluate(i,Fs(t.randomSeed+qW));(this.offsetX.getMaxAbs()>0||this.offsetY.getMaxAbs()>0||this.offsetZ.getMaxAbs()>0||this.orbitX.getMaxAbs()>0||this.orbitY.getMaxAbs()>0||this.orbitZ.getMaxAbs()>0)&&this.calculateOrbital(t,e,i,r),js.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),js.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,r)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),KV=Za(YV.prototype,"_enable",[mo],(function(){return!1})),qV=Za(YV.prototype,"x",[PV,mo],(function(){return new mk})),QV=Za(YV.prototype,"y",[DV,mo],(function(){return new mk})),ZV=Za(YV.prototype,"z",[FV,mo],(function(){return new mk})),JV=Za(YV.prototype,"speedModifier",[LV,mo],(function(){return new mk})),$V=Za(YV.prototype,"orbitX",[UV,mo],(function(){return new mk})),tW=Za(YV.prototype,"orbitY",[GV,mo],(function(){return new mk})),eW=Za(YV.prototype,"orbitZ",[kV,mo],(function(){return new mk})),iW=Za(YV.prototype,"offsetX",[zV,mo],(function(){return new mk})),nW=Za(YV.prototype,"offsetY",[HV,mo],(function(){return new mk})),rW=Za(YV.prototype,"offsetZ",[VV,mo],(function(){return new mk})),sW=Za(YV.prototype,"radius",[WV,mo],(function(){return new mk})),aW=Za(YV.prototype,"space",[XV,mo],(function(){return Vz.Local})),jV=YV))||jV),sX=t("Burst",(oW=ao("cc.Burst"),uW=xo(mk),oW((cW=function(){function t(){this._time=lW&&lW(),this._repeatCount=_W&&_W(),this.repeatInterval=dW&&dW(),this.count=fW&&fW(),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e,i){if(i){var n=Fs(1712326^i.randomSeed);t.emit(this.count.evaluate(i.time/t.duration,n),e,i)}else{if(0===this._remainingCount){this._remainingCount=this._repeatCount;var r=t.startDelay.evaluate(0,Is());this._curTime=this._time+r}if(this._remainingCount>0){var s=ks(t.time,t.duration)-e;s=s>0?s:0;var a=ks(t.time,t.duration);this._curTime>=s&&this._curTime<a&&(i||t.emit(this.count.evaluate(this._curTime/t.duration,Is()),e-(a-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},s(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),lW=Za(cW.prototype,"_time",[mo],(function(){return 0})),_W=Za(cW.prototype,"_repeatCount",[mo],(function(){return 1})),dW=Za(cW.prototype,"repeatInterval",[mo],(function(){return 1})),fW=Za(cW.prototype,"count",[uW,mo],(function(){return new mk})),hW=cW))||hW)),aX=new js(0,0,0),oX=[],uX=new js(.5,.5,.5),hX=(pW=ao("cc.ShapeModule"),mW=xo(Yz),gW=go("shapeType"),vW=xo(Yz),yW=xo(Kz),TW=xo(qz),EW=xo(mk),pW((AW=function(){function t(){this._enable=RW&&RW(),this._shapeType=wW&&wW(),this.emitFrom=bW&&bW(),this.alignToDirection=OW&&OW(),this.randomDirectionAmount=MW&&MW(),this.sphericalDirectionAmount=IW&&IW(),this.randomPositionAmount=CW&&CW(),this.radius=xW&&xW(),this.radiusThickness=NW&&NW(),this.arcMode=BW&&BW(),this.arcSpread=PW&&PW(),this.arcSpeed=DW&&DW(),this.length=FW&&FW(),this.boxThickness=LW&&LW(),this._position=UW&&UW(),this._rotation=GW&&GW(),this._scale=kW&&kW(),this._arc=zW&&zW(),this._angle=HW&&HW(),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new da,this.quat=new sa,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case Yz.Box:!function(t,e,i,n){switch(t){case Kz.Volume:r=i,s=uX,js.set(r,Ps(-s.x,s.x),Ps(-s.y,s.y),Ps(-s.z,s.z));break;case Kz.Shell:oX.splice(0,oX.length),oX.push(Ps(-.5,.5)),oX.push(Ps(-.5,.5)),oX.push(.5*aH()),sH(oX),cX(oX,e),js.set(i,oX[0],oX[1],oX[2]);break;case Kz.Edge:oX.splice(0,oX.length),oX.push(Ps(-.5,.5)),oX.push(.5*aH()),oX.push(.5*aH()),sH(oX),cX(oX,e),js.set(i,oX[0],oX[1],oX[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,s;js.copy(n,$z)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case Yz.Circle:!function(t,e,i,n,r){rH(n,t*(1-e),t,i),js.normalize(r,n)}(this.radius,this.radiusThickness,this.generateArcAngle(),t.position,t.velocity);break;case Yz.Cone:!function(t,e,i,n,r,s,a,o){switch(t){case Kz.Base:rH(a,e*(1-i),e,n),Qs.multiplyScalar(o,a,Math.sin(r)),o.z=-Math.cos(r)*e,js.normalize(o,o),a.z=0;break;case Kz.Shell:eH(a,n),Qs.multiplyScalar(o,a,Math.sin(r)),o.z=-Math.cos(r),js.normalize(o,o),Qs.multiplyScalar(a,a,e),a.z=0;break;case Kz.Volume:rH(a,e*(1-i),e,n),Qs.multiplyScalar(o,a,Math.sin(r)),o.z=-Math.cos(r)*e,js.normalize(o,o),a.z=0,js.add(a,a,js.multiplyScalar(aX,o,s*Is()/-o.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case Yz.Sphere:!function(t,e,i,n,r){switch(t){case Kz.Volume:nH(n,e*(1-i),e),js.normalize(r,n);break;case Kz.Shell:iH(n),js.multiplyScalar(n,n,e),js.normalize(r,n);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case Yz.Hemisphere:!function(t,e,i,n,r){switch(t){case Kz.Volume:nH(n,e*(1-i),e),n.z>0&&(n.z*=-1),js.normalize(r,n);break;case Kz.Shell:iH(n),js.multiplyScalar(n,n,e),n.z>0&&(n.z*=-1),js.normalize(r,n);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(t.position.x+=Ps(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=Ps(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=Ps(-this.randomPositionAmount,this.randomPositionAmount)),js.transformQuat(t.velocity,t.velocity,this.quat),js.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var e=js.normalize(aX,t.position);js.lerp(t.velocity,t.velocity,e,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){sa.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),da.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===qz.Random)return Ps(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case qz.Loop:return ks(t,this._arc);case qz.PingPong:return zs(t,this._arc);default:return ks(t,this._arc)}},s(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return Os(this._arc)},set:function(t){this._arc=bs(t)}},{key:"angle",get:function(){return Math.round(100*Os(this._angle))/100},set:function(t){this._angle=bs(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case Yz.Box:this.emitFrom===Kz.Base&&(this.emitFrom=Kz.Volume);break;case Yz.Cone:this.emitFrom===Kz.Edge&&(this.emitFrom=Kz.Base);break;case Yz.Sphere:case Yz.Hemisphere:this.emitFrom!==Kz.Base&&this.emitFrom!==Kz.Edge||(this.emitFrom=Kz.Volume)}}}]),t}(),RW=Za(AW.prototype,"_enable",[mo],(function(){return!1})),wW=Za(AW.prototype,"_shapeType",[mW,gW],(function(){return Yz.Cone})),m(AW.prototype,"shapeType",[vW],Object.getOwnPropertyDescriptor(AW.prototype,"shapeType"),AW.prototype),bW=Za(AW.prototype,"emitFrom",[yW,mo],(function(){return Kz.Volume})),OW=Za(AW.prototype,"alignToDirection",[mo],(function(){return!1})),MW=Za(AW.prototype,"randomDirectionAmount",[mo],(function(){return 0})),IW=Za(AW.prototype,"sphericalDirectionAmount",[mo],(function(){return 0})),CW=Za(AW.prototype,"randomPositionAmount",[mo],(function(){return 0})),xW=Za(AW.prototype,"radius",[mo],(function(){return 1})),NW=Za(AW.prototype,"radiusThickness",[mo],(function(){return 1})),BW=Za(AW.prototype,"arcMode",[TW,mo],(function(){return qz.Random})),PW=Za(AW.prototype,"arcSpread",[mo],(function(){return 0})),DW=Za(AW.prototype,"arcSpeed",[EW,mo],(function(){return new mk})),FW=Za(AW.prototype,"length",[mo],(function(){return 5})),LW=Za(AW.prototype,"boxThickness",[mo],(function(){return new js(0,0,0)})),UW=Za(AW.prototype,"_position",[mo],(function(){return new js(0,0,0)})),GW=Za(AW.prototype,"_rotation",[mo],(function(){return new js(0,0,0)})),kW=Za(AW.prototype,"_scale",[mo],(function(){return new js(1,1,1)})),zW=Za(AW.prototype,"_arc",[mo],(function(){return bs(360)})),HW=Za(AW.prototype,"_angle",[mo],(function(){return bs(25)})),SW=AW))||SW);function cX(t,e){e.x>0&&(t[0]+=.5*Ps(-e.x,e.x),t[0]=As(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*Ps(-e.y,e.y),t[1]=As(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*Ps(-e.z,e.z),t[2]=As(t[2],-.5,.5))}var lX=[0,0,1,0,0,1,1,1],_X=[0,0,0,1,0,0,0,1,0,1,1,0],dX=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertAttribSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._iaInfo=void 0,e._iaInfoBuffer=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e._vertAttribSizeStatic=void 0,e._vertStaticAttrsFloatCount=void 0,e._insBuffers=void 0,e._insIndices=void 0,e._useInstance=void 0,e.type=nO.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertAttribSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._vertAttribSizeStatic=0,e._vertStaticAttrsFloatCount=0,e._insBuffers=[],e._insIndices=null,Wa.gfxDevice.hasFeature(tt.INSTANCED_ARRAYS)?e._useInstance=!0:e._useInstance=!1,e._iaInfo=new ce([new ue]),e._iaInfoBuffer=e._device.createBuffer(new ae(rt.INDIRECT,ot.HOST|ot.DEVICE,Je,Je)),e._subMeshData=null,e._mesh=null,e}o(e,t);var i=e.prototype;return i.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},i.setVertexAttributes=function(t,e){if(this._useInstance)this.setVertexAttributesIns(t,e);else{if(this._mesh===t&&this._vertAttrs===e)return;this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0;for(var i,n=p(this._vertAttrs);!(i=n()).done;){var r=i.value;r.offset=this._vertAttribSize,this._vertAttribSize+=Ke[r.format].size}this._vertAttrsFloatCount=this._vertAttribSize/4,this.rebuild()}},i.setVertexAttributesIns=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0,this._vertAttribSizeStatic=0;for(var i,n=p(this._vertAttrs);!(i=n()).done;){var r=i.value;0===r.stream?(r.offset=this._vertAttribSize,this._vertAttribSize+=Ke[r.format].size):1===r.stream&&(r.offset=this._vertAttribSizeStatic,this._vertAttribSizeStatic+=Ke[r.format].size)}this._vertAttrsFloatCount=this._vertAttribSize/4,this._vertStaticAttrsFloatCount=this._vertAttribSizeStatic/4,this.rebuild()}},i.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,this._vertAttribSize*this._capacity*this._vertCount,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===Vt.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,Vt.ATTR_TEX_COORD,e,this._vertAttribSize,i);var n=this._vertAttrs.findIndex((function(t){return t.name===Vt.ATTR_TEX_COORD3}));if(i=this._vertAttrs[n++].offset,this._mesh.copyAttribute(0,Vt.ATTR_POSITION,e,this._vertAttribSize,i),i=this._vertAttrs[n++].offset,this._mesh.copyAttribute(0,Vt.ATTR_NORMAL,e,this._vertAttribSize,i),i=this._vertAttrs[n++].offset,!this._mesh.copyAttribute(0,Vt.ATTR_COLOR,e,this._vertAttribSize,i))for(var r=new Uint32Array(e),s=0;s<this._vertCount;++s)r[s*this._vertAttrsFloatCount+i/4]=Aa.WHITE._val;for(var a=new Float32Array(e),o=1;o<this._capacity;o++)a.copyWithin(o*this._vertAttribSize*this._vertCount/4,0,this._vertAttribSize*this._vertCount/4)}t.update(e);var u=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,u);for(var h=1;h<this._capacity;h++)for(var c=0;c<this._indexCount;c++)u[h*this._indexCount+c]=u[c]+h*this._vertCount}else for(var l=0,_=0;_<this._capacity;++_){var d=4*_;u[l++]=d,u[l++]=d+1,u[l++]=d+2,u[l++]=d+3,u[l++]=d+2,u[l++]=d+1}var f=this._device.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return f.update(u),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new ae(rt.INDIRECT,ot.HOST|ot.DEVICE,Je,Je))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Ob([t],this._vertAttrs,Ot.TRIANGLE_LIST,f,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),e},i.createSubMeshDataInsDynamic=function(){this.destroySubMeshData();var t=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,this._vertAttribSize*this._capacity,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._capacity);return t.update(e),this._insBuffers.push(t),e},i.createSubMeshDataInsStatic=function(){this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,this._vertAttribSizeStatic*this._vertCount,this._vertAttribSizeStatic)),e=new ArrayBuffer(this._vertAttribSizeStatic*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(t){return t.name===Vt.ATTR_TEX_COORD})),n=this._vertAttrs[i].offset;if(this._mesh.copyAttribute(0,Vt.ATTR_TEX_COORD,e,this._vertAttribSizeStatic,n),i=this._vertAttrs.findIndex((function(t){return t.name===Vt.ATTR_TEX_COORD3})),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Vt.ATTR_POSITION,e,this._vertAttribSizeStatic,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Vt.ATTR_NORMAL,e,this._vertAttribSizeStatic,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Vt.ATTR_COLOR,e,this._vertAttribSizeStatic,n))for(var r=new Uint32Array(e),s=0;s<this._vertCount;++s)r[s*this._vertStaticAttrsFloatCount+n/4]=Aa.WHITE._val}else for(var a=new Float32Array(e),o=0;o<_X.length;++o)a[o]=_X[o];t.update(e);var u=new Uint16Array(this._indexCount);this._mesh?this._mesh.copyIndices(0,u):(u[0]=0,u[1]=1,u[2]=2,u[3]=3,u[4]=2,u[5]=1);var h=this._device.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.DEVICE,this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));h.update(u),this._insIndices=h,this._iaInfo.drawInfos[0].vertexCount=this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new ae(rt.INDIRECT,ot.HOST|ot.DEVICE,Je,Je))),this._iaInfoBuffer.update(this._iaInfo),this._insBuffers.push(t)},i.createInsSubmesh=function(){this._subMeshData=new Ob(this._insBuffers,this._vertAttrs,Ot.TRIANGLE_LIST,this._insIndices,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material)},i.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},i.addParticleVertexData=function(t,e){if(this._useInstance)this.addParticleVertexDataIns(t,e);else if(this._mesh)for(var i=0;i<this._vertCount;i++){var n=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[n++]=e[0].x,this._vdataF32[n++]=e[0].y,this._vdataF32[n++]=e[0].z,n+=2,this._vdataF32[n++]=e[1].z,this._vdataF32[n++]=e[2].x,this._vdataF32[n++]=e[2].y,this._vdataF32[n++]=e[2].z,this._vdataF32[n++]=e[3].x,this._vdataF32[n++]=e[3].y,this._vdataF32[n++]=e[3].z,this._vdataUint32[n++]=e[4]}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=e[1].x,this._vdataF32[r++]=e[1].y,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4],e[5]&&(this._vdataF32[r++]=e[5].x,this._vdataF32[r++]=e[5].y,this._vdataF32[r++]=e[5].z)}},i.addParticleVertexDataIns=function(t,e){var i=t*this._vertAttrsFloatCount;this._mesh?(this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4],e[6]&&(this._vdataF32[i++]=e[6].x,this._vdataF32[i++]=e[6].y,this._vdataF32[i++]=e[6].z,this._vdataF32[i++]=e[6].w),e[7]&&(this._vdataF32[i++]=e[7].x,this._vdataF32[i++]=e[7].y,this._vdataF32[i++]=e[7].z,this._vdataF32[i++]=e[7].w)):(this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4],e[5]&&(this._vdataF32[i++]=e[5].x,this._vdataF32[i++]=e[5].y,this._vdataF32[i++]=e[5].z),e[6]&&(this._vdataF32[i++]=e[6].x,this._vdataF32[i++]=e[6].y,this._vdataF32[i++]=e[6].z,this._vdataF32[i++]=e[6].w),e[7]&&(this._vdataF32[i++]=e[7].x,this._vdataF32[i++]=e[7].y,this._vdataF32[i++]=e[7].z,this._vdataF32[i++]=e[7].w))},i.addGPUParticleVertexData=function(t,e,i){if(this._useInstance)this.addGPUParticleVertexDataIns(t,e,i);else for(var n=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var s=n;this._vdataF32[s++]=t.position.x,this._vdataF32[s++]=t.position.y,this._vdataF32[s++]=t.position.z,this._vdataF32[s++]=i,this._vdataF32[s++]=t.startSize.x,this._vdataF32[s++]=t.startSize.y,this._vdataF32[s++]=t.startSize.z,this._vdataF32[s++]=lX[2*r],this._vdataF32[s++]=t.rotation.x,this._vdataF32[s++]=t.rotation.y,this._vdataF32[s++]=t.rotation.z,this._vdataF32[s++]=lX[2*r+1],this._vdataF32[s++]=t.startColor.r/255,this._vdataF32[s++]=t.startColor.g/255,this._vdataF32[s++]=t.startColor.b/255,this._vdataF32[s++]=t.startColor.a/255,this._vdataF32[s++]=t.velocity.x,this._vdataF32[s++]=t.velocity.y,this._vdataF32[s++]=t.velocity.z,this._vdataF32[s++]=t.startLifetime,this._vdataF32[s++]=t.randomSeed,n+=this._vertAttrsFloatCount}},i.addGPUParticleVertexDataIns=function(t,e,i){var n=e*this._vertAttrsFloatCount,r=n;this._vdataF32[r++]=t.position.x,this._vdataF32[r++]=t.position.y,this._vdataF32[r++]=t.position.z,this._vdataF32[r++]=i,this._vdataF32[r++]=t.startSize.x,this._vdataF32[r++]=t.startSize.y,this._vdataF32[r++]=t.startSize.z,this._vdataF32[r++]=t.frameIndex,this._vdataF32[r++]=t.rotation.x,this._vdataF32[r++]=t.rotation.y,this._vdataF32[r++]=t.rotation.z,this._vdataF32[r++]=t.randomSeed,this._vdataF32[r++]=t.startColor.r/255,this._vdataF32[r++]=t.startColor.g/255,this._vdataF32[r++]=t.startColor.b/255,this._vdataF32[r++]=t.startColor.a/255,this._vdataF32[r++]=t.velocity.x,this._vdataF32[r++]=t.velocity.y,this._vdataF32[r++]=t.velocity.z,this._vdataF32[r++]=t.startLifetime,n+=this._vertAttrsFloatCount},i.updateGPUParticles=function(t,e,i){if(this._useInstance)return this.updateGPUParticlesIns(t,e,i);for(var n=this._vertAttrsFloatCount*this._vertCount,r=0,s=0,a=0,o=0;o<t;++o)r=o*n,s=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-s)<i&&(a=--t*n,this._vdataF32.copyWithin(r,a,a+n),o--);return t},i.updateGPUParticlesIns=function(t,e,i){for(var n=this._vertAttrsFloatCount,r=0,s=0,a=0,o=0;o<t;++o)r=o*n,s=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-s)<i&&(a=--t*n,this._vdataF32.copyWithin(r,a,a+n),o--);return t},i.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},i.updateIA=function(t){if(this._useInstance)this.updateIAIns(t);else{if(t<=0)return;this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*t,this._iaInfoBuffer.update(this._iaInfo)}},i.updateIAIns=function(t){if(!(t<=0)){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.instanceCount=t,this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount,this._iaInfo.drawInfos[0].instanceCount=t,this._iaInfoBuffer.update(this._iaInfo)}},i.clear=function(){this._useInstance?this.clearIns():this._subModels[0].inputAssembler.indexCount=0},i.clearIns=function(){this._subModels[0].inputAssembler.instanceCount=0},i.destroy=function(){t.prototype.destroy.call(this),this.doDestroy()},i.doDestroy=function(){this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._insBuffers=[],this._insIndices=null,this._vertAttrs=null,this._material=null,this._mesh=null,this.destroySubMeshData()},i.rebuild=function(){this._useInstance?this.rebuildIns():(this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer))},i.rebuildIns=function(){this._vBuffer=this.createSubMeshDataInsDynamic(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this.createSubMeshDataInsStatic(),this.createInsSubmesh()},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null),this._iaInfoBuffer&&(this._iaInfoBuffer=null)},s(e,[{key:"useInstance",get:function(){return this._useInstance},set:function(t){this._useInstance!==t&&(this._useInstance=t)}}]),e}(fO),fX=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._useInstance=void 0,this._useCustom=void 0,this._renderInfo=t,Wa.gfxDevice.hasFeature(tt.INSTANCED_ARRAYS)?this._useInstance=!0:this._useInstance=!1,this._useCustom=!1}var e=t.prototype;return e.getUseCustom=function(){return this._useCustom},e.setUseCustom=function(t){this._useCustom=t},e.getUseInstance=function(){return this._useInstance},e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(v.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&(this.updateVertexAttrib(),this._model.setVertexAttributes(this._renderInfo.renderMode===jz.Mesh?this._renderInfo.mesh:null,this._vertAttrs))},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){this._model||(this._model=v.director.root.createModel(dX),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},t}(),pX=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180,151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],mX=[new js(1,1,0),new js(-1,1,0),new js(1,-1,0),new js(-1,-1,0),new js(1,0,1),new js(-1,0,1),new js(1,0,-1),new js(-1,0,-1),new js(0,1,1),new js(0,-1,1),new js(0,1,-1),new js(0,-1,-1),new js(1,1,0),new js(-1,1,0),new js(0,-1,1),new js(0,-1,-1)],gX=15;function vX(t){return t*t*t*(t*(6*t-15)+10)}function yX(t){return 30*t*t*(t*(t-2)+1)}new Qs(1,0),new Qs(-1,0),new Qs(0,1),new Qs(0,-1),new Qs(1,1).normalize(),new Qs(-1,1).normalize(),new Qs(1,-1).normalize(),new Qs(-1,-1).normalize();var TX=new js,EX=new js,SX=function(){function t(){this.ix0=0,this.iy0=0,this.iz0=0,this.ix1=0,this.iy1=0,this.iz1=0,this.g000=new js,this.g100=new js,this.g010=new js,this.g110=new js,this.g001=new js,this.g101=new js,this.g011=new js,this.g111=new js,this.db=new js,this.dc=new js,this.dd=new js,this.de=new js,this.df=new js,this.dg=new js,this.dh=new js}return t.prototype.updateCache=function(t,e,i){if(!(t<this.ix1&&t>this.ix0&&e<this.iy1&&e>this.iy0&&i<this.iz1&&i>this.iz0)){var n=this.ix0=Math.floor(t),r=this.iy0=Math.floor(e),s=this.iz0=Math.floor(i);this.ix1=this.ix0+1,this.iy1=this.iy0+1,this.iz1=this.iz0+1;var a=1+(r&=255),o=1+(s&=255),u=pX[n&=255],h=pX[n+1],c=pX[u+r],l=pX[h+r],_=pX[u+a],d=pX[h+a],f=this.g000=mX[pX[c+s]&gX],p=this.g100=mX[pX[l+s]&gX],m=this.g010=mX[pX[_+s]&gX],g=this.g110=mX[pX[d+s]&gX],v=this.g001=mX[pX[c+o]&gX],y=this.g101=mX[pX[l+o]&gX],T=this.g011=mX[pX[_+o]&gX],E=this.g111=mX[pX[d+o]&gX],S=this.db,A=this.dc,R=this.de,w=this.df,b=this.dg,O=this.dh;Qs.subtract(S,p,f),Qs.subtract(A,m,f),Qs.subtract(this.dd,v,f),Qs.subtract(R,g,m),Qs.subtract(R,R,S),Qs.subtract(w,y,v),Qs.subtract(w,w,S),Qs.subtract(b,T,v),Qs.subtract(b,b,A),Qs.subtract(O,E,T),Qs.subtract(O,O,w),Qs.subtract(O,O,R),Qs.subtract(O,O,S)}},t}();function AX(t,e,i,n){return t.x*e+t.y*i+t.z*n}var RX,wX,bX,OX,MX,IX,CX,xX,NX,BX,PX,DX,FX,LX,UX,GX,kX,zX,HX,VX,WX,XX,jX=new js,YX=new Qs,KX=new Qs,qX=new Qs,QX=new Qs,ZX=function(){function t(){this.accSpeed=new js,this.noiseSpeed=new js,this.noiseFrequency=0,this.noiseAbs=new js,this.noiseAmplitude=new js,this.octaves=new js,this.dt=0,this.point=new js,this.result=new js,this.mixOut=new Qs,this.noiseCache=void 0,this.noiseCache=new SX}var e=t.prototype;return e.noise=function(t,e,i,n,r){return jX.set(e,i,n),function(t,e,i,n){var r=e.x*i,s=e.y*i,a=e.z*i;n.updateCache(r,s,a);var o=r-n.ix0,u=s-n.iy0,h=a-n.iz0,c=o-1,l=u-1,_=h-1,d=AX(n.g000,o,u,h),f=AX(n.g100,c,u,h),p=AX(n.g010,o,l,h),m=AX(n.g110,c,l,h),g=AX(n.g001,o,u,_),v=AX(n.g101,c,u,_),y=AX(n.g011,o,l,_),T=AX(n.g111,c,l,_),E=vX(o),S=vX(u),A=vX(h),R=yX(o),w=yX(u),b=f-d,O=p-d,M=m-p-b,I=v-g-b,C=y-g-O,x=T-y-I-M-b;return Qs.scaleAndAdd(TX,Qs.scaleAndAdd(TX,Qs.scaleAndAdd(TX,n.g000,Qs.scaleAndAdd(TX,n.dc,n.de,E),S),n.db,E),Qs.scaleAndAdd(EX,Qs.scaleAndAdd(EX,n.dd,Qs.scaleAndAdd(EX,n.dg,n.dh,E),S),n.df,E),A),t.x=TX.x+(b+M*S+(I+x*S)*A)*R,t.y=TX.y+(O+M*E+(C+x*E)*A)*w,Qs.multiplyScalar(t,t,i),t}(t,jX,r,this.noiseCache)},e.setSpeed=function(t,e,i){this.noiseSpeed.set(t,e,i)},e.setFrequency=function(t){this.noiseFrequency=t},e.setAbs=function(t,e,i){this.noiseAbs.set(t,e,i)},e.setAmplititude=function(t,e,i){this.noiseAmplitude.set(t,e,i)},e.setOctaves=function(t,e,i){this.octaves.set(t,e,i)},e.setTime=function(t){this.dt=t},e.setSamplePoint=function(t){this.point.set(t)},e.getResult=function(){return this.result},e.accumulateNoise3D=function(t,e,i,n,r,s,a,o){for(var u=this.noise(t,e,i,n,r),h=1,c=1,l=1;l<s;l++)r*=a,c+=h*=o,Qs.scaleAndAdd(u,u,this.noise(YX,e,i,n,r),h);return Qs.multiplyScalar(u,u,1/c)},e.getNoise=function(t,e,i,n,r,s){this.accumulateNoise3D(t,e,i,n,r,s.x,s.z,s.y)},e.getNoiseParticle=function(){this.accSpeed.set(this.noiseSpeed.x*this.dt,this.noiseSpeed.y*this.dt,this.noiseSpeed.z*this.dt),this.getNoise(KX,this.point.z+this.accSpeed.x,this.point.y,this.point.x,this.noiseFrequency,this.octaves),this.getNoise(qX,this.point.x+1e3,this.point.z+this.accSpeed.y,this.point.y,this.noiseFrequency,this.octaves),this.getNoise(QX,this.point.y,this.point.x+1e3,this.point.z+this.accSpeed.z,this.noiseFrequency,this.octaves);var t=QX.x-qX.y,e=KX.x-QX.y,i=qX.x-KX.y;this.result.set(t*this.noiseAmplitude.x,e*this.noiseAmplitude.y,i*this.noiseAmplitude.z)},e.getPreview=function(t,e,i){for(var n=0;n<i;++n)for(var r=0;r<e;++r){var s=(r-.5*e)/e+this.noiseSpeed.x*this.dt,a=(n-.5*i)/i+this.noiseSpeed.y*this.dt;this.getNoise(qX,s,a,0,this.noiseFrequency,this.octaves),this.getNoise(QX,s,a,0,this.noiseFrequency,this.octaves);var o=QX.x-qX.y;t[n*e+r]=.5*(o+1)}},t}(),JX=new(function(){var t=e.prototype;function e(){this._forceFields=void 0,this._forceFields=[]}return t.addForceField=function(t){this._forceFields.indexOf(t)<=-1&&this._forceFields.push(t)},t.removeForceField=function(t){var e=this._forceFields.indexOf(t);e>-1&&this._forceFields.splice(e,1)},s(e,[{key:"forceFields",get:function(){return this._forceFields}}]),e}()),$X=new js,tj=new da,ej=new da,ij=new da,nj=new sa,rj=(new js,new da),sj=new ia,aj=new js(0),oj=new js,uj=new js(0,1,0),hj=new sa,cj=new js,lj=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_forcefieldModule","_inheritVelocityModule","_customDataModule","_rotationSpeedModule"],_j=[0,0,1,0,0,1,1,1],dj=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0)],fj=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0),new Ae(Vt.ATTR_COLOR1,et.RGB32F)],pj=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0),new Ae(Vt.ATTR_TEX_COORD3,et.RGB32F),new Ae(Vt.ATTR_NORMAL,et.RGB32F),new Ae(Vt.ATTR_COLOR1,et.RGBA8,!0)],mj=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1)],gj=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_COLOR1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1)],vj=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1),new Ae(Vt.ATTR_TEX_COORD3,et.RGB32F,!1,1),new Ae(Vt.ATTR_NORMAL,et.RGB32F,!1,1),new Ae(Vt.ATTR_COLOR1,et.RGBA8,!0,1)],yj=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_TEX_COORD5,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD6,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1)],Tj=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_COLOR1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD5,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD6,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1)],Ej=[new Ae(Vt.ATTR_TEX_COORD4,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD2,et.RGB32F,!1,0,!0),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0,0,!0),new Ae(Vt.ATTR_TEX_COORD5,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD6,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1),new Ae(Vt.ATTR_TEX_COORD3,et.RGB32F,!1,1),new Ae(Vt.ATTR_NORMAL,et.RGB32F,!1,1),new Ae(Vt.ATTR_COLOR1,et.RGBA8,!0,1)],Sj={parent:null,owner:null,subModelIdx:0},Aj=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=[],i._uLenHandle=[],i._uNodeRotHandle=[],i._alignSpace=Xz.View,i._inited=!1,i._localMat=new da,i._gravity=new ta,i._currid=-1,i.noise=new ZX,i._model=null,i._frameTile_velLenScale=new ta(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new ta,i._attrs=new Array(8),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,CC_USE_CUSTOM:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i._currid=-1,i}o(e,t);var i=e.prototype;return i.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new Vi((function(){return new pz(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0,this._currid=-1},i.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},i.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},i.onDestroy=function(){var e;null===(e=this._particles)||void 0===e||e.destroy(),t.prototype.onDestroy.call(this)},i.getFreeParticle=function(){if(this._particles.length>=this._particleSystem.capacity)return null;var t=this._particles.add();return t.id<0&&(this._currid++,t.id=this._currid),t},i.getDefaultTrailMaterial=function(){return this._defaultTrailMat},i.setNewParticle=function(){},i._initModuleList=function(){var t=this;lj.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=kz.length;e<i;e++){var n=this._animateList[kz[e]];n&&this._runAnimateList.push(n)}},i.enableModule=function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var n=0,r=kz.length;n<r;n++){var s=this._animateList[kz[n]];s&&this._runAnimateList.push(s)}this.updateMaterialParams()},i.updateAlignSpace=function(t){this._alignSpace=t},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===jz.Mesh||this._alignSpace!==Xz.View){if(this._alignSpace===Xz.Local)this._particleSystem.node.getRotation(nj);else if(this._alignSpace===Xz.World)this._particleSystem.node.getWorldRotation(nj);else if(this._alignSpace===Xz.View){var e;nj.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){sa.fromViewUp(nj,r.forward);break}}}else nj.set(0,0,0,1);if(t)for(var s=t.passes.length,a=0;a<s;++a)t.passes[a].setUniform(this._uNodeRotHandle[a],nj)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case Vz.Local:this._particleSystem.node.getScale(this._node_scale);break;case Vz.World:this._particleSystem.node.getWorldScale(this._node_scale)}if(t)for(var e=t.passes.length,i=0;i<e;++i)t.passes[i].setUniform(this._uScaleHandle[i],this._node_scale)},i.clearSubemitter=function(){for(var t=this._particles.data.length;t>=0;--t)this._particles.data[t]},i.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;i.node.getWorldMatrix(tj);var n=i.getMaterialInstance(0)||this._defaultMat;this.doUpdateScale(n),this.doUpdateRotation(n),JX.forceFields.length>0&&da.invert(ej,tj),this._updateList.forEach((function(t){t.update(i._simulationSpace,tj)}));var r=i._trailModule,s=r&&r.enable;if(s&&r.update(),i.simulationSpace===Vz.Local){var a=i.node.getRotation();da.fromQuat(this._localMat,a),this._localMat.transpose()}if(i.node.parent){var o=i.node.parent.getWorldRotation();da.fromQuat(ij,o),ij.transpose()}for(var u=function(n){var a=e._particles.data[n];if(null==a||!a.active)return"continue";if(a.remainingLifetime-=t,js.set(a.animatedVelocity,0,0,0),a.remainingLifetime>=0){if(i.simulationSpace===Vz.Local){var o=9.8*-i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,Fs(a.randomSeed))*t;e._gravity.x=0,e._gravity.y=o,e._gravity.z=0,e._gravity.w=1,Ss(o,0,Ts)||(i.node.parent&&(e._gravity=e._gravity.transformMat4(ij)),e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z)}else a.velocity.y-=9.8*i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,Fs(a.randomSeed))*t;if(i.forceFieldModule&&i.forceFieldModule.enable)for(var u=i.forceFieldModule.forceList,h=0;h<u.length;++h){var c=u[h];c&&c.field.update(a,t,tj,ej)}if(js.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),js.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),s&&r.animate(a,t),a.time+=t,a.particleSystem){var l=a.particleSystem.getSubEmitters().length;l>0&&(js.normalize(cj,a.ultimateVelocity),js.set(oj,cj.x,cj.y,cj.z),da.lookAt(rj,aj,oj,uj),ia.fromMat4(sj,rj),ia.transpose(sj,sj),sa.fromMat3(hj,sj),sa.normalize(hj,hj),a.dir.set(hj));for(var _=0;_<l;++_){var d=a.particleSystem.getSubEmitters()[_];d.actDie||Is()<=d.subPercent&&(d.isPlaying||d.play(),d._emit(t,a))}}}else{s&&r.removeParticle(a);var f=!0;if(a.particleSystem){var p=a.particleSystem.getSubEmitters().length;if(!a.trigged){p>0&&(js.normalize(cj,a.ultimateVelocity),js.set(oj,cj.x,cj.y,cj.z),da.lookAt(rj,aj,oj,uj),ia.fromMat4(sj,rj),ia.transpose(sj,sj),sa.fromMat3(hj,sj),sa.normalize(hj,hj),a.dir.set(hj));for(var m=0;m<p;++m){var g=a.particleSystem.getSubEmitters()[m];g.actDie&&Is()<=g.subPercent&&(g.isPlaying||g.play(),g._emit(t,a))}a.trigged=!0}for(var v=0;v<p;++v)if(a.particleSystem.getSubEmitters()[v].getParticleCount()>0){f=!1;break}}f?(a.active=!1,e._particles.removeAt(n)):a.color.a=0}},h=this._particles.length;h>=0;--h)u(h);return this._model.enabled=this._particles.length>0,this._particles.length},i.getNoisePreview=function(t,e,i){var n=this;this._runAnimateList.forEach((function(r){r.name===Uz&&r.getNoisePreview(t,n._particleSystem,e,i)}))},i.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],n=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(n=i.frameIndex),t=4*e,this._fillDataFunc(i,t,n)}},i.beforeRender=function(){this._model.updateIA(this._particles.length)},i.getParticleCount=function(){return this._particles.length},i.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===t&&i._trailModel.setSubModelMaterial(0,e)},i._setFillFunc=function(){this._renderInfo.renderMode===jz.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===jz.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},i._fillMeshData=function(t,e,i){var n=e/4;this._attrs[0]=t.position,$X.z=i,this._attrs[1]=$X,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this.getUseCustom()?(this._attrs[6]=t.custom1,this._attrs[7]=t.custom2):(this._attrs[6]=null,this._attrs[7]=null),this._model.addParticleVertexData(n,this._attrs)},i._fillStrecthedData=function(t,e,i){if(this._useInstance)this._fillStrecthedDataIns(t,e,i);else for(var n=0;n<4;++n)this._attrs[0]=t.position,$X.x=_j[2*n],$X.y=_j[2*n+1],$X.z=i,this._attrs[1]=$X,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillStrecthedDataIns=function(t,e,i){var n=e/4;this._attrs[0]=t.position,$X.z=i,this._attrs[1]=$X,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this.getUseCustom()?(this._attrs[6]=t.custom1,this._attrs[7]=t.custom2):(this._attrs[6]=null,this._attrs[7]=null),this._model.addParticleVertexData(n,this._attrs)},i._fillNormalData=function(t,e,i){if(this._useInstance)this._fillNormalDataIns(t,e,i);else for(var n=0;n<4;++n)this._attrs[0]=t.position,$X.x=_j[2*n],$X.y=_j[2*n+1],$X.z=i,this._attrs[1]=$X,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillNormalDataIns=function(t,e,i){var n=e/4;this._attrs[0]=t.position,$X.z=i,this._attrs[1]=$X,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this.getUseCustom()?(this._attrs[6]=t.custom1,this._attrs[7]=t.custom2):(this._attrs[6]=null,this._attrs[7]=null),this._model.addParticleVertexData(n,this._attrs)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===jz.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,Vt.ATTR_COLOR);if(t){for(var e=et.RGBA8,i=0;i<Ke.length;++i)if(Ke[i].name===t.name){e=i;break}var n=this._useCustom?9:7;this._vertAttrs[n]=new Ae(Vt.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var r=et.RGBA8,s=this._useCustom?9:7;this._vertAttrs[s]=new Ae(Vt.ATTR_COLOR1,r,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case jz.StrecthedBillboard:this._vertAttrs=fj.slice();break;case jz.Mesh:this._vertAttrs=pj.slice();break;default:this._vertAttrs=dj.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case jz.StrecthedBillboard:this.getUseCustom()?this._vertAttrs=Tj.slice():this._vertAttrs=gj.slice();break;case jz.Mesh:this.getUseCustom()?this._vertAttrs=Ej.slice():this._vertAttrs=vj.slice();break;default:this.getUseCustom()?this._vertAttrs=yj.slice():this._vertAttrs=mj.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!=e&&(e._effectAsset._name,this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Sj.parent=IT.get("default-particle-material"),Sj.owner=this._particleSystem,Sj.subModelIdx=0,this._defaultMat=new _E(Sj),Sj.parent=null,Sj.owner=null,Sj.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===Vz.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;for(var n=i.passes.length;this._uScaleHandle.length<n;)this._uScaleHandle.push(0);for(;this._uLenHandle.length<n;)this._uLenHandle.push(0);for(;this._uNodeRotHandle.length<n;)this._uNodeRotHandle.push(0);for(var r=0;r<n;++r){var s=i.passes[r];this._uScaleHandle[r]=s.getHandle("scale"),this._uLenHandle[r]=s.getHandle("frameTile_velLenScale"),this._uNodeRotHandle[r]=s.getHandle("nodeRotation")}var a=this._renderInfo.renderMode,o=this._frameTile_velLenScale;a===jz.Billboard?this._defines.CC_RENDER_MODE=0:a===jz.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,o.z=this._renderInfo.velocityScale,o.w=this._renderInfo.lengthScale):a===jz.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:a===jz.VerticalBillboard?this._defines.CC_RENDER_MODE=3:a===jz.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+a+" not support.");var u=t._textureAnimationModule;if(u&&u.enable){ta.copy(this._tmp_velLenScale,o),Qs.set(this._tmp_velLenScale,u.numTilesX,u.numTilesY);for(var h=0;h<n;++h)i.passes[h].setUniform(this._uLenHandle[h],this._tmp_velLenScale)}else for(var c=0;c<n;++c)i.passes[c].setUniform(this._uLenHandle[c],o);var l,_=this._particleSystem._rotationOvertimeModule,d=this._particleSystem._rotationSpeedModule;l=_&&_.enable||d&&d.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=l,this._defines.CC_INSTANCE_PARTICLE=this._useInstance,this._defines.CC_USE_CUSTOM=this._useCustom,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===Vz.World||e.space===Vz.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(Sj.parent=IT.get("default-trail-material"),Sj.owner=this._particleSystem,Sj.subModelIdx=1,this._defaultTrailMat=new _E(Sj),Sj.parent=null,Sj.owner=null,Sj.subModelIdx=0),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},e}(fX),Rj=new da,wj=new ta,bj=new sa,Oj=new sa,Mj=(new js,32),Ij="a_position_starttime",Cj="a_size_uv",xj="a_rotation_uv",Nj="a_color",Bj="a_dir_life",Pj="a_rndSeed",Dj="a_size_fid",Fj="a_rotation_rnd",Lj=[new Ae(Ij,et.RGBA32F),new Ae(Cj,et.RGBA32F),new Ae(xj,et.RGBA32F),new Ae(Nj,et.RGBA32F),new Ae(Bj,et.RGBA32F),new Ae(Pj,et.R32F)],Uj=[new Ae(Ij,et.RGBA32F),new Ae(Cj,et.RGBA32F),new Ae(xj,et.RGBA32F),new Ae(Nj,et.RGBA32F),new Ae(Bj,et.RGBA32F),new Ae(Pj,et.R32F),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD3,et.RGB32F),new Ae(Vt.ATTR_NORMAL,et.RGB32F),new Ae(Vt.ATTR_COLOR1,et.RGBA8,!0)],Gj=[new Ae(Ij,et.RGBA32F,!1,0,!0),new Ae(Dj,et.RGBA32F,!1,0,!0),new Ae(Fj,et.RGBA32F,!1,0,!0),new Ae(Nj,et.RGBA32F,!1,0,!0),new Ae(Bj,et.RGBA32F,!1,0,!0),new Ae("a_uv",et.RGB32F,!1,1)],kj=[new Ae(Ij,et.RGBA32F,!1,0,!0),new Ae(Dj,et.RGBA32F,!1,0,!0),new Ae(Fj,et.RGBA32F,!1,0,!0),new Ae(Nj,et.RGBA32F,!1,0,!0),new Ae(Bj,et.RGBA32F,!1,0,!0),new Ae(Vt.ATTR_TEX_COORD,et.RGB32F,!1,1),new Ae(Vt.ATTR_TEX_COORD3,et.RGB32F,!1,1),new Ae(Vt.ATTR_NORMAL,et.RGB32F,!1,1),new Ae(Vt.ATTR_COLOR1,et.RGBA8,!0,1)],zj={parent:null,owner:null,subModelIdx:0},Hj=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._colorData=null,i._forceData=null,i._velocityData=null,i._rotationData=null,i._sizeData=null,i._animData=null,i._uTimeHandle=[],i._uRotHandle=[],i._uNodeRotHandle=[],i._uScaleHandle=[],i._alignSpace=Xz.View,i._inited=!1,i._frameTile_velLenScale=new ta(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new ta,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new pz(null),i._particleNum=0,i}o(e,t);var i=e.prototype;return i.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},i.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},i.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},i.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy(),this._forceData=null,this._velocityData=null,this._colorData=null,this._sizeData=null,this._rotationData=null,this._animData=null},i.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},i.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},i.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===jz.Mesh||this._alignSpace!==Xz.View){if(this._alignSpace===Xz.Local)this._particleSystem.node.getRotation(Oj);else if(this._alignSpace===Xz.World)this._particleSystem.node.getWorldRotation(Oj);else if(this._alignSpace===Xz.View){var e;Oj.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var n=0;n<(null==i?void 0:i.length);++n){var r=i[n];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){sa.fromViewUp(Oj,r.forward);break}}}else Oj.set(0,0,0,1);if(t){for(var s=t.passes.length;s>this._uNodeRotHandle.length;)this._uNodeRotHandle.push(0);for(var a=0;a<s;++a)t.passes[a].setUniform(this._uNodeRotHandle[a],Oj)}}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case Vz.Local:this._particleSystem.node.getScale(this._node_scale);break;case Vz.World:this._particleSystem.node.getWorldScale(this._node_scale)}if(t){for(var e=t.passes.length;e>this._uScaleHandle.length;)this._uScaleHandle.push(0);for(var i=0;i<e;++i)t.passes[i].setUniform(this._uScaleHandle[i],this._node_scale)}},i.clearSubemitter=function(){},i.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},i.updateRenderData=function(){},i.beforeRender=function(){this._model.updateIA(this._particleNum)},i.updateAlignSpace=function(t){this._alignSpace=t},i.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){for(var i=e.passes.length;i>this._uTimeHandle.length;)this._uTimeHandle.push(0);for(;i>this._uRotHandle.length;)this._uRotHandle.push(0);wj.x=this._particleSystem._time,wj.y=t,this._particleSystem.node.getWorldRotation(bj);for(var n=0;n<i;++n){var r=e.passes[n];r.setUniform(this._uTimeHandle[n],wj),r.setUniform(this._uRotHandle[n],bj)}this.doUpdateRotation(e)}},i.initShaderUniform=function(t){this.doUpdateScale(t);for(var e=t.passes.length;e>this._uTimeHandle.length;)this._uTimeHandle.push(0);for(;e>this._uRotHandle.length;)this._uRotHandle.push(0);for(;e>this._uNodeRotHandle.length;)this._uNodeRotHandle.push(0);for(;e>this._uScaleHandle.length;)this._uScaleHandle.push(0);wj.x=Mj,wj.y=.03125;for(var i=0;i<e;++i){var n=t.passes[i];this._uTimeHandle[i]=n.getHandle("u_timeDelta"),this._uRotHandle[i]=n.getHandle("u_worldRot"),this._uNodeRotHandle[i]=n.getHandle("nodeRotation"),this._uScaleHandle[i]=n.getHandle("scale"),n.setUniform(n.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),n.setUniform(n.getHandle("u_sampleInfo"),wj)}var r=!1,s=this._particleSystem._forceOvertimeModule;if(r=s&&s.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=r,r){var a=Tk(this._forceTexture,this._forceData,Mj,s.x,s.y,s.z);this._forceTexture=a.texture,this._forceData=a.texdata;for(var o=0;o<e;++o){var u=t.passes[o],h=u.getHandle("force_over_time_tex0"),c=FT.getBindingFromHandle(h);u.bindSampler(c,this._forceTexture.getGFXSampler()),u.bindTexture(c,this._forceTexture.getGFXTexture());var l=u.getHandle("u_force_space");u.setUniform(l,s.space);var _=u.getHandle("u_force_mode");u.setUniform(_,this._forceTexture.height)}}var d=this._particleSystem._velocityOvertimeModule;if(r=d&&d.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=r,r){var f=function(t,e,i,n,r,s,a){var o=Math.max(vk(n),vk(r),vk(s),vk(a)),u=i*o*4;null!==e&&e.length===u||(e=new Float32Array(i*o*4));for(var h=[n,r,s,a],c=1/(i-1),l=0;l<o;l++)for(var _=0;_<4;_++)for(var d=h[_],f=0,p=0,m=0;m<i;m++){var g=gk(d,c*m,l);p=(f+=g)/(m+1),e[4*(l*i+m)+_]=p}return{texture:yk(t,e,i,o),texdata:e}}(this._velocityTexture,this._velocityData,Mj,d.x,d.y,d.z,d.speedModifier);this._velocityTexture=f.texture,this._velocityData=f.texdata;for(var p=0;p<e;++p){var m=t.passes[p],g=m.getHandle("velocity_over_time_tex0"),v=FT.getBindingFromHandle(g);m.bindSampler(v,this._velocityTexture.getGFXSampler()),m.bindTexture(v,this._velocityTexture.getGFXTexture());var y=m.getHandle("u_velocity_space");m.setUniform(y,d.space);var T=m.getHandle("u_velocity_mode");m.setUniform(T,this._velocityTexture.height)}}var E=this._particleSystem._colorOverLifetimeModule;if(r=E&&E.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=r,r){var S=function(t,e,i,n){var r=function(t){switch(t.mode){case cz.TwoColors:case cz.TwoGradients:return 2;default:return 1}}(n),s=i*r*4;null!==e&&e.length===s||(e=new Uint8Array(i*r*4));for(var a=1/i,o=0,u=0;u<r;u++)for(var h=0;h<i;h++){var c=_z(n,a*h,u);e[o]=c.r,e[o+1]=c.g,e[o+2]=c.b,e[o+3]=c.a,o+=4}return null!==t&&i===t.width&&r===t.height||(t&&t.destroy(),(t=new fy).create(i,r,cf.RGBA8888),t.setFilters(_f.LINEAR,_f.LINEAR),t.setWrapMode(lf.CLAMP_TO_EDGE,lf.CLAMP_TO_EDGE)),t.uploadData(e),{texture:t,texdata:e}}(this._colorTexture,this._colorData,Mj,E.color);this._colorTexture=S.texture,this._colorData=S.texdata;for(var A=0;A<e;++A){var R=t.passes[A],w=R.getHandle("color_over_time_tex0"),b=FT.getBindingFromHandle(w);R.bindSampler(b,this._colorTexture.getGFXSampler()),R.bindTexture(b,this._colorTexture.getGFXTexture());var O=R.getHandle("u_color_mode");R.setUniform(O,this._colorTexture.height)}}var M,I=this._particleSystem._rotationOvertimeModule;if(r=I&&I.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=r,r&&(M=I.separateAxes?Tk(this._rotationTexture,this._rotationData,Mj,I.x,I.y,I.z):function(t,e,i,n){var r=vk(n),s=i*r*4;null!==e&&e.length===s||(e=new Float32Array(i*r*4));for(var a=1/(i-1),o=0,u=0;u<r;u++)for(var h=0;h<i;h++){var c=gk(n,a*h,u);e[o+2]=c,o+=4}return{texture:yk(t,e,i,r),texdata:e}}(this._rotationTexture,this._rotationData,Mj,I.z),this._rotationTexture=M.texture,this._rotationData=M.texdata,this._rotationTexture))for(var C=0;C<e;++C){var x=t.passes[C],N=x.getHandle("rotation_over_time_tex0"),B=FT.getBindingFromHandle(N);x.bindSampler(B,this._rotationTexture.getGFXSampler()),x.bindTexture(B,this._rotationTexture.getGFXTexture());var P=x.getHandle("u_rotation_mode");x.setUniform(P,this._rotationTexture.height)}var D,F=this._particleSystem._sizeOvertimeModule;if(r=F&&F.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=r,r&&(D=F.separateAxes?Tk(this._sizeTexture,this._sizeData,Mj,F.x,F.y,F.z,!0):function(t,e,i,n){var r=vk(n),s=i*r*4;null!==e&&e.length===s||(e=new Float32Array(i*r*4));for(var a=1/(i-1),o=0,u=0,h=0;h<r;h++){0;for(var c=0;c<i;c++){var l=gk(n,a*c,h);o=l,e[u]=o,e[u+1]=o,e[u+2]=o,u+=4}}return{texture:yk(t,e,i,r),texdata:e}}(this._sizeTexture,this._sizeData,Mj,F.size),this._sizeTexture=D.texture,this._sizeData=D.texdata,this._sizeTexture))for(var L=0;L<e;++L){var U=t.passes[L],G=U.getHandle("size_over_time_tex0"),k=FT.getBindingFromHandle(G);U.bindSampler(k,this._sizeTexture.getGFXSampler()),U.bindTexture(k,this._sizeTexture.getGFXTexture());var z=U.getHandle("u_size_mode");U.setUniform(z,this._sizeTexture.height)}var H=this._particleSystem._textureAnimationModule;if(r=H&&H.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=r,r){var V=function(t,e,i,n,r){var s=Math.max(vk(n),vk(r)),a=i*s*4;null!==e&&e.length===a||(e=new Float32Array(i*s*4));for(var o=[n,r],u=1/(i-1),h=0;h<s;h++)for(var c=0;c<2;c++)for(var l=o[c],_=0,d=0;d<i;d++){var f=gk(l,u*d,h);_=f,e[4*(h*i+d)+c]=_}return{texture:yk(t,e,i,s),texdata:e}}(this._animTexture,this._animData,Mj,H.startFrame,H.frameOverTime);this._animTexture=V.texture,this._animData=V.texdata;for(var W=0;W<e;++W){var X=t.passes[W],j=X.getHandle("texture_animation_tex0"),Y=FT.getBindingFromHandle(j);X.bindSampler(Y,this._animTexture.getGFXSampler()),X.bindTexture(Y,this._animTexture.getGFXTexture());var K=X.getHandle("u_anim_info");wj.x=this._animTexture.height,wj.y=H.numTilesX*H.numTilesY,wj.z=H.cycleCount,X.setUniform(K,wj)}}this._defines.USE_VK_SHADER=Wa.gfxDevice.gfxAPI===J.VULKAN,this._defines.CC_INSTANCE_PARTICLE=this._useInstance},i.getParticleCount=function(){return this._particleNum},i.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===jz.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,Vt.ATTR_COLOR);if(t){for(var e=et.RGBA8,i=0;i<Ke.length;++i)if(Ke[i].name===t.name){e=i;break}this._vertAttrs[9]=new Ae(Vt.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var n=et.RGBA8;this._vertAttrs[9]=new Ae(Vt.ATTR_COLOR1,n,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case jz.StrecthedBillboard:this._vertAttrs=Lj.slice();break;case jz.Mesh:this._vertAttrs=Uj.slice();break;default:this._vertAttrs=Lj.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case jz.StrecthedBillboard:this._vertAttrs=Gj.slice();break;case jz.Mesh:this._vertAttrs=kj.slice();break;default:this._vertAttrs=Gj.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!==e&&(e._effectAsset._name,this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(zj.parent=IT.get("default-particle-gpu-material"),zj.owner=t,zj.subModelIdx=0,this._defaultMat=new _E(zj),zj.parent=null,zj.owner=null,zj.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(Rj),t._simulationSpace===Vz.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var n=this._renderInfo.renderMode;n===jz.Billboard?this._defines.CC_RENDER_MODE=0:n===jz.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):n===jz.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:n===jz.VerticalBillboard?this._defines.CC_RENDER_MODE=3:n===jz.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+n+" not support.");var r=t._textureAnimationModule;r&&r.enable?(Qs.set(this._frameTile_velLenScale,r.numTilesX,r.numTilesY),ta.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,ta.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},i.getNoisePreview=function(){},e}(fX);function Vj(){var t=SD.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.getFormatFeatures(et.RGBA32F)&(lt.RENDER_TARGET|lt.SAMPLED_TEXTURE))||(v.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Wj,Xj,jj,Yj,Kj,qj,Qj,Zj,Jj,$j,tY,eY,iY,nY,rY,sY,aY,oY,uY,hY,cY,lY,_Y,dY,fY,pY,mY,gY,vY,yY,TY,EY,SY,AY,RY,wY,bY,OY,MY,IY,CY,xY,NY,BY,PY,DY,FY,LY,UY,GY,kY,zY,HY,VY,WY,XY,jY,YY,KY,qY,QY,ZY,JY,$Y,tK,eK,iK,nK,rK,sK,aK,oK,uK,hK,cK,lK,_K,dK,fK,pK,mK,gK,vK,yK,TK,EK,SK,AK,RK,wK,bK,OK,MK,IK,CK,xK,NK,BK,PK,DK,FK,LK,UK,GK,kK,zK,HK,VK,WK,XK,jK,YK,KK,qK,QK,ZK,JK,$K,tq,eq,iq,nq,rq,sq,aq,oq,uq,hq,cq,lq,_q,dq,fq,pq,mq,gq=(RX=ao("cc.ParticleSystemRenderer"),wX=xo(jz),bX=xo(jz),OX=xo(Xb),MX=xo($T),IX=xo($T),CX=xo($T),xX=xo($T),NX=xo(Xz),RX((XX=WX=function(){function t(){this._renderMode=DX&&DX(),this._velocityScale=FX&&FX(),this._lengthScale=LX&&LX(),this._mesh=UX&&UX(),this._cpuMaterial=GX&&GX(),this._gpuMaterial=kX&&kX(),this._mainTexture=zX&&zX(),this._useGPU=HX&&HX(),this._alignSpace=VX&&VX(),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&z(6033)},e.onInit=function(t){this.create(t);var e=this._useGPU&&Vj();this._particleSystem.processor?z(6034):(this._particleSystem.processor=e?new Hj(this):new Aj(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)),e?this.gpuMaterial=this.particleMaterial:(this.particleMaterial&&-1!==this.particleMaterial.effectName.indexOf("particle-gpu")&&(this.particleMaterial=null,G(6035)),this.cpuMaterial=this.particleMaterial)},e._switchProcessor=function(){if(this._particleSystem){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null);var t=this._useGPU&&Vj();!t&&this.cpuMaterial&&(this.particleMaterial=this.cpuMaterial),t&&this.gpuMaterial&&(this.particleMaterial=this.gpuMaterial),this._particleSystem.processor=t?new Hj(this):new Aj(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},s(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"cpuMaterial",get:function(){return this._cpuMaterial},set:function(t){if(null!==t){var e=t.effectName;-1!==e.indexOf("particle")&&-1===e.indexOf("particle-gpu")?(this._cpuMaterial=t,this.particleMaterial=this._cpuMaterial):G(6035)}}},{key:"gpuMaterial",get:function(){return this._gpuMaterial},set:function(t){null!==t&&(-1!==t.effectName.indexOf("particle-gpu")?(this._gpuMaterial=t,this.particleMaterial=this._gpuMaterial):G(6035))}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(Vj()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}(),WX.AlignmentSpace=Xz,m((PX=XX).prototype,"renderMode",[wX],Object.getOwnPropertyDescriptor(PX.prototype,"renderMode"),PX.prototype),DX=Za(PX.prototype,"_renderMode",[bX,mo],(function(){return jz.Billboard})),FX=Za(PX.prototype,"_velocityScale",[mo],(function(){return 1})),LX=Za(PX.prototype,"_lengthScale",[mo],(function(){return 1})),UX=Za(PX.prototype,"_mesh",[mo],(function(){return null})),m(PX.prototype,"mesh",[OX],Object.getOwnPropertyDescriptor(PX.prototype,"mesh"),PX.prototype),m(PX.prototype,"particleMaterial",[MX],Object.getOwnPropertyDescriptor(PX.prototype,"particleMaterial"),PX.prototype),m(PX.prototype,"cpuMaterial",[IX],Object.getOwnPropertyDescriptor(PX.prototype,"cpuMaterial"),PX.prototype),GX=Za(PX.prototype,"_cpuMaterial",[mo],(function(){return null})),m(PX.prototype,"gpuMaterial",[CX],Object.getOwnPropertyDescriptor(PX.prototype,"gpuMaterial"),PX.prototype),kX=Za(PX.prototype,"_gpuMaterial",[mo],(function(){return null})),m(PX.prototype,"trailMaterial",[xX],Object.getOwnPropertyDescriptor(PX.prototype,"trailMaterial"),PX.prototype),zX=Za(PX.prototype,"_mainTexture",[mo],(function(){return null})),HX=Za(PX.prototype,"_useGPU",[mo],(function(){return!1})),m(PX.prototype,"alignSpace",[NX],Object.getOwnPropertyDescriptor(PX.prototype,"alignSpace"),PX.prototype),VX=Za(PX.prototype,"_alignSpace",[mo],(function(){return Xz.View})),BX=PX))||BX),vq=Math.cos(bs(100)),yq={position:new js,velocity:new js},Tq=new sa,Eq=new da,Sq=new js,Aq=new js,Rq=new Aa,wq=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new js,lifetime:0,width:0,velocity:new js,direction:0,color:new Aa})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new js,lifetime:0,width:0,velocity:new js,direction:0,color:new Aa}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,n){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,s=this.start;s<r;s++)e(t,this.trailElements[s%this.trailElements.length],i,n)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),bq=(Wj=ao("cc.TrailModule"),Xj=xo(Qz),jj=xo(mk),Yj=xo(Vz),Kj=xo(Zz),qj=xo(mk),Qj=xo(lz),Zj=xo(lz),Jj=xo(Vz),Wj((tY=function(){var t=e.prototype;function e(){this._enable=eY&&eY(),this.mode=iY&&iY(),this.lifeTime=nY&&nY(),this._minParticleDistance=rY&&rY(),this.existWithParticles=sY&&sY(),this.textureMode=aY&&aY(),this.widthFromParticle=oY&&oY(),this.widthRatio=uY&&uY(),this.colorFromParticle=hY&&hY(),this.colorOverTrail=cY&&cY(),this.colorOvertime=lY&&lY(),this._space=_Y&&_Y(),this._particleSystem=dY&&dY(),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._inited=void 0,this._iaInfo=new ce([new ue]),this._vertAttrs=[new Ae(Vt.ATTR_POSITION,et.RGB32F),new Ae(Vt.ATTR_TEX_COORD,et.RGBA32F),new Ae(Vt.ATTR_TEX_COORD1,et.RGB32F),new Ae(Vt.ATTR_COLOR,et.RGBA8,!0)],this._vertSize=0;for(var t,e=p(this._vertAttrs);!(t=e()).done;){var i=t.value;this._vertSize+=Ke[i.format].size}this._particleTrail=new Map,this._inited=!1}return t.getModel=function(){return this._trailModel},t.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;var e=0,i=t.startLifetime.getMax(),n=1;t._parentEmitter&&(n=t._parentEmitter.startSpeed.getMax());for(var r=t.rateOverTime.getMax()>t.rateOverDistance.getMax()*n?t.rateOverTime.getMax():t.rateOverDistance.getMax()*n,s=t.duration,a=0,o=t.bursts.length;a<o;a++)e+=t.bursts[a].getMaxCount(t)*Math.ceil(i/s);var u=1;t._parentEmitter&&(u=t._parentEmitter.capacity),this._trailNum=Math.ceil(i*Math.ceil(this.lifeTime.getMax())*60*u*(r*s+e)),this._trailSegments=new Hi((function(){return new wq(10)}),Math.ceil(r*s),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable),this._inited=!0},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(SD.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===Vz.World&&this._particleSystem._simulationSpace===Vz.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Eq),this._particleSystem.node.getWorldRotation(Tq)):this._needTransform=!1},t.animate=function(t,e){if(this._trailSegments){t.loopCount>t.lastLoop&&(t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++);var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var n=i.getElement(i.end-1);if(this._needTransform?js.transformMat4(Sq,t.position,Eq):js.copy(Sq,t.position),!(n&&(i.iterateElement(this,this._updateTrailElement,t,e),js.squaredDistance(n.position,Sq)<this._minSquaredDistance))&&(n=i.addElement())){js.copy(n.position,Sq),n.lifetime=0,this.widthFromParticle?n.width=t.size.x*this.widthRatio.evaluate(0,1):n.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var s=i.getElement(i.end-2);js.subtract(s.velocity,n.position,s.position)}else if(r>2){var a=i.getElement(i.end-2),o=i.getElement(i.end-3);js.subtract(Sq,o.position,a.position),js.subtract(Aq,n.position,a.position),js.subtract(a.velocity,Aq,Sq),js.equals(js.ZERO,a.velocity)&&js.copy(a.velocity,Sq),js.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,o)}this.colorFromParticle?n.color.set(t.color):n.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=p(this._particleTrail.keys());!(t=e()).done;){var i=t.value,n=this._particleTrail.get(i);if(-1!==n.start){var r=4*this.vbOffset/this._vertSize,s=n.start>=n.end?n.end+n.trailElements.length:n.end,a=s-n.start,o=1/a,u=n.trailElements[n.start];this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var h=n.start+1;h<s;h++){var c=n.trailElements[h%n.trailElements.length],l=h-n.start;this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1-l/a,1),r,1-l*o,l,5)}this._needTransform?js.transformMat4(yq.position,i.position,Eq):js.copy(yq.position,i.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(gp.POSITION),1===a||2===a){var d=n.getElement(n.end-1);js.subtract(d.velocity,yq.position,d.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=d.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=d.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=d.velocity.z,this._vbF32[this.vbOffset-4]=d.velocity.x,this._vbF32[this.vbOffset-3]=d.velocity.y,this._vbF32[this.vbOffset-2]=d.velocity.z,js.subtract(yq.velocity,yq.position,d.position),this._checkDirectionReverse(yq,d)}else if(a>2){var f=n.getElement(n.end-1),m=n.getElement(n.end-2);js.subtract(Sq,m.position,f.position),js.subtract(Aq,yq.position,f.position),js.normalize(Sq,Sq),js.normalize(Aq,Aq),js.subtract(f.velocity,Aq,Sq),js.normalize(f.velocity,f.velocity),this._checkDirectionReverse(f,m),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(f,this.colorOverTrail.evaluate(o,1),r,o,a-1,5),js.subtract(yq.velocity,yq.position,f.position),js.normalize(yq.velocity,yq.velocity),this._checkDirectionReverse(yq,f)}this.widthFromParticle?yq.width=i.size.x*this.widthRatio.evaluate(0,1):yq.width=this.widthRatio.evaluate(0,1),yq.color=i.color,js.equals(yq.velocity,js.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(yq,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel&&(this._trailModel.enabled=this.ibOffset>0)},t.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=t,this._iaInfoBuffer.update(this._iaInfo)}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=v.director.root.createModel(fO))},t.rebuild=function(){var t=SD.root.device,e=t.createBuffer(new ae(rt.VERTEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var n=t.createBuffer(new ae(rt.INDEX|rt.TRANSFER_DST,ot.HOST|ot.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),n.update(this._iBuffer),this._iaInfoBuffer=t.createBuffer(new ae(rt.INDIRECT,ot.HOST|ot.DEVICE,Je,Je)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new Ob([e],this._vertAttrs,Ot.TRIANGLE_LIST,n,this._iaInfoBuffer);var r=this._trailModel;r&&this._material&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(t,e,i,n){return e.lifetime+=n,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},t._fillVertexBuffer=function(t,e,i,n,r,s){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,Rq.set(t.color),Rq.multiply(e),this._vbUint32[this.vbOffset++]=Rq._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=n,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=Rq._val,1&s&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&s&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)},t._checkDirectionReverse=function(t,e){js.dot(t.velocity,e.velocity)<vq?t.direction=1-e.direction:t.direction=e.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}}]),e}(),eY=Za(tY.prototype,"_enable",[mo],(function(){return!1})),iY=Za(tY.prototype,"mode",[Xj,mo],(function(){return Qz.Particles})),nY=Za(tY.prototype,"lifeTime",[jj,mo],(function(){return new mk})),rY=Za(tY.prototype,"_minParticleDistance",[mo],(function(){return.1})),m(tY.prototype,"space",[Yj],Object.getOwnPropertyDescriptor(tY.prototype,"space"),tY.prototype),sY=Za(tY.prototype,"existWithParticles",[mo],(function(){return!0})),aY=Za(tY.prototype,"textureMode",[Kj,mo],(function(){return Zz.Stretch})),oY=Za(tY.prototype,"widthFromParticle",[mo],(function(){return!0})),uY=Za(tY.prototype,"widthRatio",[qj,mo],(function(){return new mk})),hY=Za(tY.prototype,"colorFromParticle",[mo],(function(){return!1})),cY=Za(tY.prototype,"colorOverTrail",[Qj,mo],(function(){return new lz})),lY=Za(tY.prototype,"colorOvertime",[Zj,mo],(function(){return new lz})),_Y=Za(tY.prototype,"_space",[Jj],(function(){return Vz.World})),dY=Za(tY.prototype,"_particleSystem",[mo],(function(){return null})),$j=tY))||$j),Oq=new da,Mq=new da,Iq=new sa,Cq=new js,xq=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],Nq=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new da,this._gravity=new ta,this.minPos=new js,this.maxPos=new js,this._nodePos=new js,this._nodeSize=new js,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;xq.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=kz.length;e<i;e++){var n=this._animateList[kz[e]];n&&this._runAnimateList.push(n)}},e._emit=function(t,e,i){var n=this._particleSystem,r=this._node,s=n.time%n.duration/n.duration;r.invalidateChildren(gp.POSITION),n.simulationSpace===Vz.World&&(r.getWorldMatrix(Oq),r.getWorldRotation(Iq));for(var a=0;a<t;++a){var o=new pz(n);o.particleSystem=n,o.reset();var u=Fs(Ds(0,cs));n._shapeModule&&n._shapeModule.enable?n._shapeModule.emit(o):(js.set(o.position,0,0,0),js.copy(o.velocity,$z)),n._textureAnimationModule&&n._textureAnimationModule.enable&&n._textureAnimationModule.init(o);var h=n.startSpeed.evaluate(s,u);js.multiplyScalar(o.velocity,o.velocity,h),n.simulationSpace===Vz.World&&(js.transformMat4(o.position,o.position,Oq),js.transformQuat(o.velocity,o.velocity,Iq)),js.copy(o.ultimateVelocity,o.velocity),js.set(o.rotation,0,0,0),n.startSize3D?js.set(o.startSize,n.startSizeX.evaluate(s,u),n.startSizeY.evaluate(s,u),n.startSizeZ.evaluate(s,u)):(js.set(o.startSize,n.startSizeX.evaluate(s,u),1,1),o.startSize.y=o.startSize.x),js.copy(o.size,o.startSize),o.startLifetime=n.startLifetime.evaluate(s,u)+e,o.remainingLifetime=o.startLifetime,i.push(o)}},e._updateParticles=function(t,e){var i=this,n=this._particleSystem;switch(n.node.getWorldMatrix(Oq),n.scaleSpace){case Vz.Local:n.node.getScale(Cq);break;case Vz.World:n.node.getWorldScale(Cq)}if(this._updateList.forEach((function(t){t.update(n.simulationSpace,Oq)})),n.simulationSpace===Vz.Local){var r=n.node.getRotation();da.fromQuat(this._localMat,r),this._localMat.transpose()}n.node.parent&&(n.node.parent.getWorldMatrix(Mq),Mq.invert());for(var s=function(r){var s=e[r];if(s.remainingLifetime-=t,js.set(s.animatedVelocity,0,0,0),n.simulationSpace===Vz.Local){var a=9.8*-n.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,Fs(s.randomSeed))*t;i._gravity.x=0,i._gravity.y=a,i._gravity.z=0,i._gravity.w=1,Ss(a,0,Ts)||(n.node.parent&&(i._gravity=i._gravity.transformMat4(Mq)),i._gravity=i._gravity.transformMat4(i._localMat),s.velocity.x+=i._gravity.x,s.velocity.y+=i._gravity.y,s.velocity.z+=i._gravity.z)}else s.velocity.y-=9.8*n.gravityModifier.evaluate(1-s.remainingLifetime/s.startLifetime,Fs(s.randomSeed))*t;js.copy(s.ultimateVelocity,s.velocity),i._runAnimateList.forEach((function(e){e.animate(s,t)})),js.scaleAndAdd(s.position,s.position,s.ultimateVelocity,t)},a=0;a<e.length;++a)s(a)},e._calculateBounding=function(t){var e=new js,i=new js,n=new js,r=new js,s=new js(1,1,1);if(this._processor.getInfo().renderMode===jz.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var o=new sc;sc.fromPoints(o,a.struct.minPosition,a.struct.maxPosition);var u=Math.max(o.halfExtents.x,o.halfExtents.y,o.halfExtents.z);s.set(u,u,u)}}for(var h=this._particleSystem.node.worldMatrix,c=0;c<this._particlesAll.length;++c){var l=this._particlesAll[c];js.multiply(e,Cq,l.size),js.multiply(e,e,s),i.set(l.position),this._particleSystem.simulationSpace!==Vz.World&&js.transformMat4(i,i,h),t&&0===c?(js.subtract(this.minPos,i,e),js.add(this.maxPos,i,e)):(js.subtract(n,i,e),js.add(r,i,e),js.min(this.minPos,this.minPos,n),js.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=Fs(Ds(0,cs));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),Bq=(fY=ao("cc.NoiseModule"),pY=xo(fr),mY=xo(fr),gY=xo(fr),vY=xo(fr),yY=xo(fr),TY=xo(fr),EY=xo(fr),SY=xo(fr),AY=xo(fr),RY=xo(fr),wY=xo(dr),bY=xo(fr),OY=xo(fr),fY((IY=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=CY&&CY(),e._strengthX=xY&&xY(),e._strengthY=NY&&NY(),e._strengthZ=BY&&BY(),e._noiseSpeedX=PY&&PY(),e._noiseSpeedY=DY&&DY(),e._noiseSpeedZ=FY&&FY(),e._noiseFrequency=LY&&LY(),e._remapX=UY&&UY(),e._remapY=GY&&GY(),e._remapZ=kY&&kY(),e._octaves=zY&&zY(),e._octaveMultiplier=HY&&HY(),e._octaveScale=VY&&VY(),e.name=Uz,e.noise=new ZX,e.samplePosition=new js,e}o(e,t);var i=e.prototype;return i.animate=function(t,e){this.noise.setTime(t.particleSystem.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.samplePosition.set(t.position),this.noise.setSamplePoint(this.samplePosition),this.noise.getNoiseParticle();var i=this.noise.getResult();js.add(t.position,t.position,i.multiplyScalar(e))},i.getNoisePreview=function(t,e,i,n){this.noise.setTime(e.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.noise.getNoiseParticle(),this.noise.getPreview(t,i,n)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"strengthX",get:function(){return this._strengthX},set:function(t){this._strengthX=t}},{key:"strengthY",get:function(){return this._strengthY},set:function(t){this._strengthY=t}},{key:"strengthZ",get:function(){return this._strengthZ},set:function(t){this._strengthZ=t}},{key:"noiseSpeedX",get:function(){return this._noiseSpeedX},set:function(t){this._noiseSpeedX=t}},{key:"noiseSpeedY",get:function(){return this._noiseSpeedY},set:function(t){this._noiseSpeedY=t}},{key:"noiseSpeedZ",get:function(){return this._noiseSpeedZ},set:function(t){this._noiseSpeedZ=t}},{key:"noiseFrequency",get:function(){return this._noiseFrequency},set:function(t){this._noiseFrequency=t}},{key:"remapX",get:function(){return this._remapX},set:function(t){this._remapX=t}},{key:"remapY",get:function(){return this._remapY},set:function(t){this._remapY=t}},{key:"remapZ",get:function(){return this._remapZ},set:function(t){this._remapZ=t}},{key:"octaves",get:function(){return this._octaves},set:function(t){this._octaves=t}},{key:"octaveMultiplier",get:function(){return this._octaveMultiplier},set:function(t){this._octaveMultiplier=t}},{key:"octaveScale",get:function(){return this._octaveScale},set:function(t){this._octaveScale=t}}]),e}(Hz),CY=Za(IY.prototype,"_enable",[mo],(function(){return!1})),m(IY.prototype,"strengthX",[pY],Object.getOwnPropertyDescriptor(IY.prototype,"strengthX"),IY.prototype),xY=Za(IY.prototype,"_strengthX",[mo],(function(){return 10})),m(IY.prototype,"strengthY",[mY],Object.getOwnPropertyDescriptor(IY.prototype,"strengthY"),IY.prototype),NY=Za(IY.prototype,"_strengthY",[mo],(function(){return 10})),m(IY.prototype,"strengthZ",[gY],Object.getOwnPropertyDescriptor(IY.prototype,"strengthZ"),IY.prototype),BY=Za(IY.prototype,"_strengthZ",[mo],(function(){return 10})),m(IY.prototype,"noiseSpeedX",[vY],Object.getOwnPropertyDescriptor(IY.prototype,"noiseSpeedX"),IY.prototype),PY=Za(IY.prototype,"_noiseSpeedX",[mo],(function(){return 0})),m(IY.prototype,"noiseSpeedY",[yY],Object.getOwnPropertyDescriptor(IY.prototype,"noiseSpeedY"),IY.prototype),DY=Za(IY.prototype,"_noiseSpeedY",[mo],(function(){return 0})),m(IY.prototype,"noiseSpeedZ",[TY],Object.getOwnPropertyDescriptor(IY.prototype,"noiseSpeedZ"),IY.prototype),FY=Za(IY.prototype,"_noiseSpeedZ",[mo],(function(){return 0})),m(IY.prototype,"noiseFrequency",[EY],Object.getOwnPropertyDescriptor(IY.prototype,"noiseFrequency"),IY.prototype),LY=Za(IY.prototype,"_noiseFrequency",[mo],(function(){return 1})),m(IY.prototype,"remapX",[SY],Object.getOwnPropertyDescriptor(IY.prototype,"remapX"),IY.prototype),UY=Za(IY.prototype,"_remapX",[mo],(function(){return 0})),m(IY.prototype,"remapY",[AY],Object.getOwnPropertyDescriptor(IY.prototype,"remapY"),IY.prototype),GY=Za(IY.prototype,"_remapY",[mo],(function(){return 0})),m(IY.prototype,"remapZ",[RY],Object.getOwnPropertyDescriptor(IY.prototype,"remapZ"),IY.prototype),kY=Za(IY.prototype,"_remapZ",[mo],(function(){return 0})),m(IY.prototype,"octaves",[wY],Object.getOwnPropertyDescriptor(IY.prototype,"octaves"),IY.prototype),zY=Za(IY.prototype,"_octaves",[mo],(function(){return 1})),m(IY.prototype,"octaveMultiplier",[bY],Object.getOwnPropertyDescriptor(IY.prototype,"octaveMultiplier"),IY.prototype),HY=Za(IY.prototype,"_octaveMultiplier",[mo],(function(){return.5})),m(IY.prototype,"octaveScale",[OY],Object.getOwnPropertyDescriptor(IY.prototype,"octaveScale"),IY.prototype),VY=Za(IY.prototype,"_octaveScale",[mo],(function(){return 2})),MY=IY))||MY),Pq=new js,Dq=new js,Fq=function(){var t=e.prototype;function e(){this._mode=void 0,this._fieldLocalToWorld=void 0,this._multiplier=void 0,this._startRange=void 0,this._endRange=void 0,this._length=void 0,this._gravityFocus=void 0,this._rotationRandomness=void 0,this._multiplyDragByParticleSize=void 0,this._multiplyDragByParticleVelocity=void 0,this._directionCacheX=void 0,this._directionCacheY=void 0,this._directionCacheZ=void 0,this._gravityCache=void 0,this._rotationSpeedCache=void 0,this._rotationAttractionCache=void 0,this._dragCache=void 0,this._directionFactor=void 0,this._gravityFactor=void 0,this._rotationSpeedFactor=void 0,this._rotationAttractionFactor=void 0,this._vectorSpeedFactor=void 0,this._vectorAttractionFactor=void 0,this._dragFactor=void 0,this._toForce=void 0,this._toForceOriginal=void 0,this._toForceTangent=void 0,this._rotationEuler=void 0,this._rotationQ=void 0,this._rotationMat=void 0,this._rotationTranspose=void 0,this._rsMat=void 0,this._velocity=void 0,this._velMag=void 0,this._velNormalized=void 0,this._fieldWorldToLocal=void 0,this._fieldScale=void 0,this._fieldCenter=void 0,this._forceTransform=void 0,this._forceInvTransform=void 0,this._multiplier=new mk,this._multiplier.constant=1,this._mode=Yz.Box,this._fieldLocalToWorld=new da,this._startRange=0,this._endRange=1,this._length=0,this._gravityFocus=0,this._rotationRandomness=new Qs,this._multiplyDragByParticleSize=!0,this._multiplyDragByParticleVelocity=!0,this._directionFactor=new js,this._gravityFactor=0,this._rotationSpeedFactor=0,this._rotationAttractionFactor=0,this._vectorSpeedFactor=0,this._vectorAttractionFactor=0,this._dragFactor=0,this._toForce=new js,this._toForceOriginal=new js,this._toForceTangent=new js,this._rotationEuler=new js,this._rotationQ=new sa,this._rotationMat=new ia,this._rotationTranspose=new ia,this._rsMat=new ia,this._velocity=new js,this._velMag=new js,this._velNormalized=new js,this._fieldWorldToLocal=new da,this._fieldScale=new js,this._fieldCenter=new js,this._forceTransform=new da,this._forceInvTransform=new da}return t.setRotationRandomness=function(t,e){this._rotationRandomness.x=t,this._rotationRandomness.y=e},t.checkOutside=function(t,e,i,n){var r=t>i||t<e;return this._mode===Yz.Hemisphere&&(r=r||n.y<0),r},t.checkInSphere=function(t,e,i){return js.distance(t,e)<=i},t.apply=function(t,e,i,n,r){if(0!==this._endRange){var s=this._startRange,a=this._endRange,o=1/a,u=(this._length,s/a),h=a-s,c=a/h,l=h*this._gravityFocus+s,_=this._multiplyDragByParticleSize?4294967295:0,d=this._multiplyDragByParticleVelocity?4294967295:0,f=2*Math.PI*this._rotationRandomness.x,p=2*Math.PI*this._rotationRandomness.y,m=Math.abs(f)>Ts||Math.abs(p)>Ts,g=1-t.remainingLifetime/t.startLifetime,v=Fs(t.randomSeed+212165),y=r.evaluate(g,v);js.transformMat4(this._toForce,Dq,i),m&&(this._rotationEuler.x=(Fs(t.randomSeed+2222344)-.5)*f,this._rotationEuler.z=(Fs(t.randomSeed+4432133)-.5)*p,sa.fromEuler(this._rotationQ,this._rotationEuler.x,this._rotationEuler.y,this._rotationEuler.z),ia.fromQuat(this._rotationMat,this._rotationQ),ia.transpose(this._rotationTranspose,this._rotationMat),js.transformMat3(this._toForce,this._toForce,this._rotationMat)),this._toForceTangent.set(this._toForce.z,0,-this._toForce.x),this._toForceOriginal.set(this._toForce);var T;T=this._mode===Yz.Box?Math.max(Math.abs(this._toForce.x),Math.max(Math.abs(this._toForce.y),Math.abs(this._toForce.z))):this._toForce.length();var E=Math.min(T,a)*o;E=Math.max((E-u)*c,0);var S=this.checkOutside(T,s,a,this._toForceOriginal);if(!S){if(this._directionCacheX&&this._directionCacheY&&this._directionCacheZ&&(0!==this._directionCacheX.getMaxAbs()||0!==this._directionCacheY.getMaxAbs()||0!==this._directionCacheZ.getMaxAbs())){var A=Fs(t.randomSeed+55533123),R=Fs(t.randomSeed+55533124),w=Fs(t.randomSeed+55533125);this._directionFactor.x=this._directionCacheX.evaluate(E,A),this._directionFactor.y=this._directionCacheY.evaluate(E,R),this._directionFactor.z=this._directionCacheZ.evaluate(E,w),this._directionFactor.x=S?0:this._directionFactor.x,this._directionFactor.y=S?0:this._directionFactor.y,this._directionFactor.z=S?0:this._directionFactor.z,ia.fromMat4(this._rsMat,n),js.transformMat3(this._directionFactor,this._directionFactor,this._rsMat),t.velocity.add(this._directionFactor.multiplyScalar(e*y))}if(this._gravityCache&&0!==this._gravityCache.getMaxAbs()){m&&js.transformMat3(this._toForce,this._toForce,this._rotationTranspose),this._rsMat.equals(ia.IDENTITY,0)&&ia.fromMat4(this._rsMat,n),js.transformMat3(this._toForce,this._toForce,this._rsMat),js.normalize(this._toForce,this._toForce);var b=Fs(t.randomSeed+66663324);this._gravityFactor=-this._gravityCache.evaluate(E,b)*y,this._gravityFactor=S?0:this._gravityFactor,l>T&&this._toForce.set(-this._toForce.x,-this._toForce.y,-this._toForce.z),t.velocity.add3f(this._toForce.x*this._gravityFactor,this._toForce.y*this._gravityFactor,this._toForce.z*this._gravityFactor)}if(this._rotationSpeedCache&&this._rotationAttractionCache&&0!==this._rotationSpeedCache.getMaxAbs()&&0!==this._rotationAttractionCache.getMaxAbs()){m&&js.transformMat3(this._toForceTangent,this._toForceTangent,this._rotationTranspose),this._rsMat.equals(ia.IDENTITY,0)&&ia.fromMat4(this._rsMat,n),js.transformMat3(this._toForceTangent,this._toForceTangent,this._rsMat),js.normalize(this._toForceTangent,this._toForceTangent);var O=Fs(t.randomSeed+1021334),M=Fs(t.randomSeed+1021335);this._rotationSpeedFactor=this._rotationSpeedCache.evaluate(E,O)*y,this._rotationAttractionFactor=this._rotationAttractionCache.evaluate(E,M)*y,this._rotationAttractionFactor=S?0:this._rotationAttractionFactor,js.multiplyScalar(this._toForceTangent,this._toForceTangent,this._rotationSpeedFactor),t.velocity.add3f((this._toForceTangent.x-t.velocity.x)*this._rotationAttractionFactor,(this._toForceTangent.y-t.velocity.y)*this._rotationAttractionFactor,(this._toForceTangent.z-t.velocity.z)*this._rotationAttractionFactor)}if(this._dragCache&&0!==this._dragCache.getMaxAbs()){var I=Fs(t.randomSeed+10314145);this._dragFactor=this._dragCache.evaluate(E,I),js.add(this._velocity,t.velocity,t.animatedVelocity);var C=js.dot(this._velocity,this._velocity),x=Math.max(t.size.x,Math.max(t.size.y,t.size.z));x*=.5;var N=Math.PI*x*x,B=this._dragFactor;B*=0!==_?N:1,B*=0!==d?C:1,B=S?0:B;var P=Math.sqrt(C);P<Ts?this._velNormalized.set(0,0,0):(this._velNormalized.x=this._velocity.x/P,this._velNormalized.y=this._velocity.y/P,this._velNormalized.z=this._velocity.z/P),P=Math.max(0,P-B*e*y),js.multiplyScalar(this._velocity,this._velNormalized,P),js.subtract(t.velocity,this._velocity,t.animatedVelocity)}}}},t.update=function(t,e,i,n){da.invert(this._fieldWorldToLocal,this._fieldLocalToWorld),da.multiply(this._forceTransform,this._fieldWorldToLocal,i),da.multiply(this._forceInvTransform,n,this._fieldLocalToWorld),da.getScaling(this._fieldScale,this._fieldLocalToWorld);var r=Math.max(Math.abs(this._fieldScale.x),Math.max(Math.abs(this._fieldScale.y),Math.abs(this._fieldScale.z))),s=this._endRange*r;this._fieldLocalToWorld.getTranslation(this._fieldCenter),t.particleSystem.simulationSpace!==Vz.World?(js.transformMat4(Pq,t.position,i),Dq.set(t.position)):(js.transformMat4(Dq,t.position,n),Pq.set(t.position)),this.checkInSphere(Pq,this._fieldCenter,s)&&this.apply(t,e,this._forceTransform,this._forceInvTransform,this._multiplier)},s(e,[{key:"mode",set:function(t){this._mode=t}},{key:"multiplier",set:function(t){this._multiplier=t}},{key:"fieldLocalToWorld",set:function(t){this._fieldLocalToWorld.set(t)}},{key:"startRange",set:function(t){this._startRange=t}},{key:"endRange",set:function(t){this._endRange=t}},{key:"length",set:function(t){this._length=t}},{key:"gravityFocus",set:function(t){this._gravityFocus=t}},{key:"multiplyDragByParticleSize",set:function(t){this._multiplyDragByParticleSize=t}},{key:"multiplyDragByParticleVelocity",set:function(t){this._multiplyDragByParticleVelocity=t}},{key:"directionCacheX",set:function(t){this._directionCacheX=t}},{key:"directionCacheY",set:function(t){this._directionCacheY=t}},{key:"directionCacheZ",set:function(t){this._directionCacheZ=t}},{key:"gravityCache",set:function(t){this._gravityCache=t}},{key:"rotationSpeedCache",set:function(t){this._rotationSpeedCache=t}},{key:"rotationAttractionCache",set:function(t){this._rotationAttractionCache=t}},{key:"dragCache",set:function(t){this._dragCache=t}}]),e}(),Lq=new da,Uq=t("ForceFieldComp",(WY=ao("cc.ForceFieldComp"),XY=uo(99),jY=xo(Yz),YY=xo(mk),KY=xo(mk),qY=xo(mk),QY=xo(mk),ZY=xo(mk),JY=xo(mk),$Y=xo(mk),WY(tK=XY((eK=function(t){function e(){var e;return(e=t.call(this)||this)._field=void 0,e.shape=iK&&iK(),e.startRange=nK&&nK(),e.endRange=rK&&rK(),e.directionX=sK&&sK(),e.directionY=aK&&aK(),e.directionZ=oK&&oK(),e.gravity=uK&&uK(),e.gravityFocus=hK&&hK(),e.rotationSpeed=cK&&cK(),e.rotationAttraction=lK&&lK(),e.rotationRandomnessX=_K&&_K(),e.rotationRandomnessY=dK&&dK(),e.drag=fK&&fK(),e.multiplyDragByParticleSize=pK&&pK(),e.multiplyDragByParticleVelocity=mK&&mK(),e._field=new Fq,e}o(e,t);var i=e.prototype;return i.update=function(){this.node.getWorldMatrix(Lq),this._field.fieldLocalToWorld=Lq,this._field.mode=this.shape,this._field.startRange=this.startRange,this._field.endRange=this.endRange,this._field.setRotationRandomness(this.rotationRandomnessX,this.rotationRandomnessY),this._field.multiplyDragByParticleSize=this.multiplyDragByParticleSize,this._field.multiplyDragByParticleVelocity=this.multiplyDragByParticleVelocity,this._field.directionCacheX=this.directionX,this._field.directionCacheY=this.directionY,this._field.directionCacheZ=this.directionZ,this._field.gravityCache=this.gravity,this._field.gravityFocus=this.gravityFocus,this._field.rotationSpeedCache=this.rotationSpeed,this._field.rotationAttractionCache=this.rotationAttraction,this._field.dragCache=this.drag},i.onEnable=function(){JX.addForceField(this)},i.onDisable=function(){JX.removeForceField(this)},s(e,[{key:"field",get:function(){return this._field}}]),e}(el),iK=Za(eK.prototype,"shape",[jY,mo],(function(){return Yz.Box})),nK=Za(eK.prototype,"startRange",[mo],(function(){return 0})),rK=Za(eK.prototype,"endRange",[mo],(function(){return 1})),sK=Za(eK.prototype,"directionX",[YY,mo],(function(){return new mk})),aK=Za(eK.prototype,"directionY",[KY,mo],(function(){return new mk})),oK=Za(eK.prototype,"directionZ",[qY,mo],(function(){return new mk})),uK=Za(eK.prototype,"gravity",[QY,mo],(function(){return new mk})),hK=Za(eK.prototype,"gravityFocus",[mo],(function(){return 0})),cK=Za(eK.prototype,"rotationSpeed",[ZY,mo],(function(){return new mk})),lK=Za(eK.prototype,"rotationAttraction",[JY,mo],(function(){return new mk})),_K=Za(eK.prototype,"rotationRandomnessX",[mo],(function(){return 0})),dK=Za(eK.prototype,"rotationRandomnessY",[mo],(function(){return 0})),fK=Za(eK.prototype,"drag",[$Y,mo],(function(){return new mk})),pK=Za(eK.prototype,"multiplyDragByParticleSize",[mo],(function(){return!0})),mK=Za(eK.prototype,"multiplyDragByParticleVelocity",[mo],(function(){return!0})),tK=eK))||tK)||tK)),Gq=(gK=ao("cc.ForceFieldModule"),vK=xo([Uq]),gK((TK=function(t){function e(){var e;return(e=t.call(this)||this).name="forcefieldModule",e._enable=EK&&EK(),e.forceList=SK&&SK(),e}return o(e,t),e.prototype.animate=function(){},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),EK=Za(TK.prototype,"_enable",[mo],(function(){return!1})),SK=Za(TK.prototype,"forceList",[mo,vK],(function(){return[]})),yK=TK))||yK),kq=Ln({Initial:0,Current:1}),zq=new js,Hq=new js,Vq=new da,Wq=new ia,Xq=(AK=ao("cc.InheritVelocityModule"),RK=xo(kq),wK=xo(mk),AK((OK=function(t){function e(){var e;return(e=t.call(this)||this).name="inheritVelocityModule",e._enable=MK&&MK(),e._mode=IK&&IK(),e.speedModifier=CK&&CK(),e.speedModifier.constant=1,e}o(e,t);var i=e.prototype;return i.caculateWorldVelocity=function(t,e,i,n){e.particleSystem&&(this.mode===kq.Initial?js.copy(t,n):this.mode===kq.Current&&(i.simulationSpace===Vz.World?js.copy(t,n):(i.node.getWorldMatrix(Vq),ia.fromMat4(Wq,Vq),js.transformMat3(t,n,Wq))))},i.animate=function(t){var e=t.particleSystem;if(e){var i=t.parentParticle;if(i&&e.simulationSpace===Vz.World){var n=i.ultimateVelocity,r=i.initialVelocity,s=1-t.remainingLifetime/t.startLifetime,a=this.speedModifier.evaluate(s,Fs(t.randomSeed+955354));this.mode===kq.Initial?js.copy(zq,r):this.mode===kq.Current&&js.copy(zq,n),js.multiplyScalar(zq,zq,a),this.caculateWorldVelocity(Hq,t,i.particleSystem,zq),js.add(t.animatedVelocity,t.animatedVelocity,Hq),js.add(t.ultimateVelocity,t.velocity,t.animatedVelocity)}}},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),e}(Hz),MK=Za(OK.prototype,"_enable",[mo],(function(){return!1})),IK=Za(OK.prototype,"_mode",[mo],(function(){return kq.Initial})),m(OK.prototype,"mode",[RK],Object.getOwnPropertyDescriptor(OK.prototype,"mode"),OK.prototype),CK=Za(OK.prototype,"speedModifier",[wK,mo],(function(){return new mk})),bK=OK))||bK),jq=Ln({Vector:0,Color:1}),Yq=(xK=ao("cc.CustomDataModule"),NK=xo(jq),BK=xo(jq),PK=xo(lz),DK=xo(lz),FK=xo(mk),LK=xo(mk),UK=xo(mk),GK=xo(mk),kK=xo(mk),zK=xo(mk),HK=xo(mk),VK=xo(mk),xK((XK=function(t){function e(){var e;return(e=t.call(this)||this)._enable=jK&&jK(),e.dataType1=YK&&YK(),e.dataType2=KK&&KK(),e.data1Color=qK&&qK(),e.data2Color=QK&&QK(),e.data1X=ZK&&ZK(),e.data1Y=JK&&JK(),e.data1Z=$K&&$K(),e.data1W=tq&&tq(),e.data2X=eq&&eq(),e.data2Y=iq&&iq(),e.data2Z=nq&&nq(),e.data2W=rq&&rq(),e.name="customDataModule",e}return o(e,t),e.prototype.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime;if(this.dataType1===jq.Color){var i=Fs(1918319^t.randomSeed),n=this.data1Color.evaluate(e,i);t.custom1.set(n.r/255,n.g/255,n.b/255,n.a/255)}else{var r=Fs(1918321^t.randomSeed),s=Fs(1918322^t.randomSeed),a=Fs(1918323^t.randomSeed),o=Fs(1918324^t.randomSeed),u=this.data1X.evaluate(e,r),h=this.data1Y.evaluate(e,s),c=this.data1Z.evaluate(e,a),l=this.data1W.evaluate(e,o);t.custom1.set(u,h,c,l)}if(this.dataType2===jq.Color){var _=Fs(1918320^t.randomSeed),d=this.data2Color.evaluate(e,_);t.custom2.set(d.r/255,d.g/255,d.b/255,d.a/255)}else{var f=Fs(1918325^t.randomSeed),p=Fs(1918326^t.randomSeed),m=Fs(1918327^t.randomSeed),g=Fs(1918328^t.randomSeed),v=this.data2X.evaluate(e,f),y=this.data2Y.evaluate(e,p),T=this.data2Z.evaluate(e,m),E=this.data2W.evaluate(e,g);t.custom2.set(v,y,T,E)}},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.enableModule(this.name,t,this),this.target.setUseCustom(this._enable),this.target.updateRenderMode()))}}]),e}(Hz),jK=Za(XK.prototype,"_enable",[mo],(function(){return!1})),YK=Za(XK.prototype,"dataType1",[NK,mo],(function(){return jq.Color})),KK=Za(XK.prototype,"dataType2",[BK,mo],(function(){return jq.Color})),qK=Za(XK.prototype,"data1Color",[PK,mo],(function(){return new lz})),QK=Za(XK.prototype,"data2Color",[DK,mo],(function(){return new lz})),ZK=Za(XK.prototype,"data1X",[FK,mo],(function(){return new mk})),JK=Za(XK.prototype,"data1Y",[LK,mo],(function(){return new mk})),$K=Za(XK.prototype,"data1Z",[UK,mo],(function(){return new mk})),tq=Za(XK.prototype,"data1W",[GK,mo],(function(){return new mk})),eq=Za(XK.prototype,"data2X",[kK,mo],(function(){return new mk})),iq=Za(XK.prototype,"data2Y",[zK,mo],(function(){return new mk})),nq=Za(XK.prototype,"data2Z",[HK,mo],(function(){return new mk})),rq=Za(XK.prototype,"data2W",[VK,mo],(function(){return new mk})),WK=XK))||WK),Kq=new js,qq=new Qs,Qq=new js,Zq=new sa,Jq=new sa,$q=new da,tQ=new da,eQ=new ia,iQ=165610;var nQ,rQ,sQ,aQ,oQ,uQ,hQ,cQ,lQ,_Q,dQ,fQ,pQ,mQ,gQ,vQ,yQ,TQ,EQ,SQ,AQ,RQ,wQ,bQ,OQ,MQ,IQ,CQ,xQ,NQ,BQ,PQ,DQ,FQ,LQ,UQ,GQ,kQ,zQ,HQ,VQ,WQ,XQ,jQ,YQ,KQ,qQ,QQ,ZQ,JQ,$Q,tZ,eZ,iZ,nZ,rZ,sZ,aZ,oZ,uZ,hZ,cZ,lZ,_Z,dZ,fZ,pZ,mZ,gZ,vZ,yZ,TZ,EZ,SZ,AZ,RZ,wZ,bZ,OZ,MZ,IZ,CZ,xZ,NZ,BZ,PZ,DZ,FZ,LZ,UZ,GZ,kZ,zZ,HZ,VZ,WZ,XZ,jZ,YZ,KZ,qZ,QZ,ZZ,JZ,$Z,tJ,eJ,iJ,nJ,rJ,sJ,aJ,oJ,uJ,hJ,cJ,lJ,_J,dJ,fJ,pJ,mJ,gJ=(sq=ao("cc.RotationSpeedModule"),aq=xo(pr),oq=xo(mk),uq=xo(mk),hq=xo(mk),sq((lq=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this)._enable=_q&&_q(),e.rotation3D=dq&&dq(),e.rotationX=fq&&fq(),e.rotationY=pq&&pq(),e.rotationZ=mq&&mq(),e.range=new Qs(0,1),e.name=Gz,e}return o(e,t),e.prototype.animate=function(t){Kq.set(t.velocity.x+t.animatedVelocity.x,t.velocity.y+t.animatedVelocity.y,t.velocity.z+t.animatedVelocity.z);var e,i,n,r,s=Kq.length();e=qq,n=(i=this.range).y-i.x,r=Math.abs(n)>Ts?1/n:i.x,e.set(r,-i.x*r);var a,o=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=1),Math.min(Math.max(t,e),i)}(s*(a=qq).x+a.y),u=Fs(t.randomSeed+iQ+1),h=Fs(t.randomSeed+iQ+2),c=Fs(t.randomSeed+iQ+3),l=Fs(t.randomSeed+iQ+10)>0?-1:1;this.rotation3D?Qq.set(this.rotationX.evaluate(o,u)*l,this.rotationY.evaluate(o,h)*l,this.rotationZ.evaluate(o,c)*l):Qq.set(0,0,this.rotationZ.evaluate(o,c)*l),sa.fromEuler(Jq,t.startEuler.x*pz.R2D,t.startEuler.y*pz.R2D,t.startEuler.z*pz.R2D),sa.normalize(Jq,Jq),da.fromQuat(tQ,Jq),sa.fromEuler(Zq,Qq.x,Qq.y,Qq.z),sa.normalize(Zq,Zq),da.fromQuat($q,Zq),da.multiply(t.localMat,$q,t.localMat),da.multiply(tQ,t.localMat,tQ),ia.fromMat4(eQ,tQ),sa.fromMat3(Jq,eQ),function(t,e){sa.normalize(e,e),t.set(e.x,e.y,e.z),e.w<0&&(t.x+=pz.INDENTIFY_NEG_QUAT)}(t.rotation,Jq)},s(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(Hz),_q=Za(lq.prototype,"_enable",[mo],(function(){return!1})),dq=Za(lq.prototype,"rotation3D",[aq,mo],(function(){return!1})),fq=Za(lq.prototype,"rotationX",[oq,mo],(function(){return new mk})),pq=Za(lq.prototype,"rotationY",[uq,mo],(function(){return new mk})),mq=Za(lq.prototype,"rotationZ",[hq,mo],(function(){return new mk})),cq=lq))||cq),vJ=new da,yJ=new sa,TJ=new js,EJ=new js,SJ=new da,AJ=new js,RJ=new sa,wJ=new js,bJ=new da,OJ=new sa,MJ=new da,IJ=Object.getOwnPropertyDescriptor(fE.prototype,"sharedMaterials"),CJ=t("ParticleSystem",(nQ=ao("cc.ParticleSystem"),rQ=uo(99),sQ=xo(lz),aQ=xo(Vz),oQ=go("startSize"),uQ=xo(mk),hQ=xo(mk),cQ=xo(mk),lQ=xo(mk),_Q=xo(mk),dQ=xo(mk),fQ=xo(mk),pQ=go("startRotation"),mQ=xo(mk),gQ=xo(mk),vQ=xo(Vz),yQ=xo(mk),TQ=xo(mk),EQ=xo(mk),SQ=xo([sX]),AQ=xo(pr),RQ=xo(Wz),wQ=xo(fr),bQ=xo(fr),OQ=xo(fr),MQ=go("enableCulling"),IQ=xo($T),CQ=xo(Jz),xQ=xo(Jz),NQ=xo(hX),BQ=xo(hX),PQ=xo(WW),DQ=xo(WW),FQ=xo(rX),LQ=xo(rX),UQ=xo(WH),GQ=xo(WH),kQ=xo(qH),zQ=xo(qH),HQ=xo(VW),VQ=xo(VW),WQ=xo(KW),XQ=xo(KW),jQ=xo(Bq),YQ=xo(Bq),KQ=xo(Gq),qQ=xo(Gq),QQ=xo(Xq),ZQ=xo(Xq),JQ=xo(Yq),$Q=xo(Yq),tZ=xo(gJ),eZ=xo(gJ),iZ=xo(bq),nZ=xo(bq),rZ=xo(gq),sZ=xo(pr),aZ=xo(pr),oZ=xo(pr),uZ=xo(pr),hZ=xo(fr),cZ=xo(pr),lZ=xo(dr),nQ(_Z=rQ((mJ=pJ=function(t){o(i,t);var e=i.prototype;function i(){var e;return(e=t.call(this)||this).startColor=fZ&&fZ(),e.scaleSpace=pZ&&pZ(),e.startSize3D=mZ&&mZ(),e.startSizeX=gZ&&gZ(),e.startSizeY=vZ&&vZ(),e.startSizeZ=yZ&&yZ(),e.startSpeed=TZ&&TZ(),e.startRotation3D=EZ&&EZ(),e.startRotationX=SZ&&SZ(),e.startRotationY=AZ&&AZ(),e.startRotationZ=RZ&&RZ(),e.startDelay=wZ&&wZ(),e.startLifetime=bZ&&bZ(),e.duration=OZ&&OZ(),e.loop=MZ&&MZ(),e.simulationSpeed=IZ&&IZ(),e.playOnAwake=CZ&&CZ(),e.gravityModifier=xZ&&xZ(),e.rateOverTime=NZ&&NZ(),e.rateOverDistance=BZ&&BZ(),e.bursts=PZ&&PZ(),e._renderCulling=DZ&&DZ(),e._cullingMode=FZ&&FZ(),e._aabbHalfX=LZ&&LZ(),e._aabbHalfY=UZ&&UZ(),e._aabbHalfZ=GZ&&GZ(),e._dataCulling=kZ&&kZ(),e._colorOverLifetimeModule=zZ&&zZ(),e._shapeModule=HZ&&HZ(),e._sizeOvertimeModule=VZ&&VZ(),e._velocityOvertimeModule=WZ&&WZ(),e._forceOvertimeModule=XZ&&XZ(),e._limitVelocityOvertimeModule=jZ&&jZ(),e._rotationOvertimeModule=YZ&&YZ(),e._textureAnimationModule=KZ&&KZ(),e._noiseModule=qZ&&qZ(),e._forceFieldModule=QZ&&QZ(),e._inheritVelocityModule=ZZ&&ZZ(),e._customDataModule=JZ&&JZ(),e._rotationSpeedModule=$Z&&$Z(),e._trailModule=tJ&&tJ(),e.renderer=eJ&&eJ(),e._useSubEmitter=iJ&&iJ(),e._subBase=nJ&&nJ(),e._actDie=rJ&&rJ(),e._inheritColor=sJ&&sJ(),e._useSeed=aJ&&aJ(),e._randomSeed=oJ&&oJ(),e._subPercent=uJ&&uJ(),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=hJ&&hJ(),e._baseEmitters=cJ&&cJ(),e._parentEmitter=lJ&&lJ(),e._needAttach=void 0,e._trigged=void 0,e._prewarm=_J&&_J(),e._capacity=dJ&&dJ(),e._simulationSpace=fJ&&fJ(),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needRefresh=!0,e._needAttach=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new js,e._curWPos=new js,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new Qs,e._customData2=new Qs,e._subEmitters=[],e._baseEmitters=[],e._parentEmitter=null,e._trigged=!1,xs(e.useSeed),Ns(e.randomSeed),e}return e.copyEmitter=function(t,e,i){var n;e.loop=t.loop,e.capacity=i,e.playOnAwake=t.playOnAwake,e.prewarm=t.prewarm,e.simulationSpace=t.simulationSpace,e.scaleSpace=t.scaleSpace,e.actDie=t.actDie,e.inheritColor=t.inheritColor,e.startSize3D=t.startSize3D,e.startRotation3D=t.startRotation3D,e.simulationSpeed=t.simulationSpeed,e.subPercent=t.subPercent,Object.assign(e.startColor,t.startColor),Object.assign(e.startDelay,t.startDelay),Object.assign(e.startLifetime,t.startLifetime),Object.assign(e.rateOverTime,t.rateOverTime),Object.assign(e.rateOverDistance,t.rateOverDistance),Object.assign(e.startSpeed,t.startSpeed),Object.assign(e.startSizeX,t.startSizeX),Object.assign(e.startSizeY,t.startSizeY),Object.assign(e.startSizeZ,t.startSizeZ),Object.assign(e.startRotationX,t.startRotationX),Object.assign(e.startRotationY,t.startRotationY),Object.assign(e.startRotationZ,t.startRotationZ),Object.assign(e.gravityModifier,t.gravityModifier),t._colorOverLifetimeModule&&(e._colorOverLifetimeModule=new Jz,Object.assign(e._colorOverLifetimeModule,t._colorOverLifetimeModule),e._colorOverLifetimeModule.bindTarget(e.processor)),t._sizeOvertimeModule&&(e._sizeOvertimeModule=new WW,Object.assign(e._sizeOvertimeModule,t._sizeOvertimeModule),e._sizeOvertimeModule.bindTarget(e.processor)),t._velocityOvertimeModule&&(e._velocityOvertimeModule=new rX,Object.assign(e._velocityOvertimeModule,t._velocityOvertimeModule),e._velocityOvertimeModule.bindTarget(e.processor)),t._forceOvertimeModule&&(e._forceOvertimeModule=new WH,Object.assign(e._forceOvertimeModule,t._forceOvertimeModule),e._forceOvertimeModule.bindTarget(e.processor)),t._limitVelocityOvertimeModule&&(e._limitVelocityOvertimeModule=new qH,Object.assign(e._limitVelocityOvertimeModule,t._limitVelocityOvertimeModule),e._limitVelocityOvertimeModule.bindTarget(e.processor)),t._rotationOvertimeModule&&(e._rotationOvertimeModule=new VW,Object.assign(e._rotationOvertimeModule,t._rotationOvertimeModule),e._rotationOvertimeModule.bindTarget(e.processor)),t._textureAnimationModule&&(e._textureAnimationModule=new KW,Object.assign(e._textureAnimationModule,t._textureAnimationModule),e._textureAnimationModule.bindTarget(e.processor));for(var r=0;r<t.bursts.length;++r){var s=new sX;s.time=t.bursts[r].time,s.repeatCount=t.bursts[r].repeatCount,s.repeatInterval=t.bursts[r].repeatInterval,Object.assign(s.count,t.bursts[r].count),e.bursts.push(s)}if(!e.shapeModule&&t.shapeModule&&(e.shapeModule=new hX,e.shapeModule.onInit(e)),!e.shapeModule||null!==(n=e.shapeModule)&&void 0!==n&&n.enable||(t.shapeModule?(e.shapeModule.shapeType=t.shapeModule.shapeType,e.shapeModule.position=t.shapeModule.position,e.shapeModule.rotation=t.shapeModule.rotation,e.shapeModule.scale=t.shapeModule.scale,e.shapeModule.arc=t.shapeModule.arc,e.shapeModule.angle=t.shapeModule.angle,e.shapeModule.emitFrom=t.shapeModule.emitFrom,e.shapeModule.alignToDirection=t.shapeModule.alignToDirection,e.shapeModule.randomDirectionAmount=t.shapeModule.randomDirectionAmount,e.shapeModule.sphericalDirectionAmount=t.shapeModule.sphericalDirectionAmount,e.shapeModule.randomPositionAmount=t.shapeModule.randomPositionAmount,e.shapeModule.radius=t.shapeModule.radius,e.shapeModule.radiusThickness=t.shapeModule.radiusThickness,e.shapeModule.arcMode=t.shapeModule.arcMode,e.shapeModule.arcSpread=t.shapeModule.arcSpread,e.shapeModule.arcSpeed=t.shapeModule.arcSpeed,e.shapeModule.length=t.shapeModule.length,e.shapeModule.boxThickness=t.shapeModule.boxThickness,e.shapeModule.enable=t.shapeModule.enable):e.shapeModule.enable=!1),t.forceFieldModule&&e.forceFieldModule){for(var a=0;a<t.forceFieldModule.forceList.length;++a){var o=t.forceFieldModule.forceList[a];e.forceFieldModule.forceList.push(o)}e.forceFieldModule.enable=t.forceFieldModule.enable}t.inheritVelocityModule&&e.inheritVelocityModule&&(e.inheritVelocityModule.mode=t.inheritVelocityModule.mode,Object.assign(e.inheritVelocityModule.speedModifier,t.inheritVelocityModule.speedModifier),e.inheritVelocityModule.enable=t.inheritVelocityModule.enable),t.customDataModule&&e.customDataModule&&(e.customDataModule.dataType1=t.customDataModule.dataType1,e.customDataModule.dataType2=t.customDataModule.dataType2,Object.assign(e.customDataModule.data1Color,t.customDataModule.data1Color),Object.assign(e.customDataModule.data2Color,t.customDataModule.data2Color),Object.assign(e.customDataModule.data1X,t.customDataModule.data1X),Object.assign(e.customDataModule.data1Y,t.customDataModule.data1Y),Object.assign(e.customDataModule.data1Z,t.customDataModule.data1Z),Object.assign(e.customDataModule.data1W,t.customDataModule.data1W),Object.assign(e.customDataModule.data2X,t.customDataModule.data2X),Object.assign(e.customDataModule.data2Y,t.customDataModule.data2Y),Object.assign(e.customDataModule.data2Z,t.customDataModule.data2Z),Object.assign(e.customDataModule.data2W,t.customDataModule.data2W),e.customDataModule.enable=t.customDataModule.enable),t.rotationSpeedModule&&e.rotationSpeedModule&&(e.rotationSpeedModule.rotation3D=t.rotationSpeedModule.rotation3D,Object.assign(e.rotationSpeedModule.range,t.rotationSpeedModule.range),Object.assign(e.rotationSpeedModule.rotationX,t.rotationSpeedModule.rotationX),Object.assign(e.rotationSpeedModule.rotationY,t.rotationSpeedModule.rotationY),Object.assign(e.rotationSpeedModule.rotationZ,t.rotationSpeedModule.rotationZ),e.rotationSpeedModule.enable=t.rotationSpeedModule.enable),t.noiseModule&&e.noiseModule&&(e.noiseModule.strengthX=t.noiseModule.strengthX,e.noiseModule.strengthY=t.noiseModule.strengthY,e.noiseModule.strengthZ=t.noiseModule.strengthZ,e.noiseModule.noiseSpeedX=t.noiseModule.noiseSpeedX,e.noiseModule.noiseSpeedY=t.noiseModule.noiseSpeedY,e.noiseModule.noiseSpeedZ=t.noiseModule.noiseSpeedZ,e.noiseModule.noiseFrequency=t.noiseModule.noiseFrequency,e.noiseModule.remapX=t.noiseModule.remapX,e.noiseModule.remapY=t.noiseModule.remapY,e.noiseModule.remapZ=t.noiseModule.remapZ,e.noiseModule.octaves=t.noiseModule.octaves,e.noiseModule.octaveMultiplier=t.noiseModule.octaveMultiplier,e.noiseModule.octaveScale=t.noiseModule.octaveScale,e.noiseModule.enable=t.noiseModule.enable),e.setMaterial(t.getMaterial(1),1),t._trailModule&&(e.trailModule=new bq,e._trailModule&&(e._trailModule.onInit(e),e._trailModule.updateMaterial(),e._trailModule.enable=t._trailModule.enable,e._trailModule.onEnable(),e._trailModule.mode=t._trailModule.mode,e._trailModule.textureMode=t._trailModule.textureMode,e._trailModule.widthFromParticle=t._trailModule.widthFromParticle,e._trailModule.colorFromParticle=t._trailModule.colorFromParticle,e._trailModule.existWithParticles=t._trailModule.existWithParticles,e._trailModule.minParticleDistance=t._trailModule.minParticleDistance,e._trailModule.space=t._trailModule.space,Object.assign(e._trailModule.lifeTime,t._trailModule.lifeTime),Object.assign(e._trailModule.widthRatio,t._trailModule.widthRatio),Object.assign(e._trailModule.colorOverTrail,t._trailModule.colorOverTrail),Object.assign(e._trailModule.colorOvertime,t._trailModule.colorOvertime))),e.renderer.cpuMaterial=t.renderer.cpuMaterial,e.renderer.alignSpace=t.renderer.alignSpace,e.renderer.mesh=t.renderer.mesh,e.renderer.renderMode=t.renderer.renderMode},e.genSubEmitter=function(t,e,n,r){var s=new kp(t.name+e.toString());s.setParent(n.node),s.addComponent(i),s.setRotation(n.node.children[r].rotation);var a=s.components[0];a._parentEmitter=n,this.copyEmitter(t,a,n.capacity*t.capacity),a.name=t.name+e.toString(),a.stop(),n.addSubEmitter(a);for(var o=0;o<t.node.children.length;++o){var u=t.node.children[o];if(u.components.length>0&&u.components[0]instanceof i){var h=u.components[0];if(h.subBase){var c="progenyBase:"+h.name+e.toString(),l=new kp(c);l.setParent(s),l.addComponent(i),l.setRotation(t.node.children[o].rotation);var _=l.components[0];_._parentEmitter=a,this.copyEmitter(h,_,h.capacity),_.name=c,_.stop(),l.active=!1,_.subBase=h.subBase}}}return a},e.refreshSubemitters=function(){this._useSubEmitter?this.createSubEmitterByBase(this):this.removeSubEmitters(this)},e.createSubEmitterByBase=function(t){if(0===t._subEmitters.length)for(var e=0;e<t.node.children.length;++e){var n=t.node.children[e];if(n.components.length>0&&n.components[0]instanceof i){var r=n.components[0];if(r.subBase){t._baseEmitters.push(r);for(var s=0;s<1;++s)t.genSubEmitter(r,s,t,e)._useSubEmitter=r._useSubEmitter}}}},e.removeSubEmitters=function(t){if(t._subEmitters.length>0){for(;t._subEmitters.length>0;){var e,i=t._subEmitters.pop();i&&(this.removeSubEmitters(i),null===(e=i.node.parent)||void 0===e||e.removeChild(i.node),i.destroy())}t._baseEmitters=[],t.processor&&t.processor.clearSubemitter()}},e.onFocusInEditor=function(){this.renderer.create(this)},e.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&!this.renderer.useGPU&&this._trailModule.enable&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},e._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},e._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},e._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},e._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},e._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},e.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor),this._noiseModule&&this._noiseModule.bindTarget(this.processor),this._forceFieldModule&&this._forceFieldModule.bindTarget(this.processor),this._inheritVelocityModule&&this._inheritVelocityModule.bindTarget(this.processor),this._customDataModule&&this._customDataModule.bindTarget(this.processor),this._rotationSpeedModule&&this._rotationSpeedModule.bindTarget(this.processor)},e.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}xs(this.useSeed),Ns(this.randomSeed)},e.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},e.stopEmitting=function(){this._isEmitting=!1},e.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._isEmitting&&(this._isEmitting=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var t,e=p(this.bursts);!(t=e()).done;)t.value.reset()},e.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},e.getParticleCount=function(){return this.processor.getParticleCount()},e.setCustomData1=function(t,e){Qs.set(this._customData1,t,e)},e.setCustomData2=function(t,e){Qs.set(this._customData2,t,e)},e.onDestroy=function(){var t;this.stop(),null!==(t=this.processor.getModel())&&void 0!==t&&t.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()),v.director.off(v.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},e.onEnable=function(){t.prototype.onEnable.call(this),v.director.on(v.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},e.onDisable=function(){v.director.off(v.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},e._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new Nq(this)),this._culler.calculatePositions(),sc.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},e.update=function(t){var e,i,n=t*this.simulationSpeed;if(this.renderCulling){var r;if(this._boundingBox||(this._boundingBox=new sc,this._calculateBounding(!1)),this._curPos||(this._curPos=new js),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new js,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var s=this._curPos.x-this._oldPos.x,a=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,u=this._boundingBox.center;u.x+=s,u.y+=a,u.z+=o,this._culler.setBoundingBoxCenter(u.x,u.y,u.z),this._oldPos.set(this._curPos)}var h=null===(r=this.node.scene.renderScene)||void 0===r?void 0:r.cameras,c=!0;if(void 0!==h&&this._boundingBox)for(var l=0;l<h.length;++l){var _=h[l];if((_.visibility&this.node.layer)===this.node.layer&&jh.aabbFrustum(this._boundingBox,_.frustum)){c=!1;break}}if(c){if(this._cullingMode!==Wz.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===Wz.PauseAndCatchup&&(this._time+=n),this._cullingMode!==Wz.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=n,this._parentEmitter||this._emit(n),0!==this.processor.updateParticles(n)||this._isEmitting||this.stop();else{var d=this.getMaterialInstance(0)||this.processor.getDefaultMaterial();this.processor.updateRotation(d),this.processor.updateScale(d)}this._needAttach&&this.getParticleCount()>0&&!this._isCulled&&(null!==(e=this.processor.getModel())&&void 0!==e&&e.scene||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&(null!==(i=this._trailModule.getModel())&&void 0!==i&&i.scene||this._trailModule._attachToScene()),this._needAttach=!1);!this.renderer.useGPU&&this._trailModule&&this._trailModule.enable&&(this._trailModule._inited||(this._trailModule.clear(),this._trailModule.destroy(),this._trailModule.onInit(this),this._trailModule.enable=!1,this._trailModule.enable=!0))},e.beforeRender=function(){var t,e,i;this.getParticleCount()<=0?null!==(i=this.processor.getModel())&&void 0!==i&&i.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):null!==(t=this.processor.getModel())&&void 0!==t&&t.scene||(this._needAttach=!0),this._isPlaying&&null!==(e=this.processor.getModel())&&void 0!==e&&e.scene&&(this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData(),this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},e._onVisibilityChange=function(t){this.processor._model&&(this.processor._model.visFlags=t)},e.emit=function(t,e,i){var n=this._time;i&&(n=i.time);var r=n%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(gp.POSITION),this._needRefresh=!1),this._simulationSpace===Vz.World?i?i.particleSystem._simulationSpace===Vz.World?(vJ.set(da.IDENTITY),this.node.getWorldScale(TJ),da.fromTranslation(SJ,i.position),da.multiply(vJ,vJ,SJ),da.fromQuat(SJ,i.dir),da.multiply(vJ,vJ,SJ),da.fromScaling(SJ,TJ),da.multiply(vJ,vJ,SJ),sa.copy(yJ,i.dir)):(i.particleSystem.node.getWorldMatrix(vJ),i.particleSystem.node.getScale(EJ),da.fromTranslation(SJ,i.position),da.multiply(vJ,vJ,SJ),da.fromQuat(SJ,i.dir),da.multiply(vJ,vJ,SJ),da.fromScaling(SJ,EJ),da.multiply(vJ,vJ,SJ),da.getRotation(yJ,vJ)):(this.node.getWorldMatrix(vJ),this.node.getWorldRotation(yJ)):i&&i.particleSystem._simulationSpace===Vz.World?(i.particleSystem.node.getWorldMatrix(bJ),i.particleSystem.node.getWorldRotation(OJ),da.invert(bJ,bJ),sa.invert(OJ,OJ)):i&&i.particleSystem._simulationSpace!==Vz.World&&(this.node.getPosition(AJ),this.node.getScale(EJ),this.node.getRotation(RJ),MJ.set(da.IDENTITY),da.fromScaling(SJ,EJ),da.multiply(MJ,SJ,MJ),da.fromQuat(SJ,RJ),da.multiply(MJ,SJ,MJ),da.fromTranslation(SJ,AJ),da.multiply(MJ,SJ,MJ),da.invert(bJ,MJ),sa.invert(OJ,RJ));for(var s=e/t,a=0;a<t;++a){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset(),i&&(o.parentParticle=i);var u=Fs(Ds(0,cs));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(js.set(o.position,0,0,0),js.copy(o.velocity,$z)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var h=this.startSpeed.evaluate(r,u);js.multiplyScalar(o.velocity,o.velocity,h),this._simulationSpace===Vz.World?(js.transformMat4(o.position,o.position,vJ),js.transformQuat(o.velocity,o.velocity,yJ)):i&&(js.transformQuat(o.position,o.position,i.dir),da.fromTranslation(SJ,i.position),js.transformMat4(o.position,o.position,SJ),js.transformMat4(o.position,o.position,bJ),js.transformQuat(o.velocity,o.velocity,i.dir),js.transformQuat(o.velocity,o.velocity,OJ)),this._simulationSpace===Vz.World?js.copy(o.initialVelocity,o.velocity):(this.node.getWorldRotation(yJ),js.copy(o.initialVelocity,wJ)),js.copy(o.ultimateVelocity,o.velocity),i&&i.particleSystem&&(i.particleSystem.simulationSpace===Vz.World?js.copy(wJ,i.ultimateVelocity):(i.particleSystem.node.getWorldRotation(RJ),js.transformQuat(wJ,i.ultimateVelocity,RJ)),o.position.add3f(wJ.x*a*s,wJ.y*a*s,wJ.z*a*s)),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(r,u),this.startRotationY.evaluate(r,u),this.startRotationZ.evaluate(r,u)):o.startEuler.set(0,0,this.startRotationZ.evaluate(r,u)),o.rotation.set(o.startEuler),this.startSize3D?js.set(o.startSize,this.startSizeX.evaluate(r,u),this.startSizeY.evaluate(r,u),this.startSizeZ.evaluate(r,u)):(js.set(o.startSize,this.startSizeX.evaluate(r,u),1,1),o.startSize.y=o.startSize.x),js.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(r,u)),i&&this.inheritColor&&(o.startColor.r=i.color.r,o.startColor.g=i.color.g,o.startColor.b=i.color.b),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(r,u)+e,o.remainingLifetime=o.startLifetime,o.randomSeed=Ds(0,233280),o.loopCount++,this._trailModule&&this._trailModule.enable&&this._trailModule.removeParticle(o),o.active=!0,this._trigged=!0,this.processor.setNewParticle(o)}},e._prewarmSystem=function(){this.startDelay.mode=pk.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._parentEmitter||this._emit(1),this.processor.updateParticles(1)},e._emit=function(t,e){if(e)for(var i,n=p(this.bursts);!(i=n()).done;)i.value.update(this,t,e);else if(!this.loop&&this.time<=this.duration)for(var r,s=p(this.bursts);!(r=s()).done;)r.value.update(this,t,e);var a=this.startDelay.evaluate(0,Is()),o=this._time;if(e&&(o=e.time),o>a){if(o>this.duration+a&&(this.loop||(this._isEmitting=!1)),!this._isEmitting)return;if(e){if(e.timeCounter+=this.rateOverTime.evaluate(o/this.duration,1)*t,e.timeCounter>1){var u=Math.floor(e.timeCounter);e.timeCounter-=u,this.emit(u,t,e)}var h=e.ultimateVelocity.length()*t;if(e.distanceCounter+=h*this.rateOverDistance.evaluate(o/this.duration,1),e.distanceCounter>1){var c=Math.floor(e.distanceCounter);e.distanceCounter-=c,this.emit(c,t,e)}}else{if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(o/this.duration,1)*t,this._emitRateTimeCounter>1){var l=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=l,this.emit(l,t,e)}this.node.getWorldPosition(this._curWPos);var _=js.distance(this._curWPos,this._oldWPos);if(js.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=_*this.rateOverDistance.evaluate(o/this.duration,1),this._emitRateDistanceCounter>1){var d=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=d,this.emit(d,t,e)}}}},e._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),js.copy(this._curWPos,this._oldWPos)},e.addSubEmitter=function(t){this._subEmitters.push(t)},e.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},e.getSubEmitters=function(){return this._subEmitters},e.addBurst=function(t){this.bursts.push(t)},e.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},e.getBoundingX=function(){return this._aabbHalfX},e.getBoundingY=function(){return this._aabbHalfY},e.getBoundingZ=function(){return this._aabbHalfZ},e.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},e.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},e.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},e._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!zz.includes(t)||e[t]&&e[t].enable})):t},e.getNoisePreview=function(t,e){var i=[];return this.processor&&this.processor.getNoisePreview(i,t,e),i},s(i,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new sc,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return IJ.get.call(this)},set:function(t){IJ.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"noiseModule",get:function(){return this._noiseModule},set:function(t){t&&(this._noiseModule=t)}},{key:"forceFieldModule",get:function(){return this._forceFieldModule},set:function(t){t&&(this._forceFieldModule=t)}},{key:"inheritVelocityModule",get:function(){return this._inheritVelocityModule},set:function(t){t&&(this._inheritVelocityModule=t)}},{key:"customDataModule",get:function(){return this._customDataModule&&this.processor&&(this.processor.setUseCustom(this._customDataModule._enable),this.processor.updateRenderMode()),this._customDataModule},set:function(t){t&&(this._customDataModule=t)}},{key:"rotationSpeedModule",get:function(){return this._rotationSpeedModule},set:function(t){t&&(this._rotationSpeedModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"useSubEmitter",get:function(){return this._useSubEmitter},set:function(t){this._useSubEmitter=t}},{key:"subBase",get:function(){return this._subBase},set:function(t){this._subBase=t}},{key:"actDie",get:function(){return this._actDie},set:function(t){this._actDie=t}},{key:"inheritColor",get:function(){return this._inheritColor},set:function(t){this._inheritColor=t}},{key:"subPercent",get:function(){return this._subPercent},set:function(t){this._subPercent=t}},{key:"useSeed",get:function(){return this._useSeed},set:function(t){this._useSeed=t,xs(this.useSeed)}},{key:"randomSeed",get:function(){return this._randomSeed},set:function(t){this._randomSeed=t}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),i}(pE),pJ.CullingMode=Wz,fZ=Za((dZ=mJ).prototype,"startColor",[sQ,mo],(function(){return new lz})),pZ=Za(dZ.prototype,"scaleSpace",[aQ,mo],(function(){return Vz.Local})),mZ=Za(dZ.prototype,"startSize3D",[mo],(function(){return!1})),gZ=Za(dZ.prototype,"startSizeX",[oQ,uQ],(function(){return new mk})),vZ=Za(dZ.prototype,"startSizeY",[hQ,mo],(function(){return new mk})),yZ=Za(dZ.prototype,"startSizeZ",[cQ,mo],(function(){return new mk})),TZ=Za(dZ.prototype,"startSpeed",[lQ,mo],(function(){return new mk})),EZ=Za(dZ.prototype,"startRotation3D",[mo],(function(){return!1})),SZ=Za(dZ.prototype,"startRotationX",[_Q,mo],(function(){return new mk})),AZ=Za(dZ.prototype,"startRotationY",[dQ,mo],(function(){return new mk})),RZ=Za(dZ.prototype,"startRotationZ",[fQ,pQ],(function(){return new mk})),wZ=Za(dZ.prototype,"startDelay",[mQ,mo],(function(){return new mk})),bZ=Za(dZ.prototype,"startLifetime",[gQ,mo],(function(){return new mk})),OZ=Za(dZ.prototype,"duration",[mo],(function(){return 5})),MZ=Za(dZ.prototype,"loop",[mo],(function(){return!0})),m(dZ.prototype,"simulationSpace",[vQ,mo],Object.getOwnPropertyDescriptor(dZ.prototype,"simulationSpace"),dZ.prototype),IZ=Za(dZ.prototype,"simulationSpeed",[mo],(function(){return 1})),CZ=Za(dZ.prototype,"playOnAwake",[mo],(function(){return!0})),xZ=Za(dZ.prototype,"gravityModifier",[yQ,mo],(function(){return new mk})),NZ=Za(dZ.prototype,"rateOverTime",[TQ,mo],(function(){return new mk})),BZ=Za(dZ.prototype,"rateOverDistance",[EQ,mo],(function(){return new mk})),PZ=Za(dZ.prototype,"bursts",[SQ,mo],(function(){return[]})),m(dZ.prototype,"renderCulling",[AQ],Object.getOwnPropertyDescriptor(dZ.prototype,"renderCulling"),dZ.prototype),DZ=Za(dZ.prototype,"_renderCulling",[mo],(function(){return!1})),m(dZ.prototype,"cullingMode",[RQ],Object.getOwnPropertyDescriptor(dZ.prototype,"cullingMode"),dZ.prototype),FZ=Za(dZ.prototype,"_cullingMode",[mo],(function(){return Wz.Pause})),m(dZ.prototype,"aabbHalfX",[wQ],Object.getOwnPropertyDescriptor(dZ.prototype,"aabbHalfX"),dZ.prototype),LZ=Za(dZ.prototype,"_aabbHalfX",[mo],(function(){return 0})),m(dZ.prototype,"aabbHalfY",[bQ],Object.getOwnPropertyDescriptor(dZ.prototype,"aabbHalfY"),dZ.prototype),UZ=Za(dZ.prototype,"_aabbHalfY",[mo],(function(){return 0})),m(dZ.prototype,"aabbHalfZ",[OQ],Object.getOwnPropertyDescriptor(dZ.prototype,"aabbHalfZ"),dZ.prototype),GZ=Za(dZ.prototype,"_aabbHalfZ",[mo],(function(){return 0})),kZ=Za(dZ.prototype,"_dataCulling",[mo,MQ],(function(){return!1})),m(dZ.prototype,"sharedMaterials",[No,IQ,mo],Object.getOwnPropertyDescriptor(dZ.prototype,"sharedMaterials"),dZ.prototype),zZ=Za(dZ.prototype,"_colorOverLifetimeModule",[CQ],(function(){return null})),m(dZ.prototype,"colorOverLifetimeModule",[xQ],Object.getOwnPropertyDescriptor(dZ.prototype,"colorOverLifetimeModule"),dZ.prototype),HZ=Za(dZ.prototype,"_shapeModule",[NQ],(function(){return null})),m(dZ.prototype,"shapeModule",[BQ],Object.getOwnPropertyDescriptor(dZ.prototype,"shapeModule"),dZ.prototype),VZ=Za(dZ.prototype,"_sizeOvertimeModule",[PQ],(function(){return null})),m(dZ.prototype,"sizeOvertimeModule",[DQ],Object.getOwnPropertyDescriptor(dZ.prototype,"sizeOvertimeModule"),dZ.prototype),WZ=Za(dZ.prototype,"_velocityOvertimeModule",[FQ],(function(){return null})),m(dZ.prototype,"velocityOvertimeModule",[LQ],Object.getOwnPropertyDescriptor(dZ.prototype,"velocityOvertimeModule"),dZ.prototype),XZ=Za(dZ.prototype,"_forceOvertimeModule",[UQ],(function(){return null})),m(dZ.prototype,"forceOvertimeModule",[GQ],Object.getOwnPropertyDescriptor(dZ.prototype,"forceOvertimeModule"),dZ.prototype),jZ=Za(dZ.prototype,"_limitVelocityOvertimeModule",[kQ],(function(){return null})),m(dZ.prototype,"limitVelocityOvertimeModule",[zQ],Object.getOwnPropertyDescriptor(dZ.prototype,"limitVelocityOvertimeModule"),dZ.prototype),YZ=Za(dZ.prototype,"_rotationOvertimeModule",[HQ],(function(){return null})),m(dZ.prototype,"rotationOvertimeModule",[VQ],Object.getOwnPropertyDescriptor(dZ.prototype,"rotationOvertimeModule"),dZ.prototype),KZ=Za(dZ.prototype,"_textureAnimationModule",[WQ],(function(){return null})),m(dZ.prototype,"textureAnimationModule",[XQ],Object.getOwnPropertyDescriptor(dZ.prototype,"textureAnimationModule"),dZ.prototype),qZ=Za(dZ.prototype,"_noiseModule",[jQ],(function(){return null})),m(dZ.prototype,"noiseModule",[YQ],Object.getOwnPropertyDescriptor(dZ.prototype,"noiseModule"),dZ.prototype),QZ=Za(dZ.prototype,"_forceFieldModule",[KQ],(function(){return null})),m(dZ.prototype,"forceFieldModule",[qQ],Object.getOwnPropertyDescriptor(dZ.prototype,"forceFieldModule"),dZ.prototype),ZZ=Za(dZ.prototype,"_inheritVelocityModule",[QQ],(function(){return null})),m(dZ.prototype,"inheritVelocityModule",[ZQ],Object.getOwnPropertyDescriptor(dZ.prototype,"inheritVelocityModule"),dZ.prototype),JZ=Za(dZ.prototype,"_customDataModule",[JQ],(function(){return null})),m(dZ.prototype,"customDataModule",[$Q],Object.getOwnPropertyDescriptor(dZ.prototype,"customDataModule"),dZ.prototype),$Z=Za(dZ.prototype,"_rotationSpeedModule",[tZ],(function(){return null})),m(dZ.prototype,"rotationSpeedModule",[eZ],Object.getOwnPropertyDescriptor(dZ.prototype,"rotationSpeedModule"),dZ.prototype),tJ=Za(dZ.prototype,"_trailModule",[iZ],(function(){return null})),m(dZ.prototype,"trailModule",[nZ],Object.getOwnPropertyDescriptor(dZ.prototype,"trailModule"),dZ.prototype),eJ=Za(dZ.prototype,"renderer",[rZ,mo],(function(){return new gq})),m(dZ.prototype,"useSubEmitter",[sZ],Object.getOwnPropertyDescriptor(dZ.prototype,"useSubEmitter"),dZ.prototype),iJ=Za(dZ.prototype,"_useSubEmitter",[mo],(function(){return!1})),m(dZ.prototype,"subBase",[aZ],Object.getOwnPropertyDescriptor(dZ.prototype,"subBase"),dZ.prototype),nJ=Za(dZ.prototype,"_subBase",[mo],(function(){return!1})),m(dZ.prototype,"actDie",[oZ],Object.getOwnPropertyDescriptor(dZ.prototype,"actDie"),dZ.prototype),rJ=Za(dZ.prototype,"_actDie",[mo],(function(){return!1})),m(dZ.prototype,"inheritColor",[uZ],Object.getOwnPropertyDescriptor(dZ.prototype,"inheritColor"),dZ.prototype),sJ=Za(dZ.prototype,"_inheritColor",[mo],(function(){return!1})),m(dZ.prototype,"subPercent",[hZ],Object.getOwnPropertyDescriptor(dZ.prototype,"subPercent"),dZ.prototype),aJ=Za(dZ.prototype,"_useSeed",[mo],(function(){return!1})),m(dZ.prototype,"useSeed",[cZ],Object.getOwnPropertyDescriptor(dZ.prototype,"useSeed"),dZ.prototype),oJ=Za(dZ.prototype,"_randomSeed",[mo],(function(){return 10})),m(dZ.prototype,"randomSeed",[lZ],Object.getOwnPropertyDescriptor(dZ.prototype,"randomSeed"),dZ.prototype),uJ=Za(dZ.prototype,"_subPercent",[mo],(function(){return 1})),hJ=Za(dZ.prototype,"_subEmitters",[mo],null),cJ=Za(dZ.prototype,"_baseEmitters",[mo],null),lJ=Za(dZ.prototype,"_parentEmitter",[mo],null),_J=Za(dZ.prototype,"_prewarm",[mo],(function(){return!1})),dJ=Za(dZ.prototype,"_capacity",[mo],(function(){return 100})),fJ=Za(dZ.prototype,"_simulationSpace",[mo],(function(){return Vz.Local})),_Z=dZ))||_Z)||_Z)),xJ=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(SD.on(TD.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new Hi((function(){return Kl(t)||new kp}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,i=p(t.getComponentsInChildren(CJ));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=p(t.getComponentsInChildren(CJ));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());xJ.particleSystemPool=new Map,xJ.registeredSceneEvent=!1,v.ParticleUtils=xJ}}}));
